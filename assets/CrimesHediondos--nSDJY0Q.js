import{r as f,a as V,_ as U,j as e,B as h,ab as H,aa as K,T as w,G,a9 as M,Q as q,D as X,P as Y,L as z}from"./index-DR-bKtYd.js";import{u as L}from"./useQueryParams-CilX3dkh.js";import{l as g}from"./lodash-7X0uo9vL.js";import{D as C}from"./EditableFields-DosZ9EA0.js";import{C as _}from"./CopyToClipboardButton-DxIlmE4p.js";import{u as J}from"./useCopyToClipboardFunction-tNDJdaiU.js";import{u as I}from"./useTableExpandableRows-4Q7cbq59.js";import{u as D}from"./useTablePagination-Bv1tD3Uj.js";import{r as $,a as Z}from"./index-CrYoWaXD.js";import{S as O}from"./index-CzhWSFX_.js";import{F as R}from"./index-CjSds9Ca.js";import{S as x}from"./index-mV1ddvS1.js";import{T as S}from"./index-Cj5QPFzB.js";import{u as Q,c as A,P as ee}from"./useBaseUrl-KlB5gb15.js";import{I as te}from"./Item-DoGDcxAW.js";import{F as v}from"./Table-mi7pioC7.js";import{I as ae}from"./index-Bxmjk3jW.js";import{u as B}from"./useToggle-Du1cYOpo.js";import{M as se}from"./index-EVJ0cPYn.js";import{F as ne,c as ie}from"./FilterEntries-UhkU006b.js";import{S as re}from"./SiderContent-BhVFP80X.js";import{D as b}from"./DownloadButton-CL-d7Hcu.js";import{S as k}from"./SaveButton-DnOghmAc.js";import{R as oe}from"./SkinOutlined-BcEX96pJ.js";import{R as le}from"./EnvironmentOutlined-CcauVmOe.js";import{D as ce}from"./DataLoadingWrapper-il0Wn8Us.js";import{u as E}from"./useResourceFirebaseData-DskTCWo7.js";import{u as de}from"./useTDResource-JIAXcSBb.js";import"./LanguageFlag-CWsg9sOF.js";import"./index-nRqnMAf0.js";import"./FireFilled-CozRNLUE.js";import"./IdcardOutlined-DfrMtzEt.js";import"./constants-Bukqt1PU.js";import"./gapSize-U1swVQyS.js";import"./index-CO0-upqR.js";import"./index-BXEMAZy-.js";import"./index-C1QAA0OT.js";import"./scrollTo-D6w3ySMz.js";import"./Pagination-rsNPmw_I.js";import"./extendsObject-keMuGWqj.js";import"./Input-CS8ZSUpo.js";import"./index-CjkS7F4v.js";import"./moment-C5S46NFB.js";import"./SaveOutlined-BD-eqkti.js";import"./useGetFirebaseDoc-B24d1TAL.js";import"./useUpdateFirebaseDoc-D_MkXhM7.js";import"./useMutation-B_3B_bq4.js";var me={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M938 458.8l-29.6-312.6c-1.5-16.2-14.4-29-30.6-30.6L565.2 86h-.4c-3.2 0-5.7 1-7.6 2.9L88.9 557.2a9.96 9.96 0 000 14.1l363.8 363.8c1.9 1.9 4.4 2.9 7.1 2.9s5.2-1 7.1-2.9l468.3-468.3c2-2.1 3-5 2.8-8zM459.7 834.7L189.3 564.3 589 164.6 836 188l23.4 247-399.7 399.7zM680 256c-48.5 0-88 39.5-88 88s39.5 88 88 88 88-39.5 88-88-39.5-88-88-88zm0 120c-17.7 0-32-14.3-32-32s14.3-32 32-32 32 14.3 32 32-14.3 32-32 32z"}}]},name:"tag",theme:"outlined"},pe=function(i,n){return f.createElement(V,U({},i,{ref:n,icon:me}))},ue=f.forwardRef(pe);function ge({allTags:a,onSelect:i}){return e.jsx(O,{showSearch:!0,mode:"tags",placeholder:"Add new tag",options:a,style:{width:"200px"},autoClearSearchValue:!0,maxCount:1,onSelect:i,allowClear:!0,defaultActiveFirstOption:!1,size:"small"})}function xe({onSelect:a}){const[i,n]=f.useState([]),r=()=>{a(i.map(c=>c.trim().toLowerCase())),n([])};return e.jsxs(R,{gap:6,children:[e.jsx(O,{showSearch:!0,mode:"tags",placeholder:"Add new tag",options:[],style:{width:"200px"},autoClearSearchValue:!0,allowClear:!0,value:i,onChange:n,tokenSeparators:[","],onClear:()=>n([]),defaultActiveFirstOption:!1,size:"small"}),e.jsx(h,{onClick:r,disabled:i.length===0,children:"Add"})]})}function W({card:a,allTags:i,onUpdateCard:n}){const r=o=>{var p,u;const l=g.cloneDeep(a);(p=l.tags)!=null&&p.includes(o)?l.tags=(u=l.tags)==null?void 0:u.filter(t=>t!==o):l.tags=$([...l.tags??[],o]).sort(),n(l)},c=o=>{const l=g.cloneDeep(a);l.tags=$([...l.tags??[],...o]).sort(),n(l)};return e.jsxs(x,{wrap:!0,children:[e.jsxs(x,{size:"small",children:["New tag:",e.jsx(ge,{allTags:i,onSelect:r})]}),e.jsxs(x,{size:"small",children:["All multiple tags:",e.jsx(xe,{allTags:i,onSelect:c})]}),e.jsx("ul",{className:"all-tags",children:i.map(({value:o,count:l})=>{var p;return e.jsxs(S,{color:(p=a.tags)!=null&&p.includes(o)?"yellow":void 0,className:"all-tags__tag",onClick:()=>r(o),children:[o," (",l,")"]},`all-tags-${o}`)})})]})}function T({item:a,cardWidth:i,activeColor:n,isSelected:r=!1,className:c=""}){const{getUrl:o}=Q("images"),l=`back/crime${g.capitalize(a.type)}`;return a.itemId?e.jsxs("div",{className:A("crime-item-card",`crime-item-card--${a.type}`,r&&"crime-item-card--selected",c),style:{width:i,backgroundImage:`url(${o(`${l}.jpg`)})`,...n&&r?{borderColor:n,backgroundColor:n}:{}},children:[e.jsx(H,{content:e.jsxs(e.Fragment,{children:[a.name.pt," | ",a.name.en]}),children:e.jsx("div",{className:"crime-item-card__name",style:{maxWidth:`${i}px`},children:e.jsx("span",{children:a.name.en})})}),e.jsx("div",{className:A("crime-item-card__item-container",`crime-item-card__item-container--${a.type}`),children:e.jsx(te,{id:a.itemId,width:i*.75,className:"crime-item-card__item"})})]}):e.jsx(e.Fragment,{children:a.id})}function he({rows:a,allTags:i,onUpdateCard:n}){const r=J(),c=D({total:a.length,showQuickJumper:!0}),o=(t,s,d)=>{const m=g.cloneDeep(d);m.name[s]=t,n(m)},l=[{title:"Id",dataIndex:"id",key:"id",render:t=>e.jsxs("span",{children:[t,e.jsx(_,{content:t})]}),sorter:(t,s)=>t.id.localeCompare(s.id)},{title:"Card",dataIndex:"itemId",key:"itemId",render:(t,s)=>e.jsxs("div",{children:[e.jsx(T,{item:s,cardWidth:70}),e.jsx(ae,{defaultValue:s.itemId,size:"small",onBlur:d=>{var m,j,y,P;if(console.log((m=d==null?void 0:d.target)==null?void 0:m.value),console.log("onBlur"),(j=d==null?void 0:d.target)!=null&&j.value&&((y=d==null?void 0:d.target)==null?void 0:y.value)!==s.itemId){const F=g.cloneDeep(s);F.itemId=(P=d==null?void 0:d.target)==null?void 0:P.value,n(F)}}})]})},{title:"Name",dataIndex:"name",key:"name",sorter:(t,s)=>t.name.en.localeCompare(s.name.en),render:(t,s)=>e.jsxs(x,{direction:"vertical",style:{minWidth:150},children:[e.jsx(C,{value:t,language:"en",onPressEnter:d=>{var m;return o(((m=d.target)==null?void 0:m.value)||s.name.en,"en",s)}}),e.jsx(C,{value:t,language:"pt",onPressEnter:d=>{var m;return o(((m=d.target)==null?void 0:m.value)||s.name.pt,"pt",s)}})]})},{title:"Type",dataIndex:"type",key:"type",render:t=>e.jsx("span",{children:t}),sorter:(t,s)=>t.type.localeCompare(s.type)},v.EXPAND_COLUMN,{title:"Tags",dataIndex:"tags",key:"tags",render:t=>e.jsx(x,{size:"small",wrap:!0,children:t.map(s=>e.jsx(S,{children:s},s))})},{title:"Verify",dataIndex:"tags",key:"verify",render:t=>t.length>2?e.jsx(K,{}):""}],p=I({maxExpandedRows:1,expandedRowRender:t=>e.jsx(W,{card:t,allTags:i,onUpdateCard:n})}),u=()=>{if(c){const{current:t=1,pageSize:s=10}=c,d=a.slice((t-1)*s,t*s),m=[];d.forEach((j,y)=>{m.push(`${y+1}) ${j.name.en} - Current tags: ${(j.tags??[]).join(", ")}`)}),console.log(m),r(m.join(`
`))}};return e.jsxs("div",{className:"my-4",children:[e.jsxs(x,{className:"mb-4",children:[e.jsx(h,{onClick:()=>{r(i.map(t=>t.value).join(", "))},children:"Copy AllTags"}),e.jsx(h,{onClick:u,children:"Copy Page Cards"})]}),e.jsx(v,{columns:l,dataSource:a,rowKey:"id",expandable:p,pagination:c})]})}function je({sceneQuery:a,allTags:i,objects:n}){const r=J(),c=Object.values(a.data??[]),o=D({total:c.length,showQuickJumper:!0}),l=t=>{const s=[];s.push(`"${t.description.en}"`),t.values.forEach((d,m)=>{s.push(`${m}) ${d.en}`)}),r(s.join(`
`))},p=[{title:"Id",dataIndex:"id",key:"id",render:t=>e.jsxs("span",{children:[t,e.jsx(_,{content:t})]}),sorter:(t,s)=>t.id.localeCompare(s.id)},{title:"Title",dataIndex:"title",key:"title",render:(t,s)=>e.jsxs(x,{direction:"vertical",style:{minWidth:150},children:[e.jsx(C,{value:s.title,language:"en",readOnly:!0}),e.jsx(C,{value:s.title,language:"pt",readOnly:!0})]})},{title:"Type",dataIndex:"type",key:"type",render:t=>e.jsx("span",{children:t}),sorter:(t,s)=>t.type.localeCompare(s.type)},v.EXPAND_COLUMN,{title:"Options",dataIndex:"values",key:"tags",render:(t,s)=>e.jsxs(e.Fragment,{children:[e.jsx(h,{onClick:()=>l(s),children:"Copy options"}),e.jsx("ul",{children:t.map((d,m)=>{var j,y;return e.jsxs("li",{children:[e.jsxs(w,{children:[d.en," / ",d.pt," ",e.jsx(S,{children:((y=(j=s.tags)==null?void 0:j[m])==null?void 0:y.length)??0})]}),e.jsx(fe,{scene:s,valueIndex:m,addEntryToUpdate:a.addEntryToUpdate})]},d.en)})})]})}],u=I({maxExpandedRows:1,expandedRowRender:t=>e.jsx(ye,{scene:t,objects:n})});return e.jsxs("div",{className:"my-4",children:[e.jsx(w.Title,{level:2,className:"my-0",children:"Scenes"}),e.jsx(x,{className:"mb-4",children:e.jsx(h,{onClick:()=>{r(i.map(t=>t.value).join(", "))},children:"Copy AllTags"})}),e.jsx(v,{columns:p,dataSource:c,rowKey:"id",expandable:u,pagination:o})]})}function fe({scene:a,valueIndex:i,addEntryToUpdate:n}){var t,s,d;const[r,c]=B(!1),[o,l]=f.useState([]),p=((t=a==null?void 0:a.tags)==null?void 0:t[i])??[],u=()=>{const m=g.cloneDeep(a);m.tags=m.tags??{},m.tags[i]=[...o.filter(Boolean)],console.log(m.tags),n(m.id,m),l([]),c()};return r?e.jsx(e.Fragment,{children:e.jsxs(R,{gap:6,align:"center",children:[e.jsx(O,{showSearch:!0,mode:"tags",placeholder:"Add new tag",options:[],style:{minWidth:"200px",maxWidth:"600px"},autoClearSearchValue:!0,allowClear:!0,defaultValue:p,onChange:l,tokenSeparators:[","],onClear:()=>l([]),defaultActiveFirstOption:!1,size:"small"}),e.jsx(h,{onClick:u,disabled:o.length===0,children:"Add"}),e.jsx(h,{onClick:c,icon:e.jsx(G,{}),shape:"circle",size:"small",type:"text"})]})}):e.jsxs(e.Fragment,{children:[(d=(s=a==null?void 0:a.tags)==null?void 0:s[i])==null?void 0:d.map(m=>e.jsx(S,{color:"green",children:m},m)),e.jsx(h,{shape:"circle",size:"small",onClick:c,icon:e.jsx(M,{})})]})}function ye({scene:a,objects:i}){const{message:n}=q.useApp(),[r,c]=f.useState(null),o=()=>{const l=g.sample(i);if(!l){n.error("No objects to sample from");return}const p=Ce(a,l);c({entry:l,likelihood:p})};return e.jsxs("div",{className:"full-width",children:[e.jsx(h,{onClick:o,children:"Sample"}),e.jsxs("div",{className:"scene-options-sampler mt-4",children:[r&&e.jsx(T,{item:r.entry,cardWidth:70}),a.values.map((l,p)=>{const u=(r==null?void 0:r.likelihood[p])??0;let t=u>50?"cyan":u>25?"orange":"red";const s=Math.max(...Object.values((r==null?void 0:r.likelihood)??{}));return t=u===s?"green":t,e.jsxs(x,{direction:"vertical",children:[e.jsxs(w.Text,{children:[l.en," / ",l.pt]}),e.jsxs(S,{color:u===0?void 0:t,children:[u,"%"]})]},l.en)})]})]})}const Ce=(a,i)=>{const n={},r={};return console.log("========="),(i.tags??[]).forEach(c=>{r[c]=0,Object.keys(a.tags??{}).forEach(o=>{var p;(((p=a.tags)==null?void 0:p[o])??[]).includes(c)&&(r[c]=r[c]+1)})}),console.log(JSON.parse(JSON.stringify(r))),Object.keys(r).forEach(c=>{const o=Math.max(0,1-r[c]*.1);r[c]=o}),console.log(JSON.parse(JSON.stringify(r))),(i.tags??[]).forEach(c=>{Object.keys(a.tags??{}).forEach(o=>{var p;(((p=a.tags)==null?void 0:p[o])??[]).includes(c)&&(n[o]=(n[o]??0)+r[c])})}),console.log(JSON.parse(JSON.stringify(n))),Object.keys(n).forEach(c=>{var o;n[c]=Math.floor(Math.min(100,(n[c]??0)/(((o=i.tags)==null?void 0:o.length)??1)*100))}),console.log(JSON.parse(JSON.stringify(n))),n};function ve({allTags:a,onUpdateCard:i,card:n,buttonProps:r}){const[c,o]=B(!1),l=(p,u,t)=>{const s=g.cloneDeep(t);s.name[u]=p,i(s)};return console.log("EditCrimeCardModal",n),e.jsxs("div",{children:[e.jsx(h,{...r,onClick:o,size:"small",icon:e.jsx(M,{}),style:{minWidth:100},children:"Edit"}),e.jsx(se,{title:`Editing ${n.id} (${n.name.en})`,open:c,onOk:()=>o(!1),onCancel:o,width:1e3,children:c&&e.jsxs(x,{children:[e.jsxs(x,{direction:"vertical",style:{minWidth:150},children:[e.jsx(T,{item:n,cardWidth:100}),e.jsx(C,{value:n.name,language:"en",onPressEnter:p=>{var u;return l(((u=p.target)==null?void 0:u.value)||n.name.en,"en",n)}}),e.jsx(C,{value:n.name,language:"pt",onPressEnter:p=>{var u;return l(((u=p.target)==null?void 0:u.value)||n.name.pt,"pt",n)}})]}),e.jsx(W,{allTags:a,onUpdateCard:i,card:n})]})})]})}function Se({rows:a,weapons:i,evidence:n,onUpdateCard:r,allTags:c}){const o=f.useMemo(()=>{const t={};return a.forEach(s=>{var d;(d=s.tags)==null||d.forEach(m=>{t[m]||(t[m]={id:m,tag:m,count:0,cardsIds:[]}),t[m].count++,t[m].cardsIds.push(s.id)})}),g.orderBy(Object.values(t),["tag"],["asc"])},[a]),l=D({total:o.length,showQuickJumper:!0}),p=I({maxExpandedRows:1,expandRowByClick:!0,expandedRowRender:t=>e.jsx(x,{size:"small",wrap:!0,children:t.cardsIds.map(s=>{const d=i[s]??n[s];return e.jsxs(x,{direction:"vertical",align:"center",children:[e.jsx(T,{item:d,cardWidth:75}),e.jsx(ve,{allTags:c,onUpdateCard:r,card:d})]},s)})})}),u=[{title:"Id",dataIndex:"id",key:"id",render:t=>e.jsx("span",{children:t}),sorter:(t,s)=>t.id.localeCompare(s.id)},{title:"Tag",dataIndex:"tag",key:"tag",render:t=>e.jsx("span",{children:t}),sorter:(t,s)=>t.tag.localeCompare(s.tag)},{title:"Count",dataIndex:"count",key:"count",render:t=>e.jsx("span",{children:t}),sorter:(t,s)=>t.count-s.count}];return e.jsx("div",{className:"my-4",children:e.jsx(v,{columns:u,dataSource:o,rowKey:"id",expandable:p,pagination:l})})}function Te({weaponsQuery:a,evidenceQuery:i,scenesQuery:n}){const{is:r,queryParams:c}=L(),o=f.useMemo(()=>[...Object.values(a.data),...Object.values(i.data)],[a.data,i.data]),l=f.useMemo(()=>{const u={};return o.forEach(t=>{var s;(s=t.tags)==null||s.forEach(d=>{u[d]=(u[d]??0)+1})}),g.orderBy(Object.entries(u).map(([t,s])=>({value:t,label:t,count:s})),["value"],["asc"])},[o]),p=u=>{if(u.type==="weapon")a.addEntryToUpdate(u.id,u);else if(u.type==="evidence")i.addEntryToUpdate(u.id,u);else throw new Error("Invalid card type")};return e.jsxs(e.Fragment,{children:[(r("display","cards")||!c.has("display"))&&e.jsx(he,{rows:o,allTags:l,onUpdateCard:p}),r("display","tags")&&e.jsx(Se,{rows:o,weapons:a.data,evidence:i.data,onUpdateCard:p,allTags:l}),r("display","scenes")&&e.jsx(je,{sceneQuery:n,allTags:l,objects:o})]})}function be({weaponsQuery:a,evidenceQuery:i,scenesQuery:n}){const{queryParams:r,addParam:c,addParams:o,is:l}=L();return e.jsxs(re,{children:[e.jsxs(R,{vertical:!0,gap:12,children:[e.jsx("span",{children:"Weapons"}),e.jsx(k,{isDirty:a.isDirty,onSave:a.save,isSaving:a.isSaving,dirt:JSON.stringify(a.entriesToUpdate)}),e.jsx(b,{data:()=>N(a.data),fileName:"crime-weapons.json",disabled:a.isDirty,block:!0}),e.jsx("span",{children:"Evidence"}),e.jsx(k,{isDirty:i.isDirty,onSave:i.save,isSaving:i.isSaving,dirt:JSON.stringify(i.entriesToUpdate)}),e.jsx(b,{data:()=>N(i.data),fileName:"crime-evidence.json",disabled:i.isDirty,block:!0}),e.jsx("span",{children:"Scenes"}),e.jsx(k,{isDirty:n.isDirty,onSave:n.save,isSaving:n.isSaving,dirt:JSON.stringify(n.entriesToUpdate)}),e.jsx(b,{data:()=>N(n.data),fileName:"crime-scenes.json",disabled:n.isDirty,block:!0})]}),e.jsx(X,{}),e.jsx(ne,{label:"Display",value:r.get("display")??"listing",onChange:p=>o({display:p,page:1},{page:1}),options:[{title:"Cards",icon:e.jsx(oe,{}),value:"cards"},{title:"Tags",icon:e.jsx(ue,{}),value:"tags"},{title:"Scenes",icon:e.jsx(le,{}),value:"scenes"}]}),l("display","item")&&e.jsx(ie,{label:"No Groups Only",value:l("emptyOnly"),onChange:p=>c("emptyOnly",p,!1)})]})}function N(a){console.log("Preparing file for download...");const i=g.cloneDeep(a);return Z(i)}function ft(){const a=E({tdrResourceName:"crime-weapons",firebaseDataCollectionName:"crimeWeapons",serialize:!0}),i=E({tdrResourceName:"crime-evidence",firebaseDataCollectionName:"crimeEvidence",serialize:!0}),n=E({tdrResourceName:"crime-scenes",firebaseDataCollectionName:"crimeScenes",serialize:!0}),r=de("items");return e.jsx(Y,{title:"Crimes Hediondos",subtitle:"Categorizer",children:e.jsxs(z,{hasSider:!0,children:[e.jsx(ee,{children:e.jsx(be,{weaponsQuery:a,evidenceQuery:i,scenesQuery:n})}),e.jsx(z.Content,{className:"content",children:e.jsx(ce,{isLoading:a.isLoading||i.isLoading||n.isLoading||r.isLoading,error:a.error||i.error||n.error||r.error,hasResponseData:!g.isEmpty(a.data)&&!g.isEmpty(i.data)&&!g.isEmpty(n.data)&&!g.isEmpty(r.data),children:e.jsx(Te,{weaponsQuery:a,evidenceQuery:i,scenesQuery:n})})})]})})}export{ft as default};
