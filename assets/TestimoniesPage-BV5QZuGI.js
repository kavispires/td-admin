import{r as v,a as V,_ as G,j as e,T as A,B as N,aj as ie,af as ae,y as F,D as Z,P as ce,L as J}from"./index-vmFFRzn7.js";import{D as le}from"./DataLoadingWrapper-CpL6TfC-.js";import{P as ue}from"./PageSider-BLPrh3D7.js";import{u as I}from"./useQueryParams-DMk5phAc.js";import{R as de}from"./main-DXitZaNU.js";import{l as y,c as ee}from"./useBaseUrl-Dv2lNNaz.js";import{u as me,D as he,g as pe,a as fe}from"./constants-BUcqTHBQ.js";import{u as M}from"./useTDResource-DRi3U-Lt.js";import{I as Q}from"./ImageCard-BBi_Q-Lh.js";import{g as te}from"./utils-D68Q4pbt.js";import{F as k}from"./index-OhNx5BvD.js";import{T as ge,F as xe}from"./FilterEntries-DqqR8kOD.js";import{B as Y,D as je}from"./DownloadButton-CaKB8OQm.js";import{S as D}from"./index-CfqKZdaa.js";import{u as se}from"./useTableExpandableRows-CK8Zxbam.js";import{u as ne}from"./useTablePagination-BTtjyxIH.js";import{P as K}from"./progress-Qw8EAow7.js";import{S as H}from"./index-pGrZ8HBU.js";import{F as W}from"./Table-QXP3jMn9.js";import{u as be}from"./useCardWidth-C6xaMvzH.js";import{C as oe}from"./index-DQdHrV6B.js";import{P as U}from"./index-Dx0gJ2sH.js";import{R as ye}from"./FireFilled-CwxTZ8_U.js";import{S as z}from"./SiderContent-BP13uxNK.js";import{S as we}from"./SaveButton-BDqV9x9b.js";import{g as ve}from"./useGetFirestoreDoc-CNHqTUco.js";import{c as Se,u as ke}from"./useTestimoniesResource-DHdaaCsR.js";import{e as Ce,a as Ee,d as Oe}from"./index-7JE2gYhQ.js";import{R as Pe}from"./TableOutlined-BcRmO_8C.js";import"./moment-C5S46NFB.js";import"./gapSize-U1swVQyS.js";import"./index-DmOiZ7rk.js";import"./index-DK5Tc_1M.js";import"./index-Dobx2ca5.js";import"./index-9FbfJmnW.js";import"./scrollTo-DL9Kg87k.js";import"./Pagination-CULIYqy9.js";import"./extendsObject-keMuGWqj.js";import"./Input-BygrLcZ2.js";import"./SaveOutlined-DtwP5Up_.js";import"./useResourceFirestoreData-CFz_0YFo.js";import"./useUpdateFirestoreDoc-BYmtHkXE.js";import"./useMutation-DMHw2nYN.js";import"./constants-LF5jsGrc.js";import"./Item-CuGkd1uQ.js";var Ne={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M594.3 601.5a111.8 111.8 0 0029.1-75.5c0-61.9-49.9-112-111.4-112s-111.4 50.1-111.4 112c0 29.1 11 55.5 29.1 75.5a158.09 158.09 0 00-74.6 126.1 8 8 0 008 8.4H407c4.2 0 7.6-3.3 7.9-7.5 3.8-50.6 46-90.5 97.2-90.5s93.4 40 97.2 90.5c.3 4.2 3.7 7.5 7.9 7.5H661a8 8 0 008-8.4c-2.8-53.3-32-99.7-74.7-126.1zM512 578c-28.5 0-51.7-23.3-51.7-52s23.2-52 51.7-52 51.7 23.3 51.7 52-23.2 52-51.7 52zm416-354H768v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H548v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H328v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H96c-17.7 0-32 14.3-32 32v576c0 17.7 14.3 32 32 32h832c17.7 0 32-14.3 32-32V256c0-17.7-14.3-32-32-32zm-40 568H136V296h120v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h148v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h148v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h120v496z"}}]},name:"contacts",theme:"outlined"},Re={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M300 328a60 60 0 10120 0 60 60 0 10-120 0zM852 64H172c-17.7 0-32 14.3-32 32v660c0 17.7 14.3 32 32 32h680c17.7 0 32-14.3 32-32V96c0-17.7-14.3-32-32-32zm-32 660H204V128h616v596zM604 328a60 60 0 10120 0 60 60 0 10-120 0zm250.2 556H169.8c-16.5 0-29.8 14.3-29.8 32v36c0 4.4 3.3 8 7.4 8h729.1c4.1 0 7.4-3.6 7.4-8v-36c.1-17.7-13.2-32-29.7-32zM664 508H360c-4.4 0-8 3.6-8 8v60c0 4.4 3.6 8 8 8h304c4.4 0 8-3.6 8-8v-60c0-4.4-3.6-8-8-8z"}}]},name:"robot",theme:"outlined"},Ae={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M868 160h-92v-40c0-4.4-3.6-8-8-8H256c-4.4 0-8 3.6-8 8v40h-92a44 44 0 00-44 44v148c0 81.7 60 149.6 138.2 162C265.6 630.2 359 721.8 476 734.5v105.2H280c-17.7 0-32 14.3-32 32V904c0 4.4 3.6 8 8 8h512c4.4 0 8-3.6 8-8v-32.3c0-17.7-14.3-32-32-32H548V734.5C665 721.8 758.4 630.2 773.8 514 852 501.6 912 433.7 912 352V204a44 44 0 00-44-44zM248 439.6c-37.1-11.9-64-46.7-64-87.6V232h64v207.6zM840 352c0 41-26.9 75.8-64 87.6V232h64v120z"}}]},name:"trophy",theme:"filled"},Ie=function(t,n){return v.createElement(V,G({},t,{ref:n,icon:Ne}))},Te=v.forwardRef(Ie),Be=function(t,n){return v.createElement(V,G({},t,{ref:n,icon:Re}))},Fe=v.forwardRef(Be),De=function(t,n){return v.createElement(V,G({},t,{ref:n,icon:Ae}))},X=v.forwardRef(De);const _=(s,t,n)=>{const{reliabilityThreshold:c=4,projectionThreshold:r=55}={},a=`us-gb-${s.split("-")[1]}`,i=y.isEmpty(t[s])?[]:t[s];let u=0,l=0;i.forEach(O=>{O===3&&(u+=3),O===-3&&(l+=3),O===4&&(u+=4),O===-4&&(l+=4)});const h=i.filter(O=>![-4,-3,3,4].includes(O)),p=h.length+u+l,m=Math.max(p,5),f=i.filter(O=>O===1).length+u,w=Math.round(f/m*100),g=i.filter(O=>O===0).length+l,x=Math.round(g/m*100),b=Math.round((m-f-g)/m*100),S=h.length+u+l>=5,E=p>3,C=p>c,R=C?w>x?"👍":"👎":null,T=E?w>=r?"👍":x>=r?"👎":null:null;return{suspectCardId:s,imageId:a,enoughData:E,reliable:C,total:m,yesCount:f,yesPercentage:w,noCount:g,noPercentage:x,blankPercentage:b,complete:S,values:i,resolution:R,projection:T}};function Me(s){const t=s.filter(r=>![0,1].includes(r)),n=s.filter(r=>[0,1].includes(r)),c={0:0,1:0};return n.forEach(r=>{if(c[r]===void 0)throw Error(`what is this value? ${r}`);c[r]+=1}),Object.entries(c).forEach(([r,d])=>{if(d>0){const a=Math.floor(d/4),i=d%4;for(let u=0;u<a;u++)t.push(r==="0"?-4:4);if(i>0){const u=Array.from({length:i},()=>r==="0"?0:1);t.push(...u)}}}),t.sort((r,d)=>r-d)}const L=9,ze=(s,t,n,c)=>{const[r]=me(he.ESPIONAGEM,c),d=M("suspects",s),a=M(`testimony-questions-${t}`,s),i=M("testimony-answers",s),u=M("crime-reasons",s),l=v.useMemo(()=>qe(i.data),[i.data]),h=v.useMemo(()=>Le(d.data),[d.data]);return{entries:v.useMemo(()=>!r||!d.isSuccess||!a.isSuccess||!i.isSuccess||!u.isSuccess?{}:$e(n,r,d.data,a.data,l,h,u.data),[s,r,d,a,i,n,l,h,u]),isLoading:d.isLoading||a.isLoading||i.isLoading}},$e=(s,t,n,c,r,d,a)=>{console.count("Creating Espionagem...");let i=t.latestDate;const u=[],l={};for(let h=0;h<s;h++){const p=pe(i);i=p;let m=null,o=0;for(;!m&&o<100;){o++;const f=He(n,c,r,d,u,a);if(We(f.statements)){m=f,console.log(`Generated valid game for ${p} after ${o} attempts`);break}}if(!m)throw new Error(`Failed to generate valid game for ${p} after 100 attempts`);u.push(m.culpritId),l[p]={id:p,type:"espionagem",number:t.latestNumber+h+1,...m}}return l};function He(s,t,n,c,r,d){let a=[];const i=[],u={},l=y.sample(Object.keys(n));if(!l)throw new Error("No selected testimony ID found");const h=Object.keys(n[l]).filter(C=>!r.includes(C)),p=h.length>0?h:Object.keys(n[l]),m=y.sample(p);if(!m)throw new Error("No selected culprit ID found");const o=y.sampleSize(Object.keys(n[l]).filter(C=>C!==m),L-1);for(a.push(...o);a.length<8;){const C=y.sampleSize(Object.keys(s).filter(R=>!a.includes(R)&&R!==m),L-a.length-1);a.push(...C)}const f={};Object.keys(c).forEach(C=>{if(c[C][m]===void 0){const R=Object.keys(c[C]).filter(T=>a.includes(T));if(R.length>0){const T={};R.forEach(O=>{a.includes(O)&&(T[O]=!0)}),f[C]=T}}});const w=t[l];i.push(Ve(m,a,w,n[l])),B(u,i[0].excludes);const j=q(m,a,f);i.push(j),B(u,j.excludes),a=y.shuffle([...a,m]);const g=q(m,a,f,[j],"worst");i.push(g),B(u,g.excludes);const x=q(m,a,f,[j,g],"worst");i.push(x),B(u,x.excludes);const b=Ge(m,a,i);i.push(b),B(u,b.excludes);const S=[i[0],i[1],i[2],i[4],i[3]],E=_e(s[m],d);return{isNsfw:w.nsfw??!1,culpritId:m,statements:S,suspects:a.map(C=>s[C]),reason:E.title,setId:`${m}::${E.id}::${S[0].key}`,level:Je(S)}}const qe=s=>{const t={};console.log("⚙️ Calculating suspect answers...");for(const n of Object.keys(s)){const c=s[n];for(const r of Object.keys(c)){const{resolution:d,projection:a}=_(r,c);if(!d&&!a){console.log("⁉️ Ignoring testimony with no resolution or projection");continue}if(t[n]===void 0&&(t[n]={}),d){t[n][r]=d==="👍";continue}if(a){t[n][r]=a==="👍";continue}console.log("⁉️ Ignoring testimony with not enough values")}}return Object.keys(t).forEach(n=>{y.isEmpty(t[n])&&delete t[n]}),Object.keys(t).forEach(n=>{Object.keys(t[n]).length<3&&(console.log("⁉️ Removing testimonies with less than 3 answers"),delete t[n])}),Object.keys(t).forEach(n=>{y.uniq(Object.values(t[n])).length===1&&(console.log("⁉️ Removing testimonies with the same answer"),delete t[n])}),t},Le=s=>{const t={};for(const c of Object.keys(s)){const{gender:r,ethnicity:d,age:a,build:i,height:u,features:l}=s[c];if(!i){console.log("⁉️ Ignoring suspect with missing build",c);continue}if(!u){console.log("⁉️ Ignoring suspect with missing height",c);continue}if(!l||l.length===0){console.log("⁉️ Ignoring suspect with missing features",c);continue}t[r]===void 0&&(t[r]={}),t[r][c]=!0,t[d]===void 0&&(t[d]={}),t[d][c]=!0,t[a]===void 0&&(t[a]={}),t[a][c]=!0,t[i]===void 0&&(t[i]={}),t[i][c]=!0,t[u]===void 0&&(t[u]={}),t[u][c]=!0,l.forEach(h=>{t[h]===void 0&&(t[h]={}),t[h][c]=!0})}return t.young=y.cloneDeep(t["18-21"]),t.adult=y.cloneDeep({...t["21-30"],...t["30-40"],...t["40-50"]}),t.senior=y.cloneDeep({...t["50-60"],...t["60-70"],...t["70-80"],...t["80-90"]}),["18-21","21-30","30-40","40-50","50-60","60-70","70-80","80-90","average","medium","mixed","adult","tall"].forEach(c=>{delete t[c]}),t},B=(s,t)=>{t.forEach(n=>{s[n]===void 0&&(s[n]=0),s[n]++})},Ve=(s,t,n,c)=>{const r=c[s],d=t.filter(u=>c[u]!==void 0&&c[u]!==r),a=n.answer.charAt(0).toLowerCase()+n.answer.slice(1),i={key:`testimony.${n.id}`,text:`O(a) suspeito(a) ${r?"":"não "}${a}`,excludes:d};return i.text.includes("não já")&&(i.text=i.text.replace("não já","nunca")),i},$={row1:{indexes:[0,1,2],text:"na primeira linha"},row2:{indexes:[3,4,5],text:"na segunda linha"},row3:{indexes:[6,7,8],text:"na terceira linha"},column1:{indexes:[0,3,6],text:"na primeira coluna"},column2:{indexes:[1,4,7],text:"na segunda coluna"},column3:{indexes:[2,5,8],text:"na terceira coluna"},corners:{indexes:[0,2,6,8],text:"nos cantos"}},Ge=(s,t,n)=>{const c=t.indexOf(s),r=n.slice(0,3),d={};for(const p of Object.keys($)){const{indexes:m}=$[p];m.includes(c)||(d[p]=m.reduce((o,f)=>{const w=t[f],j=r.filter(g=>g.excludes.includes(w)).length;return j>0?o+j:o},0))}const a=Object.entries(d).reduce((p,[m,o])=>(p[o]||(p[o]=[]),p[o].push(m),p),{}),i=Math.min(...Object.keys(d).map(p=>d[p])),u=a[i.toString()],l=y.sample(u)||Object.keys(d)[0],h=$[l].indexes.map(p=>t[p]);return{key:`not.grid.${l}`,text:`O(a) suspeito(a) não está ${$[l].text}`,excludes:h}},q=(s,t,n,c=[],r="best")=>{const d=y.difference(t,[s]),a=c.filter(f=>f.key.startsWith("not.feature.")).map(f=>f.key.replace("not.feature.","")),i=new Set(c.flatMap(f=>f.excludes)),u=Object.keys(n).filter(f=>Object.keys(n[f]).length<=6&&!a.includes(f)).sort((f,w)=>Object.keys(n[w]).length-Object.keys(n[f]).length);let l,h=[],p=0;const m=500;for(;p<m;){p++;const f=r==="best"?u[0]:y.sample(u.slice(2,5))??u[2];if(!f)break;const w=d.filter(g=>n[f][g]);if(w.some(g=>!i.has(g))||p===m){l=f,h=w;break}u.splice(u.indexOf(f),1)}if(!l)throw Error(`No suitable feature found for ${r} selection after ${m} attempts`);console.log(`Selected feature after ${p} attempts: ${l}`);const o=Qe[l];return o||console.warn(`Feature ${l} not found in translations`),{key:`not.feature.${l}`,text:`O(a) suspeito(a) não ${o||l}`,excludes:h}},Qe={male:"é homem",female:"é mulher",black:"é negro(a)",white:"é branco(a)",asian:"é asiático(a)",latino:"é latino(a)",thin:"é magrelo(a)",fat:"é gordo(a)",large:"é gordo(a)",tall:"é alto(a)",short:"é baixinho(a)",young:"é jovem",adult:"é adulto(a)",senior:"é idoso(a)",average:"é médio(a)",medium:"é médio(a)",mixed:"é mestiço(a)",hat:"está usando um chapéu",tie:"está usando uma gravata",glasses:"está usando óculos",brownHair:"tem cabelo castanho",shortHair:"tem cabelo curto",beard:"tem barba",caucasian:"é caucasiano(a)",scarf:"está usando um cachecol",blondeHair:"tem cabelo loiro",longHair:"tem cabelo longo",greyHair:"tem cabelo grisalho",bald:"é careca",mustache:"tem bigode",goatee:"tem cavanhaque",muscular:"é musculoso(a)",blackHair:"tem cabelo preto",hoodie:"está usando um moletom",earrings:"está usando brincos",lipstick:"está usando batom",necklace:"está usando um colar",mediumHair:"tem cabelo médio","middle-eastern":"é do Oriente Médio",headscarf:"está usando um lenço na cabeça",redHair:"tem cabelo ruivo",piercings:"tem piercings",coloredHair:"tem cabelo colorido",indian:"é indiano(a)","native-american":"é nativo-americano(a)"},We=s=>{const t=s.slice(0,3);return t.reduce((r,d)=>r+d.excludes.length,0)<10?!1:new Set(t.flatMap(r=>r.excludes)).size===L-1},_e=(s,t)=>{const n=[];Object.values(t).forEach(r=>{var d;r.feature==="general"&&n.push(r),(d=s.features)!=null&&d.includes(r.feature)&&n.push(r)});const c=y.sample(n);return c||{id:"unknown",title:{pt:"Motivo desconhecido",en:"Unknown reason"},feature:"general"}},Je=s=>{const t=s.slice(0,3),n=[],c={1:4,2:3,3:3,4:2,5:2,6:1,7:0,8:0};t.forEach(d=>{const a=d.excludes.length;c[a]!==void 0&&n.push(c[a])});const r=Math.round(n.reduce((d,a)=>d+a,0)/n.length);return Math.min(Math.max(r,1),3)};function Ye(){const[s,t]=v.useState({batchSize:1,history:{}}),n=v.useRef(1),{entries:c}=ze(!0,"pt",s.batchSize,s.history);return e.jsxs(k,{vertical:!0,gap:12,className:"p-4",children:[e.jsxs(k,{justify:"space-between",align:"center",children:[e.jsx(A.Title,{level:4,className:"my-0",children:"Espionagem Simulator"}),e.jsxs(k,{gap:6,children:[e.jsx(ge,{min:1,max:7,defaultValue:1,onChange:r=>{n.current=r??1}}),e.jsx(N,{type:"primary",onClick:()=>t({batchSize:n.current,history:{}}),children:"Re-run Simulation"})]})]}),e.jsx(Ke,{entries:c})]})}function Ke({entries:s}){const[t,n]=v.useState(!1),c=fe(),r=s[c],d=v.useMemo(()=>r?r.statements.slice(0,3).reduce((a,i)=>{const{excludes:u}=i;return u.forEach(l=>{a[l]?a[l]++:a[l]=1}),a},{}):{},[r]);return e.jsxs("div",{className:"full-width grid grid-2",children:[e.jsx(de,{src:s??{},theme:"twilight",collapsed:3}),r&&e.jsxs(k,{gap:18,className:"p-4",children:[e.jsx("div",{children:e.jsx("div",{style:{width:`${105*3}px`,display:"grid",gap:"6px",gridTemplateColumns:"repeat(3, 1fr)"},children:r.suspects.map(a=>e.jsxs(Y.Ribbon,{text:t?d[a.id]:null,color:"cyan",children:[e.jsx(Q,{id:te(a.id,"gb"),width:96,className:ee(t&&a.id===r.culpritId&&"red-border")},a.id),e.jsxs(k,{gap:6,align:"center",children:[e.jsx(D,{checkedChildren:"🚫",size:"small"})," ",a.id]})]},a.id))})}),e.jsxs("div",{children:[e.jsx("div",{children:e.jsx(D,{checkedChildren:"Show Culprit",unCheckedChildren:"Hide Culprit",checked:t,onChange:n})}),r.statements.map((a,i)=>e.jsx(A.Paragraph,{children:e.jsx(Y,{count:a.excludes.length,color:"cyan",children:e.jsx(ie,{message:a.text,banner:!0,type:i<3?"info":"error"},a.key)})},a.key))]})]})]})}function re({suspect:s,values:t,resolution:n,projection:c,yesPercentage:r,noPercentage:d,complete:a,enoughData:i,testimonyId:u,addEntryToUpdate:l,answers:h,barWidth:p,showName:m}){const o=g=>{const x={...h};x[g]=[...x[g]||[],3],l(u,x)},f=g=>{const x={...h};x[g]=[...x[g]||[],-3],l(u,x)},w=g=>{var S;const x={...h},b=(S=x[g])==null?void 0:S.findIndex(E=>E===3);b!==-1&&b!==void 0&&(x[g]=[...x[g].slice(0,b),...x[g].slice(b+1)]),l(u,x)},j=g=>{var S;const x={...h},b=(S=x[g])==null?void 0:S.findIndex(E=>E===-3);b!==-1&&b!==void 0&&(x[g]=[...x[g].slice(0,b),...x[g].slice(b+1)]),l(u,x)};return e.jsxs(ae,{trigger:"click",title:`Add strong fit/unfit answer to ${s.name.pt}`,content:e.jsxs(k,{vertical:!0,gap:4,children:[e.jsx(A.Text,{type:"secondary",children:t.join(", ")}),e.jsxs(N,{icon:"👍",block:!0,onClick:()=>o(s.id),children:[" ","Add strong fit"]}),e.jsxs(N,{icon:"👎",block:!0,onClick:()=>f(s.id),children:[" ","Add strong unfit"]}),e.jsxs(H.Compact,{children:[e.jsx(N,{icon:"❌",size:"small",block:!0,onClick:()=>w(s.id),children:"fit"}),e.jsx(N,{icon:"❌",size:"small",block:!0,onClick:()=>j(s.id),children:"unfit"})]})]}),children:[m&&e.jsxs("div",{children:[e.jsx(F,{title:s.id,children:s.name.pt})," ",a&&e.jsx(F,{title:"Complete: It has 5 or more answers",children:e.jsx(X,{style:{color:"gold"}})})]}),e.jsxs(k,{align:"flex-start",gap:12,children:[e.jsx(F,{title:`Values: ${t.join(", ")} : ${n||(c?`${c}*`:"")}`,children:i?e.jsx(K,{percent:d+r,size:[p,20],status:"exception",success:{percent:r},showInfo:!1}):e.jsx(K,{percent:d+r,size:[p,10],status:"exception",success:{percent:r},showInfo:!1})}),!m&&a&&e.jsx(F,{title:"Complete: It has 5 or more answers",children:e.jsx(X,{style:{color:"gold"}})})]})]})}function Ue({suspect:s,answersPerQuestion:t,questions:n,addEntryToUpdate:c,allAnswers:r}){const{queryParams:d}=I({sortSuspectsBy:"answers"}),a=d.get("sortSuspectsBy")??"answers";console.log(t),console.log(r);const i=v.useMemo(()=>{const l=Object.values(n).map(h=>{const p=t[h.id]??{},{enoughData:m,reliable:o,yesPercentage:f,noPercentage:w,blankPercentage:j,values:g,total:x,resolution:b,projection:S,complete:E}=_(s.id,{[s.id]:p});return{id:h.id,question:h,enoughData:m,reliable:o,yesPercentage:f,noPercentage:w,blankPercentage:j,values:g,total:x,resolution:b,projection:S,complete:E}});return a==="answers"?y.orderBy(l,["reliable","enoughData","yesPercentage",h=>h.values.length],["desc","desc","desc","desc"]):y.orderBy(l,h=>Number(h.id.split("-")[1]),["asc"])},[t,n,s.id,a]),u=[{key:"id",title:"Id",dataIndex:"id"},{key:"question",title:"Question",dataIndex:"question",render:l=>l.question},{key:"answer",title:"Answer",dataIndex:"id",sorter:(l,h)=>l.total-h.total,render:l=>{const h=i.find(p=>p.id===l);return h?e.jsx(k,{gap:8,wrap:"nowrap",children:e.jsx(re,{values:h.values,resolution:h.resolution,projection:h.projection,yesPercentage:h.yesPercentage,noPercentage:h.noPercentage,complete:h.complete,enoughData:h.enoughData,suspect:s,testimonyId:h.question.id,answers:r[h.question.id]||{},addEntryToUpdate:c,barWidth:120})}):""}}];return e.jsx(H,{wrap:!0,size:"large",children:e.jsx(W,{rowKey:"id",columns:u,dataSource:i,bordered:!0})})}function Xe({isLoading:s,isSuccess:t,questions:n,data:c,suspects:r,addEntryToUpdate:d}){const{queryParams:a,addParam:i}=I(),u=v.useMemo(()=>Object.keys(c).reduce((o,f)=>{const w=c[f]??{};return Object.keys(w).forEach(j=>{o[j]||(o[j]={}),o[j][f]=w[j]}),o},{}),[c]),l=v.useMemo(()=>y.orderBy(Object.values(r).map(o=>({...o,answers:u[o.id]})),o=>Number(o.id.split("-")[1]),"asc"),[r,u]),h=ne({total:l.length,showQuickJumper:!0}),p=[{title:"Id",dataIndex:"id",key:"id",sorter:(o,f)=>Number(o.id.split("-")[1])-Number(f.id.split("-")[1])},{title:"Picture",dataIndex:"id",render:o=>e.jsx(Q,{id:te(o,"gb"),width:48})},{title:"Name",dataIndex:"name",key:"name",sorter:(o,f)=>o.name.pt.localeCompare(f.name.pt),render:o=>o.pt},{title:"Questions Answered",dataIndex:"answers",key:"answers",sorter:(o,f)=>Object.keys(o.answers??{}).length-Object.keys(f.answers??{}).length,render:o=>o?Object.values(o).length:""}],m=se({maxExpandedRows:1,expandedRowRender:o=>e.jsx(Ue,{suspect:o,answersPerQuestion:u[o.id],questions:n,addEntryToUpdate:d,allAnswers:c}),rowExpandable:()=>t});return e.jsxs(k,{gap:12,className:"full-width py-4",vertical:!0,children:[e.jsxs(k,{justify:"space-between",align:"center",children:[e.jsx(A.Title,{level:4,className:"my-0",children:"Testimonies by Suspect"}),e.jsx(D,{checked:a.get("sortSuspectsBy")==="answers",onChange:o=>i("sortSuspectsBy",o?"answers":"id"),checkedChildren:"Sort by Answers",unCheckedChildren:"Sort by Id"})]}),e.jsx(W,{columns:p,dataSource:l,pagination:h,rowKey:"id",expandable:m,loading:s,bordered:!0,className:"full-width"})]})}function Ze({answers:s,suspects:t,addEntryToUpdate:n,testimonyId:c}){const[r,d]=be(12),{queryParams:a,is:i}=I({sortSuspectsBy:"answers"}),u=i("enableBatch"),l=a.get("sortSuspectsBy")??"answers",h=v.useMemo(()=>{const o=Object.keys(t).map(f=>_(f,s));return l==="answers"?y.orderBy(o,["reliable","enoughData",f=>f.values.length,"yesPercentage"],["desc","desc","desc","desc"]):y.orderBy(o,f=>Number(f.suspectCardId.split("-")[1]),["asc"])},[s,t,l]),[p,m]=v.useState([]);return e.jsxs(H,{direction:"vertical",children:[e.jsx(et,{selection:p,setSelection:m,suspects:t,addEntryToUpdate:n,list:h,testimonyId:c,answers:s}),e.jsx(H,{wrap:!0,ref:d,size:"large",children:h.map(o=>e.jsxs(k,{vertical:!0,gap:6,className:ee({"selection-outline":u&&p.includes(o.suspectCardId)}),children:[e.jsx(Q,{id:o.imageId,width:r,className:o.values.length>1?void 0:"grayscale"}),e.jsxs(k,{gap:4,children:[u&&e.jsx(oe,{disabled:o.complete,checked:p.includes(o.suspectCardId),onChange:f=>{const w=f.target.checked;m(j=>w?[...j,o.suspectCardId]:j.filter(g=>g!==o.suspectCardId))}}),e.jsx(re,{values:o.values,resolution:o.resolution,projection:o.projection,yesPercentage:o.yesPercentage,noPercentage:o.noPercentage,complete:o.complete,enoughData:o.enoughData,suspect:t[o.suspectCardId],testimonyId:c,answers:s,addEntryToUpdate:n,barWidth:r,showName:!0})]})]},o.suspectCardId))})]})}function et({testimonyId:s,selection:t,setSelection:n,suspects:c,addEntryToUpdate:r,list:d,answers:a}){const[i,u]=v.useState([]),{addParam:l,removeParam:h,is:p}=I({sortSuspectsBy:"answers"}),m=p("enableBatch"),o=j=>{u(g=>g.includes(j)?g.filter(x=>x!==j):[...g,j])},f=v.useMemo(()=>y.keyBy(d,"suspectCardId"),[d]);v.useEffect(()=>{if(i.length===0&&t.length>0){n([]);return}if(!i.length)return;const g=(t.length>0?t:Object.values(f).filter(x=>!x.complete&&!x.values.includes(3)&&!x.values.includes(-3)).map(x=>x.suspectCardId)).filter(x=>{const b=c[x],S=[b.gender,b.ethnicity,b.build,b.height];return b.age==="18-21"&&S.push("young"),(b.age==="21-30"||b.age==="30-40")&&S.push("adult"),b.age==="40-50"&&S.push("parent"),(b.age==="50-60"||b.age==="60-70"||b.age==="70-80"||b.age==="80-90")&&S.push("senior"),i.every(E=>S.includes(E))});n(g)},[i]);const w=j=>{const g=y.cloneDeep(a);t.forEach(x=>{g[x]=[...g[x]||[],j]}),r(s,g),u([])};return e.jsxs(k,{align:"center",gap:6,justify:"space-between",className:"mb-4",children:[e.jsxs(k,{gap:3,children:[e.jsx(A.Text,{className:"nowrap buceta",style:{minWidth:"5ch"},children:"Batch"}),e.jsx(D,{value:m,checkedChildren:"On",unCheckedChildren:"Off",onChange:j=>{j?l("enableBatch",!0):h("enableBatch")}})]}),m&&e.jsxs(e.Fragment,{children:[e.jsxs(A.Text,{className:"nowrap mr-2",children:["Selected ",t.length]}),e.jsxs(k,{gap:6,wrap:!0,align:"center",justify:"center",children:[e.jsx(P,{filter:"male",activeFilters:i,updateActiveFilter:o}),e.jsx(P,{filter:"female",activeFilters:i,updateActiveFilter:o}),e.jsx(P,{filter:"young",activeFilters:i,updateActiveFilter:o}),e.jsx(P,{filter:"adult",activeFilters:i,updateActiveFilter:o}),e.jsx(P,{filter:"parent",activeFilters:i,updateActiveFilter:o}),e.jsx(P,{filter:"senior",activeFilters:i,updateActiveFilter:o}),e.jsx(P,{filter:"thin",activeFilters:i,updateActiveFilter:o}),e.jsx(P,{filter:"muscular",activeFilters:i,updateActiveFilter:o}),e.jsx(P,{filter:"large",activeFilters:i,updateActiveFilter:o}),e.jsx(P,{filter:"asian",activeFilters:i,updateActiveFilter:o}),e.jsx(P,{filter:"black",activeFilters:i,updateActiveFilter:o}),e.jsx(P,{filter:"caucasian",activeFilters:i,updateActiveFilter:o}),e.jsx(P,{filter:"latino",activeFilters:i,updateActiveFilter:o})]}),e.jsxs(k,{align:"center",gap:6,children:[e.jsx(N,{onClick:()=>u([]),danger:!0,size:"small",children:"Clear"}),e.jsx(U,{title:"Apply +3 to selected suspects?",onConfirm:()=>w(3),children:e.jsx(N,{disabled:t.length===0,size:"small",type:"primary",className:"ml-10",children:"Apply +3"})}),e.jsx(Z,{type:"vertical"}),e.jsx(U,{title:"Apply -3 to selected suspects?",onConfirm:()=>w(-3),children:e.jsx(N,{disabled:t.length===0,size:"small",type:"primary",children:"Apply -3"})})]})]})]})}function P({filter:s,activeFilters:t,updateActiveFilter:n}){return e.jsxs(e.Fragment,{children:[e.jsxs("span",{children:[e.jsx(oe,{checked:t.includes(s),onClick:()=>n(s)})," ",y.capitalize(s)]}),e.jsx(Z,{type:"vertical"})]})}function tt({data:s,questions:t,suspects:n,isLoading:c,isSuccess:r,addEntryToUpdate:d}){const{queryParams:a,addParam:i}=I(),u=v.useMemo(()=>y.orderBy(Object.values(t),m=>Number(m.id.split("-")[1]),"asc"),[t]),l=ne({total:u.length,showQuickJumper:!0}),h=[{title:"Id",dataIndex:"id",key:"id",sorter:(m,o)=>Number(m.id.split("-")[1])-Number(o.id.split("-")[1])},{title:"Question",dataIndex:"question",key:"question",sorter:(m,o)=>m.question.localeCompare(o.question)},{title:"NSFW",dataIndex:"nsfw",key:"nsfw",render:m=>m?e.jsx(ye,{style:{color:"hotPink"}}):"",sorter:(m,o)=>Number(m.nsfw)-Number(o.nsfw)},{title:"Answers",dataIndex:"id",key:"answers",render:m=>{const o=s[m];return o?Object.values(o).length:""}}],p=se({maxExpandedRows:1,expandedRowRender:m=>e.jsx(Ze,{testimonyId:m.id,answers:s[m.id]??{},suspects:n,addEntryToUpdate:d}),rowExpandable:()=>r});return e.jsxs(k,{gap:12,className:"full-width py-4",vertical:!0,children:[e.jsxs(k,{justify:"space-between",align:"center",children:[e.jsx(A.Title,{level:4,className:"my-0",children:"Suspects by Testimony"}),e.jsx(D,{checked:a.get("sortSuspectsBy")==="answers",onChange:m=>i("sortSuspectsBy",m?"answers":"id"),checkedChildren:"Sort by Answers",unCheckedChildren:"Sort by Id"})]}),e.jsx(W,{columns:h,dataSource:u,pagination:l,rowKey:"id",expandable:p,loading:c,bordered:!0,className:"full-width"})]})}function st(s){const{queryParams:t,is:n}=I();return e.jsxs(e.Fragment,{children:[(n("display","questions")||!t.get("display"))&&e.jsx(tt,{...s}),n("display","suspects")&&e.jsx(Xe,{...s}),n("display","simulator")&&e.jsx(Ye,{})]})}function nt({data:s,hasNewData:t,isDirty:n,save:c,isSaving:r,entriesToUpdate:d}){const{queryParams:a,addParams:i}=I(),u=v.useMemo(()=>{const l={};return Object.values(s).forEach(h=>{Object.keys(h).forEach(p=>{h[p]&&(l[p]||(l[p]=0),Se(h[p])>=5&&(l[p]+=1))})}),{queriedTestimoniesCount:Object.keys(s).length,suspectsCount:Object.keys(l).length,reliableSuspectsCount:Object.values(l).filter(h=>h>=5).length}},[s]);return e.jsxs(e.Fragment,{children:[e.jsx(z,{children:e.jsxs(k,{vertical:!0,gap:12,children:[e.jsx(we,{isDirty:n,onSave:c,isSaving:r,dirt:JSON.stringify(d)}),e.jsx(je,{data:async()=>await ot(s),fileName:"testimony-answers.json",disabled:n,hasNewData:t,block:!0})]})}),e.jsx(z,{children:e.jsx(xe,{label:"Display",value:a.get("display")??"questions",onChange:l=>i({display:l,page:1},{page:1}),options:[{title:"Questions",icon:e.jsx(Pe,{}),value:"questions"},{title:"Suspects",icon:e.jsx(Te,{}),value:"suspects"},{title:"Simulator",icon:e.jsx(Fe,{}),value:"simulator"}]})}),e.jsx(z,{children:e.jsxs("div",{style:{fontSize:"0.85em"},children:[e.jsx("strong",{children:"Legend"}),e.jsxs("ul",{children:[e.jsx("li",{children:"Reliability: At least 5 votes"}),e.jsx("li",{children:"Large Bars: There's enough data (at least 3)"}),e.jsx("li",{children:"Small blue bar: in progress negative"})]})]})}),e.jsx(z,{children:e.jsxs("div",{style:{fontSize:"0.85em"},children:[e.jsx("strong",{children:"Counts"}),e.jsxs("ul",{children:[e.jsxs("li",{children:["Testimonies: ",u.queriedTestimoniesCount]}),e.jsxs("li",{children:["Suspects: ",u.suspectsCount]}),e.jsx("li",{children:e.jsxs(F,{title:"A reliable suspect is one that has at least 5 complete testimonies.",children:["Reliable suspects: ",u.reliableSuspectsCount]})})]})]})})]})}async function ot(s){console.log("Preparing file for download...x");const t=await ve("data","testimonies")(),n=Ce(t);console.log("Parsed data from Firestore:",n);const c=y.cloneDeep(s);return Object.keys(c).forEach(r=>{const d=c[r],a=n[r]||{};Object.keys(d).forEach(i=>{const u=a[i]||[],l=Me([...d[i],...u]);d[i]=l})}),Ee(Oe(c))}function Kt(){const s=ke();return e.jsx(ce,{title:"Testimonies",subtitle:"Suspect Testimony Rates",children:e.jsxs(J,{hasSider:!0,children:[e.jsx(ue,{children:e.jsx(nt,{...s})}),e.jsx(J.Content,{className:"content",children:e.jsx(le,{isLoading:s.isLoading,error:s.error,hasResponseData:!y.isEmpty(s.data),children:e.jsx(st,{...s})})})]})})}export{Kt as TestimoniesPage,Kt as default};
