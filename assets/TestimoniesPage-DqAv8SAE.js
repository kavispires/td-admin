import{r as w,a as B,_ as $,j as e,T as O,B as C,at as Y,ao as pe,G as z,D as se,aq as ge,P as je,L as G}from"./index-BUCQLO0w.js";import{D as xe}from"./DataLoadingWrapper-KtIEp7Y2.js";import{l as T,c as re,P as be}from"./useBaseUrl-C8kAU6ch.js";import{u as P}from"./useQueryParams-B9khQq8x.js";import{R as we}from"./main-CME1OJve.js";import{u as ye,a as ie,c as ve,n as Se,b as ke}from"./useTestimoniesResource-DIdt4Z8g.js";import{g as Ce}from"./useParsedHistory-CG5N1ZbC.js";import{S as H}from"./SuspectImageCard-BnA3g3Qb.js";import{u as Oe}from"./useTDResource-B4HyOAy_.js";import{F as k}from"./index-ZkMgzlNO.js";import{T as oe,S as Te,F as Re}from"./FilterEntries-DQ9pFqHJ.js";import{B as q,D as ce}from"./DownloadButton-7WxXnfbE.js";import{S as F}from"./index-_sx3ox9_.js";import{u as ae}from"./useTableExpandableRows-DYzGCqCN.js";import{u as le}from"./useTablePagination-DaBe2OU4.js";import{P as K}from"./progress-CQLNKmbg.js";import{S as E}from"./index-mJYGwyu9.js";import{F as Q}from"./Table-D3GwGAv-.js";import{I as Ie}from"./index-D5Lk72Tc.js";import{u as De}from"./useCardWidth-DK4JtuC0.js";import{C as ue}from"./index-Ryw6SLTC.js";import{P as J}from"./index-DXqFwdmJ.js";import{R as Pe}from"./FireFilled-LLZLtkEv.js";import{S as V}from"./SiderContent-BTI1XaoE.js";import{F as Ae,a as Ne}from"./FirestoreConsoleLink-eVpuVM2y.js";import{S as Me}from"./SaveButton-Dab0M01Y.js";import{S as Fe}from"./SuspectsStyleVariantSelector-RH7cCdyf.js";import{g as Ee}from"./useGetFirestoreDoc-D2sQmMXt.js";import{e as ze,a as Be,d as $e}from"./index-CyrvyyDs.js";import{u as de}from"./useWindowSize-Cwq6ZONG.js";import{M as he}from"./index-UnxzIzdS.js";import{R as He}from"./TableOutlined-DJ4Lq8QF.js";import{R as Le}from"./RobotOutlined-BG8Eu-gI.js";import"./useResourceFirestoreData-DS-Ud6M5.js";import"./useUpdateFirestoreDoc-zr8kc8W5.js";import"./useMutation-DyqpvZjD.js";import"./moment-C5S46NFB.js";import"./ImageCard-jZKdwy17.js";import"./gapSize-U1swVQyS.js";import"./index-B5RqVnhD.js";import"./index-ClWB0cin.js";import"./index-DE0g4Jif.js";import"./index-CPa9D6oZ.js";import"./scrollTo-C3-IxNFy.js";import"./Pagination-8dcugb3U.js";import"./Input-BnTeV5TB.js";import"./SaveOutlined-D4aoFKMR.js";import"./constants-DbPBHhY7.js";import"./Item-DFYBH5R0.js";var Ve={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M864 144H560c-8.8 0-16 7.2-16 16v304c0 8.8 7.2 16 16 16h304c8.8 0 16-7.2 16-16V160c0-8.8-7.2-16-16-16zm0 400H560c-8.8 0-16 7.2-16 16v304c0 8.8 7.2 16 16 16h304c8.8 0 16-7.2 16-16V560c0-8.8-7.2-16-16-16zM464 144H160c-8.8 0-16 7.2-16 16v304c0 8.8 7.2 16 16 16h304c8.8 0 16-7.2 16-16V160c0-8.8-7.2-16-16-16zm0 400H160c-8.8 0-16 7.2-16 16v304c0 8.8 7.2 16 16 16h304c8.8 0 16-7.2 16-16V560c0-8.8-7.2-16-16-16z"}}]},name:"appstore",theme:"filled"},qe=function(r,o){return w.createElement(B,$({},r,{ref:o,icon:Ve}))},Ue=w.forwardRef(qe),Qe={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M512 624c93.9 0 170-75.2 170-168V232c0-92.8-76.1-168-170-168s-170 75.2-170 168v224c0 92.8 76.1 168 170 168zm330-170c0-4.4-3.6-8-8-8h-60c-4.4 0-8 3.6-8 8 0 140.3-113.7 254-254 254S258 594.3 258 454c0-4.4-3.6-8-8-8h-60c-4.4 0-8 3.6-8 8 0 168.7 126.6 307.9 290 327.6V884H326.7c-13.7 0-24.7 14.3-24.7 32v36c0 4.4 2.8 8 6.2 8h407.6c3.4 0 6.2-3.6 6.2-8v-36c0-17.7-11-32-24.7-32H548V782.1c165.3-18 294-158 294-328.1z"}}]},name:"audio",theme:"filled"},We=function(r,o){return w.createElement(B,$({},r,{ref:o,icon:Qe}))},_e=w.forwardRef(We),Ye={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M594.3 601.5a111.8 111.8 0 0029.1-75.5c0-61.9-49.9-112-111.4-112s-111.4 50.1-111.4 112c0 29.1 11 55.5 29.1 75.5a158.09 158.09 0 00-74.6 126.1 8 8 0 008 8.4H407c4.2 0 7.6-3.3 7.9-7.5 3.8-50.6 46-90.5 97.2-90.5s93.4 40 97.2 90.5c.3 4.2 3.7 7.5 7.9 7.5H661a8 8 0 008-8.4c-2.8-53.3-32-99.7-74.7-126.1zM512 578c-28.5 0-51.7-23.3-51.7-52s23.2-52 51.7-52 51.7 23.3 51.7 52-23.2 52-51.7 52zm416-354H768v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H548v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H328v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H96c-17.7 0-32 14.3-32 32v576c0 17.7 14.3 32 32 32h832c17.7 0 32-14.3 32-32V256c0-17.7-14.3-32-32-32zm-40 568H136V296h120v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h148v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h148v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h120v496z"}}]},name:"contacts",theme:"outlined"},Ge=function(r,o){return w.createElement(B,$({},r,{ref:o,icon:Ye}))},Ke=w.forwardRef(Ge),Je={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M870 126H663.8c-17.4 0-32.9 11.9-37 29.3C614.3 208.1 567 246 512 246s-102.3-37.9-114.8-90.7a37.93 37.93 0 00-37-29.3H154a44 44 0 00-44 44v252a44 44 0 0044 44h75v388a44 44 0 0044 44h478a44 44 0 0044-44V466h75a44 44 0 0044-44V170a44 44 0 00-44-44z"}}]},name:"skin",theme:"filled"},Xe=function(r,o){return w.createElement(B,$({},r,{ref:o,icon:Je}))},Ze=w.forwardRef(Xe),et={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M868 160h-92v-40c0-4.4-3.6-8-8-8H256c-4.4 0-8 3.6-8 8v40h-92a44 44 0 00-44 44v148c0 81.7 60 149.6 138.2 162C265.6 630.2 359 721.8 476 734.5v105.2H280c-17.7 0-32 14.3-32 32V904c0 4.4 3.6 8 8 8h512c4.4 0 8-3.6 8-8v-32.3c0-17.7-14.3-32-32-32H548V734.5C665 721.8 758.4 630.2 773.8 514 852 501.6 912 433.7 912 352V204a44 44 0 00-44-44zM248 439.6c-37.1-11.9-64-46.7-64-87.6V232h64v207.6zM840 352c0 41-26.9 75.8-64 87.6V232h64v120z"}}]},name:"trophy",theme:"filled"},tt=function(r,o){return w.createElement(B,$({},r,{ref:o,icon:et}))},X=w.forwardRef(tt);function nt(){var t=w.useRef(!0);return t.current?(t.current=!1,!0):t.current}function st(t,r){return typeof t=="function"?t.length?t(r):t():t}function me(t,r,o){if(r===void 0&&(r=10),r<1)throw new Error("Capacity has to be greater than 1, got '"+r+"'");var u=nt(),m=w.useState(t),g=m[0],h=m[1],c=w.useRef([]),n=w.useRef(0);u&&(c.current.length?(c.current[c.current.length-1]!==t&&c.current.push(t),c.current.length>r&&(c.current=c.current.slice(c.current.length-r))):c.current.push(t),n.current=c.current.length&&c.current.length-1);var f=w.useCallback(function(s){h(function(i){return s=st(s,i),s!==i&&(n.current<c.current.length-1&&(c.current=c.current.slice(0,n.current+1)),n.current=c.current.push(s)-1,c.current.length>r&&(c.current=c.current.slice(c.current.length-r))),s})},[g,r]),l=w.useMemo(function(){return{history:c.current,position:n.current,capacity:r,back:function(s){s===void 0&&(s=1),n.current&&h(function(){return n.current-=Math.min(s,n.current),c.current[n.current]})},forward:function(s){s===void 0&&(s=1),n.current!==c.current.length-1&&h(function(){return n.current=Math.min(n.current+s,c.current.length-1),c.current[n.current]})},go:function(s){s!==n.current&&h(function(){return n.current=s<0?Math.max(c.current.length+s,0):Math.min(c.current.length-1,s),c.current[n.current]})}}},[g]);return[g,f,l]}function rt(){const[t,r]=w.useState({batchSize:1,history:{}}),o=w.useRef(1),{entries:u}=ye(!0,"pt",t.batchSize,t.history),m=Oe("suspects",!T.isEmpty(u));return console.log(ot(u,m.data??{})),e.jsxs(k,{className:"p-4",gap:12,vertical:!0,children:[e.jsxs(k,{align:"center",justify:"space-between",children:[e.jsx(O.Title,{className:"my-0",level:4,children:"Espionagem Simulator"}),e.jsxs(k,{gap:6,children:[e.jsx(oe,{defaultValue:1,max:100,min:1,onChange:g=>{o.current=g??1}}),e.jsx(C,{onClick:()=>r({batchSize:o.current,history:{}}),type:"primary",children:"Re-run Simulation"})]})]}),e.jsx(it,{entries:u})]})}function it({entries:t}){const[r,o]=w.useState(!1),u=Ce(),m=t[u],g=w.useMemo(()=>m?m.statements.reduce((h,c)=>{const{excludes:n}=c;return n.forEach(f=>{h[f]?h[f]++:h[f]=1}),h},{}):{},[m]);return e.jsxs("div",{className:"full-width grid",style:{gridTemplateColumns:"2fr 3fr"},children:[e.jsx(we,{collapsed:3,src:t??{},theme:"twilight"}),e.jsx("div",{children:m&&e.jsxs(k,{className:"p-4",gap:18,children:[e.jsx("div",{children:e.jsx("div",{style:{width:`${105*4}px`,display:"grid",gap:"6px",gridTemplateColumns:"repeat(4, 1fr)"},children:m.suspects.map(h=>e.jsxs(q.Ribbon,{color:"cyan",text:r?g[h.id]:null,children:[e.jsx(H,{className:re(r&&h.id===m.culpritId&&"red-border"),id:h.id,width:96},h.id),e.jsxs(k,{align:"center",gap:6,children:[e.jsx(F,{checkedChildren:"ðŸš«",size:"small"})," ",h.id]})]},h.id))})}),e.jsxs("div",{children:[e.jsx("div",{children:e.jsx(F,{checked:r,checkedChildren:"Show Culprit",onChange:o,unCheckedChildren:"Hide Culprit"})}),m.statements.map(h=>e.jsx(O.Paragraph,{children:e.jsx(q,{color:"cyan",count:h.excludes.length,children:e.jsx(Y,{banner:!0,icon:Z(h.type),message:h.text,type:"info"},h.key)})},h.key)),m.additionalStatements.map(h=>e.jsx(O.Paragraph,{children:e.jsx(q,{color:"cyan",count:h.excludes.length,children:e.jsx(Y,{banner:!0,icon:Z(h.type),message:h.text,type:"warning"},h.key)})},h.key))]})]})})]})}const Z=t=>{switch(t){case"testimony":return e.jsx(_e,{});case"feature":return e.jsx(Ze,{});case"grid":return e.jsx(Ue,{});default:return"â“"}},ot=(t,r)=>{const o=Object.values(t).reduce((u,m)=>(m.suspects.forEach(g=>{u[g.id]=(u[g.id]||0)+1,g.id===m.culpritId&&(u[`${g.id}_culprit`]=(u[`${g.id}_culprit`]||0)+1)}),u),{});return Object.values(r).forEach(u=>{o[u.id]||(o[u.id]=0),o[`${u.id}_culprit`]||(o[`${u.id}_culprit`]=0)}),o};function fe({suspect:t,values:r,resolution:o,projection:u,yesPercentage:m,noPercentage:g,complete:h,enoughData:c,testimonyId:n,addEntryToUpdate:f,answers:l,barWidth:s,showName:i}){const a=j=>{const p={...l};p[j]=[...p[j]||[],3],f(n,p)},d=j=>{const p={...l};p[j]=[...p[j]||[],-3],f(n,p)},x=j=>{var y;const p={...l},v=(y=p[j])==null?void 0:y.findIndex(S=>S===3);v!==-1&&v!==void 0&&(p[j]=[...p[j].slice(0,v),...p[j].slice(v+1)]),f(n,p)},b=j=>{var y;const p={...l},v=(y=p[j])==null?void 0:y.findIndex(S=>S===-3);v!==-1&&v!==void 0&&(p[j]=[...p[j].slice(0,v),...p[j].slice(v+1)]),f(n,p)};return e.jsxs(pe,{content:e.jsxs(k,{gap:4,vertical:!0,children:[e.jsx(O.Text,{type:"secondary",children:r.join(", ")}),e.jsxs(C,{block:!0,icon:"ðŸ‘",onClick:()=>a(t.id),children:[" ","Add strong fit"]}),e.jsxs(C,{block:!0,icon:"ðŸ‘Ž",onClick:()=>d(t.id),children:[" ","Add strong unfit"]}),e.jsxs(E.Compact,{children:[e.jsx(C,{block:!0,icon:"âŒ",onClick:()=>x(t.id),size:"small",children:"fit"}),e.jsx(C,{block:!0,icon:"âŒ",onClick:()=>b(t.id),size:"small",children:"unfit"})]})]}),title:`Add strong fit/unfit answer to ${t.name.pt}`,trigger:"click",children:[i&&e.jsxs("div",{children:[e.jsx(z,{title:t.id,children:t.name.pt})," ",h&&e.jsx(z,{title:"Complete: It has 5 or more answers",children:e.jsx(X,{style:{color:"gold"}})})]}),e.jsxs(k,{align:"flex-start",gap:12,children:[e.jsx(z,{title:`Values: ${r.join(", ")} : ${o||(u?`${u}*`:"")}`,children:c?e.jsx(K,{percent:g+m,showInfo:!1,size:[s,20],status:"exception",success:{percent:m}}):e.jsx(K,{percent:g+m,showInfo:!1,size:[s,10],status:"exception",success:{percent:m}})}),!i&&h&&e.jsx(z,{title:"Complete: It has 5 or more answers",children:e.jsx(X,{style:{color:"gold"}})})]})]})}function ct({suspect:t,answersPerQuestion:r={},questions:o,addEntryToUpdate:u,allAnswers:m}){const{queryParams:g}=P({sortSuspectsBy:"answers"}),h=g.get("sortSuspectsBy")??"answers",c=w.useMemo(()=>{const l=Object.values(o).map(s=>{const i=r[s.id]??{},{enoughData:a,reliable:d,yesPercentage:x,noPercentage:b,blankPercentage:j,values:p,total:v,resolution:y,projection:S,complete:R}=ie(t.id,{[t.id]:i});return{id:s.id,question:s,enoughData:a,reliable:d,yesPercentage:x,noPercentage:b,blankPercentage:j,values:p,total:v,resolution:y,projection:S,complete:R}});return h==="answers"?T.orderBy(l,["reliable","enoughData","yesPercentage",s=>s.values.length],["desc","desc","desc","desc"]):T.orderBy(l,s=>Number(s.id.split("-")[1]),["asc"])},[r,o,t.id,h]),n=w.useMemo(()=>at(t,c),[t,c]),f=[{key:"id",title:"Id",dataIndex:"id"},{key:"question",title:"Question",dataIndex:"question",render:l=>l.question},{key:"answer",title:"Answer",dataIndex:"id",sorter:(l,s)=>l.total-s.total,render:l=>{const s=c.find(i=>i.id===l);return s?e.jsx(k,{gap:8,wrap:"nowrap",children:e.jsx(fe,{addEntryToUpdate:u,answers:m[s.question.id]||{},barWidth:120,complete:s.complete,enoughData:s.enoughData,noPercentage:s.noPercentage,projection:s.projection,resolution:s.resolution,suspect:t,testimonyId:s.question.id,values:s.values,yesPercentage:s.yesPercentage})}):""}},{key:"actions",title:"Actions",dataIndex:"id",render:l=>{const s=c.find(i=>i.id===l);return s?e.jsx(lt,{addEntryToUpdate:u,answers:m[s.question.id]||{},suspect:t,testimonyId:s.question.id}):""}}];return e.jsxs(E,{size:"large",wrap:!0,children:[e.jsx(Q,{bordered:!0,columns:f,dataSource:c,rowKey:"id"}),e.jsxs(k,{gap:8,vertical:!0,children:[e.jsx(O.Title,{level:5,children:"Suspect Description"}),e.jsx(Ie.TextArea,{className:"full-width",readOnly:!0,rows:7,value:n})]})]})}const at=(t,r)=>{const o=r.filter(u=>u.resolution||u.projection).map(u=>{const{question:m,resolution:g,projection:h}=u,c=g||h;return`${t.gender==="male"?"ele":"ela"} ${c==="ðŸ‘"?"":"nÃ£o "}${m.answer.toLocaleLowerCase()}`});return`${t.name.pt}: ${o.join(", ")}`};function lt({suspect:t,testimonyId:r,addEntryToUpdate:o,answers:u}){const m=n=>{const f={...u};f[n]=[...f[n]||[],3],o(r,f)},g=n=>{const f={...u};f[n]=[...f[n]||[],-3],o(r,f)},h=n=>{var s;const f={...u},l=(s=f[n])==null?void 0:s.findIndex(i=>i===3);l!==-1&&l!==void 0&&(f[n]=[...f[n].slice(0,l),...f[n].slice(l+1)]),o(r,f)},c=n=>{var s;const f={...u},l=(s=f[n])==null?void 0:s.findIndex(i=>i===-3);l!==-1&&l!==void 0&&(f[n]=[...f[n].slice(0,l),...f[n].slice(l+1)]),o(r,f)};return e.jsxs(E.Compact,{children:[e.jsxs(C,{block:!0,icon:"ðŸ‘",onClick:()=>m(t.id),children:[" ","FIT"]}),e.jsxs(C,{block:!0,icon:"ðŸ‘Ž",onClick:()=>g(t.id),children:[" ","UNFIT"]}),e.jsx(C,{icon:"âŒ",onClick:()=>h(t.id),children:"DESFIT"}),e.jsx(C,{icon:"âŒ",onClick:()=>c(t.id),children:"DESUNFIT"})]})}function ut({isLoading:t,isSuccess:r,questions:o,data:u,suspects:m,addEntryToUpdate:g}){const{queryParams:h,addParam:c}=P(),n=Object.values(o).map(({id:d,question:x})=>({id:d,question:x})),f=w.useMemo(()=>Object.keys(u).reduce((d,x)=>{const b=u[x]??{};return Object.keys(b).forEach(j=>{d[j]||(d[j]={}),d[j][x]=b[j]}),d},{}),[u]),l=w.useMemo(()=>T.orderBy(Object.values(m).map(d=>({...d,answers:f[d.id]})),d=>Number(d.id.split("-")[1]),"asc"),[m,f]),s=le({total:l.length,showQuickJumper:!0}),i=[{title:"Id",dataIndex:"id",key:"id",sorter:(d,x)=>Number(d.id.split("-")[1])-Number(x.id.split("-")[1])},{title:"Picture",dataIndex:"id",render:d=>e.jsx(H,{id:d,width:48})},{title:"Name",dataIndex:"name",key:"name",sorter:(d,x)=>d.name.pt.localeCompare(x.name.pt),render:(d,x)=>e.jsxs(k,{vertical:!0,children:[e.jsx(O.Text,{children:d.pt}),e.jsx(O.Text,{type:"secondary",children:d.en}),e.jsx(O.Text,{italic:!0,type:"secondary",children:e.jsx("small",{children:x.note})})]})},{title:"Questions Answered",dataIndex:"answers",key:"answers",sorter:(d,x)=>Object.keys(d.answers??{}).length-Object.keys(x.answers??{}).length,render:d=>d?Object.values(d).length:""}],a=ae({maxExpandedRows:1,expandedRowRender:d=>e.jsx(ct,{addEntryToUpdate:g,allAnswers:u,answersPerQuestion:d.answers,questions:o,suspect:d}),rowExpandable:()=>r});return e.jsxs(k,{className:"full-width py-4",gap:12,vertical:!0,children:[e.jsxs(k,{align:"center",justify:"space-between",children:[e.jsx(O.Title,{className:"my-0",level:4,children:"Testimonies by Suspect"}),e.jsx(ce,{data:n,fileName:"newQuestions.json"}),e.jsx(F,{checked:h.get("sortSuspectsBy")==="answers",checkedChildren:"Sort by Answers",onChange:d=>c("sortSuspectsBy",d?"answers":"id"),unCheckedChildren:"Sort by Id"})]}),e.jsx(Q,{bordered:!0,className:"full-width",columns:i,dataSource:l,expandable:a,loading:t,pagination:s,rowKey:"id"})]})}function dt({answers:t,suspects:r,addEntryToUpdate:o,testimonyId:u}){const[m,g]=De(12),{queryParams:h,is:c}=P({sortSuspectsBy:"answers"}),n=c("enableBatch"),f=h.get("sortSuspectsBy")??"answers",l=w.useMemo(()=>{const a=Object.keys(r).map(d=>ie(d,t));return f==="answers"?T.orderBy(a,["reliable","enoughData",d=>d.values.length,"yesPercentage","noPercentage",d=>Number(d.suspectCardId.split("-")[1])],["desc","desc","desc","desc","desc","asc"]):T.orderBy(a,d=>Number(d.suspectCardId.split("-")[1]),["asc"])},[t,r,f]),[s,i]=w.useState([]);return e.jsxs(E,{direction:"vertical",children:[e.jsx(ht,{addEntryToUpdate:o,answers:t,list:l,selection:s,setSelection:i,suspects:r,testimonyId:u}),e.jsx(E,{ref:g,size:"large",wrap:!0,children:l.map(a=>e.jsxs(k,{className:re({"selection-outline":n&&s.includes(a.suspectCardId)}),gap:6,vertical:!0,children:[e.jsx(H,{className:a.values.length>1?void 0:"grayscale",id:a.imageId,width:m}),e.jsxs(k,{gap:4,children:[n&&e.jsx(ue,{checked:s.includes(a.suspectCardId),disabled:a.complete,onChange:d=>{const x=d.target.checked;i(b=>x?[...b,a.suspectCardId]:b.filter(j=>j!==a.suspectCardId))}}),e.jsx(fe,{addEntryToUpdate:o,answers:t,barWidth:m,complete:a.complete,enoughData:a.enoughData,noPercentage:a.noPercentage,projection:a.projection,resolution:a.resolution,showName:!0,suspect:r[a.suspectCardId],testimonyId:u,values:a.values,yesPercentage:a.yesPercentage})]})]},a.suspectCardId))})]})}function ht({testimonyId:t,selection:r,setSelection:o,suspects:u,addEntryToUpdate:m,list:g,answers:h}){const[c,n]=w.useState([]),{addParam:f,removeParam:l,is:s}=P({sortSuspectsBy:"answers"}),i=s("enableBatch"),a=b=>{n(j=>j.includes(b)?j.filter(p=>p!==b):[...j,b])},d=w.useMemo(()=>T.keyBy(g,"suspectCardId"),[g]);w.useEffect(()=>{if(c.length===0&&r.length>0){o([]);return}if(!c.length)return;const j=(r.length>0?r:Object.values(d).filter(p=>!p.complete&&!p.values.includes(3)&&!p.values.includes(-3)).map(p=>p.suspectCardId)).filter(p=>{const v=u[p],y=[v.gender,v.ethnicity,v.build,v.height];return v.age==="18-21"&&y.push("young"),(v.age==="21-30"||v.age==="30-40")&&y.push("adult"),v.age==="40-50"&&y.push("parent"),(v.age==="50-60"||v.age==="60-70"||v.age==="70-80"||v.age==="80-90")&&y.push("senior"),c.every(S=>y.includes(S))});o(j)},[c]);const x=b=>{const j=T.cloneDeep(h);r.forEach(p=>{j[p]=[...j[p]||[],b]}),m(t,j),n([])};return e.jsxs(k,{align:"center",className:"mb-4",gap:6,justify:"space-between",children:[e.jsxs(k,{gap:3,children:[e.jsx(O.Text,{className:"nowrap",style:{minWidth:"5ch"},children:"Batch"}),e.jsx(F,{checkedChildren:"On",onChange:b=>{b?f("enableBatch",!0):l("enableBatch")},unCheckedChildren:"Off",value:i})]}),i&&e.jsxs(e.Fragment,{children:[e.jsxs(O.Text,{className:"nowrap mr-2",children:["Selected ",r.length]}),e.jsxs(k,{align:"center",gap:6,justify:"center",wrap:!0,children:[e.jsx(D,{activeFilters:c,filter:"male",updateActiveFilter:a}),e.jsx(D,{activeFilters:c,filter:"female",updateActiveFilter:a}),e.jsx(D,{activeFilters:c,filter:"young",updateActiveFilter:a}),e.jsx(D,{activeFilters:c,filter:"adult",updateActiveFilter:a}),e.jsx(D,{activeFilters:c,filter:"parent",updateActiveFilter:a}),e.jsx(D,{activeFilters:c,filter:"senior",updateActiveFilter:a}),e.jsx(D,{activeFilters:c,filter:"thin",updateActiveFilter:a}),e.jsx(D,{activeFilters:c,filter:"muscular",updateActiveFilter:a}),e.jsx(D,{activeFilters:c,filter:"large",updateActiveFilter:a}),e.jsx(D,{activeFilters:c,filter:"asian",updateActiveFilter:a}),e.jsx(D,{activeFilters:c,filter:"black",updateActiveFilter:a}),e.jsx(D,{activeFilters:c,filter:"caucasian",updateActiveFilter:a}),e.jsx(D,{activeFilters:c,filter:"latino",updateActiveFilter:a})]}),e.jsxs(k,{align:"center",gap:6,children:[e.jsx(C,{danger:!0,onClick:()=>n([]),size:"small",children:"Clear"}),e.jsx(J,{onConfirm:()=>x(3),title:"Apply +3 to selected suspects?",children:e.jsx(C,{className:"ml-10",disabled:r.length===0,size:"small",type:"primary",children:"Apply +3"})}),e.jsx(se,{type:"vertical"}),e.jsx(J,{onConfirm:()=>x(-3),title:"Apply -3 to selected suspects?",children:e.jsx(C,{disabled:r.length===0,size:"small",type:"primary",children:"Apply -3"})})]})]})]})}function D({filter:t,activeFilters:r,updateActiveFilter:o}){return e.jsxs(e.Fragment,{children:[e.jsxs("span",{children:[e.jsx(ue,{checked:r.includes(t),onClick:()=>o(t)})," ",T.capitalize(t)]}),e.jsx(se,{type:"vertical"})]})}function mt({data:t,questions:r,suspects:o,isLoading:u,isSuccess:m,addEntryToUpdate:g}){const{queryParams:h,addParam:c}=P(),n=w.useMemo(()=>T.orderBy(Object.values(r).map(i=>({...i,answersCount:Object.values(t[i.id]??{}).length})),i=>Number(i.id.split("-")[1]),"asc"),[r]),f=le({total:n.length,showQuickJumper:!0}),l=[{title:"Id",dataIndex:"id",key:"id",sorter:(i,a)=>Number(i.id.split("-")[1])-Number(a.id.split("-")[1])},{title:"Question",dataIndex:"question",key:"question",sorter:(i,a)=>i.question.localeCompare(a.question)},{title:"NSFW",dataIndex:"nsfw",key:"nsfw",render:i=>i?e.jsx(Pe,{style:{color:"hotPink"}}):"",sorter:(i,a)=>Number(i.nsfw)-Number(a.nsfw)},{title:"Answers",dataIndex:"answersCount",key:"answersCount",sorter:(i,a)=>i.answersCount-a.answersCount}],s=ae({maxExpandedRows:1,expandedRowRender:i=>e.jsx(dt,{addEntryToUpdate:g,answers:t[i.id]??{},suspects:o,testimonyId:i.id}),rowExpandable:()=>m});return e.jsxs(k,{className:"full-width py-4",gap:12,vertical:!0,children:[e.jsxs(k,{align:"center",justify:"space-between",children:[e.jsx(O.Title,{className:"my-0",level:4,children:"Suspects by Testimony"}),e.jsx(F,{checked:h.get("sortSuspectsBy")==="answers",checkedChildren:"Sort by Answers",onChange:i=>c("sortSuspectsBy",i?"answers":"id"),unCheckedChildren:"Sort by Id"})]}),e.jsx(Q,{bordered:!0,className:"full-width",columns:l,dataSource:n,expandable:s,loading:u,pagination:f,rowKey:"id"})]})}function ft(t){const{queryParams:r,is:o}=P();return e.jsxs(e.Fragment,{children:[(o("display","questions")||!r.get("display"))&&e.jsx(mt,{...t}),o("display","suspects")&&e.jsx(ut,{...t}),o("display","simulator")&&e.jsx(rt,{})]})}const pt="Left",gt="Right",jt="Up",xt="Down",M={delta:10,preventScrollOnSwipe:!1,rotationAngle:0,trackMouse:!1,trackTouch:!0,swipeDuration:1/0,touchEventOptions:{passive:!0}},U={first:!0,initial:[0,0],start:0,swiping:!1,xy:[0,0]},ee="mousemove",te="mouseup",bt="touchend",wt="touchmove",yt="touchstart";function vt(t,r,o,u){return t>r?o>0?gt:pt:u>0?xt:jt}function ne(t,r){if(r===0)return t;const o=Math.PI/180*r,u=t[0]*Math.cos(o)+t[1]*Math.sin(o),m=t[1]*Math.cos(o)-t[0]*Math.sin(o);return[u,m]}function St(t,r){const o=l=>{const s="touches"in l;s&&l.touches.length>1||t((i,a)=>{a.trackMouse&&!s&&(document.addEventListener(ee,u),document.addEventListener(te,h));const{clientX:d,clientY:x}=s?l.touches[0]:l,b=ne([d,x],a.rotationAngle);return a.onTouchStartOrOnMouseDown&&a.onTouchStartOrOnMouseDown({event:l}),Object.assign(Object.assign(Object.assign({},i),U),{initial:b.slice(),xy:b,start:l.timeStamp||0})})},u=l=>{t((s,i)=>{const a="touches"in l;if(a&&l.touches.length>1)return s;if(l.timeStamp-s.start>i.swipeDuration)return s.swiping?Object.assign(Object.assign({},s),{swiping:!1}):s;const{clientX:d,clientY:x}=a?l.touches[0]:l,[b,j]=ne([d,x],i.rotationAngle),p=b-s.xy[0],v=j-s.xy[1],y=Math.abs(p),S=Math.abs(v),R=(l.timeStamp||0)-s.start,I=Math.sqrt(y*y+S*S)/(R||1),A=[p/(R||1),v/(R||1)],N=vt(y,S,p,v),W=typeof i.delta=="number"?i.delta:i.delta[N.toLowerCase()]||M.delta;if(y<W&&S<W&&!s.swiping)return s;const L={absX:y,absY:S,deltaX:p,deltaY:v,dir:N,event:l,first:s.first,initial:s.initial,velocity:I,vxvy:A};L.first&&i.onSwipeStart&&i.onSwipeStart(L),i.onSwiping&&i.onSwiping(L);let _=!1;return(i.onSwiping||i.onSwiped||i[`onSwiped${N}`])&&(_=!0),_&&i.preventScrollOnSwipe&&i.trackTouch&&l.cancelable&&l.preventDefault(),Object.assign(Object.assign({},s),{first:!1,eventData:L,swiping:!0})})},m=l=>{t((s,i)=>{let a;if(s.swiping&&s.eventData){if(l.timeStamp-s.start<i.swipeDuration){a=Object.assign(Object.assign({},s.eventData),{event:l}),i.onSwiped&&i.onSwiped(a);const d=i[`onSwiped${a.dir}`];d&&d(a)}}else i.onTap&&i.onTap({event:l});return i.onTouchEndOrOnMouseUp&&i.onTouchEndOrOnMouseUp({event:l}),Object.assign(Object.assign(Object.assign({},s),U),{eventData:a})})},g=()=>{document.removeEventListener(ee,u),document.removeEventListener(te,h)},h=l=>{g(),m(l)},c=(l,s)=>{let i=()=>{};if(l&&l.addEventListener){const a=Object.assign(Object.assign({},M.touchEventOptions),s.touchEventOptions),d=[[yt,o,a],[wt,u,Object.assign(Object.assign({},a),s.preventScrollOnSwipe?{passive:!1}:{})],[bt,m,a]];d.forEach(([x,b,j])=>l.addEventListener(x,b,j)),i=()=>d.forEach(([x,b])=>l.removeEventListener(x,b))}return i},f={ref:l=>{l!==null&&t((s,i)=>{if(s.el===l)return s;const a={};return s.el&&s.el!==l&&s.cleanUpTouch&&(s.cleanUpTouch(),a.cleanUpTouch=void 0),i.trackTouch&&l&&(a.cleanUpTouch=c(l,i)),Object.assign(Object.assign(Object.assign({},s),{el:l}),a)})}};return r.trackMouse&&(f.onMouseDown=o),[f,c]}function kt(t,r,o,u){return!r.trackTouch||!t.el?(t.cleanUpTouch&&t.cleanUpTouch(),Object.assign(Object.assign({},t),{cleanUpTouch:void 0})):t.cleanUpTouch?r.preventScrollOnSwipe!==o.preventScrollOnSwipe||r.touchEventOptions.passive!==o.touchEventOptions.passive?(t.cleanUpTouch(),Object.assign(Object.assign({},t),{cleanUpTouch:u(t.el,r)})):t:Object.assign(Object.assign({},t),{cleanUpTouch:u(t.el,r)})}function Ct(t){const{trackMouse:r}=t,o=w.useRef(Object.assign({},U)),u=w.useRef(Object.assign({},M)),m=w.useRef(Object.assign({},u.current));m.current=Object.assign({},u.current),u.current=Object.assign(Object.assign({},M),t);let g;for(g in M)u.current[g]===void 0&&(u.current[g]=M[g]);const[h,c]=w.useMemo(()=>St(n=>o.current=n(o.current,u.current),{trackMouse:r}),[r]);return o.current=kt(o.current,u.current,m.current,c),h}function Ot(t){const{addParam:r}=P();return e.jsxs(k,{gap:8,vertical:!0,children:[e.jsx(C,{block:!0,onClick:()=>r("testify","single"),children:"Testify Drawer"}),e.jsx(C,{block:!0,onClick:()=>r("testify","group"),children:"Testify Group"}),e.jsx(Tt,{...t}),e.jsx(Rt,{...t})]})}function Tt({suspects:t,questions:r,answers:o,addEntryToUpdate:u}){var j;const{width:m,height:g}=de(),{is:h,removeParam:c}=P(),[n,f,l]=me(),s=Ct({onSwipedLeft:()=>alert("Swiped Left"),onSwipedRight:()=>alert("Swiped Right"),onSwipedUp:()=>alert("Swiped Up"),preventScrollOnSwipe:!0,trackTouch:!0,trackMouse:!0}),i=()=>{f({suspectId:T.sample(Object.keys(t))||null,testimonyId:T.sample(Object.keys(r))||null})},a=()=>{i()},d=()=>{if(n!=null&&n.suspectId&&(n!=null&&n.testimonyId)){const p=T.cloneDeep(o[(n==null?void 0:n.testimonyId)??""]??{});p[n.suspectId]=[...p[n.suspectId]||[],1],u(n.testimonyId??"",p),i()}},x=()=>{if(n!=null&&n.suspectId&&(n!=null&&n.testimonyId)){const p=T.cloneDeep(o[(n==null?void 0:n.testimonyId)??""]??{});p[n.suspectId]=[...p[n.suspectId]||[],0],u(n.testimonyId??"",p),i()}},b=!!(n!=null&&n.suspectId)&&!!(n!=null&&n.testimonyId);return e.jsx(he,{footer:null,maskClosable:!1,onCancel:()=>c("testify"),open:h("testify","single"),title:e.jsx(O,{children:"Does this person do this??"}),width:m-64,children:e.jsxs("div",{...s,children:[b&&e.jsxs(k,{align:"center",className:"mb-8",gap:8,justify:"center",vertical:!0,children:[e.jsx(H,{id:n.suspectId??"",width:Math.max(g/4,128)}),e.jsx(O.Title,{className:"text-center",level:5,children:(j=r[n.testimonyId??""])==null?void 0:j.question})]}),e.jsxs(E.Compact,{block:!0,className:"mb-8",size:"large",children:[e.jsx(C,{block:!0,disabled:!b,icon:"ðŸ‘Ž",onClick:x,style:{height:64},children:"No"}),e.jsx(C,{block:!0,onClick:a,style:{height:64},children:"Skip"}),e.jsx(C,{block:!0,disabled:!b,icon:"ðŸ‘",iconPosition:"end",onClick:d,style:{height:64},children:"Yes"})]})]})})}function Rt({suspects:t,questions:r,answers:o,addEntryToUpdate:u}){var v;const{width:m,height:g}=de(),{is:h,removeParam:c}=P(),[n,f,l]=me(),[s,i]=w.useState(6),[a,d]=w.useState(!0),x=()=>{var S;const y=(S=T.sampleSize(Object.keys(t),s))==null?void 0:S.reduce((R,I)=>(R[I]=null,R),{});f({suspectsIds:y,testimonyId:(a?T.sample(Object.keys(r)):n==null?void 0:n.testimonyId)??null})};ge(()=>x());const b=()=>{const y=Object.entries((n==null?void 0:n.suspectsIds)??{}).reduce((S,[R,I])=>(I!==null&&(S[R]=[I]),S),{});if(n!=null&&n.testimonyId&&Object.keys(y).length>0){const S=T.cloneDeep(o[n.testimonyId]??{});Object.entries(y).forEach(([R,I])=>{S[R]=[...S[R]||[],...I]}),u(n.testimonyId,S)}else console.log("No testimonyId or no judged suspects found, likely skipped");x()},j=!!(n!=null&&n.suspectsIds)&&!!(n!=null&&n.testimonyId),p=y=>{f(S=>{if(!S)return S;const R=Object.entries(S.suspectsIds).reduce((I,[A,N])=>(I[A]=N===null?y:N,I),{});return{...S,suspectsIds:R}})};return e.jsx(he,{footer:null,maskClosable:!1,onCancel:()=>c("testify"),open:h("testify","group"),title:e.jsx(O,{children:"Do these people do this??"}),width:m-64,children:e.jsxs("div",{children:[j&&e.jsxs(k,{align:"center",className:"mb-8",gap:8,justify:"center",vertical:!0,children:[e.jsxs(k,{align:"center",gap:6,justify:"center",children:[e.jsx(O.Text,{children:"Number of Suspects:"}),e.jsx(oe,{onChange:y=>i(y??6),size:"small",value:s}),e.jsx(O.Text,{children:"Random Questions:"}),e.jsx(F,{checked:a,onChange:d,size:"small"})]}),e.jsx(O.Title,{className:"text-center",level:4,children:(v=r[n.testimonyId??""])==null?void 0:v.question}),e.jsx(k,{gap:8,justify:"center",wrap:"wrap",children:Object.keys(n.suspectsIds).map(y=>{var S,R;return e.jsxs(k,{align:"center",justify:"center",vertical:!0,children:[e.jsx(O.Text,{className:"text-center",children:((R=(S=t[y])==null?void 0:S.name)==null?void 0:R.pt)||"Unknown"}),e.jsx(H,{id:y,width:Math.min(Math.max(g/3,128),128)},y),e.jsx(Te,{onChange:I=>f(A=>A&&{...A,suspectsIds:{...A.suspectsIds,[y]:I}}),options:[{value:0,icon:"ðŸ‘Ž"},{value:null,icon:"â™¾"},{value:1,icon:"ðŸ‘"}],shape:"round",size:"large",value:n.suspectsIds[y]})]},y)})})]}),e.jsxs(k,{align:"center",className:"mt-8",justify:"space-between",children:[e.jsx("span",{}),e.jsxs(k,{gap:8,children:[e.jsx(C,{onClick:()=>p(0),children:"Set all â™¾ to ðŸ‘Ž"}),e.jsx(C,{onClick:()=>p(1),children:"Set all â™¾ to ðŸ‘"})]}),e.jsx(C,{onClick:b,size:"large",children:"Next Set"})]})]})})}function It({suspects:t,questions:r,data:o,hasNewData:u,isDirty:m,save:g,isSaving:h,entriesToUpdate:c,addEntryToUpdate:n}){const{queryParams:f,addParams:l}=P(),s=w.useMemo(()=>{let a=0;const d={};return Object.values(o).forEach(x=>{Object.keys(x).forEach(b=>{if(x[b]){d[b]||(d[b]=0);const j=ve(x[b]);j>=5&&(d[b]+=1),j>=3&&(a+=1)}})}),{absoluteTotal:a,queriedTestimoniesCount:Object.keys(o).length,suspectsCount:Object.keys(d).length,reliableSuspectsCount:Object.values(d).filter(x=>x>=5).length}},[o]),i=s.queriedTestimoniesCount*s.suspectsCount;return e.jsxs(e.Fragment,{children:[e.jsx(V,{children:e.jsxs(k,{gap:12,vertical:!0,children:[e.jsx(Me,{dirt:JSON.stringify(c),isDirty:m,isSaving:h,onSave:g}),e.jsx(ce,{block:!0,data:async()=>await Dt(o),disabled:m,fileName:"testimony-answers.json",hasNewData:u}),e.jsx(Ae,{label:"FS Data",path:"data/testimonies"}),e.jsx(Ne,{docId:"testimonies",label:"FS TDR",path:"tdr",queryKey:["tdr","testimonies"]})]})}),e.jsxs(V,{children:[e.jsx(Re,{label:"Display",onChange:a=>l({display:a,page:1},{page:1}),options:[{title:"Questions",icon:e.jsx(He,{}),value:"questions"},{title:"Suspects",icon:e.jsx(Ke,{}),value:"suspects"},{title:"Simulator",icon:e.jsx(Le,{}),value:"simulator"}],value:f.get("display")??"questions"}),e.jsx(Fe,{})]}),e.jsx(V,{children:e.jsxs("div",{style:{fontSize:"0.85em"},children:[e.jsx("strong",{children:"Legend"}),e.jsxs("ul",{children:[e.jsx("li",{children:"Reliability: At least 5 votes"}),e.jsx("li",{children:"Large Bars: There's enough data (at least 3)"}),e.jsx("li",{children:"Small blue bar: in progress negative"})]})]})}),e.jsxs(V,{children:[e.jsxs("div",{style:{fontSize:"0.85em"},children:[e.jsx("strong",{children:"Counts"}),e.jsxs("ul",{children:[e.jsxs("li",{children:["Testimonies: ",s.queriedTestimoniesCount]}),e.jsxs("li",{children:["Suspects: ",s.suspectsCount]}),e.jsx("li",{children:e.jsxs(z,{title:"A reliable suspect is one that has at least 5 complete testimonies.",children:["Reliable suspects: ",s.reliableSuspectsCount]})}),e.jsxs("li",{children:["Complete: ",s.absoluteTotal]}),e.jsxs("li",{children:["Total: ",i]}),e.jsxs("li",{children:["Percentage: ",(s.absoluteTotal/i*100).toFixed(1),"%"]})]})]}),e.jsx(Ot,{addEntryToUpdate:n,answers:o,questions:r,suspects:t})]})]})}async function Dt(t){console.log("Preparing file for download...x");const r=await Ee("data","testimonies")(),o=ze(r);console.log("Parsed data from Firestore:",o);const u=T.cloneDeep(t);return Object.keys(u).forEach(m=>{const g=u[m],h=o[m]||{};Object.keys(g).forEach(c=>{const n=h[c]||[],f=Se([...g[c],...n]);g[c]=f})}),Be($e(u))}function Tn(){const t=ke();return e.jsx(je,{subtitle:"Suspect Testimony Rates",title:"Testimonies",children:e.jsxs(G,{hasSider:!0,children:[e.jsx(be,{children:e.jsx(It,{...t})}),e.jsx(G.Content,{className:"content",children:e.jsx(xe,{error:t.error,hasResponseData:!T.isEmpty(t.data),isLoading:t.isLoading,children:e.jsx(ft,{...t})})})]})})}export{Tn as TestimoniesPage,Tn as default};
