import{j as e,T as v,r as b,D as R,P as E,L as S}from"./index-BZlgVGyQ.js";import{D as B}from"./DataLoadingWrapper-BdBJ8MHz.js";import{u as L,P as k}from"./useGridPagination-ihu1vBNT.js";import{I as Q}from"./Item-i8IR1ffc.js";import{u as D}from"./useCopyToClipboardFunction-B_oksN_x.js";import{u as w}from"./useQueryParams-SxpUkNbA.js";import{u as C}from"./useTDResource-DknGbtCY.js";import{l as y}from"./lodash-C-CNgKU_.js";import{r as I,h as $,a as W}from"./index-DSRbwsOq.js";import{T as M}from"./TransparentButton-iiuSTFm_.js";import{D as T}from"./EditableFields-Ch-VogGg.js";import{u as A}from"./useTablePagination-BljribDO.js";import{C as z}from"./CopyIdsButton-xT3VdNnL.js";import{I as J}from"./ItemsTypeahead-DT7ybRLb.js";import{I as q,b as F,d as K}from"./ItemBuildingBlocks-D16D6jJx.js";import{C as U}from"./index-CAEa4a2p.js";import{S as V}from"./index-BgmHRj3u.js";import{S as X}from"./index-DAAN8KO-.js";import{F as G}from"./Table-Dky-jnHG.js";import{F as g}from"./index-D7ssyPOH.js";import{D as _}from"./index-DNIXPw_l.js";import{R as H,C as Y}from"./index-CRRJORQS.js";import{F as Z,c as ee}from"./FilterEntries-DOUp0Wt4.js";import{S as se}from"./SiderContent-CJEv_zZp.js";import{D as te}from"./DownloadButton-BN5Z1CNS.js";import{S as re}from"./SaveButton-Btowi3Fc.js";import{R as oe}from"./ClusterOutlined-CqTS-EC0.js";import{R as ie}from"./TableOutlined-NI9TtkQZ.js";import{P as ae}from"./useBaseUrl-DfdTaQhG.js";import{u as ne}from"./useResourceFirebaseData-D7Qbkxuw.js";import"./Pagination-CCO_kDKt.js";import"./constants--noGxxjp.js";import"./LanguageFlag-EHBDUfga.js";import"./index-Bqgz6ppr.js";import"./Input-BKtyPqwb.js";import"./index-D2ShRf9Y.js";import"./FireFilled-oR0rDV-w.js";import"./IdcardOutlined-xp4GWKkG.js";import"./useDebounce-CqWLOG1u.js";import"./index-CbZFFArY.js";import"./PlusOutlined-Crih-cvM.js";import"./gapSize-U1swVQyS.js";import"./index-C7OCW9Iw.js";import"./index-7EuvvQI3.js";import"./index-C1yscgmY.js";import"./scrollTo-CznnqliU.js";import"./extendsObject-keMuGWqj.js";import"./moment-C5S46NFB.js";import"./SaveOutlined-yncQWwYq.js";import"./useGetFirebaseDoc-B_niq1mS.js";import"./useUpdateFirebaseDoc-DTMj9F0I.js";import"./useMutation-SpvvL0jG.js";function N({item:s,itemGroups:t,groupsTypeahead:o,onUpdateItemGroups:m}){const l=D();return e.jsxs(U,{title:e.jsxs(e.Fragment,{children:[e.jsx(v.Text,{onClick:()=>l(s.id),children:s.id}),e.jsx(K,{item:s})]}),style:{maxWidth:250},children:[e.jsx(q,{item:s,width:75}),e.jsxs(V,{size:"small",direction:"vertical",className:"my-4",children:[e.jsx(F,{item:s,language:"en"}),e.jsx(F,{item:s,language:"pt"}),e.jsx(X,{mode:"tags",style:{width:"100%"},placeholder:"Select a group",defaultValue:t,options:o,showSearch:!0,size:"small",onChange:p=>m(s.id,p)},String(t))]})]})}function me({data:s,addEntryToUpdate:t}){const{is:o,queryParams:m}=w(),l=C("items"),p=b.useMemo(()=>Object.values(s??[]).reduce((r,a)=>(a.itemsIds||console.warn("Group without items",a),a.itemsIds.forEach(u=>{r[u]||(r[u]=[]),r[u].push(a.id)}),r),{}),[s]),x=b.useMemo(()=>y.orderBy(Object.keys(s).map(r=>({label:r,value:r})),"label"),[s]),f=(r,a)=>{const u=p[r]??[],h=a.filter(n=>!u.includes(n)),c=u.filter(n=>!a.includes(n));h.forEach(n=>{const i=s[n];t(n,{...i,itemsIds:I([...(i==null?void 0:i.itemsIds)??[],r])})}),c.forEach(n=>{const i=s[n];t(n,{...i,itemsIds:I(i==null?void 0:i.itemsIds.filter(P=>P!==r))})})},j=(r,a)=>{const u=s[r];t(r,{...u,itemsIds:I(a)})},d=(r,a,u)=>{const h=s[u];t(u,{...h,name:{...h.name,[a]:r}})};return e.jsxs(e.Fragment,{children:[(o("display","group")||!m.has("display"))&&e.jsx(le,{data:s,items:l.data,grousByItem:p,groupsTypeahead:x,onUpdateItemGroups:f,onUpdateGroupItems:j,onUpdateName:d}),o("display","item")&&e.jsx(de,{data:s,items:l.data,grousByItem:p,groupsTypeahead:x,onUpdateItemGroups:f,onUpdateGroupItems:j,onUpdateName:d})]})}function le({data:s,items:t,grousByItem:o,groupsTypeahead:m,onUpdateItemGroups:l,onUpdateGroupItems:p,onUpdateName:x}){const f=D(),j=C("items"),[d,r]=b.useState(null),a=A({showQuickJumper:!0,total:Object.keys(s).length}),u=[{title:"id",dataIndex:"id",key:"id",render:c=>e.jsx("span",{children:c})},{title:"Name",dataIndex:"name",key:"name",render:(c,n)=>e.jsxs(g,{vertical:!0,gap:4,children:[e.jsx(T,{value:c,language:"en",style:{minWidth:150},onChange:i=>x(i.target.value,"en",n.id)}),e.jsx(T,{value:c,language:"pt",style:{minWidth:150},onChange:i=>x(i.target.value,"pt",n.id)})]})},{title:"Items",dataIndex:"itemsIds",key:"itemsIds",render:(c,n)=>e.jsx(g,{gap:6,wrap:"wrap",children:c.map(i=>e.jsxs(g,{gap:2,vertical:!0,children:[e.jsx(M,{onClick:()=>r(i),children:e.jsx(Q,{id:i,width:60})}),e.jsx(g,{justify:"center",children:e.jsx(v.Text,{onClick:()=>f(i),children:i})})]},`${n.id}-${i}`))},`items-${n.id}`)},G.EXPAND_COLUMN,{title:"Count",dataIndex:"itemsIds",key:"count",render:c=>I(c).filter(Boolean).length},{title:"Actions",dataIndex:"itemsIds",key:"actions",render:c=>e.jsx(z,{ids:c})}],h=d?t[d]:null;return e.jsxs(e.Fragment,{children:[e.jsx(G,{columns:u,dataSource:Object.values(s),className:"my-4",rowKey:"id",pagination:a,expandable:{expandedRowRender:c=>e.jsx(pe,{group:c,onUpdateGroupItems:p}),rowExpandable:()=>j.isSuccess}}),e.jsx(_,{title:"Edit Item Group",onClose:()=>r(null),open:!!h,children:h&&e.jsx(N,{item:h,itemGroups:o[h.id],groupsTypeahead:m,onUpdateItemGroups:l})})]})}function pe({group:s,onUpdateGroupItems:t}){const o=m=>{t(s.id,[...s.itemsIds,m])};return e.jsx("div",{children:e.jsx(J,{onFinish:o})})}function de({items:s,grousByItem:t,groupsTypeahead:o,onUpdateItemGroups:m}){const{is:l}=w(),p=l("emptyOnly"),x=b.useMemo(()=>p?Object.values(s).filter(d=>!t[d.id]):Object.values(s),[s,t,p]),{page:f,pagination:j}=L({data:x});return e.jsxs(e.Fragment,{children:[e.jsxs(v.Title,{level:2,children:["Groups by Items (",x.length,")"]}),e.jsx(k,{pagination:j,children:e.jsx(H,{gutter:[16,16],className:"my-4",children:f.map(d=>e.jsx(Y,{xs:24,sm:24,md:12,lg:6,xl:4,children:e.jsx(N,{item:d,itemGroups:t[d.id],groupsTypeahead:o,onUpdateItemGroups:m})},d.id))})})]})}function ce({data:s,save:t,isDirty:o,isSaving:m,entriesToUpdate:l,hasFirestoreData:p}){const{queryParams:x,addParam:f,addParams:j,is:d}=w(),r=C("items");return e.jsxs(se,{children:[e.jsxs(g,{vertical:!0,gap:12,children:[e.jsx(re,{isDirty:o,onSave:t,isSaving:m,dirt:JSON.stringify(O(l))}),e.jsx(te,{data:()=>ue(s,r.data),fileName:"items-groups.json",disabled:o||y.isEmpty(r.data),hasNewData:p,block:!0})]}),e.jsx(R,{}),e.jsx(Z,{label:"Display",value:x.get("display")??"group",onChange:a=>j({display:a,page:1},{page:1}),options:[{title:"By Groups",icon:e.jsx(oe,{}),value:"group"},{title:"By Items",icon:e.jsx(ie,{}),value:"item"}]}),d("display","item")&&e.jsx(ee,{label:"No Groups Only",value:d("emptyOnly"),onChange:a=>f("emptyOnly",a,!1)})]})}function O(s){return y.omitBy(y.cloneDeep(s),t=>y.isEmpty(t.itemsIds))}function ue(s,t){return Object.keys(s).forEach(o=>{s[o].itemsIds=$(I(s[o].itemsIds));const m=s[o].itemsIds.length,l=s[o].itemsIds.filter(p=>t[p].nsfw).length;l>m*.3&&(s[o].nsfw=!0,console.log(`ðŸ˜ˆ Group ${s[o].name.pt} has ${l} (${Math.round(l/m*100)}%) NSFW items`))}),W(O(s))}function cs(){const s=ne({tdrResourceName:"items-groups",firebaseDataCollectionName:"itemsGroups",serialize:!0}),t=C("items");return e.jsx(E,{title:"Items",subtitle:"Groups Sets",children:e.jsxs(S,{hasSider:!0,children:[e.jsx(ae,{children:e.jsx(ce,{...s})}),e.jsx(S.Content,{className:"content",children:e.jsx(B,{isLoading:s.isLoading||t.isLoading,error:s.error||t.error,hasResponseData:!y.isEmpty(s.data)&&!y.isEmpty(t.data),children:e.jsx(me,{...s})})})]})})}export{cs as ItemsGroups,cs as default};
