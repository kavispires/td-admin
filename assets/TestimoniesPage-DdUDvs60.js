import{r as y,a as W,_ as Y,j as t,T as P,B as M,aj as fe,ae as ge,y as F,D as ae,P as pe,L as ee}from"./index-CgiFaygz.js";import{D as xe}from"./DataLoadingWrapper-BMYarIJM.js";import{l as v,c as le,P as je}from"./useBaseUrl-DKYo4V9s.js";import{u as I}from"./useQueryParams-BylyOuz5.js";import{R as be,c as we,u as ye}from"./useTestimoniesResource-8PSBqMpo.js";import{u as ve,D as Se,a as Oe,g as ke}from"./constants-Bv59XymU.js";import{u as H}from"./useTDResource-BeQ0n1Xj.js";import{I as U}from"./ImageCard-Dz8RI4Bz.js";import{g as _}from"./utils-rZXRcKe_.js";import{F as O}from"./index-D73l_cZQ.js";import{T as Ee,F as Ce}from"./FilterEntries-YDB2K5TT.js";import{B as te,D as Te}from"./DownloadButton-DAAnN5EO.js";import{S as B}from"./index-Cz_qJ3rt.js";import{u as ue}from"./useTableExpandableRows-b9bX-3S5.js";import{u as de}from"./useTablePagination-Cp1y3Izk.js";import{P as se}from"./progress-BWdE-6o3.js";import{S as z}from"./index-JpLsr9PS.js";import{F as X}from"./Table-zMM1m27m.js";import{u as Me}from"./useCardWidth-DtIffdGc.js";import{C as he}from"./index-EmfHENal.js";import{P as ne}from"./index-BY2-XRRZ.js";import{R as Re}from"./FireFilled-BHtYEUIK.js";import{S as L}from"./SiderContent-Cu139Ix2.js";import{S as Pe}from"./SaveButton-CynKZjk1.js";import{g as De}from"./useGetFirestoreDoc-DNoB_OGO.js";import{e as Ie,a as Ne,d as Ae}from"./index-CBYzJrV0.js";import{u as Fe}from"./useWindowSize-C1qVjEiC.js";import{M as Be}from"./index-D-taM28A.js";import{R as ze}from"./TableOutlined-WNfdpMe0.js";import"./useResourceFirestoreData-DnDjD-44.js";import"./useUpdateFirestoreDoc-DpnaHZT7.js";import"./useMutation-c_G0mUet.js";import"./moment-C5S46NFB.js";import"./gapSize-U1swVQyS.js";import"./index-BQfEtuTy.js";import"./index-COkgi1Fw.js";import"./index-D6Q3Wjh_.js";import"./index-BBeD4OHK.js";import"./scrollTo-CDjJ7MCZ.js";import"./Pagination---xECCNu.js";import"./extendsObject-keMuGWqj.js";import"./Input-Bg-dT-cB.js";import"./SaveOutlined-zxa8KgyN.js";import"./constants-CpI1HLcw.js";import"./Item-D7IM6caB.js";var $e={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M594.3 601.5a111.8 111.8 0 0029.1-75.5c0-61.9-49.9-112-111.4-112s-111.4 50.1-111.4 112c0 29.1 11 55.5 29.1 75.5a158.09 158.09 0 00-74.6 126.1 8 8 0 008 8.4H407c4.2 0 7.6-3.3 7.9-7.5 3.8-50.6 46-90.5 97.2-90.5s93.4 40 97.2 90.5c.3 4.2 3.7 7.5 7.9 7.5H661a8 8 0 008-8.4c-2.8-53.3-32-99.7-74.7-126.1zM512 578c-28.5 0-51.7-23.3-51.7-52s23.2-52 51.7-52 51.7 23.3 51.7 52-23.2 52-51.7 52zm416-354H768v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H548v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H328v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H96c-17.7 0-32 14.3-32 32v576c0 17.7 14.3 32 32 32h832c17.7 0 32-14.3 32-32V256c0-17.7-14.3-32-32-32zm-40 568H136V296h120v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h148v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h148v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h120v496z"}}]},name:"contacts",theme:"outlined"},He={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M300 328a60 60 0 10120 0 60 60 0 10-120 0zM852 64H172c-17.7 0-32 14.3-32 32v660c0 17.7 14.3 32 32 32h680c17.7 0 32-14.3 32-32V96c0-17.7-14.3-32-32-32zm-32 660H204V128h616v596zM604 328a60 60 0 10120 0 60 60 0 10-120 0zm250.2 556H169.8c-16.5 0-29.8 14.3-29.8 32v36c0 4.4 3.3 8 7.4 8h729.1c4.1 0 7.4-3.6 7.4-8v-36c.1-17.7-13.2-32-29.7-32zM664 508H360c-4.4 0-8 3.6-8 8v60c0 4.4 3.6 8 8 8h304c4.4 0 8-3.6 8-8v-60c0-4.4-3.6-8-8-8z"}}]},name:"robot",theme:"outlined"},Le={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M868 160h-92v-40c0-4.4-3.6-8-8-8H256c-4.4 0-8 3.6-8 8v40h-92a44 44 0 00-44 44v148c0 81.7 60 149.6 138.2 162C265.6 630.2 359 721.8 476 734.5v105.2H280c-17.7 0-32 14.3-32 32V904c0 4.4 3.6 8 8 8h512c4.4 0 8-3.6 8-8v-32.3c0-17.7-14.3-32-32-32H548V734.5C665 721.8 758.4 630.2 773.8 514 852 501.6 912 433.7 912 352V204a44 44 0 00-44-44zM248 439.6c-37.1-11.9-64-46.7-64-87.6V232h64v207.6zM840 352c0 41-26.9 75.8-64 87.6V232h64v120z"}}]},name:"trophy",theme:"filled"};function qe(){var s=y.useRef(!0);return s.current?(s.current=!1,!0):s.current}function Ue(s,e){return typeof s=="function"?s.length?s(e):s():s}function Ve(s,e,o){if(e===void 0&&(e=10),e<1)throw new Error("Capacity has to be greater than 1, got '"+e+"'");var l=qe(),u=y.useState(s),m=u[0],h=u[1],r=y.useRef([]),d=y.useRef(0);l&&(r.current.length?(r.current[r.current.length-1]!==s&&r.current.push(s),r.current.length>e&&(r.current=r.current.slice(r.current.length-e))):r.current.push(s),d.current=r.current.length&&r.current.length-1);var g=y.useCallback(function(c){h(function(i){return c=Ue(c,i),c!==i&&(d.current<r.current.length-1&&(r.current=r.current.slice(0,d.current+1)),d.current=r.current.push(c)-1,r.current.length>e&&(r.current=r.current.slice(r.current.length-e))),c})},[m,e]),a=y.useMemo(function(){return{history:r.current,position:d.current,capacity:e,back:function(c){c===void 0&&(c=1),d.current&&h(function(){return d.current-=Math.min(c,d.current),r.current[d.current]})},forward:function(c){c===void 0&&(c=1),d.current!==r.current.length-1&&h(function(){return d.current=Math.min(d.current+c,r.current.length-1),r.current[d.current]})},go:function(c){c!==d.current&&h(function(){return d.current=c<0?Math.max(r.current.length+c,0):Math.min(r.current.length-1,c),r.current[d.current]})}}},[m]);return[m,g,a]}var Ge=function(e,o){return y.createElement(W,Y({},e,{ref:o,icon:$e}))},Qe=y.forwardRef(Ge),We=function(e,o){return y.createElement(W,Y({},e,{ref:o,icon:He}))},Ye=y.forwardRef(We),_e=function(e,o){return y.createElement(W,Y({},e,{ref:o,icon:Le}))},re=y.forwardRef(_e);const J=(s,e,o)=>{const{reliabilityThreshold:l=4,projectionThreshold:u=55}={},h=`us-gb-${s.split("-")[1]}`,r=v.isEmpty(e[s])?[]:e[s];let d=0,g=0;r.forEach(C=>{C===3&&(d+=3),C===-3&&(g+=3),C===4&&(d+=4),C===-4&&(g+=4)});const a=r.filter(C=>![-4,-3,3,4].includes(C)),c=a.length+d+g,i=Math.max(c,5),f=r.filter(C=>C===1).length+d,b=Math.round(f/i*100),p=r.filter(C=>C===0).length+g,x=Math.round(p/i*100),w=Math.round((i-f-p)/i*100),S=a.length+d+g>=5,k=c>3,E=c>l,R=E?b>x?"üëç":"üëé":null,D=k?b>=u?"üëç":x>=u?"üëé":null:null;return{suspectCardId:s,imageId:h,enoughData:k,reliable:E,total:i,yesCount:f,yesPercentage:b,noCount:p,noPercentage:x,blankPercentage:w,complete:S,values:r,resolution:R,projection:D}};function Xe(s){const e=s.filter(u=>![0,1].includes(u)),o=s.filter(u=>[0,1].includes(u)),l={0:0,1:0};return o.forEach(u=>{if(l[u]===void 0)throw Error(`what is this value? ${u}`);l[u]+=1}),Object.entries(l).forEach(([u,m])=>{if(m>0){const h=Math.floor(m/4),r=m%4;for(let d=0;d<h;d++)e.push(u==="0"?-4:4);if(r>0){const d=Array.from({length:r},()=>u==="0"?0:1);e.push(...d)}}}),e.sort((u,m)=>u-m)}const G=9,Je=(s,e,o,l)=>{const[u]=ve(Se.ESPIONAGEM,l),m=H("suspects",s),h=H(`testimony-questions-${e}`,s),r=H("testimony-answers",s),d=H("crime-reasons",s),g=y.useMemo(()=>et(r.data),[r.data]),a=y.useMemo(()=>tt(m.data),[m.data]);return{entries:y.useMemo(()=>!u||!m.isSuccess||!h.isSuccess||!r.isSuccess||!d.isSuccess?{}:Ke(o,u,m.data,h.data,g,a,d.data),[s,u,m,h,r,o,g,a,d]),isLoading:m.isLoading||h.isLoading||r.isLoading}},Ke=(s,e,o,l,u,m,h)=>{console.count("Creating Espionagem...");let r=e.latestDate;const d=[],g={};for(let a=0;a<s;a++){const c=Oe(r);r=c;let i=null,n=0;for(;!i&&n<100;){n++;const f=Ze(o,l,u,m,d,h);if(ot(f.statements)){i=f,console.log(`Generated valid game for ${c} after ${n} attempts`);break}}if(!i)throw new Error(`Failed to generate valid game for ${c} after 100 attempts`);d.push(i.culpritId),g[c]={id:c,type:"espionagem",number:e.latestNumber+a+1,...i}}return g};function Ze(s,e,o,l,u,m){let h=[];const r=[],d={},g=v.sample(Object.keys(o));if(!g)throw new Error("No selected testimony ID found");const a=Object.keys(o[g]).filter(E=>!u.includes(E)),c=a.length>0?a:Object.keys(o[g]),i=v.sample(c);if(!i)throw new Error("No selected culprit ID found");const n=v.sampleSize(Object.keys(o[g]).filter(E=>E!==i),G-1);for(h.push(...n);h.length<8;){const E=v.sampleSize(Object.keys(s).filter(R=>!h.includes(R)&&R!==i),G-h.length-1);h.push(...E)}const f={};Object.keys(l).forEach(E=>{if(l[E][i]===void 0){const R=Object.keys(l[E]).filter(D=>h.includes(D));if(R.length>0){const D={};R.forEach(C=>{h.includes(C)&&(D[C]=!0)}),f[E]=D}}});const b=e[g];r.push(st(i,h,b,o[g])),A(d,r[0].excludes);const j=V(i,h,f);r.push(j),A(d,j.excludes),h=v.shuffle([...h,i]);const p=V(i,h,f,[j],"worst");r.push(p),A(d,p.excludes);const x=V(i,h,f,[j,p],"worst");r.push(x),A(d,x.excludes);const w=nt(i,h,r);r.push(w),A(d,w.excludes);const S=[r[0],r[1],r[2],r[4],r[3]],k=it(s[i],m);return{isNsfw:b.nsfw??!1,culpritId:i,statements:S,suspects:h.map(E=>s[E]),reason:k.title,setId:`${i}::${k.id}::${S[0].key}`,level:ct(S)}}const et=s=>{const e={};console.log("‚öôÔ∏è Calculating suspect answers...");for(const o of Object.keys(s)){const l=s[o];for(const u of Object.keys(l)){const{resolution:m,projection:h}=J(u,l);if(!m&&!h){console.log("‚ÅâÔ∏è Ignoring testimony with no resolution or projection");continue}if(e[o]===void 0&&(e[o]={}),m){e[o][u]=m==="üëç";continue}if(h){e[o][u]=h==="üëç";continue}console.log("‚ÅâÔ∏è Ignoring testimony with not enough values")}}return Object.keys(e).forEach(o=>{v.isEmpty(e[o])&&delete e[o]}),Object.keys(e).forEach(o=>{Object.keys(e[o]).length<3&&(console.log("‚ÅâÔ∏è Removing testimonies with less than 3 answers"),delete e[o])}),Object.keys(e).forEach(o=>{v.uniq(Object.values(e[o])).length===1&&(console.log("‚ÅâÔ∏è Removing testimonies with the same answer"),delete e[o])}),e},tt=s=>{const e={};for(const l of Object.keys(s)){const{gender:u,ethnicity:m,age:h,build:r,height:d,features:g}=s[l];if(!r){console.log("‚ÅâÔ∏è Ignoring suspect with missing build",l);continue}if(!d){console.log("‚ÅâÔ∏è Ignoring suspect with missing height",l);continue}if(!g||g.length===0){console.log("‚ÅâÔ∏è Ignoring suspect with missing features",l);continue}e[u]===void 0&&(e[u]={}),e[u][l]=!0,e[m]===void 0&&(e[m]={}),e[m][l]=!0,e[h]===void 0&&(e[h]={}),e[h][l]=!0,e[r]===void 0&&(e[r]={}),e[r][l]=!0,e[d]===void 0&&(e[d]={}),e[d][l]=!0,g.forEach(a=>{e[a]===void 0&&(e[a]={}),e[a][l]=!0})}return e.young=v.cloneDeep(e["18-21"]),e.adult=v.cloneDeep({...e["21-30"],...e["30-40"],...e["40-50"]}),e.senior=v.cloneDeep({...e["50-60"],...e["60-70"],...e["70-80"],...e["80-90"]}),["18-21","21-30","30-40","40-50","50-60","60-70","70-80","80-90","average","medium","mixed","adult","tall"].forEach(l=>{delete e[l]}),e},A=(s,e)=>{e.forEach(o=>{s[o]===void 0&&(s[o]=0),s[o]++})},st=(s,e,o,l)=>{const u=l[s],m=e.filter(d=>l[d]!==void 0&&l[d]!==u),h=o.answer.charAt(0).toLowerCase()+o.answer.slice(1),r={key:`testimony.${o.id}`,text:`O(a) suspeito(a) ${u?"":"n√£o "}${h}`,excludes:m};return r.text.includes("n√£o j√°")&&(r.text=r.text.replace("n√£o j√°","nunca")),r},q={row1:{indexes:[0,1,2],text:"na primeira linha"},row2:{indexes:[3,4,5],text:"na segunda linha"},row3:{indexes:[6,7,8],text:"na terceira linha"},column1:{indexes:[0,3,6],text:"na primeira coluna"},column2:{indexes:[1,4,7],text:"na segunda coluna"},column3:{indexes:[2,5,8],text:"na terceira coluna"},corners:{indexes:[0,2,6,8],text:"nos cantos"}},nt=(s,e,o)=>{const l=e.indexOf(s),u=o.slice(0,3),m={};for(const c of Object.keys(q)){const{indexes:i}=q[c];i.includes(l)||(m[c]=i.reduce((n,f)=>{const b=e[f],j=u.filter(p=>p.excludes.includes(b)).length;return j>0?n+j:n},0))}const h=Object.entries(m).reduce((c,[i,n])=>(c[n]||(c[n]=[]),c[n].push(i),c),{}),r=Math.min(...Object.keys(m).map(c=>m[c])),d=h[r.toString()],g=v.sample(d)||Object.keys(m)[0],a=q[g].indexes.map(c=>e[c]);return{key:`not.grid.${g}`,text:`O(a) suspeito(a) n√£o est√° ${q[g].text}`,excludes:a}},V=(s,e,o,l=[],u="best")=>{const m=v.difference(e,[s]),h=l.filter(f=>f.key.startsWith("not.feature.")).map(f=>f.key.replace("not.feature.","")),r=new Set(l.flatMap(f=>f.excludes)),d=Object.keys(o).filter(f=>Object.keys(o[f]).length<=6&&!h.includes(f)).sort((f,b)=>Object.keys(o[b]).length-Object.keys(o[f]).length);let g,a=[],c=0;const i=500;for(;c<i;){c++;const f=u==="best"?d[0]:v.sample(d.slice(2,5))??d[2];if(!f)break;const b=m.filter(p=>o[f][p]);if(b.some(p=>!r.has(p))||c===i){g=f,a=b;break}d.splice(d.indexOf(f),1)}if(!g)throw Error(`No suitable feature found for ${u} selection after ${i} attempts`);console.log(`Selected feature after ${c} attempts: ${g}`);const n=rt[g];return n||console.warn(`Feature ${g} not found in translations`),{key:`not.feature.${g}`,text:`O(a) suspeito(a) n√£o ${n||g}`,excludes:a}},rt={male:"√© homem",female:"√© mulher",black:"√© negro(a)",white:"√© branco(a)",asian:"√© asi√°tico(a)",latino:"√© latino(a)",thin:"√© magrelo(a)",fat:"√© gordo(a)",large:"√© gordo(a)",tall:"√© alto(a)",short:"√© baixinho(a)",young:"√© jovem",adult:"√© adulto(a)",senior:"√© idoso(a)",average:"√© m√©dio(a)",medium:"√© m√©dio(a)",mixed:"√© mesti√ßo(a)",hat:"est√° usando um chap√©u",tie:"est√° usando uma gravata",glasses:"est√° usando √≥culos",brownHair:"tem cabelo castanho",shortHair:"tem cabelo curto",beard:"tem barba",caucasian:"√© caucasiano(a)",scarf:"est√° usando um cachecol",blondeHair:"tem cabelo loiro",longHair:"tem cabelo longo",greyHair:"tem cabelo grisalho",bald:"√© careca",mustache:"tem bigode",goatee:"tem cavanhaque",muscular:"√© musculoso(a)",blackHair:"tem cabelo preto",hoodie:"est√° usando um moletom",earrings:"est√° usando brincos",lipstick:"est√° usando batom",necklace:"est√° usando um colar",mediumHair:"tem cabelo m√©dio","middle-eastern":"√© do Oriente M√©dio",headscarf:"est√° usando um len√ßo na cabe√ßa",redHair:"tem cabelo ruivo",piercings:"tem piercings",coloredHair:"tem cabelo colorido",indian:"√© indiano(a)","native-american":"√© nativo-americano(a)",noAccessories:"n√£o est√° usando acess√≥rios"},ot=s=>{const e=s.slice(0,3);return e.reduce((u,m)=>u+m.excludes.length,0)<10?!1:new Set(e.flatMap(u=>u.excludes)).size===G-1},it=(s,e)=>{const o=[];Object.values(e).forEach(u=>{var m;u.feature==="general"&&o.push(u),(m=s.features)!=null&&m.includes(u.feature)&&o.push(u)});const l=v.sample(o);return l||{id:"unknown",title:{pt:"Motivo desconhecido",en:"Unknown reason"},feature:"general"}},ct=s=>{const e=s.slice(0,3),o=[],l={1:4,2:3,3:3,4:2,5:2,6:1,7:0,8:0};e.forEach(m=>{const h=m.excludes.length;l[h]!==void 0&&o.push(l[h])});const u=Math.round(o.reduce((m,h)=>m+h,0)/o.length);return Math.min(Math.max(u,1),3)};function at(){const[s,e]=y.useState({batchSize:1,history:{}}),o=y.useRef(1),{entries:l}=Je(!0,"pt",s.batchSize,s.history);return t.jsxs(O,{vertical:!0,gap:12,className:"p-4",children:[t.jsxs(O,{justify:"space-between",align:"center",children:[t.jsx(P.Title,{level:4,className:"my-0",children:"Espionagem Simulator"}),t.jsxs(O,{gap:6,children:[t.jsx(Ee,{min:1,max:7,defaultValue:1,onChange:u=>{o.current=u??1}}),t.jsx(M,{type:"primary",onClick:()=>e({batchSize:o.current,history:{}}),children:"Re-run Simulation"})]})]}),t.jsx(lt,{entries:l})]})}function lt({entries:s}){const[e,o]=y.useState(!1),l=ke(),u=s[l],m=y.useMemo(()=>u?u.statements.slice(0,3).reduce((h,r)=>{const{excludes:d}=r;return d.forEach(g=>{h[g]?h[g]++:h[g]=1}),h},{}):{},[u]);return t.jsxs("div",{className:"full-width grid grid-2",children:[t.jsx(be,{src:s??{},theme:"twilight",collapsed:3}),u&&t.jsxs(O,{gap:18,className:"p-4",children:[t.jsx("div",{children:t.jsx("div",{style:{width:`${105*3}px`,display:"grid",gap:"6px",gridTemplateColumns:"repeat(3, 1fr)"},children:u.suspects.map(h=>t.jsxs(te.Ribbon,{text:e?m[h.id]:null,color:"cyan",children:[t.jsx(U,{id:_(h.id,"gb"),width:96,className:le(e&&h.id===u.culpritId&&"red-border")},h.id),t.jsxs(O,{gap:6,align:"center",children:[t.jsx(B,{checkedChildren:"üö´",size:"small"})," ",h.id]})]},h.id))})}),t.jsxs("div",{children:[t.jsx("div",{children:t.jsx(B,{checkedChildren:"Show Culprit",unCheckedChildren:"Hide Culprit",checked:e,onChange:o})}),u.statements.map((h,r)=>t.jsx(P.Paragraph,{children:t.jsx(te,{count:h.excludes.length,color:"cyan",children:t.jsx(fe,{message:h.text,banner:!0,type:r<3?"info":"error"},h.key)})},h.key))]})]})]})}function me({suspect:s,values:e,resolution:o,projection:l,yesPercentage:u,noPercentage:m,complete:h,enoughData:r,testimonyId:d,addEntryToUpdate:g,answers:a,barWidth:c,showName:i}){const n=p=>{const x={...a};x[p]=[...x[p]||[],3],g(d,x)},f=p=>{const x={...a};x[p]=[...x[p]||[],-3],g(d,x)},b=p=>{var S;const x={...a},w=(S=x[p])==null?void 0:S.findIndex(k=>k===3);w!==-1&&w!==void 0&&(x[p]=[...x[p].slice(0,w),...x[p].slice(w+1)]),g(d,x)},j=p=>{var S;const x={...a},w=(S=x[p])==null?void 0:S.findIndex(k=>k===-3);w!==-1&&w!==void 0&&(x[p]=[...x[p].slice(0,w),...x[p].slice(w+1)]),g(d,x)};return t.jsxs(ge,{trigger:"click",title:`Add strong fit/unfit answer to ${s.name.pt}`,content:t.jsxs(O,{vertical:!0,gap:4,children:[t.jsx(P.Text,{type:"secondary",children:e.join(", ")}),t.jsxs(M,{icon:"üëç",block:!0,onClick:()=>n(s.id),children:[" ","Add strong fit"]}),t.jsxs(M,{icon:"üëé",block:!0,onClick:()=>f(s.id),children:[" ","Add strong unfit"]}),t.jsxs(z.Compact,{children:[t.jsx(M,{icon:"‚ùå",size:"small",block:!0,onClick:()=>b(s.id),children:"fit"}),t.jsx(M,{icon:"‚ùå",size:"small",block:!0,onClick:()=>j(s.id),children:"unfit"})]})]}),children:[i&&t.jsxs("div",{children:[t.jsx(F,{title:s.id,children:s.name.pt})," ",h&&t.jsx(F,{title:"Complete: It has 5 or more answers",children:t.jsx(re,{style:{color:"gold"}})})]}),t.jsxs(O,{align:"flex-start",gap:12,children:[t.jsx(F,{title:`Values: ${e.join(", ")} : ${o||(l?`${l}*`:"")}`,children:r?t.jsx(se,{percent:m+u,size:[c,20],status:"exception",success:{percent:u},showInfo:!1}):t.jsx(se,{percent:m+u,size:[c,10],status:"exception",success:{percent:u},showInfo:!1})}),!i&&h&&t.jsx(F,{title:"Complete: It has 5 or more answers",children:t.jsx(re,{style:{color:"gold"}})})]})]})}function ut({suspect:s,answersPerQuestion:e={},questions:o,addEntryToUpdate:l,allAnswers:u}){const{queryParams:m}=I({sortSuspectsBy:"answers"}),h=m.get("sortSuspectsBy")??"answers",r=y.useMemo(()=>{const g=Object.values(o).map(a=>{const c=e[a.id]??{},{enoughData:i,reliable:n,yesPercentage:f,noPercentage:b,blankPercentage:j,values:p,total:x,resolution:w,projection:S,complete:k}=J(s.id,{[s.id]:c});return{id:a.id,question:a,enoughData:i,reliable:n,yesPercentage:f,noPercentage:b,blankPercentage:j,values:p,total:x,resolution:w,projection:S,complete:k}});return h==="answers"?v.orderBy(g,["reliable","enoughData","yesPercentage",a=>a.values.length],["desc","desc","desc","desc"]):v.orderBy(g,a=>Number(a.id.split("-")[1]),["asc"])},[e,o,s.id,h]),d=[{key:"id",title:"Id",dataIndex:"id"},{key:"question",title:"Question",dataIndex:"question",render:g=>g.question},{key:"answer",title:"Answer",dataIndex:"id",sorter:(g,a)=>g.total-a.total,render:g=>{const a=r.find(c=>c.id===g);return a?t.jsx(O,{gap:8,wrap:"nowrap",children:t.jsx(me,{values:a.values,resolution:a.resolution,projection:a.projection,yesPercentage:a.yesPercentage,noPercentage:a.noPercentage,complete:a.complete,enoughData:a.enoughData,suspect:s,testimonyId:a.question.id,answers:u[a.question.id]||{},addEntryToUpdate:l,barWidth:120})}):""}}];return t.jsx(z,{wrap:!0,size:"large",children:t.jsx(X,{rowKey:"id",columns:d,dataSource:r,bordered:!0})})}function dt({isLoading:s,isSuccess:e,questions:o,data:l,suspects:u,addEntryToUpdate:m}){const{queryParams:h,addParam:r}=I(),d=y.useMemo(()=>Object.keys(l).reduce((n,f)=>{const b=l[f]??{};return Object.keys(b).forEach(j=>{n[j]||(n[j]={}),n[j][f]=b[j]}),n},{}),[l]),g=y.useMemo(()=>v.orderBy(Object.values(u).map(n=>({...n,answers:d[n.id]})),n=>Number(n.id.split("-")[1]),"asc"),[u,d]),a=de({total:g.length,showQuickJumper:!0}),c=[{title:"Id",dataIndex:"id",key:"id",sorter:(n,f)=>Number(n.id.split("-")[1])-Number(f.id.split("-")[1])},{title:"Picture",dataIndex:"id",render:n=>t.jsx(U,{id:_(n,"gb"),width:48})},{title:"Name",dataIndex:"name",key:"name",sorter:(n,f)=>n.name.pt.localeCompare(f.name.pt),render:n=>n.pt},{title:"Questions Answered",dataIndex:"answers",key:"answers",sorter:(n,f)=>Object.keys(n.answers??{}).length-Object.keys(f.answers??{}).length,render:n=>n?Object.values(n).length:""}],i=ue({maxExpandedRows:1,expandedRowRender:n=>t.jsx(ut,{suspect:n,answersPerQuestion:d[n.id],questions:o,addEntryToUpdate:m,allAnswers:l}),rowExpandable:()=>e});return t.jsxs(O,{gap:12,className:"full-width py-4",vertical:!0,children:[t.jsxs(O,{justify:"space-between",align:"center",children:[t.jsx(P.Title,{level:4,className:"my-0",children:"Testimonies by Suspect"}),t.jsx(B,{checked:h.get("sortSuspectsBy")==="answers",onChange:n=>r("sortSuspectsBy",n?"answers":"id"),checkedChildren:"Sort by Answers",unCheckedChildren:"Sort by Id"})]}),t.jsx(X,{columns:c,dataSource:g,pagination:a,rowKey:"id",expandable:i,loading:s,bordered:!0,className:"full-width"})]})}function ht({answers:s,suspects:e,addEntryToUpdate:o,testimonyId:l}){const[u,m]=Me(12),{queryParams:h,is:r}=I({sortSuspectsBy:"answers"}),d=r("enableBatch"),g=h.get("sortSuspectsBy")??"answers",a=y.useMemo(()=>{const n=Object.keys(e).map(f=>J(f,s));return g==="answers"?v.orderBy(n,["reliable","enoughData",f=>f.values.length,"yesPercentage","noPercentage",f=>Number(f.suspectCardId.split("-")[1])],["desc","desc","desc","desc","desc","asc"]):v.orderBy(n,f=>Number(f.suspectCardId.split("-")[1]),["asc"])},[s,e,g]),[c,i]=y.useState([]);return t.jsxs(z,{direction:"vertical",children:[t.jsx(mt,{selection:c,setSelection:i,suspects:e,addEntryToUpdate:o,list:a,testimonyId:l,answers:s}),t.jsx(z,{wrap:!0,ref:m,size:"large",children:a.map(n=>t.jsxs(O,{vertical:!0,gap:6,className:le({"selection-outline":d&&c.includes(n.suspectCardId)}),children:[t.jsx(U,{id:n.imageId,width:u,className:n.values.length>1?void 0:"grayscale"}),t.jsxs(O,{gap:4,children:[d&&t.jsx(he,{disabled:n.complete,checked:c.includes(n.suspectCardId),onChange:f=>{const b=f.target.checked;i(j=>b?[...j,n.suspectCardId]:j.filter(p=>p!==n.suspectCardId))}}),t.jsx(me,{values:n.values,resolution:n.resolution,projection:n.projection,yesPercentage:n.yesPercentage,noPercentage:n.noPercentage,complete:n.complete,enoughData:n.enoughData,suspect:e[n.suspectCardId],testimonyId:l,answers:s,addEntryToUpdate:o,barWidth:u,showName:!0})]})]},n.suspectCardId))})]})}function mt({testimonyId:s,selection:e,setSelection:o,suspects:l,addEntryToUpdate:u,list:m,answers:h}){const[r,d]=y.useState([]),{addParam:g,removeParam:a,is:c}=I({sortSuspectsBy:"answers"}),i=c("enableBatch"),n=j=>{d(p=>p.includes(j)?p.filter(x=>x!==j):[...p,j])},f=y.useMemo(()=>v.keyBy(m,"suspectCardId"),[m]);y.useEffect(()=>{if(r.length===0&&e.length>0){o([]);return}if(!r.length)return;const p=(e.length>0?e:Object.values(f).filter(x=>!x.complete&&!x.values.includes(3)&&!x.values.includes(-3)).map(x=>x.suspectCardId)).filter(x=>{const w=l[x],S=[w.gender,w.ethnicity,w.build,w.height];return w.age==="18-21"&&S.push("young"),(w.age==="21-30"||w.age==="30-40")&&S.push("adult"),w.age==="40-50"&&S.push("parent"),(w.age==="50-60"||w.age==="60-70"||w.age==="70-80"||w.age==="80-90")&&S.push("senior"),r.every(k=>S.includes(k))});o(p)},[r]);const b=j=>{const p=v.cloneDeep(h);e.forEach(x=>{p[x]=[...p[x]||[],j]}),u(s,p),d([])};return t.jsxs(O,{align:"center",gap:6,justify:"space-between",className:"mb-4",children:[t.jsxs(O,{gap:3,children:[t.jsx(P.Text,{className:"nowrap buceta",style:{minWidth:"5ch"},children:"Batch"}),t.jsx(B,{value:i,checkedChildren:"On",unCheckedChildren:"Off",onChange:j=>{j?g("enableBatch",!0):a("enableBatch")}})]}),i&&t.jsxs(t.Fragment,{children:[t.jsxs(P.Text,{className:"nowrap mr-2",children:["Selected ",e.length]}),t.jsxs(O,{gap:6,wrap:!0,align:"center",justify:"center",children:[t.jsx(T,{filter:"male",activeFilters:r,updateActiveFilter:n}),t.jsx(T,{filter:"female",activeFilters:r,updateActiveFilter:n}),t.jsx(T,{filter:"young",activeFilters:r,updateActiveFilter:n}),t.jsx(T,{filter:"adult",activeFilters:r,updateActiveFilter:n}),t.jsx(T,{filter:"parent",activeFilters:r,updateActiveFilter:n}),t.jsx(T,{filter:"senior",activeFilters:r,updateActiveFilter:n}),t.jsx(T,{filter:"thin",activeFilters:r,updateActiveFilter:n}),t.jsx(T,{filter:"muscular",activeFilters:r,updateActiveFilter:n}),t.jsx(T,{filter:"large",activeFilters:r,updateActiveFilter:n}),t.jsx(T,{filter:"asian",activeFilters:r,updateActiveFilter:n}),t.jsx(T,{filter:"black",activeFilters:r,updateActiveFilter:n}),t.jsx(T,{filter:"caucasian",activeFilters:r,updateActiveFilter:n}),t.jsx(T,{filter:"latino",activeFilters:r,updateActiveFilter:n})]}),t.jsxs(O,{align:"center",gap:6,children:[t.jsx(M,{onClick:()=>d([]),danger:!0,size:"small",children:"Clear"}),t.jsx(ne,{title:"Apply +3 to selected suspects?",onConfirm:()=>b(3),children:t.jsx(M,{disabled:e.length===0,size:"small",type:"primary",className:"ml-10",children:"Apply +3"})}),t.jsx(ae,{type:"vertical"}),t.jsx(ne,{title:"Apply -3 to selected suspects?",onConfirm:()=>b(-3),children:t.jsx(M,{disabled:e.length===0,size:"small",type:"primary",children:"Apply -3"})})]})]})]})}function T({filter:s,activeFilters:e,updateActiveFilter:o}){return t.jsxs(t.Fragment,{children:[t.jsxs("span",{children:[t.jsx(he,{checked:e.includes(s),onClick:()=>o(s)})," ",v.capitalize(s)]}),t.jsx(ae,{type:"vertical"})]})}function ft({data:s,questions:e,suspects:o,isLoading:l,isSuccess:u,addEntryToUpdate:m}){const{queryParams:h,addParam:r}=I(),d=y.useMemo(()=>v.orderBy(Object.values(e),i=>Number(i.id.split("-")[1]),"asc"),[e]),g=de({total:d.length,showQuickJumper:!0}),a=[{title:"Id",dataIndex:"id",key:"id",sorter:(i,n)=>Number(i.id.split("-")[1])-Number(n.id.split("-")[1])},{title:"Question",dataIndex:"question",key:"question",sorter:(i,n)=>i.question.localeCompare(n.question)},{title:"NSFW",dataIndex:"nsfw",key:"nsfw",render:i=>i?t.jsx(Re,{style:{color:"hotPink"}}):"",sorter:(i,n)=>Number(i.nsfw)-Number(n.nsfw)},{title:"Answers",dataIndex:"id",key:"answers",render:i=>{const n=s[i];return n?Object.values(n).length:""}}],c=ue({maxExpandedRows:1,expandedRowRender:i=>t.jsx(ht,{testimonyId:i.id,answers:s[i.id]??{},suspects:o,addEntryToUpdate:m}),rowExpandable:()=>u});return t.jsxs(O,{gap:12,className:"full-width py-4",vertical:!0,children:[t.jsxs(O,{justify:"space-between",align:"center",children:[t.jsx(P.Title,{level:4,className:"my-0",children:"Suspects by Testimony"}),t.jsx(B,{checked:h.get("sortSuspectsBy")==="answers",onChange:i=>r("sortSuspectsBy",i?"answers":"id"),checkedChildren:"Sort by Answers",unCheckedChildren:"Sort by Id"})]}),t.jsx(X,{columns:a,dataSource:d,pagination:g,rowKey:"id",expandable:c,loading:l,bordered:!0,className:"full-width"})]})}function gt(s){const{queryParams:e,is:o}=I();return t.jsxs(t.Fragment,{children:[(o("display","questions")||!e.get("display"))&&t.jsx(ft,{...s}),o("display","suspects")&&t.jsx(dt,{...s}),o("display","simulator")&&t.jsx(at,{})]})}const pt="Left",xt="Right",jt="Up",bt="Down",N={delta:10,preventScrollOnSwipe:!1,rotationAngle:0,trackMouse:!1,trackTouch:!0,swipeDuration:1/0,touchEventOptions:{passive:!0}},Q={first:!0,initial:[0,0],start:0,swiping:!1,xy:[0,0]},oe="mousemove",ie="mouseup",wt="touchend",yt="touchmove",vt="touchstart";function St(s,e,o,l){return s>e?o>0?xt:pt:l>0?bt:jt}function ce(s,e){if(e===0)return s;const o=Math.PI/180*e,l=s[0]*Math.cos(o)+s[1]*Math.sin(o),u=s[1]*Math.cos(o)-s[0]*Math.sin(o);return[l,u]}function Ot(s,e){const o=a=>{const c="touches"in a;c&&a.touches.length>1||s((i,n)=>{n.trackMouse&&!c&&(document.addEventListener(oe,l),document.addEventListener(ie,h));const{clientX:f,clientY:b}=c?a.touches[0]:a,j=ce([f,b],n.rotationAngle);return n.onTouchStartOrOnMouseDown&&n.onTouchStartOrOnMouseDown({event:a}),Object.assign(Object.assign(Object.assign({},i),Q),{initial:j.slice(),xy:j,start:a.timeStamp||0})})},l=a=>{s((c,i)=>{const n="touches"in a;if(n&&a.touches.length>1)return c;if(a.timeStamp-c.start>i.swipeDuration)return c.swiping?Object.assign(Object.assign({},c),{swiping:!1}):c;const{clientX:f,clientY:b}=n?a.touches[0]:a,[j,p]=ce([f,b],i.rotationAngle),x=j-c.xy[0],w=p-c.xy[1],S=Math.abs(x),k=Math.abs(w),E=(a.timeStamp||0)-c.start,R=Math.sqrt(S*S+k*k)/(E||1),D=[x/(E||1),w/(E||1)],C=St(S,k,x,w),K=typeof i.delta=="number"?i.delta:i.delta[C.toLowerCase()]||N.delta;if(S<K&&k<K&&!c.swiping)return c;const $={absX:S,absY:k,deltaX:x,deltaY:w,dir:C,event:a,first:c.first,initial:c.initial,velocity:R,vxvy:D};$.first&&i.onSwipeStart&&i.onSwipeStart($),i.onSwiping&&i.onSwiping($);let Z=!1;return(i.onSwiping||i.onSwiped||i[`onSwiped${C}`])&&(Z=!0),Z&&i.preventScrollOnSwipe&&i.trackTouch&&a.cancelable&&a.preventDefault(),Object.assign(Object.assign({},c),{first:!1,eventData:$,swiping:!0})})},u=a=>{s((c,i)=>{let n;if(c.swiping&&c.eventData){if(a.timeStamp-c.start<i.swipeDuration){n=Object.assign(Object.assign({},c.eventData),{event:a}),i.onSwiped&&i.onSwiped(n);const f=i[`onSwiped${n.dir}`];f&&f(n)}}else i.onTap&&i.onTap({event:a});return i.onTouchEndOrOnMouseUp&&i.onTouchEndOrOnMouseUp({event:a}),Object.assign(Object.assign(Object.assign({},c),Q),{eventData:n})})},m=()=>{document.removeEventListener(oe,l),document.removeEventListener(ie,h)},h=a=>{m(),u(a)},r=(a,c)=>{let i=()=>{};if(a&&a.addEventListener){const n=Object.assign(Object.assign({},N.touchEventOptions),c.touchEventOptions),f=[[vt,o,n],[yt,l,Object.assign(Object.assign({},n),c.preventScrollOnSwipe?{passive:!1}:{})],[wt,u,n]];f.forEach(([b,j,p])=>a.addEventListener(b,j,p)),i=()=>f.forEach(([b,j])=>a.removeEventListener(b,j))}return i},g={ref:a=>{a!==null&&s((c,i)=>{if(c.el===a)return c;const n={};return c.el&&c.el!==a&&c.cleanUpTouch&&(c.cleanUpTouch(),n.cleanUpTouch=void 0),i.trackTouch&&a&&(n.cleanUpTouch=r(a,i)),Object.assign(Object.assign(Object.assign({},c),{el:a}),n)})}};return e.trackMouse&&(g.onMouseDown=o),[g,r]}function kt(s,e,o,l){return!e.trackTouch||!s.el?(s.cleanUpTouch&&s.cleanUpTouch(),Object.assign(Object.assign({},s),{cleanUpTouch:void 0})):s.cleanUpTouch?e.preventScrollOnSwipe!==o.preventScrollOnSwipe||e.touchEventOptions.passive!==o.touchEventOptions.passive?(s.cleanUpTouch(),Object.assign(Object.assign({},s),{cleanUpTouch:l(s.el,e)})):s:Object.assign(Object.assign({},s),{cleanUpTouch:l(s.el,e)})}function Et(s){const{trackMouse:e}=s,o=y.useRef(Object.assign({},Q)),l=y.useRef(Object.assign({},N)),u=y.useRef(Object.assign({},l.current));u.current=Object.assign({},l.current),l.current=Object.assign(Object.assign({},N),s);let m;for(m in N)l.current[m]===void 0&&(l.current[m]=N[m]);const[h,r]=y.useMemo(()=>Ot(d=>o.current=d(o.current,l.current),{trackMouse:e}),[e]);return o.current=kt(o.current,l.current,u.current,r),h}function Ct({suspects:s,questions:e,answers:o}){var b;const{width:l,height:u}=Fe(),{is:m,addParam:h,removeParam:r}=I(),[d,g,a]=Ve(),c=Et({onSwipedLeft:()=>console.log("Swiped Left"),onSwipedRight:()=>console.log("Swiped Right"),onSwipedUp:()=>console.log("Swiped Up"),preventScrollOnSwipe:!0,trackTouch:!0,trackMouse:!0}),i=()=>{g({suspectId:v.sample(Object.keys(s))||null,testimonyId:v.sample(Object.keys(e))||null})},n=()=>{i()},f=!!(d!=null&&d.suspectId)&&!!(d!=null&&d.testimonyId);return t.jsxs(t.Fragment,{children:[t.jsx(M,{onClick:()=>h("testimonyDrawer",!0),block:!0,children:"Testify Drawer"}),t.jsxs(Be,{title:t.jsx(P,{children:"Does this person do this?"}),open:m("testimonyDrawer"),onCancel:()=>r("testimonyDrawer"),maskClosable:!1,width:l-64,footer:null,...c,children:[f&&t.jsxs(O,{vertical:!0,gap:8,className:"mb-8",justify:"center",align:"center",children:[t.jsx(U,{id:_(d.suspectId??"","gb"),width:Math.max(u/4,128)}),t.jsx(P.Title,{level:5,className:"text-center",children:(b=e[d.testimonyId??""])==null?void 0:b.question})]}),t.jsxs(z.Compact,{block:!0,size:"large",className:"mb-8",children:[t.jsx(M,{block:!0,icon:"üëé",disabled:!f,children:"No"}),t.jsx(M,{block:!0,onClick:n,children:"Skip"}),t.jsx(M,{block:!0,icon:"üëç",iconPosition:"end",disabled:!f,children:"Yes"})]})]})]})}function Tt({suspects:s,questions:e,data:o,hasNewData:l,isDirty:u,save:m,isSaving:h,entriesToUpdate:r,addEntryToUpdate:d}){const{queryParams:g,addParams:a}=I(),c=y.useMemo(()=>{const i={};return Object.values(o).forEach(n=>{Object.keys(n).forEach(f=>{n[f]&&(i[f]||(i[f]=0),we(n[f])>=5&&(i[f]+=1))})}),{queriedTestimoniesCount:Object.keys(o).length,suspectsCount:Object.keys(i).length,reliableSuspectsCount:Object.values(i).filter(n=>n>=5).length}},[o]);return t.jsxs(t.Fragment,{children:[t.jsx(L,{children:t.jsxs(O,{vertical:!0,gap:12,children:[t.jsx(Pe,{isDirty:u,onSave:m,isSaving:h,dirt:JSON.stringify(r)}),t.jsx(Te,{data:async()=>await Mt(o),fileName:"testimony-answers.json",disabled:u,hasNewData:l,block:!0})]})}),t.jsx(L,{children:t.jsx(Ce,{label:"Display",value:g.get("display")??"questions",onChange:i=>a({display:i,page:1},{page:1}),options:[{title:"Questions",icon:t.jsx(ze,{}),value:"questions"},{title:"Suspects",icon:t.jsx(Qe,{}),value:"suspects"},{title:"Simulator",icon:t.jsx(Ye,{}),value:"simulator"}]})}),t.jsx(L,{children:t.jsxs("div",{style:{fontSize:"0.85em"},children:[t.jsx("strong",{children:"Legend"}),t.jsxs("ul",{children:[t.jsx("li",{children:"Reliability: At least 5 votes"}),t.jsx("li",{children:"Large Bars: There's enough data (at least 3)"}),t.jsx("li",{children:"Small blue bar: in progress negative"})]})]})}),t.jsxs(L,{children:[t.jsxs("div",{style:{fontSize:"0.85em"},children:[t.jsx("strong",{children:"Counts"}),t.jsxs("ul",{children:[t.jsxs("li",{children:["Testimonies: ",c.queriedTestimoniesCount]}),t.jsxs("li",{children:["Suspects: ",c.suspectsCount]}),t.jsx("li",{children:t.jsxs(F,{title:"A reliable suspect is one that has at least 5 complete testimonies.",children:["Reliable suspects: ",c.reliableSuspectsCount]})})]})]}),t.jsx(Ct,{suspects:s,questions:e,answers:o,addEntryToUpdate:d})]})]})}async function Mt(s){console.log("Preparing file for download...x");const e=await De("data","testimonies")(),o=Ie(e);console.log("Parsed data from Firestore:",o);const l=v.cloneDeep(s);return Object.keys(l).forEach(u=>{const m=l[u],h=o[u]||{};Object.keys(m).forEach(r=>{const d=h[r]||[],g=Xe([...m[r],...d]);m[r]=g})}),Ne(Ae(l))}function ys(){const s=ye();return t.jsx(pe,{title:"Testimonies",subtitle:"Suspect Testimony Rates",children:t.jsxs(ee,{hasSider:!0,children:[t.jsx(je,{children:t.jsx(Tt,{...s})}),t.jsx(ee.Content,{className:"content",children:t.jsx(xe,{isLoading:s.isLoading,error:s.error,hasResponseData:!v.isEmpty(s.data),children:t.jsx(gt,{...s})})})]})})}export{ys as TestimoniesPage,ys as default};
