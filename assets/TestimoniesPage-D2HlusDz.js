import{r as j,a as L,_ as q,j as t,T as F,B as R,aj as Z,y as T,af as ee,Y as te,X as se,P as ne,L as _}from"./index-BpOPtDno.js";import{D as oe}from"./DataLoadingWrapper-B86QopG6.js";import{l as x,c as re,P as ie}from"./useBaseUrl-DGQ0WeaR.js";import{u as I}from"./useQueryParams-0iU09vdH.js";import{R as ae}from"./main-CmHhfdXr.js";import{u as ce,D as le,a as ue,g as de}from"./constants-hr1a1cN0.js";import{u as C}from"./useTDResource-Gj2sjeOb.js";import{I as Q}from"./ImageCard-BNF_1J-X.js";import{g as me}from"./utils-D1c9hPZl.js";import{F as S}from"./index-CoMLl3xt.js";import{B as W,D as he}from"./DownloadButton-B1eA7G8a.js";import{S as J}from"./index-D5RiZbBy.js";import{u as U}from"./useTableExpandableRows-BiRqHPqd.js";import{u as K}from"./useTablePagination-PNznRvs0.js";import{S as z}from"./index-Opn2dpJE.js";import{F as G}from"./Table-DPJJWGVM.js";import{P as B}from"./progress-BssllH-P.js";import{T as Y}from"./index-BVwjVxAw.js";import{u as pe}from"./useCardWidth-8M-t-Sdr.js";import{R as ge}from"./FireFilled-BBljoHet.js";import{F as fe}from"./FilterEntries-Ca_ivSrS.js";import{S as D}from"./SiderContent-B5DdMimI.js";import{S as xe}from"./SaveButton-DrwiZphv.js";import{a as je,d as be,e as ye}from"./index-DDOyUl_x.js";import{R as we}from"./TableOutlined-BU2fkma7.js";import{u as ve}from"./useGetFirestoreDoc-b19109Z3.js";import{u as Se}from"./useUpdateFirestoreDoc-BW6mGRPr.js";import"./moment-C5S46NFB.js";import"./gapSize-U1swVQyS.js";import"./index-DixHne5n.js";import"./index-Bso3DuBd.js";import"./index-BKCVE1-P.js";import"./index-aKvSwoWC.js";import"./scrollTo-Bn6L7X6K.js";import"./Pagination-CUJ_Pm05.js";import"./extendsObject-keMuGWqj.js";import"./Input-Bu1Bxuxa.js";import"./index-BJjapmBU.js";import"./SaveOutlined-BgQlvX8X.js";import"./constants-CR1AS5tN.js";import"./Item-E5GiKY6X.js";import"./useMutation-DYAWxsN6.js";var ke={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M594.3 601.5a111.8 111.8 0 0029.1-75.5c0-61.9-49.9-112-111.4-112s-111.4 50.1-111.4 112c0 29.1 11 55.5 29.1 75.5a158.09 158.09 0 00-74.6 126.1 8 8 0 008 8.4H407c4.2 0 7.6-3.3 7.9-7.5 3.8-50.6 46-90.5 97.2-90.5s93.4 40 97.2 90.5c.3 4.2 3.7 7.5 7.9 7.5H661a8 8 0 008-8.4c-2.8-53.3-32-99.7-74.7-126.1zM512 578c-28.5 0-51.7-23.3-51.7-52s23.2-52 51.7-52 51.7 23.3 51.7 52-23.2 52-51.7 52zm416-354H768v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H548v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H328v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H96c-17.7 0-32 14.3-32 32v576c0 17.7 14.3 32 32 32h832c17.7 0 32-14.3 32-32V256c0-17.7-14.3-32-32-32zm-40 568H136V296h120v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h148v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h148v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h120v496z"}}]},name:"contacts",theme:"outlined"},Ee={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M300 328a60 60 0 10120 0 60 60 0 10-120 0zM852 64H172c-17.7 0-32 14.3-32 32v660c0 17.7 14.3 32 32 32h680c17.7 0 32-14.3 32-32V96c0-17.7-14.3-32-32-32zm-32 660H204V128h616v596zM604 328a60 60 0 10120 0 60 60 0 10-120 0zm250.2 556H169.8c-16.5 0-29.8 14.3-29.8 32v36c0 4.4 3.3 8 7.4 8h729.1c4.1 0 7.4-3.6 7.4-8v-36c.1-17.7-13.2-32-29.7-32zM664 508H360c-4.4 0-8 3.6-8 8v60c0 4.4 3.6 8 8 8h304c4.4 0 8-3.6 8-8v-60c0-4.4-3.6-8-8-8z"}}]},name:"robot",theme:"outlined"},Oe={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M868 160h-92v-40c0-4.4-3.6-8-8-8H256c-4.4 0-8 3.6-8 8v40h-92a44 44 0 00-44 44v148c0 81.7 60 149.6 138.2 162C265.6 630.2 359 721.8 476 734.5v105.2H280c-17.7 0-32 14.3-32 32V904c0 4.4 3.6 8 8 8h512c4.4 0 8-3.6 8-8v-32.3c0-17.7-14.3-32-32-32H548V734.5C665 721.8 758.4 630.2 773.8 514 852 501.6 912 433.7 912 352V204a44 44 0 00-44-44zM248 439.6c-37.1-11.9-64-46.7-64-87.6V232h64v207.6zM840 352c0 41-26.9 75.8-64 87.6V232h64v120z"}}]},name:"trophy",theme:"filled"},Ce=function(e,o){return j.createElement(L,q({},e,{ref:o,icon:ke}))},Pe=j.forwardRef(Ce),Re=function(e,o){return j.createElement(L,q({},e,{ref:o,icon:Ee}))},Te=j.forwardRef(Re),Ne=function(e,o){return j.createElement(L,q({},e,{ref:o,icon:Oe}))},De=j.forwardRef(Ne);const V=(r,e,o)=>{const{reliabilityThreshold:c=4,projectionThreshold:l=55}={},s=`us-gb-${r.split("-")[1]}`,d=e[r]??[];let m=0,p=0;d.forEach(v=>{v===3&&(m+=3),v===-3&&(p+=3)});const a=d.filter(v=>v!==3&&v!==-3),u=a.length+m+p,g=Math.max(u,5),h=d.filter(v=>v===1).length+m,f=Math.round(h/g*100),y=d.filter(v=>v===0).length+p,O=Math.round(y/g*100),M=Math.round((g-h-y)/g*100),w=a.length+m+p>=5,k=u>3,E=u>c,N=E?f>O?"ðŸ‘":"ðŸ‘Ž":null,X=k?f>=l?"ðŸ‘":O>=l?"ðŸ‘Ž":null:null;return{suspectCardId:r,imageId:s,enoughData:k,reliable:E,total:g,yesCount:h,yesPercentage:f,noCount:y,noPercentage:O,blankPercentage:M,complete:w,values:d,resolution:N,projection:X}},H=9,Ae=(r,e,o,c)=>{const[l]=ce(le.ESPIONAGEM,c),i=C("suspects",r),s=C(`testimony-questions-${e}`,r),d=C("testimony-answers",r),m=j.useMemo(()=>Me(d.data),[d.data]),p=j.useMemo(()=>$e(i.data),[i.data]);return{entries:j.useMemo(()=>!l||!i.isSuccess||!s.isSuccess||!d.isSuccess?{}:Fe(o,l,i.data,s.data,m,p),[r,l,i,s,d,o,m,p]),isLoading:i.isLoading||s.isLoading||d.isLoading}},Fe=(r,e,o,c,l,i)=>{console.count("Creating Espionagem...");let s=e.latestDate;const d=[],m={};for(let p=0;p<r;p++){const a=ue(s);s=a;let u=null,g=0;for(;!u&&g<100;){g++;const n=Ie(o,c,l,i,d);if(Le(n.statements)){u=n,console.log(`Generated valid game for ${a} after ${g} attempts`);break}}if(!u)throw new Error(`Failed to generate valid game for ${a} after 100 attempts`);d.push(u.culpritId),m[a]={id:a,type:"espionagem",number:e.latestNumber+p+1,...u}}return m};function Ie(r,e,o,c,l){let i=[];const s=[],d={},m=x.sample(Object.keys(o));if(!m)throw new Error("No selected testimony ID found");const p=Object.keys(o[m]).filter(w=>!l.includes(w)),a=p.length>0?p:Object.keys(o[m]),u=x.sample(a);if(!u)throw new Error("No selected culprit ID found");const g=x.sampleSize(Object.keys(o[m]).filter(w=>w!==u),H-1);for(i.push(...g);i.length<8;){const w=x.sampleSize(Object.keys(r).filter(k=>!i.includes(k)&&k!==u),H-i.length-1);i.push(...w)}const n={};Object.keys(c).forEach(w=>{if(c[w][u]===void 0){const k=Object.keys(c[w]).filter(E=>i.includes(E));if(k.length>0){const E={};k.forEach(N=>{i.includes(N)&&(E[N]=!0)}),n[w]=E}}});const h=e[m];s.push(ze(u,i,h,o[m])),P(d,s[0].excludes);const f=$(u,i,n);s.push(f),P(d,f.excludes),i=x.shuffle([...i,u]);const b=$(u,i,n,[f.key],"worst");s.push(b),P(d,b.excludes);const y=$(u,i,n,[b.key],"worst");s.push(y),P(d,y.excludes);const O=Be(u,i,s);s.push(O),P(d,O.excludes);const M=[s[0],s[1],s[2],s[4],s[3]];return{isNsfw:h.nsfw??!1,culpritId:u,statements:M,suspectsIds:i}}const Me=r=>{const e={};console.log("âš™ï¸ Calculating suspect answers...");for(const o of Object.keys(r)){const c=r[o];for(const l of Object.keys(c)){const{resolution:i,projection:s}=V(l,c);if(!i&&!s){console.log("â‰ï¸ Ignoring testimony with no resolution or projection");continue}if(e[o]===void 0&&(e[o]={}),i){e[o][l]=i==="ðŸ‘";continue}if(s){e[o][l]=s==="ðŸ‘";continue}console.log("â‰ï¸ Ignoring testimony with not enough values")}}return Object.keys(e).forEach(o=>{x.isEmpty(e[o])&&delete e[o]}),Object.keys(e).forEach(o=>{Object.keys(e[o]).length<3&&(console.log("â‰ï¸ Removing testimonies with less than 3 answers"),delete e[o])}),Object.keys(e).forEach(o=>{x.uniq(Object.values(e[o])).length===1&&(console.log("â‰ï¸ Removing testimonies with the same answer"),delete e[o])}),console.log(e),e},$e=r=>{const e={};for(const c of Object.keys(r)){const{gender:l,ethnicity:i,age:s,build:d,height:m,features:p}=r[c];if(!d){console.log("â‰ï¸ Ignoring suspect with missing build",c);continue}if(!m){console.log("â‰ï¸ Ignoring suspect with missing height",c);continue}if(!p||p.length===0){console.log("â‰ï¸ Ignoring suspect with missing features",c);continue}e[l]===void 0&&(e[l]={}),e[l][c]=!0,e[i]===void 0&&(e[i]={}),e[i][c]=!0,e[s]===void 0&&(e[s]={}),e[s][c]=!0,e[d]===void 0&&(e[d]={}),e[d][c]=!0,e[m]===void 0&&(e[m]={}),e[m][c]=!0,p.forEach(a=>{e[a]===void 0&&(e[a]={}),e[a][c]=!0})}return e.young=x.cloneDeep(e["18-21"]),e.adult=x.cloneDeep({...e["21-30"],...e["30-40"],...e["40-50"]}),e.senior=x.cloneDeep({...e["50-60"],...e["60-70"],...e["70-80"],...e["80-90"]}),["18-21","21-30","30-40","40-50","50-60","60-70","70-80","80-90","average","medium","mixed","adult","tall"].forEach(c=>{delete e[c]}),e},P=(r,e)=>{e.forEach(o=>{r[o]===void 0&&(r[o]=0),r[o]++})},ze=(r,e,o,c)=>{const l=c[r],i=e.filter(d=>c[d]!==void 0&&c[d]!==l),s=o.answer.charAt(0).toLowerCase()+o.answer.slice(1);return{key:`testimony.${o.id}`,text:`O(a) suspeito(a) ${l?"":"nÃ£o "}${s}`,excludes:i}},A={row1:{indexes:[0,1,2],text:"na primeira linha"},row2:{indexes:[3,4,5],text:"na segunda linha"},row3:{indexes:[6,7,8],text:"na terceira linha"},column1:{indexes:[0,3,6],text:"na primeira coluna"},column2:{indexes:[1,4,7],text:"na segunda coluna"},column3:{indexes:[2,5,8],text:"na terceira coluna"},corners:{indexes:[0,2,6,8],text:"nos cantos"}},Be=(r,e,o)=>{const c=e.indexOf(r),l={};for(const m of Object.keys(A)){const{indexes:p}=A[m];p.includes(c)||(l[m]=p.reduce((a,u)=>o.some(g=>g.excludes.includes(e[u]))?a+1:a,0))}const s=Object.keys(l).sort((m,p)=>l[m]-l[p])[0],d=A[s].indexes.map(m=>e[m]);return{key:`not.grid.${s}`,text:`O(a) suspeito(a) nÃ£o estÃ¡ ${A[s].text}`,excludes:d}},$=(r,e,o,c=[],l="best")=>{const i=x.difference(e,[r]),s=c.map(u=>u.replace("not.feature.","")),d=Object.keys(o).filter(u=>Object.keys(o[u]).length<=6&&!s.includes(u)).sort((u,g)=>Object.keys(o[g]).length-Object.keys(o[u]).length),m=l==="best"?d[0]:x.sample(d.slice(2,5))??d[2];if(!m)throw Error(`No suitable feature found for ${l} selection`);const p=i.filter(u=>o[m][u]),a=He[m];return a||console.warn(`Feature ${m} not found in translations`),{key:`not.feature.${m}`,text:`O(a) suspeito(a) nÃ£o ${a||m}`,excludes:p}},He={male:"Ã© homem",female:"Ã© mulher",black:"Ã© negro",white:"Ã© branco",asian:"Ã© asiÃ¡tico",latino:"Ã© latino",thin:"Ã© magro",fat:"Ã© gordo",tall:"Ã© alto",short:"Ã© baixo",young:"Ã© jovem",adult:"Ã© adulto",senior:"Ã© idoso",average:"Ã© mÃ©dio",medium:"Ã© mÃ©dio",mixed:"Ã© mestiÃ§o",hat:"estÃ¡ usando um chapÃ©u",tie:"estÃ¡ usando uma gravata",glasses:"estÃ¡ usando Ã³culos",brownHair:"tem cabelo castanho",shortHair:"tem cabelo curto",beard:"tem barba",caucasian:"Ã© caucasiano",scarf:"estÃ¡ usando um cachecol",blondeHair:"tem cabelo loiro",longHair:"tem cabelo longo",greyHair:"tem cabelo grisalho",bald:"Ã© careca",mustache:"tem bigode",goatee:"tem cavanhaque",muscular:"Ã© musculoso",blackHair:"tem cabelo preto",hoodie:"estÃ¡ usando um moletom",earrings:"estÃ¡ usando brincos",lipstick:"estÃ¡ usando batom",necklace:"estÃ¡ usando um colar",mediumHair:"tem cabelo mÃ©dio","middle-eastern":"Ã© do Oriente MÃ©dio",headscarf:"estÃ¡ usando um lenÃ§o na cabeÃ§a",redHair:"tem cabelo ruivo",large:"Ã© grande",piercings:"tem piercings",coloredHair:"tem cabelo colorido",indian:"Ã© indiano","native-american":"Ã© nativo-americano"},Le=r=>{const e=r.slice(0,3);return new Set(e.flatMap(c=>c.excludes)).size===H-1};function qe(){const[r,e]=j.useState({}),{entries:o}=Ae(!0,"pt",1,r);return t.jsxs(S,{vertical:!0,gap:12,className:"p-4",children:[t.jsxs(S,{justify:"space-between",align:"center",children:[t.jsx(F.Title,{level:4,className:"my-0",children:"Espionagem Simulator"}),t.jsx(R,{type:"primary",onClick:()=>e({}),children:"Re-run Simulation"})]}),t.jsx(Qe,{entries:o})]})}function Qe({entries:r}){const[e,o]=j.useState(!1),c=de(),l=r[c],i=j.useMemo(()=>l?l.statements.reduce((s,d)=>{const{excludes:m}=d;return m.forEach(p=>{s[p]?s[p]++:s[p]=1}),s},{}):{},[l]);return t.jsxs("div",{className:"full-width grid grid-2",children:[t.jsx(ae,{src:r??{},theme:"twilight",collapsed:3}),l&&t.jsxs(S,{gap:18,className:"p-4",children:[t.jsx("div",{children:t.jsx("div",{style:{width:`${105*3}px`,display:"grid",gap:"6px",gridTemplateColumns:"repeat(3, 1fr)"},children:l.suspectsIds.map(s=>t.jsx(W.Ribbon,{text:e?i[s]:null,color:"cyan",children:t.jsx(Q,{id:me(s,"gb"),width:96,className:re(e&&s===l.culpritId&&"red-border")},s)},s))})}),t.jsxs("div",{children:[t.jsx("div",{children:t.jsx(J,{checkedChildren:"Show culprit",unCheckedChildren:"Hide culprit",checked:e,onChange:o})}),l.statements.map((s,d)=>t.jsx(F.Paragraph,{children:t.jsx(W,{count:s.excludes.length,color:"cyan",children:t.jsx(Z,{message:s.text,banner:!0,type:d<3?"info":"error"},s.key)})},s.key))]})]})]})}function Ge({suspect:r,answersPerQuestion:e,questions:o}){const c=j.useMemo(()=>x.orderBy(Object.keys(e).map(i=>{const s=o[i],{enoughData:d,reliable:m,yesPercentage:p,noPercentage:a,blankPercentage:u,values:g,total:n}=V(r.id,{[r.id]:e[i]});return{id:i,question:s,enoughData:d,reliable:m,yesPercentage:p,noPercentage:a,blankPercentage:u,values:g,total:n}}),["reliable","enoughData","yesPercentage",i=>i.values.length],["desc","desc","desc","desc"]),[e,o,r.id]),l=[{key:"id",title:"Id",dataIndex:"id"},{key:"question",title:"Question",dataIndex:"question",render:i=>i.question},{key:"answer",title:"Answer",dataIndex:"id",sorter:(i,s)=>i.total-s.total,render:i=>{const s=c.find(d=>d.id===i);return s?t.jsxs(S,{gap:8,wrap:"nowrap",children:[t.jsx(T,{title:`Values: ${s.values.join(", ")}`,children:t.jsx(B,{percent:s.noPercentage+s.yesPercentage,size:s.enoughData?[100,20]:[100,10],status:s.enoughData?"exception":"active",success:{percent:s.yesPercentage},showInfo:!1})}),s.yesPercentage>=s.noPercentage?t.jsxs(Y,{color:"green-inverse",children:[s.yesPercentage,"% Yes"]}):t.jsxs(Y,{color:"red-inverse",children:[s.noPercentage,"% No"]})]}):""}}];return t.jsx(z,{wrap:!0,size:"large",children:t.jsx(G,{rowKey:"id",columns:l,dataSource:c,bordered:!0})})}function Ve({isLoading:r,isSuccess:e,questions:o,data:c,suspects:l}){const i=j.useMemo(()=>Object.keys(c).reduce((a,u)=>{const g=c[u]??{};return Object.keys(g).forEach(n=>{a[n]||(a[n]={}),a[n][u]=g[n]}),a},{}),[c]),s=j.useMemo(()=>x.orderBy(Object.values(l).map(a=>({...a,answers:i[a.id]})),a=>Number(a.id.split("-")[1]),"asc"),[l,i]),d=K({total:s.length,showQuickJumper:!0}),m=[{title:"Id",dataIndex:"id",key:"id",sorter:(a,u)=>Number(a.id.split("-")[1])-Number(u.id.split("-")[1])},{title:"Picture",dataIndex:"id",render:a=>{const u=a.split("-").join("-gb-");return t.jsx(Q,{id:u,width:48})}},{title:"Name",dataIndex:"name",key:"name",sorter:(a,u)=>a.name.pt.localeCompare(u.name.pt),render:a=>a.pt},{title:"Questions Answered",dataIndex:"answers",key:"answers",sorter:(a,u)=>Object.keys(a.answers).length-Object.keys(u.answers).length,render:a=>a?Object.values(a).length:""}],p=U({maxExpandedRows:1,expandedRowRender:a=>t.jsx(Ge,{suspect:a,answersPerQuestion:i[a.id],questions:o}),rowExpandable:()=>e});return t.jsx(G,{columns:m,dataSource:s,pagination:d,rowKey:"id",expandable:p,loading:r,bordered:!0,className:"full-width"})}function _e({answers:r,suspects:e,addEntryToUpdate:o,testimonyId:c}){const[l,i]=pe(12),{queryParams:s}=I({sortSuspectsBy:"answers"}),d=s.get("sortSuspectsBy")??"answers",m=j.useMemo(()=>{const n=Object.keys(e).map(h=>V(h,r));return d==="answers"?x.orderBy(n,["reliable","enoughData",h=>h.values.length,"yesPercentage"],["desc","desc","desc","desc"]):n},[r,e,d]),p=n=>{const h={...r};h[n]=[...h[n]||[],3],o(c,h)},a=n=>{const h={...r};h[n]=[...h[n]||[],-3],o(c,h)},u=n=>{var b;const h={...r},f=(b=h[n])==null?void 0:b.findIndex(y=>y===3);f!==-1&&f!==void 0&&(h[n]=[...h[n].slice(0,f),...h[n].slice(f+1)]),o(c,h)},g=n=>{var b;const h={...r},f=(b=h[n])==null?void 0:b.findIndex(y=>y===-3);f!==-1&&f!==void 0&&(h[n]=[...h[n].slice(0,f),...h[n].slice(f+1)]),o(c,h)};return t.jsx(z,{wrap:!0,ref:i,size:"large",children:m.map(n=>t.jsxs(S,{vertical:!0,gap:4,children:[t.jsx(Q,{id:n.imageId,width:l,className:n.enoughData?void 0:"grayscale"}),t.jsxs(ee,{trigger:"click",title:`Add strong fit/unfit answer to ${e[n.suspectCardId].name.pt}`,content:t.jsxs(S,{vertical:!0,gap:4,children:[t.jsx(F.Text,{type:"secondary",children:n.values.join(", ")}),t.jsxs(R,{icon:"ðŸ‘",block:!0,onClick:()=>p(n.suspectCardId),children:[" ","Add strong fit"]}),t.jsxs(R,{icon:"ðŸ‘Ž",block:!0,onClick:()=>a(n.suspectCardId),children:[" ","Add strong unfit"]}),t.jsxs(z.Compact,{children:[t.jsx(R,{icon:"âŒ",size:"small",block:!0,onClick:()=>u(n.suspectCardId),children:"fit"}),t.jsx(R,{icon:"âŒ",size:"small",block:!0,onClick:()=>g(n.suspectCardId),children:"unfit"})]})]}),children:[t.jsxs("div",{children:[t.jsx(T,{title:n.suspectCardId,children:e[n.suspectCardId].name.pt})," ",n.complete&&t.jsx(T,{title:"Complete: It has 5 or more answers",children:t.jsx(De,{style:{color:"gold"}})})]}),t.jsx(T,{title:`Values: ${n.values.join(", ")} : ${n.resolution?n.resolution:n.projection?`${n.projection}*`:""}`,children:n.enoughData?t.jsx(B,{percent:n.noPercentage+n.yesPercentage,size:[l,20],status:"exception",success:{percent:n.yesPercentage},showInfo:!1}):t.jsx(B,{percent:n.noPercentage+n.yesPercentage,size:[l,10],status:"exception",success:{percent:n.yesPercentage},showInfo:!1})})]})]},n.suspectCardId))})}function We({data:r,questions:e,suspects:o,isLoading:c,isSuccess:l,addEntryToUpdate:i}){const{queryParams:s,addParam:d}=I(),m=j.useMemo(()=>x.orderBy(Object.values(e),g=>Number(g.id.split("-")[1]),"asc"),[e]),p=K({total:m.length,showQuickJumper:!0}),a=[{title:"Id",dataIndex:"id",key:"id",sorter:(g,n)=>Number(g.id.split("-")[1])-Number(n.id.split("-")[1])},{title:"Question",dataIndex:"question",key:"question",sorter:(g,n)=>g.question.localeCompare(n.question)},{title:"NSFW",dataIndex:"nsfw",key:"nsfw",render:g=>g?t.jsx(ge,{style:{color:"hotPink"}}):"",sorter:(g,n)=>Number(g.nsfw)-Number(n.nsfw)},{title:"Answers",dataIndex:"id",key:"answers",render:g=>{const n=r[g];return n?Object.values(n).length:""}}],u=U({maxExpandedRows:1,expandedRowRender:g=>t.jsx(_e,{testimonyId:g.id,answers:r[g.id]??{},suspects:o,addEntryToUpdate:i}),rowExpandable:()=>l});return t.jsxs(S,{gap:12,className:"full-width py-4",vertical:!0,children:[t.jsxs(S,{justify:"space-between",align:"center",children:[t.jsx(F.Title,{level:4,className:"my-0",children:"Suspects by Testimony"}),t.jsx(J,{checked:s.get("sortSuspectsBy")==="answers",onChange:g=>d("sortSuspectsBy",g?"answers":"id"),checkedChildren:"Sort by Answers",unCheckedChildren:"Sort by Id"})]}),t.jsx(G,{columns:a,dataSource:m,pagination:p,rowKey:"id",expandable:u,loading:c,bordered:!0,className:"full-width"})]})}function Ye(r){const{queryParams:e,is:o}=I();return t.jsxs(t.Fragment,{children:[(o("display","questions")||!e.get("display"))&&t.jsx(We,{...r}),o("display","suspects")&&t.jsx(Ve,{...r}),o("display","simulator")&&t.jsx(qe,{})]})}function Je({data:r,hasNewData:e,isDirty:o,save:c,isSaving:l,entriesToUpdate:i}){const{queryParams:s,addParams:d}=I(),m=j.useMemo(()=>{const p={};return Object.values(r).forEach(a=>{Object.keys(a).forEach(u=>{a[u]&&(p[u]||(p[u]=0),a[u].length>=5&&(p[u]+=1))})}),{queriedTestimoniesCount:Object.keys(r).length,suspectsCount:Object.keys(p).length,reliableSuspectsCount:Object.values(p).filter(a=>a>=5).length}},[r]);return t.jsxs(t.Fragment,{children:[t.jsx(D,{children:t.jsxs(S,{vertical:!0,gap:12,children:[t.jsx(xe,{isDirty:o,onSave:c,isSaving:l,dirt:JSON.stringify(i)}),t.jsx(he,{data:()=>Ue(r),fileName:"testimony-answers.json",disabled:o,hasNewData:e,block:!0})]})}),t.jsx(D,{children:t.jsx(fe,{label:"Display",value:s.get("display")??"questions",onChange:p=>d({display:p,page:1},{page:1}),options:[{title:"Questions",icon:t.jsx(we,{}),value:"questions"},{title:"Suspects",icon:t.jsx(Pe,{}),value:"suspects"},{title:"Simulator",icon:t.jsx(Te,{}),value:"simulator"}]})}),t.jsx(D,{children:t.jsxs("div",{style:{fontSize:"0.85em"},children:[t.jsx("strong",{children:"Legend"}),t.jsxs("ul",{children:[t.jsx("li",{children:"Reliability: At least 5 votes"}),t.jsx("li",{children:"Large Bars: There's enough data (at least 3)"}),t.jsx("li",{children:"Small blue bar: in progress negative"})]})]})}),t.jsx(D,{children:t.jsxs("div",{style:{fontSize:"0.85em"},children:[t.jsx("strong",{children:"Counts"}),t.jsxs("ul",{children:[t.jsxs("li",{children:["Testimonies: ",m.queriedTestimoniesCount]}),t.jsxs("li",{children:["Suspects: ",m.suspectsCount]}),t.jsx("li",{children:t.jsxs(T,{title:"A reliable suspect is one that has at least 5 complete testimonies.",children:["Reliable suspects: ",m.reliableSuspectsCount]})})]})]})})]})}function Ue(r){console.log("Preparing file for download...");const e=x.cloneDeep(r);return je(be(e))}function Ke(){const{notification:r}=te.useApp(),e=se(),o=C("suspects"),c=C("testimony-questions-pt"),l=C("testimony-answers"),i=ve("data","testimonies",{select:n=>ye(n,h=>{const f={};return Object.keys(h).forEach(b=>{const y=b.replace(/us-\w{2}-(\d+)/,"us-$1");f[y]=h[b]||[]}),f})}),[s,d]=j.useState({}),m=Se("data","testimonies",{onSuccess:()=>{r.success({message:"data/testimonies updated"}),e.refetchQueries({queryKey:["firestore","data","testimonies"]}),d({})},onError:n=>{r.error({message:"data/testimonies update failed",description:n.message})}}),p=j.useMemo(()=>{if(!l.data||!i.data)return{};const n=x.cloneDeep(l.data);return Object.keys(i.data).forEach(h=>{const f=i.data[h];if(n[h]===void 0){n[h]=f;return}Object.keys(f).forEach(b=>{n[h][b]===void 0?n[h][b]=f[b]:n[h][b].push(...f[b])})}),Object.keys(s).forEach(h=>{const f=s[h];n[h]&&(n[h]=f)}),n},[l.data,i.data,s]),a=!x.isEmpty(s),u=(n,h)=>{d(f=>({...f,[n]:h}))},g=()=>{const n=Object.keys(s).reduce((h,f)=>(h[f]=JSON.stringify(s[f]),h),{});m.mutate(n)};return{isLoading:l.isLoading||i.isLoading||c.isLoading||o.isLoading,isSuccess:l.isSuccess&&i.isSuccess&&c.isSuccess&&o.isSuccess,error:l.error||i.error,data:p,questions:c.data,suspects:o.data,hasNewData:!x.isEmpty(i.data),isSaving:m.isPending,save:g,addEntryToUpdate:u,isDirty:a,entriesToUpdate:s}}function Ht(){const r=Ke();return t.jsx(ne,{title:"Testimonies",subtitle:"Suspect Testimony Rates",children:t.jsxs(_,{hasSider:!0,children:[t.jsx(ie,{children:t.jsx(Je,{...r})}),t.jsx(_.Content,{className:"content",children:t.jsx(oe,{isLoading:r.isLoading,error:r.error,hasResponseData:!x.isEmpty(r.data),children:t.jsx(Ye,{...r})})})]})})}export{Ht as TestimoniesPage,Ht as default};
