import{r as p,a as M,j as t,x as y,P as H,L as T}from"./index-BHrRQ1uq.js";import{D as I}from"./DataLoadingWrapper-DKkg9HZe.js";import{P as A}from"./useBaseUrl--32bgvsR.js";import{u as E}from"./useQueryParams-Cr8fZCN0.js";import{I as N}from"./ImageCard-DDGT4T7O.js";import{u as F}from"./useTableExpandableRows-CUpiWuCD.js";import{u as z}from"./useTablePagination-T_HopZaN.js";import{l as f}from"./lodash-f0m46xYx.js";import{S as L}from"./index-Co7aD7RO.js";import{F as C}from"./Table-CGPLlxUi.js";import{F as Q}from"./index-CjtWJUFP.js";import{P}from"./progress-UvC3QPtr.js";import{T as D}from"./index-Db_5R2-z.js";import{u as $}from"./useCardWidth-DDmlay8a.js";import{R as B}from"./FireFilled-Ai6thRSV.js";import{F as V}from"./FilterEntries-BiZjj4NT.js";import{S as b}from"./SiderContent-Dj_cqrIg.js";import{D as q}from"./DownloadButton-DRTPYwYl.js";import{a as K,d as W,e as J}from"./index-Rk2ZCQ0l.js";import{R as _}from"./TableOutlined-nZjEACr8.js";import{u as G}from"./useGetFirebaseDoc-xE0GJyOY.js";import{u as v}from"./useTDResource-wK2jd69j.js";import"./gapSize-U1swVQyS.js";import"./index-CkYVgnOz.js";import"./index-DL-QmAap.js";import"./index-BESd2kFy.js";import"./index-Cm-andhV.js";import"./scrollTo-CnYqteaX.js";import"./Pagination-DPx5Huu7.js";import"./extendsObject-keMuGWqj.js";import"./Input-cdsOURLH.js";import"./index-BHuPI7uO.js";import"./index-7mXcI-6s.js";import"./constants-B_q3c2xJ.js";import"./Item-DXicAdtS.js";var Y={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M594.3 601.5a111.8 111.8 0 0029.1-75.5c0-61.9-49.9-112-111.4-112s-111.4 50.1-111.4 112c0 29.1 11 55.5 29.1 75.5a158.09 158.09 0 00-74.6 126.1 8 8 0 008 8.4H407c4.2 0 7.6-3.3 7.9-7.5 3.8-50.6 46-90.5 97.2-90.5s93.4 40 97.2 90.5c.3 4.2 3.7 7.5 7.9 7.5H661a8 8 0 008-8.4c-2.8-53.3-32-99.7-74.7-126.1zM512 578c-28.5 0-51.7-23.3-51.7-52s23.2-52 51.7-52 51.7 23.3 51.7 52-23.2 52-51.7 52zm416-354H768v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H548v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H328v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H96c-17.7 0-32 14.3-32 32v576c0 17.7 14.3 32 32 32h832c17.7 0 32-14.3 32-32V256c0-17.7-14.3-32-32-32zm-40 568H136V296h120v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h148v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h148v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h120v496z"}}]},name:"contacts",theme:"outlined"},U={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M868 160h-92v-40c0-4.4-3.6-8-8-8H256c-4.4 0-8 3.6-8 8v40h-92a44 44 0 00-44 44v148c0 81.7 60 149.6 138.2 162C265.6 630.2 359 721.8 476 734.5v105.2H280c-17.7 0-32 14.3-32 32V904c0 4.4 3.6 8 8 8h512c4.4 0 8-3.6 8-8v-32.3c0-17.7-14.3-32-32-32H548V734.5C665 721.8 758.4 630.2 773.8 514 852 501.6 912 433.7 912 352V204a44 44 0 00-44-44zM248 439.6c-37.1-11.9-64-46.7-64-87.6V232h64v207.6zM840 352c0 41-26.9 75.8-64 87.6V232h64v120z"}}]},name:"trophy",theme:"filled"};function O(){return O=Object.assign?Object.assign.bind():function(s){for(var o=1;o<arguments.length;o++){var r=arguments[o];for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&(s[i]=r[i])}return s},O.apply(this,arguments)}const X=(s,o)=>p.createElement(M,O({},s,{ref:o,icon:Y})),Z=p.forwardRef(X);function S(){return S=Object.assign?Object.assign.bind():function(s){for(var o=1;o<arguments.length;o++){var r=arguments[o];for(var i in r)Object.prototype.hasOwnProperty.call(r,i)&&(s[i]=r[i])}return s},S.apply(this,arguments)}const ee=(s,o)=>p.createElement(M,S({},s,{ref:o,icon:U})),te=p.forwardRef(ee);function se({answersPerQuestion:s,questions:o}){const r=p.useMemo(()=>f.orderBy(Object.keys(s).map(d=>{const e=o[d],a=s[d],u=a.length>2,c=a.length,l=Math.max(a.length,5),n=a.filter(x=>x===1).length,m=Math.round(n/l*100),g=a.filter(x=>x===0).length,h=Math.round(g/l*100),j=Math.round((l-n-g)/l*100);return{id:d,question:e,enoughData:u,reliability:c,yesPercentage:m,noPercentage:h,blankPercentage:j}}),["reliability","enoughData","yesPercentage"],["desc","desc","desc"]),[s,o]),i=[{key:"id",title:"Id",dataIndex:"id"},{key:"question",title:"Question",dataIndex:"question",render:d=>d.question},{key:"answer",title:"Answer",dataIndex:"id",sorter:(d,e)=>d.reliability-e.reliability,render:d=>{const e=r.find(a=>a.id===d);return e?t.jsxs(Q,{gap:8,children:[t.jsx(P,{percent:e.noPercentage+e.yesPercentage,size:e.enoughData?[100,20]:[100,10],status:e.enoughData?"exception":"active",success:{percent:e.yesPercentage},showInfo:!1}),e.yesPercentage>=e.noPercentage?t.jsxs(D,{color:"green-inverse",children:[e.yesPercentage,"% Yes"]}):t.jsxs(D,{color:"red-inverse",children:[e.noPercentage,"% No"]})]}):""}}];return t.jsx(L,{wrap:!0,size:"large",children:t.jsx(C,{rowKey:"id",columns:i,dataSource:r,bordered:!0})})}function ne({isLoading:s,isSuccess:o,questions:r,data:i,suspects:d}){const e=p.useMemo(()=>Object.keys(i).reduce((n,m)=>{const g=i[m]??{};return Object.keys(g).forEach(h=>{n[h]||(n[h]={}),n[h][m]=g[h]}),n},{}),[i]),a=p.useMemo(()=>f.orderBy(Object.values(d).map(n=>({...n,answers:e[n.id]})),n=>Number(n.id.split("-")[1]),"asc"),[d,e]),u=z({total:a.length,showQuickJumper:!0}),c=[{title:"Id",dataIndex:"id",key:"id",sorter:(n,m)=>Number(n.id.split("-")[1])-Number(m.id.split("-")[1])},{title:"Picture",dataIndex:"id",render:n=>{const m=n.split("-").join("-gb-");return t.jsx(N,{id:m,width:48})}},{title:"Name",dataIndex:"name",key:"name",sorter:(n,m)=>n.name.pt.localeCompare(m.name.pt),render:n=>n.pt},{title:"Questions Answered",dataIndex:"answers",key:"answers",sorter:(n,m)=>Object.keys(n.answers).length-Object.keys(m.answers).length,render:n=>n?Object.values(n).length:""}],l=F({maxExpandedRows:1,expandedRowRender:n=>t.jsx(se,{suspect:n,answersPerQuestion:e[n.id],questions:r}),rowExpandable:()=>o});return t.jsx(C,{columns:c,dataSource:a,pagination:u,rowKey:"id",expandable:l,loading:s,bordered:!0,className:"full-width"})}function re({answers:s,suspects:o}){const[r,i]=$(12),d=p.useMemo(()=>f.orderBy(Object.keys(s??{}).map(e=>{const u=`us-gb-${e.split("-")[1]}`,c=s[e],l=c.length>2,n=c.length>4,m=Math.max(c.length,5),g=c.filter(w=>w===1).length,h=Math.round(g/m*100),j=c.filter(w=>w===0).length,x=Math.round(j/m*100),R=Math.round((m-g-j)/m*100),k=c.length>=5;return k&&console.log({suspectCardId:e,values:c,yesPercentage:h,noPercentage:x,blankPercentage:R,total:m}),{imageId:u,suspectCardId:e,enoughData:l,reliability:n,yesPercentage:h,noPercentage:x,blankPercentage:R,complete:k,values:c}}),["complete","reliability","enoughData","percentage"],["desc","desc","desc","desc"]),[s]);return t.jsx(L,{wrap:!0,ref:i,size:"large",children:d.map(e=>t.jsxs(Q,{vertical:!0,gap:4,children:[t.jsx(N,{id:e.imageId,width:r,className:e.enoughData?void 0:"grayscale"}),t.jsxs("div",{children:[t.jsx(y,{title:e.suspectCardId,children:o[e.suspectCardId].name.pt})," ",e.complete&&t.jsx(y,{title:"Complete: It has 5 or more answers",children:t.jsx(te,{style:{color:"gold"}})})]}),t.jsx(y,{title:`Values: ${e.values.join(", ")}`,children:e.enoughData?t.jsx(P,{percent:e.noPercentage+e.yesPercentage,size:[r,20],status:"exception",success:{percent:e.yesPercentage},showInfo:!1}):t.jsx(P,{percent:e.noPercentage+e.yesPercentage,size:[r,10],status:"exception",success:{percent:e.yesPercentage},showInfo:!1})})]},e.suspectCardId))})}function ae({data:s,questions:o,suspects:r,isLoading:i,isSuccess:d}){const e=p.useMemo(()=>f.orderBy(Object.values(o),l=>Number(l.id.split("-")[1]),"asc"),[o]),a=z({total:e.length,showQuickJumper:!0}),u=[{title:"Id",dataIndex:"id",key:"id",sorter:(l,n)=>Number(l.id.split("-")[1])-Number(n.id.split("-")[1])},{title:"Question",dataIndex:"question",key:"question",sorter:(l,n)=>l.question.localeCompare(n.question)},{title:"NSFW",dataIndex:"nsfw",key:"nsfw",render:l=>l?t.jsx(B,{style:{color:"hotPink"}}):"",sorter:(l,n)=>Number(l.nsfw)-Number(n.nsfw)},{title:"Answers",dataIndex:"id",key:"answers",render:l=>{const n=s[l];return n?Object.values(n).length:""}}],c=F({maxExpandedRows:1,expandedRowRender:l=>t.jsx(re,{answers:s[l.id]??{},suspects:r}),rowExpandable:()=>d});return t.jsx(C,{columns:u,dataSource:e,pagination:a,rowKey:"id",expandable:c,loading:i,bordered:!0,className:"full-width"})}function oe(s){const{queryParams:o,is:r}=E();return t.jsxs(t.Fragment,{children:[(r("display","questions")||!o.get("display"))&&t.jsx(ae,{...s}),r("display","suspects")&&t.jsx(ne,{...s})]})}function ie({data:s,hasNewData:o}){const{queryParams:r,addParams:i}=E(),d=p.useMemo(()=>{const e={};return Object.values(s).forEach(a=>{Object.keys(a).forEach(u=>{a[u]&&(e[u]||(e[u]=0),a[u].length>=5&&(e[u]+=1))})}),{queriedTestimoniesCount:Object.keys(s).length,suspectsCount:Object.keys(e).length,reliableSuspectsCount:Object.values(e).filter(a=>a>=5).length}},[s]);return t.jsxs(t.Fragment,{children:[t.jsx(b,{children:t.jsx(q,{data:()=>ce(s),fileName:"testimony-answers.json",hasNewData:o,block:!0})}),t.jsx(b,{children:t.jsx(V,{label:"Display",value:r.get("display")??"questions",onChange:e=>i({display:e,page:1},{page:1}),options:[{title:"Questions",icon:t.jsx(_,{}),value:"questions"},{title:"Suspects",icon:t.jsx(Z,{}),value:"suspects"}]})}),t.jsx(b,{children:t.jsxs("div",{style:{fontSize:"0.85em"},children:[t.jsx("strong",{children:"Legend"}),t.jsxs("ul",{children:[t.jsx("li",{children:"Reliability: At least 5 votes"}),t.jsx("li",{children:"Large Bars: There's enough data (at least 3)"}),t.jsx("li",{children:"Small blue bar: in progress negative"})]})]})}),t.jsx(b,{children:t.jsxs("div",{style:{fontSize:"0.85em"},children:[t.jsx("strong",{children:"Counts"}),t.jsxs("ul",{children:[t.jsxs("li",{children:["Testimonies: ",d.queriedTestimoniesCount]}),t.jsxs("li",{children:["Suspects: ",d.suspectsCount]}),t.jsx("li",{children:t.jsxs(y,{title:"A reliable suspect is one that has at least 5 complete testimonies.",children:["Reliable suspects: ",d.reliableSuspectsCount]})})]})]})})]})}function ce(s){return console.log("Preparing file for download..."),K(W(s))}function le(){const s=v("suspects"),o=v("testimony-questions-pt"),r=v("testimony-answers"),i=G("data","testimonies",{select:e=>J(e,a=>{const u={};return Object.keys(a).forEach(c=>{const l=c.replace(/us-\w{2}-(\d+)/,"us-$1");u[l]=a[c]||[]}),u})}),d=p.useMemo(()=>{if(!r.data||!i.data)return{};const e=f.cloneDeep(r.data);return Object.keys(i.data).forEach(a=>{const u=i.data[a];if(e[a]===void 0){e[a]=u;return}Object.keys(u).forEach(c=>{e[a][c]===void 0?e[a][c]=u[c]:(console.log("merging",a,c),e[a][c].push(...u[c]))})}),e},[r.data,i.data]);return{isLoading:r.isLoading||i.isLoading||o.isLoading||s.isLoading,isSuccess:r.isSuccess&&i.isSuccess&&o.isSuccess&&s.isSuccess,error:r.error||i.error,data:d,questions:o.data,suspects:s.data,hasNewData:!f.isEmpty(i.data)}}function Ke(){const s=le();return t.jsx(H,{title:"Testimonies",subtitle:"Suspect Testimony Rates",children:t.jsxs(T,{hasSider:!0,children:[t.jsx(A,{children:t.jsx(ie,{...s})}),t.jsx(T.Content,{className:"content",children:t.jsx(I,{isLoading:s.isLoading,error:s.error,hasResponseData:!f.isEmpty(s.data),children:t.jsx(oe,{...s})})})]})})}export{Ke as TestimoniesPage,Ke as default};
