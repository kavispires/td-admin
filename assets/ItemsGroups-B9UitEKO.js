import{j as e,T as S,r as b,X as G,B as A,D as M,P as $,L as v}from"./index-B-CB-hmC.js";import{D as Q}from"./DataLoadingWrapper-GIYtl44F.js";import{u as W,P as z}from"./useGridPagination-DYe7Ut93.js";import{I as q}from"./Item-D9agdC9N.js";import{u as E}from"./useCopyToClipboardFunction-CgWdZ1Nu.js";import{u as F}from"./useQueryParams-B-K0E8XR.js";import{u as T}from"./useTDResource-VDQIHIMH.js";import{l as y}from"./lodash-Czkt6pVA.js";import{r as C,h as O,b as U,i as J,a as K}from"./index-lGkeVY1X.js";import{T as X}from"./TransparentButton-DmkOepxx.js";import{D as N}from"./EditableFields-D-U0qybk.js";import{u as _}from"./useTableExpandableRows-cfJ8SNMU.js";import{u as V}from"./useTablePagination-4UOUt7oj.js";import{C as H}from"./CopyIdsButton-D0FPIGpQ.js";import{I as Y}from"./InspirationSample-Cy12mMCE.js";import{I as Z}from"./ItemsTypeahead-B-F3oIDH.js";import{I as ee,b as D,d as se}from"./ItemBuildingBlocks-BoIyXScu.js";import{C as te}from"./index-CO_wYkA1.js";import{S as re}from"./index-Dpykzcri.js";import{S as oe}from"./index-06Xp2EXn.js";import{F as P}from"./Table-DtHi6rd_.js";import{F as w}from"./index-BGd500q_.js";import{D as ae}from"./index-BKZfFrQt.js";import{R as ie,C as ne,F as g}from"./index-Bo__JzcK.js";import{F as le,c as me}from"./FilterEntries-CILsmA30.js";import{S as ce}from"./SiderContent-FZX9emIy.js";import{D as de}from"./DownloadButton-BzY0paAD.js";import{S as pe}from"./SaveButton-C_jpPclL.js";import{L as k}from"./LanguageFlag-BkaoqNMu.js";import{M as ue}from"./index-CxhqJQjm.js";import{I as R}from"./index-DCTDI9bN.js";import{R as xe}from"./ClusterOutlined-uzlVLYdU.js";import{R as he}from"./TableOutlined-PxoVfvOv.js";import{P as fe}from"./useBaseUrl-xjSpq_uF.js";import{u as je}from"./useResourceFirebaseData-xaMtIUW_.js";import"./Pagination-Dw_THTpl.js";import"./constants-CICODHNU.js";import"./index-4F-tsTm3.js";import"./FireFilled-CdjnO2WV.js";import"./IdcardOutlined-DiWW65D9.js";import"./PlusOutlined-A95W9OFY.js";import"./PlusOutlined-ByZyTB3m.js";import"./useDebounce-Bt98GF_7.js";import"./index-cPYsJV-S.js";import"./gapSize-U1swVQyS.js";import"./index-kQHTayh-.js";import"./index-BLsm4Xwq.js";import"./index-Dna_Lvgx.js";import"./scrollTo-DTu61Nla.js";import"./extendsObject-keMuGWqj.js";import"./Input-QpefR0Z_.js";import"./moment-C5S46NFB.js";import"./SaveOutlined-C1T5zzwQ.js";import"./useGetFirebaseDoc-CmSt-g-E.js";import"./useUpdateFirebaseDoc-vKfuE25D.js";import"./useMutation-DpWGO1_H.js";const ye=["8bc4f","96efa","c10eb","16ec3","2a97f","4bba8","565ed","5fb57","62a8b"];function L({item:s,itemGroups:t,groupsTypeahead:i,onUpdateItemGroups:m}){const l=E();return e.jsxs(te,{title:e.jsxs(e.Fragment,{children:[e.jsx(S.Text,{onClick:()=>l(s.id),children:s.id}),e.jsx(se,{item:s})]}),style:{maxWidth:250,...ge(t)},children:[e.jsx(ee,{item:s,width:75}),e.jsxs(re,{size:"small",direction:"vertical",className:"my-4",children:[e.jsx(D,{item:s,language:"en"}),e.jsx(D,{item:s,language:"pt"}),e.jsx(oe,{mode:"multiple",style:{width:"100%"},placeholder:"Select a group",defaultValue:t,options:i,filterOption:(c,p)=>!!(p!=null&&p.label.toLowerCase().includes(c.toLowerCase())),size:"small",onChange:c=>m(s.id,c)},String(t))]})]})}const ge=s=>!s||(s==null?void 0:s.length)===0?{borderColor:"orange"}:s!=null&&s.every(t=>ye.includes(t))?{borderColor:"red"}:{};function be({data:s,addEntryToUpdate:t}){const{is:i,queryParams:m}=F(),l=T("items"),c=b.useMemo(()=>Object.values(s??[]).reduce((r,o)=>(o.itemsIds||console.warn("Group without items",o),o.itemsIds.forEach(n=>{r[n]||(r[n]=[]),r[n].push(o.id)}),r),{}),[s]),p=b.useMemo(()=>y.orderBy(Object.values(s).flatMap(({id:r,name:o})=>[{label:`${o.en} [${r}]`,value:r}]),"label"),[s]),f=(r,o)=>{const n=c[r]??[],x=o.filter(a=>!n.includes(a)),I=n.filter(a=>!o.includes(a));x.forEach(a=>{const d=s[a];t(a,{...d,itemsIds:C([...(d==null?void 0:d.itemsIds)??[],r])})}),I.forEach(a=>{const d=s[a];t(a,{...d,itemsIds:C(d==null?void 0:d.itemsIds.filter(h=>h!==r))})})},j=(r,o)=>{const n=s[r];t(r,{...n,itemsIds:C(o)})},u=(r,o,n)=>{const x=s[n];t(n,{...x,name:{...x.name,[o]:r}})};return e.jsxs(e.Fragment,{children:[(i("display","group")||!m.has("display"))&&e.jsx(Ie,{data:s,items:l.data,grousByItem:c,groupsTypeahead:p,onUpdateItemGroups:f,onUpdateGroupItems:j,onUpdateName:u}),i("display","item")&&e.jsx(Ce,{data:s,items:l.data,grousByItem:c,groupsTypeahead:p,onUpdateItemGroups:f,onUpdateGroupItems:j,onUpdateName:u})]})}function Ie({data:s,items:t,grousByItem:i,groupsTypeahead:m,onUpdateItemGroups:l,onUpdateGroupItems:c,onUpdateName:p}){const f=E(),j=T("items"),[u,r]=b.useState(null),o=V({showQuickJumper:!0,total:Object.keys(s).length}),n=[{title:"id",dataIndex:"id",key:"id",render:a=>e.jsx("span",{children:a})},{title:"Name",dataIndex:"name",key:"name",render:(a,d)=>e.jsxs(w,{vertical:!0,gap:4,children:[e.jsx(N,{value:a,language:"en",style:{minWidth:150},onChange:h=>p(h.target.value,"en",d.id)}),e.jsx(N,{value:a,language:"pt",style:{minWidth:150},onChange:h=>p(h.target.value,"pt",d.id)})]})},{title:"Items",dataIndex:"itemsIds",key:"itemsIds",render:(a,d)=>e.jsx(w,{gap:6,wrap:"wrap",children:a.map(h=>e.jsxs(w,{gap:2,vertical:!0,children:[e.jsx(X,{onClick:()=>r(h),children:e.jsx(q,{id:h,width:60})}),e.jsx(w,{justify:"center",children:e.jsx(S.Text,{onClick:()=>f(h),children:h})})]},`${d.id}-${h}`))},`items-${d.id}`)},P.EXPAND_COLUMN,{title:"Count",dataIndex:"itemsIds",key:"count",render:a=>C(a).filter(Boolean).length},{title:"Actions",dataIndex:"itemsIds",key:"actions",render:a=>e.jsx(H,{ids:a})}],x=u?t[u]:null,I=_({maxExpandedRows:1,expandedRowRender:a=>e.jsx(we,{group:a,onUpdateGroupItems:c}),rowExpandable:()=>j.isSuccess});return e.jsxs(e.Fragment,{children:[e.jsx(P,{columns:n,dataSource:Object.values(s),className:"my-4",rowKey:"id",pagination:o,expandable:I}),e.jsx(ae,{title:"Edit Item Group",onClose:()=>r(null),open:!!x,children:x&&e.jsx(L,{item:x,itemGroups:i[x.id],groupsTypeahead:m,onUpdateItemGroups:l})})]})}function we({group:s,onUpdateGroupItems:t}){const i=m=>{t(s.id,[...s.itemsIds,m])};return e.jsxs("div",{children:[e.jsx(Z,{onFinish:i}),e.jsx(Y,{onSelect:i,excludeList:s.itemsIds,initialQuantity:0})]})}function Ce({items:s,grousByItem:t,groupsTypeahead:i,onUpdateItemGroups:m}){const{is:l}=F(),c=l("emptyOnly"),p=b.useMemo(()=>c?Object.values(s).filter(u=>!t[u.id]):Object.values(s),[s,t,c]),{page:f,pagination:j}=W({data:p});return e.jsxs(e.Fragment,{children:[e.jsxs(S.Title,{level:2,children:["Groups by Items (",p.length,")"]}),e.jsx(z,{pagination:j,children:e.jsx(ie,{gutter:[16,16],className:"my-4",children:f.map(u=>e.jsx(ne,{xs:24,sm:24,md:12,lg:6,xl:4,children:e.jsx(L,{item:u,itemGroups:t[u.id],groupsTypeahead:i,onUpdateItemGroups:m})},u.id))})})]})}function Se({addEntryToUpdate:s,data:t}){const[i,m]=b.useState(!1),[l]=g.useForm(),{notification:c}=G.useApp(),p=r=>{const o=U(Object.keys(t));s(o,{id:o,name:{pt:r.nome,en:r.name},itemsIds:[],keywords:r.keywords}),c.success({message:"Group added successfully"}),m(!1),l.resetFields()},f=g.useWatch("name",l),j=g.useWatch("nome",l),u=b.useMemo(()=>{const r={};if(f&&f.length>2){const n=Object.entries(t).reduce((x,[I,a])=>{const d=O.compareTwoStrings(a.name.en,f),h=O.compareTwoStrings(a.name.pt,j);return(d>.2||h>.2)&&(x[I]=Math.max(d,h)),x},{});Object.keys(n).forEach(x=>{r[x]=n[x]})}return Object.keys(r)},[f,j,t]);return e.jsxs(e.Fragment,{children:[e.jsx(A,{type:"dashed",block:!0,onClick:()=>m(!0),className:"mb-4",children:"Add New Group"}),e.jsxs(ue,{title:"Add New Set",open:i,onOk:l.submit,onCancel:()=>m(!1),maskClosable:!1,okText:"Add",okButtonProps:{htmlType:"submit"},children:[e.jsxs(g,{form:l,onFinish:p,children:[e.jsx(g.Item,{name:"nome",label:"Nome",rules:[{required:!0}],children:e.jsx(R,{prefix:e.jsx(k,{language:"pt",width:"1em"}),placeholder:"Name in pt",size:"small"})}),e.jsx(g.Item,{name:"name",label:"Name",rules:[{required:!0}],children:e.jsx(R,{prefix:e.jsx(k,{language:"en",width:"1em"}),placeholder:"Name in en",size:"small"})})]}),e.jsx(S.Text,{children:"Similar:"}),e.jsx("ul",{children:u.map(r=>{var o,n;return e.jsxs("li",{children:[r," - ",(o=t[r])==null?void 0:o.name.en," / ",(n=t[r])==null?void 0:n.name.pt]},r)})})]})]})}function Te({data:s,save:t,isDirty:i,isSaving:m,entriesToUpdate:l,addEntryToUpdate:c,hasFirestoreData:p}){const{queryParams:f,addParam:j,addParams:u,is:r}=F(),o=T("items");return e.jsxs(ce,{children:[e.jsxs(w,{vertical:!0,gap:12,children:[e.jsx(pe,{isDirty:i,onSave:t,isSaving:m,dirt:JSON.stringify(B(l))}),e.jsx(de,{data:()=>Fe(s,o.data),fileName:"items-groups.json",disabled:i||y.isEmpty(o.data),hasNewData:p,block:!0})]}),e.jsx(M,{}),e.jsx(Se,{data:s,addEntryToUpdate:c}),e.jsx(le,{label:"Display",value:f.get("display")??"group",onChange:n=>u({display:n,page:1},{page:1}),options:[{title:"By Groups",icon:e.jsx(xe,{}),value:"group"},{title:"By Items",icon:e.jsx(he,{}),value:"item"}]}),r("display","item")&&e.jsx(me,{label:"No Groups Only",value:r("emptyOnly"),onChange:n=>j("emptyOnly",n,!1)})]})}function B(s){return y.omitBy(y.cloneDeep(s),t=>y.isEmpty(t.itemsIds))}function Fe(s,t){return Object.keys(s).forEach(i=>{s[i].itemsIds=J(C(s[i].itemsIds));const m=s[i].itemsIds.length,l=s[i].itemsIds.filter(c=>t[c].nsfw).length;l>m*.3&&(s[i].nsfw=!0,console.log(`ðŸ˜ˆ Group ${s[i].name.pt} has ${l} (${Math.round(l/m*100)}%) NSFW items`))}),K(B(s))}function Ns(){const s=je({tdrResourceName:"items-groups",firebaseDataCollectionName:"itemsGroups",serialize:!0}),t=T("items");return e.jsx($,{title:"Items",subtitle:"Groups Sets",children:e.jsxs(v,{hasSider:!0,children:[e.jsx(fe,{children:e.jsx(Te,{...s})}),e.jsx(v.Content,{className:"content",children:e.jsx(Q,{isLoading:s.isLoading||t.isLoading,error:s.error||t.error,hasResponseData:!y.isEmpty(s.data)&&!y.isEmpty(t.data),children:e.jsx(be,{...s})})})]})})}export{Ns as ItemsGroups,Ns as default};
