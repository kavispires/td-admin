import{r as w,a as L,_ as q,j as t,T as M,B as A,aj as te,af as se,y as F,Y as ne,X as oe,P as re,L as W}from"./index-DKldGYC9.js";import{D as ie}from"./DataLoadingWrapper-LoQ1HTAc.js";import{l as b,c as ae,P as ce}from"./useBaseUrl-CzvQiwMK.js";import{u as T}from"./useQueryParams-BmcEa7HG.js";import{R as le}from"./main-DEedGuyQ.js";import{u as ue,D as de,a as me,g as he}from"./constants-BZXkykWi.js";import{u as R}from"./useTDResource-DZouQedq.js";import{I as Q}from"./ImageCard-NSdofaP6.js";import{g as K}from"./utils-wPPXcPLE.js";import{F as E}from"./index-BCTNeYxA.js";import{B as U,D as pe}from"./DownloadButton-BZ-e2rgf.js";import{S as $}from"./index-BZDnQ0XM.js";import{u as X}from"./useTableExpandableRows-65kZKXJo.js";import{u as Z}from"./useTablePagination-BcrkeNXP.js";import{P as J}from"./progress-DtSw9983.js";import{S as G}from"./index-BhPX-fbT.js";import{F as V}from"./Table-CWH02Oy6.js";import{u as ge}from"./useCardWidth-KBGXSvfD.js";import{R as fe}from"./FireFilled-CCZISRwv.js";import{F as xe}from"./FilterEntries-DIaYCgoN.js";import{S as B}from"./SiderContent-CWBPdBJr.js";import{S as ye}from"./SaveButton-BjTzOZtG.js";import{a as je,d as be,e as we}from"./index-CS8tCY7i.js";import{R as ve}from"./TableOutlined-DVzBZqsw.js";import{u as Se}from"./useGetFirestoreDoc-C17LBNOx.js";import{u as ke}from"./useUpdateFirestoreDoc-Du_MLqGh.js";import"./moment-C5S46NFB.js";import"./gapSize-U1swVQyS.js";import"./index-DMoY3GTb.js";import"./index-D0d9pyAM.js";import"./index-CnctZy45.js";import"./index-yNfdQCVO.js";import"./scrollTo-P-eDCUzO.js";import"./Pagination-DXNSwMpe.js";import"./extendsObject-keMuGWqj.js";import"./Input-D9WiqoRz.js";import"./index-CmcbUsyL.js";import"./SaveOutlined-DODUybLq.js";import"./constants-DMr5cfhV.js";import"./Item-B05TLgZt.js";import"./useMutation-C2U8foqc.js";var Ee={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M594.3 601.5a111.8 111.8 0 0029.1-75.5c0-61.9-49.9-112-111.4-112s-111.4 50.1-111.4 112c0 29.1 11 55.5 29.1 75.5a158.09 158.09 0 00-74.6 126.1 8 8 0 008 8.4H407c4.2 0 7.6-3.3 7.9-7.5 3.8-50.6 46-90.5 97.2-90.5s93.4 40 97.2 90.5c.3 4.2 3.7 7.5 7.9 7.5H661a8 8 0 008-8.4c-2.8-53.3-32-99.7-74.7-126.1zM512 578c-28.5 0-51.7-23.3-51.7-52s23.2-52 51.7-52 51.7 23.3 51.7 52-23.2 52-51.7 52zm416-354H768v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H548v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H328v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H96c-17.7 0-32 14.3-32 32v576c0 17.7 14.3 32 32 32h832c17.7 0 32-14.3 32-32V256c0-17.7-14.3-32-32-32zm-40 568H136V296h120v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h148v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h148v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h120v496z"}}]},name:"contacts",theme:"outlined"},Oe={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M300 328a60 60 0 10120 0 60 60 0 10-120 0zM852 64H172c-17.7 0-32 14.3-32 32v660c0 17.7 14.3 32 32 32h680c17.7 0 32-14.3 32-32V96c0-17.7-14.3-32-32-32zm-32 660H204V128h616v596zM604 328a60 60 0 10120 0 60 60 0 10-120 0zm250.2 556H169.8c-16.5 0-29.8 14.3-29.8 32v36c0 4.4 3.3 8 7.4 8h729.1c4.1 0 7.4-3.6 7.4-8v-36c.1-17.7-13.2-32-29.7-32zM664 508H360c-4.4 0-8 3.6-8 8v60c0 4.4 3.6 8 8 8h304c4.4 0 8-3.6 8-8v-60c0-4.4-3.6-8-8-8z"}}]},name:"robot",theme:"outlined"},Ce={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M868 160h-92v-40c0-4.4-3.6-8-8-8H256c-4.4 0-8 3.6-8 8v40h-92a44 44 0 00-44 44v148c0 81.7 60 149.6 138.2 162C265.6 630.2 359 721.8 476 734.5v105.2H280c-17.7 0-32 14.3-32 32V904c0 4.4 3.6 8 8 8h512c4.4 0 8-3.6 8-8v-32.3c0-17.7-14.3-32-32-32H548V734.5C665 721.8 758.4 630.2 773.8 514 852 501.6 912 433.7 912 352V204a44 44 0 00-44-44zM248 439.6c-37.1-11.9-64-46.7-64-87.6V232h64v207.6zM840 352c0 41-26.9 75.8-64 87.6V232h64v120z"}}]},name:"trophy",theme:"filled"},Pe=function(e,n){return w.createElement(L,q({},e,{ref:n,icon:Ee}))},Re=w.forwardRef(Pe),Ne=function(e,n){return w.createElement(L,q({},e,{ref:n,icon:Oe}))},Te=w.forwardRef(Ne),De=function(e,n){return w.createElement(L,q({},e,{ref:n,icon:Ce}))},Y=w.forwardRef(De);const _=(s,e,n)=>{const{reliabilityThreshold:l=4,projectionThreshold:a=55}={},o=`us-gb-${s.split("-")[1]}`,d=b.isEmpty(e[s])?[]:e[s];let p=0,r=0;d.forEach(O=>{O===3&&(p+=3),O===-3&&(r+=3)});const c=d.filter(O=>O!==3&&O!==-3),g=c.length+p+r,h=Math.max(g,5),m=d.filter(O=>O===1).length+p,f=Math.round(m/h*100),x=d.filter(O=>O===0).length+r,y=Math.round(x/h*100),v=Math.round((h-m-x)/h*100),k=c.length+p+r>=5,C=g>3,S=g>l,P=S?f>y?"👍":"👎":null,N=C?f>=a?"👍":y>=a?"👎":null:null;return{suspectCardId:s,imageId:o,enoughData:C,reliable:S,total:h,yesCount:m,yesPercentage:f,noCount:x,noPercentage:y,blankPercentage:v,complete:k,values:d,resolution:P,projection:N}},H=9,Ae=(s,e,n,l)=>{const[a]=ue(de.ESPIONAGEM,l),u=R("suspects",s),o=R(`testimony-questions-${e}`,s),d=R("testimony-answers",s),p=R("crime-reasons",s),r=w.useMemo(()=>Be(d.data),[d.data]),c=w.useMemo(()=>Ie(u.data),[u.data]);return{entries:w.useMemo(()=>!a||!u.isSuccess||!o.isSuccess||!d.isSuccess||!p.isSuccess?{}:Fe(n,a,u.data,o.data,r,c,p.data),[s,a,u,o,d,n,r,c,p]),isLoading:u.isLoading||o.isLoading||d.isLoading}},Fe=(s,e,n,l,a,u,o)=>{console.count("Creating Espionagem...");let d=e.latestDate;const p=[],r={};for(let c=0;c<s;c++){const g=me(d);d=g;let h=null,i=0;for(;!h&&i<100;){i++;const m=Me(n,l,a,u,p,o);if(Le(m.statements)){h=m,console.log(`Generated valid game for ${g} after ${i} attempts`);break}}if(!h)throw new Error(`Failed to generate valid game for ${g} after 100 attempts`);p.push(h.culpritId),r[g]={id:g,type:"espionagem",number:e.latestNumber+c+1,...h}}return r};function Me(s,e,n,l,a,u){let o=[];const d=[],p={},r=b.sample(Object.keys(n));if(!r)throw new Error("No selected testimony ID found");const c=Object.keys(n[r]).filter(S=>!a.includes(S)),g=c.length>0?c:Object.keys(n[r]),h=b.sample(g);if(!h)throw new Error("No selected culprit ID found");const i=b.sampleSize(Object.keys(n[r]).filter(S=>S!==h),H-1);for(o.push(...i);o.length<8;){const S=b.sampleSize(Object.keys(s).filter(P=>!o.includes(P)&&P!==h),H-o.length-1);o.push(...S)}const m={};Object.keys(l).forEach(S=>{if(l[S][h]===void 0){const P=Object.keys(l[S]).filter(N=>o.includes(N));if(P.length>0){const N={};P.forEach(O=>{o.includes(O)&&(N[O]=!0)}),m[S]=N}}});const f=e[r];d.push($e(h,o,f,n[r])),D(p,d[0].excludes);const j=z(h,o,m);d.push(j),D(p,j.excludes),o=b.shuffle([...o,h]);const x=z(h,o,m,[j],"worst");d.push(x),D(p,x.excludes);const y=z(h,o,m,[j,x],"worst");d.push(y),D(p,y.excludes);const v=ze(h,o,d);d.push(v),D(p,v.excludes);const k=[d[0],d[1],d[2],d[4],d[3]],C=qe(s[h],u);return{isNsfw:f.nsfw??!1,culpritId:h,statements:k,suspects:o.map(S=>s[S]),reason:C.title,setId:`${h}::${C.id}::${k[0].key}`,level:Qe(k)}}const Be=s=>{const e={};console.log("⚙️ Calculating suspect answers...");for(const n of Object.keys(s)){const l=s[n];for(const a of Object.keys(l)){const{resolution:u,projection:o}=_(a,l);if(!u&&!o){console.log("⁉️ Ignoring testimony with no resolution or projection");continue}if(e[n]===void 0&&(e[n]={}),u){e[n][a]=u==="👍";continue}if(o){e[n][a]=o==="👍";continue}console.log("⁉️ Ignoring testimony with not enough values")}}return Object.keys(e).forEach(n=>{b.isEmpty(e[n])&&delete e[n]}),Object.keys(e).forEach(n=>{Object.keys(e[n]).length<3&&(console.log("⁉️ Removing testimonies with less than 3 answers"),delete e[n])}),Object.keys(e).forEach(n=>{b.uniq(Object.values(e[n])).length===1&&(console.log("⁉️ Removing testimonies with the same answer"),delete e[n])}),e},Ie=s=>{const e={};for(const l of Object.keys(s)){const{gender:a,ethnicity:u,age:o,build:d,height:p,features:r}=s[l];if(!d){console.log("⁉️ Ignoring suspect with missing build",l);continue}if(!p){console.log("⁉️ Ignoring suspect with missing height",l);continue}if(!r||r.length===0){console.log("⁉️ Ignoring suspect with missing features",l);continue}e[a]===void 0&&(e[a]={}),e[a][l]=!0,e[u]===void 0&&(e[u]={}),e[u][l]=!0,e[o]===void 0&&(e[o]={}),e[o][l]=!0,e[d]===void 0&&(e[d]={}),e[d][l]=!0,e[p]===void 0&&(e[p]={}),e[p][l]=!0,r.forEach(c=>{e[c]===void 0&&(e[c]={}),e[c][l]=!0})}return e.young=b.cloneDeep(e["18-21"]),e.adult=b.cloneDeep({...e["21-30"],...e["30-40"],...e["40-50"]}),e.senior=b.cloneDeep({...e["50-60"],...e["60-70"],...e["70-80"],...e["80-90"]}),["18-21","21-30","30-40","40-50","50-60","60-70","70-80","80-90","average","medium","mixed","adult","tall"].forEach(l=>{delete e[l]}),e},D=(s,e)=>{e.forEach(n=>{s[n]===void 0&&(s[n]=0),s[n]++})},$e=(s,e,n,l)=>{const a=l[s],u=e.filter(p=>l[p]!==void 0&&l[p]!==a),o=n.answer.charAt(0).toLowerCase()+n.answer.slice(1),d={key:`testimony.${n.id}`,text:`O(a) suspeito(a) ${a?"":"não "}${o}`,excludes:u};return d.text.includes("não já")&&(d.text=d.text.replace("não já","nunca")),d},I={row1:{indexes:[0,1,2],text:"na primeira linha"},row2:{indexes:[3,4,5],text:"na segunda linha"},row3:{indexes:[6,7,8],text:"na terceira linha"},column1:{indexes:[0,3,6],text:"na primeira coluna"},column2:{indexes:[1,4,7],text:"na segunda coluna"},column3:{indexes:[2,5,8],text:"na terceira coluna"},corners:{indexes:[0,2,6,8],text:"nos cantos"}},ze=(s,e,n)=>{const l=e.indexOf(s),a=n.slice(0,3),u={};for(const g of Object.keys(I)){const{indexes:h}=I[g];h.includes(l)||(u[g]=h.reduce((i,m)=>{const f=e[m],j=a.filter(x=>x.excludes.includes(f)).length;return j>0?i+j:i},0))}const o=Object.entries(u).reduce((g,[h,i])=>(g[i]||(g[i]=[]),g[i].push(h),g),{}),d=Math.min(...Object.keys(u).map(g=>u[g])),p=o[d.toString()],r=b.sample(p)||Object.keys(u)[0],c=I[r].indexes.map(g=>e[g]);return{key:`not.grid.${r}`,text:`O(a) suspeito(a) não está ${I[r].text}`,excludes:c}},z=(s,e,n,l=[],a="best")=>{const u=b.difference(e,[s]),o=l.filter(m=>m.key.startsWith("not.feature.")).map(m=>m.key.replace("not.feature.","")),d=new Set(l.flatMap(m=>m.excludes)),p=Object.keys(n).filter(m=>Object.keys(n[m]).length<=6&&!o.includes(m)).sort((m,f)=>Object.keys(n[f]).length-Object.keys(n[m]).length);let r,c=[],g=0;const h=50;for(;g<h;){g++;const m=a==="best"?p[0]:b.sample(p.slice(2,5))??p[2];if(!m)break;const f=u.filter(x=>n[m][x]);if(f.some(x=>!d.has(x))||g===h){r=m,c=f;break}p.splice(p.indexOf(m),1)}if(!r)throw Error(`No suitable feature found for ${a} selection after ${h} attempts`);const i=He[r];return i||console.warn(`Feature ${r} not found in translations`),{key:`not.feature.${r}`,text:`O(a) suspeito(a) não ${i||r}`,excludes:c}},He={male:"é homem",female:"é mulher",black:"é negro(a)",white:"é branco(a)",asian:"é asiático(a)",latino:"é latino(a)",thin:"é magrelo(a)",fat:"é gordo(a)",large:"é gordo(a)",tall:"é alto(a)",short:"é baixinho(a)",young:"é jovem",adult:"é adulto(a)",senior:"é idoso(a)",average:"é médio(a)",medium:"é médio(a)",mixed:"é mestiço(a)",hat:"está usando um chapéu",tie:"está usando uma gravata",glasses:"está usando óculos",brownHair:"tem cabelo castanho",shortHair:"tem cabelo curto",beard:"tem barba",caucasian:"é caucasiano(a)",scarf:"está usando um cachecol",blondeHair:"tem cabelo loiro",longHair:"tem cabelo longo",greyHair:"tem cabelo grisalho",bald:"é careca",mustache:"tem bigode",goatee:"tem cavanhaque",muscular:"é musculoso(a)",blackHair:"tem cabelo preto",hoodie:"está usando um moletom",earrings:"está usando brincos",lipstick:"está usando batom",necklace:"está usando um colar",mediumHair:"tem cabelo médio","middle-eastern":"é do Oriente Médio",headscarf:"está usando um lenço na cabeça",redHair:"tem cabelo ruivo",piercings:"tem piercings",coloredHair:"tem cabelo colorido",indian:"é indiano(a)","native-american":"é nativo-americano(a)"},Le=s=>{const e=s.slice(0,3);return e.reduce((a,u)=>a+u.excludes.length,0)<10?!1:new Set(e.flatMap(a=>a.excludes)).size===H-1},qe=(s,e)=>{const n=[];Object.values(e).forEach(a=>{var u;a.feature==="general"&&n.push(a),(u=s.features)!=null&&u.includes(a.feature)&&n.push(a)});const l=b.sample(n);return l||{id:"unknown",title:{pt:"Motivo desconhecido",en:"Unknown reason"},feature:"general"}},Qe=s=>{const e=s.slice(0,3),n=[],l={1:4,2:3,3:3,4:2,5:2,6:1,7:0,8:0};e.forEach(u=>{const o=u.excludes.length;l[o]!==void 0&&n.push(l[o])});const a=Math.round(n.reduce((u,o)=>u+o,0)/n.length);return Math.min(Math.max(a,1),3)};function Ge(){const[s,e]=w.useState({}),{entries:n}=Ae(!0,"pt",1,s);return t.jsxs(E,{vertical:!0,gap:12,className:"p-4",children:[t.jsxs(E,{justify:"space-between",align:"center",children:[t.jsx(M.Title,{level:4,className:"my-0",children:"Espionagem Simulator"}),t.jsx(A,{type:"primary",onClick:()=>e({}),children:"Re-run Simulation"})]}),t.jsx(Ve,{entries:n})]})}function Ve({entries:s}){const[e,n]=w.useState(!1),l=he(),a=s[l],u=w.useMemo(()=>a?a.statements.slice(0,3).reduce((o,d)=>{const{excludes:p}=d;return p.forEach(r=>{o[r]?o[r]++:o[r]=1}),o},{}):{},[a]);return t.jsxs("div",{className:"full-width grid grid-2",children:[t.jsx(le,{src:s??{},theme:"twilight",collapsed:3}),a&&t.jsxs(E,{gap:18,className:"p-4",children:[t.jsx("div",{children:t.jsx("div",{style:{width:`${105*3}px`,display:"grid",gap:"6px",gridTemplateColumns:"repeat(3, 1fr)"},children:a.suspects.map(o=>t.jsxs(U.Ribbon,{text:e?u[o.id]:null,color:"cyan",children:[t.jsx(Q,{id:K(o.id,"gb"),width:96,className:ae(e&&o.id===a.culpritId&&"red-border")},o.id),t.jsxs(E,{gap:6,align:"center",children:[t.jsx($,{checkedChildren:"🚫",size:"small"})," ",o.id]})]},o.id))})}),t.jsxs("div",{children:[t.jsx("div",{children:t.jsx($,{checkedChildren:"Show Culprit",unCheckedChildren:"Hide Culprit",checked:e,onChange:n})}),a.statements.map((o,d)=>t.jsx(M.Paragraph,{children:t.jsx(U,{count:o.excludes.length,color:"cyan",children:t.jsx(te,{message:o.text,banner:!0,type:d<3?"info":"error"},o.key)})},o.key))]})]})]})}function ee({suspect:s,values:e,resolution:n,projection:l,yesPercentage:a,noPercentage:u,complete:o,enoughData:d,testimonyId:p,addEntryToUpdate:r,answers:c,barWidth:g,showName:h}){const i=x=>{const y={...c};y[x]=[...y[x]||[],3],r(p,y)},m=x=>{const y={...c};y[x]=[...y[x]||[],-3],r(p,y)},f=x=>{var k;const y={...c},v=(k=y[x])==null?void 0:k.findIndex(C=>C===3);v!==-1&&v!==void 0&&(y[x]=[...y[x].slice(0,v),...y[x].slice(v+1)]),r(p,y)},j=x=>{var k;const y={...c},v=(k=y[x])==null?void 0:k.findIndex(C=>C===-3);v!==-1&&v!==void 0&&(y[x]=[...y[x].slice(0,v),...y[x].slice(v+1)]),r(p,y)};return t.jsxs(se,{trigger:"click",title:`Add strong fit/unfit answer to ${s.name.pt}`,content:t.jsxs(E,{vertical:!0,gap:4,children:[t.jsx(M.Text,{type:"secondary",children:e.join(", ")}),t.jsxs(A,{icon:"👍",block:!0,onClick:()=>i(s.id),children:[" ","Add strong fit"]}),t.jsxs(A,{icon:"👎",block:!0,onClick:()=>m(s.id),children:[" ","Add strong unfit"]}),t.jsxs(G.Compact,{children:[t.jsx(A,{icon:"❌",size:"small",block:!0,onClick:()=>f(s.id),children:"fit"}),t.jsx(A,{icon:"❌",size:"small",block:!0,onClick:()=>j(s.id),children:"unfit"})]})]}),children:[h&&t.jsxs("div",{children:[t.jsx(F,{title:s.id,children:s.name.pt})," ",o&&t.jsx(F,{title:"Complete: It has 5 or more answers",children:t.jsx(Y,{style:{color:"gold"}})})]}),t.jsxs(E,{align:"flex-start",gap:12,children:[t.jsx(F,{title:`Values: ${e.join(", ")} : ${n||(l?`${l}*`:"")}`,children:d?t.jsx(J,{percent:u+a,size:[g,20],status:"exception",success:{percent:a},showInfo:!1}):t.jsx(J,{percent:u+a,size:[g,10],status:"exception",success:{percent:a},showInfo:!1})}),!h&&o&&t.jsx(F,{title:"Complete: It has 5 or more answers",children:t.jsx(Y,{style:{color:"gold"}})})]})]})}function _e({suspect:s,answersPerQuestion:e,questions:n,addEntryToUpdate:l,allAnswers:a}){const{queryParams:u}=T({sortSuspectsBy:"answers"}),o=u.get("sortSuspectsBy")??"answers";console.log(e),console.log(a);const d=w.useMemo(()=>{const r=Object.values(n).map(c=>{const g=e[c.id]??{},{enoughData:h,reliable:i,yesPercentage:m,noPercentage:f,blankPercentage:j,values:x,total:y,resolution:v,projection:k,complete:C}=_(s.id,{[s.id]:g});return{id:c.id,question:c,enoughData:h,reliable:i,yesPercentage:m,noPercentage:f,blankPercentage:j,values:x,total:y,resolution:v,projection:k,complete:C}});return o==="answers"?b.orderBy(r,["reliable","enoughData","yesPercentage",c=>c.values.length],["desc","desc","desc","desc"]):b.orderBy(r,c=>Number(c.id.split("-")[1]),["asc"])},[e,n,s.id,o]),p=[{key:"id",title:"Id",dataIndex:"id"},{key:"question",title:"Question",dataIndex:"question",render:r=>r.question},{key:"answer",title:"Answer",dataIndex:"id",sorter:(r,c)=>r.total-c.total,render:r=>{const c=d.find(g=>g.id===r);return c?t.jsx(E,{gap:8,wrap:"nowrap",children:t.jsx(ee,{values:c.values,resolution:c.resolution,projection:c.projection,yesPercentage:c.yesPercentage,noPercentage:c.noPercentage,complete:c.complete,enoughData:c.enoughData,suspect:s,testimonyId:c.question.id,answers:a[c.question.id]||{},addEntryToUpdate:l,barWidth:120})}):""}}];return t.jsx(G,{wrap:!0,size:"large",children:t.jsx(V,{rowKey:"id",columns:p,dataSource:d,bordered:!0})})}function We({isLoading:s,isSuccess:e,questions:n,data:l,suspects:a,addEntryToUpdate:u}){const{queryParams:o,addParam:d}=T(),p=w.useMemo(()=>Object.keys(l).reduce((i,m)=>{const f=l[m]??{};return Object.keys(f).forEach(j=>{i[j]||(i[j]={}),i[j][m]=f[j]}),i},{}),[l]),r=w.useMemo(()=>b.orderBy(Object.values(a).map(i=>({...i,answers:p[i.id]})),i=>Number(i.id.split("-")[1]),"asc"),[a,p]),c=Z({total:r.length,showQuickJumper:!0}),g=[{title:"Id",dataIndex:"id",key:"id",sorter:(i,m)=>Number(i.id.split("-")[1])-Number(m.id.split("-")[1])},{title:"Picture",dataIndex:"id",render:i=>t.jsx(Q,{id:K(i,"gb"),width:48})},{title:"Name",dataIndex:"name",key:"name",sorter:(i,m)=>i.name.pt.localeCompare(m.name.pt),render:i=>i.pt},{title:"Questions Answered",dataIndex:"answers",key:"answers",sorter:(i,m)=>Object.keys(i.answers??{}).length-Object.keys(m.answers??{}).length,render:i=>i?Object.values(i).length:""}],h=X({maxExpandedRows:1,expandedRowRender:i=>t.jsx(_e,{suspect:i,answersPerQuestion:p[i.id],questions:n,addEntryToUpdate:u,allAnswers:l}),rowExpandable:()=>e});return t.jsxs(E,{gap:12,className:"full-width py-4",vertical:!0,children:[t.jsxs(E,{justify:"space-between",align:"center",children:[t.jsx(M.Title,{level:4,className:"my-0",children:"Testimonies by Suspect"}),t.jsx($,{checked:o.get("sortSuspectsBy")==="answers",onChange:i=>d("sortSuspectsBy",i?"answers":"id"),checkedChildren:"Sort by Answers",unCheckedChildren:"Sort by Id"})]}),t.jsx(V,{columns:g,dataSource:r,pagination:c,rowKey:"id",expandable:h,loading:s,bordered:!0,className:"full-width"})]})}function Ue({answers:s,suspects:e,addEntryToUpdate:n,testimonyId:l}){const[a,u]=ge(12),{queryParams:o}=T({sortSuspectsBy:"answers"}),d=o.get("sortSuspectsBy")??"answers",p=w.useMemo(()=>{const r=Object.keys(e).map(c=>_(c,s));return d==="answers"?b.orderBy(r,["reliable","enoughData",c=>c.values.length,"yesPercentage"],["desc","desc","desc","desc"]):b.orderBy(r,c=>Number(c.suspectCardId.split("-")[1]),["asc"])},[s,e,d]);return t.jsx(G,{wrap:!0,ref:u,size:"large",children:p.map(r=>t.jsxs(E,{vertical:!0,gap:4,children:[t.jsx(Q,{id:r.imageId,width:a,className:r.values.length>1?void 0:"grayscale"}),t.jsx(ee,{values:r.values,resolution:r.resolution,projection:r.projection,yesPercentage:r.yesPercentage,noPercentage:r.noPercentage,complete:r.complete,enoughData:r.enoughData,suspect:e[r.suspectCardId],testimonyId:l,answers:s,addEntryToUpdate:n,barWidth:a,showName:!0})]},r.suspectCardId))})}function Je({data:s,questions:e,suspects:n,isLoading:l,isSuccess:a,addEntryToUpdate:u}){const{queryParams:o,addParam:d}=T(),p=w.useMemo(()=>b.orderBy(Object.values(e),h=>Number(h.id.split("-")[1]),"asc"),[e]),r=Z({total:p.length,showQuickJumper:!0}),c=[{title:"Id",dataIndex:"id",key:"id",sorter:(h,i)=>Number(h.id.split("-")[1])-Number(i.id.split("-")[1])},{title:"Question",dataIndex:"question",key:"question",sorter:(h,i)=>h.question.localeCompare(i.question)},{title:"NSFW",dataIndex:"nsfw",key:"nsfw",render:h=>h?t.jsx(fe,{style:{color:"hotPink"}}):"",sorter:(h,i)=>Number(h.nsfw)-Number(i.nsfw)},{title:"Answers",dataIndex:"id",key:"answers",render:h=>{const i=s[h];return i?Object.values(i).length:""}}],g=X({maxExpandedRows:1,expandedRowRender:h=>t.jsx(Ue,{testimonyId:h.id,answers:s[h.id]??{},suspects:n,addEntryToUpdate:u}),rowExpandable:()=>a});return t.jsxs(E,{gap:12,className:"full-width py-4",vertical:!0,children:[t.jsxs(E,{justify:"space-between",align:"center",children:[t.jsx(M.Title,{level:4,className:"my-0",children:"Suspects by Testimony"}),t.jsx($,{checked:o.get("sortSuspectsBy")==="answers",onChange:h=>d("sortSuspectsBy",h?"answers":"id"),checkedChildren:"Sort by Answers",unCheckedChildren:"Sort by Id"})]}),t.jsx(V,{columns:c,dataSource:p,pagination:r,rowKey:"id",expandable:g,loading:l,bordered:!0,className:"full-width"})]})}function Ye(s){const{queryParams:e,is:n}=T();return t.jsxs(t.Fragment,{children:[(n("display","questions")||!e.get("display"))&&t.jsx(Je,{...s}),n("display","suspects")&&t.jsx(We,{...s}),n("display","simulator")&&t.jsx(Ge,{})]})}function Ke({data:s,hasNewData:e,isDirty:n,save:l,isSaving:a,entriesToUpdate:u}){const{queryParams:o,addParams:d}=T(),p=w.useMemo(()=>{const r={};return Object.values(s).forEach(c=>{Object.keys(c).forEach(g=>{c[g]&&(r[g]||(r[g]=0),c[g].length>=5&&(r[g]+=1))})}),{queriedTestimoniesCount:Object.keys(s).length,suspectsCount:Object.keys(r).length,reliableSuspectsCount:Object.values(r).filter(c=>c>=5).length}},[s]);return t.jsxs(t.Fragment,{children:[t.jsx(B,{children:t.jsxs(E,{vertical:!0,gap:12,children:[t.jsx(ye,{isDirty:n,onSave:l,isSaving:a,dirt:JSON.stringify(u)}),t.jsx(pe,{data:()=>Xe(s),fileName:"testimony-answers.json",disabled:n,hasNewData:e,block:!0})]})}),t.jsx(B,{children:t.jsx(xe,{label:"Display",value:o.get("display")??"questions",onChange:r=>d({display:r,page:1},{page:1}),options:[{title:"Questions",icon:t.jsx(ve,{}),value:"questions"},{title:"Suspects",icon:t.jsx(Re,{}),value:"suspects"},{title:"Simulator",icon:t.jsx(Te,{}),value:"simulator"}]})}),t.jsx(B,{children:t.jsxs("div",{style:{fontSize:"0.85em"},children:[t.jsx("strong",{children:"Legend"}),t.jsxs("ul",{children:[t.jsx("li",{children:"Reliability: At least 5 votes"}),t.jsx("li",{children:"Large Bars: There's enough data (at least 3)"}),t.jsx("li",{children:"Small blue bar: in progress negative"})]})]})}),t.jsx(B,{children:t.jsxs("div",{style:{fontSize:"0.85em"},children:[t.jsx("strong",{children:"Counts"}),t.jsxs("ul",{children:[t.jsxs("li",{children:["Testimonies: ",p.queriedTestimoniesCount]}),t.jsxs("li",{children:["Suspects: ",p.suspectsCount]}),t.jsx("li",{children:t.jsxs(F,{title:"A reliable suspect is one that has at least 5 complete testimonies.",children:["Reliable suspects: ",p.reliableSuspectsCount]})})]})]})})]})}function Xe(s){console.log("Preparing file for download...");const e=b.cloneDeep(s);return je(be(e))}function Ze(){const{notification:s}=ne.useApp(),e=oe(),n=R("suspects"),l=R("testimony-questions-pt"),a=R("testimony-answers"),u=Se("data","testimonies",{select:i=>we(i,m=>{const f={};return Object.keys(m).forEach(j=>{const x=j.replace(/us-\w{2}-(\d+)/,"us-$1");f[x]=m[j]||[]}),f})}),[o,d]=w.useState({}),p=ke("data","testimonies",{onSuccess:()=>{s.success({message:"data/testimonies updated"}),e.refetchQueries({queryKey:["firestore","data","testimonies"]}),d({})},onError:i=>{s.error({message:"data/testimonies update failed",description:i.message})}}),r=w.useMemo(()=>{if(!a.data||!u.data)return{};const i=b.cloneDeep(a.data);return Object.keys(u.data).forEach(m=>{const f=u.data[m];if(i[m]===void 0){i[m]=f;return}Object.keys(f).forEach(j=>{i[m][j]===void 0?i[m][j]=f[j]:i[m][j].push(...f[j])})}),Object.keys(o).forEach(m=>{const f=o[m];i[m]&&(i[m]=f)}),i},[a.data,u.data,o]),c=!b.isEmpty(o),g=(i,m)=>{d(f=>({...f,[i]:m}))},h=()=>{const i=Object.keys(o).reduce((m,f)=>(m[f]=JSON.stringify(o[f]),m),{});p.mutate(i)};return{isLoading:a.isLoading||u.isLoading||l.isLoading||n.isLoading,isSuccess:a.isSuccess&&u.isSuccess&&l.isSuccess&&n.isSuccess,error:a.error||u.error,data:r,questions:l.data,suspects:n.data,hasNewData:!b.isEmpty(u.data),isSaving:p.isPending,save:h,addEntryToUpdate:g,isDirty:c,entriesToUpdate:o}}function Lt(){const s=Ze();return t.jsx(re,{title:"Testimonies",subtitle:"Suspect Testimony Rates",children:t.jsxs(W,{hasSider:!0,children:[t.jsx(ce,{children:t.jsx(Ke,{...s})}),t.jsx(W.Content,{className:"content",children:t.jsx(ie,{isLoading:s.isLoading,error:s.error,hasResponseData:!b.isEmpty(s.data),children:t.jsx(Ye,{...s})})})]})})}export{Lt as TestimoniesPage,Lt as default};
