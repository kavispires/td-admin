import{r as y,X as M,j as e,B as $,T as b,D as W,P as Q,L as O}from"./index-CVRCWKrs.js";import{D as z}from"./DataLoadingWrapper-B9QIqPW2.js";import{F as q,c as U}from"./FilterEntries-Dhp66qCb.js";import{S as J}from"./SiderContent-CbiDcO95.js";import{D as K}from"./DownloadButton-CkzYhAOK.js";import{S as X}from"./SaveButton-rmS-rILF.js";import{u as T}from"./useQueryParams-xVArmLnz.js";import{u as v}from"./useTDResource-DW9HZv24.js";import{l as g,P as _}from"./useBaseUrl-CZeEyNwd.js";import{h as N,b as V,i as H,r as C,a as Y}from"./index-Ca59VBQd.js";import{L as P}from"./LanguageFlag-B4LXJXyL.js";import{F as I,R as Z,C as ee}from"./index-CQF4KHb-.js";import{M as se}from"./index-DO7X16xv.js";import{I as D}from"./index-D_mPyj4X.js";import{F as w}from"./index-CWi0oCqR.js";import{R as te}from"./ClusterOutlined-CaUdH5ve.js";import{R as re}from"./TableOutlined-Q9_RimE-.js";import{T as oe}from"./TransparentButton-DK-FWwS9.js";import{D as G}from"./EditableFields-B9hVS5Vp.js";import{I as ie}from"./Item-DbXqLFWP.js";import{u as E}from"./useCopyToClipboardFunction-PHWxKNlW.js";import{u as ae}from"./useTableExpandableRows-YfI-V7lR.js";import{u as ne}from"./useTablePagination-XEJBRQ7a.js";import{C as le}from"./CopyIdsButton-CmPgC2nV.js";import{I as me}from"./InspirationSample-C-5wEloZ.js";import{I as ce}from"./ItemsTypeahead-C_78Hqyt.js";import{I as de,b as k,d as pe}from"./ItemBuildingBlocks-DJmtgBJw.js";import{C as ue}from"./index-3D7m3RNp.js";import{S as F}from"./index-DW1cKGSC.js";import{S as he}from"./index-BctA8CAm.js";import{F as R}from"./Table-C_TRinbG.js";import{D as xe}from"./index-o2MXaJ63.js";import{u as fe,P as je}from"./useGridPagination-DI5AS1e8.js";import{T as ye}from"./Typeahead-CjEpvCZR.js";import{u as ge}from"./useResourceFirestoreData-Czwcau02.js";import"./index-Cjxx39wZ.js";import"./index-B24RBAno.js";import"./moment-C5S46NFB.js";import"./SaveOutlined-DRDGFjuw.js";import"./constants-BNLZsNJa.js";import"./Input-Ch2EOOMe.js";import"./gapSize-U1swVQyS.js";import"./FireFilled-Bgq4Pmhj.js";import"./IdcardOutlined-DbmWZhwT.js";import"./index-BxGCwdtf.js";import"./SyncOutlined-BgTI9SnB.js";import"./PlusOutlined-NpYEt6zl.js";import"./PlusOutlined-ByZyTB3m.js";import"./useDebounce-Dvw2KkAQ.js";import"./index-B2EM8jyZ.js";import"./index-DUqublxs.js";import"./index-DLjdKiif.js";import"./index-Ss88wE1m.js";import"./scrollTo-BDOp4hxZ.js";import"./Pagination-Ctt071ox.js";import"./extendsObject-keMuGWqj.js";import"./useGetFirestoreDoc-CW8pporG.js";import"./useUpdateFirestoreDoc-CO8-59wg.js";import"./useMutation-FZ7itTWt.js";function Ie({addEntryToUpdate:s,data:t}){const[o,c]=y.useState(!1),[n]=I.useForm(),{notification:m}=M.useApp(),d=r=>{const i=V(Object.keys(t));s(i,{id:i,name:{pt:r.nome,en:r.name},itemsIds:[],keywords:r.keywords}),m.success({message:"Group added successfully"}),c(!1),n.resetFields()},u=I.useWatch("name",n),f=I.useWatch("nome",n),p=y.useMemo(()=>{const r={};if(u&&u.length>2){const l=Object.entries(t).reduce((x,[S,a])=>{const h=N.compareTwoStrings(a.name.en,u),j=N.compareTwoStrings(a.name.pt,f);return(h>.2||j>.2)&&(x[S]=Math.max(h,j)),x},{});Object.keys(l).forEach(x=>{r[x]=l[x]})}return Object.keys(r)},[u,f,t]);return e.jsxs(e.Fragment,{children:[e.jsx($,{type:"dashed",block:!0,onClick:()=>c(!0),className:"mb-4",children:"Add New Group"}),e.jsxs(se,{title:"Add New Set",open:o,onOk:n.submit,onCancel:()=>c(!1),maskClosable:!1,okText:"Add",okButtonProps:{htmlType:"submit"},children:[e.jsxs(I,{form:n,onFinish:d,children:[e.jsx(I.Item,{name:"nome",label:"Nome",rules:[{required:!0}],children:e.jsx(D,{prefix:e.jsx(P,{language:"pt",width:"1em"}),placeholder:"Name in pt",size:"small"})}),e.jsx(I.Item,{name:"name",label:"Name",rules:[{required:!0}],children:e.jsx(D,{prefix:e.jsx(P,{language:"en",width:"1em"}),placeholder:"Name in en",size:"small"})})]}),e.jsx(b.Text,{children:"Similar:"}),e.jsx("ul",{children:p.map(r=>{var i,l;return e.jsxs("li",{children:[r," - ",(i=t[r])==null?void 0:i.name.en," / ",(l=t[r])==null?void 0:l.name.pt]},r)})})]})]})}function be({data:s,save:t,isDirty:o,isSaving:c,entriesToUpdate:n,addEntryToUpdate:m,hasFirestoreData:d}){const{queryParams:u,addParam:f,addParams:p,is:r}=T(),i=v("items");return e.jsxs(J,{children:[e.jsxs(w,{vertical:!0,gap:12,children:[e.jsx(X,{isDirty:o,onSave:t,isSaving:c,dirt:JSON.stringify(L(n))}),e.jsx(K,{data:()=>Se(s,i.data),fileName:"items-groups.json",disabled:o||g.isEmpty(i.data),hasNewData:d,block:!0})]}),e.jsx(W,{}),e.jsx(q,{label:"Display",value:u.get("display")??"group",onChange:l=>p({display:l,page:1},{page:1}),options:[{title:"By Groups",icon:e.jsx(te,{}),value:"group"},{title:"By Items",icon:e.jsx(re,{}),value:"item"}]}),e.jsx(Ie,{data:s,addEntryToUpdate:m}),r("display","item")&&e.jsx(U,{label:"No Groups Only",value:r("emptyOnly"),onChange:l=>f("emptyOnly",l,!1)})]})}function L(s){return g.omitBy(g.cloneDeep(s),t=>g.isEmpty(t.itemsIds))}function Se(s,t){return Object.keys(s).forEach(o=>{s[o].itemsIds=H(C(s[o].itemsIds));const c=s[o].itemsIds.length,n=s[o].itemsIds.filter(m=>t[m].nsfw).length;n>c*.3&&(s[o].nsfw=!0,console.log(`ðŸ˜ˆ Group ${s[o].name.pt} has ${n} (${Math.round(n/c*100)}%) NSFW items`))}),Y(L(s))}function we({group:s,onUpdateGroupItems:t}){const o=c=>{t(s.id,[...s.itemsIds,c])};return e.jsxs("div",{children:[e.jsx(ce,{onFinish:o}),e.jsx(me,{onSelect:o,excludeList:s.itemsIds,initialQuantity:0})]})}const Ce=["8bc4f","96efa","c10eb","16ec3","2a97f","4bba8","565ed","5fb57","62a8b"];function B({item:s,itemGroups:t,groupsTypeahead:o,onUpdateItemGroups:c}){const n=E();return e.jsxs(ue,{title:e.jsxs(e.Fragment,{children:[e.jsx(b.Text,{onClick:()=>n(s.id),children:s.id}),e.jsx(pe,{item:s})]}),style:{maxWidth:250,...ve(t)},children:[e.jsx(de,{item:s,width:75}),e.jsxs(F,{size:"small",direction:"vertical",className:"my-4",children:[e.jsx(k,{item:s,language:"en"}),e.jsx(k,{item:s,language:"pt"}),e.jsx(he,{mode:"multiple",style:{width:"100%"},placeholder:"Select a group",defaultValue:t,options:o,filterOption:(m,d)=>!!(d!=null&&d.label.toLowerCase().includes(m.toLowerCase())),size:"small",onChange:m=>c(s.id,m)},String(t))]})]})}const ve=s=>!s||(s==null?void 0:s.length)===0?{borderColor:"orange"}:s!=null&&s.every(t=>Ce.includes(t))?{borderColor:"red"}:{};function A({rows:s,items:t,grousByItem:o,groupsTypeahead:c,onUpdateItemGroups:n,onUpdateGroupItems:m,onUpdateName:d}){const u=E(),f=v("items"),[p,r]=y.useState(null),i=ne({showQuickJumper:!0,total:s.length}),l=[{title:"id",dataIndex:"id",key:"id",render:a=>e.jsx("span",{children:a})},{title:"Name",dataIndex:"name",key:"name",render:(a,h)=>e.jsxs(w,{vertical:!0,gap:4,children:[e.jsx(G,{value:a,language:"en",style:{minWidth:150},onChange:j=>d(j.target.value,"en",h.id)}),e.jsx(G,{value:a,language:"pt",style:{minWidth:150},onChange:j=>d(j.target.value,"pt",h.id)})]})},{title:"Items",dataIndex:"itemsIds",key:"itemsIds",render:(a,h)=>e.jsx(w,{gap:6,wrap:"wrap",children:a.map(j=>e.jsxs(w,{gap:2,vertical:!0,children:[e.jsx(oe,{onClick:()=>r(j),children:e.jsx(ie,{id:j,width:60})}),e.jsx(w,{justify:"center",children:e.jsx(b.Text,{onClick:()=>u(j),children:j})})]},`${h.id}-${j}`))},`items-${h.id}`)},R.EXPAND_COLUMN,{title:"Count",dataIndex:"itemsIds",key:"count",render:a=>C(a).filter(Boolean).length},{title:"Actions",dataIndex:"itemsIds",key:"actions",render:a=>e.jsx(le,{ids:a})}],x=p?t[p]:null,S=ae({maxExpandedRows:1,expandedRowRender:a=>e.jsx(we,{group:a,onUpdateGroupItems:m}),rowExpandable:()=>f.isSuccess});return e.jsxs(e.Fragment,{children:[e.jsx(R,{columns:l,dataSource:s,className:"my-4",rowKey:"id",pagination:i,expandable:S}),e.jsx(xe,{title:"Edit Item Group",onClose:()=>r(null),open:!!x,children:x&&e.jsx(B,{item:x,itemGroups:o[x.id],groupsTypeahead:c,onUpdateItemGroups:n})})]})}function Te({items:s,grousByItem:t,groupsTypeahead:o,onUpdateItemGroups:c}){const{is:n}=T(),m=n("emptyOnly"),d=y.useMemo(()=>m?Object.values(s).filter(p=>!t[p.id]):Object.values(s),[s,t,m]),{page:u,pagination:f}=fe({data:d});return e.jsxs(e.Fragment,{children:[e.jsxs(b.Title,{level:2,children:["Groups by Items (",d.length,")"]}),e.jsx(je,{pagination:f,children:e.jsx(Z,{gutter:[16,16],className:"my-4",children:u.map(p=>e.jsx(ee,{xs:24,sm:24,md:12,lg:6,xl:4,children:e.jsx(B,{item:p,itemGroups:t[p.id],groupsTypeahead:o,onUpdateItemGroups:c})},p.id))})})]})}function Fe({data:s,items:t,grousByItem:o,groupsTypeahead:c,onUpdateItemGroups:n,onUpdateGroupItems:m,onUpdateName:d}){const[u,f]=y.useState(null),p=y.useMemo(()=>u?s[u]:null,[u,s]);return e.jsxs(F,{direction:"vertical",children:[e.jsx(b.Title,{level:5,children:"Search Groups"}),e.jsx(ye,{data:s,onFinish:r=>f(r),placeholder:"Search group by name...",parser:Oe,style:{width:"100%",minWidth:450}}),!!p&&e.jsx(A,{rows:[p],items:t,grousByItem:o,groupsTypeahead:c,onUpdateItemGroups:n,onUpdateGroupItems:m,onUpdateName:d})]})}const Oe=s=>Object.values(s??{}).reduce((t,o)=>(t[`${o.name.en}`]=o.id,t[`${o.name.pt}`]=o.id,t),{});function Ne({data:s,addEntryToUpdate:t}){const{is:o,queryParams:c}=T(),n=v("items"),m=y.useMemo(()=>Object.values(s??[]).reduce((r,i)=>(i.itemsIds||console.warn("Group without items",i),i.itemsIds.forEach(l=>{r[l]||(r[l]=[]),r[l].push(i.id)}),r),{}),[s]),d=y.useMemo(()=>g.orderBy(Object.values(s).flatMap(({id:r,name:i})=>[{label:`${i.en} [${r}]`,value:r}]),"label"),[s]),u=(r,i)=>{const l=m[r]??[],x=i.filter(a=>!l.includes(a)),S=l.filter(a=>!i.includes(a));x.forEach(a=>{const h=s[a];t(a,{...h,itemsIds:C([...(h==null?void 0:h.itemsIds)??[],r])})}),S.forEach(a=>{const h=s[a];t(a,{...h,itemsIds:C(h==null?void 0:h.itemsIds.filter(j=>j!==r))})})},f=(r,i)=>{const l=s[r];t(r,{...l,itemsIds:C(i)})},p=(r,i,l)=>{const x=s[l];t(l,{...x,name:{...x.name,[i]:r}})};return e.jsxs(e.Fragment,{children:[(o("display","group")||!c.has("display"))&&e.jsxs(F,{direction:"vertical",className:"mb-4",children:[e.jsx(Fe,{data:s,items:n.data,grousByItem:m,groupsTypeahead:d,onUpdateItemGroups:u,onUpdateGroupItems:f,onUpdateName:p}),e.jsxs(b.Title,{level:2,children:["Groups (",Object.keys(s).length,")"]}),e.jsx(A,{rows:Object.values(s),items:n.data,grousByItem:m,groupsTypeahead:d,onUpdateItemGroups:u,onUpdateGroupItems:f,onUpdateName:p})]}),o("display","item")&&e.jsx(Te,{items:n.data,grousByItem:m,groupsTypeahead:d,onUpdateItemGroups:u,onUpdateGroupItems:f,onUpdateName:p})]})}function Es(){const s=ge({tdrResourceName:"items-groups",firestoreDataCollectionName:"itemsGroups",serialize:!0}),t=v("items");return e.jsx(Q,{title:"Items",subtitle:"Groups Sets",children:e.jsxs(O,{hasSider:!0,children:[e.jsx(_,{children:e.jsx(be,{...s})}),e.jsx(O.Content,{className:"content",children:e.jsx(z,{isLoading:s.isLoading||t.isLoading,error:s.error||t.error,hasResponseData:!g.isEmpty(s.data)&&!g.isEmpty(t.data),children:e.jsx(Ne,{...s})})})]})})}export{Es as ItemsGroups,Es as default};
