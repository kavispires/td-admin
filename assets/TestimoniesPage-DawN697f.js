import{ay as je,r as y,c as B,_ as z,j as e,F as v,T as C,B as S,A as K,g as xe,a3 as F,D as Q,a as G,az as ge,a1 as ie,aA as ye,P as be,L as J}from"./index-D37itX2d.js";import{D as we}from"./DataLoadingWrapper-Ci-O23Yo.js";import{l as O,c as oe,P as ve}from"./useBaseUrl-BRxm3gcj.js";import{u as R}from"./useQueryParams-Cd5Aniy8.js";import{R as Se}from"./main-D9VYrh1i.js";import{u as ke,b as ce,c as Ce,n as Oe,e as Te}from"./useTestimoniesResource-CDUXo5mD.js";import{g as Ie}from"./useParsedHistory-DtDmy4wa.js";import{S as L}from"./SuspectImageCard-HIdQQ4Np.js";import{u as Re}from"./useTDResource-CagVVubj.js";import{T as ae,S as Ne,F as Pe}from"./FilterEntries-DNpdH5X6.js";import{B as H,D as le}from"./DownloadButton-BI6fVBt5.js";import{S as E}from"./index-D7yYZq8k.js";import{u as ue}from"./useTableExpandableRows-ymXZXgBA.js";import{u as de}from"./useTablePagination-CWcVMAcq.js";import{P as X}from"./progress-Dj-CcsN9.js";import{S as P}from"./index-57nd00jp.js";import{F as W}from"./Table-B-52N5yy.js";import{u as De}from"./useCardWidth-BmlHE3o8.js";import{C as he}from"./index-Crd1jx2_.js";import{P as Z}from"./index-B0-FyCLI.js";import{R as Me}from"./FireFilled-RqRB6LJp.js";import{S as V}from"./SiderContent-CFdUCslS.js";import{F as Ee,a as Ae}from"./FirestoreConsoleLink-BCtMLo8V.js";import{S as Fe}from"./SaveButton-Dcml--l0.js";import{S as Be}from"./SuspectsStyleVariantSelector-OE3iO1dJ.js";import{g as ze}from"./useGetFirestoreDoc-C87ZD_I3.js";import{j as Le,a as $e,i as Ve}from"./index-DyrmBSk6.js";import{u as me}from"./useWindowSize-mYeayaFd.js";import{R as He}from"./TableOutlined-DG0FcSyK.js";import{R as qe}from"./RobotOutlined-Dgt17HeC.js";import"./useResourceFirestoreData-C9wyCMTh.js";import"./useUpdateFirestoreDoc-eF0U8SW6.js";import"./useMutation-v59Ucof-.js";import"./moment-C5S46NFB.js";import"./ImageCard-g2z_vKYo.js";import"./index-CkobVGKs.js";import"./index-CTtYF_lN.js";import"./index-YhnuB92G.js";import"./scrollTo-CLquuyzb.js";import"./Pagination-CpqhVvnV.js";import"./SaveOutlined-Pe7M9McS.js";import"./constants-BG7avbge.js";import"./Item-BZivEtnW.js";function Ue(t,r){return typeof t=="function"?t.length?t(r):t():t}function pe(t,r,c){if(r===void 0&&(r=10),r<1)throw new Error("Capacity has to be greater than 1, got '"+r+"'");var l=je(),m=y.useState(t),p=m[0],h=m[1],i=y.useRef([]),a=y.useRef(0);l&&(i.current.length?(i.current[i.current.length-1]!==t&&i.current.push(t),i.current.length>r&&(i.current=i.current.slice(i.current.length-r))):i.current.push(t),a.current=i.current.length&&i.current.length-1);var j=y.useCallback(function(o){h(function(u){return o=Ue(o,u),o!==u&&(a.current<i.current.length-1&&(i.current=i.current.slice(0,a.current+1)),a.current=i.current.push(o)-1,i.current.length>r&&(i.current=i.current.slice(i.current.length-r))),o})},[p,r]),d=y.useMemo(function(){return{history:i.current,position:a.current,capacity:r,back:function(o){o===void 0&&(o=1),a.current&&h(function(){return a.current-=Math.min(o,a.current),i.current[a.current]})},forward:function(o){o===void 0&&(o=1),a.current!==i.current.length-1&&h(function(){return a.current=Math.min(a.current+o,i.current.length-1),i.current[a.current]})},go:function(o){o!==a.current&&h(function(){return a.current=o<0?Math.max(i.current.length+o,0):Math.min(i.current.length-1,o),i.current[a.current]})}}},[p]);return[p,j,d]}var Qe={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M864 144H560c-8.8 0-16 7.2-16 16v304c0 8.8 7.2 16 16 16h304c8.8 0 16-7.2 16-16V160c0-8.8-7.2-16-16-16zm0 400H560c-8.8 0-16 7.2-16 16v304c0 8.8 7.2 16 16 16h304c8.8 0 16-7.2 16-16V560c0-8.8-7.2-16-16-16zM464 144H160c-8.8 0-16 7.2-16 16v304c0 8.8 7.2 16 16 16h304c8.8 0 16-7.2 16-16V160c0-8.8-7.2-16-16-16zm0 400H160c-8.8 0-16 7.2-16 16v304c0 8.8 7.2 16 16 16h304c8.8 0 16-7.2 16-16V560c0-8.8-7.2-16-16-16z"}}]},name:"appstore",theme:"filled"},We=function(r,c){return y.createElement(B,z({},r,{ref:c,icon:Qe}))},Ye=y.forwardRef(We),_e={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M512 624c93.9 0 170-75.2 170-168V232c0-92.8-76.1-168-170-168s-170 75.2-170 168v224c0 92.8 76.1 168 170 168zm330-170c0-4.4-3.6-8-8-8h-60c-4.4 0-8 3.6-8 8 0 140.3-113.7 254-254 254S258 594.3 258 454c0-4.4-3.6-8-8-8h-60c-4.4 0-8 3.6-8 8 0 168.7 126.6 307.9 290 327.6V884H326.7c-13.7 0-24.7 14.3-24.7 32v36c0 4.4 2.8 8 6.2 8h407.6c3.4 0 6.2-3.6 6.2-8v-36c0-17.7-11-32-24.7-32H548V782.1c165.3-18 294-158 294-328.1z"}}]},name:"audio",theme:"filled"},Ke=function(r,c){return y.createElement(B,z({},r,{ref:c,icon:_e}))},Ge=y.forwardRef(Ke),Je={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M594.3 601.5a111.8 111.8 0 0029.1-75.5c0-61.9-49.9-112-111.4-112s-111.4 50.1-111.4 112c0 29.1 11 55.5 29.1 75.5a158.09 158.09 0 00-74.6 126.1 8 8 0 008 8.4H407c4.2 0 7.6-3.3 7.9-7.5 3.8-50.6 46-90.5 97.2-90.5s93.4 40 97.2 90.5c.3 4.2 3.7 7.5 7.9 7.5H661a8 8 0 008-8.4c-2.8-53.3-32-99.7-74.7-126.1zM512 578c-28.5 0-51.7-23.3-51.7-52s23.2-52 51.7-52 51.7 23.3 51.7 52-23.2 52-51.7 52zm416-354H768v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H548v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H328v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H96c-17.7 0-32 14.3-32 32v576c0 17.7 14.3 32 32 32h832c17.7 0 32-14.3 32-32V256c0-17.7-14.3-32-32-32zm-40 568H136V296h120v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h148v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h148v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h120v496z"}}]},name:"contacts",theme:"outlined"},Xe=function(r,c){return y.createElement(B,z({},r,{ref:c,icon:Je}))},Ze=y.forwardRef(Xe),et={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M870 126H663.8c-17.4 0-32.9 11.9-37 29.3C614.3 208.1 567 246 512 246s-102.3-37.9-114.8-90.7a37.93 37.93 0 00-37-29.3H154a44 44 0 00-44 44v252a44 44 0 0044 44h75v388a44 44 0 0044 44h478a44 44 0 0044-44V466h75a44 44 0 0044-44V170a44 44 0 00-44-44z"}}]},name:"skin",theme:"filled"},tt=function(r,c){return y.createElement(B,z({},r,{ref:c,icon:et}))},nt=y.forwardRef(tt),st={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M868 160h-92v-40c0-4.4-3.6-8-8-8H256c-4.4 0-8 3.6-8 8v40h-92a44 44 0 00-44 44v148c0 81.7 60 149.6 138.2 162C265.6 630.2 359 721.8 476 734.5v105.2H280c-17.7 0-32 14.3-32 32V904c0 4.4 3.6 8 8 8h512c4.4 0 8-3.6 8-8v-32.3c0-17.7-14.3-32-32-32H548V734.5C665 721.8 758.4 630.2 773.8 514 852 501.6 912 433.7 912 352V204a44 44 0 00-44-44zM248 439.6c-37.1-11.9-64-46.7-64-87.6V232h64v207.6zM840 352c0 41-26.9 75.8-64 87.6V232h64v120z"}}]},name:"trophy",theme:"filled"},rt=function(r,c){return y.createElement(B,z({},r,{ref:c,icon:st}))},ee=y.forwardRef(rt);function it(){const[t,r]=y.useState({batchSize:1,history:{}}),c=y.useRef(1),{entries:l}=ke(!0,"pt",t.batchSize,t.history),m=Re("suspects",!O.isEmpty(l));return console.log(ct(l,m.data??{})),e.jsxs(v,{className:"p-4",gap:12,vertical:!0,children:[e.jsxs(v,{align:"center",justify:"space-between",children:[e.jsx(C.Title,{className:"my-0",level:4,children:"Espionagem Simulator"}),e.jsxs(v,{gap:6,children:[e.jsx(ae,{defaultValue:1,max:100,min:1,onChange:p=>{c.current=p??1}}),e.jsx(S,{onClick:()=>r({batchSize:c.current,history:{}}),type:"primary",children:"Re-run Simulation"})]})]}),e.jsx(ot,{entries:l})]})}function ot({entries:t}){const[r,c]=y.useState(!1),l=Ie(),m=t[l],p=y.useMemo(()=>m?m.statements.reduce((h,i)=>{const{excludes:a}=i;return a.forEach(j=>{h[j]?h[j]++:h[j]=1}),h},{}):{},[m]);return e.jsxs("div",{className:"full-width grid",style:{gridTemplateColumns:"2fr 3fr"},children:[e.jsx(Se,{collapsed:3,src:t??{},theme:"twilight"}),e.jsx("div",{children:m&&e.jsxs(v,{className:"p-4",gap:18,children:[e.jsx("div",{children:e.jsx("div",{style:{width:`${105*4}px`,display:"grid",gap:"6px",gridTemplateColumns:"repeat(4, 1fr)"},children:m.suspects.map(h=>e.jsxs(H.Ribbon,{color:"cyan",text:r?p[h.id]:null,children:[e.jsx(L,{cardId:h.id,cardWidth:96,className:oe(r&&h.id===m.culpritId&&"red-border")},h.id),e.jsxs(v,{align:"center",gap:6,children:[e.jsx(E,{checkedChildren:"ðŸš«",size:"small"})," ",h.id]})]},h.id))})}),e.jsxs("div",{children:[e.jsx("div",{children:e.jsx(E,{checked:r,checkedChildren:"Show Culprit",onChange:c,unCheckedChildren:"Hide Culprit"})}),m.statements.map(h=>e.jsx(C.Paragraph,{children:e.jsx(H,{color:"cyan",count:h.excludes.length,children:e.jsx(K,{banner:!0,icon:te(h.type),message:h.text,type:"info"},h.key)})},h.key)),m.additionalStatements.map(h=>e.jsx(C.Paragraph,{children:e.jsx(H,{color:"cyan",count:h.excludes.length,children:e.jsx(K,{banner:!0,icon:te(h.type),message:h.text,type:"warning"},h.key)})},h.key))]})]})})]})}const te=t=>{switch(t){case"testimony":return e.jsx(Ge,{});case"feature":return e.jsx(nt,{});case"grid":return e.jsx(Ye,{});default:return"â“"}},ct=(t,r)=>{const c=Object.values(t).reduce((l,m)=>(m.suspects.forEach(p=>{l[p.id]=(l[p.id]||0)+1,p.id===m.culpritId&&(l[`${p.id}_culprit`]=(l[`${p.id}_culprit`]||0)+1)}),l),{});return Object.values(r).forEach(l=>{c[l.id]||(c[l.id]=0),c[`${l.id}_culprit`]||(c[`${l.id}_culprit`]=0)}),c};function fe({suspect:t,values:r,resolution:c,projection:l,yesPercentage:m,noPercentage:p,complete:h,enoughData:i,testimonyId:a,addEntryToUpdate:j,answers:d,barWidth:o,showName:u}){const n=(f,x)=>{const b={...d};b[f]=[...b[f]||[],x],j(a,b)},s=(f,x)=>{const b={...d},g=b[f]?.findIndex(w=>w===x);g!==-1&&g!==void 0&&(b[f]=[...b[f].slice(0,g),...b[f].slice(g+1)]),j(a,b)};return e.jsxs(xe,{content:e.jsxs(v,{align:"center",vertical:!0,children:[e.jsx(C.Text,{type:"secondary",children:r.join(", ")}),e.jsxs(P.Compact,{children:[e.jsx(S,{block:!0,icon:"ðŸ‘",onClick:()=>n(t.id,4),children:"Fit"}),e.jsx(S,{icon:"âŒ",onClick:()=>s(t.id,4)}),e.jsx(S,{block:!0,icon:"ðŸ‘Ž",onClick:()=>n(t.id,-4),children:"Unfit"}),e.jsx(S,{icon:"âŒ",onClick:()=>s(t.id,-4)})]}),e.jsx(Q,{className:"my-1"}),e.jsxs(P.Compact,{children:[e.jsx(S,{block:!0,icon:"â¬†ï¸",onClick:()=>n(t.id,32),children:"Sure"}),e.jsx(S,{icon:"âœ–ï¸",onClick:()=>s(t.id,32)}),e.jsx(S,{block:!0,icon:"â¬‡ï¸",onClick:()=>n(t.id,-32),children:"Sure"}),e.jsx(S,{icon:"âœ–ï¸",onClick:()=>s(t.id,-32)})]})]}),title:`Add strong fit/unfit answer to ${t.name.pt}`,trigger:"click",children:[u&&e.jsxs("div",{children:[e.jsx(F,{title:t.id,children:t.name.pt})," ",h&&e.jsx(F,{title:"Complete: It has 5 or more answers",children:e.jsx(ee,{style:{color:"gold"}})})]}),e.jsxs(v,{align:"flex-start",gap:12,children:[e.jsx(F,{title:`Values: ${r.join(", ")} : ${c||(l?`${l}*`:"")}`,children:i?e.jsx(X,{percent:p+m,showInfo:!1,size:[o,20],status:"exception",success:{percent:m}}):e.jsx(X,{percent:p+m,showInfo:!1,size:[o,10],status:"exception",success:{percent:m}})}),!u&&h&&e.jsx(F,{title:"Complete: It has 5 or more answers",children:e.jsx(ee,{style:{color:"gold"}})})]})]})}function at({suspect:t,answersPerQuestion:r={},questions:c,addEntryToUpdate:l,allAnswers:m}){const{queryParams:p}=R({sortSuspectsBy:"answers"}),h=p.get("sortSuspectsBy")??"answers",[i,a]=y.useState(""),j=y.useMemo(()=>{const n=Object.values(c).map(s=>{const f=r[s.id]??{},{enoughData:x,reliable:b,yesPercentage:g,noPercentage:w,blankPercentage:k,values:T,total:N,resolution:D,projection:q,complete:A}=ce(t.id,{[t.id]:f});return{id:s.id,question:s,enoughData:x,reliable:b,yesPercentage:g,noPercentage:w,blankPercentage:k,values:T,total:N,resolution:D,projection:q,complete:A}});return h==="answers"?O.orderBy(n,["reliable","enoughData","yesPercentage",s=>s.values.length],["desc","desc","desc","desc"]):O.orderBy(n,s=>Number(s.id.split("-")[1]),["asc"])},[r,c,t.id,h]),d=y.useMemo(()=>lt(t,j),[t,j]),o=[{key:"id",title:"Id",dataIndex:"id",width:"7%"},{key:"question",title:"Question",dataIndex:"question",render:n=>n.question},{key:"answer",title:"Answer",dataIndex:"id",width:"170px",sorter:(n,s)=>n.total-s.total,render:n=>{const s=j.find(f=>f.id===n);return s?e.jsx(v,{gap:8,wrap:"nowrap",children:e.jsx(fe,{addEntryToUpdate:l,answers:m[s.question.id]||{},barWidth:120,complete:s.complete,enoughData:s.enoughData,noPercentage:s.noPercentage,projection:s.projection,resolution:s.resolution,suspect:t,testimonyId:s.question.id,values:s.values,yesPercentage:s.yesPercentage})}):""}},{key:"actions",title:"Actions",dataIndex:"id",width:"auto",render:n=>{const s=j.find(f=>f.id===n);return s?e.jsx(ut,{addEntryToUpdate:l,answers:m[s.question.id]||{},suspect:t,testimonyId:s.question.id}):""}}],u=y.useMemo(()=>i.trim()?j.filter(n=>n.question.question.toLowerCase().includes(i.toLowerCase())||n.id.toLowerCase().includes(i.toLowerCase())):j,[j,i]);return e.jsxs(P,{size:"large",wrap:!0,children:[e.jsxs(v,{className:"full-width",gap:16,vertical:!0,children:[e.jsx(G,{allowClear:!0,onChange:n=>a(n.target.value),placeholder:"Search questions...",prefix:e.jsx(ge,{}),style:{marginBottom:16,width:320},value:i}),e.jsx(W,{bordered:!0,className:"full-width",columns:o,dataSource:u,rowKey:"id",tableLayout:"fixed"})]}),e.jsxs(v,{gap:8,vertical:!0,children:[e.jsx(C.Title,{level:5,children:"Suspect Description"}),e.jsx(G.TextArea,{className:"full-width",readOnly:!0,rows:7,value:d})]})]})}const lt=(t,r)=>{const c=r.filter(l=>l.resolution||l.projection).map(l=>{const{question:m,resolution:p,projection:h}=l,i=p||h;return`${t.gender==="male"?"ele":"ela"} ${i==="ðŸ‘"?"":"nÃ£o "}${m.answer.toLocaleLowerCase()}`});return`${t.name.pt}: ${c.join(", ")}`};function ut({suspect:t,testimonyId:r,addEntryToUpdate:c,answers:l}){const m=(i,a)=>{const j={...l};j[i]=[...j[i]||[],a],c(r,j)},p=(i,a)=>{const j={...l},d=j[i]?.findIndex(o=>o===a);d!==-1&&d!==void 0&&(j[i]=[...j[i].slice(0,d),...j[i].slice(d+1)]),c(r,j)},h=y.useMemo(()=>Object.values(l[t.id]||{}).reduce((i,a)=>i+Math.abs(a===0?-1:a),0),[l,t.id]);return console.log(l[t.id]),e.jsxs(v,{align:"center",gap:6,wrap:"nowrap",children:[e.jsx(H,{color:h>20?"gold":"grey",count:h,showZero:!0,style:{minWidth:32}}),e.jsxs(P.Compact,{children:[e.jsx(S,{block:!0,icon:"ðŸ‘",onClick:()=>m(t.id,4),children:"FIT"}),e.jsx(S,{icon:"âŒ",onClick:()=>p(t.id,4)}),e.jsx(S,{block:!0,icon:"ðŸ‘Ž",onClick:()=>m(t.id,-4),children:"UNFIT"}),e.jsx(S,{icon:"âŒ",onClick:()=>p(t.id,-4)}),e.jsx(S,{block:!0,icon:"â¬†ï¸",onClick:()=>m(t.id,32),children:"Sure"}),e.jsx(S,{icon:"âœ–ï¸",onClick:()=>p(t.id,32)}),e.jsx(S,{block:!0,icon:"â¬‡ï¸",onClick:()=>m(t.id,-32),children:"Sure"}),e.jsx(S,{icon:"âœ–ï¸",onClick:()=>p(t.id,-32)})]})]})}function dt({isLoading:t,isSuccess:r,questions:c,data:l,suspects:m,addEntryToUpdate:p}){const{queryParams:h,addParam:i}=R(),a=Object.values(c).map(({id:s,question:f})=>({id:s,question:f})),j=y.useMemo(()=>Object.keys(l).reduce((s,f)=>{const x=l[f]??{};return Object.keys(x).forEach(b=>{s[b]||(s[b]={}),s[b][f]=x[b]}),s},{}),[l]),d=y.useMemo(()=>O.orderBy(Object.values(m).map(s=>({...s,answers:j[s.id]})),s=>Number(s.id.split("-")[1]),"asc"),[m,j]),o=de({total:d.length,showQuickJumper:!0}),u=[{title:"Id",dataIndex:"id",key:"id",sorter:(s,f)=>Number(s.id.split("-")[1])-Number(f.id.split("-")[1])},{title:"Picture",dataIndex:"id",render:s=>e.jsx(L,{cardId:s,cardWidth:48})},{title:"Name",dataIndex:"name",key:"name",sorter:(s,f)=>s.name.pt.localeCompare(f.name.pt),render:(s,f)=>e.jsxs(v,{vertical:!0,children:[e.jsx(C.Text,{children:s.pt}),e.jsx(C.Text,{type:"secondary",children:s.en}),e.jsx(C.Text,{italic:!0,type:"secondary",children:e.jsx("small",{children:f.note})})]})},{title:"Questions Answered",dataIndex:"answers",key:"answers",sorter:(s,f)=>Object.keys(s.answers??{}).length-Object.keys(f.answers??{}).length,render:s=>s?Object.values(s).length:""}],n=ue({maxExpandedRows:1,expandedRowRender:s=>e.jsx(at,{addEntryToUpdate:p,allAnswers:l,answersPerQuestion:s.answers,questions:c,suspect:s}),rowExpandable:()=>r});return e.jsxs(v,{className:"full-width py-4",gap:12,vertical:!0,children:[e.jsxs(v,{align:"center",justify:"space-between",children:[e.jsx(C.Title,{className:"my-0",level:4,children:"Testimonies by Suspect"}),e.jsx(le,{data:a,fileName:"newQuestions.json"}),e.jsx(E,{checked:h.get("sortSuspectsBy")==="answers",checkedChildren:"Sort by Answers",onChange:s=>i("sortSuspectsBy",s?"answers":"id"),unCheckedChildren:"Sort by Id"})]}),e.jsx(W,{bordered:!0,className:"full-width",columns:u,dataSource:d,expandable:n,loading:t,pagination:o,rowKey:"id"})]})}function ht({answers:t,suspects:r,addEntryToUpdate:c,testimonyId:l}){const[m,p]=De(12),{queryParams:h,is:i}=R({sortSuspectsBy:"answers"}),a=i("enableBatch"),j=h.get("sortSuspectsBy")??"answers",d=y.useMemo(()=>{const n=Object.keys(r).map(s=>ce(s,t));return j==="answers"?O.orderBy(n,["reliable","enoughData",s=>s.values.length,"yesPercentage","noPercentage",s=>Number(s.suspectCardId.split("-")[1])],["desc","desc","desc","desc","desc","asc"]):O.orderBy(n,s=>Number(s.suspectCardId.split("-")[1]),["asc"])},[t,r,j]),[o,u]=y.useState([]);return e.jsxs(P,{direction:"vertical",children:[e.jsx(mt,{addEntryToUpdate:c,answers:t,list:d,selection:o,setSelection:u,suspects:r,testimonyId:l}),e.jsx(P,{ref:p,size:"large",wrap:!0,children:d.map(n=>e.jsxs(v,{className:oe({"selection-outline":a&&o.includes(n.suspectCardId)}),gap:6,vertical:!0,children:[e.jsx(L,{cardId:n.imageId,cardWidth:m,className:n.values.length>1||n.enoughData?void 0:"grayscale"}),e.jsxs(v,{gap:4,children:[a&&e.jsx(he,{checked:o.includes(n.suspectCardId),disabled:n.complete,onChange:s=>{const f=s.target.checked;u(x=>f?[...x,n.suspectCardId]:x.filter(b=>b!==n.suspectCardId))}}),e.jsx(fe,{addEntryToUpdate:c,answers:t,barWidth:m,complete:n.complete,enoughData:n.enoughData,noPercentage:n.noPercentage,projection:n.projection,resolution:n.resolution,showName:!0,suspect:r[n.suspectCardId],testimonyId:l,values:n.values,yesPercentage:n.yesPercentage})]})]},n.suspectCardId))})]})}function mt({testimonyId:t,selection:r,setSelection:c,suspects:l,addEntryToUpdate:m,list:p,answers:h}){const[i,a]=y.useState([]),{addParam:j,removeParam:d,is:o}=R({sortSuspectsBy:"answers"}),u=o("enableBatch"),n=x=>{a(b=>b.includes(x)?b.filter(g=>g!==x):[...b,x])},s=y.useMemo(()=>O.keyBy(p,"suspectCardId"),[p]);y.useEffect(()=>{if(i.length===0&&r.length>0){c([]);return}if(!i.length)return;const b=(r.length>0?r:Object.values(s).filter(g=>!g.complete&&!g.values.includes(4)&&!g.values.includes(-4)).map(g=>g.suspectCardId)).filter(g=>{const w=l[g],k=[w.gender,w.ethnicity,w.build,w.height];return w.age==="18-21"&&k.push("young"),(w.age==="21-30"||w.age==="30-40")&&k.push("adult"),w.age==="40-50"&&k.push("parent"),(w.age==="50-60"||w.age==="60-70"||w.age==="70-80"||w.age==="80-90")&&k.push("senior"),i.every(T=>k.includes(T))});c(b)},[i]);const f=x=>{const b=O.cloneDeep(h);r.forEach(g=>{b[g]=[...b[g]||[],x]}),m(t,b),a([])};return e.jsxs(v,{align:"center",className:"mb-4",gap:6,justify:"space-between",children:[e.jsxs(v,{gap:3,children:[e.jsx(C.Text,{className:"nowrap",style:{minWidth:"5ch"},children:"Batch"}),e.jsx(E,{checkedChildren:"On",onChange:x=>{x?j("enableBatch",!0):d("enableBatch")},unCheckedChildren:"Off",value:u})]}),u&&e.jsxs(e.Fragment,{children:[e.jsxs(C.Text,{className:"nowrap mr-2",children:["Selected ",r.length]}),e.jsxs(v,{align:"center",gap:6,justify:"center",wrap:!0,children:[e.jsx(I,{activeFilters:i,filter:"male",updateActiveFilter:n}),e.jsx(I,{activeFilters:i,filter:"female",updateActiveFilter:n}),e.jsx(I,{activeFilters:i,filter:"young",updateActiveFilter:n}),e.jsx(I,{activeFilters:i,filter:"adult",updateActiveFilter:n}),e.jsx(I,{activeFilters:i,filter:"parent",updateActiveFilter:n}),e.jsx(I,{activeFilters:i,filter:"senior",updateActiveFilter:n}),e.jsx(I,{activeFilters:i,filter:"thin",updateActiveFilter:n}),e.jsx(I,{activeFilters:i,filter:"muscular",updateActiveFilter:n}),e.jsx(I,{activeFilters:i,filter:"large",updateActiveFilter:n}),e.jsx(I,{activeFilters:i,filter:"asian",updateActiveFilter:n}),e.jsx(I,{activeFilters:i,filter:"black",updateActiveFilter:n}),e.jsx(I,{activeFilters:i,filter:"caucasian",updateActiveFilter:n}),e.jsx(I,{activeFilters:i,filter:"latino",updateActiveFilter:n})]}),e.jsxs(v,{align:"center",gap:6,children:[e.jsx(S,{danger:!0,onClick:()=>a([]),size:"small",children:"Clear"}),e.jsx(Z,{onConfirm:()=>f(4),title:"Apply +4 to selected suspects?",children:e.jsx(S,{className:"ml-10",disabled:r.length===0,size:"small",type:"primary",children:"Apply +4"})}),e.jsx(Q,{type:"vertical"}),e.jsx(Z,{onConfirm:()=>f(-4),title:"Apply -4 to selected suspects?",children:e.jsx(S,{disabled:r.length===0,size:"small",type:"primary",children:"Apply -4"})})]})]})]})}function I({filter:t,activeFilters:r,updateActiveFilter:c}){return e.jsxs(e.Fragment,{children:[e.jsxs("span",{children:[e.jsx(he,{checked:r.includes(t),onClick:()=>c(t)})," ",O.capitalize(t)]}),e.jsx(Q,{type:"vertical"})]})}function pt({data:t,questions:r,suspects:c,isLoading:l,isSuccess:m,addEntryToUpdate:p}){const{queryParams:h,addParam:i}=R(),a=y.useMemo(()=>O.orderBy(Object.values(r).map(u=>({...u,answersCount:Object.values(t[u.id]??{}).length})),u=>Number(u.id.split("-")[1]),"asc"),[r]),j=de({total:a.length,showQuickJumper:!0}),d=[{title:"Id",dataIndex:"id",key:"id",sorter:(u,n)=>Number(u.id.split("-")[1])-Number(n.id.split("-")[1])},{title:"Question",dataIndex:"question",key:"question",sorter:(u,n)=>u.question.localeCompare(n.question)},{title:"NSFW",dataIndex:"nsfw",key:"nsfw",render:u=>u?e.jsx(Me,{style:{color:"hotPink"}}):"",sorter:(u,n)=>Number(u.nsfw)-Number(n.nsfw)},{title:"Answers",dataIndex:"answersCount",key:"answersCount",sorter:(u,n)=>u.answersCount-n.answersCount}],o=ue({maxExpandedRows:1,expandedRowRender:u=>e.jsx(ht,{addEntryToUpdate:p,answers:t[u.id]??{},suspects:c,testimonyId:u.id}),rowExpandable:()=>m});return e.jsxs(v,{className:"full-width py-4",gap:12,vertical:!0,children:[e.jsxs(v,{align:"center",justify:"space-between",children:[e.jsx(C.Title,{className:"my-0",level:4,children:"Suspects by Testimony"}),e.jsx(E,{checked:h.get("sortSuspectsBy")==="answers",checkedChildren:"Sort by Answers",onChange:u=>i("sortSuspectsBy",u?"answers":"id"),unCheckedChildren:"Sort by Id"})]}),e.jsx(W,{bordered:!0,className:"full-width",columns:d,dataSource:a,expandable:o,loading:l,pagination:j,rowKey:"id"})]})}function ft(t){const{queryParams:r,is:c}=R();return e.jsxs(e.Fragment,{children:[(c("display","questions")||!r.get("display"))&&e.jsx(pt,{...t}),c("display","suspects")&&e.jsx(dt,{...t}),c("display","simulator")&&e.jsx(it,{})]})}const jt="Left",xt="Right",gt="Up",yt="Down",M={delta:10,preventScrollOnSwipe:!1,rotationAngle:0,trackMouse:!1,trackTouch:!0,swipeDuration:1/0,touchEventOptions:{passive:!0}},U={first:!0,initial:[0,0],start:0,swiping:!1,xy:[0,0]},ne="mousemove",se="mouseup",bt="touchend",wt="touchmove",vt="touchstart";function St(t,r,c,l){return t>r?c>0?xt:jt:l>0?yt:gt}function re(t,r){if(r===0)return t;const c=Math.PI/180*r,l=t[0]*Math.cos(c)+t[1]*Math.sin(c),m=t[1]*Math.cos(c)-t[0]*Math.sin(c);return[l,m]}function kt(t,r){const c=d=>{const o="touches"in d;o&&d.touches.length>1||t((u,n)=>{n.trackMouse&&!o&&(document.addEventListener(ne,l),document.addEventListener(se,h));const{clientX:s,clientY:f}=o?d.touches[0]:d,x=re([s,f],n.rotationAngle);return n.onTouchStartOrOnMouseDown&&n.onTouchStartOrOnMouseDown({event:d}),Object.assign(Object.assign(Object.assign({},u),U),{initial:x.slice(),xy:x,start:d.timeStamp||0})})},l=d=>{t((o,u)=>{const n="touches"in d;if(n&&d.touches.length>1)return o;if(d.timeStamp-o.start>u.swipeDuration)return o.swiping?Object.assign(Object.assign({},o),{swiping:!1}):o;const{clientX:s,clientY:f}=n?d.touches[0]:d,[x,b]=re([s,f],u.rotationAngle),g=x-o.xy[0],w=b-o.xy[1],k=Math.abs(g),T=Math.abs(w),N=(d.timeStamp||0)-o.start,D=Math.sqrt(k*k+T*T)/(N||1),q=[g/(N||1),w/(N||1)],A=St(k,T,g,w),Y=typeof u.delta=="number"?u.delta:u.delta[A.toLowerCase()]||M.delta;if(k<Y&&T<Y&&!o.swiping)return o;const $={absX:k,absY:T,deltaX:g,deltaY:w,dir:A,event:d,first:o.first,initial:o.initial,velocity:D,vxvy:q};$.first&&u.onSwipeStart&&u.onSwipeStart($),u.onSwiping&&u.onSwiping($);let _=!1;return(u.onSwiping||u.onSwiped||u[`onSwiped${A}`])&&(_=!0),_&&u.preventScrollOnSwipe&&u.trackTouch&&d.cancelable&&d.preventDefault(),Object.assign(Object.assign({},o),{first:!1,eventData:$,swiping:!0})})},m=d=>{t((o,u)=>{let n;if(o.swiping&&o.eventData){if(d.timeStamp-o.start<u.swipeDuration){n=Object.assign(Object.assign({},o.eventData),{event:d}),u.onSwiped&&u.onSwiped(n);const s=u[`onSwiped${n.dir}`];s&&s(n)}}else u.onTap&&u.onTap({event:d});return u.onTouchEndOrOnMouseUp&&u.onTouchEndOrOnMouseUp({event:d}),Object.assign(Object.assign(Object.assign({},o),U),{eventData:n})})},p=()=>{document.removeEventListener(ne,l),document.removeEventListener(se,h)},h=d=>{p(),m(d)},i=(d,o)=>{let u=()=>{};if(d&&d.addEventListener){const n=Object.assign(Object.assign({},M.touchEventOptions),o.touchEventOptions),s=[[vt,c,n],[wt,l,Object.assign(Object.assign({},n),o.preventScrollOnSwipe?{passive:!1}:{})],[bt,m,n]];s.forEach(([f,x,b])=>d.addEventListener(f,x,b)),u=()=>s.forEach(([f,x])=>d.removeEventListener(f,x))}return u},j={ref:d=>{d!==null&&t((o,u)=>{if(o.el===d)return o;const n={};return o.el&&o.el!==d&&o.cleanUpTouch&&(o.cleanUpTouch(),n.cleanUpTouch=void 0),u.trackTouch&&d&&(n.cleanUpTouch=i(d,u)),Object.assign(Object.assign(Object.assign({},o),{el:d}),n)})}};return r.trackMouse&&(j.onMouseDown=c),[j,i]}function Ct(t,r,c,l){return!r.trackTouch||!t.el?(t.cleanUpTouch&&t.cleanUpTouch(),Object.assign(Object.assign({},t),{cleanUpTouch:void 0})):t.cleanUpTouch?r.preventScrollOnSwipe!==c.preventScrollOnSwipe||r.touchEventOptions.passive!==c.touchEventOptions.passive?(t.cleanUpTouch(),Object.assign(Object.assign({},t),{cleanUpTouch:l(t.el,r)})):t:Object.assign(Object.assign({},t),{cleanUpTouch:l(t.el,r)})}function Ot(t){const{trackMouse:r}=t,c=y.useRef(Object.assign({},U)),l=y.useRef(Object.assign({},M)),m=y.useRef(Object.assign({},l.current));m.current=Object.assign({},l.current),l.current=Object.assign(Object.assign({},M),t);let p;for(p in M)l.current[p]===void 0&&(l.current[p]=M[p]);const[h,i]=y.useMemo(()=>kt(a=>c.current=a(c.current,l.current),{trackMouse:r}),[r]);return c.current=Ct(c.current,l.current,m.current,i),h}function Tt(t){const{addParam:r}=R();return e.jsxs(v,{gap:8,vertical:!0,children:[e.jsx(S,{block:!0,onClick:()=>r("testify","single"),children:"Testify Drawer"}),e.jsx(S,{block:!0,onClick:()=>r("testify","group"),children:"Testify Group"}),e.jsx(It,{...t}),e.jsx(Rt,{...t})]})}function It({suspects:t,questions:r,answers:c,addEntryToUpdate:l}){const{width:m,height:p}=me(),{is:h,removeParam:i}=R(),[a,j]=pe(),d=Ot({onSwipedLeft:()=>alert("Swiped Left"),onSwipedRight:()=>alert("Swiped Right"),onSwipedUp:()=>alert("Swiped Up"),preventScrollOnSwipe:!0,trackTouch:!0,trackMouse:!0}),o=()=>{j({suspectId:O.sample(Object.keys(t))||null,testimonyId:O.sample(Object.keys(r))||null})},u=()=>{o()},n=()=>{if(a?.suspectId&&a?.testimonyId){const x=O.cloneDeep(c[a?.testimonyId??""]??{});x[a.suspectId]=[...x[a.suspectId]||[],1],l(a.testimonyId??"",x),o()}},s=()=>{if(a?.suspectId&&a?.testimonyId){const x=O.cloneDeep(c[a?.testimonyId??""]??{});x[a.suspectId]=[...x[a.suspectId]||[],0],l(a.testimonyId??"",x),o()}},f=!!a?.suspectId&&!!a?.testimonyId;return e.jsx(ie,{footer:null,maskClosable:!1,onCancel:()=>i("testify"),open:h("testify","single"),title:e.jsx(C,{children:"Does this person do this??"}),width:m-64,children:e.jsxs("div",{...d,children:[f&&e.jsxs(v,{align:"center",className:"mb-8",gap:8,justify:"center",vertical:!0,children:[e.jsx(L,{cardId:a.suspectId??"",cardWidth:Math.max(p/4,128)}),e.jsx(C.Title,{className:"text-center",level:5,children:r[a.testimonyId??""]?.question})]}),e.jsxs(P.Compact,{block:!0,className:"mb-8",size:"large",children:[e.jsx(S,{block:!0,disabled:!f,icon:"ðŸ‘Ž",onClick:s,style:{height:64},children:"No"}),e.jsx(S,{block:!0,onClick:u,style:{height:64},children:"Skip"}),e.jsx(S,{block:!0,disabled:!f,icon:"ðŸ‘",iconPosition:"end",onClick:n,style:{height:64},children:"Yes"})]})]})})}function Rt({suspects:t,questions:r,answers:c,addEntryToUpdate:l}){const{width:m,height:p}=me(),{is:h,removeParam:i}=R(),[a,j]=pe(),[d,o]=y.useState(6),[u,n]=y.useState(!0),s=()=>{const g=O.sampleSize(Object.keys(t),d)?.reduce((w,k)=>(w[k]=null,w),{});j({suspectsIds:g,testimonyId:(u?O.sample(Object.keys(r)):a?.testimonyId)??null})};ye(()=>s());const f=()=>{const g=Object.entries(a?.suspectsIds??{}).reduce((w,[k,T])=>(T!==null&&(w[k]=[T]),w),{});if(a?.testimonyId&&Object.keys(g).length>0){const w=O.cloneDeep(c[a.testimonyId]??{});Object.entries(g).forEach(([k,T])=>{w[k]=[...w[k]||[],...T]}),l(a.testimonyId,w)}else console.log("No testimonyId or no judged suspects found, likely skipped");s()},x=!!a?.suspectsIds&&!!a?.testimonyId,b=g=>{j(w=>{if(!w)return w;const k=Object.entries(w.suspectsIds).reduce((T,[N,D])=>(T[N]=D===null?g:D,T),{});return{...w,suspectsIds:k}})};return e.jsx(ie,{footer:null,maskClosable:!1,onCancel:()=>i("testify"),open:h("testify","group"),title:e.jsx(C,{children:"Do these people do this??"}),width:m-64,children:e.jsxs("div",{children:[x&&e.jsxs(v,{align:"center",className:"mb-8",gap:8,justify:"center",vertical:!0,children:[e.jsxs(v,{align:"center",gap:6,justify:"center",children:[e.jsx(C.Text,{children:"Number of Suspects:"}),e.jsx(ae,{onChange:g=>o(g??6),size:"small",value:d}),e.jsx(C.Text,{children:"Random Questions:"}),e.jsx(E,{checked:u,onChange:n,size:"small"})]}),e.jsx(C.Title,{className:"text-center",level:4,children:r[a.testimonyId??""]?.question}),e.jsx(v,{gap:8,justify:"center",wrap:"wrap",children:Object.keys(a.suspectsIds).map(g=>e.jsxs(v,{align:"center",justify:"center",vertical:!0,children:[e.jsx(C.Text,{className:"text-center",children:t[g]?.name?.pt||"Unknown"}),e.jsx(L,{cardId:g,cardWidth:Math.min(Math.max(p/3,128),128)},g),e.jsx(Ne,{onChange:w=>j(k=>k&&{...k,suspectsIds:{...k.suspectsIds,[g]:w}}),options:[{value:0,icon:"ðŸ‘Ž"},{value:null,icon:"â™¾"},{value:1,icon:"ðŸ‘"}],shape:"round",size:"large",value:a.suspectsIds[g]})]},g))})]}),e.jsxs(v,{align:"center",className:"mt-8",justify:"space-between",children:[e.jsx("span",{}),e.jsxs(v,{gap:8,children:[e.jsx(S,{onClick:()=>b(0),children:"Set all â™¾ to ðŸ‘Ž"}),e.jsx(S,{onClick:()=>b(1),children:"Set all â™¾ to ðŸ‘"})]}),e.jsx(S,{onClick:f,size:"large",children:"Next Set"})]})]})})}function Nt({suspects:t,questions:r,data:c,hasNewData:l,isDirty:m,save:p,isSaving:h,entriesToUpdate:i,addEntryToUpdate:a}){const{queryParams:j,addParams:d}=R(),o=y.useMemo(()=>{let n=0;const s={};return Object.values(c).forEach(f=>{Object.keys(f).forEach(x=>{if(f[x]){s[x]||(s[x]=0);const b=Ce(f[x]);b>=5&&(s[x]+=1),b>=3&&(n+=1)}})}),{absoluteTotal:n,queriedTestimoniesCount:Object.keys(c).length,suspectsCount:Object.keys(s).length,reliableSuspectsCount:Object.values(s).filter(f=>f>=5).length}},[c]),u=o.queriedTestimoniesCount*o.suspectsCount;return e.jsxs(e.Fragment,{children:[e.jsx(V,{children:e.jsxs(v,{gap:12,vertical:!0,children:[e.jsx(Fe,{dirt:JSON.stringify(i),isDirty:m,isSaving:h,onSave:p}),e.jsx(le,{block:!0,data:async()=>await Pt(c),disabled:m,fileName:"testimony-answers.json",hasNewData:l}),e.jsx(Ee,{label:"FS Data",path:"data/testimonies"}),e.jsx(Ae,{docId:"testimonies",label:"FS TDR",path:"tdr",queryKey:["tdr","testimonies"]})]})}),e.jsxs(V,{children:[e.jsx(Pe,{label:"Display",onChange:n=>d({display:n,page:1},{page:1}),options:[{title:"Questions",icon:e.jsx(He,{}),value:"questions"},{title:"Suspects",icon:e.jsx(Ze,{}),value:"suspects"},{title:"Simulator",icon:e.jsx(qe,{}),value:"simulator"}],value:j.get("display")??"questions"}),e.jsx(Be,{})]}),e.jsx(V,{children:e.jsxs("div",{style:{fontSize:"0.85em"},children:[e.jsx("strong",{children:"Legend"}),e.jsxs("ul",{children:[e.jsx("li",{children:"Reliability: At least 5 votes"}),e.jsx("li",{children:"Large Bars: There's enough data (at least 3)"}),e.jsx("li",{children:"Small blue bar: in progress negative"})]})]})}),e.jsxs(V,{children:[e.jsxs("div",{style:{fontSize:"0.85em"},children:[e.jsx("strong",{children:"Counts"}),e.jsxs("ul",{children:[e.jsxs("li",{children:["Testimonies: ",o.queriedTestimoniesCount]}),e.jsxs("li",{children:["Suspects: ",o.suspectsCount]}),e.jsx("li",{children:e.jsxs(F,{title:"A reliable suspect is one that has at least 5 complete testimonies.",children:["Reliable suspects: ",o.reliableSuspectsCount]})}),e.jsxs("li",{children:["Complete: ",o.absoluteTotal]}),e.jsxs("li",{children:["Total: ",u]}),e.jsxs("li",{children:["Percentage: ",(o.absoluteTotal/u*100).toFixed(1),"%"]})]})]}),e.jsx(Tt,{addEntryToUpdate:a,answers:c,questions:r,suspects:t})]})]})}async function Pt(t){console.log("Preparing file for download...x");const r=await ze("data","testimonies")(),c=Le(r);console.log("Parsed data from Firestore:",c);const l=O.cloneDeep(t);return Object.keys(l).forEach(m=>{const p=l[m],h=c[m]||{};Object.keys(p).forEach(i=>{const a=h[i]||[],j=Oe([...p[i],...a]);p[i]=j})}),$e(Ve(l))}function vn(){const t=Te();return e.jsx(be,{subtitle:"Suspect Testimony Rates",title:"Testimonies",children:e.jsxs(J,{hasSider:!0,children:[e.jsx(ve,{children:e.jsx(Nt,{...t})}),e.jsx(J.Content,{className:"content",children:e.jsx(we,{error:t.error,hasResponseData:!O.isEmpty(t.data),isLoading:t.isLoading,children:e.jsx(ft,{...t})})})]})})}export{vn as TestimoniesPage,vn as default};
