import{r as g,a as z,_ as F,j as e,T as O,B as I,ao as Y,aj as fe,G as B,D as re,an as ge,P as je,L as G}from"./index-DsV55vb0.js";import{D as xe}from"./DataLoadingWrapper-DRIKXOAh.js";import{l as C,c as ie,P as ye}from"./useBaseUrl-DHVr4qF3.js";import{u as P}from"./useQueryParams-35HGH-39.js";import{u as be,R as we,a as ce,c as ve,n as Se,b as ke}from"./useTestimoniesResource-DwaZnahr.js";import{g as Oe}from"./constants-UGMuk3uc.js";import{S as $}from"./SuspectImageCard-BtJBD9k_.js";import{u as Ce}from"./useTDResource-ytlw1Wdo.js";import{F as S}from"./index-BhQiV4UT.js";import{T as oe,S as Te,F as Ie}from"./FilterEntries-mw82ljdp.js";import{B as U,D as Re}from"./DownloadButton-CSQMkNUE.js";import{S as A}from"./index-C2BSwcK5.js";import{u as ae}from"./useTableExpandableRows-1vyA5Htw.js";import{u as le}from"./useTablePagination-CuriBiFH.js";import{P as J}from"./progress-BQYgrUs_.js";import{S as H}from"./index-BYr7G0av.js";import{F as Q}from"./Table-Cd714oU7.js";import{I as Me}from"./index-DH7x8X0p.js";import{u as Pe}from"./useCardWidth-DkFAdVmA.js";import{C as ue}from"./index-BY_VO0Jc.js";import{P as K}from"./index-Dia_90Zf.js";import{R as De}from"./FireFilled-pK_jM7ZK.js";import{S as L}from"./SiderContent-DJlYgVXp.js";import{F as X}from"./FirestoreConsoleLink-mWYFOixt.js";import{S as Ne}from"./SaveButton-CHO0AJlF.js";import{S as Ee}from"./SuspectsStyleVariantSelector-DIew-VtI.js";import{g as Ae}from"./useGetFirestoreDoc-CPaLzGa-.js";import{e as ze,a as Fe,d as Be}from"./index-DwSDsoxO.js";import{u as de}from"./useWindowSize-DauzMPbA.js";import{M as he}from"./index-CL8_3uEH.js";import{R as He}from"./TableOutlined-Ckul1GBf.js";import"./useResourceFirestoreData-CsNRjuqg.js";import"./useUpdateFirestoreDoc-CV6isKZQ.js";import"./useMutation-DczzbJSq.js";import"./moment-C5S46NFB.js";import"./ImageCard-DlVHXVQn.js";import"./gapSize-U1swVQyS.js";import"./index-B1ugW9XK.js";import"./index-CxHMk4ck.js";import"./index-Br-kN19V.js";import"./index-BLeO27EC.js";import"./scrollTo-CMtt_I9a.js";import"./Pagination-RedeP2v2.js";import"./extendsObject-keMuGWqj.js";import"./Input-ot97OnIB.js";import"./SaveOutlined-Cmwn8Rxi.js";import"./constants-BzeosQnZ.js";import"./Item-BU57AiPz.js";var $e={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M864 144H560c-8.8 0-16 7.2-16 16v304c0 8.8 7.2 16 16 16h304c8.8 0 16-7.2 16-16V160c0-8.8-7.2-16-16-16zm0 400H560c-8.8 0-16 7.2-16 16v304c0 8.8 7.2 16 16 16h304c8.8 0 16-7.2 16-16V560c0-8.8-7.2-16-16-16zM464 144H160c-8.8 0-16 7.2-16 16v304c0 8.8 7.2 16 16 16h304c8.8 0 16-7.2 16-16V160c0-8.8-7.2-16-16-16zm0 400H160c-8.8 0-16 7.2-16 16v304c0 8.8 7.2 16 16 16h304c8.8 0 16-7.2 16-16V560c0-8.8-7.2-16-16-16z"}}]},name:"appstore",theme:"filled"},Ve={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M512 624c93.9 0 170-75.2 170-168V232c0-92.8-76.1-168-170-168s-170 75.2-170 168v224c0 92.8 76.1 168 170 168zm330-170c0-4.4-3.6-8-8-8h-60c-4.4 0-8 3.6-8 8 0 140.3-113.7 254-254 254S258 594.3 258 454c0-4.4-3.6-8-8-8h-60c-4.4 0-8 3.6-8 8 0 168.7 126.6 307.9 290 327.6V884H326.7c-13.7 0-24.7 14.3-24.7 32v36c0 4.4 2.8 8 6.2 8h407.6c3.4 0 6.2-3.6 6.2-8v-36c0-17.7-11-32-24.7-32H548V782.1c165.3-18 294-158 294-328.1z"}}]},name:"audio",theme:"filled"},Le={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M594.3 601.5a111.8 111.8 0 0029.1-75.5c0-61.9-49.9-112-111.4-112s-111.4 50.1-111.4 112c0 29.1 11 55.5 29.1 75.5a158.09 158.09 0 00-74.6 126.1 8 8 0 008 8.4H407c4.2 0 7.6-3.3 7.9-7.5 3.8-50.6 46-90.5 97.2-90.5s93.4 40 97.2 90.5c.3 4.2 3.7 7.5 7.9 7.5H661a8 8 0 008-8.4c-2.8-53.3-32-99.7-74.7-126.1zM512 578c-28.5 0-51.7-23.3-51.7-52s23.2-52 51.7-52 51.7 23.3 51.7 52-23.2 52-51.7 52zm416-354H768v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H548v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H328v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H96c-17.7 0-32 14.3-32 32v576c0 17.7 14.3 32 32 32h832c17.7 0 32-14.3 32-32V256c0-17.7-14.3-32-32-32zm-40 568H136V296h120v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h148v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h148v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h120v496z"}}]},name:"contacts",theme:"outlined"},Ue={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M300 328a60 60 0 10120 0 60 60 0 10-120 0zM852 64H172c-17.7 0-32 14.3-32 32v660c0 17.7 14.3 32 32 32h680c17.7 0 32-14.3 32-32V96c0-17.7-14.3-32-32-32zm-32 660H204V128h616v596zM604 328a60 60 0 10120 0 60 60 0 10-120 0zm250.2 556H169.8c-16.5 0-29.8 14.3-29.8 32v36c0 4.4 3.3 8 7.4 8h729.1c4.1 0 7.4-3.6 7.4-8v-36c.1-17.7-13.2-32-29.7-32zM664 508H360c-4.4 0-8 3.6-8 8v60c0 4.4 3.6 8 8 8h304c4.4 0 8-3.6 8-8v-60c0-4.4-3.6-8-8-8z"}}]},name:"robot",theme:"outlined"},qe={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M870 126H663.8c-17.4 0-32.9 11.9-37 29.3C614.3 208.1 567 246 512 246s-102.3-37.9-114.8-90.7a37.93 37.93 0 00-37-29.3H154a44 44 0 00-44 44v252a44 44 0 0044 44h75v388a44 44 0 0044 44h478a44 44 0 0044-44V466h75a44 44 0 0044-44V170a44 44 0 00-44-44z"}}]},name:"skin",theme:"filled"},Qe={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M868 160h-92v-40c0-4.4-3.6-8-8-8H256c-4.4 0-8 3.6-8 8v40h-92a44 44 0 00-44 44v148c0 81.7 60 149.6 138.2 162C265.6 630.2 359 721.8 476 734.5v105.2H280c-17.7 0-32 14.3-32 32V904c0 4.4 3.6 8 8 8h512c4.4 0 8-3.6 8-8v-32.3c0-17.7-14.3-32-32-32H548V734.5C665 721.8 758.4 630.2 773.8 514 852 501.6 912 433.7 912 352V204a44 44 0 00-44-44zM248 439.6c-37.1-11.9-64-46.7-64-87.6V232h64v207.6zM840 352c0 41-26.9 75.8-64 87.6V232h64v120z"}}]},name:"trophy",theme:"filled"};function We(){var t=g.useRef(!0);return t.current?(t.current=!1,!0):t.current}function _e(t,i){return typeof t=="function"?t.length?t(i):t():t}function me(t,i,o){if(i===void 0&&(i=10),i<1)throw new Error("Capacity has to be greater than 1, got '"+i+"'");var l=We(),h=g.useState(t),p=h[0],d=h[1],a=g.useRef([]),s=g.useRef(0);l&&(a.current.length?(a.current[a.current.length-1]!==t&&a.current.push(t),a.current.length>i&&(a.current=a.current.slice(a.current.length-i))):a.current.push(t),s.current=a.current.length&&a.current.length-1);var x=g.useCallback(function(r){d(function(c){return r=_e(r,c),r!==c&&(s.current<a.current.length-1&&(a.current=a.current.slice(0,s.current+1)),s.current=a.current.push(r)-1,a.current.length>i&&(a.current=a.current.slice(a.current.length-i))),r})},[p,i]),u=g.useMemo(function(){return{history:a.current,position:s.current,capacity:i,back:function(r){r===void 0&&(r=1),s.current&&d(function(){return s.current-=Math.min(r,s.current),a.current[s.current]})},forward:function(r){r===void 0&&(r=1),s.current!==a.current.length-1&&d(function(){return s.current=Math.min(s.current+r,a.current.length-1),a.current[s.current]})},go:function(r){r!==s.current&&d(function(){return s.current=r<0?Math.max(a.current.length+r,0):Math.min(a.current.length-1,r),a.current[s.current]})}}},[p]);return[p,x,u]}var Ye=function(i,o){return g.createElement(z,F({},i,{ref:o,icon:$e}))},Ge=g.forwardRef(Ye),Je=function(i,o){return g.createElement(z,F({},i,{ref:o,icon:Ve}))},Ke=g.forwardRef(Je),Xe=function(i,o){return g.createElement(z,F({},i,{ref:o,icon:Le}))},Ze=g.forwardRef(Xe),et=function(i,o){return g.createElement(z,F({},i,{ref:o,icon:Ue}))},tt=g.forwardRef(et),nt=function(i,o){return g.createElement(z,F({},i,{ref:o,icon:qe}))},st=g.forwardRef(nt),rt=function(i,o){return g.createElement(z,F({},i,{ref:o,icon:Qe}))},Z=g.forwardRef(rt);function it(){const[t,i]=g.useState({batchSize:1,history:{}}),o=g.useRef(1),{entries:l}=be(!0,"pt",t.batchSize,t.history),h=Ce("suspects",!C.isEmpty(l));return console.log(ot(l,h.data??{})),e.jsxs(S,{vertical:!0,gap:12,className:"p-4",children:[e.jsxs(S,{justify:"space-between",align:"center",children:[e.jsx(O.Title,{level:4,className:"my-0",children:"Espionagem Simulator"}),e.jsxs(S,{gap:6,children:[e.jsx(oe,{min:1,max:100,defaultValue:1,onChange:p=>{o.current=p??1}}),e.jsx(I,{type:"primary",onClick:()=>i({batchSize:o.current,history:{}}),children:"Re-run Simulation"})]})]}),e.jsx(ct,{entries:l})]})}function ct({entries:t}){const[i,o]=g.useState(!1),l=Oe(),h=t[l],p=g.useMemo(()=>h?h.statements.reduce((d,a)=>{const{excludes:s}=a;return s.forEach(x=>{d[x]?d[x]++:d[x]=1}),d},{}):{},[h]);return e.jsxs("div",{className:"full-width grid",style:{gridTemplateColumns:"2fr 3fr"},children:[e.jsx(we,{src:t??{},theme:"twilight",collapsed:3}),e.jsx("div",{children:h&&e.jsxs(S,{gap:18,className:"p-4",children:[e.jsx("div",{children:e.jsx("div",{style:{width:`${105*4}px`,display:"grid",gap:"6px",gridTemplateColumns:"repeat(4, 1fr)"},children:h.suspects.map(d=>e.jsxs(U.Ribbon,{text:i?p[d.id]:null,color:"cyan",children:[e.jsx($,{id:d.id,width:96,className:ie(i&&d.id===h.culpritId&&"red-border")},d.id),e.jsxs(S,{gap:6,align:"center",children:[e.jsx(A,{checkedChildren:"ðŸš«",size:"small"})," ",d.id]})]},d.id))})}),e.jsxs("div",{children:[e.jsx("div",{children:e.jsx(A,{checkedChildren:"Show Culprit",unCheckedChildren:"Hide Culprit",checked:i,onChange:o})}),h.statements.map(d=>e.jsx(O.Paragraph,{children:e.jsx(U,{count:d.excludes.length,color:"cyan",children:e.jsx(Y,{message:d.text,banner:!0,type:"info",icon:ee(d.type)},d.key)})},d.key)),h.additionalStatements.map(d=>e.jsx(O.Paragraph,{children:e.jsx(U,{count:d.excludes.length,color:"cyan",children:e.jsx(Y,{message:d.text,banner:!0,type:"warning",icon:ee(d.type)},d.key)})},d.key))]})]})})]})}const ee=t=>{switch(t){case"testimony":return e.jsx(Ke,{});case"feature":return e.jsx(st,{});case"grid":return e.jsx(Ge,{});default:return"â“"}},ot=(t,i)=>{const o=Object.values(t).reduce((l,h)=>(h.suspects.forEach(p=>{l[p.id]=(l[p.id]||0)+1,p.id===h.culpritId&&(l[`${p.id}_culprit`]=(l[`${p.id}_culprit`]||0)+1)}),l),{});return Object.values(i).forEach(l=>{o[l.id]||(o[l.id]=0),o[`${l.id}_culprit`]||(o[`${l.id}_culprit`]=0)}),o};function pe({suspect:t,values:i,resolution:o,projection:l,yesPercentage:h,noPercentage:p,complete:d,enoughData:a,testimonyId:s,addEntryToUpdate:x,answers:u,barWidth:r,showName:c}){const n=j=>{const m={...u};m[j]=[...m[j]||[],3],x(s,m)},f=j=>{const m={...u};m[j]=[...m[j]||[],-3],x(s,m)},k=j=>{var b;const m={...u},w=(b=m[j])==null?void 0:b.findIndex(v=>v===3);w!==-1&&w!==void 0&&(m[j]=[...m[j].slice(0,w),...m[j].slice(w+1)]),x(s,m)},y=j=>{var b;const m={...u},w=(b=m[j])==null?void 0:b.findIndex(v=>v===-3);w!==-1&&w!==void 0&&(m[j]=[...m[j].slice(0,w),...m[j].slice(w+1)]),x(s,m)};return e.jsxs(fe,{trigger:"click",title:`Add strong fit/unfit answer to ${t.name.pt}`,content:e.jsxs(S,{vertical:!0,gap:4,children:[e.jsx(O.Text,{type:"secondary",children:i.join(", ")}),e.jsxs(I,{icon:"ðŸ‘",block:!0,onClick:()=>n(t.id),children:[" ","Add strong fit"]}),e.jsxs(I,{icon:"ðŸ‘Ž",block:!0,onClick:()=>f(t.id),children:[" ","Add strong unfit"]}),e.jsxs(H.Compact,{children:[e.jsx(I,{icon:"âŒ",size:"small",block:!0,onClick:()=>k(t.id),children:"fit"}),e.jsx(I,{icon:"âŒ",size:"small",block:!0,onClick:()=>y(t.id),children:"unfit"})]})]}),children:[c&&e.jsxs("div",{children:[e.jsx(B,{title:t.id,children:t.name.pt})," ",d&&e.jsx(B,{title:"Complete: It has 5 or more answers",children:e.jsx(Z,{style:{color:"gold"}})})]}),e.jsxs(S,{align:"flex-start",gap:12,children:[e.jsx(B,{title:`Values: ${i.join(", ")} : ${o||(l?`${l}*`:"")}`,children:a?e.jsx(J,{percent:p+h,size:[r,20],status:"exception",success:{percent:h},showInfo:!1}):e.jsx(J,{percent:p+h,size:[r,10],status:"exception",success:{percent:h},showInfo:!1})}),!c&&d&&e.jsx(B,{title:"Complete: It has 5 or more answers",children:e.jsx(Z,{style:{color:"gold"}})})]})]})}function at({suspect:t,answersPerQuestion:i={},questions:o,addEntryToUpdate:l,allAnswers:h}){const{queryParams:p}=P({sortSuspectsBy:"answers"}),d=p.get("sortSuspectsBy")??"answers",a=g.useMemo(()=>{const u=Object.values(o).map(r=>{const c=i[r.id]??{},{enoughData:n,reliable:f,yesPercentage:k,noPercentage:y,blankPercentage:j,values:m,total:w,resolution:b,projection:v,complete:T}=ce(t.id,{[t.id]:c});return{id:r.id,question:r,enoughData:n,reliable:f,yesPercentage:k,noPercentage:y,blankPercentage:j,values:m,total:w,resolution:b,projection:v,complete:T}});return d==="answers"?C.orderBy(u,["reliable","enoughData","yesPercentage",r=>r.values.length],["desc","desc","desc","desc"]):C.orderBy(u,r=>Number(r.id.split("-")[1]),["asc"])},[i,o,t.id,d]),s=g.useMemo(()=>lt(t,a),[t,a]),x=[{key:"id",title:"Id",dataIndex:"id"},{key:"question",title:"Question",dataIndex:"question",render:u=>u.question},{key:"answer",title:"Answer",dataIndex:"id",sorter:(u,r)=>u.total-r.total,render:u=>{const r=a.find(c=>c.id===u);return r?e.jsx(S,{gap:8,wrap:"nowrap",children:e.jsx(pe,{values:r.values,resolution:r.resolution,projection:r.projection,yesPercentage:r.yesPercentage,noPercentage:r.noPercentage,complete:r.complete,enoughData:r.enoughData,suspect:t,testimonyId:r.question.id,answers:h[r.question.id]||{},addEntryToUpdate:l,barWidth:120})}):""}}];return e.jsxs(H,{wrap:!0,size:"large",children:[e.jsx(Q,{rowKey:"id",columns:x,dataSource:a,bordered:!0}),e.jsxs(S,{gap:8,vertical:!0,children:[e.jsx(O.Title,{level:5,children:"Suspect Description"}),e.jsx(Me.TextArea,{value:s,readOnly:!0,className:"full-width",rows:7})]})]})}const lt=(t,i)=>{const o=i.filter(l=>l.resolution||l.projection).map(l=>{const{question:h,resolution:p,projection:d}=l,a=p||d;return`${t.gender==="male"?"ele":"ela"} ${a==="ðŸ‘"?"":"nÃ£o "}${h.answer.toLocaleLowerCase()}`});return`${t.name.pt}: ${o.join(", ")}`};function ut({isLoading:t,isSuccess:i,questions:o,data:l,suspects:h,addEntryToUpdate:p}){const{queryParams:d,addParam:a}=P(),s=g.useMemo(()=>Object.keys(l).reduce((n,f)=>{const k=l[f]??{};return Object.keys(k).forEach(y=>{n[y]||(n[y]={}),n[y][f]=k[y]}),n},{}),[l]),x=g.useMemo(()=>C.orderBy(Object.values(h).map(n=>({...n,answers:s[n.id]})),n=>Number(n.id.split("-")[1]),"asc"),[h,s]),u=le({total:x.length,showQuickJumper:!0}),r=[{title:"Id",dataIndex:"id",key:"id",sorter:(n,f)=>Number(n.id.split("-")[1])-Number(f.id.split("-")[1])},{title:"Picture",dataIndex:"id",render:n=>e.jsx($,{id:n,width:48})},{title:"Name",dataIndex:"name",key:"name",sorter:(n,f)=>n.name.pt.localeCompare(f.name.pt),render:(n,f)=>e.jsxs(S,{vertical:!0,children:[e.jsx(O.Text,{children:n.pt}),e.jsx(O.Text,{type:"secondary",children:n.en}),e.jsx(O.Text,{type:"secondary",italic:!0,children:e.jsx("small",{children:f.note})})]})},{title:"Questions Answered",dataIndex:"answers",key:"answers",sorter:(n,f)=>Object.keys(n.answers??{}).length-Object.keys(f.answers??{}).length,render:n=>n?Object.values(n).length:""}],c=ae({maxExpandedRows:1,expandedRowRender:n=>e.jsx(at,{suspect:n,answersPerQuestion:s[n.id],questions:o,addEntryToUpdate:p,allAnswers:l}),rowExpandable:()=>i});return e.jsxs(S,{gap:12,className:"full-width py-4",vertical:!0,children:[e.jsxs(S,{justify:"space-between",align:"center",children:[e.jsx(O.Title,{level:4,className:"my-0",children:"Testimonies by Suspect"}),e.jsx(A,{checked:d.get("sortSuspectsBy")==="answers",onChange:n=>a("sortSuspectsBy",n?"answers":"id"),checkedChildren:"Sort by Answers",unCheckedChildren:"Sort by Id"})]}),e.jsx(Q,{columns:r,dataSource:x,pagination:u,rowKey:"id",expandable:c,loading:t,bordered:!0,className:"full-width"})]})}function dt({answers:t,suspects:i,addEntryToUpdate:o,testimonyId:l}){const[h,p]=Pe(12),{queryParams:d,is:a}=P({sortSuspectsBy:"answers"}),s=a("enableBatch"),x=d.get("sortSuspectsBy")??"answers",u=g.useMemo(()=>{const n=Object.keys(i).map(f=>ce(f,t));return x==="answers"?C.orderBy(n,["reliable","enoughData",f=>f.values.length,"yesPercentage","noPercentage",f=>Number(f.suspectCardId.split("-")[1])],["desc","desc","desc","desc","desc","asc"]):C.orderBy(n,f=>Number(f.suspectCardId.split("-")[1]),["asc"])},[t,i,x]),[r,c]=g.useState([]);return e.jsxs(H,{direction:"vertical",children:[e.jsx(ht,{selection:r,setSelection:c,suspects:i,addEntryToUpdate:o,list:u,testimonyId:l,answers:t}),e.jsx(H,{wrap:!0,ref:p,size:"large",children:u.map(n=>e.jsxs(S,{vertical:!0,gap:6,className:ie({"selection-outline":s&&r.includes(n.suspectCardId)}),children:[e.jsx($,{id:n.imageId,width:h,className:n.values.length>1?void 0:"grayscale"}),e.jsxs(S,{gap:4,children:[s&&e.jsx(ue,{disabled:n.complete,checked:r.includes(n.suspectCardId),onChange:f=>{const k=f.target.checked;c(y=>k?[...y,n.suspectCardId]:y.filter(j=>j!==n.suspectCardId))}}),e.jsx(pe,{values:n.values,resolution:n.resolution,projection:n.projection,yesPercentage:n.yesPercentage,noPercentage:n.noPercentage,complete:n.complete,enoughData:n.enoughData,suspect:i[n.suspectCardId],testimonyId:l,answers:t,addEntryToUpdate:o,barWidth:h,showName:!0})]})]},n.suspectCardId))})]})}function ht({testimonyId:t,selection:i,setSelection:o,suspects:l,addEntryToUpdate:h,list:p,answers:d}){const[a,s]=g.useState([]),{addParam:x,removeParam:u,is:r}=P({sortSuspectsBy:"answers"}),c=r("enableBatch"),n=y=>{s(j=>j.includes(y)?j.filter(m=>m!==y):[...j,y])},f=g.useMemo(()=>C.keyBy(p,"suspectCardId"),[p]);g.useEffect(()=>{if(a.length===0&&i.length>0){o([]);return}if(!a.length)return;const j=(i.length>0?i:Object.values(f).filter(m=>!m.complete&&!m.values.includes(3)&&!m.values.includes(-3)).map(m=>m.suspectCardId)).filter(m=>{const w=l[m],b=[w.gender,w.ethnicity,w.build,w.height];return w.age==="18-21"&&b.push("young"),(w.age==="21-30"||w.age==="30-40")&&b.push("adult"),w.age==="40-50"&&b.push("parent"),(w.age==="50-60"||w.age==="60-70"||w.age==="70-80"||w.age==="80-90")&&b.push("senior"),a.every(v=>b.includes(v))});o(j)},[a]);const k=y=>{const j=C.cloneDeep(d);i.forEach(m=>{j[m]=[...j[m]||[],y]}),h(t,j),s([])};return e.jsxs(S,{align:"center",gap:6,justify:"space-between",className:"mb-4",children:[e.jsxs(S,{gap:3,children:[e.jsx(O.Text,{className:"nowrap",style:{minWidth:"5ch"},children:"Batch"}),e.jsx(A,{value:c,checkedChildren:"On",unCheckedChildren:"Off",onChange:y=>{y?x("enableBatch",!0):u("enableBatch")}})]}),c&&e.jsxs(e.Fragment,{children:[e.jsxs(O.Text,{className:"nowrap mr-2",children:["Selected ",i.length]}),e.jsxs(S,{gap:6,wrap:!0,align:"center",justify:"center",children:[e.jsx(M,{filter:"male",activeFilters:a,updateActiveFilter:n}),e.jsx(M,{filter:"female",activeFilters:a,updateActiveFilter:n}),e.jsx(M,{filter:"young",activeFilters:a,updateActiveFilter:n}),e.jsx(M,{filter:"adult",activeFilters:a,updateActiveFilter:n}),e.jsx(M,{filter:"parent",activeFilters:a,updateActiveFilter:n}),e.jsx(M,{filter:"senior",activeFilters:a,updateActiveFilter:n}),e.jsx(M,{filter:"thin",activeFilters:a,updateActiveFilter:n}),e.jsx(M,{filter:"muscular",activeFilters:a,updateActiveFilter:n}),e.jsx(M,{filter:"large",activeFilters:a,updateActiveFilter:n}),e.jsx(M,{filter:"asian",activeFilters:a,updateActiveFilter:n}),e.jsx(M,{filter:"black",activeFilters:a,updateActiveFilter:n}),e.jsx(M,{filter:"caucasian",activeFilters:a,updateActiveFilter:n}),e.jsx(M,{filter:"latino",activeFilters:a,updateActiveFilter:n})]}),e.jsxs(S,{align:"center",gap:6,children:[e.jsx(I,{onClick:()=>s([]),danger:!0,size:"small",children:"Clear"}),e.jsx(K,{title:"Apply +3 to selected suspects?",onConfirm:()=>k(3),children:e.jsx(I,{disabled:i.length===0,size:"small",type:"primary",className:"ml-10",children:"Apply +3"})}),e.jsx(re,{type:"vertical"}),e.jsx(K,{title:"Apply -3 to selected suspects?",onConfirm:()=>k(-3),children:e.jsx(I,{disabled:i.length===0,size:"small",type:"primary",children:"Apply -3"})})]})]})]})}function M({filter:t,activeFilters:i,updateActiveFilter:o}){return e.jsxs(e.Fragment,{children:[e.jsxs("span",{children:[e.jsx(ue,{checked:i.includes(t),onClick:()=>o(t)})," ",C.capitalize(t)]}),e.jsx(re,{type:"vertical"})]})}function mt({data:t,questions:i,suspects:o,isLoading:l,isSuccess:h,addEntryToUpdate:p}){const{queryParams:d,addParam:a}=P(),s=g.useMemo(()=>C.orderBy(Object.values(i).map(c=>({...c,answersCount:Object.values(t[c.id]??{}).length})),c=>Number(c.id.split("-")[1]),"asc"),[i]),x=le({total:s.length,showQuickJumper:!0}),u=[{title:"Id",dataIndex:"id",key:"id",sorter:(c,n)=>Number(c.id.split("-")[1])-Number(n.id.split("-")[1])},{title:"Question",dataIndex:"question",key:"question",sorter:(c,n)=>c.question.localeCompare(n.question)},{title:"NSFW",dataIndex:"nsfw",key:"nsfw",render:c=>c?e.jsx(De,{style:{color:"hotPink"}}):"",sorter:(c,n)=>Number(c.nsfw)-Number(n.nsfw)},{title:"Answers",dataIndex:"answersCount",key:"answersCount",sorter:(c,n)=>c.answersCount-n.answersCount}],r=ae({maxExpandedRows:1,expandedRowRender:c=>e.jsx(dt,{testimonyId:c.id,answers:t[c.id]??{},suspects:o,addEntryToUpdate:p}),rowExpandable:()=>h});return e.jsxs(S,{gap:12,className:"full-width py-4",vertical:!0,children:[e.jsxs(S,{justify:"space-between",align:"center",children:[e.jsx(O.Title,{level:4,className:"my-0",children:"Suspects by Testimony"}),e.jsx(A,{checked:d.get("sortSuspectsBy")==="answers",onChange:c=>a("sortSuspectsBy",c?"answers":"id"),checkedChildren:"Sort by Answers",unCheckedChildren:"Sort by Id"})]}),e.jsx(Q,{columns:u,dataSource:s,pagination:x,rowKey:"id",expandable:r,loading:l,bordered:!0,className:"full-width"})]})}function pt(t){const{queryParams:i,is:o}=P();return e.jsxs(e.Fragment,{children:[(o("display","questions")||!i.get("display"))&&e.jsx(mt,{...t}),o("display","suspects")&&e.jsx(ut,{...t}),o("display","simulator")&&e.jsx(it,{})]})}const ft="Left",gt="Right",jt="Up",xt="Down",E={delta:10,preventScrollOnSwipe:!1,rotationAngle:0,trackMouse:!1,trackTouch:!0,swipeDuration:1/0,touchEventOptions:{passive:!0}},q={first:!0,initial:[0,0],start:0,swiping:!1,xy:[0,0]},te="mousemove",ne="mouseup",yt="touchend",bt="touchmove",wt="touchstart";function vt(t,i,o,l){return t>i?o>0?gt:ft:l>0?xt:jt}function se(t,i){if(i===0)return t;const o=Math.PI/180*i,l=t[0]*Math.cos(o)+t[1]*Math.sin(o),h=t[1]*Math.cos(o)-t[0]*Math.sin(o);return[l,h]}function St(t,i){const o=u=>{const r="touches"in u;r&&u.touches.length>1||t((c,n)=>{n.trackMouse&&!r&&(document.addEventListener(te,l),document.addEventListener(ne,d));const{clientX:f,clientY:k}=r?u.touches[0]:u,y=se([f,k],n.rotationAngle);return n.onTouchStartOrOnMouseDown&&n.onTouchStartOrOnMouseDown({event:u}),Object.assign(Object.assign(Object.assign({},c),q),{initial:y.slice(),xy:y,start:u.timeStamp||0})})},l=u=>{t((r,c)=>{const n="touches"in u;if(n&&u.touches.length>1)return r;if(u.timeStamp-r.start>c.swipeDuration)return r.swiping?Object.assign(Object.assign({},r),{swiping:!1}):r;const{clientX:f,clientY:k}=n?u.touches[0]:u,[y,j]=se([f,k],c.rotationAngle),m=y-r.xy[0],w=j-r.xy[1],b=Math.abs(m),v=Math.abs(w),T=(u.timeStamp||0)-r.start,R=Math.sqrt(b*b+v*v)/(T||1),D=[m/(T||1),w/(T||1)],N=vt(b,v,m,w),W=typeof c.delta=="number"?c.delta:c.delta[N.toLowerCase()]||E.delta;if(b<W&&v<W&&!r.swiping)return r;const V={absX:b,absY:v,deltaX:m,deltaY:w,dir:N,event:u,first:r.first,initial:r.initial,velocity:R,vxvy:D};V.first&&c.onSwipeStart&&c.onSwipeStart(V),c.onSwiping&&c.onSwiping(V);let _=!1;return(c.onSwiping||c.onSwiped||c[`onSwiped${N}`])&&(_=!0),_&&c.preventScrollOnSwipe&&c.trackTouch&&u.cancelable&&u.preventDefault(),Object.assign(Object.assign({},r),{first:!1,eventData:V,swiping:!0})})},h=u=>{t((r,c)=>{let n;if(r.swiping&&r.eventData){if(u.timeStamp-r.start<c.swipeDuration){n=Object.assign(Object.assign({},r.eventData),{event:u}),c.onSwiped&&c.onSwiped(n);const f=c[`onSwiped${n.dir}`];f&&f(n)}}else c.onTap&&c.onTap({event:u});return c.onTouchEndOrOnMouseUp&&c.onTouchEndOrOnMouseUp({event:u}),Object.assign(Object.assign(Object.assign({},r),q),{eventData:n})})},p=()=>{document.removeEventListener(te,l),document.removeEventListener(ne,d)},d=u=>{p(),h(u)},a=(u,r)=>{let c=()=>{};if(u&&u.addEventListener){const n=Object.assign(Object.assign({},E.touchEventOptions),r.touchEventOptions),f=[[wt,o,n],[bt,l,Object.assign(Object.assign({},n),r.preventScrollOnSwipe?{passive:!1}:{})],[yt,h,n]];f.forEach(([k,y,j])=>u.addEventListener(k,y,j)),c=()=>f.forEach(([k,y])=>u.removeEventListener(k,y))}return c},x={ref:u=>{u!==null&&t((r,c)=>{if(r.el===u)return r;const n={};return r.el&&r.el!==u&&r.cleanUpTouch&&(r.cleanUpTouch(),n.cleanUpTouch=void 0),c.trackTouch&&u&&(n.cleanUpTouch=a(u,c)),Object.assign(Object.assign(Object.assign({},r),{el:u}),n)})}};return i.trackMouse&&(x.onMouseDown=o),[x,a]}function kt(t,i,o,l){return!i.trackTouch||!t.el?(t.cleanUpTouch&&t.cleanUpTouch(),Object.assign(Object.assign({},t),{cleanUpTouch:void 0})):t.cleanUpTouch?i.preventScrollOnSwipe!==o.preventScrollOnSwipe||i.touchEventOptions.passive!==o.touchEventOptions.passive?(t.cleanUpTouch(),Object.assign(Object.assign({},t),{cleanUpTouch:l(t.el,i)})):t:Object.assign(Object.assign({},t),{cleanUpTouch:l(t.el,i)})}function Ot(t){const{trackMouse:i}=t,o=g.useRef(Object.assign({},q)),l=g.useRef(Object.assign({},E)),h=g.useRef(Object.assign({},l.current));h.current=Object.assign({},l.current),l.current=Object.assign(Object.assign({},E),t);let p;for(p in E)l.current[p]===void 0&&(l.current[p]=E[p]);const[d,a]=g.useMemo(()=>St(s=>o.current=s(o.current,l.current),{trackMouse:i}),[i]);return o.current=kt(o.current,l.current,h.current,a),d}function Ct(t){const{addParam:i}=P();return e.jsxs(S,{vertical:!0,gap:8,children:[e.jsx(I,{onClick:()=>i("testify","single"),block:!0,children:"Testify Drawer"}),e.jsx(I,{onClick:()=>i("testify","group"),block:!0,children:"Testify Group"}),e.jsx(Tt,{...t}),e.jsx(It,{...t})]})}function Tt({suspects:t,questions:i,answers:o,addEntryToUpdate:l}){var j;const{width:h,height:p}=de(),{is:d,removeParam:a}=P(),[s,x,u]=me(),r=Ot({onSwipedLeft:()=>alert("Swiped Left"),onSwipedRight:()=>alert("Swiped Right"),onSwipedUp:()=>alert("Swiped Up"),preventScrollOnSwipe:!0,trackTouch:!0,trackMouse:!0}),c=()=>{x({suspectId:C.sample(Object.keys(t))||null,testimonyId:C.sample(Object.keys(i))||null})},n=()=>{c()},f=()=>{if(s!=null&&s.suspectId&&(s!=null&&s.testimonyId)){const m=C.cloneDeep(o[(s==null?void 0:s.testimonyId)??""]??{});m[s.suspectId]=[...m[s.suspectId]||[],1],l(s.testimonyId??"",m),c()}},k=()=>{if(s!=null&&s.suspectId&&(s!=null&&s.testimonyId)){const m=C.cloneDeep(o[(s==null?void 0:s.testimonyId)??""]??{});m[s.suspectId]=[...m[s.suspectId]||[],0],l(s.testimonyId??"",m),c()}},y=!!(s!=null&&s.suspectId)&&!!(s!=null&&s.testimonyId);return e.jsx(he,{title:e.jsx(O,{children:"Does this person do this??"}),open:d("testify","single"),onCancel:()=>a("testify"),maskClosable:!1,width:h-64,footer:null,children:e.jsxs("div",{...r,children:[y&&e.jsxs(S,{vertical:!0,gap:8,className:"mb-8",justify:"center",align:"center",children:[e.jsx($,{id:s.suspectId??"",width:Math.max(p/4,128)}),e.jsx(O.Title,{level:5,className:"text-center",children:(j=i[s.testimonyId??""])==null?void 0:j.question})]}),e.jsxs(H.Compact,{block:!0,size:"large",className:"mb-8",children:[e.jsx(I,{block:!0,icon:"ðŸ‘Ž",disabled:!y,style:{height:64},onClick:k,children:"No"}),e.jsx(I,{block:!0,onClick:n,style:{height:64},children:"Skip"}),e.jsx(I,{block:!0,icon:"ðŸ‘",iconPosition:"end",disabled:!y,style:{height:64},onClick:f,children:"Yes"})]})]})})}function It({suspects:t,questions:i,answers:o,addEntryToUpdate:l}){var w;const{width:h,height:p}=de(),{is:d,removeParam:a}=P(),[s,x,u]=me(),[r,c]=g.useState(6),[n,f]=g.useState(!0),k=()=>{var v;const b=(v=C.sampleSize(Object.keys(t),r))==null?void 0:v.reduce((T,R)=>(T[R]=null,T),{});x({suspectsIds:b,testimonyId:(n?C.sample(Object.keys(i)):s==null?void 0:s.testimonyId)??null})};ge(()=>k());const y=()=>{const b=Object.entries((s==null?void 0:s.suspectsIds)??{}).reduce((v,[T,R])=>(R!==null&&(v[T]=[R]),v),{});if(s!=null&&s.testimonyId&&Object.keys(b).length>0){const v=C.cloneDeep(o[s.testimonyId]??{});Object.entries(b).forEach(([T,R])=>{v[T]=[...v[T]||[],...R]}),l(s.testimonyId,v)}else console.log("No testimonyId or no judged suspects found, likely skipped");k()},j=!!(s!=null&&s.suspectsIds)&&!!(s!=null&&s.testimonyId),m=b=>{x(v=>{if(!v)return v;const T=Object.entries(v.suspectsIds).reduce((R,[D,N])=>(R[D]=N===null?b:N,R),{});return{...v,suspectsIds:T}})};return e.jsx(he,{title:e.jsx(O,{children:"Do these people do this??"}),open:d("testify","group"),onCancel:()=>a("testify"),maskClosable:!1,width:h-64,footer:null,children:e.jsxs("div",{children:[j&&e.jsxs(S,{vertical:!0,gap:8,className:"mb-8",justify:"center",align:"center",children:[e.jsxs(S,{gap:6,align:"center",justify:"center",children:[e.jsx(O.Text,{children:"Number of Suspects:"}),e.jsx(oe,{value:r,onChange:b=>c(b??6),size:"small"}),e.jsx(O.Text,{children:"Random Questions:"}),e.jsx(A,{checked:n,onChange:f,size:"small"})]}),e.jsx(O.Title,{level:4,className:"text-center",children:(w=i[s.testimonyId??""])==null?void 0:w.question}),e.jsx(S,{wrap:"wrap",justify:"center",gap:8,children:Object.keys(s.suspectsIds).map(b=>{var v,T;return e.jsxs(S,{justify:"center",align:"center",vertical:!0,children:[e.jsx(O.Text,{className:"text-center",children:((T=(v=t[b])==null?void 0:v.name)==null?void 0:T.pt)||"Unknown"}),e.jsx($,{id:b,width:Math.min(Math.max(p/3,128),128)},b),e.jsx(Te,{shape:"round",size:"large",value:s.suspectsIds[b],onChange:R=>x(D=>D&&{...D,suspectsIds:{...D.suspectsIds,[b]:R}}),options:[{value:0,icon:"ðŸ‘Ž"},{value:null,icon:"â™¾"},{value:1,icon:"ðŸ‘"}]})]},b)})})]}),e.jsxs(S,{justify:"space-between",align:"center",className:"mt-8",children:[e.jsx("span",{}),e.jsxs(S,{gap:8,children:[e.jsx(I,{onClick:()=>m(0),children:"Set all â™¾ to ðŸ‘Ž"}),e.jsx(I,{onClick:()=>m(1),children:"Set all â™¾ to ðŸ‘"})]}),e.jsx(I,{onClick:y,size:"large",children:"Next Set"})]})]})})}function Rt({suspects:t,questions:i,data:o,hasNewData:l,isDirty:h,save:p,isSaving:d,entriesToUpdate:a,addEntryToUpdate:s}){const{queryParams:x,addParams:u}=P(),r=g.useMemo(()=>{const c={};return Object.values(o).forEach(n=>{Object.keys(n).forEach(f=>{n[f]&&(c[f]||(c[f]=0),ve(n[f])>=5&&(c[f]+=1))})}),{queriedTestimoniesCount:Object.keys(o).length,suspectsCount:Object.keys(c).length,reliableSuspectsCount:Object.values(c).filter(n=>n>=5).length}},[o]);return e.jsxs(e.Fragment,{children:[e.jsx(L,{children:e.jsxs(S,{vertical:!0,gap:12,children:[e.jsx(Ne,{isDirty:h,onSave:p,isSaving:d,dirt:JSON.stringify(a)}),e.jsx(Re,{data:async()=>await Mt(o),fileName:"testimony-answers.json",disabled:h,hasNewData:l,block:!0}),e.jsx(X,{path:"data/testimonies",className:"text-center",label:"Firestore Data"}),e.jsx(X,{path:"tdr/testimonies",className:"text-center",label:"Firestore TDR"})]})}),e.jsxs(L,{children:[e.jsx(Ie,{label:"Display",value:x.get("display")??"questions",onChange:c=>u({display:c,page:1},{page:1}),options:[{title:"Questions",icon:e.jsx(He,{}),value:"questions"},{title:"Suspects",icon:e.jsx(Ze,{}),value:"suspects"},{title:"Simulator",icon:e.jsx(tt,{}),value:"simulator"}]}),e.jsx(Ee,{})]}),e.jsx(L,{children:e.jsxs("div",{style:{fontSize:"0.85em"},children:[e.jsx("strong",{children:"Legend"}),e.jsxs("ul",{children:[e.jsx("li",{children:"Reliability: At least 5 votes"}),e.jsx("li",{children:"Large Bars: There's enough data (at least 3)"}),e.jsx("li",{children:"Small blue bar: in progress negative"})]})]})}),e.jsxs(L,{children:[e.jsxs("div",{style:{fontSize:"0.85em"},children:[e.jsx("strong",{children:"Counts"}),e.jsxs("ul",{children:[e.jsxs("li",{children:["Testimonies: ",r.queriedTestimoniesCount]}),e.jsxs("li",{children:["Suspects: ",r.suspectsCount]}),e.jsx("li",{children:e.jsxs(B,{title:"A reliable suspect is one that has at least 5 complete testimonies.",children:["Reliable suspects: ",r.reliableSuspectsCount]})})]})]}),e.jsx(Ct,{suspects:t,questions:i,answers:o,addEntryToUpdate:s})]})]})}async function Mt(t){console.log("Preparing file for download...x");const i=await Ae("data","testimonies")(),o=ze(i);console.log("Parsed data from Firestore:",o);const l=C.cloneDeep(t);return Object.keys(l).forEach(h=>{const p=l[h],d=o[h]||{};Object.keys(p).forEach(a=>{const s=d[a]||[],x=Se([...p[a],...s]);p[a]=x})}),Fe(Be(l))}function Cn(){const t=ke();return e.jsx(je,{title:"Testimonies",subtitle:"Suspect Testimony Rates",children:e.jsxs(G,{hasSider:!0,children:[e.jsx(ye,{children:e.jsx(Rt,{...t})}),e.jsx(G.Content,{className:"content",children:e.jsx(xe,{isLoading:t.isLoading,error:t.error,hasResponseData:!C.isEmpty(t.data),children:e.jsx(pt,{...t})})})]})})}export{Cn as TestimoniesPage,Cn as default};
