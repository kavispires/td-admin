import{r as p,a as R,_ as C,j as e,P as F,L as S}from"./index-oik76Yce.js";import{D as N}from"./DataLoadingWrapper-B2D8XxnP.js";import{P as z}from"./useBaseUrl-8KF9RGGJ.js";import{u as T}from"./useQueryParams-Df1JeVTl.js";import{I as D}from"./ImageCard-Cfj0d6gN.js";import{u as M}from"./useTableExpandableRows-BUFcEwN6.js";import{u as O}from"./useTablePagination-twzJ0TmB.js";import{l as x}from"./lodash-Vop7Mp14.js";import{S as y}from"./index-Do93bfhz.js";import{F as P}from"./Table-xgW500Xi.js";import{F as E}from"./index-BPF7_s59.js";import{P as w}from"./progress-BgRgfdBv.js";import{T as k}from"./index-4_11IMf3.js";import{u as L}from"./useCardWidth-CniwLS_W.js";import{R as H}from"./FireFilled-CDhG2y_s.js";import{F as Q}from"./FilterEntries-2k4jljom.js";import{S as j}from"./SiderContent-2txor-6k.js";import{D as I}from"./DownloadButton-Dg0aFjjM.js";import{a as B,d as A,e as V}from"./index-C4Fw4qmq.js";import{R as $}from"./TableOutlined-COhT1_jE.js";import{u as q}from"./useGetFirebaseDoc-U-6oUXkl.js";import{u as v}from"./useTDResource-DkOmcFeu.js";import"./gapSize-U1swVQyS.js";import"./index-C8FScIXC.js";import"./index-BT_-hxwD.js";import"./index-D4bHF8ZM.js";import"./index-Cm8buRN3.js";import"./scrollTo-DdZFo67F.js";import"./Pagination-CV-sUief.js";import"./extendsObject-keMuGWqj.js";import"./Input-B7NcGiI2.js";import"./useMeasure-Di1fT8h1.js";import"./util-CeAI_f06.js";import"./index-Bi3uYhXZ.js";import"./index-BPMAy79T.js";import"./constants-TZCB7cTe.js";import"./Item-Ba0f751c.js";var K={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M594.3 601.5a111.8 111.8 0 0029.1-75.5c0-61.9-49.9-112-111.4-112s-111.4 50.1-111.4 112c0 29.1 11 55.5 29.1 75.5a158.09 158.09 0 00-74.6 126.1 8 8 0 008 8.4H407c4.2 0 7.6-3.3 7.9-7.5 3.8-50.6 46-90.5 97.2-90.5s93.4 40 97.2 90.5c.3 4.2 3.7 7.5 7.9 7.5H661a8 8 0 008-8.4c-2.8-53.3-32-99.7-74.7-126.1zM512 578c-28.5 0-51.7-23.3-51.7-52s23.2-52 51.7-52 51.7 23.3 51.7 52-23.2 52-51.7 52zm416-354H768v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H548v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H328v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H96c-17.7 0-32 14.3-32 32v576c0 17.7 14.3 32 32 32h832c17.7 0 32-14.3 32-32V256c0-17.7-14.3-32-32-32zm-40 568H136V296h120v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h148v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h148v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h120v496z"}}]},name:"contacts",theme:"outlined"},W=function(c,a){return p.createElement(R,C({},c,{ref:a,icon:K}))},J=p.forwardRef(W),_={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M868 160h-92v-40c0-4.4-3.6-8-8-8H256c-4.4 0-8 3.6-8 8v40h-92a44 44 0 00-44 44v148c0 81.7 60 149.6 138.2 162C265.6 630.2 359 721.8 476 734.5v105.2H280c-17.7 0-32 14.3-32 32V904c0 4.4 3.6 8 8 8h512c4.4 0 8-3.6 8-8v-32.3c0-17.7-14.3-32-32-32H548V734.5C665 721.8 758.4 630.2 773.8 514 852 501.6 912 433.7 912 352V204a44 44 0 00-44-44zM248 439.6c-37.1-11.9-64-46.7-64-87.6V232h64v207.6zM840 352c0 41-26.9 75.8-64 87.6V232h64v120z"}}]},name:"trophy",theme:"filled"},G=function(c,a){return p.createElement(R,C({},c,{ref:a,icon:_}))},Y=p.forwardRef(G);function U({answersPerQuestion:r,questions:c}){const a=p.useMemo(()=>x.orderBy(Object.keys(r).map(o=>{const t=c[o],n=r[o],d=n.length>2,m=n.length,i=Math.max(n.length,5),s=Math.round(n.filter(h=>h===1).length/i*100),u=Math.round(n.filter(h=>h===0).length/i*100),g=Math.round((i-s+u)/i*100);return{id:o,question:t,enoughData:d,reliability:m,yesPercentage:s,noPercentage:u,blankPercentage:g}}),["reliability","enoughData","yesPercentage"],["desc","desc","desc"]),[r,c]),l=[{key:"id",title:"Id",dataIndex:"id"},{key:"question",title:"Question",dataIndex:"question",render:o=>o.question},{key:"answer",title:"Answer",dataIndex:"id",sorter:(o,t)=>o.reliability-t.reliability,render:o=>{const t=a.find(n=>n.id===o);return t?e.jsxs(E,{children:[e.jsx(w,{percent:t.noPercentage,size:t.enoughData?[100,20]:[100,10],status:t.enoughData?"exception":"active",success:{percent:t.yesPercentage},showInfo:!1}),t.yesPercentage>=t.noPercentage?e.jsxs(k,{color:"green-inverse",children:[t.yesPercentage,"% Yes"]}):e.jsxs(k,{color:"red-inverse",children:[t.noPercentage,"% No"]})]}):""}}];return e.jsx(y,{wrap:!0,size:"large",children:e.jsx(P,{rowKey:"id",columns:l,dataSource:a,bordered:!0})})}function X({isLoading:r,isSuccess:c,questions:a,data:l,suspects:o}){const t=p.useMemo(()=>Object.keys(l).reduce((s,u)=>{const g=l[u]??{};return Object.keys(g).forEach(h=>{const f=`us-${h.split("-")[2]}`;s[f]||(s[f]={}),s[f][u]=g[h]}),s},{}),[l]),n=p.useMemo(()=>x.orderBy(Object.values(o),s=>Number(s.id.split("-")[1]),"asc"),[o]),d=O({total:n.length,showQuickJumper:!0}),m=[{title:"Id",dataIndex:"id",key:"id",sorter:(s,u)=>Number(s.id.split("-")[1])-Number(u.id.split("-")[1])},{title:"Picture",dataIndex:"id",render:s=>{const u=s.split("-").join("-ct-");return e.jsx(D,{id:u,width:48})}},{title:"Name",dataIndex:"name",key:"name",sorter:(s,u)=>s.name.pt.localeCompare(u.name.pt),render:s=>s.pt},{title:"Answers",dataIndex:"id",key:"answers",render:s=>{const u=t[s];return u?Object.values(u).length:""}}],i=M({maxExpandedRows:1,expandedRowRender:s=>e.jsx(U,{suspect:s,answersPerQuestion:t[s.id],questions:a}),rowExpandable:()=>c});return e.jsx(P,{columns:m,dataSource:n,pagination:d,rowKey:"id",expandable:i,loading:r,bordered:!0,className:"full-width"})}function Z({answers:r,suspects:c}){const[a,l]=L(12),o=p.useMemo(()=>x.orderBy(Object.keys(r??{}).map(t=>{const n=`us-${t.split("-")[2]}`,d=r[t],m=d.length>2,i=d.length>4,s=Math.max(d.length,5),u=Math.round(d.filter(b=>b===1).length/s*100),g=Math.round(d.filter(b=>b===0).length/s*100),h=Math.round((s-u+g)/s*100),f=d.length>=5;return{imageId:t,suspectCardId:n,enoughData:m,reliability:i,yesPercentage:u,noPercentage:g,blankPercentage:h,complete:f}}),["complete","reliability","enoughData","percentage"],["desc","desc","desc","desc"]),[r]);return e.jsx(y,{wrap:!0,ref:l,size:"large",children:o.map(t=>e.jsxs(E,{vertical:!0,gap:4,children:[e.jsx(D,{id:t.imageId,width:a,className:t.enoughData?void 0:"grayscale"}),e.jsxs("div",{children:[c[t.suspectCardId].name.pt," ",t.complete&&e.jsx(Y,{style:{color:"gold"}})]}),t.enoughData?e.jsx(w,{percent:t.noPercentage,size:[a,20],status:"exception",success:{percent:t.yesPercentage},showInfo:!1}):e.jsx(w,{percent:t.noPercentage,size:[a,10],status:"exception",success:{percent:t.yesPercentage},showInfo:!1})]},t.suspectCardId))})}function ee({data:r,questions:c,suspects:a,isLoading:l,isSuccess:o}){const t=p.useMemo(()=>x.orderBy(Object.values(c),i=>Number(i.id.split("-")[1]),"asc"),[c]),n=O({total:t.length,showQuickJumper:!0}),d=[{title:"Id",dataIndex:"id",key:"id",sorter:(i,s)=>Number(i.id.split("-")[1])-Number(s.id.split("-")[1])},{title:"Question",dataIndex:"question",key:"question",sorter:(i,s)=>i.question.localeCompare(s.question)},{title:"NSFW",dataIndex:"nsfw",key:"nsfw",render:i=>i?e.jsx(H,{style:{color:"hotPink"}}):"",sorter:(i,s)=>Number(i.nsfw)-Number(s.nsfw)},{title:"Answers",dataIndex:"id",key:"answers",render:i=>{const s=r[i];return s?Object.values(s).length:""}}],m=M({maxExpandedRows:1,expandedRowRender:i=>e.jsx(Z,{answers:r[i.id]??{},suspects:a}),rowExpandable:()=>o});return e.jsx(y,{direction:"vertical",children:e.jsx(P,{columns:d,dataSource:t,pagination:n,rowKey:"id",expandable:m,loading:l,bordered:!0,className:"full-width"})})}function te(r){const{queryParams:c,is:a}=T();return e.jsxs(y,{direction:"vertical",children:[(a("display","questions")||!c.get("display"))&&e.jsx(ee,{...r}),a("display","suspects")&&e.jsx(X,{...r})]})}function se({data:r}){const{queryParams:c,addParams:a}=T(),l=p.useMemo(()=>{const o={};return Object.values(r).forEach(t=>{Object.keys(t).forEach(n=>{t[n]&&(o[n]||(o[n]=0),t[n].length>=5&&(o[n]+=1))})}),{queriedTestimoniesCount:Object.keys(r).length,suspectsCount:Object.keys(o).length,reliableSuspectsCount:Object.values(o).filter(t=>t>=5).length}},[r]);return e.jsxs(e.Fragment,{children:[e.jsx(j,{children:e.jsx(I,{data:()=>re(r),fileName:"testimony-answers.json",block:!0})}),e.jsx(j,{children:e.jsx(Q,{label:"Display",value:c.get("display")??"questions",onChange:o=>a({display:o,page:1},{page:1}),options:[{title:"Questions",icon:e.jsx($,{}),value:"questions"},{title:"Suspects",icon:e.jsx(J,{}),value:"suspects"}]})}),e.jsx(j,{children:e.jsxs("div",{style:{fontSize:"0.85em"},children:[e.jsx("strong",{children:"Legend"}),e.jsxs("ul",{children:[e.jsx("li",{children:"Reliability: At least 5 votes"}),e.jsx("li",{children:"Large Bars: There's enough data (at least 3)"}),e.jsx("li",{children:"Small blue bar: in progress negative"})]})]})}),e.jsx(j,{children:e.jsxs("div",{style:{fontSize:"0.85em"},children:[e.jsx("strong",{children:"Counts"}),e.jsxs("ul",{children:[e.jsxs("li",{children:["Testimonies: ",l.queriedTestimoniesCount]}),e.jsxs("li",{children:["Suspects: ",l.suspectsCount]}),e.jsxs("li",{children:["Reliable suspects: ",l.reliableSuspectsCount]})]})]})})]})}function re(r){return console.log("Preparing file for download..."),B(A(r))}function ne(){const r=v("suspects"),c=v("testimony-questions-pt"),a=v("testimony-answers"),l=q("data","testimonies",{select:V}),o=p.useMemo(()=>{if(!a.data||!l.data)return{};const t=x.cloneDeep(a.data);return Object.keys(l.data).forEach(n=>{const d=l.data[n];if(t[n]===void 0){t[n]=d;return}Object.keys(d).forEach(m=>{t[n][m]===void 0?t[n][m]=d[m]:(console.log("merging",n,m),t[n][m].push(...d[m]))})}),t},[a.data,l.data]);return{isLoading:a.isLoading||l.isLoading||c.isLoading||r.isLoading,isSuccess:a.isSuccess&&l.isSuccess&&c.isSuccess&&r.isSuccess,error:a.error||l.error,data:o,questions:c.data,suspects:r.data}}function Ve(){const r=ne();return e.jsx(F,{title:"Testimonies",subtitle:"Suspect Testimony Rates",children:e.jsxs(S,{hasSider:!0,children:[e.jsx(z,{children:e.jsx(se,{...r})}),e.jsx(S.Content,{className:"content",children:e.jsx(N,{isLoading:r.isLoading,error:r.error,hasResponseData:!x.isEmpty(r.data),children:e.jsx(te,{...r})})})]})})}export{Ve as TestimoniesPage,Ve as default};
