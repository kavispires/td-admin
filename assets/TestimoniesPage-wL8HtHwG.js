import{r as b,a as Q,_ as G,j as s,T as M,B as N,aj as Z,y as D,af as ee,Y as te,X as se,P as ne,L as W}from"./index-CYc_ZTzS.js";import{D as oe}from"./DataLoadingWrapper-BrC72tH2.js";import{l as x,c as re,P as ie}from"./useBaseUrl-Do8JSuXy.js";import{u as $}from"./useQueryParams-BTn-5Fv2.js";import{R as ae}from"./main-1mDy5U3-.js";import{u as ce,D as le,a as ue,g as de}from"./constants-D0-gnIAG.js";import{u as E}from"./useTDResource-CGG6wY3X.js";import{I as V}from"./ImageCard-BdjUps7Q.js";import{g as me}from"./utils-CTlwRcmq.js";import{F as S}from"./index-BGEaKPFC.js";import{B as Y,D as he}from"./DownloadButton-DWgfm1m1.js";import{S as B}from"./index-Cj_UJJGg.js";import{u as K}from"./useTableExpandableRows-DZktnjms.js";import{u as X}from"./useTablePagination-4b3IYakY.js";import{S as H}from"./index-D1FNRZfK.js";import{F as _}from"./Table-kOqhR-zu.js";import{P as L}from"./progress-DBX2-kFu.js";import{T as J}from"./index-FwfxrDsu.js";import{u as pe}from"./useCardWidth-DDjNVv0-.js";import{R as ge}from"./FireFilled-Cl2nl7Qy.js";import{F as fe}from"./FilterEntries-B5VH5f-2.js";import{S as F}from"./SiderContent-BBs3lczC.js";import{S as xe}from"./SaveButton-sU4fYeCD.js";import{a as je,d as be,e as ye}from"./index-0dszxRyZ.js";import{R as ve}from"./TableOutlined-CcbgM_So.js";import{u as we}from"./useGetFirestoreDoc-B7evsWs9.js";import{u as Se}from"./useUpdateFirestoreDoc-CMtq3h5_.js";import"./moment-C5S46NFB.js";import"./gapSize-U1swVQyS.js";import"./index-BtL2ZYD6.js";import"./index-dh0thgI4.js";import"./index-If0JoOck.js";import"./index-DQiBXskX.js";import"./scrollTo-CY0Ye6O6.js";import"./Pagination-CFuvBBYs.js";import"./extendsObject-keMuGWqj.js";import"./Input-Dx3Q3Uyz.js";import"./index-GfOA261t.js";import"./SaveOutlined-BarTdzOR.js";import"./constants-Bu2VSlqI.js";import"./Item-7Xg0dcbH.js";import"./useMutation-CKMPbBek.js";var ke={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M594.3 601.5a111.8 111.8 0 0029.1-75.5c0-61.9-49.9-112-111.4-112s-111.4 50.1-111.4 112c0 29.1 11 55.5 29.1 75.5a158.09 158.09 0 00-74.6 126.1 8 8 0 008 8.4H407c4.2 0 7.6-3.3 7.9-7.5 3.8-50.6 46-90.5 97.2-90.5s93.4 40 97.2 90.5c.3 4.2 3.7 7.5 7.9 7.5H661a8 8 0 008-8.4c-2.8-53.3-32-99.7-74.7-126.1zM512 578c-28.5 0-51.7-23.3-51.7-52s23.2-52 51.7-52 51.7 23.3 51.7 52-23.2 52-51.7 52zm416-354H768v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H548v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H328v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H96c-17.7 0-32 14.3-32 32v576c0 17.7 14.3 32 32 32h832c17.7 0 32-14.3 32-32V256c0-17.7-14.3-32-32-32zm-40 568H136V296h120v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h148v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h148v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h120v496z"}}]},name:"contacts",theme:"outlined"},Ee={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M300 328a60 60 0 10120 0 60 60 0 10-120 0zM852 64H172c-17.7 0-32 14.3-32 32v660c0 17.7 14.3 32 32 32h680c17.7 0 32-14.3 32-32V96c0-17.7-14.3-32-32-32zm-32 660H204V128h616v596zM604 328a60 60 0 10120 0 60 60 0 10-120 0zm250.2 556H169.8c-16.5 0-29.8 14.3-29.8 32v36c0 4.4 3.3 8 7.4 8h729.1c4.1 0 7.4-3.6 7.4-8v-36c.1-17.7-13.2-32-29.7-32zM664 508H360c-4.4 0-8 3.6-8 8v60c0 4.4 3.6 8 8 8h304c4.4 0 8-3.6 8-8v-60c0-4.4-3.6-8-8-8z"}}]},name:"robot",theme:"outlined"},Oe={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M868 160h-92v-40c0-4.4-3.6-8-8-8H256c-4.4 0-8 3.6-8 8v40h-92a44 44 0 00-44 44v148c0 81.7 60 149.6 138.2 162C265.6 630.2 359 721.8 476 734.5v105.2H280c-17.7 0-32 14.3-32 32V904c0 4.4 3.6 8 8 8h512c4.4 0 8-3.6 8-8v-32.3c0-17.7-14.3-32-32-32H548V734.5C665 721.8 758.4 630.2 773.8 514 852 501.6 912 433.7 912 352V204a44 44 0 00-44-44zM248 439.6c-37.1-11.9-64-46.7-64-87.6V232h64v207.6zM840 352c0 41-26.9 75.8-64 87.6V232h64v120z"}}]},name:"trophy",theme:"filled"},Ce=function(e,o){return b.createElement(Q,G({},e,{ref:o,icon:ke}))},Pe=b.forwardRef(Ce),Re=function(e,o){return b.createElement(Q,G({},e,{ref:o,icon:Ee}))},Te=b.forwardRef(Re),Ne=function(e,o){return b.createElement(Q,G({},e,{ref:o,icon:Oe}))},De=b.forwardRef(Ne);const U=(r,e,o)=>{const{reliabilityThreshold:c=4,projectionThreshold:a=55}={},t=`us-gb-${r.split("-")[1]}`,l=e[r]??[];let p=0,g=0;l.forEach(w=>{w===3&&(p+=3),w===-3&&(g+=3)});const u=l.filter(w=>w!==3&&w!==-3),d=u.length+p+g,m=Math.max(d,5),h=l.filter(w=>w===1).length+p,f=Math.round(h/m*100),y=l.filter(w=>w===0).length+g,O=Math.round(y/m*100),A=Math.round((m-h-y)/m*100),P=u.length+p+g>=5,R=d>3,v=d>c,k=v?f>O?"👍":"👎":null,C=R?f>=a?"👍":O>=a?"👎":null:null;return{suspectCardId:r,imageId:t,enoughData:R,reliable:v,total:m,yesCount:h,yesPercentage:f,noCount:y,noPercentage:O,blankPercentage:A,complete:P,values:l,resolution:k,projection:C}},q=9,Ae=(r,e,o,c)=>{const[a]=ce(le.ESPIONAGEM,c),i=E("suspects",r),t=E(`testimony-questions-${e}`,r),l=E("testimony-answers",r),p=E("crime-reasons",r),g=b.useMemo(()=>Me(l.data),[l.data]),u=b.useMemo(()=>$e(i.data),[i.data]);return{entries:b.useMemo(()=>!a||!i.isSuccess||!t.isSuccess||!l.isSuccess||!p.isSuccess?{}:Fe(o,a,i.data,t.data,g,u,p.data),[r,a,i,t,l,o,g,u,p]),isLoading:i.isLoading||t.isLoading||l.isLoading}},Fe=(r,e,o,c,a,i,t)=>{console.count("Creating Espionagem...");let l=e.latestDate;const p=[],g={};for(let u=0;u<r;u++){const d=ue(l);l=d;let m=null,n=0;for(;!m&&n<100;){n++;const h=Ie(o,c,a,i,p,t);if(Le(h.statements)){m=h,console.log(`Generated valid game for ${d} after ${n} attempts`);break}}if(!m)throw new Error(`Failed to generate valid game for ${d} after 100 attempts`);p.push(m.culpritId),g[d]={id:d,type:"espionagem",number:e.latestNumber+u+1,...m}}return g};function Ie(r,e,o,c,a,i){let t=[];const l=[],p={},g=x.sample(Object.keys(o));if(!g)throw new Error("No selected testimony ID found");const u=Object.keys(o[g]).filter(v=>!a.includes(v)),d=u.length>0?u:Object.keys(o[g]),m=x.sample(d);if(!m)throw new Error("No selected culprit ID found");const n=x.sampleSize(Object.keys(o[g]).filter(v=>v!==m),q-1);for(t.push(...n);t.length<8;){const v=x.sampleSize(Object.keys(r).filter(k=>!t.includes(k)&&k!==m),q-t.length-1);t.push(...v)}const h={};Object.keys(c).forEach(v=>{if(c[v][m]===void 0){const k=Object.keys(c[v]).filter(C=>t.includes(C));if(k.length>0){const C={};k.forEach(w=>{t.includes(w)&&(C[w]=!0)}),h[v]=C}}});const f=e[g];l.push(ze(m,t,f,o[g])),T(p,l[0].excludes);const j=z(m,t,h);l.push(j),T(p,j.excludes),t=x.shuffle([...t,m]);const y=z(m,t,h,[j.key],"worst");l.push(y),T(p,y.excludes);const O=z(m,t,h,[y.key],"worst");l.push(O),T(p,O.excludes);const A=Be(m,t,l);l.push(A),T(p,A.excludes);const P=[l[0],l[1],l[2],l[4],l[3]],R=qe(r[m],i);return{isNsfw:f.nsfw??!1,culpritId:m,statements:P,suspects:t.map(v=>r[v]),reason:R.title,setId:`${m}::${R.id}::${P[0].key}`,level:Qe(P)}}const Me=r=>{const e={};console.log("⚙️ Calculating suspect answers...");for(const o of Object.keys(r)){const c=r[o];for(const a of Object.keys(c)){const{resolution:i,projection:t}=U(a,c);if(!i&&!t){console.log("⁉️ Ignoring testimony with no resolution or projection");continue}if(e[o]===void 0&&(e[o]={}),i){e[o][a]=i==="👍";continue}if(t){e[o][a]=t==="👍";continue}console.log("⁉️ Ignoring testimony with not enough values")}}return Object.keys(e).forEach(o=>{x.isEmpty(e[o])&&delete e[o]}),Object.keys(e).forEach(o=>{Object.keys(e[o]).length<3&&(console.log("⁉️ Removing testimonies with less than 3 answers"),delete e[o])}),Object.keys(e).forEach(o=>{x.uniq(Object.values(e[o])).length===1&&(console.log("⁉️ Removing testimonies with the same answer"),delete e[o])}),e},$e=r=>{const e={};for(const c of Object.keys(r)){const{gender:a,ethnicity:i,age:t,build:l,height:p,features:g}=r[c];if(!l){console.log("⁉️ Ignoring suspect with missing build",c);continue}if(!p){console.log("⁉️ Ignoring suspect with missing height",c);continue}if(!g||g.length===0){console.log("⁉️ Ignoring suspect with missing features",c);continue}e[a]===void 0&&(e[a]={}),e[a][c]=!0,e[i]===void 0&&(e[i]={}),e[i][c]=!0,e[t]===void 0&&(e[t]={}),e[t][c]=!0,e[l]===void 0&&(e[l]={}),e[l][c]=!0,e[p]===void 0&&(e[p]={}),e[p][c]=!0,g.forEach(u=>{e[u]===void 0&&(e[u]={}),e[u][c]=!0})}return e.young=x.cloneDeep(e["18-21"]),e.adult=x.cloneDeep({...e["21-30"],...e["30-40"],...e["40-50"]}),e.senior=x.cloneDeep({...e["50-60"],...e["60-70"],...e["70-80"],...e["80-90"]}),["18-21","21-30","30-40","40-50","50-60","60-70","70-80","80-90","average","medium","mixed","adult","tall"].forEach(c=>{delete e[c]}),e},T=(r,e)=>{e.forEach(o=>{r[o]===void 0&&(r[o]=0),r[o]++})},ze=(r,e,o,c)=>{const a=c[r],i=e.filter(p=>c[p]!==void 0&&c[p]!==a),t=o.answer.charAt(0).toLowerCase()+o.answer.slice(1),l={key:`testimony.${o.id}`,text:`O(a) suspeito(a) ${a?"":"não "}${t}`,excludes:i};return l.text.includes("não já")&&(l.text=l.text.replace("não já","nunca")),l},I={row1:{indexes:[0,1,2],text:"na primeira linha"},row2:{indexes:[3,4,5],text:"na segunda linha"},row3:{indexes:[6,7,8],text:"na terceira linha"},column1:{indexes:[0,3,6],text:"na primeira coluna"},column2:{indexes:[1,4,7],text:"na segunda coluna"},column3:{indexes:[2,5,8],text:"na terceira coluna"},corners:{indexes:[0,2,6,8],text:"nos cantos"}},Be=(r,e,o)=>{const c=e.indexOf(r),a=o.slice(0,3),i={};for(const d of Object.keys(I)){const{indexes:m}=I[d];m.includes(c)||(i[d]=m.reduce((n,h)=>{const f=e[h],j=a.filter(y=>y.excludes.includes(f)).length;return j>0?n+j:n},0))}const t=Object.entries(i).reduce((d,[m,n])=>(d[n]||(d[n]=[]),d[n].push(m),d),{}),l=Math.min(...Object.keys(i).map(d=>i[d])),p=t[l.toString()],g=x.sample(p)||Object.keys(i)[0],u=I[g].indexes.map(d=>e[d]);return{key:`not.grid.${g}`,text:`O(a) suspeito(a) não está ${I[g].text}`,excludes:u}},z=(r,e,o,c=[],a="best")=>{const i=x.difference(e,[r]),t=c.map(d=>d.replace("not.feature.","")),l=Object.keys(o).filter(d=>Object.keys(o[d]).length<=6&&!t.includes(d)).sort((d,m)=>Object.keys(o[m]).length-Object.keys(o[d]).length),p=a==="best"?l[0]:x.sample(l.slice(2,5))??l[2];if(!p)throw Error(`No suitable feature found for ${a} selection`);const g=i.filter(d=>o[p][d]),u=He[p];return u||console.warn(`Feature ${p} not found in translations`),{key:`not.feature.${p}`,text:`O(a) suspeito(a) não ${u||p}`,excludes:g}},He={male:"é homem",female:"é mulher",black:"é negro(a)",white:"é branco(a)",asian:"é asiático(a)",latino:"é latino(a)",thin:"é magrelo(a)",fat:"é gordo(a)",large:"é gordo(a)",tall:"é alto(a)",short:"é baixinho(a)",young:"é jovem",adult:"é adulto(a)",senior:"é idoso(a)",average:"é médio(a)",medium:"é médio(a)",mixed:"é mestiço(a)",hat:"está usando um chapéu",tie:"está usando uma gravata",glasses:"está usando óculos",brownHair:"tem cabelo castanho",shortHair:"tem cabelo curto",beard:"tem barba",caucasian:"é caucasiano(a)",scarf:"está usando um cachecol",blondeHair:"tem cabelo loiro",longHair:"tem cabelo longo",greyHair:"tem cabelo grisalho",bald:"é careca",mustache:"tem bigode",goatee:"tem cavanhaque",muscular:"é musculoso(a)",blackHair:"tem cabelo preto",hoodie:"está usando um moletom",earrings:"está usando brincos",lipstick:"está usando batom",necklace:"está usando um colar",mediumHair:"tem cabelo médio","middle-eastern":"é do Oriente Médio",headscarf:"está usando um lenço na cabeça",redHair:"tem cabelo ruivo",piercings:"tem piercings",coloredHair:"tem cabelo colorido",indian:"é indiano(a)","native-american":"é nativo-americano(a)"},Le=r=>{const e=r.slice(0,3);return e.reduce((a,i)=>a+i.excludes.length,0)<10?!1:new Set(e.flatMap(a=>a.excludes)).size===q-1},qe=(r,e)=>{const o=[];Object.values(e).forEach(a=>{var i;a.feature==="general"&&o.push(a),(i=r.features)!=null&&i.includes(a.feature)&&o.push(a)});const c=x.sample(o);return c||{id:"unknown",title:{pt:"Motivo desconhecido",en:"Unknown reason"},feature:"general"}},Qe=r=>{const e=r.slice(0,3),o=[],c={1:4,2:3,3:3,4:2,5:2,6:1,7:0,8:0};e.forEach(i=>{const t=i.excludes.length;c[t]!==void 0&&o.push(c[t])});const a=Math.round(o.reduce((i,t)=>i+t,0)/o.length);return Math.min(Math.max(a,1),3)};function Ge(){const[r,e]=b.useState({}),{entries:o}=Ae(!0,"pt",1,r);return s.jsxs(S,{vertical:!0,gap:12,className:"p-4",children:[s.jsxs(S,{justify:"space-between",align:"center",children:[s.jsx(M.Title,{level:4,className:"my-0",children:"Espionagem Simulator"}),s.jsx(N,{type:"primary",onClick:()=>e({}),children:"Re-run Simulation"})]}),s.jsx(Ve,{entries:o})]})}function Ve({entries:r}){const[e,o]=b.useState(!1),c=de(),a=r[c],i=b.useMemo(()=>a?a.statements.slice(0,3).reduce((t,l)=>{const{excludes:p}=l;return p.forEach(g=>{t[g]?t[g]++:t[g]=1}),t},{}):{},[a]);return s.jsxs("div",{className:"full-width grid grid-2",children:[s.jsx(ae,{src:r??{},theme:"twilight",collapsed:3}),a&&s.jsxs(S,{gap:18,className:"p-4",children:[s.jsx("div",{children:s.jsx("div",{style:{width:`${105*3}px`,display:"grid",gap:"6px",gridTemplateColumns:"repeat(3, 1fr)"},children:a.suspects.map(t=>s.jsxs(Y.Ribbon,{text:e?i[t.id]:null,color:"cyan",children:[s.jsx(V,{id:me(t.id,"gb"),width:96,className:re(e&&t.id===a.culpritId&&"red-border")},t.id),s.jsxs(S,{gap:6,align:"center",children:[s.jsx(B,{checkedChildren:"🚫",size:"small"})," ",t.id]})]},t.id))})}),s.jsxs("div",{children:[s.jsx("div",{children:s.jsx(B,{checkedChildren:"Show Culprit",unCheckedChildren:"Hide Culprit",checked:e,onChange:o})}),a.statements.map((t,l)=>s.jsx(M.Paragraph,{children:s.jsx(Y,{count:t.excludes.length,color:"cyan",children:s.jsx(Z,{message:t.text,banner:!0,type:l<3?"info":"error"},t.key)})},t.key))]})]})]})}function _e({suspect:r,answersPerQuestion:e,questions:o}){const c=b.useMemo(()=>x.orderBy(Object.keys(e).map(i=>{const t=o[i],{enoughData:l,reliable:p,yesPercentage:g,noPercentage:u,blankPercentage:d,values:m,total:n}=U(r.id,{[r.id]:e[i]});return{id:i,question:t,enoughData:l,reliable:p,yesPercentage:g,noPercentage:u,blankPercentage:d,values:m,total:n}}),["reliable","enoughData","yesPercentage",i=>i.values.length],["desc","desc","desc","desc"]),[e,o,r.id]),a=[{key:"id",title:"Id",dataIndex:"id"},{key:"question",title:"Question",dataIndex:"question",render:i=>i.question},{key:"answer",title:"Answer",dataIndex:"id",sorter:(i,t)=>i.total-t.total,render:i=>{const t=c.find(l=>l.id===i);return t?s.jsxs(S,{gap:8,wrap:"nowrap",children:[s.jsx(D,{title:`Values: ${t.values.join(", ")}`,children:s.jsx(L,{percent:t.noPercentage+t.yesPercentage,size:t.enoughData?[100,20]:[100,10],status:t.enoughData?"exception":"active",success:{percent:t.yesPercentage},showInfo:!1})}),t.yesPercentage>=t.noPercentage?s.jsxs(J,{color:"green-inverse",children:[t.yesPercentage,"% Yes"]}):s.jsxs(J,{color:"red-inverse",children:[t.noPercentage,"% No"]})]}):""}}];return s.jsx(H,{wrap:!0,size:"large",children:s.jsx(_,{rowKey:"id",columns:a,dataSource:c,bordered:!0})})}function Ue({isLoading:r,isSuccess:e,questions:o,data:c,suspects:a}){const i=b.useMemo(()=>Object.keys(c).reduce((u,d)=>{const m=c[d]??{};return Object.keys(m).forEach(n=>{u[n]||(u[n]={}),u[n][d]=m[n]}),u},{}),[c]),t=b.useMemo(()=>x.orderBy(Object.values(a).map(u=>({...u,answers:i[u.id]})),u=>Number(u.id.split("-")[1]),"asc"),[a,i]),l=X({total:t.length,showQuickJumper:!0}),p=[{title:"Id",dataIndex:"id",key:"id",sorter:(u,d)=>Number(u.id.split("-")[1])-Number(d.id.split("-")[1])},{title:"Picture",dataIndex:"id",render:u=>{const d=u.split("-").join("-gb-");return s.jsx(V,{id:d,width:48})}},{title:"Name",dataIndex:"name",key:"name",sorter:(u,d)=>u.name.pt.localeCompare(d.name.pt),render:u=>u.pt},{title:"Questions Answered",dataIndex:"answers",key:"answers",sorter:(u,d)=>Object.keys(u.answers).length-Object.keys(d.answers).length,render:u=>u?Object.values(u).length:""}],g=K({maxExpandedRows:1,expandedRowRender:u=>s.jsx(_e,{suspect:u,answersPerQuestion:i[u.id],questions:o}),rowExpandable:()=>e});return s.jsx(_,{columns:p,dataSource:t,pagination:l,rowKey:"id",expandable:g,loading:r,bordered:!0,className:"full-width"})}function We({answers:r,suspects:e,addEntryToUpdate:o,testimonyId:c}){const[a,i]=pe(12),{queryParams:t}=$({sortSuspectsBy:"answers"}),l=t.get("sortSuspectsBy")??"answers",p=b.useMemo(()=>{const n=Object.keys(e).map(h=>U(h,r));return l==="answers"?x.orderBy(n,["reliable","enoughData",h=>h.values.length,"yesPercentage"],["desc","desc","desc","desc"]):n},[r,e,l]),g=n=>{const h={...r};h[n]=[...h[n]||[],3],o(c,h)},u=n=>{const h={...r};h[n]=[...h[n]||[],-3],o(c,h)},d=n=>{var j;const h={...r},f=(j=h[n])==null?void 0:j.findIndex(y=>y===3);f!==-1&&f!==void 0&&(h[n]=[...h[n].slice(0,f),...h[n].slice(f+1)]),o(c,h)},m=n=>{var j;const h={...r},f=(j=h[n])==null?void 0:j.findIndex(y=>y===-3);f!==-1&&f!==void 0&&(h[n]=[...h[n].slice(0,f),...h[n].slice(f+1)]),o(c,h)};return s.jsx(H,{wrap:!0,ref:i,size:"large",children:p.map(n=>s.jsxs(S,{vertical:!0,gap:4,children:[s.jsx(V,{id:n.imageId,width:a,className:n.values.length>1?void 0:"grayscale"}),s.jsxs(ee,{trigger:"click",title:`Add strong fit/unfit answer to ${e[n.suspectCardId].name.pt}`,content:s.jsxs(S,{vertical:!0,gap:4,children:[s.jsx(M.Text,{type:"secondary",children:n.values.join(", ")}),s.jsxs(N,{icon:"👍",block:!0,onClick:()=>g(n.suspectCardId),children:[" ","Add strong fit"]}),s.jsxs(N,{icon:"👎",block:!0,onClick:()=>u(n.suspectCardId),children:[" ","Add strong unfit"]}),s.jsxs(H.Compact,{children:[s.jsx(N,{icon:"❌",size:"small",block:!0,onClick:()=>d(n.suspectCardId),children:"fit"}),s.jsx(N,{icon:"❌",size:"small",block:!0,onClick:()=>m(n.suspectCardId),children:"unfit"})]})]}),children:[s.jsxs("div",{children:[s.jsx(D,{title:n.suspectCardId,children:e[n.suspectCardId].name.pt})," ",n.complete&&s.jsx(D,{title:"Complete: It has 5 or more answers",children:s.jsx(De,{style:{color:"gold"}})})]}),s.jsx(D,{title:`Values: ${n.values.join(", ")} : ${n.resolution?n.resolution:n.projection?`${n.projection}*`:""}`,children:n.enoughData?s.jsx(L,{percent:n.noPercentage+n.yesPercentage,size:[a,20],status:"exception",success:{percent:n.yesPercentage},showInfo:!1}):s.jsx(L,{percent:n.noPercentage+n.yesPercentage,size:[a,10],status:"exception",success:{percent:n.yesPercentage},showInfo:!1})})]})]},n.suspectCardId))})}function Ye({data:r,questions:e,suspects:o,isLoading:c,isSuccess:a,addEntryToUpdate:i}){const{queryParams:t,addParam:l}=$(),p=b.useMemo(()=>x.orderBy(Object.values(e),m=>Number(m.id.split("-")[1]),"asc"),[e]),g=X({total:p.length,showQuickJumper:!0}),u=[{title:"Id",dataIndex:"id",key:"id",sorter:(m,n)=>Number(m.id.split("-")[1])-Number(n.id.split("-")[1])},{title:"Question",dataIndex:"question",key:"question",sorter:(m,n)=>m.question.localeCompare(n.question)},{title:"NSFW",dataIndex:"nsfw",key:"nsfw",render:m=>m?s.jsx(ge,{style:{color:"hotPink"}}):"",sorter:(m,n)=>Number(m.nsfw)-Number(n.nsfw)},{title:"Answers",dataIndex:"id",key:"answers",render:m=>{const n=r[m];return n?Object.values(n).length:""}}],d=K({maxExpandedRows:1,expandedRowRender:m=>s.jsx(We,{testimonyId:m.id,answers:r[m.id]??{},suspects:o,addEntryToUpdate:i}),rowExpandable:()=>a});return s.jsxs(S,{gap:12,className:"full-width py-4",vertical:!0,children:[s.jsxs(S,{justify:"space-between",align:"center",children:[s.jsx(M.Title,{level:4,className:"my-0",children:"Suspects by Testimony"}),s.jsx(B,{checked:t.get("sortSuspectsBy")==="answers",onChange:m=>l("sortSuspectsBy",m?"answers":"id"),checkedChildren:"Sort by Answers",unCheckedChildren:"Sort by Id"})]}),s.jsx(_,{columns:u,dataSource:p,pagination:g,rowKey:"id",expandable:d,loading:c,bordered:!0,className:"full-width"})]})}function Je(r){const{queryParams:e,is:o}=$();return s.jsxs(s.Fragment,{children:[(o("display","questions")||!e.get("display"))&&s.jsx(Ye,{...r}),o("display","suspects")&&s.jsx(Ue,{...r}),o("display","simulator")&&s.jsx(Ge,{})]})}function Ke({data:r,hasNewData:e,isDirty:o,save:c,isSaving:a,entriesToUpdate:i}){const{queryParams:t,addParams:l}=$(),p=b.useMemo(()=>{const g={};return Object.values(r).forEach(u=>{Object.keys(u).forEach(d=>{u[d]&&(g[d]||(g[d]=0),u[d].length>=5&&(g[d]+=1))})}),{queriedTestimoniesCount:Object.keys(r).length,suspectsCount:Object.keys(g).length,reliableSuspectsCount:Object.values(g).filter(u=>u>=5).length}},[r]);return s.jsxs(s.Fragment,{children:[s.jsx(F,{children:s.jsxs(S,{vertical:!0,gap:12,children:[s.jsx(xe,{isDirty:o,onSave:c,isSaving:a,dirt:JSON.stringify(i)}),s.jsx(he,{data:()=>Xe(r),fileName:"testimony-answers.json",disabled:o,hasNewData:e,block:!0})]})}),s.jsx(F,{children:s.jsx(fe,{label:"Display",value:t.get("display")??"questions",onChange:g=>l({display:g,page:1},{page:1}),options:[{title:"Questions",icon:s.jsx(ve,{}),value:"questions"},{title:"Suspects",icon:s.jsx(Pe,{}),value:"suspects"},{title:"Simulator",icon:s.jsx(Te,{}),value:"simulator"}]})}),s.jsx(F,{children:s.jsxs("div",{style:{fontSize:"0.85em"},children:[s.jsx("strong",{children:"Legend"}),s.jsxs("ul",{children:[s.jsx("li",{children:"Reliability: At least 5 votes"}),s.jsx("li",{children:"Large Bars: There's enough data (at least 3)"}),s.jsx("li",{children:"Small blue bar: in progress negative"})]})]})}),s.jsx(F,{children:s.jsxs("div",{style:{fontSize:"0.85em"},children:[s.jsx("strong",{children:"Counts"}),s.jsxs("ul",{children:[s.jsxs("li",{children:["Testimonies: ",p.queriedTestimoniesCount]}),s.jsxs("li",{children:["Suspects: ",p.suspectsCount]}),s.jsx("li",{children:s.jsxs(D,{title:"A reliable suspect is one that has at least 5 complete testimonies.",children:["Reliable suspects: ",p.reliableSuspectsCount]})})]})]})})]})}function Xe(r){console.log("Preparing file for download...");const e=x.cloneDeep(r);return je(be(e))}function Ze(){const{notification:r}=te.useApp(),e=se(),o=E("suspects"),c=E("testimony-questions-pt"),a=E("testimony-answers"),i=we("data","testimonies",{select:n=>ye(n,h=>{const f={};return Object.keys(h).forEach(j=>{const y=j.replace(/us-\w{2}-(\d+)/,"us-$1");f[y]=h[j]||[]}),f})}),[t,l]=b.useState({}),p=Se("data","testimonies",{onSuccess:()=>{r.success({message:"data/testimonies updated"}),e.refetchQueries({queryKey:["firestore","data","testimonies"]}),l({})},onError:n=>{r.error({message:"data/testimonies update failed",description:n.message})}}),g=b.useMemo(()=>{if(!a.data||!i.data)return{};const n=x.cloneDeep(a.data);return Object.keys(i.data).forEach(h=>{const f=i.data[h];if(n[h]===void 0){n[h]=f;return}Object.keys(f).forEach(j=>{n[h][j]===void 0?n[h][j]=f[j]:n[h][j].push(...f[j])})}),Object.keys(t).forEach(h=>{const f=t[h];n[h]&&(n[h]=f)}),n},[a.data,i.data,t]),u=!x.isEmpty(t),d=(n,h)=>{l(f=>({...f,[n]:h}))},m=()=>{const n=Object.keys(t).reduce((h,f)=>(h[f]=JSON.stringify(t[f]),h),{});p.mutate(n)};return{isLoading:a.isLoading||i.isLoading||c.isLoading||o.isLoading,isSuccess:a.isSuccess&&i.isSuccess&&c.isSuccess&&o.isSuccess,error:a.error||i.error,data:g,questions:c.data,suspects:o.data,hasNewData:!x.isEmpty(i.data),isSaving:p.isPending,save:m,addEntryToUpdate:d,isDirty:u,entriesToUpdate:t}}function qt(){const r=Ze();return s.jsx(ne,{title:"Testimonies",subtitle:"Suspect Testimony Rates",children:s.jsxs(W,{hasSider:!0,children:[s.jsx(ie,{children:s.jsx(Ke,{...r})}),s.jsx(W.Content,{className:"content",children:s.jsx(oe,{isLoading:r.isLoading,error:r.error,hasResponseData:!x.isEmpty(r.data),children:s.jsx(Je,{...r})})})]})})}export{qt as TestimoniesPage,qt as default};
