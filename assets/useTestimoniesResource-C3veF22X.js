import{u as q,D as P,a as H}from"./constants-D1QS-T8p.js";import{l as p}from"./useBaseUrl-Bgww8MYZ.js";import{u as k}from"./useTDResource-idwmPnrO.js";import{r as R}from"./index-CD2lQx4f.js";import{u as U}from"./useResourceFirestoreData-Ckcka-iX.js";const Q=(o,e,t)=>{const{reliabilityThreshold:n=4,projectionThreshold:s=55}={},r=`us-gb-${o.split("-")[1]}`,i=p.isEmpty(e[o])?[]:e[o];let c=0,m=0;i.forEach(b=>{b===3&&(c+=3),b===-3&&(m+=3),b===4&&(c+=4),b===-4&&(m+=4)});const u=i.filter(b=>![-4,-3,3,4].includes(b)),f=u.length+c+m,g=Math.max(f,5),d=i.filter(b=>b===1).length+c,h=Math.round(d/g*100),y=i.filter(b=>b===0).length+m,x=Math.round(y/g*100),S=Math.round((g-d-y)/g*100),v=u.length+c+m>=5,w=f>3,O=f>n,j=O&&Math.abs(h-x)>30?h>x?"üëç":"üëé":null,D=!w||Math.abs(h-x)<20?null:h>=s?"üëç":x>=s?"üëé":null;return{suspectCardId:o,imageId:r,enoughData:w,reliable:O,total:g,yesCount:d,yesPercentage:h,noCount:y,noPercentage:x,blankPercentage:S,complete:v,values:i,resolution:j,projection:D}};function ce(o){const e=o.filter(s=>![0,1].includes(s)),t=o.filter(s=>[0,1].includes(s)),n={0:0,1:0};return t.forEach(s=>{if(n[s]===void 0)throw Error(`what is this value? ${s}`);n[s]+=1}),Object.entries(n).forEach(([s,a])=>{if(a>0){const r=Math.floor(a/4),i=a%4;for(let c=0;c<r;c++)e.push(s==="0"?-4:4);if(i>0){const c=Array.from({length:i},()=>s==="0"?0:1);e.push(...c)}}}),e.sort((s,a)=>s-a)}const B={male:"√© homem",female:"√© mulher",caucasian:"√© branco(a)",black:"√© negro(a)",asian:"√© asi√°tico(a)",latino:"√© latino(a)",thin:"√© magrelo(a)",fat:"√© gordo(a)",large:"√© gordo(a)",tall:"√© alto(a)",short:"√© baixinho(a)",young:"√© jovem",adult:"√© adulto(a)",senior:"√© idoso(a)",average:"tem corpo normal",medium:"√© de altura m√©dia",mixed:"√© mesti√ßo(a)",hat:"est√° usando um chap√©u",tie:"est√° usando uma gravata",glasses:"est√° usando √≥culos",brownHair:"tem cabelo castanho",shortHair:"tem cabelo curto",beard:"tem barba",scarf:"est√° usando um cachecol",blondeHair:"tem cabelo loiro",longHair:"tem cabelo longo",greyHair:"tem cabelo grisalho",bald:"√© careca",mustache:"tem bigode",goatee:"tem cavanhaque",muscular:"√© sarado(a)",blackHair:"tem cabelo preto",hoodie:"est√° usando um moletom",earrings:"est√° usando brincos",lipstick:"est√° usando batom",necklace:"est√° usando um colar",mediumHair:"tem cabelo m√©dio","middle-eastern":"√© do Oriente M√©dio",headscarf:"est√° usando um len√ßo na cabe√ßa",redHair:"tem cabelo ruivo",piercings:"tem piercings",coloredHair:"tem cabelo colorido",indian:"√© indiano(a)","native-american":"√© nativo-americano(a)",noAccessories:"sem nenhum acess√≥rio",avoidingCamera:"est√° evitando olhar para a c√¢mera",wearingStripes:"tem listras na roupa",blackClothes:"est√° vestindo roupas pretas",blueClothes:"est√° vestindo roupas azuis",greenClothes:"est√° vestindo roupas verdes",redClothes:"est√° vestindo roupas vermelhas",yellowClothes:"est√° vestindo roupas amarelas",purpleClothes:"est√° vestindo roupas roxas",orangeClothes:"est√° vestindo roupas laranjas",brownClothes:"est√° vestindo roupas marrons",whiteShirt:"est√° usando camisa branca",pinkClothes:"est√° vestindo roupas rosas",patternedShirt:"est√° usando roupa estampada",buttonShirt:"est√° usando camisa com bot√µes",bow:"est√° usando um la√ßo",hairyChest:"tem peito peludo",wearingFlowers:"est√° usando flores",showTeeth:"est√° mostrando os dentes",hairTie:"est√° usando um xuxinha ou fita no cabelo","non-binary":"√© n√£o-bin√°rio(a)"},N=12,ue=(o,e,t,n)=>{const[s]=q(P.ESPIONAGEM,n),a=k("suspects",o),r=k(`testimony-questions-${e}`,o),i=k("testimony-answers",o),c=k("crime-reasons",o),m=R.useMemo(()=>X(i.data),[i.dataUpdatedAt]),u=R.useMemo(()=>V(a.data),[a.data]);return{entries:R.useMemo(()=>!o||!s||!a.isSuccess||!r.isSuccess||!i.isSuccess||!c.isSuccess?{}:z(t,s,a.data,r.data,m,u,c.data),[o,s,a,r,i,t,m,u,c]),isLoading:a.isLoading||r.isLoading||i.isLoading}},z=(o,e,t,n,s,a,r)=>{console.count("Creating Espionagem...");let i=e.latestDate;const c=[],m={};for(let u=0;u<o;u++){const f=H(i);i=f;let g=null,l=0;for(;g===null&&l<100;)try{l++;const d=W(t,n,s,a,c,r);if(ee(d.statements))throw g=d,new Error(`Game is invalid after ${l} attempts`)}catch{}if(!g)throw new Error(`Failed to generate valid game for ${f} after ${l} attempts`);console.log(`Generated valid game for ${f} after ${l} attempts`),c.push(g.culpritId),m[f]={id:f,type:"espionagem",number:e.latestNumber+u+1,...g}}return m};function W(o,e,t,n,s,a){const r=[],i={},{selectedTestimonyId1:c,selectedTestimonyId2:m,culpritId:u,possibleSuspects:f,impossibleSuspects:g}=K(t,s);let l=[...f];if(f.length<N-1){const C=p.sampleSize(Object.keys(o).filter($=>!g.includes($)&&!f.includes($)),N-f.length-1);l.push(...C)}const d={};Object.keys(n).forEach(C=>{if(n[C][u]===void 0){const $=Object.keys(n[C]).filter(M=>l.includes(M));if($.length>0){const M={};$.forEach(A=>{l.includes(A)&&(M[A]=!0)}),d[C]=M}}});const h=e[c],E=G(u,l,h,t[c]);r.push(E),F(i,E.excludes);const y=e[m],x=G(u,l,y,t[m]);r.push(x),F(i,x.excludes);const S=I(u,l,d,[],"best");r.push(S),F(i,S.excludes);const v=I(u,l,d,[S],"best");r.push(v);const w=I(u,l,d,[S,v],"worst");r.push(w),F(i,w.excludes);const O=I(u,l,d,[S,v,w],"worst");if(r.push(O),r.length<6)throw new Error("Not enough statements generated");l=p.shuffle([...l,u]);const j=_(u,l,r,"columns");r.push(j),F(i,j.excludes);const D=_(u,l,r,"rows");r.push(D);const b=[E,w,x,S,j,O],L=[v,D],T=te(o[u],a);return{isNsfw:h.nsfw||y.nsfw||!1,culpritId:u,statements:b,additionalStatements:L,suspects:Y(l,o,[...b,...L]),reason:T.title,setId:`${u}::${T.id}::${b[0].key}`,level:se(b)}}const Y=(o,e,t)=>{const n={};return t.forEach(s=>{if(s.key.includes(".feature.")){const a=s.key.split("not.feature.")[1];n[a]=!0}}),o.map(s=>{const a=e[s],r={"18-21":"young","21-30":"adult","30-40":"adult","40-50":"adult","50-60":"senior","60-70":"senior","70-80":"senior","80-90":"senior"}[a.age]||a.age,i=[a.gender,r,a.ethnicity,a.height,a.build],c=a.features.filter(m=>n[m]);return{id:a.id,name:a.name,gender:a.gender,features:[...i,...c]}})},X=o=>{const e={};console.log("‚öôÔ∏è Calculating suspect answers...");for(const t of Object.keys(o)){const n=o[t];for(const s of Object.keys(n)){const{resolution:a,projection:r}=Q(s,n);if(!(!a&&!r)){if(e[t]===void 0&&(e[t]={}),a){e[t][s]=a==="üëç";continue}r&&(e[t][s]=r==="üëç")}}}return Object.keys(e).forEach(t=>{p.isEmpty(e[t])&&delete e[t]}),Object.keys(e).forEach(t=>{Object.keys(e[t]).length<3&&(console.log("‚ÅâÔ∏è Removing testimonies with less than 3 answers"),delete e[t])}),Object.keys(e).forEach(t=>{p.uniq(Object.values(e[t])).length===1&&(console.log("‚ÅâÔ∏è Removing testimonies with the same answer"),delete e[t])}),e},V=o=>{const e={};for(const n of Object.keys(o)){const{gender:s,ethnicity:a,age:r,build:i,height:c,features:m}=o[n];if(!i){console.log("‚ÅâÔ∏è Ignoring suspect with missing build",n);continue}if(!c){console.log("‚ÅâÔ∏è Ignoring suspect with missing height",n);continue}if(!m||m.length===0){console.log("‚ÅâÔ∏è Ignoring suspect with missing features",n);continue}e[s]===void 0&&(e[s]={}),e[s][n]=!0,e[a]===void 0&&(e[a]={}),e[a][n]=!0,e[r]===void 0&&(e[r]={}),e[r][n]=!0,e[i]===void 0&&(e[i]={}),e[i][n]=!0,e[c]===void 0&&(e[c]={}),e[c][n]=!0,m.forEach(u=>{e[u]===void 0&&(e[u]={}),e[u][n]=!0})}return e.young=p.cloneDeep(e["18-21"]),e.adult=p.cloneDeep({...e["21-30"],...e["30-40"],...e["40-50"]}),e.senior=p.cloneDeep({...e["50-60"],...e["60-70"],...e["70-80"],...e["80-90"]}),["18-21","21-30","30-40","40-50","50-60","60-70","70-80","80-90","average","medium","mixed","adult","tall"].forEach(n=>{delete e[n]}),e},K=(o,e)=>{let t=0,n,s,a=[];for(;t<100&&!s;){if(t++,n=p.sample(Object.keys(o)),!n)continue;const u=Object.keys(o[n]);if(s=p.sample(Object.keys(o).filter(f=>f!==n&&!p.isEmpty(p.difference(u,Object.keys(o[f]))))),s){a=p.uniq([...Object.keys(o[n]),...Object.keys(o[s])]);break}}if(!n||!s||a.length<3)throw new Error("Failed to find two related testimonies");const r=p.sample(a.filter(u=>!e.includes(u)));if(!r)throw new Error("Failed to determine a culprit from common suspects");const i=`${o[n][r]}-${o[s][r]}`,c=p.sampleSize(a.filter(u=>u!==r&&`${o[n][u]}-${o[s][u]}`!==i),N-1),m=p.difference(a,c);return console.log(`‚öôÔ∏è Attempts made: ${t}`),{selectedTestimonyId1:n,selectedTestimonyId2:s,culpritId:r,possibleSuspects:c,impossibleSuspects:m}},F=(o,e)=>{e.forEach(t=>{o[t]===void 0&&(o[t]=0),o[t]++})},G=(o,e,t,n)=>{const s=n[o],a=e.filter(c=>n[c]!==void 0&&n[c]!==s),r=t.answer.charAt(0).toLowerCase()+t.answer.slice(1),i={key:`testimony.${t.id}`,text:`O(a) suspeito(a) ${s?"":"n√£o "}${r}`,excludes:a,type:"testimony"};return i.text.includes("n√£o j√°")&&(i.text=i.text.replace("n√£o j√°","nunca")),i},J={column1:{indexes:[0,4,8],text:"na primeira coluna"},column2:{indexes:[1,5,9],text:"na segunda coluna"},column3:{indexes:[2,6,10],text:"na terceira coluna"},column4:{indexes:[3,7,11],text:"na quarta coluna"},corners:{indexes:[0,3,8,11],text:"nos cantos"}},Z={row1:{indexes:[0,1,2,3],text:"na primeira linha"},row2:{indexes:[4,5,6,7],text:"na segunda linha"},row3:{indexes:[8,9,10,11],text:"na terceira linha"}},_=(o,e,t,n)=>{const s=e.indexOf(o),a=t.slice(0,3),r=n==="rows"?Z:J,i={};for(const l of Object.keys(r)){const{indexes:d}=r[l];d.includes(s)||(i[l]=d.reduce((h,E)=>{const y=e[E],x=a.filter(S=>S.excludes.includes(y)).length;return x>0?h+x:h},0))}const c=Object.entries(i).reduce((l,[d,h])=>(l[h]||(l[h]=[]),l[h].push(d),l),{}),m=Math.min(...Object.keys(i).map(l=>i[l])),u=c[m.toString()],f=p.sample(u)||Object.keys(i)[0],g=r[f].indexes.map(l=>e[l]);return{key:`not.grid.${f}`,text:`O(a) suspeito(a) n√£o est√° ${r[f].text}`,excludes:g,type:"grid"}},I=(o,e,t,n=[],s="best")=>{const a=p.difference(e,[o]),r=n.filter(d=>d.key.startsWith("not.feature.")).map(d=>d.key.replace("not.feature.","")),i=new Set(n.flatMap(d=>d.excludes)),c=Object.keys(t).filter(d=>Object.keys(t[d]).length<=6&&!r.includes(d)).sort((d,h)=>Object.keys(t[h]).length-Object.keys(t[d]).length);let m,u=[],f=0;const g=500;for(;f<g;){f++;const d=s==="best"?c[0]:p.sample(c.slice(2,5))??c[2];if(!d)break;const h=a.filter(y=>t[d][y]);if(h.some(y=>!i.has(y))||f===g){m=d,u=h;break}c.splice(c.indexOf(d),1)}if(!m)throw Error(`No suitable feature found for ${s} selection after ${g} attempts`);console.log(`Selected feature after ${f} attempts: ${m}`);const l=B[m];return l||console.warn(`Feature ${m} not found in translations`),{key:`not.feature.${m}`,text:`O(a) suspeito(a) n√£o ${l||m}`,excludes:u,type:"feature"}},ee=o=>{const e=o.slice(0,3);return e.reduce((s,a)=>s+a.excludes.length,0)<10?!1:new Set(e.flatMap(s=>s.excludes)).size===N-1},te=(o,e)=>{const t=[];Object.values(e).forEach(s=>{var a;s.feature==="general"&&t.push(s),(a=o.features)!=null&&a.includes(s.feature)&&t.push(s)});const n=p.sample(t);return n||{id:"unknown",title:{pt:"Motivo desconhecido",en:"Unknown reason"},feature:"general"}},se=o=>{const e=o.slice(0,3),t=[],n={1:4,2:3,3:3,4:2,5:2,6:1,7:0,8:0};e.forEach(a=>{const r=a.excludes.length;n[r]!==void 0&&t.push(n[r])});const s=Math.round(t.reduce((a,r)=>a+r,0)/t.length);return Math.min(Math.max(s,1),3)};function le(){const o=k("suspects"),e=k("testimony-questions-pt"),t=U({tdrResourceName:"testimony-answers",firestoreDataCollectionName:"testimonies",serialize:!0});return{...t,isLoading:t.isLoading||e.isLoading||o.isLoading,isSuccess:t.isSuccess&&e.isSuccess&&o.isSuccess,error:t.error||e.error||o.error,questions:e.data,suspects:o.data,hasNewData:t.hasFirestoreData}}const de=o=>o.reduce((e,t)=>{if(t===0||t===1)return e+1;const n=Math.abs(t);return n?e+n:e},0);export{Q as a,le as b,de as c,ce as n,ue as u};
