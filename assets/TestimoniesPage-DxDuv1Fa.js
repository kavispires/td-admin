import{r as b,a as Q,_ as G,j as n,T as I,B as N,aj as Z,y as D,af as ee,Y as te,X as se,P as ne,L as U}from"./index-BmKmifuD.js";import{D as oe}from"./DataLoadingWrapper-DfqjV0Gf.js";import{l as j,c as re,P as ie}from"./useBaseUrl-CV65xL7T.js";import{u as $}from"./useQueryParams-Xp2SkAjz.js";import{R as ae}from"./main-Lmn9gIUS.js";import{u as ce,D as le,a as ue,g as de}from"./constants-612R8Vpu.js";import{u as E}from"./useTDResource-C3kg2Dqy.js";import{I as V}from"./ImageCard-C8XC0jEm.js";import{g as me}from"./utils-Bq5u3CDr.js";import{F as S}from"./index-DZkJ9OT8.js";import{B as Y,D as he}from"./DownloadButton-tz6fwmNw.js";import{S as B}from"./index-DmgRV1Ct.js";import{u as K}from"./useTableExpandableRows-Cku_BbcW.js";import{u as X}from"./useTablePagination-BZXZ9gnP.js";import{S as H}from"./index-CXjb0pZw.js";import{F as _}from"./Table-t0JrhtBC.js";import{P as L}from"./progress-BQr1HRVx.js";import{T as J}from"./index-3FN9VFKp.js";import{u as pe}from"./useCardWidth-CZsLuRob.js";import{R as ge}from"./FireFilled-17_jJgK3.js";import{F as fe}from"./FilterEntries-CRanhvKv.js";import{S as F}from"./SiderContent-CQJYQry7.js";import{S as xe}from"./SaveButton-E-BI8ZxD.js";import{a as je,d as be,e as ye}from"./index-DmSVtCoz.js";import{R as we}from"./TableOutlined-BqAByUUS.js";import{u as ve}from"./useGetFirestoreDoc--hH88T1t.js";import{u as Se}from"./useUpdateFirestoreDoc-C2ni2j9Y.js";import"./moment-C5S46NFB.js";import"./gapSize-U1swVQyS.js";import"./index-C93JcBPZ.js";import"./index-Dl0nHeYG.js";import"./index-Bp5RKnu_.js";import"./index-B3nqieae.js";import"./scrollTo-Bya_zsyU.js";import"./Pagination-BT7uN7Tb.js";import"./extendsObject-keMuGWqj.js";import"./Input-CEcyoz_o.js";import"./index-CsRa4iyH.js";import"./SaveOutlined-Gppapl37.js";import"./constants-B4YYuuBb.js";import"./Item-BDgAGbk3.js";import"./useMutation-Dczd92Es.js";var ke={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M594.3 601.5a111.8 111.8 0 0029.1-75.5c0-61.9-49.9-112-111.4-112s-111.4 50.1-111.4 112c0 29.1 11 55.5 29.1 75.5a158.09 158.09 0 00-74.6 126.1 8 8 0 008 8.4H407c4.2 0 7.6-3.3 7.9-7.5 3.8-50.6 46-90.5 97.2-90.5s93.4 40 97.2 90.5c.3 4.2 3.7 7.5 7.9 7.5H661a8 8 0 008-8.4c-2.8-53.3-32-99.7-74.7-126.1zM512 578c-28.5 0-51.7-23.3-51.7-52s23.2-52 51.7-52 51.7 23.3 51.7 52-23.2 52-51.7 52zm416-354H768v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H548v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H328v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H96c-17.7 0-32 14.3-32 32v576c0 17.7 14.3 32 32 32h832c17.7 0 32-14.3 32-32V256c0-17.7-14.3-32-32-32zm-40 568H136V296h120v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h148v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h148v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h120v496z"}}]},name:"contacts",theme:"outlined"},Ee={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M300 328a60 60 0 10120 0 60 60 0 10-120 0zM852 64H172c-17.7 0-32 14.3-32 32v660c0 17.7 14.3 32 32 32h680c17.7 0 32-14.3 32-32V96c0-17.7-14.3-32-32-32zm-32 660H204V128h616v596zM604 328a60 60 0 10120 0 60 60 0 10-120 0zm250.2 556H169.8c-16.5 0-29.8 14.3-29.8 32v36c0 4.4 3.3 8 7.4 8h729.1c4.1 0 7.4-3.6 7.4-8v-36c.1-17.7-13.2-32-29.7-32zM664 508H360c-4.4 0-8 3.6-8 8v60c0 4.4 3.6 8 8 8h304c4.4 0 8-3.6 8-8v-60c0-4.4-3.6-8-8-8z"}}]},name:"robot",theme:"outlined"},Oe={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M868 160h-92v-40c0-4.4-3.6-8-8-8H256c-4.4 0-8 3.6-8 8v40h-92a44 44 0 00-44 44v148c0 81.7 60 149.6 138.2 162C265.6 630.2 359 721.8 476 734.5v105.2H280c-17.7 0-32 14.3-32 32V904c0 4.4 3.6 8 8 8h512c4.4 0 8-3.6 8-8v-32.3c0-17.7-14.3-32-32-32H548V734.5C665 721.8 758.4 630.2 773.8 514 852 501.6 912 433.7 912 352V204a44 44 0 00-44-44zM248 439.6c-37.1-11.9-64-46.7-64-87.6V232h64v207.6zM840 352c0 41-26.9 75.8-64 87.6V232h64v120z"}}]},name:"trophy",theme:"filled"},Ce=function(e,o){return b.createElement(Q,G({},e,{ref:o,icon:ke}))},Pe=b.forwardRef(Ce),Re=function(e,o){return b.createElement(Q,G({},e,{ref:o,icon:Ee}))},Te=b.forwardRef(Re),Ne=function(e,o){return b.createElement(Q,G({},e,{ref:o,icon:Oe}))},De=b.forwardRef(Ne);const W=(r,e,o)=>{const{reliabilityThreshold:l=4,projectionThreshold:c=55}={},t=`us-gb-${r.split("-")[1]}`,u=e[r]??[];let g=0,h=0;u.forEach(v=>{v===3&&(g+=3),v===-3&&(h+=3)});const d=u.filter(v=>v!==3&&v!==-3),p=d.length+g+h,m=Math.max(p,5),i=u.filter(v=>v===1).length+g,f=Math.round(i/m*100),y=u.filter(v=>v===0).length+h,O=Math.round(y/m*100),A=Math.round((m-i-y)/m*100),P=d.length+g+h>=5,R=p>3,w=p>l,k=w?f>O?"👍":"👎":null,C=R?f>=c?"👍":O>=c?"👎":null:null;return{suspectCardId:r,imageId:t,enoughData:R,reliable:w,total:m,yesCount:i,yesPercentage:f,noCount:y,noPercentage:O,blankPercentage:A,complete:P,values:u,resolution:k,projection:C}},q=9,Ae=(r,e,o,l)=>{const[c]=ce(le.ESPIONAGEM,l),a=E("suspects",r),t=E(`testimony-questions-${e}`,r),u=E("testimony-answers",r),g=E("crime-reasons",r),h=b.useMemo(()=>Ie(u.data),[u.data]),d=b.useMemo(()=>$e(a.data),[a.data]);return{entries:b.useMemo(()=>!c||!a.isSuccess||!t.isSuccess||!u.isSuccess||!g.isSuccess?{}:Fe(o,c,a.data,t.data,h,d,g.data),[r,c,a,t,u,o,h,d,g]),isLoading:a.isLoading||t.isLoading||u.isLoading}},Fe=(r,e,o,l,c,a,t)=>{console.count("Creating Espionagem...");let u=e.latestDate;const g=[],h={};for(let d=0;d<r;d++){const p=ue(u);u=p;let m=null,s=0;for(;!m&&s<100;){s++;const i=Me(o,l,c,a,g,t);if(Le(i.statements)){m=i,console.log(`Generated valid game for ${p} after ${s} attempts`);break}}if(!m)throw new Error(`Failed to generate valid game for ${p} after 100 attempts`);g.push(m.culpritId),h[p]={id:p,type:"espionagem",number:e.latestNumber+d+1,...m}}return h};function Me(r,e,o,l,c,a){let t=[];const u=[],g={},h=j.sample(Object.keys(o));if(!h)throw new Error("No selected testimony ID found");const d=Object.keys(o[h]).filter(w=>!c.includes(w)),p=d.length>0?d:Object.keys(o[h]),m=j.sample(p);if(!m)throw new Error("No selected culprit ID found");const s=j.sampleSize(Object.keys(o[h]).filter(w=>w!==m),q-1);for(t.push(...s);t.length<8;){const w=j.sampleSize(Object.keys(r).filter(k=>!t.includes(k)&&k!==m),q-t.length-1);t.push(...w)}const i={};Object.keys(l).forEach(w=>{if(l[w][m]===void 0){const k=Object.keys(l[w]).filter(C=>t.includes(C));if(k.length>0){const C={};k.forEach(v=>{t.includes(v)&&(C[v]=!0)}),i[w]=C}}});const f=e[h];u.push(ze(m,t,f,o[h])),T(g,u[0].excludes);const x=z(m,t,i);u.push(x),T(g,x.excludes),t=j.shuffle([...t,m]);const y=z(m,t,i,[x],"worst");u.push(y),T(g,y.excludes);const O=z(m,t,i,[x,y],"worst");u.push(O),T(g,O.excludes);const A=Be(m,t,u);u.push(A),T(g,A.excludes);const P=[u[0],u[1],u[2],u[4],u[3]],R=qe(r[m],a);return{isNsfw:f.nsfw??!1,culpritId:m,statements:P,suspects:t.map(w=>r[w]),reason:R.title,setId:`${m}::${R.id}::${P[0].key}`,level:Qe(P)}}const Ie=r=>{const e={};console.log("⚙️ Calculating suspect answers...");for(const o of Object.keys(r)){const l=r[o];for(const c of Object.keys(l)){const{resolution:a,projection:t}=W(c,l);if(!a&&!t){console.log("⁉️ Ignoring testimony with no resolution or projection");continue}if(e[o]===void 0&&(e[o]={}),a){e[o][c]=a==="👍";continue}if(t){e[o][c]=t==="👍";continue}console.log("⁉️ Ignoring testimony with not enough values")}}return Object.keys(e).forEach(o=>{j.isEmpty(e[o])&&delete e[o]}),Object.keys(e).forEach(o=>{Object.keys(e[o]).length<3&&(console.log("⁉️ Removing testimonies with less than 3 answers"),delete e[o])}),Object.keys(e).forEach(o=>{j.uniq(Object.values(e[o])).length===1&&(console.log("⁉️ Removing testimonies with the same answer"),delete e[o])}),e},$e=r=>{const e={};for(const l of Object.keys(r)){const{gender:c,ethnicity:a,age:t,build:u,height:g,features:h}=r[l];if(!u){console.log("⁉️ Ignoring suspect with missing build",l);continue}if(!g){console.log("⁉️ Ignoring suspect with missing height",l);continue}if(!h||h.length===0){console.log("⁉️ Ignoring suspect with missing features",l);continue}e[c]===void 0&&(e[c]={}),e[c][l]=!0,e[a]===void 0&&(e[a]={}),e[a][l]=!0,e[t]===void 0&&(e[t]={}),e[t][l]=!0,e[u]===void 0&&(e[u]={}),e[u][l]=!0,e[g]===void 0&&(e[g]={}),e[g][l]=!0,h.forEach(d=>{e[d]===void 0&&(e[d]={}),e[d][l]=!0})}return e.young=j.cloneDeep(e["18-21"]),e.adult=j.cloneDeep({...e["21-30"],...e["30-40"],...e["40-50"]}),e.senior=j.cloneDeep({...e["50-60"],...e["60-70"],...e["70-80"],...e["80-90"]}),["18-21","21-30","30-40","40-50","50-60","60-70","70-80","80-90","average","medium","mixed","adult","tall"].forEach(l=>{delete e[l]}),e},T=(r,e)=>{e.forEach(o=>{r[o]===void 0&&(r[o]=0),r[o]++})},ze=(r,e,o,l)=>{const c=l[r],a=e.filter(g=>l[g]!==void 0&&l[g]!==c),t=o.answer.charAt(0).toLowerCase()+o.answer.slice(1),u={key:`testimony.${o.id}`,text:`O(a) suspeito(a) ${c?"":"não "}${t}`,excludes:a};return u.text.includes("não já")&&(u.text=u.text.replace("não já","nunca")),u},M={row1:{indexes:[0,1,2],text:"na primeira linha"},row2:{indexes:[3,4,5],text:"na segunda linha"},row3:{indexes:[6,7,8],text:"na terceira linha"},column1:{indexes:[0,3,6],text:"na primeira coluna"},column2:{indexes:[1,4,7],text:"na segunda coluna"},column3:{indexes:[2,5,8],text:"na terceira coluna"},corners:{indexes:[0,2,6,8],text:"nos cantos"}},Be=(r,e,o)=>{const l=e.indexOf(r),c=o.slice(0,3),a={};for(const p of Object.keys(M)){const{indexes:m}=M[p];m.includes(l)||(a[p]=m.reduce((s,i)=>{const f=e[i],x=c.filter(y=>y.excludes.includes(f)).length;return x>0?s+x:s},0))}const t=Object.entries(a).reduce((p,[m,s])=>(p[s]||(p[s]=[]),p[s].push(m),p),{}),u=Math.min(...Object.keys(a).map(p=>a[p])),g=t[u.toString()],h=j.sample(g)||Object.keys(a)[0],d=M[h].indexes.map(p=>e[p]);return{key:`not.grid.${h}`,text:`O(a) suspeito(a) não está ${M[h].text}`,excludes:d}},z=(r,e,o,l=[],c="best")=>{const a=j.difference(e,[r]),t=l.filter(i=>i.key.startsWith("not.feature.")).map(i=>i.key.replace("not.feature.","")),u=new Set(l.flatMap(i=>i.excludes)),g=Object.keys(o).filter(i=>Object.keys(o[i]).length<=6&&!t.includes(i)).sort((i,f)=>Object.keys(o[f]).length-Object.keys(o[i]).length);let h,d=[],p=0;const m=50;for(;p<m;){p++;const i=c==="best"?g[0]:j.sample(g.slice(2,5))??g[2];if(!i)break;const f=a.filter(y=>o[i][y]);if(f.some(y=>!u.has(y))||p===m){h=i,d=f;break}g.splice(g.indexOf(i),1)}if(!h)throw Error(`No suitable feature found for ${c} selection after ${m} attempts`);const s=He[h];return s||console.warn(`Feature ${h} not found in translations`),{key:`not.feature.${h}`,text:`O(a) suspeito(a) não ${s||h}`,excludes:d}},He={male:"é homem",female:"é mulher",black:"é negro(a)",white:"é branco(a)",asian:"é asiático(a)",latino:"é latino(a)",thin:"é magrelo(a)",fat:"é gordo(a)",large:"é gordo(a)",tall:"é alto(a)",short:"é baixinho(a)",young:"é jovem",adult:"é adulto(a)",senior:"é idoso(a)",average:"é médio(a)",medium:"é médio(a)",mixed:"é mestiço(a)",hat:"está usando um chapéu",tie:"está usando uma gravata",glasses:"está usando óculos",brownHair:"tem cabelo castanho",shortHair:"tem cabelo curto",beard:"tem barba",caucasian:"é caucasiano(a)",scarf:"está usando um cachecol",blondeHair:"tem cabelo loiro",longHair:"tem cabelo longo",greyHair:"tem cabelo grisalho",bald:"é careca",mustache:"tem bigode",goatee:"tem cavanhaque",muscular:"é musculoso(a)",blackHair:"tem cabelo preto",hoodie:"está usando um moletom",earrings:"está usando brincos",lipstick:"está usando batom",necklace:"está usando um colar",mediumHair:"tem cabelo médio","middle-eastern":"é do Oriente Médio",headscarf:"está usando um lenço na cabeça",redHair:"tem cabelo ruivo",piercings:"tem piercings",coloredHair:"tem cabelo colorido",indian:"é indiano(a)","native-american":"é nativo-americano(a)"},Le=r=>{const e=r.slice(0,3);return e.reduce((c,a)=>c+a.excludes.length,0)<10?!1:new Set(e.flatMap(c=>c.excludes)).size===q-1},qe=(r,e)=>{const o=[];Object.values(e).forEach(c=>{var a;c.feature==="general"&&o.push(c),(a=r.features)!=null&&a.includes(c.feature)&&o.push(c)});const l=j.sample(o);return l||{id:"unknown",title:{pt:"Motivo desconhecido",en:"Unknown reason"},feature:"general"}},Qe=r=>{const e=r.slice(0,3),o=[],l={1:4,2:3,3:3,4:2,5:2,6:1,7:0,8:0};e.forEach(a=>{const t=a.excludes.length;l[t]!==void 0&&o.push(l[t])});const c=Math.round(o.reduce((a,t)=>a+t,0)/o.length);return Math.min(Math.max(c,1),3)};function Ge(){const[r,e]=b.useState({}),{entries:o}=Ae(!0,"pt",1,r);return n.jsxs(S,{vertical:!0,gap:12,className:"p-4",children:[n.jsxs(S,{justify:"space-between",align:"center",children:[n.jsx(I.Title,{level:4,className:"my-0",children:"Espionagem Simulator"}),n.jsx(N,{type:"primary",onClick:()=>e({}),children:"Re-run Simulation"})]}),n.jsx(Ve,{entries:o})]})}function Ve({entries:r}){const[e,o]=b.useState(!1),l=de(),c=r[l],a=b.useMemo(()=>c?c.statements.slice(0,3).reduce((t,u)=>{const{excludes:g}=u;return g.forEach(h=>{t[h]?t[h]++:t[h]=1}),t},{}):{},[c]);return n.jsxs("div",{className:"full-width grid grid-2",children:[n.jsx(ae,{src:r??{},theme:"twilight",collapsed:3}),c&&n.jsxs(S,{gap:18,className:"p-4",children:[n.jsx("div",{children:n.jsx("div",{style:{width:`${105*3}px`,display:"grid",gap:"6px",gridTemplateColumns:"repeat(3, 1fr)"},children:c.suspects.map(t=>n.jsxs(Y.Ribbon,{text:e?a[t.id]:null,color:"cyan",children:[n.jsx(V,{id:me(t.id,"gb"),width:96,className:re(e&&t.id===c.culpritId&&"red-border")},t.id),n.jsxs(S,{gap:6,align:"center",children:[n.jsx(B,{checkedChildren:"🚫",size:"small"})," ",t.id]})]},t.id))})}),n.jsxs("div",{children:[n.jsx("div",{children:n.jsx(B,{checkedChildren:"Show Culprit",unCheckedChildren:"Hide Culprit",checked:e,onChange:o})}),c.statements.map((t,u)=>n.jsx(I.Paragraph,{children:n.jsx(Y,{count:t.excludes.length,color:"cyan",children:n.jsx(Z,{message:t.text,banner:!0,type:u<3?"info":"error"},t.key)})},t.key))]})]})]})}function _e({suspect:r,answersPerQuestion:e,questions:o}){const l=b.useMemo(()=>j.orderBy(Object.keys(e).map(a=>{const t=o[a],{enoughData:u,reliable:g,yesPercentage:h,noPercentage:d,blankPercentage:p,values:m,total:s}=W(r.id,{[r.id]:e[a]});return{id:a,question:t,enoughData:u,reliable:g,yesPercentage:h,noPercentage:d,blankPercentage:p,values:m,total:s}}),["reliable","enoughData","yesPercentage",a=>a.values.length],["desc","desc","desc","desc"]),[e,o,r.id]),c=[{key:"id",title:"Id",dataIndex:"id"},{key:"question",title:"Question",dataIndex:"question",render:a=>a.question},{key:"answer",title:"Answer",dataIndex:"id",sorter:(a,t)=>a.total-t.total,render:a=>{const t=l.find(u=>u.id===a);return t?n.jsxs(S,{gap:8,wrap:"nowrap",children:[n.jsx(D,{title:`Values: ${t.values.join(", ")}`,children:n.jsx(L,{percent:t.noPercentage+t.yesPercentage,size:t.enoughData?[100,20]:[100,10],status:t.enoughData?"exception":"active",success:{percent:t.yesPercentage},showInfo:!1})}),t.yesPercentage>=t.noPercentage?n.jsxs(J,{color:"green-inverse",children:[t.yesPercentage,"% Yes"]}):n.jsxs(J,{color:"red-inverse",children:[t.noPercentage,"% No"]})]}):""}}];return n.jsx(H,{wrap:!0,size:"large",children:n.jsx(_,{rowKey:"id",columns:c,dataSource:l,bordered:!0})})}function We({isLoading:r,isSuccess:e,questions:o,data:l,suspects:c}){const a=b.useMemo(()=>Object.keys(l).reduce((d,p)=>{const m=l[p]??{};return Object.keys(m).forEach(s=>{d[s]||(d[s]={}),d[s][p]=m[s]}),d},{}),[l]),t=b.useMemo(()=>j.orderBy(Object.values(c).map(d=>({...d,answers:a[d.id]})),d=>Number(d.id.split("-")[1]),"asc"),[c,a]),u=X({total:t.length,showQuickJumper:!0}),g=[{title:"Id",dataIndex:"id",key:"id",sorter:(d,p)=>Number(d.id.split("-")[1])-Number(p.id.split("-")[1])},{title:"Picture",dataIndex:"id",render:d=>{const p=d.split("-").join("-gb-");return n.jsx(V,{id:p,width:48})}},{title:"Name",dataIndex:"name",key:"name",sorter:(d,p)=>d.name.pt.localeCompare(p.name.pt),render:d=>d.pt},{title:"Questions Answered",dataIndex:"answers",key:"answers",sorter:(d,p)=>Object.keys(d.answers).length-Object.keys(p.answers).length,render:d=>d?Object.values(d).length:""}],h=K({maxExpandedRows:1,expandedRowRender:d=>n.jsx(_e,{suspect:d,answersPerQuestion:a[d.id],questions:o}),rowExpandable:()=>e});return n.jsx(_,{columns:g,dataSource:t,pagination:u,rowKey:"id",expandable:h,loading:r,bordered:!0,className:"full-width"})}function Ue({answers:r,suspects:e,addEntryToUpdate:o,testimonyId:l}){const[c,a]=pe(12),{queryParams:t}=$({sortSuspectsBy:"answers"}),u=t.get("sortSuspectsBy")??"answers",g=b.useMemo(()=>{const s=Object.keys(e).map(i=>W(i,r));return u==="answers"?j.orderBy(s,["reliable","enoughData",i=>i.values.length,"yesPercentage"],["desc","desc","desc","desc"]):s},[r,e,u]),h=s=>{const i={...r};i[s]=[...i[s]||[],3],o(l,i)},d=s=>{const i={...r};i[s]=[...i[s]||[],-3],o(l,i)},p=s=>{var x;const i={...r},f=(x=i[s])==null?void 0:x.findIndex(y=>y===3);f!==-1&&f!==void 0&&(i[s]=[...i[s].slice(0,f),...i[s].slice(f+1)]),o(l,i)},m=s=>{var x;const i={...r},f=(x=i[s])==null?void 0:x.findIndex(y=>y===-3);f!==-1&&f!==void 0&&(i[s]=[...i[s].slice(0,f),...i[s].slice(f+1)]),o(l,i)};return n.jsx(H,{wrap:!0,ref:a,size:"large",children:g.map(s=>n.jsxs(S,{vertical:!0,gap:4,children:[n.jsx(V,{id:s.imageId,width:c,className:s.values.length>1?void 0:"grayscale"}),n.jsxs(ee,{trigger:"click",title:`Add strong fit/unfit answer to ${e[s.suspectCardId].name.pt}`,content:n.jsxs(S,{vertical:!0,gap:4,children:[n.jsx(I.Text,{type:"secondary",children:s.values.join(", ")}),n.jsxs(N,{icon:"👍",block:!0,onClick:()=>h(s.suspectCardId),children:[" ","Add strong fit"]}),n.jsxs(N,{icon:"👎",block:!0,onClick:()=>d(s.suspectCardId),children:[" ","Add strong unfit"]}),n.jsxs(H.Compact,{children:[n.jsx(N,{icon:"❌",size:"small",block:!0,onClick:()=>p(s.suspectCardId),children:"fit"}),n.jsx(N,{icon:"❌",size:"small",block:!0,onClick:()=>m(s.suspectCardId),children:"unfit"})]})]}),children:[n.jsxs("div",{children:[n.jsx(D,{title:s.suspectCardId,children:e[s.suspectCardId].name.pt})," ",s.complete&&n.jsx(D,{title:"Complete: It has 5 or more answers",children:n.jsx(De,{style:{color:"gold"}})})]}),n.jsx(D,{title:`Values: ${s.values.join(", ")} : ${s.resolution?s.resolution:s.projection?`${s.projection}*`:""}`,children:s.enoughData?n.jsx(L,{percent:s.noPercentage+s.yesPercentage,size:[c,20],status:"exception",success:{percent:s.yesPercentage},showInfo:!1}):n.jsx(L,{percent:s.noPercentage+s.yesPercentage,size:[c,10],status:"exception",success:{percent:s.yesPercentage},showInfo:!1})})]})]},s.suspectCardId))})}function Ye({data:r,questions:e,suspects:o,isLoading:l,isSuccess:c,addEntryToUpdate:a}){const{queryParams:t,addParam:u}=$(),g=b.useMemo(()=>j.orderBy(Object.values(e),m=>Number(m.id.split("-")[1]),"asc"),[e]),h=X({total:g.length,showQuickJumper:!0}),d=[{title:"Id",dataIndex:"id",key:"id",sorter:(m,s)=>Number(m.id.split("-")[1])-Number(s.id.split("-")[1])},{title:"Question",dataIndex:"question",key:"question",sorter:(m,s)=>m.question.localeCompare(s.question)},{title:"NSFW",dataIndex:"nsfw",key:"nsfw",render:m=>m?n.jsx(ge,{style:{color:"hotPink"}}):"",sorter:(m,s)=>Number(m.nsfw)-Number(s.nsfw)},{title:"Answers",dataIndex:"id",key:"answers",render:m=>{const s=r[m];return s?Object.values(s).length:""}}],p=K({maxExpandedRows:1,expandedRowRender:m=>n.jsx(Ue,{testimonyId:m.id,answers:r[m.id]??{},suspects:o,addEntryToUpdate:a}),rowExpandable:()=>c});return n.jsxs(S,{gap:12,className:"full-width py-4",vertical:!0,children:[n.jsxs(S,{justify:"space-between",align:"center",children:[n.jsx(I.Title,{level:4,className:"my-0",children:"Suspects by Testimony"}),n.jsx(B,{checked:t.get("sortSuspectsBy")==="answers",onChange:m=>u("sortSuspectsBy",m?"answers":"id"),checkedChildren:"Sort by Answers",unCheckedChildren:"Sort by Id"})]}),n.jsx(_,{columns:d,dataSource:g,pagination:h,rowKey:"id",expandable:p,loading:l,bordered:!0,className:"full-width"})]})}function Je(r){const{queryParams:e,is:o}=$();return n.jsxs(n.Fragment,{children:[(o("display","questions")||!e.get("display"))&&n.jsx(Ye,{...r}),o("display","suspects")&&n.jsx(We,{...r}),o("display","simulator")&&n.jsx(Ge,{})]})}function Ke({data:r,hasNewData:e,isDirty:o,save:l,isSaving:c,entriesToUpdate:a}){const{queryParams:t,addParams:u}=$(),g=b.useMemo(()=>{const h={};return Object.values(r).forEach(d=>{Object.keys(d).forEach(p=>{d[p]&&(h[p]||(h[p]=0),d[p].length>=5&&(h[p]+=1))})}),{queriedTestimoniesCount:Object.keys(r).length,suspectsCount:Object.keys(h).length,reliableSuspectsCount:Object.values(h).filter(d=>d>=5).length}},[r]);return n.jsxs(n.Fragment,{children:[n.jsx(F,{children:n.jsxs(S,{vertical:!0,gap:12,children:[n.jsx(xe,{isDirty:o,onSave:l,isSaving:c,dirt:JSON.stringify(a)}),n.jsx(he,{data:()=>Xe(r),fileName:"testimony-answers.json",disabled:o,hasNewData:e,block:!0})]})}),n.jsx(F,{children:n.jsx(fe,{label:"Display",value:t.get("display")??"questions",onChange:h=>u({display:h,page:1},{page:1}),options:[{title:"Questions",icon:n.jsx(we,{}),value:"questions"},{title:"Suspects",icon:n.jsx(Pe,{}),value:"suspects"},{title:"Simulator",icon:n.jsx(Te,{}),value:"simulator"}]})}),n.jsx(F,{children:n.jsxs("div",{style:{fontSize:"0.85em"},children:[n.jsx("strong",{children:"Legend"}),n.jsxs("ul",{children:[n.jsx("li",{children:"Reliability: At least 5 votes"}),n.jsx("li",{children:"Large Bars: There's enough data (at least 3)"}),n.jsx("li",{children:"Small blue bar: in progress negative"})]})]})}),n.jsx(F,{children:n.jsxs("div",{style:{fontSize:"0.85em"},children:[n.jsx("strong",{children:"Counts"}),n.jsxs("ul",{children:[n.jsxs("li",{children:["Testimonies: ",g.queriedTestimoniesCount]}),n.jsxs("li",{children:["Suspects: ",g.suspectsCount]}),n.jsx("li",{children:n.jsxs(D,{title:"A reliable suspect is one that has at least 5 complete testimonies.",children:["Reliable suspects: ",g.reliableSuspectsCount]})})]})]})})]})}function Xe(r){console.log("Preparing file for download...");const e=j.cloneDeep(r);return je(be(e))}function Ze(){const{notification:r}=te.useApp(),e=se(),o=E("suspects"),l=E("testimony-questions-pt"),c=E("testimony-answers"),a=ve("data","testimonies",{select:s=>ye(s,i=>{const f={};return Object.keys(i).forEach(x=>{const y=x.replace(/us-\w{2}-(\d+)/,"us-$1");f[y]=i[x]||[]}),f})}),[t,u]=b.useState({}),g=Se("data","testimonies",{onSuccess:()=>{r.success({message:"data/testimonies updated"}),e.refetchQueries({queryKey:["firestore","data","testimonies"]}),u({})},onError:s=>{r.error({message:"data/testimonies update failed",description:s.message})}}),h=b.useMemo(()=>{if(!c.data||!a.data)return{};const s=j.cloneDeep(c.data);return Object.keys(a.data).forEach(i=>{const f=a.data[i];if(s[i]===void 0){s[i]=f;return}Object.keys(f).forEach(x=>{s[i][x]===void 0?s[i][x]=f[x]:s[i][x].push(...f[x])})}),Object.keys(t).forEach(i=>{const f=t[i];s[i]&&(s[i]=f)}),s},[c.data,a.data,t]),d=!j.isEmpty(t),p=(s,i)=>{u(f=>({...f,[s]:i}))},m=()=>{const s=Object.keys(t).reduce((i,f)=>(i[f]=JSON.stringify(t[f]),i),{});g.mutate(s)};return{isLoading:c.isLoading||a.isLoading||l.isLoading||o.isLoading,isSuccess:c.isSuccess&&a.isSuccess&&l.isSuccess&&o.isSuccess,error:c.error||a.error,data:h,questions:l.data,suspects:o.data,hasNewData:!j.isEmpty(a.data),isSaving:g.isPending,save:m,addEntryToUpdate:p,isDirty:d,entriesToUpdate:t}}function qt(){const r=Ze();return n.jsx(ne,{title:"Testimonies",subtitle:"Suspect Testimony Rates",children:n.jsxs(U,{hasSider:!0,children:[n.jsx(ie,{children:n.jsx(Ke,{...r})}),n.jsx(U.Content,{className:"content",children:n.jsx(oe,{isLoading:r.isLoading,error:r.error,hasResponseData:!j.isEmpty(r.data),children:n.jsx(Je,{...r})})})]})})}export{qt as TestimoniesPage,qt as default};
