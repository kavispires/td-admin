import{r as y,c as b,i as M,j as e,B as $,M as W,b as G,T as I,F as w,D as Q,S as T,a as z,C as q,P as U,L as O}from"./index-AeBhBC7r.js";import{D as J}from"./DataLoadingWrapper-ChvbOcIh.js";import{F as K,b as _}from"./FilterEntries-B20fNyqW.js";import{S as V}from"./SiderContent-BBrCGPee.js";import{D as X}from"./DownloadButton-2dt99Wgn.js";import{S as H}from"./SaveButton-CGZ119o_.js";import{u as F}from"./useQueryParams-CkFTvRtk.js";import{u as C}from"./useTDResource-CfBHyLv8.js";import{l as g,P as Y}from"./useBaseUrl-CGD9CB6e.js";import{c as N,g as Z,d as ee,r as v,a as se}from"./index-dN5o3TnW.js";import{L as P}from"./LanguageFlag-Bo9CVRno.js";import{R as te}from"./ClusterOutlined-CVulcoI2.js";import{R as re}from"./TableOutlined-5EI_WAnz.js";import{T as oe}from"./TransparentButton-p7EK8Fi4.js";import{D}from"./EditableFields-BS6vypZF.js";import{I as ie}from"./IdTag-C7nBSxbT.js";import{I as ae}from"./Item-D1fhDPdc.js";import{u as R}from"./useCopyToClipboardFunction-1voR8M_w.js";import{u as ne}from"./useTableExpandableRows-C-hQ4Vh2.js";import{u as le}from"./useTablePagination-BxigUU9d.js";import{C as me}from"./CopyIdsButton-CN7zderz.js";import{I as ce}from"./InspirationSample-DNcH3GjI.js";import{I as de}from"./ItemsTypeahead-CV-OTlJr.js";import{a as pe,b as k,c as ue}from"./ItemBuildingBlocks-DaHejb99.js";import{C as he}from"./index-ylX_DNMx.js";import{S as xe}from"./index-cQwL5GOf.js";import{F as E}from"./Table-DtkA7GhK.js";import{D as je}from"./index-CzHEkavl.js";import{u as fe,P as ye}from"./useGridPagination-CkqYH3_T.js";import{T as ge}from"./Typeahead-euT8_tzS.js";import{u as be}from"./useResourceFirestoreData-DRE8PPhn.js";import"./index-RkF4G9iN.js";import"./index-D3aHxMAZ.js";import"./PlusOutlined-C9LcCiU-.js";import"./index-Djnq5RxC.js";import"./index-BTFqW_tr.js";import"./Dropdown-9ElPI2lv.js";import"./moment-B-YVwB4U.js";import"./SaveOutlined-54X7fwx9.js";import"./constants-CYJN94L5.js";import"./IdcardOutlined-qYBd3D5x.js";import"./index-DnPn7qom.js";import"./index-BW3wABTi.js";import"./SyncOutlined-BTO40fVs.js";import"./useDebounce-BB2JKJhA.js";import"./index--19LBFFZ.js";import"./index-CFL2EcdZ.js";import"./index-CUiOQ1bq.js";import"./scrollTo-DIF_ikdQ.js";import"./Pagination-_Cc5bCRA.js";import"./useGetFirestoreDoc-3AobfX5J.js";import"./useUpdateFirestoreDoc-BmAQD6Af.js";import"./useMutation-WOFFLZsP.js";function Ie({addEntryToUpdate:s,data:t}){const[o,m]=y.useState(!1),[a]=b.useForm(),{notification:l}=M.useApp(),u=r=>{const n=Z(Object.keys(t));s(n,{id:n,name:{pt:r.nome,en:r.name},itemsIds:[],keywords:r.keywords}),l.success({title:"Group added successfully"}),m(!1),a.resetFields()},p=b.useWatch("name",a),x=b.useWatch("nome",a),d=y.useMemo(()=>{const r={};if(p&&p.length>2){const c=Object.entries(t).reduce((h,[S,i])=>{const j=N.compareTwoStrings(i.name.en,p),f=N.compareTwoStrings(i.name.pt,x);return(j>.2||f>.2)&&(h[S]=Math.max(j,f)),h},{});Object.keys(c).forEach(h=>{r[h]=c[h]})}return Object.keys(r)},[p,x,t]);return e.jsxs(e.Fragment,{children:[e.jsx($,{block:!0,className:"mb-4",onClick:()=>m(!0),type:"dashed",children:"Add New Group"}),e.jsxs(W,{maskClosable:!1,okButtonProps:{htmlType:"submit"},okText:"Add",onCancel:()=>m(!1),onOk:a.submit,open:o,title:"Add New Set",children:[e.jsxs(b,{form:a,onFinish:u,children:[e.jsx(b.Item,{label:"Nome",name:"nome",rules:[{required:!0}],children:e.jsx(G,{placeholder:"Name in pt",prefix:e.jsx(P,{language:"pt",width:"1em"}),size:"small"})}),e.jsx(b.Item,{label:"Name",name:"name",rules:[{required:!0}],children:e.jsx(G,{placeholder:"Name in en",prefix:e.jsx(P,{language:"en",width:"1em"}),size:"small"})})]}),e.jsx(I.Text,{children:"Similar:"}),e.jsx("ul",{children:d.map(r=>e.jsxs("li",{children:[r," - ",t[r]?.name.en," / ",t[r]?.name.pt]},r))})]})]})}function Se({data:s,save:t,isDirty:o,isSaving:m,entriesToUpdate:a,addEntryToUpdate:l,hasFirestoreData:u}){const{queryParams:p,addParam:x,addParams:d,is:r}=F(),n=C("items");return e.jsxs(V,{children:[e.jsxs(w,{gap:12,vertical:!0,children:[e.jsx(H,{dirt:JSON.stringify(L(a)),isDirty:o,isSaving:m,onSave:t}),e.jsx(X,{block:!0,data:()=>we(s,n.data),disabled:o||g.isEmpty(n.data),fileName:"items-groups.json",hasNewData:u})]}),e.jsx(Q,{}),e.jsx(K,{label:"Display",onChange:c=>d({display:c,page:1},{page:1}),options:[{title:"By Groups",icon:e.jsx(te,{}),value:"group"},{title:"By Items",icon:e.jsx(re,{}),value:"item"}],value:p.get("display")??"group"}),e.jsx(Ie,{addEntryToUpdate:l,data:s}),r("display","item")&&e.jsx(_,{label:"No Groups Only",onChange:c=>x("emptyOnly",c,!1),value:r("emptyOnly")})]})}function L(s){return g.omitBy(g.cloneDeep(s),t=>g.isEmpty(t.itemsIds))}function we(s,t){return Object.keys(s).forEach(o=>{s[o].itemsIds=ee(v(s[o].itemsIds));const m=s[o].itemsIds.length,a=s[o].itemsIds.filter(l=>t[l].nsfw).length;a>m*.3&&(s[o].nsfw=!0,console.log(`ðŸ˜ˆ Group ${s[o].name.pt} has ${a} (${Math.round(a/m*100)}%) NSFW items`))}),se(L(s))}function ve({group:s,onUpdateGroupItems:t}){const o=m=>{t(s.id,[...s.itemsIds,m])};return e.jsxs("div",{children:[e.jsx(de,{onFinish:o}),e.jsx(ce,{excludeList:s.itemsIds,initialQuantity:0,onSelect:o})]})}const Ce=["8bc4f","96efa","c10eb","16ec3","2a97f","4bba8","565ed","5fb57","62a8b"];function B({item:s,itemGroups:t,groupsTypeahead:o,onUpdateItemGroups:m}){const a=R();return e.jsxs(he,{style:{maxWidth:250,...Te(t)},title:e.jsxs(e.Fragment,{children:[e.jsx(I.Text,{onClick:()=>a(s.id),children:s.id}),e.jsx(ue,{item:s})]}),children:[e.jsx(pe,{item:s,width:75}),e.jsxs(T,{className:"my-4",orientation:"vertical",size:"small",children:[e.jsx(k,{item:s,language:"en"}),e.jsx(k,{item:s,language:"pt"}),e.jsx(xe,{defaultValue:t,filterOption:(l,u)=>!!u?.label.toLowerCase().includes(l.toLowerCase()),mode:"multiple",onChange:l=>m(s.id,l),options:o,placeholder:"Select a group",size:"small",style:{width:"100%"}},String(t))]})]})}const Te=s=>!s||s?.length===0?{borderColor:"orange"}:s?.every(t=>Ce.includes(t))?{borderColor:"red"}:{};function A({rows:s,items:t,grousByItem:o,groupsTypeahead:m,onUpdateItemGroups:a,onUpdateGroupItems:l,onUpdateName:u}){const p=R(),x=C("items"),[d,r]=y.useState(null),n=le({showQuickJumper:!0,total:s.length}),c=[{title:"id",dataIndex:"id",key:"id",render:i=>e.jsx("div",{children:e.jsx(ie,{children:i})})},{title:"Name",dataIndex:"name",key:"name",render:(i,j)=>e.jsxs(w,{gap:4,vertical:!0,children:[e.jsx(D,{language:"en",onChange:f=>u(f.target.value,"en",j.id),style:{minWidth:150},value:i}),e.jsx(D,{language:"pt",onChange:f=>u(f.target.value,"pt",j.id),style:{minWidth:150},value:i})]})},{title:"Items",dataIndex:"itemsIds",key:"itemsIds",render:(i,j)=>e.jsx(w,{gap:6,wrap:"wrap",children:i.map(f=>e.jsxs(w,{gap:2,vertical:!0,children:[e.jsx(oe,{onClick:()=>r(f),children:e.jsx(ae,{itemId:f,width:60})}),e.jsx(w,{justify:"center",children:e.jsx(I.Text,{onClick:()=>p(f),children:f})})]},`${j.id}-${f}`))},`items-${j.id}`)},E.EXPAND_COLUMN,{title:"Count",dataIndex:"itemsIds",key:"count",render:i=>v(i).filter(Boolean).length},{title:"Actions",dataIndex:"itemsIds",key:"actions",render:i=>e.jsx(me,{ids:i})}],h=d?t[d]:null,S=ne({maxExpandedRows:1,expandedRowRender:i=>e.jsx(ve,{group:i,onUpdateGroupItems:l}),rowExpandable:()=>x.isSuccess});return e.jsxs(e.Fragment,{children:[e.jsx(E,{className:"my-4",columns:c,dataSource:s,expandable:S,pagination:n,rowKey:"id"}),e.jsx(je,{onClose:()=>r(null),open:!!h,title:"Edit Item Group",children:h&&e.jsx(B,{groupsTypeahead:m,item:h,itemGroups:o[h.id],onUpdateItemGroups:a})})]})}function Fe({items:s,grousByItem:t,groupsTypeahead:o,onUpdateItemGroups:m}){const{is:a}=F(),l=a("emptyOnly"),u=y.useMemo(()=>l?Object.values(s).filter(d=>!t[d.id]):Object.values(s),[s,t,l]),{page:p,pagination:x}=fe({data:u});return e.jsxs(e.Fragment,{children:[e.jsxs(I.Title,{level:2,children:["Groups by Items (",u.length,")"]}),e.jsx(ye,{pagination:x,children:e.jsx(z,{className:"my-4",gutter:[16,16],children:p.map(d=>e.jsx(q,{lg:6,md:12,sm:24,xl:4,xs:24,children:e.jsx(B,{groupsTypeahead:o,item:d,itemGroups:t[d.id],onUpdateItemGroups:m})},d.id))})})]})}function Ge({data:s,items:t,grousByItem:o,groupsTypeahead:m,onUpdateItemGroups:a,onUpdateGroupItems:l,onUpdateName:u}){const[p,x]=y.useState(null),d=y.useMemo(()=>p?s[p]:null,[p,s]);return e.jsxs(T,{orientation:"vertical",children:[e.jsx(I.Title,{level:5,children:"Search Groups"}),e.jsx(ge,{data:s,onFinish:r=>x(r),parser:Oe,placeholder:"Search group by name...",style:{width:"100%",minWidth:450}}),!!d&&e.jsx(A,{groupsTypeahead:m,grousByItem:o,items:t,onUpdateGroupItems:l,onUpdateItemGroups:a,onUpdateName:u,rows:[d]})]})}const Oe=s=>Object.values(s??{}).reduce((t,o)=>(t[`${o.name.en}`]=o.id,t[`${o.name.pt}`]=o.id,t),{});function Ne({data:s,addEntryToUpdate:t}){const{is:o,queryParams:m}=F(),a=C("items"),l=y.useMemo(()=>Object.values(s??[]).reduce((r,n)=>(n.itemsIds||console.warn("Group without items",n),n.itemsIds.forEach(c=>{r[c]||(r[c]=[]),r[c].push(n.id)}),r),{}),[s]),u=y.useMemo(()=>g.orderBy(Object.values(s).flatMap(({id:r,name:n})=>[{label:`${n.en} [${r}]`,value:r}]),"label"),[s]),p=(r,n)=>{const c=l[r]??[],h=n.filter(i=>!c.includes(i)),S=c.filter(i=>!n.includes(i));h.forEach(i=>{const j=s[i];t(i,{...j,itemsIds:v([...j?.itemsIds??[],r])})}),S.forEach(i=>{const j=s[i];t(i,{...j,itemsIds:v(j?.itemsIds.filter(f=>f!==r))})})},x=(r,n)=>{const c=s[r];t(r,{...c,itemsIds:v(n)})},d=(r,n,c)=>{const h=s[c];t(c,{...h,name:{...h.name,[n]:r}})};return e.jsxs(e.Fragment,{children:[(o("display","group")||!m.has("display"))&&e.jsxs(T,{className:"mb-4",orientation:"vertical",children:[e.jsx(Ge,{data:s,groupsTypeahead:u,grousByItem:l,items:a.data,onUpdateGroupItems:x,onUpdateItemGroups:p,onUpdateName:d}),e.jsxs(I.Title,{level:2,children:["Groups (",Object.keys(s).length,")"]}),e.jsx(A,{groupsTypeahead:u,grousByItem:l,items:a.data,onUpdateGroupItems:x,onUpdateItemGroups:p,onUpdateName:d,rows:Object.values(s)})]}),o("display","item")&&e.jsx(Fe,{groupsTypeahead:u,grousByItem:l,items:a.data,onUpdateGroupItems:x,onUpdateItemGroups:p,onUpdateName:d})]})}function Ns(){const s=be({tdrResourceName:"items-groups",firestoreDataCollectionName:"itemsGroups",serialize:!0}),t=C("items");return e.jsx(U,{subtitle:"Groups Sets",title:"Items",children:e.jsxs(O,{hasSider:!0,children:[e.jsx(Y,{children:e.jsx(Se,{...s})}),e.jsx(O.Content,{className:"content",children:e.jsx(J,{error:s.error||t.error,hasResponseData:!g.isEmpty(s.data)&&!g.isEmpty(t.data),isLoading:s.isLoading||t.isLoading,children:e.jsx(Ne,{...s})})})]})})}export{Ns as ItemsGroups,Ns as default};
