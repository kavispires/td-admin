import{r as y,b,h as $,j as e,B as M,a1 as W,a as G,T as I,F as w,D as Q,R as z,C as q,P as U,L as O}from"./index-D37itX2d.js";import{D as J}from"./DataLoadingWrapper-Ci-O23Yo.js";import{F as K,b as _}from"./FilterEntries-DNpdH5X6.js";import{S as V}from"./SiderContent-CFdUCslS.js";import{D as X}from"./DownloadButton-BI6fVBt5.js";import{S as H}from"./SaveButton-Dcml--l0.js";import{u as T}from"./useQueryParams-Cd5Aniy8.js";import{u as v}from"./useTDResource-CagVVubj.js";import{l as g,P as Y}from"./useBaseUrl-BRxm3gcj.js";import{c as N,g as Z,d as ee,r as C,a as se}from"./index-DyrmBSk6.js";import{L as P}from"./LanguageFlag-CtO1qwbd.js";import{R as te}from"./ClusterOutlined-Dj6-gUMY.js";import{R as re}from"./TableOutlined-DG0FcSyK.js";import{T as oe}from"./TransparentButton-CngecIPB.js";import{D}from"./EditableFields-BdHeamd3.js";import{I as ie}from"./Item-BZivEtnW.js";import{u as E}from"./useCopyToClipboardFunction-h3TNarmO.js";import{u as ae}from"./useTableExpandableRows-ymXZXgBA.js";import{u as ne}from"./useTablePagination-CWcVMAcq.js";import{C as le}from"./CopyIdsButton-BT33qhXs.js";import{I as me}from"./InspirationSample-mVwhWoXT.js";import{I as ce}from"./ItemsTypeahead-BjjVqgxF.js";import{a as de,b as k,c as pe}from"./ItemBuildingBlocks-FusBcXYW.js";import{C as ue}from"./index-DtnX76sG.js";import{S as F}from"./index-57nd00jp.js";import{S as he}from"./index-CkobVGKs.js";import{F as R}from"./Table-B-52N5yy.js";import{D as xe}from"./index-9FGWoHBu.js";import{u as je,P as fe}from"./useGridPagination-DVxlVMXZ.js";import{T as ye}from"./Typeahead-DZK0WiD5.js";import{u as ge}from"./useResourceFirestoreData-C9wyCMTh.js";import"./index-D7yYZq8k.js";import"./index-Crd1jx2_.js";import"./moment-C5S46NFB.js";import"./SaveOutlined-Pe7M9McS.js";import"./constants-BG7avbge.js";import"./FireFilled-RqRB6LJp.js";import"./IdcardOutlined-Ctp3zL4Z.js";import"./index-B0-FyCLI.js";import"./SyncOutlined-HaEWzFUy.js";import"./PlusOutlined-DVYQm6gE.js";import"./useDebounce-DGApTwHz.js";import"./index-B5mthAFs.js";import"./index-D6mj_CVi.js";import"./index-CTtYF_lN.js";import"./index-YhnuB92G.js";import"./scrollTo-CLquuyzb.js";import"./Pagination-CpqhVvnV.js";import"./useGetFirestoreDoc-C87ZD_I3.js";import"./useUpdateFirestoreDoc-eF0U8SW6.js";import"./useMutation-v59Ucof-.js";function be({addEntryToUpdate:s,data:t}){const[o,m]=y.useState(!1),[a]=b.useForm(),{notification:l}=$.useApp(),u=r=>{const n=Z(Object.keys(t));s(n,{id:n,name:{pt:r.nome,en:r.name},itemsIds:[],keywords:r.keywords}),l.success({message:"Group added successfully"}),m(!1),a.resetFields()},p=b.useWatch("name",a),x=b.useWatch("nome",a),d=y.useMemo(()=>{const r={};if(p&&p.length>2){const c=Object.entries(t).reduce((h,[S,i])=>{const j=N.compareTwoStrings(i.name.en,p),f=N.compareTwoStrings(i.name.pt,x);return(j>.2||f>.2)&&(h[S]=Math.max(j,f)),h},{});Object.keys(c).forEach(h=>{r[h]=c[h]})}return Object.keys(r)},[p,x,t]);return e.jsxs(e.Fragment,{children:[e.jsx(M,{block:!0,className:"mb-4",onClick:()=>m(!0),type:"dashed",children:"Add New Group"}),e.jsxs(W,{maskClosable:!1,okButtonProps:{htmlType:"submit"},okText:"Add",onCancel:()=>m(!1),onOk:a.submit,open:o,title:"Add New Set",children:[e.jsxs(b,{form:a,onFinish:u,children:[e.jsx(b.Item,{label:"Nome",name:"nome",rules:[{required:!0}],children:e.jsx(G,{placeholder:"Name in pt",prefix:e.jsx(P,{language:"pt",width:"1em"}),size:"small"})}),e.jsx(b.Item,{label:"Name",name:"name",rules:[{required:!0}],children:e.jsx(G,{placeholder:"Name in en",prefix:e.jsx(P,{language:"en",width:"1em"}),size:"small"})})]}),e.jsx(I.Text,{children:"Similar:"}),e.jsx("ul",{children:d.map(r=>e.jsxs("li",{children:[r," - ",t[r]?.name.en," / ",t[r]?.name.pt]},r))})]})]})}function Ie({data:s,save:t,isDirty:o,isSaving:m,entriesToUpdate:a,addEntryToUpdate:l,hasFirestoreData:u}){const{queryParams:p,addParam:x,addParams:d,is:r}=T(),n=v("items");return e.jsxs(V,{children:[e.jsxs(w,{gap:12,vertical:!0,children:[e.jsx(H,{dirt:JSON.stringify(L(a)),isDirty:o,isSaving:m,onSave:t}),e.jsx(X,{block:!0,data:()=>Se(s,n.data),disabled:o||g.isEmpty(n.data),fileName:"items-groups.json",hasNewData:u})]}),e.jsx(Q,{}),e.jsx(K,{label:"Display",onChange:c=>d({display:c,page:1},{page:1}),options:[{title:"By Groups",icon:e.jsx(te,{}),value:"group"},{title:"By Items",icon:e.jsx(re,{}),value:"item"}],value:p.get("display")??"group"}),e.jsx(be,{addEntryToUpdate:l,data:s}),r("display","item")&&e.jsx(_,{label:"No Groups Only",onChange:c=>x("emptyOnly",c,!1),value:r("emptyOnly")})]})}function L(s){return g.omitBy(g.cloneDeep(s),t=>g.isEmpty(t.itemsIds))}function Se(s,t){return Object.keys(s).forEach(o=>{s[o].itemsIds=ee(C(s[o].itemsIds));const m=s[o].itemsIds.length,a=s[o].itemsIds.filter(l=>t[l].nsfw).length;a>m*.3&&(s[o].nsfw=!0,console.log(`ðŸ˜ˆ Group ${s[o].name.pt} has ${a} (${Math.round(a/m*100)}%) NSFW items`))}),se(L(s))}function we({group:s,onUpdateGroupItems:t}){const o=m=>{t(s.id,[...s.itemsIds,m])};return e.jsxs("div",{children:[e.jsx(ce,{onFinish:o}),e.jsx(me,{excludeList:s.itemsIds,initialQuantity:0,onSelect:o})]})}const Ce=["8bc4f","96efa","c10eb","16ec3","2a97f","4bba8","565ed","5fb57","62a8b"];function B({item:s,itemGroups:t,groupsTypeahead:o,onUpdateItemGroups:m}){const a=E();return e.jsxs(ue,{style:{maxWidth:250,...ve(t)},title:e.jsxs(e.Fragment,{children:[e.jsx(I.Text,{onClick:()=>a(s.id),children:s.id}),e.jsx(pe,{item:s})]}),children:[e.jsx(de,{item:s,width:75}),e.jsxs(F,{className:"my-4",direction:"vertical",size:"small",children:[e.jsx(k,{item:s,language:"en"}),e.jsx(k,{item:s,language:"pt"}),e.jsx(he,{defaultValue:t,filterOption:(l,u)=>!!u?.label.toLowerCase().includes(l.toLowerCase()),mode:"multiple",onChange:l=>m(s.id,l),options:o,placeholder:"Select a group",size:"small",style:{width:"100%"}},String(t))]})]})}const ve=s=>!s||s?.length===0?{borderColor:"orange"}:s?.every(t=>Ce.includes(t))?{borderColor:"red"}:{};function A({rows:s,items:t,grousByItem:o,groupsTypeahead:m,onUpdateItemGroups:a,onUpdateGroupItems:l,onUpdateName:u}){const p=E(),x=v("items"),[d,r]=y.useState(null),n=ne({showQuickJumper:!0,total:s.length}),c=[{title:"id",dataIndex:"id",key:"id",render:i=>e.jsx("span",{children:i})},{title:"Name",dataIndex:"name",key:"name",render:(i,j)=>e.jsxs(w,{gap:4,vertical:!0,children:[e.jsx(D,{language:"en",onChange:f=>u(f.target.value,"en",j.id),style:{minWidth:150},value:i}),e.jsx(D,{language:"pt",onChange:f=>u(f.target.value,"pt",j.id),style:{minWidth:150},value:i})]})},{title:"Items",dataIndex:"itemsIds",key:"itemsIds",render:(i,j)=>e.jsx(w,{gap:6,wrap:"wrap",children:i.map(f=>e.jsxs(w,{gap:2,vertical:!0,children:[e.jsx(oe,{onClick:()=>r(f),children:e.jsx(ie,{itemId:f,width:60})}),e.jsx(w,{justify:"center",children:e.jsx(I.Text,{onClick:()=>p(f),children:f})})]},`${j.id}-${f}`))},`items-${j.id}`)},R.EXPAND_COLUMN,{title:"Count",dataIndex:"itemsIds",key:"count",render:i=>C(i).filter(Boolean).length},{title:"Actions",dataIndex:"itemsIds",key:"actions",render:i=>e.jsx(le,{ids:i})}],h=d?t[d]:null,S=ae({maxExpandedRows:1,expandedRowRender:i=>e.jsx(we,{group:i,onUpdateGroupItems:l}),rowExpandable:()=>x.isSuccess});return e.jsxs(e.Fragment,{children:[e.jsx(R,{className:"my-4",columns:c,dataSource:s,expandable:S,pagination:n,rowKey:"id"}),e.jsx(xe,{onClose:()=>r(null),open:!!h,title:"Edit Item Group",children:h&&e.jsx(B,{groupsTypeahead:m,item:h,itemGroups:o[h.id],onUpdateItemGroups:a})})]})}function Te({items:s,grousByItem:t,groupsTypeahead:o,onUpdateItemGroups:m}){const{is:a}=T(),l=a("emptyOnly"),u=y.useMemo(()=>l?Object.values(s).filter(d=>!t[d.id]):Object.values(s),[s,t,l]),{page:p,pagination:x}=je({data:u});return e.jsxs(e.Fragment,{children:[e.jsxs(I.Title,{level:2,children:["Groups by Items (",u.length,")"]}),e.jsx(fe,{pagination:x,children:e.jsx(z,{className:"my-4",gutter:[16,16],children:p.map(d=>e.jsx(q,{lg:6,md:12,sm:24,xl:4,xs:24,children:e.jsx(B,{groupsTypeahead:o,item:d,itemGroups:t[d.id],onUpdateItemGroups:m})},d.id))})})]})}function Fe({data:s,items:t,grousByItem:o,groupsTypeahead:m,onUpdateItemGroups:a,onUpdateGroupItems:l,onUpdateName:u}){const[p,x]=y.useState(null),d=y.useMemo(()=>p?s[p]:null,[p,s]);return e.jsxs(F,{direction:"vertical",children:[e.jsx(I.Title,{level:5,children:"Search Groups"}),e.jsx(ye,{data:s,onFinish:r=>x(r),parser:Ge,placeholder:"Search group by name...",style:{width:"100%",minWidth:450}}),!!d&&e.jsx(A,{groupsTypeahead:m,grousByItem:o,items:t,onUpdateGroupItems:l,onUpdateItemGroups:a,onUpdateName:u,rows:[d]})]})}const Ge=s=>Object.values(s??{}).reduce((t,o)=>(t[`${o.name.en}`]=o.id,t[`${o.name.pt}`]=o.id,t),{});function Oe({data:s,addEntryToUpdate:t}){const{is:o,queryParams:m}=T(),a=v("items"),l=y.useMemo(()=>Object.values(s??[]).reduce((r,n)=>(n.itemsIds||console.warn("Group without items",n),n.itemsIds.forEach(c=>{r[c]||(r[c]=[]),r[c].push(n.id)}),r),{}),[s]),u=y.useMemo(()=>g.orderBy(Object.values(s).flatMap(({id:r,name:n})=>[{label:`${n.en} [${r}]`,value:r}]),"label"),[s]),p=(r,n)=>{const c=l[r]??[],h=n.filter(i=>!c.includes(i)),S=c.filter(i=>!n.includes(i));h.forEach(i=>{const j=s[i];t(i,{...j,itemsIds:C([...j?.itemsIds??[],r])})}),S.forEach(i=>{const j=s[i];t(i,{...j,itemsIds:C(j?.itemsIds.filter(f=>f!==r))})})},x=(r,n)=>{const c=s[r];t(r,{...c,itemsIds:C(n)})},d=(r,n,c)=>{const h=s[c];t(c,{...h,name:{...h.name,[n]:r}})};return e.jsxs(e.Fragment,{children:[(o("display","group")||!m.has("display"))&&e.jsxs(F,{className:"mb-4",direction:"vertical",children:[e.jsx(Fe,{data:s,groupsTypeahead:u,grousByItem:l,items:a.data,onUpdateGroupItems:x,onUpdateItemGroups:p,onUpdateName:d}),e.jsxs(I.Title,{level:2,children:["Groups (",Object.keys(s).length,")"]}),e.jsx(A,{groupsTypeahead:u,grousByItem:l,items:a.data,onUpdateGroupItems:x,onUpdateItemGroups:p,onUpdateName:d,rows:Object.values(s)})]}),o("display","item")&&e.jsx(Te,{groupsTypeahead:u,grousByItem:l,items:a.data,onUpdateGroupItems:x,onUpdateItemGroups:p,onUpdateName:d})]})}function Fs(){const s=ge({tdrResourceName:"items-groups",firestoreDataCollectionName:"itemsGroups",serialize:!0}),t=v("items");return e.jsx(U,{subtitle:"Groups Sets",title:"Items",children:e.jsxs(O,{hasSider:!0,children:[e.jsx(Y,{children:e.jsx(Ie,{...s})}),e.jsx(O.Content,{className:"content",children:e.jsx(J,{error:s.error||t.error,hasResponseData:!g.isEmpty(s.data)&&!g.isEmpty(t.data),isLoading:s.isLoading||t.isLoading,children:e.jsx(Oe,{...s})})})]})})}export{Fs as ItemsGroups,Fs as default};
