import{r as b,a as B,_ as $,j as e,T as O,B as C,at as Y,ao as pe,G as z,D as re,aq as ge,P as je,L as G}from"./index-IdPNWoIA.js";import{D as xe}from"./DataLoadingWrapper-Ch7gITbQ.js";import{l as T,c as ie,P as be}from"./useBaseUrl-DjlPP39F.js";import{u as P}from"./useQueryParams-DGhPKHGQ.js";import{R as we}from"./main-CRm5XwKC.js";import{u as ye,a as oe,c as ve,n as Se,b as ke}from"./useTestimoniesResource-CviXJyoV.js";import{g as Ce}from"./useParsedHistory-C9Kv-I9L.js";import{S as H}from"./SuspectImageCard-K3CLDMO_.js";import{u as Oe}from"./useTDResource-CfJUpd5i.js";import{F as k}from"./index-ZnkpdGSt.js";import{T as ce,S as Te,F as Re}from"./FilterEntries-CyKTUyXf.js";import{B as q,D as Ie}from"./DownloadButton-4fgxXpYm.js";import{S as F}from"./index-CMeCFo_f.js";import{u as ae}from"./useTableExpandableRows-BM5cnxLl.js";import{u as le}from"./useTablePagination-Bx88m9C-.js";import{P as J}from"./progress-CNqIDt1y.js";import{S as E}from"./index-CHVKldSs.js";import{F as Q}from"./Table-BGFXocYS.js";import{I as De}from"./index-BdT5DDDg.js";import{u as Pe}from"./useCardWidth-BvvDwNJ5.js";import{C as ue}from"./index-fvaD2JJj.js";import{P as K}from"./index-C2abbVwP.js";import{R as Ne}from"./FireFilled-DkC8lz7U.js";import{S as V}from"./SiderContent-Dmz6UsoL.js";import{F as X}from"./FirestoreConsoleLink-N6QCZDfq.js";import{S as Ae}from"./SaveButton-BCIdkMt5.js";import{S as Me}from"./SuspectsStyleVariantSelector-BhWDXure.js";import{g as Fe}from"./useGetFirestoreDoc-CTs4B5gQ.js";import{e as Ee,a as ze,d as Be}from"./index-Bp_ut9CP.js";import{u as de}from"./useWindowSize-BWeYQ8sv.js";import{M as he}from"./index-CY1knO-G.js";import{R as $e}from"./TableOutlined-CZ4hOfoz.js";import{R as He}from"./RobotOutlined-DqzYa12Z.js";import"./useResourceFirestoreData-qCAexMbx.js";import"./useUpdateFirestoreDoc-3YFipcOY.js";import"./useMutation-C19tV37G.js";import"./moment-C5S46NFB.js";import"./ImageCard-B5JJASJ7.js";import"./gapSize-U1swVQyS.js";import"./index-B2c0zKQZ.js";import"./index-gsdKC-Cu.js";import"./index-mJOv3lac.js";import"./index-Bq046HYO.js";import"./scrollTo-HDAe66fN.js";import"./Pagination-BZ0Q2Ye7.js";import"./Input-DErVaEmv.js";import"./SaveOutlined-BeXDflC8.js";import"./constants-B6u4zE9X.js";import"./Item-DFZhjtxG.js";var Le={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M864 144H560c-8.8 0-16 7.2-16 16v304c0 8.8 7.2 16 16 16h304c8.8 0 16-7.2 16-16V160c0-8.8-7.2-16-16-16zm0 400H560c-8.8 0-16 7.2-16 16v304c0 8.8 7.2 16 16 16h304c8.8 0 16-7.2 16-16V560c0-8.8-7.2-16-16-16zM464 144H160c-8.8 0-16 7.2-16 16v304c0 8.8 7.2 16 16 16h304c8.8 0 16-7.2 16-16V160c0-8.8-7.2-16-16-16zm0 400H160c-8.8 0-16 7.2-16 16v304c0 8.8 7.2 16 16 16h304c8.8 0 16-7.2 16-16V560c0-8.8-7.2-16-16-16z"}}]},name:"appstore",theme:"filled"},Ve=function(i,a){return b.createElement(B,$({},i,{ref:a,icon:Le}))},qe=b.forwardRef(Ve),Ue={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M512 624c93.9 0 170-75.2 170-168V232c0-92.8-76.1-168-170-168s-170 75.2-170 168v224c0 92.8 76.1 168 170 168zm330-170c0-4.4-3.6-8-8-8h-60c-4.4 0-8 3.6-8 8 0 140.3-113.7 254-254 254S258 594.3 258 454c0-4.4-3.6-8-8-8h-60c-4.4 0-8 3.6-8 8 0 168.7 126.6 307.9 290 327.6V884H326.7c-13.7 0-24.7 14.3-24.7 32v36c0 4.4 2.8 8 6.2 8h407.6c3.4 0 6.2-3.6 6.2-8v-36c0-17.7-11-32-24.7-32H548V782.1c165.3-18 294-158 294-328.1z"}}]},name:"audio",theme:"filled"},Qe=function(i,a){return b.createElement(B,$({},i,{ref:a,icon:Ue}))},We=b.forwardRef(Qe),_e={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M594.3 601.5a111.8 111.8 0 0029.1-75.5c0-61.9-49.9-112-111.4-112s-111.4 50.1-111.4 112c0 29.1 11 55.5 29.1 75.5a158.09 158.09 0 00-74.6 126.1 8 8 0 008 8.4H407c4.2 0 7.6-3.3 7.9-7.5 3.8-50.6 46-90.5 97.2-90.5s93.4 40 97.2 90.5c.3 4.2 3.7 7.5 7.9 7.5H661a8 8 0 008-8.4c-2.8-53.3-32-99.7-74.7-126.1zM512 578c-28.5 0-51.7-23.3-51.7-52s23.2-52 51.7-52 51.7 23.3 51.7 52-23.2 52-51.7 52zm416-354H768v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H548v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H328v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H96c-17.7 0-32 14.3-32 32v576c0 17.7 14.3 32 32 32h832c17.7 0 32-14.3 32-32V256c0-17.7-14.3-32-32-32zm-40 568H136V296h120v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h148v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h148v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h120v496z"}}]},name:"contacts",theme:"outlined"},Ye=function(i,a){return b.createElement(B,$({},i,{ref:a,icon:_e}))},Ge=b.forwardRef(Ye),Je={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M870 126H663.8c-17.4 0-32.9 11.9-37 29.3C614.3 208.1 567 246 512 246s-102.3-37.9-114.8-90.7a37.93 37.93 0 00-37-29.3H154a44 44 0 00-44 44v252a44 44 0 0044 44h75v388a44 44 0 0044 44h478a44 44 0 0044-44V466h75a44 44 0 0044-44V170a44 44 0 00-44-44z"}}]},name:"skin",theme:"filled"},Ke=function(i,a){return b.createElement(B,$({},i,{ref:a,icon:Je}))},Xe=b.forwardRef(Ke),Ze={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M868 160h-92v-40c0-4.4-3.6-8-8-8H256c-4.4 0-8 3.6-8 8v40h-92a44 44 0 00-44 44v148c0 81.7 60 149.6 138.2 162C265.6 630.2 359 721.8 476 734.5v105.2H280c-17.7 0-32 14.3-32 32V904c0 4.4 3.6 8 8 8h512c4.4 0 8-3.6 8-8v-32.3c0-17.7-14.3-32-32-32H548V734.5C665 721.8 758.4 630.2 773.8 514 852 501.6 912 433.7 912 352V204a44 44 0 00-44-44zM248 439.6c-37.1-11.9-64-46.7-64-87.6V232h64v207.6zM840 352c0 41-26.9 75.8-64 87.6V232h64v120z"}}]},name:"trophy",theme:"filled"},et=function(i,a){return b.createElement(B,$({},i,{ref:a,icon:Ze}))},Z=b.forwardRef(et);function tt(){var t=b.useRef(!0);return t.current?(t.current=!1,!0):t.current}function nt(t,i){return typeof t=="function"?t.length?t(i):t():t}function me(t,i,a){if(i===void 0&&(i=10),i<1)throw new Error("Capacity has to be greater than 1, got '"+i+"'");var u=tt(),d=b.useState(t),p=d[0],h=d[1],l=b.useRef([]),r=b.useRef(0);u&&(l.current.length?(l.current[l.current.length-1]!==t&&l.current.push(t),l.current.length>i&&(l.current=l.current.slice(l.current.length-i))):l.current.push(t),r.current=l.current.length&&l.current.length-1);var m=b.useCallback(function(n){h(function(c){return n=nt(n,c),n!==c&&(r.current<l.current.length-1&&(l.current=l.current.slice(0,r.current+1)),r.current=l.current.push(n)-1,l.current.length>i&&(l.current=l.current.slice(l.current.length-i))),n})},[p,i]),o=b.useMemo(function(){return{history:l.current,position:r.current,capacity:i,back:function(n){n===void 0&&(n=1),r.current&&h(function(){return r.current-=Math.min(n,r.current),l.current[r.current]})},forward:function(n){n===void 0&&(n=1),r.current!==l.current.length-1&&h(function(){return r.current=Math.min(r.current+n,l.current.length-1),l.current[r.current]})},go:function(n){n!==r.current&&h(function(){return r.current=n<0?Math.max(l.current.length+n,0):Math.min(l.current.length-1,n),l.current[r.current]})}}},[p]);return[p,m,o]}function st(){const[t,i]=b.useState({batchSize:1,history:{}}),a=b.useRef(1),{entries:u}=ye(!0,"pt",t.batchSize,t.history),d=Oe("suspects",!T.isEmpty(u));return console.log(it(u,d.data??{})),e.jsxs(k,{className:"p-4",gap:12,vertical:!0,children:[e.jsxs(k,{align:"center",justify:"space-between",children:[e.jsx(O.Title,{className:"my-0",level:4,children:"Espionagem Simulator"}),e.jsxs(k,{gap:6,children:[e.jsx(ce,{defaultValue:1,max:100,min:1,onChange:p=>{a.current=p??1}}),e.jsx(C,{onClick:()=>i({batchSize:a.current,history:{}}),type:"primary",children:"Re-run Simulation"})]})]}),e.jsx(rt,{entries:u})]})}function rt({entries:t}){const[i,a]=b.useState(!1),u=Ce(),d=t[u],p=b.useMemo(()=>d?d.statements.reduce((h,l)=>{const{excludes:r}=l;return r.forEach(m=>{h[m]?h[m]++:h[m]=1}),h},{}):{},[d]);return e.jsxs("div",{className:"full-width grid",style:{gridTemplateColumns:"2fr 3fr"},children:[e.jsx(we,{collapsed:3,src:t??{},theme:"twilight"}),e.jsx("div",{children:d&&e.jsxs(k,{className:"p-4",gap:18,children:[e.jsx("div",{children:e.jsx("div",{style:{width:`${105*4}px`,display:"grid",gap:"6px",gridTemplateColumns:"repeat(4, 1fr)"},children:d.suspects.map(h=>e.jsxs(q.Ribbon,{color:"cyan",text:i?p[h.id]:null,children:[e.jsx(H,{className:ie(i&&h.id===d.culpritId&&"red-border"),id:h.id,width:96},h.id),e.jsxs(k,{align:"center",gap:6,children:[e.jsx(F,{checkedChildren:"🚫",size:"small"})," ",h.id]})]},h.id))})}),e.jsxs("div",{children:[e.jsx("div",{children:e.jsx(F,{checked:i,checkedChildren:"Show Culprit",onChange:a,unCheckedChildren:"Hide Culprit"})}),d.statements.map(h=>e.jsx(O.Paragraph,{children:e.jsx(q,{color:"cyan",count:h.excludes.length,children:e.jsx(Y,{banner:!0,icon:ee(h.type),message:h.text,type:"info"},h.key)})},h.key)),d.additionalStatements.map(h=>e.jsx(O.Paragraph,{children:e.jsx(q,{color:"cyan",count:h.excludes.length,children:e.jsx(Y,{banner:!0,icon:ee(h.type),message:h.text,type:"warning"},h.key)})},h.key))]})]})})]})}const ee=t=>{switch(t){case"testimony":return e.jsx(We,{});case"feature":return e.jsx(Xe,{});case"grid":return e.jsx(qe,{});default:return"❓"}},it=(t,i)=>{const a=Object.values(t).reduce((u,d)=>(d.suspects.forEach(p=>{u[p.id]=(u[p.id]||0)+1,p.id===d.culpritId&&(u[`${p.id}_culprit`]=(u[`${p.id}_culprit`]||0)+1)}),u),{});return Object.values(i).forEach(u=>{a[u.id]||(a[u.id]=0),a[`${u.id}_culprit`]||(a[`${u.id}_culprit`]=0)}),a};function fe({suspect:t,values:i,resolution:a,projection:u,yesPercentage:d,noPercentage:p,complete:h,enoughData:l,testimonyId:r,addEntryToUpdate:m,answers:o,barWidth:n,showName:c}){const s=x=>{const f={...o};f[x]=[...f[x]||[],3],m(r,f)},g=x=>{const f={...o};f[x]=[...f[x]||[],-3],m(r,f)},S=x=>{var w;const f={...o},y=(w=f[x])==null?void 0:w.findIndex(v=>v===3);y!==-1&&y!==void 0&&(f[x]=[...f[x].slice(0,y),...f[x].slice(y+1)]),m(r,f)},j=x=>{var w;const f={...o},y=(w=f[x])==null?void 0:w.findIndex(v=>v===-3);y!==-1&&y!==void 0&&(f[x]=[...f[x].slice(0,y),...f[x].slice(y+1)]),m(r,f)};return e.jsxs(pe,{content:e.jsxs(k,{gap:4,vertical:!0,children:[e.jsx(O.Text,{type:"secondary",children:i.join(", ")}),e.jsxs(C,{block:!0,icon:"👍",onClick:()=>s(t.id),children:[" ","Add strong fit"]}),e.jsxs(C,{block:!0,icon:"👎",onClick:()=>g(t.id),children:[" ","Add strong unfit"]}),e.jsxs(E.Compact,{children:[e.jsx(C,{block:!0,icon:"❌",onClick:()=>S(t.id),size:"small",children:"fit"}),e.jsx(C,{block:!0,icon:"❌",onClick:()=>j(t.id),size:"small",children:"unfit"})]})]}),title:`Add strong fit/unfit answer to ${t.name.pt}`,trigger:"click",children:[c&&e.jsxs("div",{children:[e.jsx(z,{title:t.id,children:t.name.pt})," ",h&&e.jsx(z,{title:"Complete: It has 5 or more answers",children:e.jsx(Z,{style:{color:"gold"}})})]}),e.jsxs(k,{align:"flex-start",gap:12,children:[e.jsx(z,{title:`Values: ${i.join(", ")} : ${a||(u?`${u}*`:"")}`,children:l?e.jsx(J,{percent:p+d,showInfo:!1,size:[n,20],status:"exception",success:{percent:d}}):e.jsx(J,{percent:p+d,showInfo:!1,size:[n,10],status:"exception",success:{percent:d}})}),!c&&h&&e.jsx(z,{title:"Complete: It has 5 or more answers",children:e.jsx(Z,{style:{color:"gold"}})})]})]})}function ot({suspect:t,answersPerQuestion:i={},questions:a,addEntryToUpdate:u,allAnswers:d}){const{queryParams:p}=P({sortSuspectsBy:"answers"}),h=p.get("sortSuspectsBy")??"answers",l=b.useMemo(()=>{const o=Object.values(a).map(n=>{const c=i[n.id]??{},{enoughData:s,reliable:g,yesPercentage:S,noPercentage:j,blankPercentage:x,values:f,total:y,resolution:w,projection:v,complete:R}=oe(t.id,{[t.id]:c});return{id:n.id,question:n,enoughData:s,reliable:g,yesPercentage:S,noPercentage:j,blankPercentage:x,values:f,total:y,resolution:w,projection:v,complete:R}});return h==="answers"?T.orderBy(o,["reliable","enoughData","yesPercentage",n=>n.values.length],["desc","desc","desc","desc"]):T.orderBy(o,n=>Number(n.id.split("-")[1]),["asc"])},[i,a,t.id,h]),r=b.useMemo(()=>ct(t,l),[t,l]),m=[{key:"id",title:"Id",dataIndex:"id"},{key:"question",title:"Question",dataIndex:"question",render:o=>o.question},{key:"answer",title:"Answer",dataIndex:"id",sorter:(o,n)=>o.total-n.total,render:o=>{const n=l.find(c=>c.id===o);return n?e.jsx(k,{gap:8,wrap:"nowrap",children:e.jsx(fe,{addEntryToUpdate:u,answers:d[n.question.id]||{},barWidth:120,complete:n.complete,enoughData:n.enoughData,noPercentage:n.noPercentage,projection:n.projection,resolution:n.resolution,suspect:t,testimonyId:n.question.id,values:n.values,yesPercentage:n.yesPercentage})}):""}},{key:"actions",title:"Actions",dataIndex:"id",render:o=>{const n=l.find(c=>c.id===o);return n?e.jsx(at,{addEntryToUpdate:u,answers:d[n.question.id]||{},suspect:t,testimonyId:n.question.id,values:n.values}):""}}];return e.jsxs(E,{size:"large",wrap:!0,children:[e.jsx(Q,{bordered:!0,columns:m,dataSource:l,rowKey:"id"}),e.jsxs(k,{gap:8,vertical:!0,children:[e.jsx(O.Title,{level:5,children:"Suspect Description"}),e.jsx(De.TextArea,{className:"full-width",readOnly:!0,rows:7,value:r})]})]})}const ct=(t,i)=>{const a=i.filter(u=>u.resolution||u.projection).map(u=>{const{question:d,resolution:p,projection:h}=u,l=p||h;return`${t.gender==="male"?"ele":"ela"} ${l==="👍"?"":"não "}${d.answer.toLocaleLowerCase()}`});return`${t.name.pt}: ${a.join(", ")}`};function at({suspect:t,values:i,testimonyId:a,addEntryToUpdate:u,answers:d}){const p=m=>{const o={...d};o[m]=[...o[m]||[],3],u(a,o)},h=m=>{const o={...d};o[m]=[...o[m]||[],-3],u(a,o)},l=m=>{var c;const o={...d},n=(c=o[m])==null?void 0:c.findIndex(s=>s===3);n!==-1&&n!==void 0&&(o[m]=[...o[m].slice(0,n),...o[m].slice(n+1)]),u(a,o)},r=m=>{var c;const o={...d},n=(c=o[m])==null?void 0:c.findIndex(s=>s===-3);n!==-1&&n!==void 0&&(o[m]=[...o[m].slice(0,n),...o[m].slice(n+1)]),u(a,o)};return e.jsxs(E.Compact,{children:[e.jsxs(C,{block:!0,icon:"👍",onClick:()=>p(t.id),children:[" ","FIT"]}),e.jsxs(C,{block:!0,icon:"👎",onClick:()=>h(t.id),children:[" ","UNFIT"]}),e.jsx(C,{icon:"❌",onClick:()=>l(t.id),children:"DESFIT"}),e.jsx(C,{icon:"❌",onClick:()=>r(t.id),children:"DESUNFIT"})]})}function lt({isLoading:t,isSuccess:i,questions:a,data:u,suspects:d,addEntryToUpdate:p}){const{queryParams:h,addParam:l}=P(),r=b.useMemo(()=>Object.keys(u).reduce((s,g)=>{const S=u[g]??{};return Object.keys(S).forEach(j=>{s[j]||(s[j]={}),s[j][g]=S[j]}),s},{}),[u]),m=b.useMemo(()=>T.orderBy(Object.values(d).map(s=>({...s,answers:r[s.id]})),s=>Number(s.id.split("-")[1]),"asc"),[d,r]),o=le({total:m.length,showQuickJumper:!0}),n=[{title:"Id",dataIndex:"id",key:"id",sorter:(s,g)=>Number(s.id.split("-")[1])-Number(g.id.split("-")[1])},{title:"Picture",dataIndex:"id",render:s=>e.jsx(H,{id:s,width:48})},{title:"Name",dataIndex:"name",key:"name",sorter:(s,g)=>s.name.pt.localeCompare(g.name.pt),render:(s,g)=>e.jsxs(k,{vertical:!0,children:[e.jsx(O.Text,{children:s.pt}),e.jsx(O.Text,{type:"secondary",children:s.en}),e.jsx(O.Text,{italic:!0,type:"secondary",children:e.jsx("small",{children:g.note})})]})},{title:"Questions Answered",dataIndex:"answers",key:"answers",sorter:(s,g)=>Object.keys(s.answers??{}).length-Object.keys(g.answers??{}).length,render:s=>s?Object.values(s).length:""}],c=ae({maxExpandedRows:1,expandedRowRender:s=>e.jsx(ot,{addEntryToUpdate:p,allAnswers:u,answersPerQuestion:r[s.id],questions:a,suspect:s}),rowExpandable:()=>i});return e.jsxs(k,{className:"full-width py-4",gap:12,vertical:!0,children:[e.jsxs(k,{align:"center",justify:"space-between",children:[e.jsx(O.Title,{className:"my-0",level:4,children:"Testimonies by Suspect"}),e.jsx(F,{checked:h.get("sortSuspectsBy")==="answers",checkedChildren:"Sort by Answers",onChange:s=>l("sortSuspectsBy",s?"answers":"id"),unCheckedChildren:"Sort by Id"})]}),e.jsx(Q,{bordered:!0,className:"full-width",columns:n,dataSource:m,expandable:c,loading:t,pagination:o,rowKey:"id"})]})}function ut({answers:t,suspects:i,addEntryToUpdate:a,testimonyId:u}){const[d,p]=Pe(12),{queryParams:h,is:l}=P({sortSuspectsBy:"answers"}),r=l("enableBatch"),m=h.get("sortSuspectsBy")??"answers",o=b.useMemo(()=>{const s=Object.keys(i).map(g=>oe(g,t));return m==="answers"?T.orderBy(s,["reliable","enoughData",g=>g.values.length,"yesPercentage","noPercentage",g=>Number(g.suspectCardId.split("-")[1])],["desc","desc","desc","desc","desc","asc"]):T.orderBy(s,g=>Number(g.suspectCardId.split("-")[1]),["asc"])},[t,i,m]),[n,c]=b.useState([]);return e.jsxs(E,{direction:"vertical",children:[e.jsx(dt,{addEntryToUpdate:a,answers:t,list:o,selection:n,setSelection:c,suspects:i,testimonyId:u}),e.jsx(E,{ref:p,size:"large",wrap:!0,children:o.map(s=>e.jsxs(k,{className:ie({"selection-outline":r&&n.includes(s.suspectCardId)}),gap:6,vertical:!0,children:[e.jsx(H,{className:s.values.length>1?void 0:"grayscale",id:s.imageId,width:d}),e.jsxs(k,{gap:4,children:[r&&e.jsx(ue,{checked:n.includes(s.suspectCardId),disabled:s.complete,onChange:g=>{const S=g.target.checked;c(j=>S?[...j,s.suspectCardId]:j.filter(x=>x!==s.suspectCardId))}}),e.jsx(fe,{addEntryToUpdate:a,answers:t,barWidth:d,complete:s.complete,enoughData:s.enoughData,noPercentage:s.noPercentage,projection:s.projection,resolution:s.resolution,showName:!0,suspect:i[s.suspectCardId],testimonyId:u,values:s.values,yesPercentage:s.yesPercentage})]})]},s.suspectCardId))})]})}function dt({testimonyId:t,selection:i,setSelection:a,suspects:u,addEntryToUpdate:d,list:p,answers:h}){const[l,r]=b.useState([]),{addParam:m,removeParam:o,is:n}=P({sortSuspectsBy:"answers"}),c=n("enableBatch"),s=j=>{r(x=>x.includes(j)?x.filter(f=>f!==j):[...x,j])},g=b.useMemo(()=>T.keyBy(p,"suspectCardId"),[p]);b.useEffect(()=>{if(l.length===0&&i.length>0){a([]);return}if(!l.length)return;const x=(i.length>0?i:Object.values(g).filter(f=>!f.complete&&!f.values.includes(3)&&!f.values.includes(-3)).map(f=>f.suspectCardId)).filter(f=>{const y=u[f],w=[y.gender,y.ethnicity,y.build,y.height];return y.age==="18-21"&&w.push("young"),(y.age==="21-30"||y.age==="30-40")&&w.push("adult"),y.age==="40-50"&&w.push("parent"),(y.age==="50-60"||y.age==="60-70"||y.age==="70-80"||y.age==="80-90")&&w.push("senior"),l.every(v=>w.includes(v))});a(x)},[l]);const S=j=>{const x=T.cloneDeep(h);i.forEach(f=>{x[f]=[...x[f]||[],j]}),d(t,x),r([])};return e.jsxs(k,{align:"center",className:"mb-4",gap:6,justify:"space-between",children:[e.jsxs(k,{gap:3,children:[e.jsx(O.Text,{className:"nowrap",style:{minWidth:"5ch"},children:"Batch"}),e.jsx(F,{checkedChildren:"On",onChange:j=>{j?m("enableBatch",!0):o("enableBatch")},unCheckedChildren:"Off",value:c})]}),c&&e.jsxs(e.Fragment,{children:[e.jsxs(O.Text,{className:"nowrap mr-2",children:["Selected ",i.length]}),e.jsxs(k,{align:"center",gap:6,justify:"center",wrap:!0,children:[e.jsx(D,{activeFilters:l,filter:"male",updateActiveFilter:s}),e.jsx(D,{activeFilters:l,filter:"female",updateActiveFilter:s}),e.jsx(D,{activeFilters:l,filter:"young",updateActiveFilter:s}),e.jsx(D,{activeFilters:l,filter:"adult",updateActiveFilter:s}),e.jsx(D,{activeFilters:l,filter:"parent",updateActiveFilter:s}),e.jsx(D,{activeFilters:l,filter:"senior",updateActiveFilter:s}),e.jsx(D,{activeFilters:l,filter:"thin",updateActiveFilter:s}),e.jsx(D,{activeFilters:l,filter:"muscular",updateActiveFilter:s}),e.jsx(D,{activeFilters:l,filter:"large",updateActiveFilter:s}),e.jsx(D,{activeFilters:l,filter:"asian",updateActiveFilter:s}),e.jsx(D,{activeFilters:l,filter:"black",updateActiveFilter:s}),e.jsx(D,{activeFilters:l,filter:"caucasian",updateActiveFilter:s}),e.jsx(D,{activeFilters:l,filter:"latino",updateActiveFilter:s})]}),e.jsxs(k,{align:"center",gap:6,children:[e.jsx(C,{danger:!0,onClick:()=>r([]),size:"small",children:"Clear"}),e.jsx(K,{onConfirm:()=>S(3),title:"Apply +3 to selected suspects?",children:e.jsx(C,{className:"ml-10",disabled:i.length===0,size:"small",type:"primary",children:"Apply +3"})}),e.jsx(re,{type:"vertical"}),e.jsx(K,{onConfirm:()=>S(-3),title:"Apply -3 to selected suspects?",children:e.jsx(C,{disabled:i.length===0,size:"small",type:"primary",children:"Apply -3"})})]})]})]})}function D({filter:t,activeFilters:i,updateActiveFilter:a}){return e.jsxs(e.Fragment,{children:[e.jsxs("span",{children:[e.jsx(ue,{checked:i.includes(t),onClick:()=>a(t)})," ",T.capitalize(t)]}),e.jsx(re,{type:"vertical"})]})}function ht({data:t,questions:i,suspects:a,isLoading:u,isSuccess:d,addEntryToUpdate:p}){const{queryParams:h,addParam:l}=P(),r=b.useMemo(()=>T.orderBy(Object.values(i).map(c=>({...c,answersCount:Object.values(t[c.id]??{}).length})),c=>Number(c.id.split("-")[1]),"asc"),[i]),m=le({total:r.length,showQuickJumper:!0}),o=[{title:"Id",dataIndex:"id",key:"id",sorter:(c,s)=>Number(c.id.split("-")[1])-Number(s.id.split("-")[1])},{title:"Question",dataIndex:"question",key:"question",sorter:(c,s)=>c.question.localeCompare(s.question)},{title:"NSFW",dataIndex:"nsfw",key:"nsfw",render:c=>c?e.jsx(Ne,{style:{color:"hotPink"}}):"",sorter:(c,s)=>Number(c.nsfw)-Number(s.nsfw)},{title:"Answers",dataIndex:"answersCount",key:"answersCount",sorter:(c,s)=>c.answersCount-s.answersCount}],n=ae({maxExpandedRows:1,expandedRowRender:c=>e.jsx(ut,{addEntryToUpdate:p,answers:t[c.id]??{},suspects:a,testimonyId:c.id}),rowExpandable:()=>d});return e.jsxs(k,{className:"full-width py-4",gap:12,vertical:!0,children:[e.jsxs(k,{align:"center",justify:"space-between",children:[e.jsx(O.Title,{className:"my-0",level:4,children:"Suspects by Testimony"}),e.jsx(F,{checked:h.get("sortSuspectsBy")==="answers",checkedChildren:"Sort by Answers",onChange:c=>l("sortSuspectsBy",c?"answers":"id"),unCheckedChildren:"Sort by Id"})]}),e.jsx(Q,{bordered:!0,className:"full-width",columns:o,dataSource:r,expandable:n,loading:u,pagination:m,rowKey:"id"})]})}function mt(t){const{queryParams:i,is:a}=P();return e.jsxs(e.Fragment,{children:[(a("display","questions")||!i.get("display"))&&e.jsx(ht,{...t}),a("display","suspects")&&e.jsx(lt,{...t}),a("display","simulator")&&e.jsx(st,{})]})}const ft="Left",pt="Right",gt="Up",jt="Down",M={delta:10,preventScrollOnSwipe:!1,rotationAngle:0,trackMouse:!1,trackTouch:!0,swipeDuration:1/0,touchEventOptions:{passive:!0}},U={first:!0,initial:[0,0],start:0,swiping:!1,xy:[0,0]},te="mousemove",ne="mouseup",xt="touchend",bt="touchmove",wt="touchstart";function yt(t,i,a,u){return t>i?a>0?pt:ft:u>0?jt:gt}function se(t,i){if(i===0)return t;const a=Math.PI/180*i,u=t[0]*Math.cos(a)+t[1]*Math.sin(a),d=t[1]*Math.cos(a)-t[0]*Math.sin(a);return[u,d]}function vt(t,i){const a=o=>{const n="touches"in o;n&&o.touches.length>1||t((c,s)=>{s.trackMouse&&!n&&(document.addEventListener(te,u),document.addEventListener(ne,h));const{clientX:g,clientY:S}=n?o.touches[0]:o,j=se([g,S],s.rotationAngle);return s.onTouchStartOrOnMouseDown&&s.onTouchStartOrOnMouseDown({event:o}),Object.assign(Object.assign(Object.assign({},c),U),{initial:j.slice(),xy:j,start:o.timeStamp||0})})},u=o=>{t((n,c)=>{const s="touches"in o;if(s&&o.touches.length>1)return n;if(o.timeStamp-n.start>c.swipeDuration)return n.swiping?Object.assign(Object.assign({},n),{swiping:!1}):n;const{clientX:g,clientY:S}=s?o.touches[0]:o,[j,x]=se([g,S],c.rotationAngle),f=j-n.xy[0],y=x-n.xy[1],w=Math.abs(f),v=Math.abs(y),R=(o.timeStamp||0)-n.start,I=Math.sqrt(w*w+v*v)/(R||1),N=[f/(R||1),y/(R||1)],A=yt(w,v,f,y),W=typeof c.delta=="number"?c.delta:c.delta[A.toLowerCase()]||M.delta;if(w<W&&v<W&&!n.swiping)return n;const L={absX:w,absY:v,deltaX:f,deltaY:y,dir:A,event:o,first:n.first,initial:n.initial,velocity:I,vxvy:N};L.first&&c.onSwipeStart&&c.onSwipeStart(L),c.onSwiping&&c.onSwiping(L);let _=!1;return(c.onSwiping||c.onSwiped||c[`onSwiped${A}`])&&(_=!0),_&&c.preventScrollOnSwipe&&c.trackTouch&&o.cancelable&&o.preventDefault(),Object.assign(Object.assign({},n),{first:!1,eventData:L,swiping:!0})})},d=o=>{t((n,c)=>{let s;if(n.swiping&&n.eventData){if(o.timeStamp-n.start<c.swipeDuration){s=Object.assign(Object.assign({},n.eventData),{event:o}),c.onSwiped&&c.onSwiped(s);const g=c[`onSwiped${s.dir}`];g&&g(s)}}else c.onTap&&c.onTap({event:o});return c.onTouchEndOrOnMouseUp&&c.onTouchEndOrOnMouseUp({event:o}),Object.assign(Object.assign(Object.assign({},n),U),{eventData:s})})},p=()=>{document.removeEventListener(te,u),document.removeEventListener(ne,h)},h=o=>{p(),d(o)},l=(o,n)=>{let c=()=>{};if(o&&o.addEventListener){const s=Object.assign(Object.assign({},M.touchEventOptions),n.touchEventOptions),g=[[wt,a,s],[bt,u,Object.assign(Object.assign({},s),n.preventScrollOnSwipe?{passive:!1}:{})],[xt,d,s]];g.forEach(([S,j,x])=>o.addEventListener(S,j,x)),c=()=>g.forEach(([S,j])=>o.removeEventListener(S,j))}return c},m={ref:o=>{o!==null&&t((n,c)=>{if(n.el===o)return n;const s={};return n.el&&n.el!==o&&n.cleanUpTouch&&(n.cleanUpTouch(),s.cleanUpTouch=void 0),c.trackTouch&&o&&(s.cleanUpTouch=l(o,c)),Object.assign(Object.assign(Object.assign({},n),{el:o}),s)})}};return i.trackMouse&&(m.onMouseDown=a),[m,l]}function St(t,i,a,u){return!i.trackTouch||!t.el?(t.cleanUpTouch&&t.cleanUpTouch(),Object.assign(Object.assign({},t),{cleanUpTouch:void 0})):t.cleanUpTouch?i.preventScrollOnSwipe!==a.preventScrollOnSwipe||i.touchEventOptions.passive!==a.touchEventOptions.passive?(t.cleanUpTouch(),Object.assign(Object.assign({},t),{cleanUpTouch:u(t.el,i)})):t:Object.assign(Object.assign({},t),{cleanUpTouch:u(t.el,i)})}function kt(t){const{trackMouse:i}=t,a=b.useRef(Object.assign({},U)),u=b.useRef(Object.assign({},M)),d=b.useRef(Object.assign({},u.current));d.current=Object.assign({},u.current),u.current=Object.assign(Object.assign({},M),t);let p;for(p in M)u.current[p]===void 0&&(u.current[p]=M[p]);const[h,l]=b.useMemo(()=>vt(r=>a.current=r(a.current,u.current),{trackMouse:i}),[i]);return a.current=St(a.current,u.current,d.current,l),h}function Ct(t){const{addParam:i}=P();return e.jsxs(k,{gap:8,vertical:!0,children:[e.jsx(C,{block:!0,onClick:()=>i("testify","single"),children:"Testify Drawer"}),e.jsx(C,{block:!0,onClick:()=>i("testify","group"),children:"Testify Group"}),e.jsx(Ot,{...t}),e.jsx(Tt,{...t})]})}function Ot({suspects:t,questions:i,answers:a,addEntryToUpdate:u}){var x;const{width:d,height:p}=de(),{is:h,removeParam:l}=P(),[r,m,o]=me(),n=kt({onSwipedLeft:()=>alert("Swiped Left"),onSwipedRight:()=>alert("Swiped Right"),onSwipedUp:()=>alert("Swiped Up"),preventScrollOnSwipe:!0,trackTouch:!0,trackMouse:!0}),c=()=>{m({suspectId:T.sample(Object.keys(t))||null,testimonyId:T.sample(Object.keys(i))||null})},s=()=>{c()},g=()=>{if(r!=null&&r.suspectId&&(r!=null&&r.testimonyId)){const f=T.cloneDeep(a[(r==null?void 0:r.testimonyId)??""]??{});f[r.suspectId]=[...f[r.suspectId]||[],1],u(r.testimonyId??"",f),c()}},S=()=>{if(r!=null&&r.suspectId&&(r!=null&&r.testimonyId)){const f=T.cloneDeep(a[(r==null?void 0:r.testimonyId)??""]??{});f[r.suspectId]=[...f[r.suspectId]||[],0],u(r.testimonyId??"",f),c()}},j=!!(r!=null&&r.suspectId)&&!!(r!=null&&r.testimonyId);return e.jsx(he,{footer:null,maskClosable:!1,onCancel:()=>l("testify"),open:h("testify","single"),title:e.jsx(O,{children:"Does this person do this??"}),width:d-64,children:e.jsxs("div",{...n,children:[j&&e.jsxs(k,{align:"center",className:"mb-8",gap:8,justify:"center",vertical:!0,children:[e.jsx(H,{id:r.suspectId??"",width:Math.max(p/4,128)}),e.jsx(O.Title,{className:"text-center",level:5,children:(x=i[r.testimonyId??""])==null?void 0:x.question})]}),e.jsxs(E.Compact,{block:!0,className:"mb-8",size:"large",children:[e.jsx(C,{block:!0,disabled:!j,icon:"👎",onClick:S,style:{height:64},children:"No"}),e.jsx(C,{block:!0,onClick:s,style:{height:64},children:"Skip"}),e.jsx(C,{block:!0,disabled:!j,icon:"👍",iconPosition:"end",onClick:g,style:{height:64},children:"Yes"})]})]})})}function Tt({suspects:t,questions:i,answers:a,addEntryToUpdate:u}){var y;const{width:d,height:p}=de(),{is:h,removeParam:l}=P(),[r,m,o]=me(),[n,c]=b.useState(6),[s,g]=b.useState(!0),S=()=>{var v;const w=(v=T.sampleSize(Object.keys(t),n))==null?void 0:v.reduce((R,I)=>(R[I]=null,R),{});m({suspectsIds:w,testimonyId:(s?T.sample(Object.keys(i)):r==null?void 0:r.testimonyId)??null})};ge(()=>S());const j=()=>{const w=Object.entries((r==null?void 0:r.suspectsIds)??{}).reduce((v,[R,I])=>(I!==null&&(v[R]=[I]),v),{});if(r!=null&&r.testimonyId&&Object.keys(w).length>0){const v=T.cloneDeep(a[r.testimonyId]??{});Object.entries(w).forEach(([R,I])=>{v[R]=[...v[R]||[],...I]}),u(r.testimonyId,v)}else console.log("No testimonyId or no judged suspects found, likely skipped");S()},x=!!(r!=null&&r.suspectsIds)&&!!(r!=null&&r.testimonyId),f=w=>{m(v=>{if(!v)return v;const R=Object.entries(v.suspectsIds).reduce((I,[N,A])=>(I[N]=A===null?w:A,I),{});return{...v,suspectsIds:R}})};return e.jsx(he,{footer:null,maskClosable:!1,onCancel:()=>l("testify"),open:h("testify","group"),title:e.jsx(O,{children:"Do these people do this??"}),width:d-64,children:e.jsxs("div",{children:[x&&e.jsxs(k,{align:"center",className:"mb-8",gap:8,justify:"center",vertical:!0,children:[e.jsxs(k,{align:"center",gap:6,justify:"center",children:[e.jsx(O.Text,{children:"Number of Suspects:"}),e.jsx(ce,{onChange:w=>c(w??6),size:"small",value:n}),e.jsx(O.Text,{children:"Random Questions:"}),e.jsx(F,{checked:s,onChange:g,size:"small"})]}),e.jsx(O.Title,{className:"text-center",level:4,children:(y=i[r.testimonyId??""])==null?void 0:y.question}),e.jsx(k,{gap:8,justify:"center",wrap:"wrap",children:Object.keys(r.suspectsIds).map(w=>{var v,R;return e.jsxs(k,{align:"center",justify:"center",vertical:!0,children:[e.jsx(O.Text,{className:"text-center",children:((R=(v=t[w])==null?void 0:v.name)==null?void 0:R.pt)||"Unknown"}),e.jsx(H,{id:w,width:Math.min(Math.max(p/3,128),128)},w),e.jsx(Te,{onChange:I=>m(N=>N&&{...N,suspectsIds:{...N.suspectsIds,[w]:I}}),options:[{value:0,icon:"👎"},{value:null,icon:"♾"},{value:1,icon:"👍"}],shape:"round",size:"large",value:r.suspectsIds[w]})]},w)})})]}),e.jsxs(k,{align:"center",className:"mt-8",justify:"space-between",children:[e.jsx("span",{}),e.jsxs(k,{gap:8,children:[e.jsx(C,{onClick:()=>f(0),children:"Set all ♾ to 👎"}),e.jsx(C,{onClick:()=>f(1),children:"Set all ♾ to 👍"})]}),e.jsx(C,{onClick:j,size:"large",children:"Next Set"})]})]})})}function Rt({suspects:t,questions:i,data:a,hasNewData:u,isDirty:d,save:p,isSaving:h,entriesToUpdate:l,addEntryToUpdate:r}){const{queryParams:m,addParams:o}=P(),n=b.useMemo(()=>{let s=0;const g={};return Object.values(a).forEach(S=>{Object.keys(S).forEach(j=>{if(S[j]){g[j]||(g[j]=0);const x=ve(S[j]);x>=5&&(g[j]+=1),x>=3&&(s+=1)}})}),{absoluteTotal:s,queriedTestimoniesCount:Object.keys(a).length,suspectsCount:Object.keys(g).length,reliableSuspectsCount:Object.values(g).filter(S=>S>=5).length}},[a]),c=n.queriedTestimoniesCount*n.suspectsCount;return e.jsxs(e.Fragment,{children:[e.jsx(V,{children:e.jsxs(k,{gap:12,vertical:!0,children:[e.jsx(Ae,{dirt:JSON.stringify(l),isDirty:d,isSaving:h,onSave:p}),e.jsx(Ie,{block:!0,data:async()=>await It(a),disabled:d,fileName:"testimony-answers.json",hasNewData:u}),e.jsx(X,{className:"text-center",label:"Firestore Data",path:"data/testimonies"}),e.jsx(X,{className:"text-center",label:"Firestore TDR",path:"tdr/testimonies"})]})}),e.jsxs(V,{children:[e.jsx(Re,{label:"Display",onChange:s=>o({display:s,page:1},{page:1}),options:[{title:"Questions",icon:e.jsx($e,{}),value:"questions"},{title:"Suspects",icon:e.jsx(Ge,{}),value:"suspects"},{title:"Simulator",icon:e.jsx(He,{}),value:"simulator"}],value:m.get("display")??"questions"}),e.jsx(Me,{})]}),e.jsx(V,{children:e.jsxs("div",{style:{fontSize:"0.85em"},children:[e.jsx("strong",{children:"Legend"}),e.jsxs("ul",{children:[e.jsx("li",{children:"Reliability: At least 5 votes"}),e.jsx("li",{children:"Large Bars: There's enough data (at least 3)"}),e.jsx("li",{children:"Small blue bar: in progress negative"})]})]})}),e.jsxs(V,{children:[e.jsxs("div",{style:{fontSize:"0.85em"},children:[e.jsx("strong",{children:"Counts"}),e.jsxs("ul",{children:[e.jsxs("li",{children:["Testimonies: ",n.queriedTestimoniesCount]}),e.jsxs("li",{children:["Suspects: ",n.suspectsCount]}),e.jsx("li",{children:e.jsxs(z,{title:"A reliable suspect is one that has at least 5 complete testimonies.",children:["Reliable suspects: ",n.reliableSuspectsCount]})}),e.jsxs("li",{children:["Complete: ",n.absoluteTotal]}),e.jsxs("li",{children:["Total: ",c]}),e.jsxs("li",{children:["Percentage: ",(n.absoluteTotal/c*100).toFixed(1),"%"]})]})]}),e.jsx(Ct,{addEntryToUpdate:r,answers:a,questions:i,suspects:t})]})]})}async function It(t){console.log("Preparing file for download...x");const i=await Fe("data","testimonies")(),a=Ee(i);console.log("Parsed data from Firestore:",a);const u=T.cloneDeep(t);return Object.keys(u).forEach(d=>{const p=u[d],h=a[d]||{};Object.keys(p).forEach(l=>{const r=h[l]||[],m=Se([...p[l],...r]);p[l]=m})}),ze(Be(u))}function On(){const t=ke();return e.jsx(je,{subtitle:"Suspect Testimony Rates",title:"Testimonies",children:e.jsxs(G,{hasSider:!0,children:[e.jsx(be,{children:e.jsx(Rt,{...t})}),e.jsx(G.Content,{className:"content",children:e.jsx(xe,{error:t.error,hasResponseData:!T.isEmpty(t.data),isLoading:t.isLoading,children:e.jsx(mt,{...t})})})]})})}export{On as TestimoniesPage,On as default};
