import{r as w,a as W,_ as Y,j as t,T as D,B as I,aj as fe,ae as ge,y as F,D as ae,P as pe,L as ee}from"./index-DXudZKff.js";import{D as xe}from"./DataLoadingWrapper-DJznxbiO.js";import{l as v,c as le,P as je}from"./useBaseUrl-F4TfRTJP.js";import{u as R}from"./useQueryParams-Bgj5dD-m.js";import{R as be,c as ye,u as we}from"./useTestimoniesResource-J45h9t_X.js";import{u as ve,D as Se,a as ke,g as Oe}from"./constants-Kvq_XinT.js";import{u as H}from"./useTDResource-CErvlQtI.js";import{I as U}from"./ImageCard-BnxtsIUB.js";import{g as _}from"./utils-CmulT0oA.js";import{F as k}from"./index-DXhVROXb.js";import{T as Ee,F as Ce}from"./FilterEntries-eDWylT-R.js";import{B as te,D as Te}from"./DownloadButton-BaSak1eG.js";import{S as B}from"./index-CG-6nfci.js";import{u as ue}from"./useTableExpandableRows-BHFjvWYc.js";import{u as de}from"./useTablePagination-CMjUyWZw.js";import{P as ne}from"./progress-ds1TEebm.js";import{S as z}from"./index-DqXoNZRF.js";import{F as X}from"./Table-B4vOA5Q3.js";import{u as Ie}from"./useCardWidth-DRucnmle.js";import{C as he}from"./index-DtO7Sdfx.js";import{P as se}from"./index-Cs8FQA-6.js";import{R as Me}from"./FireFilled-BZB9pqba.js";import{S as L}from"./SiderContent-DvYqu5UB.js";import{S as De}from"./SaveButton-q1ChOX4o.js";import{g as Re}from"./useGetFirestoreDoc-DWyQKRPx.js";import{e as Pe,a as Ne,d as Ae}from"./index-qUq_VRcW.js";import{u as Fe}from"./useWindowSize-C8rE0JmU.js";import{M as Be}from"./index-DvzOMxUC.js";import{R as ze}from"./TableOutlined-B8BWXuLz.js";import"./useResourceFirestoreData-DH6mffC6.js";import"./useUpdateFirestoreDoc-DV2pQuT0.js";import"./useMutation-Btg2QnBB.js";import"./moment-C5S46NFB.js";import"./gapSize-U1swVQyS.js";import"./index-DrA1LQXe.js";import"./index-DyTfBchR.js";import"./index-Cu5uIk_O.js";import"./index-bugDYy45.js";import"./scrollTo-CIrXtMkb.js";import"./Pagination-DO68VWgw.js";import"./extendsObject-keMuGWqj.js";import"./Input-B6TFe_lN.js";import"./SaveOutlined-CxSNrJKc.js";import"./constants-BjYcv3Tq.js";import"./Item-aLbqTaep.js";var $e={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M594.3 601.5a111.8 111.8 0 0029.1-75.5c0-61.9-49.9-112-111.4-112s-111.4 50.1-111.4 112c0 29.1 11 55.5 29.1 75.5a158.09 158.09 0 00-74.6 126.1 8 8 0 008 8.4H407c4.2 0 7.6-3.3 7.9-7.5 3.8-50.6 46-90.5 97.2-90.5s93.4 40 97.2 90.5c.3 4.2 3.7 7.5 7.9 7.5H661a8 8 0 008-8.4c-2.8-53.3-32-99.7-74.7-126.1zM512 578c-28.5 0-51.7-23.3-51.7-52s23.2-52 51.7-52 51.7 23.3 51.7 52-23.2 52-51.7 52zm416-354H768v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H548v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H328v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H96c-17.7 0-32 14.3-32 32v576c0 17.7 14.3 32 32 32h832c17.7 0 32-14.3 32-32V256c0-17.7-14.3-32-32-32zm-40 568H136V296h120v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h148v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h148v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h120v496z"}}]},name:"contacts",theme:"outlined"},He={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M300 328a60 60 0 10120 0 60 60 0 10-120 0zM852 64H172c-17.7 0-32 14.3-32 32v660c0 17.7 14.3 32 32 32h680c17.7 0 32-14.3 32-32V96c0-17.7-14.3-32-32-32zm-32 660H204V128h616v596zM604 328a60 60 0 10120 0 60 60 0 10-120 0zm250.2 556H169.8c-16.5 0-29.8 14.3-29.8 32v36c0 4.4 3.3 8 7.4 8h729.1c4.1 0 7.4-3.6 7.4-8v-36c.1-17.7-13.2-32-29.7-32zM664 508H360c-4.4 0-8 3.6-8 8v60c0 4.4 3.6 8 8 8h304c4.4 0 8-3.6 8-8v-60c0-4.4-3.6-8-8-8z"}}]},name:"robot",theme:"outlined"},Le={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M868 160h-92v-40c0-4.4-3.6-8-8-8H256c-4.4 0-8 3.6-8 8v40h-92a44 44 0 00-44 44v148c0 81.7 60 149.6 138.2 162C265.6 630.2 359 721.8 476 734.5v105.2H280c-17.7 0-32 14.3-32 32V904c0 4.4 3.6 8 8 8h512c4.4 0 8-3.6 8-8v-32.3c0-17.7-14.3-32-32-32H548V734.5C665 721.8 758.4 630.2 773.8 514 852 501.6 912 433.7 912 352V204a44 44 0 00-44-44zM248 439.6c-37.1-11.9-64-46.7-64-87.6V232h64v207.6zM840 352c0 41-26.9 75.8-64 87.6V232h64v120z"}}]},name:"trophy",theme:"filled"};function qe(){var n=w.useRef(!0);return n.current?(n.current=!1,!0):n.current}function Ue(n,e){return typeof n=="function"?n.length?n(e):n():n}function Ve(n,e,o){if(e===void 0&&(e=10),e<1)throw new Error("Capacity has to be greater than 1, got '"+e+"'");var l=qe(),d=w.useState(n),m=d[0],h=d[1],i=w.useRef([]),r=w.useRef(0);l&&(i.current.length?(i.current[i.current.length-1]!==n&&i.current.push(n),i.current.length>e&&(i.current=i.current.slice(i.current.length-e))):i.current.push(n),r.current=i.current.length&&i.current.length-1);var f=w.useCallback(function(a){h(function(c){return a=Ue(a,c),a!==c&&(r.current<i.current.length-1&&(i.current=i.current.slice(0,r.current+1)),r.current=i.current.push(a)-1,i.current.length>e&&(i.current=i.current.slice(i.current.length-e))),a})},[m,e]),u=w.useMemo(function(){return{history:i.current,position:r.current,capacity:e,back:function(a){a===void 0&&(a=1),r.current&&h(function(){return r.current-=Math.min(a,r.current),i.current[r.current]})},forward:function(a){a===void 0&&(a=1),r.current!==i.current.length-1&&h(function(){return r.current=Math.min(r.current+a,i.current.length-1),i.current[r.current]})},go:function(a){a!==r.current&&h(function(){return r.current=a<0?Math.max(i.current.length+a,0):Math.min(i.current.length-1,a),i.current[r.current]})}}},[m]);return[m,f,u]}var Ge=function(e,o){return w.createElement(W,Y({},e,{ref:o,icon:$e}))},Qe=w.forwardRef(Ge),We=function(e,o){return w.createElement(W,Y({},e,{ref:o,icon:He}))},Ye=w.forwardRef(We),_e=function(e,o){return w.createElement(W,Y({},e,{ref:o,icon:Le}))},re=w.forwardRef(_e);const J=(n,e,o)=>{const{reliabilityThreshold:l=4,projectionThreshold:d=55}={},h=`us-gb-${n.split("-")[1]}`,i=v.isEmpty(e[n])?[]:e[n];let r=0,f=0;i.forEach(C=>{C===3&&(r+=3),C===-3&&(f+=3),C===4&&(r+=4),C===-4&&(f+=4)});const u=i.filter(C=>![-4,-3,3,4].includes(C)),a=u.length+r+f,c=Math.max(a,5),g=i.filter(C=>C===1).length+r,b=Math.round(g/c*100),x=i.filter(C=>C===0).length+f,p=Math.round(x/c*100),y=Math.round((c-g-x)/c*100),S=u.length+r+f>=5,O=a>3,E=a>l,M=E?b>p?"ðŸ‘":"ðŸ‘Ž":null,P=O?b>=d?"ðŸ‘":p>=d?"ðŸ‘Ž":null:null;return{suspectCardId:n,imageId:h,enoughData:O,reliable:E,total:c,yesCount:g,yesPercentage:b,noCount:x,noPercentage:p,blankPercentage:y,complete:S,values:i,resolution:M,projection:P}};function Xe(n){const e=n.filter(d=>![0,1].includes(d)),o=n.filter(d=>[0,1].includes(d)),l={0:0,1:0};return o.forEach(d=>{if(l[d]===void 0)throw Error(`what is this value? ${d}`);l[d]+=1}),Object.entries(l).forEach(([d,m])=>{if(m>0){const h=Math.floor(m/4),i=m%4;for(let r=0;r<h;r++)e.push(d==="0"?-4:4);if(i>0){const r=Array.from({length:i},()=>d==="0"?0:1);e.push(...r)}}}),e.sort((d,m)=>d-m)}const G=9,Je=(n,e,o,l)=>{const[d]=ve(Se.ESPIONAGEM,l),m=H("suspects",n),h=H(`testimony-questions-${e}`,n),i=H("testimony-answers",n),r=H("crime-reasons",n),f=w.useMemo(()=>et(i.data),[i.data]),u=w.useMemo(()=>tt(m.data),[m.data]);return{entries:w.useMemo(()=>!d||!m.isSuccess||!h.isSuccess||!i.isSuccess||!r.isSuccess?{}:Ke(o,d,m.data,h.data,f,u,r.data),[n,d,m,h,i,o,f,u,r]),isLoading:m.isLoading||h.isLoading||i.isLoading}},Ke=(n,e,o,l,d,m,h)=>{console.count("Creating Espionagem...");let i=e.latestDate;const r=[],f={};for(let u=0;u<n;u++){const a=ke(i);i=a;let c=null,s=0;for(;!c&&s<100;){s++;const g=Ze(o,l,d,m,r,h);if(ot(g.statements)){c=g,console.log(`Generated valid game for ${a} after ${s} attempts`);break}}if(!c)throw new Error(`Failed to generate valid game for ${a} after 100 attempts`);r.push(c.culpritId),f[a]={id:a,type:"espionagem",number:e.latestNumber+u+1,...c}}return f};function Ze(n,e,o,l,d,m){let h=[];const i=[],r={},f=v.sample(Object.keys(o));if(!f)throw new Error("No selected testimony ID found");const u=Object.keys(o[f]).filter(E=>!d.includes(E)),a=u.length>0?u:Object.keys(o[f]),c=v.sample(a);if(!c)throw new Error("No selected culprit ID found");const s=v.sampleSize(Object.keys(o[f]).filter(E=>E!==c),G-1);for(h.push(...s);h.length<8;){const E=v.sampleSize(Object.keys(n).filter(M=>!h.includes(M)&&M!==c),G-h.length-1);h.push(...E)}const g={};Object.keys(l).forEach(E=>{if(l[E][c]===void 0){const M=Object.keys(l[E]).filter(P=>h.includes(P));if(M.length>0){const P={};M.forEach(C=>{h.includes(C)&&(P[C]=!0)}),g[E]=P}}});const b=e[f];i.push(nt(c,h,b,o[f])),A(r,i[0].excludes);const j=V(c,h,g);i.push(j),A(r,j.excludes),h=v.shuffle([...h,c]);const x=V(c,h,g,[j],"worst");i.push(x),A(r,x.excludes);const p=V(c,h,g,[j,x],"worst");i.push(p),A(r,p.excludes);const y=st(c,h,i);i.push(y),A(r,y.excludes);const S=[i[0],i[1],i[2],i[4],i[3]],O=it(n[c],m);return{isNsfw:b.nsfw??!1,culpritId:c,statements:S,suspects:h.map(E=>n[E]),reason:O.title,setId:`${c}::${O.id}::${S[0].key}`,level:ct(S)}}const et=n=>{const e={};console.log("âš™ï¸ Calculating suspect answers...");for(const o of Object.keys(n)){const l=n[o];for(const d of Object.keys(l)){const{resolution:m,projection:h}=J(d,l);if(!m&&!h){console.log("â‰ï¸ Ignoring testimony with no resolution or projection");continue}if(e[o]===void 0&&(e[o]={}),m){e[o][d]=m==="ðŸ‘";continue}if(h){e[o][d]=h==="ðŸ‘";continue}console.log("â‰ï¸ Ignoring testimony with not enough values")}}return Object.keys(e).forEach(o=>{v.isEmpty(e[o])&&delete e[o]}),Object.keys(e).forEach(o=>{Object.keys(e[o]).length<3&&(console.log("â‰ï¸ Removing testimonies with less than 3 answers"),delete e[o])}),Object.keys(e).forEach(o=>{v.uniq(Object.values(e[o])).length===1&&(console.log("â‰ï¸ Removing testimonies with the same answer"),delete e[o])}),e},tt=n=>{const e={};for(const l of Object.keys(n)){const{gender:d,ethnicity:m,age:h,build:i,height:r,features:f}=n[l];if(!i){console.log("â‰ï¸ Ignoring suspect with missing build",l);continue}if(!r){console.log("â‰ï¸ Ignoring suspect with missing height",l);continue}if(!f||f.length===0){console.log("â‰ï¸ Ignoring suspect with missing features",l);continue}e[d]===void 0&&(e[d]={}),e[d][l]=!0,e[m]===void 0&&(e[m]={}),e[m][l]=!0,e[h]===void 0&&(e[h]={}),e[h][l]=!0,e[i]===void 0&&(e[i]={}),e[i][l]=!0,e[r]===void 0&&(e[r]={}),e[r][l]=!0,f.forEach(u=>{e[u]===void 0&&(e[u]={}),e[u][l]=!0})}return e.young=v.cloneDeep(e["18-21"]),e.adult=v.cloneDeep({...e["21-30"],...e["30-40"],...e["40-50"]}),e.senior=v.cloneDeep({...e["50-60"],...e["60-70"],...e["70-80"],...e["80-90"]}),["18-21","21-30","30-40","40-50","50-60","60-70","70-80","80-90","average","medium","mixed","adult","tall"].forEach(l=>{delete e[l]}),e},A=(n,e)=>{e.forEach(o=>{n[o]===void 0&&(n[o]=0),n[o]++})},nt=(n,e,o,l)=>{const d=l[n],m=e.filter(r=>l[r]!==void 0&&l[r]!==d),h=o.answer.charAt(0).toLowerCase()+o.answer.slice(1),i={key:`testimony.${o.id}`,text:`O(a) suspeito(a) ${d?"":"nÃ£o "}${h}`,excludes:m};return i.text.includes("nÃ£o jÃ¡")&&(i.text=i.text.replace("nÃ£o jÃ¡","nunca")),i},q={row1:{indexes:[0,1,2],text:"na primeira linha"},row2:{indexes:[3,4,5],text:"na segunda linha"},row3:{indexes:[6,7,8],text:"na terceira linha"},column1:{indexes:[0,3,6],text:"na primeira coluna"},column2:{indexes:[1,4,7],text:"na segunda coluna"},column3:{indexes:[2,5,8],text:"na terceira coluna"},corners:{indexes:[0,2,6,8],text:"nos cantos"}},st=(n,e,o)=>{const l=e.indexOf(n),d=o.slice(0,3),m={};for(const a of Object.keys(q)){const{indexes:c}=q[a];c.includes(l)||(m[a]=c.reduce((s,g)=>{const b=e[g],j=d.filter(x=>x.excludes.includes(b)).length;return j>0?s+j:s},0))}const h=Object.entries(m).reduce((a,[c,s])=>(a[s]||(a[s]=[]),a[s].push(c),a),{}),i=Math.min(...Object.keys(m).map(a=>m[a])),r=h[i.toString()],f=v.sample(r)||Object.keys(m)[0],u=q[f].indexes.map(a=>e[a]);return{key:`not.grid.${f}`,text:`O(a) suspeito(a) nÃ£o estÃ¡ ${q[f].text}`,excludes:u}},V=(n,e,o,l=[],d="best")=>{const m=v.difference(e,[n]),h=l.filter(g=>g.key.startsWith("not.feature.")).map(g=>g.key.replace("not.feature.","")),i=new Set(l.flatMap(g=>g.excludes)),r=Object.keys(o).filter(g=>Object.keys(o[g]).length<=6&&!h.includes(g)).sort((g,b)=>Object.keys(o[b]).length-Object.keys(o[g]).length);let f,u=[],a=0;const c=500;for(;a<c;){a++;const g=d==="best"?r[0]:v.sample(r.slice(2,5))??r[2];if(!g)break;const b=m.filter(x=>o[g][x]);if(b.some(x=>!i.has(x))||a===c){f=g,u=b;break}r.splice(r.indexOf(g),1)}if(!f)throw Error(`No suitable feature found for ${d} selection after ${c} attempts`);console.log(`Selected feature after ${a} attempts: ${f}`);const s=rt[f];return s||console.warn(`Feature ${f} not found in translations`),{key:`not.feature.${f}`,text:`O(a) suspeito(a) nÃ£o ${s||f}`,excludes:u}},rt={male:"Ã© homem",female:"Ã© mulher",black:"Ã© negro(a)",white:"Ã© branco(a)",asian:"Ã© asiÃ¡tico(a)",latino:"Ã© latino(a)",thin:"Ã© magrelo(a)",fat:"Ã© gordo(a)",large:"Ã© gordo(a)",tall:"Ã© alto(a)",short:"Ã© baixinho(a)",young:"Ã© jovem",adult:"Ã© adulto(a)",senior:"Ã© idoso(a)",average:"Ã© mÃ©dio(a)",medium:"Ã© mÃ©dio(a)",mixed:"Ã© mestiÃ§o(a)",hat:"estÃ¡ usando um chapÃ©u",tie:"estÃ¡ usando uma gravata",glasses:"estÃ¡ usando Ã³culos",brownHair:"tem cabelo castanho",shortHair:"tem cabelo curto",beard:"tem barba",caucasian:"Ã© caucasiano(a)",scarf:"estÃ¡ usando um cachecol",blondeHair:"tem cabelo loiro",longHair:"tem cabelo longo",greyHair:"tem cabelo grisalho",bald:"Ã© careca",mustache:"tem bigode",goatee:"tem cavanhaque",muscular:"Ã© musculoso(a)",blackHair:"tem cabelo preto",hoodie:"estÃ¡ usando um moletom",earrings:"estÃ¡ usando brincos",lipstick:"estÃ¡ usando batom",necklace:"estÃ¡ usando um colar",mediumHair:"tem cabelo mÃ©dio","middle-eastern":"Ã© do Oriente MÃ©dio",headscarf:"estÃ¡ usando um lenÃ§o na cabeÃ§a",redHair:"tem cabelo ruivo",piercings:"tem piercings",coloredHair:"tem cabelo colorido",indian:"Ã© indiano(a)","native-american":"Ã© nativo-americano(a)",noAccessories:"nÃ£o estÃ¡ usando acessÃ³rios"},ot=n=>{const e=n.slice(0,3);return e.reduce((d,m)=>d+m.excludes.length,0)<10?!1:new Set(e.flatMap(d=>d.excludes)).size===G-1},it=(n,e)=>{const o=[];Object.values(e).forEach(d=>{var m;d.feature==="general"&&o.push(d),(m=n.features)!=null&&m.includes(d.feature)&&o.push(d)});const l=v.sample(o);return l||{id:"unknown",title:{pt:"Motivo desconhecido",en:"Unknown reason"},feature:"general"}},ct=n=>{const e=n.slice(0,3),o=[],l={1:4,2:3,3:3,4:2,5:2,6:1,7:0,8:0};e.forEach(m=>{const h=m.excludes.length;l[h]!==void 0&&o.push(l[h])});const d=Math.round(o.reduce((m,h)=>m+h,0)/o.length);return Math.min(Math.max(d,1),3)};function at(){const[n,e]=w.useState({batchSize:1,history:{}}),o=w.useRef(1),{entries:l}=Je(!0,"pt",n.batchSize,n.history);return t.jsxs(k,{vertical:!0,gap:12,className:"p-4",children:[t.jsxs(k,{justify:"space-between",align:"center",children:[t.jsx(D.Title,{level:4,className:"my-0",children:"Espionagem Simulator"}),t.jsxs(k,{gap:6,children:[t.jsx(Ee,{min:1,max:7,defaultValue:1,onChange:d=>{o.current=d??1}}),t.jsx(I,{type:"primary",onClick:()=>e({batchSize:o.current,history:{}}),children:"Re-run Simulation"})]})]}),t.jsx(lt,{entries:l})]})}function lt({entries:n}){const[e,o]=w.useState(!1),l=Oe(),d=n[l],m=w.useMemo(()=>d?d.statements.slice(0,3).reduce((h,i)=>{const{excludes:r}=i;return r.forEach(f=>{h[f]?h[f]++:h[f]=1}),h},{}):{},[d]);return t.jsxs("div",{className:"full-width grid grid-2",children:[t.jsx(be,{src:n??{},theme:"twilight",collapsed:3}),d&&t.jsxs(k,{gap:18,className:"p-4",children:[t.jsx("div",{children:t.jsx("div",{style:{width:`${105*3}px`,display:"grid",gap:"6px",gridTemplateColumns:"repeat(3, 1fr)"},children:d.suspects.map(h=>t.jsxs(te.Ribbon,{text:e?m[h.id]:null,color:"cyan",children:[t.jsx(U,{id:_(h.id,"gb"),width:96,className:le(e&&h.id===d.culpritId&&"red-border")},h.id),t.jsxs(k,{gap:6,align:"center",children:[t.jsx(B,{checkedChildren:"ðŸš«",size:"small"})," ",h.id]})]},h.id))})}),t.jsxs("div",{children:[t.jsx("div",{children:t.jsx(B,{checkedChildren:"Show Culprit",unCheckedChildren:"Hide Culprit",checked:e,onChange:o})}),d.statements.map((h,i)=>t.jsx(D.Paragraph,{children:t.jsx(te,{count:h.excludes.length,color:"cyan",children:t.jsx(fe,{message:h.text,banner:!0,type:i<3?"info":"error"},h.key)})},h.key))]})]})]})}function me({suspect:n,values:e,resolution:o,projection:l,yesPercentage:d,noPercentage:m,complete:h,enoughData:i,testimonyId:r,addEntryToUpdate:f,answers:u,barWidth:a,showName:c}){const s=x=>{const p={...u};p[x]=[...p[x]||[],3],f(r,p)},g=x=>{const p={...u};p[x]=[...p[x]||[],-3],f(r,p)},b=x=>{var S;const p={...u},y=(S=p[x])==null?void 0:S.findIndex(O=>O===3);y!==-1&&y!==void 0&&(p[x]=[...p[x].slice(0,y),...p[x].slice(y+1)]),f(r,p)},j=x=>{var S;const p={...u},y=(S=p[x])==null?void 0:S.findIndex(O=>O===-3);y!==-1&&y!==void 0&&(p[x]=[...p[x].slice(0,y),...p[x].slice(y+1)]),f(r,p)};return t.jsxs(ge,{trigger:"click",title:`Add strong fit/unfit answer to ${n.name.pt}`,content:t.jsxs(k,{vertical:!0,gap:4,children:[t.jsx(D.Text,{type:"secondary",children:e.join(", ")}),t.jsxs(I,{icon:"ðŸ‘",block:!0,onClick:()=>s(n.id),children:[" ","Add strong fit"]}),t.jsxs(I,{icon:"ðŸ‘Ž",block:!0,onClick:()=>g(n.id),children:[" ","Add strong unfit"]}),t.jsxs(z.Compact,{children:[t.jsx(I,{icon:"âŒ",size:"small",block:!0,onClick:()=>b(n.id),children:"fit"}),t.jsx(I,{icon:"âŒ",size:"small",block:!0,onClick:()=>j(n.id),children:"unfit"})]})]}),children:[c&&t.jsxs("div",{children:[t.jsx(F,{title:n.id,children:n.name.pt})," ",h&&t.jsx(F,{title:"Complete: It has 5 or more answers",children:t.jsx(re,{style:{color:"gold"}})})]}),t.jsxs(k,{align:"flex-start",gap:12,children:[t.jsx(F,{title:`Values: ${e.join(", ")} : ${o||(l?`${l}*`:"")}`,children:i?t.jsx(ne,{percent:m+d,size:[a,20],status:"exception",success:{percent:d},showInfo:!1}):t.jsx(ne,{percent:m+d,size:[a,10],status:"exception",success:{percent:d},showInfo:!1})}),!c&&h&&t.jsx(F,{title:"Complete: It has 5 or more answers",children:t.jsx(re,{style:{color:"gold"}})})]})]})}function ut({suspect:n,answersPerQuestion:e={},questions:o,addEntryToUpdate:l,allAnswers:d}){const{queryParams:m}=R({sortSuspectsBy:"answers"}),h=m.get("sortSuspectsBy")??"answers",i=w.useMemo(()=>{const f=Object.values(o).map(u=>{const a=e[u.id]??{},{enoughData:c,reliable:s,yesPercentage:g,noPercentage:b,blankPercentage:j,values:x,total:p,resolution:y,projection:S,complete:O}=J(n.id,{[n.id]:a});return{id:u.id,question:u,enoughData:c,reliable:s,yesPercentage:g,noPercentage:b,blankPercentage:j,values:x,total:p,resolution:y,projection:S,complete:O}});return h==="answers"?v.orderBy(f,["reliable","enoughData","yesPercentage",u=>u.values.length],["desc","desc","desc","desc"]):v.orderBy(f,u=>Number(u.id.split("-")[1]),["asc"])},[e,o,n.id,h]),r=[{key:"id",title:"Id",dataIndex:"id"},{key:"question",title:"Question",dataIndex:"question",render:f=>f.question},{key:"answer",title:"Answer",dataIndex:"id",sorter:(f,u)=>f.total-u.total,render:f=>{const u=i.find(a=>a.id===f);return u?t.jsx(k,{gap:8,wrap:"nowrap",children:t.jsx(me,{values:u.values,resolution:u.resolution,projection:u.projection,yesPercentage:u.yesPercentage,noPercentage:u.noPercentage,complete:u.complete,enoughData:u.enoughData,suspect:n,testimonyId:u.question.id,answers:d[u.question.id]||{},addEntryToUpdate:l,barWidth:120})}):""}}];return t.jsx(z,{wrap:!0,size:"large",children:t.jsx(X,{rowKey:"id",columns:r,dataSource:i,bordered:!0})})}function dt({isLoading:n,isSuccess:e,questions:o,data:l,suspects:d,addEntryToUpdate:m}){const{queryParams:h,addParam:i}=R(),r=w.useMemo(()=>Object.keys(l).reduce((s,g)=>{const b=l[g]??{};return Object.keys(b).forEach(j=>{s[j]||(s[j]={}),s[j][g]=b[j]}),s},{}),[l]),f=w.useMemo(()=>v.orderBy(Object.values(d).map(s=>({...s,answers:r[s.id]})),s=>Number(s.id.split("-")[1]),"asc"),[d,r]),u=de({total:f.length,showQuickJumper:!0}),a=[{title:"Id",dataIndex:"id",key:"id",sorter:(s,g)=>Number(s.id.split("-")[1])-Number(g.id.split("-")[1])},{title:"Picture",dataIndex:"id",render:s=>t.jsx(U,{id:_(s,"gb"),width:48})},{title:"Name",dataIndex:"name",key:"name",sorter:(s,g)=>s.name.pt.localeCompare(g.name.pt),render:s=>s.pt},{title:"Questions Answered",dataIndex:"answers",key:"answers",sorter:(s,g)=>Object.keys(s.answers??{}).length-Object.keys(g.answers??{}).length,render:s=>s?Object.values(s).length:""}],c=ue({maxExpandedRows:1,expandedRowRender:s=>t.jsx(ut,{suspect:s,answersPerQuestion:r[s.id],questions:o,addEntryToUpdate:m,allAnswers:l}),rowExpandable:()=>e});return t.jsxs(k,{gap:12,className:"full-width py-4",vertical:!0,children:[t.jsxs(k,{justify:"space-between",align:"center",children:[t.jsx(D.Title,{level:4,className:"my-0",children:"Testimonies by Suspect"}),t.jsx(B,{checked:h.get("sortSuspectsBy")==="answers",onChange:s=>i("sortSuspectsBy",s?"answers":"id"),checkedChildren:"Sort by Answers",unCheckedChildren:"Sort by Id"})]}),t.jsx(X,{columns:a,dataSource:f,pagination:u,rowKey:"id",expandable:c,loading:n,bordered:!0,className:"full-width"})]})}function ht({answers:n,suspects:e,addEntryToUpdate:o,testimonyId:l}){const[d,m]=Ie(12),{queryParams:h,is:i}=R({sortSuspectsBy:"answers"}),r=i("enableBatch"),f=h.get("sortSuspectsBy")??"answers",u=w.useMemo(()=>{const s=Object.keys(e).map(g=>J(g,n));return f==="answers"?v.orderBy(s,["reliable","enoughData",g=>g.values.length,"yesPercentage","noPercentage",g=>Number(g.suspectCardId.split("-")[1])],["desc","desc","desc","desc","desc","asc"]):v.orderBy(s,g=>Number(g.suspectCardId.split("-")[1]),["asc"])},[n,e,f]),[a,c]=w.useState([]);return t.jsxs(z,{direction:"vertical",children:[t.jsx(mt,{selection:a,setSelection:c,suspects:e,addEntryToUpdate:o,list:u,testimonyId:l,answers:n}),t.jsx(z,{wrap:!0,ref:m,size:"large",children:u.map(s=>t.jsxs(k,{vertical:!0,gap:6,className:le({"selection-outline":r&&a.includes(s.suspectCardId)}),children:[t.jsx(U,{id:s.imageId,width:d,className:s.values.length>1?void 0:"grayscale"}),t.jsxs(k,{gap:4,children:[r&&t.jsx(he,{disabled:s.complete,checked:a.includes(s.suspectCardId),onChange:g=>{const b=g.target.checked;c(j=>b?[...j,s.suspectCardId]:j.filter(x=>x!==s.suspectCardId))}}),t.jsx(me,{values:s.values,resolution:s.resolution,projection:s.projection,yesPercentage:s.yesPercentage,noPercentage:s.noPercentage,complete:s.complete,enoughData:s.enoughData,suspect:e[s.suspectCardId],testimonyId:l,answers:n,addEntryToUpdate:o,barWidth:d,showName:!0})]})]},s.suspectCardId))})]})}function mt({testimonyId:n,selection:e,setSelection:o,suspects:l,addEntryToUpdate:d,list:m,answers:h}){const[i,r]=w.useState([]),{addParam:f,removeParam:u,is:a}=R({sortSuspectsBy:"answers"}),c=a("enableBatch"),s=j=>{r(x=>x.includes(j)?x.filter(p=>p!==j):[...x,j])},g=w.useMemo(()=>v.keyBy(m,"suspectCardId"),[m]);w.useEffect(()=>{if(i.length===0&&e.length>0){o([]);return}if(!i.length)return;const x=(e.length>0?e:Object.values(g).filter(p=>!p.complete&&!p.values.includes(3)&&!p.values.includes(-3)).map(p=>p.suspectCardId)).filter(p=>{const y=l[p],S=[y.gender,y.ethnicity,y.build,y.height];return y.age==="18-21"&&S.push("young"),(y.age==="21-30"||y.age==="30-40")&&S.push("adult"),y.age==="40-50"&&S.push("parent"),(y.age==="50-60"||y.age==="60-70"||y.age==="70-80"||y.age==="80-90")&&S.push("senior"),i.every(O=>S.includes(O))});o(x)},[i]);const b=j=>{const x=v.cloneDeep(h);e.forEach(p=>{x[p]=[...x[p]||[],j]}),d(n,x),r([])};return t.jsxs(k,{align:"center",gap:6,justify:"space-between",className:"mb-4",children:[t.jsxs(k,{gap:3,children:[t.jsx(D.Text,{className:"nowrap buceta",style:{minWidth:"5ch"},children:"Batch"}),t.jsx(B,{value:c,checkedChildren:"On",unCheckedChildren:"Off",onChange:j=>{j?f("enableBatch",!0):u("enableBatch")}})]}),c&&t.jsxs(t.Fragment,{children:[t.jsxs(D.Text,{className:"nowrap mr-2",children:["Selected ",e.length]}),t.jsxs(k,{gap:6,wrap:!0,align:"center",justify:"center",children:[t.jsx(T,{filter:"male",activeFilters:i,updateActiveFilter:s}),t.jsx(T,{filter:"female",activeFilters:i,updateActiveFilter:s}),t.jsx(T,{filter:"young",activeFilters:i,updateActiveFilter:s}),t.jsx(T,{filter:"adult",activeFilters:i,updateActiveFilter:s}),t.jsx(T,{filter:"parent",activeFilters:i,updateActiveFilter:s}),t.jsx(T,{filter:"senior",activeFilters:i,updateActiveFilter:s}),t.jsx(T,{filter:"thin",activeFilters:i,updateActiveFilter:s}),t.jsx(T,{filter:"muscular",activeFilters:i,updateActiveFilter:s}),t.jsx(T,{filter:"large",activeFilters:i,updateActiveFilter:s}),t.jsx(T,{filter:"asian",activeFilters:i,updateActiveFilter:s}),t.jsx(T,{filter:"black",activeFilters:i,updateActiveFilter:s}),t.jsx(T,{filter:"caucasian",activeFilters:i,updateActiveFilter:s}),t.jsx(T,{filter:"latino",activeFilters:i,updateActiveFilter:s})]}),t.jsxs(k,{align:"center",gap:6,children:[t.jsx(I,{onClick:()=>r([]),danger:!0,size:"small",children:"Clear"}),t.jsx(se,{title:"Apply +3 to selected suspects?",onConfirm:()=>b(3),children:t.jsx(I,{disabled:e.length===0,size:"small",type:"primary",className:"ml-10",children:"Apply +3"})}),t.jsx(ae,{type:"vertical"}),t.jsx(se,{title:"Apply -3 to selected suspects?",onConfirm:()=>b(-3),children:t.jsx(I,{disabled:e.length===0,size:"small",type:"primary",children:"Apply -3"})})]})]})]})}function T({filter:n,activeFilters:e,updateActiveFilter:o}){return t.jsxs(t.Fragment,{children:[t.jsxs("span",{children:[t.jsx(he,{checked:e.includes(n),onClick:()=>o(n)})," ",v.capitalize(n)]}),t.jsx(ae,{type:"vertical"})]})}function ft({data:n,questions:e,suspects:o,isLoading:l,isSuccess:d,addEntryToUpdate:m}){const{queryParams:h,addParam:i}=R(),r=w.useMemo(()=>v.orderBy(Object.values(e),c=>Number(c.id.split("-")[1]),"asc"),[e]),f=de({total:r.length,showQuickJumper:!0}),u=[{title:"Id",dataIndex:"id",key:"id",sorter:(c,s)=>Number(c.id.split("-")[1])-Number(s.id.split("-")[1])},{title:"Question",dataIndex:"question",key:"question",sorter:(c,s)=>c.question.localeCompare(s.question)},{title:"NSFW",dataIndex:"nsfw",key:"nsfw",render:c=>c?t.jsx(Me,{style:{color:"hotPink"}}):"",sorter:(c,s)=>Number(c.nsfw)-Number(s.nsfw)},{title:"Answers",dataIndex:"id",key:"answers",render:c=>{const s=n[c];return s?Object.values(s).length:""}}],a=ue({maxExpandedRows:1,expandedRowRender:c=>t.jsx(ht,{testimonyId:c.id,answers:n[c.id]??{},suspects:o,addEntryToUpdate:m}),rowExpandable:()=>d});return t.jsxs(k,{gap:12,className:"full-width py-4",vertical:!0,children:[t.jsxs(k,{justify:"space-between",align:"center",children:[t.jsx(D.Title,{level:4,className:"my-0",children:"Suspects by Testimony"}),t.jsx(B,{checked:h.get("sortSuspectsBy")==="answers",onChange:c=>i("sortSuspectsBy",c?"answers":"id"),checkedChildren:"Sort by Answers",unCheckedChildren:"Sort by Id"})]}),t.jsx(X,{columns:u,dataSource:r,pagination:f,rowKey:"id",expandable:a,loading:l,bordered:!0,className:"full-width"})]})}function gt(n){const{queryParams:e,is:o}=R();return t.jsxs(t.Fragment,{children:[(o("display","questions")||!e.get("display"))&&t.jsx(ft,{...n}),o("display","suspects")&&t.jsx(dt,{...n}),o("display","simulator")&&t.jsx(at,{})]})}const pt="Left",xt="Right",jt="Up",bt="Down",N={delta:10,preventScrollOnSwipe:!1,rotationAngle:0,trackMouse:!1,trackTouch:!0,swipeDuration:1/0,touchEventOptions:{passive:!0}},Q={first:!0,initial:[0,0],start:0,swiping:!1,xy:[0,0]},oe="mousemove",ie="mouseup",yt="touchend",wt="touchmove",vt="touchstart";function St(n,e,o,l){return n>e?o>0?xt:pt:l>0?bt:jt}function ce(n,e){if(e===0)return n;const o=Math.PI/180*e,l=n[0]*Math.cos(o)+n[1]*Math.sin(o),d=n[1]*Math.cos(o)-n[0]*Math.sin(o);return[l,d]}function kt(n,e){const o=u=>{const a="touches"in u;a&&u.touches.length>1||n((c,s)=>{s.trackMouse&&!a&&(document.addEventListener(oe,l),document.addEventListener(ie,h));const{clientX:g,clientY:b}=a?u.touches[0]:u,j=ce([g,b],s.rotationAngle);return s.onTouchStartOrOnMouseDown&&s.onTouchStartOrOnMouseDown({event:u}),Object.assign(Object.assign(Object.assign({},c),Q),{initial:j.slice(),xy:j,start:u.timeStamp||0})})},l=u=>{n((a,c)=>{const s="touches"in u;if(s&&u.touches.length>1)return a;if(u.timeStamp-a.start>c.swipeDuration)return a.swiping?Object.assign(Object.assign({},a),{swiping:!1}):a;const{clientX:g,clientY:b}=s?u.touches[0]:u,[j,x]=ce([g,b],c.rotationAngle),p=j-a.xy[0],y=x-a.xy[1],S=Math.abs(p),O=Math.abs(y),E=(u.timeStamp||0)-a.start,M=Math.sqrt(S*S+O*O)/(E||1),P=[p/(E||1),y/(E||1)],C=St(S,O,p,y),K=typeof c.delta=="number"?c.delta:c.delta[C.toLowerCase()]||N.delta;if(S<K&&O<K&&!a.swiping)return a;const $={absX:S,absY:O,deltaX:p,deltaY:y,dir:C,event:u,first:a.first,initial:a.initial,velocity:M,vxvy:P};$.first&&c.onSwipeStart&&c.onSwipeStart($),c.onSwiping&&c.onSwiping($);let Z=!1;return(c.onSwiping||c.onSwiped||c[`onSwiped${C}`])&&(Z=!0),Z&&c.preventScrollOnSwipe&&c.trackTouch&&u.cancelable&&u.preventDefault(),Object.assign(Object.assign({},a),{first:!1,eventData:$,swiping:!0})})},d=u=>{n((a,c)=>{let s;if(a.swiping&&a.eventData){if(u.timeStamp-a.start<c.swipeDuration){s=Object.assign(Object.assign({},a.eventData),{event:u}),c.onSwiped&&c.onSwiped(s);const g=c[`onSwiped${s.dir}`];g&&g(s)}}else c.onTap&&c.onTap({event:u});return c.onTouchEndOrOnMouseUp&&c.onTouchEndOrOnMouseUp({event:u}),Object.assign(Object.assign(Object.assign({},a),Q),{eventData:s})})},m=()=>{document.removeEventListener(oe,l),document.removeEventListener(ie,h)},h=u=>{m(),d(u)},i=(u,a)=>{let c=()=>{};if(u&&u.addEventListener){const s=Object.assign(Object.assign({},N.touchEventOptions),a.touchEventOptions),g=[[vt,o,s],[wt,l,Object.assign(Object.assign({},s),a.preventScrollOnSwipe?{passive:!1}:{})],[yt,d,s]];g.forEach(([b,j,x])=>u.addEventListener(b,j,x)),c=()=>g.forEach(([b,j])=>u.removeEventListener(b,j))}return c},f={ref:u=>{u!==null&&n((a,c)=>{if(a.el===u)return a;const s={};return a.el&&a.el!==u&&a.cleanUpTouch&&(a.cleanUpTouch(),s.cleanUpTouch=void 0),c.trackTouch&&u&&(s.cleanUpTouch=i(u,c)),Object.assign(Object.assign(Object.assign({},a),{el:u}),s)})}};return e.trackMouse&&(f.onMouseDown=o),[f,i]}function Ot(n,e,o,l){return!e.trackTouch||!n.el?(n.cleanUpTouch&&n.cleanUpTouch(),Object.assign(Object.assign({},n),{cleanUpTouch:void 0})):n.cleanUpTouch?e.preventScrollOnSwipe!==o.preventScrollOnSwipe||e.touchEventOptions.passive!==o.touchEventOptions.passive?(n.cleanUpTouch(),Object.assign(Object.assign({},n),{cleanUpTouch:l(n.el,e)})):n:Object.assign(Object.assign({},n),{cleanUpTouch:l(n.el,e)})}function Et(n){const{trackMouse:e}=n,o=w.useRef(Object.assign({},Q)),l=w.useRef(Object.assign({},N)),d=w.useRef(Object.assign({},l.current));d.current=Object.assign({},l.current),l.current=Object.assign(Object.assign({},N),n);let m;for(m in N)l.current[m]===void 0&&(l.current[m]=N[m]);const[h,i]=w.useMemo(()=>kt(r=>o.current=r(o.current,l.current),{trackMouse:e}),[e]);return o.current=Ot(o.current,l.current,d.current,i),h}function Ct(n){const{addParam:e}=R();return t.jsxs(t.Fragment,{children:[t.jsx(I,{onClick:()=>e("testimonyDrawer",!0),block:!0,children:"Testify Drawer"}),t.jsx(Tt,{...n})]})}function Tt({suspects:n,questions:e,answers:o,addEntryToUpdate:l}){var x;const{width:d,height:m}=Fe(),{is:h,removeParam:i}=R(),[r,f,u]=Ve(),a=Et({onSwipedLeft:()=>alert("Swiped Left"),onSwipedRight:()=>alert("Swiped Right"),onSwipedUp:()=>alert("Swiped Up"),preventScrollOnSwipe:!0,trackTouch:!0,trackMouse:!0}),c=()=>{f({suspectId:v.sample(Object.keys(n))||null,testimonyId:v.sample(Object.keys(e))||null})},s=()=>{c()},g=()=>{if(r!=null&&r.suspectId&&(r!=null&&r.testimonyId)){const p=v.cloneDeep(o[(r==null?void 0:r.testimonyId)??""]??{});p[r.suspectId]=[...p[r.suspectId]||[],1],l(r.testimonyId??"",p),c()}},b=()=>{if(r!=null&&r.suspectId&&(r!=null&&r.testimonyId)){const p=v.cloneDeep(o[(r==null?void 0:r.testimonyId)??""]??{});p[r.suspectId]=[...p[r.suspectId]||[],0],l(r.testimonyId??"",p),c()}},j=!!(r!=null&&r.suspectId)&&!!(r!=null&&r.testimonyId);return t.jsx(Be,{title:t.jsx(D,{children:"Does this person do this??"}),open:h("testimonyDrawer"),onCancel:()=>i("testimonyDrawer"),maskClosable:!1,width:d-64,footer:null,children:t.jsxs("div",{...a,children:[j&&t.jsxs(k,{vertical:!0,gap:8,className:"mb-8",justify:"center",align:"center",children:[t.jsx(U,{id:_(r.suspectId??"","gb"),width:Math.max(m/4,128)}),t.jsx(D.Title,{level:5,className:"text-center",children:(x=e[r.testimonyId??""])==null?void 0:x.question})]}),t.jsxs(z.Compact,{block:!0,size:"large",className:"mb-8",children:[t.jsx(I,{block:!0,icon:"ðŸ‘Ž",disabled:!j,style:{height:64},onClick:b,children:"No"}),t.jsx(I,{block:!0,onClick:s,style:{height:64},children:"Skip"}),t.jsx(I,{block:!0,icon:"ðŸ‘",iconPosition:"end",disabled:!j,style:{height:64},onClick:g,children:"Yes"})]})]})})}function It({suspects:n,questions:e,data:o,hasNewData:l,isDirty:d,save:m,isSaving:h,entriesToUpdate:i,addEntryToUpdate:r}){const{queryParams:f,addParams:u}=R(),a=w.useMemo(()=>{const c={};return Object.values(o).forEach(s=>{Object.keys(s).forEach(g=>{s[g]&&(c[g]||(c[g]=0),ye(s[g])>=5&&(c[g]+=1))})}),{queriedTestimoniesCount:Object.keys(o).length,suspectsCount:Object.keys(c).length,reliableSuspectsCount:Object.values(c).filter(s=>s>=5).length}},[o]);return t.jsxs(t.Fragment,{children:[t.jsx(L,{children:t.jsxs(k,{vertical:!0,gap:12,children:[t.jsx(De,{isDirty:d,onSave:m,isSaving:h,dirt:JSON.stringify(i)}),t.jsx(Te,{data:async()=>await Mt(o),fileName:"testimony-answers.json",disabled:d,hasNewData:l,block:!0})]})}),t.jsx(L,{children:t.jsx(Ce,{label:"Display",value:f.get("display")??"questions",onChange:c=>u({display:c,page:1},{page:1}),options:[{title:"Questions",icon:t.jsx(ze,{}),value:"questions"},{title:"Suspects",icon:t.jsx(Qe,{}),value:"suspects"},{title:"Simulator",icon:t.jsx(Ye,{}),value:"simulator"}]})}),t.jsx(L,{children:t.jsxs("div",{style:{fontSize:"0.85em"},children:[t.jsx("strong",{children:"Legend"}),t.jsxs("ul",{children:[t.jsx("li",{children:"Reliability: At least 5 votes"}),t.jsx("li",{children:"Large Bars: There's enough data (at least 3)"}),t.jsx("li",{children:"Small blue bar: in progress negative"})]})]})}),t.jsxs(L,{children:[t.jsxs("div",{style:{fontSize:"0.85em"},children:[t.jsx("strong",{children:"Counts"}),t.jsxs("ul",{children:[t.jsxs("li",{children:["Testimonies: ",a.queriedTestimoniesCount]}),t.jsxs("li",{children:["Suspects: ",a.suspectsCount]}),t.jsx("li",{children:t.jsxs(F,{title:"A reliable suspect is one that has at least 5 complete testimonies.",children:["Reliable suspects: ",a.reliableSuspectsCount]})})]})]}),t.jsx(Ct,{suspects:n,questions:e,answers:o,addEntryToUpdate:r})]})]})}async function Mt(n){console.log("Preparing file for download...x");const e=await Re("data","testimonies")(),o=Pe(e);console.log("Parsed data from Firestore:",o);const l=v.cloneDeep(n);return Object.keys(l).forEach(d=>{const m=l[d],h=o[d]||{};Object.keys(m).forEach(i=>{const r=h[i]||[],f=Xe([...m[i],...r]);m[i]=f})}),Ne(Ae(l))}function Sn(){const n=we();return t.jsx(pe,{title:"Testimonies",subtitle:"Suspect Testimony Rates",children:t.jsxs(ee,{hasSider:!0,children:[t.jsx(je,{children:t.jsx(It,{...n})}),t.jsx(ee.Content,{className:"content",children:t.jsx(xe,{isLoading:n.isLoading,error:n.error,hasResponseData:!v.isEmpty(n.data),children:t.jsx(gt,{...n})})})]})})}export{Sn as TestimoniesPage,Sn as default};
