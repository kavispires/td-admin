import{r as v,a as G,_ as V,j as e,T as A,B as N,aj as ie,af as ae,y as F,D as Z,P as ce,L as J}from"./index-CL7ZgB_t.js";import{D as le}from"./DataLoadingWrapper-DFoSirT7.js";import{l as y,c as ee,P as ue}from"./useBaseUrl-DvS4m1Km.js";import{u as B}from"./useQueryParams-D18ivquu.js";import{R as de,u as me}from"./useTestimoniesResource-C6WN7H3W.js";import{u as he,D as pe,a as fe,g as ge}from"./constants-D0FhWmUe.js";import{u as M}from"./useTDResource-f6RZMqvS.js";import{I as Q}from"./ImageCard-D_0g8_uX.js";import{g as te}from"./utils-BJs5IqRz.js";import{F as k}from"./index-CRghe_PI.js";import{B as Y,D as xe}from"./DownloadButton-C-q8dXnw.js";import{S as D}from"./index-CwEfDMC_.js";import{u as se}from"./useTableExpandableRows-C-1ZQDoq.js";import{u as ne}from"./useTablePagination-FbuPAgU3.js";import{P as K}from"./progress-Bx2E2Xx0.js";import{S as H}from"./index-BQPHuWNZ.js";import{F as W}from"./Table-DK0q2yVs.js";import{u as je}from"./useCardWidth-DpJCUosZ.js";import{C as oe}from"./index-Ckumnh5W.js";import{P as U}from"./index-CLOOKRG2.js";import{R as be}from"./FireFilled-BmRCnal1.js";import{F as ye}from"./FilterEntries-B43n70DE.js";import{S as $}from"./SiderContent-CD3lXP0U.js";import{S as we}from"./SaveButton-rmEowFL0.js";import{a as ve,d as Se}from"./index-CxTFAdG3.js";import{R as ke}from"./TableOutlined-BRrX7Bot.js";import"./useResourceFirestoreData-DPEI0iyJ.js";import"./useGetFirestoreDoc-BjB8aPiq.js";import"./useUpdateFirestoreDoc-BuJkMzpT.js";import"./useMutation-C_-B8jNM.js";import"./moment-C5S46NFB.js";import"./gapSize-U1swVQyS.js";import"./index-VajtuZzC.js";import"./index-Qm2xHDyK.js";import"./index-X4BaIBK0.js";import"./scrollTo-BgR-D5RO.js";import"./Pagination-Cw_LU7Ud.js";import"./extendsObject-keMuGWqj.js";import"./Input-DoEhzlJK.js";import"./index-CaNMvDnb.js";import"./SaveOutlined-CivnzahG.js";import"./constants-CpqFoyR7.js";import"./Item-DFsV0HVC.js";var Ce={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M594.3 601.5a111.8 111.8 0 0029.1-75.5c0-61.9-49.9-112-111.4-112s-111.4 50.1-111.4 112c0 29.1 11 55.5 29.1 75.5a158.09 158.09 0 00-74.6 126.1 8 8 0 008 8.4H407c4.2 0 7.6-3.3 7.9-7.5 3.8-50.6 46-90.5 97.2-90.5s93.4 40 97.2 90.5c.3 4.2 3.7 7.5 7.9 7.5H661a8 8 0 008-8.4c-2.8-53.3-32-99.7-74.7-126.1zM512 578c-28.5 0-51.7-23.3-51.7-52s23.2-52 51.7-52 51.7 23.3 51.7 52-23.2 52-51.7 52zm416-354H768v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H548v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H328v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H96c-17.7 0-32 14.3-32 32v576c0 17.7 14.3 32 32 32h832c17.7 0 32-14.3 32-32V256c0-17.7-14.3-32-32-32zm-40 568H136V296h120v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h148v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h148v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h120v496z"}}]},name:"contacts",theme:"outlined"},Ee={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M300 328a60 60 0 10120 0 60 60 0 10-120 0zM852 64H172c-17.7 0-32 14.3-32 32v660c0 17.7 14.3 32 32 32h680c17.7 0 32-14.3 32-32V96c0-17.7-14.3-32-32-32zm-32 660H204V128h616v596zM604 328a60 60 0 10120 0 60 60 0 10-120 0zm250.2 556H169.8c-16.5 0-29.8 14.3-29.8 32v36c0 4.4 3.3 8 7.4 8h729.1c4.1 0 7.4-3.6 7.4-8v-36c.1-17.7-13.2-32-29.7-32zM664 508H360c-4.4 0-8 3.6-8 8v60c0 4.4 3.6 8 8 8h304c4.4 0 8-3.6 8-8v-60c0-4.4-3.6-8-8-8z"}}]},name:"robot",theme:"outlined"},Oe={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M868 160h-92v-40c0-4.4-3.6-8-8-8H256c-4.4 0-8 3.6-8 8v40h-92a44 44 0 00-44 44v148c0 81.7 60 149.6 138.2 162C265.6 630.2 359 721.8 476 734.5v105.2H280c-17.7 0-32 14.3-32 32V904c0 4.4 3.6 8 8 8h512c4.4 0 8-3.6 8-8v-32.3c0-17.7-14.3-32-32-32H548V734.5C665 721.8 758.4 630.2 773.8 514 852 501.6 912 433.7 912 352V204a44 44 0 00-44-44zM248 439.6c-37.1-11.9-64-46.7-64-87.6V232h64v207.6zM840 352c0 41-26.9 75.8-64 87.6V232h64v120z"}}]},name:"trophy",theme:"filled"},Pe=function(t,n){return v.createElement(G,V({},t,{ref:n,icon:Ce}))},Ne=v.forwardRef(Pe),Re=function(t,n){return v.createElement(G,V({},t,{ref:n,icon:Ee}))},Ae=v.forwardRef(Re),Be=function(t,n){return v.createElement(G,V({},t,{ref:n,icon:Oe}))},X=v.forwardRef(Be);const _=(s,t,n)=>{const{reliabilityThreshold:c=4,projectionThreshold:r=55}={},i=`us-gb-${s.split("-")[1]}`,a=y.isEmpty(t[s])?[]:t[s];let u=0,l=0;a.forEach(O=>{O===3&&(u+=3),O===-3&&(l+=3),O===4&&(u+=4),O===-4&&(l+=4)});const h=a.filter(O=>![-4,-3,3,4].includes(O)),f=h.length+u+l,m=Math.max(f,5),p=a.filter(O=>O===1).length+u,w=Math.round(p/m*100),g=a.filter(O=>O===0).length+l,x=Math.round(g/m*100),b=Math.round((m-p-g)/m*100),S=h.length+u+l>=5,E=f>3,C=f>c,R=C?w>x?"👍":"👎":null,I=E?w>=r?"👍":x>=r?"👎":null:null;return{suspectCardId:s,imageId:i,enoughData:E,reliable:C,total:m,yesCount:p,yesPercentage:w,noCount:g,noPercentage:x,blankPercentage:b,complete:S,values:a,resolution:R,projection:I}};function Ie(s){const t=s.filter(r=>![0,1].includes(r)),n=s.filter(r=>[0,1].includes(r)),c={0:0,1:0};return n.forEach(r=>{if(c[r]===void 0)throw Error(`what is this value? ${r}`);c[r]+=1}),Object.entries(c).forEach(([r,d])=>{if(d>0){const i=Math.floor(d/4),a=d%4;for(let u=0;u<i;u++)t.push(r==="0"?-4:4);if(a>0){const u=Array.from({length:a},()=>r==="0"?0:1);t.push(...u)}}}),t.sort((r,d)=>r-d)}const L=9,Te=(s,t,n,c)=>{const[r]=he(pe.ESPIONAGEM,c),d=M("suspects",s),i=M(`testimony-questions-${t}`,s),a=M("testimony-answers",s),u=M("crime-reasons",s),l=v.useMemo(()=>Me(a.data),[a.data]),h=v.useMemo(()=>$e(d.data),[d.data]);return{entries:v.useMemo(()=>!r||!d.isSuccess||!i.isSuccess||!a.isSuccess||!u.isSuccess?{}:Fe(n,r,d.data,i.data,l,h,u.data),[s,r,d,i,a,n,l,h,u]),isLoading:d.isLoading||i.isLoading||a.isLoading}},Fe=(s,t,n,c,r,d,i)=>{console.count("Creating Espionagem...");let a=t.latestDate;const u=[],l={};for(let h=0;h<s;h++){const f=fe(a);a=f;let m=null,o=0;for(;!m&&o<100;){o++;const p=De(n,c,r,d,u,i);if(Le(p.statements)){m=p,console.log(`Generated valid game for ${f} after ${o} attempts`);break}}if(!m)throw new Error(`Failed to generate valid game for ${f} after 100 attempts`);u.push(m.culpritId),l[f]={id:f,type:"espionagem",number:t.latestNumber+h+1,...m}}return l};function De(s,t,n,c,r,d){let i=[];const a=[],u={},l=y.sample(Object.keys(n));if(!l)throw new Error("No selected testimony ID found");const h=Object.keys(n[l]).filter(C=>!r.includes(C)),f=h.length>0?h:Object.keys(n[l]),m=y.sample(f);if(!m)throw new Error("No selected culprit ID found");const o=y.sampleSize(Object.keys(n[l]).filter(C=>C!==m),L-1);for(i.push(...o);i.length<8;){const C=y.sampleSize(Object.keys(s).filter(R=>!i.includes(R)&&R!==m),L-i.length-1);i.push(...C)}const p={};Object.keys(c).forEach(C=>{if(c[C][m]===void 0){const R=Object.keys(c[C]).filter(I=>i.includes(I));if(R.length>0){const I={};R.forEach(O=>{i.includes(O)&&(I[O]=!0)}),p[C]=I}}});const w=t[l];a.push(ze(m,i,w,n[l])),T(u,a[0].excludes);const j=q(m,i,p);a.push(j),T(u,j.excludes),i=y.shuffle([...i,m]);const g=q(m,i,p,[j],"worst");a.push(g),T(u,g.excludes);const x=q(m,i,p,[j,g],"worst");a.push(x),T(u,x.excludes);const b=He(m,i,a);a.push(b),T(u,b.excludes);const S=[a[0],a[1],a[2],a[4],a[3]],E=Ge(s[m],d);return{isNsfw:w.nsfw??!1,culpritId:m,statements:S,suspects:i.map(C=>s[C]),reason:E.title,setId:`${m}::${E.id}::${S[0].key}`,level:Ve(S)}}const Me=s=>{const t={};console.log("⚙️ Calculating suspect answers...");for(const n of Object.keys(s)){const c=s[n];for(const r of Object.keys(c)){const{resolution:d,projection:i}=_(r,c);if(!d&&!i){console.log("⁉️ Ignoring testimony with no resolution or projection");continue}if(t[n]===void 0&&(t[n]={}),d){t[n][r]=d==="👍";continue}if(i){t[n][r]=i==="👍";continue}console.log("⁉️ Ignoring testimony with not enough values")}}return Object.keys(t).forEach(n=>{y.isEmpty(t[n])&&delete t[n]}),Object.keys(t).forEach(n=>{Object.keys(t[n]).length<3&&(console.log("⁉️ Removing testimonies with less than 3 answers"),delete t[n])}),Object.keys(t).forEach(n=>{y.uniq(Object.values(t[n])).length===1&&(console.log("⁉️ Removing testimonies with the same answer"),delete t[n])}),t},$e=s=>{const t={};for(const c of Object.keys(s)){const{gender:r,ethnicity:d,age:i,build:a,height:u,features:l}=s[c];if(!a){console.log("⁉️ Ignoring suspect with missing build",c);continue}if(!u){console.log("⁉️ Ignoring suspect with missing height",c);continue}if(!l||l.length===0){console.log("⁉️ Ignoring suspect with missing features",c);continue}t[r]===void 0&&(t[r]={}),t[r][c]=!0,t[d]===void 0&&(t[d]={}),t[d][c]=!0,t[i]===void 0&&(t[i]={}),t[i][c]=!0,t[a]===void 0&&(t[a]={}),t[a][c]=!0,t[u]===void 0&&(t[u]={}),t[u][c]=!0,l.forEach(h=>{t[h]===void 0&&(t[h]={}),t[h][c]=!0})}return t.young=y.cloneDeep(t["18-21"]),t.adult=y.cloneDeep({...t["21-30"],...t["30-40"],...t["40-50"]}),t.senior=y.cloneDeep({...t["50-60"],...t["60-70"],...t["70-80"],...t["80-90"]}),["18-21","21-30","30-40","40-50","50-60","60-70","70-80","80-90","average","medium","mixed","adult","tall"].forEach(c=>{delete t[c]}),t},T=(s,t)=>{t.forEach(n=>{s[n]===void 0&&(s[n]=0),s[n]++})},ze=(s,t,n,c)=>{const r=c[s],d=t.filter(u=>c[u]!==void 0&&c[u]!==r),i=n.answer.charAt(0).toLowerCase()+n.answer.slice(1),a={key:`testimony.${n.id}`,text:`O(a) suspeito(a) ${r?"":"não "}${i}`,excludes:d};return a.text.includes("não já")&&(a.text=a.text.replace("não já","nunca")),a},z={row1:{indexes:[0,1,2],text:"na primeira linha"},row2:{indexes:[3,4,5],text:"na segunda linha"},row3:{indexes:[6,7,8],text:"na terceira linha"},column1:{indexes:[0,3,6],text:"na primeira coluna"},column2:{indexes:[1,4,7],text:"na segunda coluna"},column3:{indexes:[2,5,8],text:"na terceira coluna"},corners:{indexes:[0,2,6,8],text:"nos cantos"}},He=(s,t,n)=>{const c=t.indexOf(s),r=n.slice(0,3),d={};for(const f of Object.keys(z)){const{indexes:m}=z[f];m.includes(c)||(d[f]=m.reduce((o,p)=>{const w=t[p],j=r.filter(g=>g.excludes.includes(w)).length;return j>0?o+j:o},0))}const i=Object.entries(d).reduce((f,[m,o])=>(f[o]||(f[o]=[]),f[o].push(m),f),{}),a=Math.min(...Object.keys(d).map(f=>d[f])),u=i[a.toString()],l=y.sample(u)||Object.keys(d)[0],h=z[l].indexes.map(f=>t[f]);return{key:`not.grid.${l}`,text:`O(a) suspeito(a) não está ${z[l].text}`,excludes:h}},q=(s,t,n,c=[],r="best")=>{const d=y.difference(t,[s]),i=c.filter(p=>p.key.startsWith("not.feature.")).map(p=>p.key.replace("not.feature.","")),a=new Set(c.flatMap(p=>p.excludes)),u=Object.keys(n).filter(p=>Object.keys(n[p]).length<=6&&!i.includes(p)).sort((p,w)=>Object.keys(n[w]).length-Object.keys(n[p]).length);let l,h=[],f=0;const m=100;for(;f<m;){f++;const p=r==="best"?u[0]:y.sample(u.slice(2,5))??u[2];if(!p)break;const w=d.filter(g=>n[p][g]);if(w.some(g=>!a.has(g))||f===m){l=p,h=w;break}u.splice(u.indexOf(p),1)}if(!l)throw Error(`No suitable feature found for ${r} selection after ${m} attempts`);const o=qe[l];return o||console.warn(`Feature ${l} not found in translations`),{key:`not.feature.${l}`,text:`O(a) suspeito(a) não ${o||l}`,excludes:h}},qe={male:"é homem",female:"é mulher",black:"é negro(a)",white:"é branco(a)",asian:"é asiático(a)",latino:"é latino(a)",thin:"é magrelo(a)",fat:"é gordo(a)",large:"é gordo(a)",tall:"é alto(a)",short:"é baixinho(a)",young:"é jovem",adult:"é adulto(a)",senior:"é idoso(a)",average:"é médio(a)",medium:"é médio(a)",mixed:"é mestiço(a)",hat:"está usando um chapéu",tie:"está usando uma gravata",glasses:"está usando óculos",brownHair:"tem cabelo castanho",shortHair:"tem cabelo curto",beard:"tem barba",caucasian:"é caucasiano(a)",scarf:"está usando um cachecol",blondeHair:"tem cabelo loiro",longHair:"tem cabelo longo",greyHair:"tem cabelo grisalho",bald:"é careca",mustache:"tem bigode",goatee:"tem cavanhaque",muscular:"é musculoso(a)",blackHair:"tem cabelo preto",hoodie:"está usando um moletom",earrings:"está usando brincos",lipstick:"está usando batom",necklace:"está usando um colar",mediumHair:"tem cabelo médio","middle-eastern":"é do Oriente Médio",headscarf:"está usando um lenço na cabeça",redHair:"tem cabelo ruivo",piercings:"tem piercings",coloredHair:"tem cabelo colorido",indian:"é indiano(a)","native-american":"é nativo-americano(a)"},Le=s=>{const t=s.slice(0,3);return t.reduce((r,d)=>r+d.excludes.length,0)<10?!1:new Set(t.flatMap(r=>r.excludes)).size===L-1},Ge=(s,t)=>{const n=[];Object.values(t).forEach(r=>{var d;r.feature==="general"&&n.push(r),(d=s.features)!=null&&d.includes(r.feature)&&n.push(r)});const c=y.sample(n);return c||{id:"unknown",title:{pt:"Motivo desconhecido",en:"Unknown reason"},feature:"general"}},Ve=s=>{const t=s.slice(0,3),n=[],c={1:4,2:3,3:3,4:2,5:2,6:1,7:0,8:0};t.forEach(d=>{const i=d.excludes.length;c[i]!==void 0&&n.push(c[i])});const r=Math.round(n.reduce((d,i)=>d+i,0)/n.length);return Math.min(Math.max(r,1),3)};function Qe(){const[s,t]=v.useState({}),{entries:n}=Te(!0,"pt",1,s);return e.jsxs(k,{vertical:!0,gap:12,className:"p-4",children:[e.jsxs(k,{justify:"space-between",align:"center",children:[e.jsx(A.Title,{level:4,className:"my-0",children:"Espionagem Simulator"}),e.jsx(N,{type:"primary",onClick:()=>t({}),children:"Re-run Simulation"})]}),e.jsx(We,{entries:n})]})}function We({entries:s}){const[t,n]=v.useState(!1),c=ge(),r=s[c],d=v.useMemo(()=>r?r.statements.slice(0,3).reduce((i,a)=>{const{excludes:u}=a;return u.forEach(l=>{i[l]?i[l]++:i[l]=1}),i},{}):{},[r]);return e.jsxs("div",{className:"full-width grid grid-2",children:[e.jsx(de,{src:s??{},theme:"twilight",collapsed:3}),r&&e.jsxs(k,{gap:18,className:"p-4",children:[e.jsx("div",{children:e.jsx("div",{style:{width:`${105*3}px`,display:"grid",gap:"6px",gridTemplateColumns:"repeat(3, 1fr)"},children:r.suspects.map(i=>e.jsxs(Y.Ribbon,{text:t?d[i.id]:null,color:"cyan",children:[e.jsx(Q,{id:te(i.id,"gb"),width:96,className:ee(t&&i.id===r.culpritId&&"red-border")},i.id),e.jsxs(k,{gap:6,align:"center",children:[e.jsx(D,{checkedChildren:"🚫",size:"small"})," ",i.id]})]},i.id))})}),e.jsxs("div",{children:[e.jsx("div",{children:e.jsx(D,{checkedChildren:"Show Culprit",unCheckedChildren:"Hide Culprit",checked:t,onChange:n})}),r.statements.map((i,a)=>e.jsx(A.Paragraph,{children:e.jsx(Y,{count:i.excludes.length,color:"cyan",children:e.jsx(ie,{message:i.text,banner:!0,type:a<3?"info":"error"},i.key)})},i.key))]})]})]})}function re({suspect:s,values:t,resolution:n,projection:c,yesPercentage:r,noPercentage:d,complete:i,enoughData:a,testimonyId:u,addEntryToUpdate:l,answers:h,barWidth:f,showName:m}){const o=g=>{const x={...h};x[g]=[...x[g]||[],3],l(u,x)},p=g=>{const x={...h};x[g]=[...x[g]||[],-3],l(u,x)},w=g=>{var S;const x={...h},b=(S=x[g])==null?void 0:S.findIndex(E=>E===3);b!==-1&&b!==void 0&&(x[g]=[...x[g].slice(0,b),...x[g].slice(b+1)]),l(u,x)},j=g=>{var S;const x={...h},b=(S=x[g])==null?void 0:S.findIndex(E=>E===-3);b!==-1&&b!==void 0&&(x[g]=[...x[g].slice(0,b),...x[g].slice(b+1)]),l(u,x)};return e.jsxs(ae,{trigger:"click",title:`Add strong fit/unfit answer to ${s.name.pt}`,content:e.jsxs(k,{vertical:!0,gap:4,children:[e.jsx(A.Text,{type:"secondary",children:t.join(", ")}),e.jsxs(N,{icon:"👍",block:!0,onClick:()=>o(s.id),children:[" ","Add strong fit"]}),e.jsxs(N,{icon:"👎",block:!0,onClick:()=>p(s.id),children:[" ","Add strong unfit"]}),e.jsxs(H.Compact,{children:[e.jsx(N,{icon:"❌",size:"small",block:!0,onClick:()=>w(s.id),children:"fit"}),e.jsx(N,{icon:"❌",size:"small",block:!0,onClick:()=>j(s.id),children:"unfit"})]})]}),children:[m&&e.jsxs("div",{children:[e.jsx(F,{title:s.id,children:s.name.pt})," ",i&&e.jsx(F,{title:"Complete: It has 5 or more answers",children:e.jsx(X,{style:{color:"gold"}})})]}),e.jsxs(k,{align:"flex-start",gap:12,children:[e.jsx(F,{title:`Values: ${t.join(", ")} : ${n||(c?`${c}*`:"")}`,children:a?e.jsx(K,{percent:d+r,size:[f,20],status:"exception",success:{percent:r},showInfo:!1}):e.jsx(K,{percent:d+r,size:[f,10],status:"exception",success:{percent:r},showInfo:!1})}),!m&&i&&e.jsx(F,{title:"Complete: It has 5 or more answers",children:e.jsx(X,{style:{color:"gold"}})})]})]})}function _e({suspect:s,answersPerQuestion:t,questions:n,addEntryToUpdate:c,allAnswers:r}){const{queryParams:d}=B({sortSuspectsBy:"answers"}),i=d.get("sortSuspectsBy")??"answers";console.log(t),console.log(r);const a=v.useMemo(()=>{const l=Object.values(n).map(h=>{const f=t[h.id]??{},{enoughData:m,reliable:o,yesPercentage:p,noPercentage:w,blankPercentage:j,values:g,total:x,resolution:b,projection:S,complete:E}=_(s.id,{[s.id]:f});return{id:h.id,question:h,enoughData:m,reliable:o,yesPercentage:p,noPercentage:w,blankPercentage:j,values:g,total:x,resolution:b,projection:S,complete:E}});return i==="answers"?y.orderBy(l,["reliable","enoughData","yesPercentage",h=>h.values.length],["desc","desc","desc","desc"]):y.orderBy(l,h=>Number(h.id.split("-")[1]),["asc"])},[t,n,s.id,i]),u=[{key:"id",title:"Id",dataIndex:"id"},{key:"question",title:"Question",dataIndex:"question",render:l=>l.question},{key:"answer",title:"Answer",dataIndex:"id",sorter:(l,h)=>l.total-h.total,render:l=>{const h=a.find(f=>f.id===l);return h?e.jsx(k,{gap:8,wrap:"nowrap",children:e.jsx(re,{values:h.values,resolution:h.resolution,projection:h.projection,yesPercentage:h.yesPercentage,noPercentage:h.noPercentage,complete:h.complete,enoughData:h.enoughData,suspect:s,testimonyId:h.question.id,answers:r[h.question.id]||{},addEntryToUpdate:c,barWidth:120})}):""}}];return e.jsx(H,{wrap:!0,size:"large",children:e.jsx(W,{rowKey:"id",columns:u,dataSource:a,bordered:!0})})}function Je({isLoading:s,isSuccess:t,questions:n,data:c,suspects:r,addEntryToUpdate:d}){const{queryParams:i,addParam:a}=B(),u=v.useMemo(()=>Object.keys(c).reduce((o,p)=>{const w=c[p]??{};return Object.keys(w).forEach(j=>{o[j]||(o[j]={}),o[j][p]=w[j]}),o},{}),[c]),l=v.useMemo(()=>y.orderBy(Object.values(r).map(o=>({...o,answers:u[o.id]})),o=>Number(o.id.split("-")[1]),"asc"),[r,u]),h=ne({total:l.length,showQuickJumper:!0}),f=[{title:"Id",dataIndex:"id",key:"id",sorter:(o,p)=>Number(o.id.split("-")[1])-Number(p.id.split("-")[1])},{title:"Picture",dataIndex:"id",render:o=>e.jsx(Q,{id:te(o,"gb"),width:48})},{title:"Name",dataIndex:"name",key:"name",sorter:(o,p)=>o.name.pt.localeCompare(p.name.pt),render:o=>o.pt},{title:"Questions Answered",dataIndex:"answers",key:"answers",sorter:(o,p)=>Object.keys(o.answers??{}).length-Object.keys(p.answers??{}).length,render:o=>o?Object.values(o).length:""}],m=se({maxExpandedRows:1,expandedRowRender:o=>e.jsx(_e,{suspect:o,answersPerQuestion:u[o.id],questions:n,addEntryToUpdate:d,allAnswers:c}),rowExpandable:()=>t});return e.jsxs(k,{gap:12,className:"full-width py-4",vertical:!0,children:[e.jsxs(k,{justify:"space-between",align:"center",children:[e.jsx(A.Title,{level:4,className:"my-0",children:"Testimonies by Suspect"}),e.jsx(D,{checked:i.get("sortSuspectsBy")==="answers",onChange:o=>a("sortSuspectsBy",o?"answers":"id"),checkedChildren:"Sort by Answers",unCheckedChildren:"Sort by Id"})]}),e.jsx(W,{columns:f,dataSource:l,pagination:h,rowKey:"id",expandable:m,loading:s,bordered:!0,className:"full-width"})]})}function Ye({answers:s,suspects:t,addEntryToUpdate:n,testimonyId:c}){const[r,d]=je(12),{queryParams:i,is:a}=B({sortSuspectsBy:"answers"}),u=a("enableBatch"),l=i.get("sortSuspectsBy")??"answers",h=v.useMemo(()=>{const o=Object.keys(t).map(p=>_(p,s));return l==="answers"?y.orderBy(o,["reliable","enoughData",p=>p.values.length,"yesPercentage"],["desc","desc","desc","desc"]):y.orderBy(o,p=>Number(p.suspectCardId.split("-")[1]),["asc"])},[s,t,l]),[f,m]=v.useState([]);return e.jsxs(H,{direction:"vertical",children:[e.jsx(Ke,{selection:f,setSelection:m,suspects:t,addEntryToUpdate:n,list:h,testimonyId:c,answers:s}),e.jsx(H,{wrap:!0,ref:d,size:"large",children:h.map(o=>e.jsxs(k,{vertical:!0,gap:6,className:ee({"selection-outline":u&&f.includes(o.suspectCardId)}),children:[e.jsx(Q,{id:o.imageId,width:r,className:o.values.length>1?void 0:"grayscale"}),e.jsxs(k,{gap:4,children:[u&&e.jsx(oe,{disabled:o.complete,checked:f.includes(o.suspectCardId),onChange:p=>{const w=p.target.checked;m(j=>w?[...j,o.suspectCardId]:j.filter(g=>g!==o.suspectCardId))}}),e.jsx(re,{values:o.values,resolution:o.resolution,projection:o.projection,yesPercentage:o.yesPercentage,noPercentage:o.noPercentage,complete:o.complete,enoughData:o.enoughData,suspect:t[o.suspectCardId],testimonyId:c,answers:s,addEntryToUpdate:n,barWidth:r,showName:!0})]})]},o.suspectCardId))})]})}function Ke({testimonyId:s,selection:t,setSelection:n,suspects:c,addEntryToUpdate:r,list:d,answers:i}){const[a,u]=v.useState([]),{addParam:l,removeParam:h,is:f}=B({sortSuspectsBy:"answers"}),m=f("enableBatch"),o=j=>{u(g=>g.includes(j)?g.filter(x=>x!==j):[...g,j])},p=v.useMemo(()=>y.keyBy(d,"suspectCardId"),[d]);v.useEffect(()=>{if(a.length===0&&t.length>0){n([]);return}if(!a.length)return;const g=(t.length>0?t:Object.values(p).filter(x=>!x.complete&&!x.values.includes(3)&&!x.values.includes(-3)).map(x=>x.suspectCardId)).filter(x=>{const b=c[x],S=[b.gender,b.ethnicity,b.build,b.height];return b.age==="18-21"&&S.push("young"),(b.age==="21-30"||b.age==="30-40")&&S.push("adult"),b.age==="40-50"&&S.push("parent"),(b.age==="50-60"||b.age==="60-70"||b.age==="70-80"||b.age==="80-90")&&S.push("senior"),a.every(E=>S.includes(E))});n(g)},[a]);const w=j=>{const g=y.cloneDeep(i);t.forEach(x=>{g[x]=[...g[x]||[],j]}),r(s,g),u([])};return e.jsxs(k,{align:"center",gap:6,justify:"space-between",className:"mb-4",children:[e.jsxs(k,{gap:3,children:[e.jsx(A.Text,{className:"nowrap buceta",style:{minWidth:"5ch"},children:"Batch"}),e.jsx(D,{value:m,checkedChildren:"On",unCheckedChildren:"Off",onChange:j=>{j?l("enableBatch",!0):h("enableBatch")}})]}),m&&e.jsxs(e.Fragment,{children:[e.jsxs(A.Text,{className:"nowrap mr-2",children:["Selected ",t.length]}),e.jsxs(k,{gap:6,wrap:!0,align:"center",justify:"center",children:[e.jsx(P,{filter:"male",activeFilters:a,updateActiveFilter:o}),e.jsx(P,{filter:"female",activeFilters:a,updateActiveFilter:o}),e.jsx(P,{filter:"young",activeFilters:a,updateActiveFilter:o}),e.jsx(P,{filter:"adult",activeFilters:a,updateActiveFilter:o}),e.jsx(P,{filter:"parent",activeFilters:a,updateActiveFilter:o}),e.jsx(P,{filter:"senior",activeFilters:a,updateActiveFilter:o}),e.jsx(P,{filter:"thin",activeFilters:a,updateActiveFilter:o}),e.jsx(P,{filter:"muscular",activeFilters:a,updateActiveFilter:o}),e.jsx(P,{filter:"large",activeFilters:a,updateActiveFilter:o}),e.jsx(P,{filter:"asian",activeFilters:a,updateActiveFilter:o}),e.jsx(P,{filter:"black",activeFilters:a,updateActiveFilter:o}),e.jsx(P,{filter:"caucasian",activeFilters:a,updateActiveFilter:o}),e.jsx(P,{filter:"latino",activeFilters:a,updateActiveFilter:o})]}),e.jsxs(k,{align:"center",gap:6,children:[e.jsx(N,{onClick:()=>u([]),danger:!0,size:"small",children:"Clear"}),e.jsx(U,{title:"Apply +3 to selected suspects?",onConfirm:()=>w(3),children:e.jsx(N,{disabled:t.length===0,size:"small",type:"primary",className:"ml-10",children:"Apply +3"})}),e.jsx(Z,{type:"vertical"}),e.jsx(U,{title:"Apply -3 to selected suspects?",onConfirm:()=>w(-3),children:e.jsx(N,{disabled:t.length===0,size:"small",type:"primary",children:"Apply -3"})})]})]})]})}function P({filter:s,activeFilters:t,updateActiveFilter:n}){return e.jsxs(e.Fragment,{children:[e.jsxs("span",{children:[e.jsx(oe,{checked:t.includes(s),onClick:()=>n(s)})," ",y.capitalize(s)]}),e.jsx(Z,{type:"vertical"})]})}function Ue({data:s,questions:t,suspects:n,isLoading:c,isSuccess:r,addEntryToUpdate:d}){const{queryParams:i,addParam:a}=B(),u=v.useMemo(()=>y.orderBy(Object.values(t),m=>Number(m.id.split("-")[1]),"asc"),[t]),l=ne({total:u.length,showQuickJumper:!0}),h=[{title:"Id",dataIndex:"id",key:"id",sorter:(m,o)=>Number(m.id.split("-")[1])-Number(o.id.split("-")[1])},{title:"Question",dataIndex:"question",key:"question",sorter:(m,o)=>m.question.localeCompare(o.question)},{title:"NSFW",dataIndex:"nsfw",key:"nsfw",render:m=>m?e.jsx(be,{style:{color:"hotPink"}}):"",sorter:(m,o)=>Number(m.nsfw)-Number(o.nsfw)},{title:"Answers",dataIndex:"id",key:"answers",render:m=>{const o=s[m];return o?Object.values(o).length:""}}],f=se({maxExpandedRows:1,expandedRowRender:m=>e.jsx(Ye,{testimonyId:m.id,answers:s[m.id]??{},suspects:n,addEntryToUpdate:d}),rowExpandable:()=>r});return e.jsxs(k,{gap:12,className:"full-width py-4",vertical:!0,children:[e.jsxs(k,{justify:"space-between",align:"center",children:[e.jsx(A.Title,{level:4,className:"my-0",children:"Suspects by Testimony"}),e.jsx(D,{checked:i.get("sortSuspectsBy")==="answers",onChange:m=>a("sortSuspectsBy",m?"answers":"id"),checkedChildren:"Sort by Answers",unCheckedChildren:"Sort by Id"})]}),e.jsx(W,{columns:h,dataSource:u,pagination:l,rowKey:"id",expandable:f,loading:c,bordered:!0,className:"full-width"})]})}function Xe(s){const{queryParams:t,is:n}=B();return e.jsxs(e.Fragment,{children:[(n("display","questions")||!t.get("display"))&&e.jsx(Ue,{...s}),n("display","suspects")&&e.jsx(Je,{...s}),n("display","simulator")&&e.jsx(Qe,{})]})}function Ze({data:s,hasNewData:t,isDirty:n,save:c,isSaving:r,entriesToUpdate:d}){const{queryParams:i,addParams:a}=B(),u=v.useMemo(()=>{const l={};return Object.values(s).forEach(h=>{Object.keys(h).forEach(f=>{h[f]&&(l[f]||(l[f]=0),h[f].length>=5&&(l[f]+=1))})}),{queriedTestimoniesCount:Object.keys(s).length,suspectsCount:Object.keys(l).length,reliableSuspectsCount:Object.values(l).filter(h=>h>=5).length}},[s]);return e.jsxs(e.Fragment,{children:[e.jsx($,{children:e.jsxs(k,{vertical:!0,gap:12,children:[e.jsx(we,{isDirty:n,onSave:c,isSaving:r,dirt:JSON.stringify(d)}),e.jsx(xe,{data:()=>et(s),fileName:"testimony-answers.json",disabled:n,hasNewData:t,block:!0})]})}),e.jsx($,{children:e.jsx(ye,{label:"Display",value:i.get("display")??"questions",onChange:l=>a({display:l,page:1},{page:1}),options:[{title:"Questions",icon:e.jsx(ke,{}),value:"questions"},{title:"Suspects",icon:e.jsx(Ne,{}),value:"suspects"},{title:"Simulator",icon:e.jsx(Ae,{}),value:"simulator"}]})}),e.jsx($,{children:e.jsxs("div",{style:{fontSize:"0.85em"},children:[e.jsx("strong",{children:"Legend"}),e.jsxs("ul",{children:[e.jsx("li",{children:"Reliability: At least 5 votes"}),e.jsx("li",{children:"Large Bars: There's enough data (at least 3)"}),e.jsx("li",{children:"Small blue bar: in progress negative"})]})]})}),e.jsx($,{children:e.jsxs("div",{style:{fontSize:"0.85em"},children:[e.jsx("strong",{children:"Counts"}),e.jsxs("ul",{children:[e.jsxs("li",{children:["Testimonies: ",u.queriedTestimoniesCount]}),e.jsxs("li",{children:["Suspects: ",u.suspectsCount]}),e.jsx("li",{children:e.jsxs(F,{title:"A reliable suspect is one that has at least 5 complete testimonies.",children:["Reliable suspects: ",u.reliableSuspectsCount]})})]})]})})]})}function et(s){console.log("Preparing file for download...x");const t=y.cloneDeep(s);return Object.keys(t).forEach(n=>{const c=t[n];Object.keys(c).forEach(r=>{const d=c[r].sort().join(","),i=Ie(c[r].sort());(i.includes(-4)||i.includes(4))&&console.log(`Suspect ${r} has auto-grouped values from: ${d} to ${i.join(",")}`),c[r]=i})}),ve(Se(t))}function Vt(){const s=me();return e.jsx(ce,{title:"Testimonies",subtitle:"Suspect Testimony Rates",children:e.jsxs(J,{hasSider:!0,children:[e.jsx(ue,{children:e.jsx(Ze,{...s})}),e.jsx(J.Content,{className:"content",children:e.jsx(le,{isLoading:s.isLoading,error:s.error,hasResponseData:!y.isEmpty(s.data),children:e.jsx(Xe,{...s})})})]})})}export{Vt as TestimoniesPage,Vt as default};
