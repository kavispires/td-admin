import{j as e,F as u,D as M,r as x,T as h,B as g,i as F,P as O,L as w}from"./index-CHgUvU-Q.js";import{D as E}from"./DataLoadingWrapper-DQsKNpFX.js";import{u as C}from"./useQueryParams-VqFm9HOY.js";import{l as p,P as k}from"./useBaseUrl-CBSZVmxT.js";import{I as R}from"./Item-Dy13d1qu.js";import{u as I}from"./useCopyToClipboardFunction-Bj4V3NPn.js";import{u as P}from"./useTableExpandableRows-DXEtnFsf.js";import{u as $}from"./useTablePagination-CArjHQXl.js";import{u as v}from"./useTDResource-DU00cG8y.js";import{c as B,r as T,a as H,e as Q}from"./index-Dljogd6m.js";import{I as Y}from"./ItemsTypeahead-DFP40u7f.js";import{R as G}from"./PlusOutlined-kpCSYfPU.js";import{u as _}from"./useDailyHistoryQuery--ENCbqQa.js";import{u as J,L as K}from"./useParsedHistory-DC_YZb5-.js";import{F as f}from"./Table-B_7RH4eV.js";import{S as y}from"./index-dRs8msh9.js";import{P as W}from"./index-n8IfTqIK.js";import{R as X}from"./DeleteFilled-C_NmUhqz.js";import{T as z}from"./Typeahead-CQjVkNp-.js";import{b as q}from"./FilterEntries-Ca9OOQms.js";import{S as U}from"./SiderContent-Di8ADKZ6.js";import{D as Z}from"./DownloadButton-e3tUTa7M.js";import{S as V}from"./SaveButton-B19kmU70.js";import{u as ee}from"./useResourceFirestoreData-D9oDHkot.js";import"./constants-CkzRd0cf.js";import"./useDebounce-U4kPmAoE.js";import"./index-VjOnN53p.js";import"./index-6DsWN4Sx.js";import"./useGetFirestoreDoc-CbHN8uBo.js";import"./moment-C5S46NFB.js";import"./index-DBb1QsdX.js";import"./index-DnwQJJWd.js";import"./index-DRprD1BH.js";import"./scrollTo-C75I2ruP.js";import"./Pagination-BjMAWdWF.js";import"./index-MEm3FsfO.js";import"./SaveOutlined-m-1HbeuI.js";import"./useUpdateFirestoreDoc-BN7m3fUL.js";import"./useMutation-BIqnuchv.js";function D({movie:t,addEntryToUpdate:s}){const r=a=>{s(t.id,{...t,itemsIds:[...t.itemsIds,a]})};return e.jsxs(u,{gap:12,children:[e.jsx("div",{style:{minWidth:250},children:e.jsx(Y,{onFinish:r})}),e.jsx(M,{type:"vertical",variant:"dotted"}),e.jsx(te,{movie:t,onUpdate:r})]})}function te({movie:t,onUpdate:s}){const r=v("items",!0),a=x.useMemo(()=>{if(!r.data)return[];const i=t.title.toLowerCase(),l=Object.entries(r.data),c=[];return l.forEach(([m,n])=>{if(t.itemsIds.includes(m))return;const o=[n.name.pt.toLowerCase()];n.aliasesPt&&Array.isArray(n.aliasesPt)&&o.push(...n.aliasesPt.map(A=>A.toLowerCase()));const S=B.findBestMatch(i,o).bestMatch.rating;S>.3&&c.push({id:m,similarity:S})}),c.sort((m,n)=>n.similarity-m.similarity).slice(0,20).map(m=>m.id)},[r.data,t]);return e.jsxs(u,{gap:12,vertical:!0,children:[e.jsx(h.Text,{strong:!0,children:"Suggestions"}),e.jsx(u,{gap:16,wrap:"wrap",children:a.map((i,l)=>{const c=r.data?.[i];return e.jsxs(u,{gap:2,vertical:!0,children:[e.jsx(R,{itemId:i,title:`${c.name.en} | ${c.name.pt}`,width:60}),e.jsxs(u,{gap:6,justify:"center",children:[e.jsx(h.Text,{children:i}),e.jsx(g,{onClick:()=>s(i),shape:"circle",size:"small",children:e.jsx(G,{})})]})]},`sample-${i}-${l}`)})})]})}function se(){const t=K.DAILY.pt,s=_(t,{enabled:!0}),[r]=J("filmaco",s.data);return x.useMemo(()=>p.mapValues(p.keyBy(r?.used??[]),()=>!0),[r])}function N({rows:t,addEntryToUpdate:s}){const r=I(),a=v("items"),i=se(),l=$({total:t.length,showQuickJumper:!0}),c=[{title:"Title",dataIndex:"title",render:(n,o)=>e.jsx(j,{addEntryToUpdate:s,movie:o,property:"title",value:n}),sorter:(n,o)=>n.title.localeCompare(o.title)},{title:"Year",dataIndex:"year",render:(n,o)=>e.jsx(j,{addEntryToUpdate:s,movie:o,property:"year",value:n}),sorter:(n,o)=>n.year-o.year},f.EXPAND_COLUMN,{title:"Items",dataIndex:"itemsIds",key:"itemsIds",render:(n,o)=>e.jsx(L,{addEntryToUpdate:s,copyToClipboard:r,itemsIds:n,movie:o}),sorter:(n,o)=>n.itemsIds.length-o.itemsIds.length},{title:"Count",dataIndex:"itemsIds",render:n=>T(n).filter(Boolean).length},{title:"Used",dataIndex:"id",render:n=>i[n]?"Yes":"No",sorter:(n,o)=>i[n.id]&&!i[o.id]?-1:!i[n.id]&&i[o.id]?1:o.itemsIds.length-n.itemsIds.length}],m=P({maxExpandedRows:1,expandedRowRender:n=>e.jsx(D,{addEntryToUpdate:s,movie:n}),rowExpandable:()=>a.isSuccess});return e.jsx(f,{columns:c,dataSource:t,expandable:m,pagination:l,rowKey:"id"})}function re({movie:t,addEntryToUpdate:s,itemId:r}){const a=()=>{s(t.id,{...t,itemsIds:t.itemsIds.filter(i=>i!==r)})};return e.jsx(W,{cancelText:"No",okText:"Yes",onConfirm:a,title:"Are you sure you want to remove this item?",children:e.jsx(g,{icon:e.jsx(X,{}),size:"small",type:"text"})})}function L({movie:t,itemsIds:s,copyToClipboard:r,addEntryToUpdate:a}){return e.jsx(u,{gap:6,wrap:"wrap",children:s.map((i,l)=>e.jsxs(u,{gap:2,vertical:!0,children:[e.jsx(R,{itemId:i,width:60}),e.jsxs(u,{justify:"center",children:[e.jsx(h.Text,{onClick:()=>r(i),children:i}),e.jsx(re,{addEntryToUpdate:a,itemId:i,movie:t})]})]},`${t.title}-${i}-${l}`))},`items-${t.title}`)}function j({value:t,movie:s,addEntryToUpdate:r,property:a}){const i=l=>typeof t=="number"?l!==String(t)?r(s.id,{...s,[a]:Number(l)}):null:l!==t?r(s.id,{...s,[a]:l.trim()}):null;return e.jsx(y,{children:e.jsx(h.Text,{editable:{onChange:i},children:String(t)})})}function ie(t){return p.orderBy(t,[s=>s.title]).map(s=>({...s,itemsIds:p.orderBy(s.itemsIds,r=>Number(r))}))}function oe({data:t,addEntryToUpdate:s}){const{is:r}=C(),a=r("emptyOnly"),i=x.useMemo(()=>{const c=t?ie(Object.values(t)):[];return a?c.filter(m=>m.itemsIds.length===0):c},[a]),l=i.filter(c=>c.itemsIds.length>0).length;return e.jsxs(y,{direction:"vertical",children:[e.jsxs(h.Title,{level:5,children:["Total Movies: ",i.length," | Complete Movies: ",l]}),e.jsx(N,{addEntryToUpdate:s,rows:i})]})}function ne({data:t,addEntryToUpdate:s}){const[r,a]=x.useState(null),i=x.useMemo(()=>r?t[r]:null,[r,t]);return e.jsxs(y,{direction:"vertical",children:[e.jsx(h.Title,{level:5,children:"Search Movie"}),e.jsx(z,{data:t,onFinish:l=>a(l),parser:ae,placeholder:"Search movie by title...",style:{width:"100%",minWidth:450}}),!!i&&e.jsx(N,{addEntryToUpdate:s,rows:[i]})]})}const ae=t=>Object.values(t??{}).reduce((s,r)=>(s[`${r.title} (${r.year})`]=r.id,s),{});function le({data:t,save:s,isDirty:r,isSaving:a,entriesToUpdate:i,hasFirestoreData:l,addEntryToUpdate:c}){const{is:m,addParam:n}=C();return e.jsxs(U,{children:[e.jsxs(u,{gap:12,vertical:!0,children:[e.jsx(V,{dirt:JSON.stringify(i),isDirty:r,isSaving:a,onSave:s}),e.jsx(Z,{block:!0,data:()=>ce(t),disabled:r,fileName:"daily-movie-sets.json",hasNewData:l})]}),e.jsx(M,{}),e.jsx(q,{label:"Pending Only",onChange:o=>n("emptyOnly",o,!1),value:m("emptyOnly")}),e.jsx(me,{addEntryToUpdate:c,data:t})]})}function ce(t){return H(t)}function me({data:t,addEntryToUpdate:s}){const{message:r}=F.useApp(),a=I(),i=()=>{const l=Q(Object.keys(t),"dms","pt","-",1),c="[New Movie Set]";s(l,{id:l,title:c,itemsIds:[],year:new Date().getFullYear()}),r.success(`New Movie Set created, search for ${c} to find it easily.`),a(c)};return e.jsx(g,{block:!0,onClick:i,variant:"dashed",children:"Add New Movie Set"})}const b=30;function de({data:t,addEntryToUpdate:s}){const[r,a]=x.useState(null),i=v("items"),l=I(),c=()=>{let o=p.sample(Object.keys(t??{})),d=0;for(;d<b&&(t[String(o)]?.itemsIds??[]).length>0;)o=p.sample(Object.keys(t??{})),d++;if(d>=b)return console.warn("Could not find a sample with no itemsIds");a(o??null)},m=[{title:"Title",dataIndex:"title",render:(o,d)=>e.jsx(j,{addEntryToUpdate:s,movie:d,property:"title",value:o})},{title:"Year",dataIndex:"year",render:(o,d)=>e.jsx(j,{addEntryToUpdate:s,movie:d,property:"year",value:o})},f.EXPAND_COLUMN,{title:"Items",dataIndex:"itemsIds",key:"itemsIds",render:(o,d)=>e.jsx(L,{addEntryToUpdate:s,copyToClipboard:l,itemsIds:o,movie:d})},{title:"Count",dataIndex:"itemsIds",render:o=>T(o).filter(Boolean).length}],n=P({maxExpandedRows:1,expandedRowRender:o=>e.jsx(D,{addEntryToUpdate:s,movie:o}),rowExpandable:()=>i.isSuccess});return e.jsxs(y,{className:"my-4",direction:"vertical",children:[e.jsx(g,{onClick:c,children:"Get Random Movie"}),r&&e.jsx(f,{columns:m,dataSource:[t[r]],expandable:n,pagination:!1,rowKey:"id"},String(r))]})}function Ue(){const t=ee({tdrResourceName:"daily-movie-sets",firestoreDataCollectionName:"movieSets"});return e.jsx(O,{subtitle:"Movie Sets",title:"Items",children:e.jsxs(w,{hasSider:!0,children:[e.jsx(k,{children:e.jsx(le,{...t})}),e.jsx(w.Content,{className:"content",children:e.jsx(E,{error:t.error,hasResponseData:!p.isEmpty(t.data),isLoading:t.isLoading,children:e.jsxs(y,{direction:"vertical",children:[e.jsx(ne,{...t}),e.jsx(de,{...t}),e.jsx(oe,{...t})]})})})]})})}export{Ue as ItemsMovieSets,Ue as default};
