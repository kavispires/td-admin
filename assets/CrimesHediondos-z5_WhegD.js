import{r as f,a as V,_ as U,j as e,B as h,ab as H,aa as K,T as w,G,a9 as L,Q as q,D as X,P as Y,L as z}from"./index-DXe0NKsU.js";import{u as $}from"./useQueryParams-BB0m4ZDO.js";import{l as g}from"./lodash-Bc7mGals.js";import{D as C}from"./EditableFields-B4ONBM0Q.js";import{C as _}from"./CopyToClipboardButton-BhBLz315.js";import{u as J}from"./useCopyToClipboardFunction-CyDVxbhs.js";import{u as D}from"./useTableExpandableRows-kFv7vw9W.js";import{u as O}from"./useTablePagination-Bnw1q8mY.js";import{r as A,a as Z}from"./index-CWkijkUk.js";import{S as I}from"./index-BZS9rDXb.js";import{F as R}from"./index-Cn-6dNGh.js";import{S as x}from"./index-l1pNpeva.js";import{T as v}from"./index-1eaCyCpZ.js";import{c as M,P as Q}from"./useBaseUrl-Dr2gnGsV.js";import{I as ee}from"./Item-B1xaxzrh.js";import{F as S}from"./Table-CWfbJPvq.js";import{I as te}from"./index-DwmjLRpU.js";import{u as W}from"./useToggle-D2MnAcKw.js";import{M as ae}from"./index-BggsdaKy.js";import{F as se,c as ne}from"./FilterEntries-8ZA2M-0j.js";import{S as oe}from"./SiderContent-BizzpyAp.js";import{D as b}from"./DownloadButton-nV1Vp6mp.js";import{S as E}from"./SaveButton-Cw7uDWF-.js";import{R as ie}from"./SkinOutlined-CIhGw36i.js";import{R as re}from"./EnvironmentOutlined-BSOgFUU4.js";import{D as le}from"./DataLoadingWrapper-BMUHkU-9.js";import{u as k}from"./useResourceFirebaseData-aRQIM0Ql.js";import{u as ce}from"./useTDResource-Bm2ZR31e.js";import"./LanguageFlag-CtBtyZW_.js";import"./index-DB9PR9p3.js";import"./FireFilled-JlkZQmER.js";import"./IdcardOutlined-CR4Cavgt.js";import"./constants-DMa2HerV.js";import"./gapSize-U1swVQyS.js";import"./index-ChXZMZkL.js";import"./index-Dhr8lByo.js";import"./index-BN_TL9kb.js";import"./scrollTo-pEWCRynY.js";import"./Pagination-DdoKsGBK.js";import"./extendsObject-keMuGWqj.js";import"./Input-BjY3wOcJ.js";import"./index-CywTZjU_.js";import"./moment-C5S46NFB.js";import"./SaveOutlined-BooZ0pum.js";import"./useGetFirebaseDoc-ahwYGaLK.js";import"./useUpdateFirebaseDoc-v5WYF7hf.js";import"./useMutation-BxXxI-Rq.js";var de={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M938 458.8l-29.6-312.6c-1.5-16.2-14.4-29-30.6-30.6L565.2 86h-.4c-3.2 0-5.7 1-7.6 2.9L88.9 557.2a9.96 9.96 0 000 14.1l363.8 363.8c1.9 1.9 4.4 2.9 7.1 2.9s5.2-1 7.1-2.9l468.3-468.3c2-2.1 3-5 2.8-8zM459.7 834.7L189.3 564.3 589 164.6 836 188l23.4 247-399.7 399.7zM680 256c-48.5 0-88 39.5-88 88s39.5 88 88 88 88-39.5 88-88-39.5-88-88-88zm0 120c-17.7 0-32-14.3-32-32s14.3-32 32-32 32 14.3 32 32-14.3 32-32 32z"}}]},name:"tag",theme:"outlined"},me=function(o,n){return f.createElement(V,U({},o,{ref:n,icon:de}))},pe=f.forwardRef(me);function ue({allTags:a,onSelect:o}){return e.jsx(I,{showSearch:!0,mode:"tags",placeholder:"Add new tag",options:a,style:{width:"200px"},autoClearSearchValue:!0,maxCount:1,onSelect:o,allowClear:!0,defaultActiveFirstOption:!1,size:"small"})}function ge({onSelect:a}){const[o,n]=f.useState([]),i=()=>{a(o.map(c=>c.trim().toLowerCase())),n([])};return e.jsxs(R,{gap:6,children:[e.jsx(I,{showSearch:!0,mode:"tags",placeholder:"Add new tag",options:[],style:{width:"200px"},autoClearSearchValue:!0,allowClear:!0,value:o,onChange:n,tokenSeparators:[","],onClear:()=>n([]),defaultActiveFirstOption:!1,size:"small"}),e.jsx(h,{onClick:i,disabled:o.length===0,children:"Add"})]})}function B({card:a,allTags:o,onUpdateCard:n}){const i=r=>{var p,u;const l=g.cloneDeep(a);(p=l.tags)!=null&&p.includes(r)?l.tags=(u=l.tags)==null?void 0:u.filter(t=>t!==r):l.tags=A([...l.tags??[],r]).sort(),n(l)},c=r=>{const l=g.cloneDeep(a);l.tags=A([...l.tags??[],...r]).sort(),n(l)};return e.jsxs(x,{wrap:!0,children:[e.jsxs(x,{size:"small",children:["New tag:",e.jsx(ue,{allTags:o,onSelect:i})]}),e.jsxs(x,{size:"small",children:["All multiple tags:",e.jsx(ge,{allTags:o,onSelect:c})]}),e.jsx("ul",{className:"all-tags",children:o.map(({value:r,count:l})=>{var p;return e.jsxs(v,{color:(p=a.tags)!=null&&p.includes(r)?"yellow":void 0,className:"all-tags__tag",onClick:()=>i(r),children:[r," (",l,")"]},`all-tags-${r}`)})})]})}function T({item:a,cardWidth:o,activeColor:n,isSelected:i=!1,className:c=""}){return a.itemId?e.jsxs("div",{className:M("crime-item-card",i&&"crime-item-card--selected",c),style:n&&i?{borderColor:"black",backgroundColor:n}:{},children:[e.jsx(H,{content:e.jsxs(e.Fragment,{children:[a.name.pt," | ",a.name.en]}),children:e.jsx(v,{className:"crime-item-card__name",color:a.type==="weapon"?"geekblue":"volcano",style:{maxWidth:`${o}px`},children:e.jsx("span",{children:a.name.en})})}),e.jsx("div",{className:M("crime-item-card__item-container",`crime-item-card__item-container--${a.type}`),children:e.jsx(ee,{id:a.itemId,width:o*.85,className:"crime-item-card__item"})})]}):e.jsx(e.Fragment,{children:a.id})}function xe({rows:a,allTags:o,onUpdateCard:n}){const i=J(),c=O({total:a.length,showQuickJumper:!0}),r=(t,s,d)=>{const m=g.cloneDeep(d);m.name[s]=t,n(m)},l=[{title:"Id",dataIndex:"id",key:"id",render:t=>e.jsxs("span",{children:[t,e.jsx(_,{content:t})]}),sorter:(t,s)=>t.id.localeCompare(s.id)},{title:"Card",dataIndex:"itemId",key:"itemId",render:(t,s)=>e.jsxs("div",{children:[e.jsx(T,{item:s,cardWidth:70}),e.jsx(te,{defaultValue:s.itemId,size:"small",onBlur:d=>{var m,j,y,P;if(console.log((m=d==null?void 0:d.target)==null?void 0:m.value),console.log("onBlur"),(j=d==null?void 0:d.target)!=null&&j.value&&((y=d==null?void 0:d.target)==null?void 0:y.value)!==s.itemId){const F=g.cloneDeep(s);F.itemId=(P=d==null?void 0:d.target)==null?void 0:P.value,n(F)}}})]})},{title:"Name",dataIndex:"name",key:"name",sorter:(t,s)=>t.name.en.localeCompare(s.name.en),render:(t,s)=>e.jsxs(x,{direction:"vertical",style:{minWidth:150},children:[e.jsx(C,{value:t,language:"en",onPressEnter:d=>{var m;return r(((m=d.target)==null?void 0:m.value)||s.name.en,"en",s)}}),e.jsx(C,{value:t,language:"pt",onPressEnter:d=>{var m;return r(((m=d.target)==null?void 0:m.value)||s.name.pt,"pt",s)}})]})},{title:"Type",dataIndex:"type",key:"type",render:t=>e.jsx("span",{children:t}),sorter:(t,s)=>t.type.localeCompare(s.type)},S.EXPAND_COLUMN,{title:"Tags",dataIndex:"tags",key:"tags",render:t=>e.jsx(x,{size:"small",wrap:!0,children:t.map(s=>e.jsx(v,{children:s},s))})},{title:"Verify",dataIndex:"tags",key:"verify",render:t=>t.length>2?e.jsx(K,{}):""}],p=D({maxExpandedRows:1,expandedRowRender:t=>e.jsx(B,{card:t,allTags:o,onUpdateCard:n})}),u=()=>{if(c){const{current:t=1,pageSize:s=10}=c,d=a.slice((t-1)*s,t*s),m=[];d.forEach((j,y)=>{m.push(`${y+1}) ${j.name.en} - Current tags: ${(j.tags??[]).join(", ")}`)}),console.log(m),i(m.join(`
`))}};return e.jsxs("div",{className:"my-4",children:[e.jsxs(x,{className:"mb-4",children:[e.jsx(h,{onClick:()=>{i(o.map(t=>t.value).join(", "))},children:"Copy AllTags"}),e.jsx(h,{onClick:u,children:"Copy Page Cards"})]}),e.jsx(S,{columns:l,dataSource:a,rowKey:"id",expandable:p,pagination:c})]})}function he({sceneQuery:a,allTags:o,objects:n}){const i=J(),c=Object.values(a.data??[]),r=O({total:c.length,showQuickJumper:!0}),l=t=>{const s=[];s.push(`"${t.description.en}"`),t.values.forEach((d,m)=>{s.push(`${m}) ${d.en}`)}),i(s.join(`
`))},p=[{title:"Id",dataIndex:"id",key:"id",render:t=>e.jsxs("span",{children:[t,e.jsx(_,{content:t})]}),sorter:(t,s)=>t.id.localeCompare(s.id)},{title:"Title",dataIndex:"title",key:"title",render:(t,s)=>e.jsxs(x,{direction:"vertical",style:{minWidth:150},children:[e.jsx(C,{value:s.title,language:"en",readOnly:!0}),e.jsx(C,{value:s.title,language:"pt",readOnly:!0})]})},{title:"Type",dataIndex:"type",key:"type",render:t=>e.jsx("span",{children:t}),sorter:(t,s)=>t.type.localeCompare(s.type)},S.EXPAND_COLUMN,{title:"Options",dataIndex:"values",key:"tags",render:(t,s)=>e.jsxs(e.Fragment,{children:[e.jsx(h,{onClick:()=>l(s),children:"Copy options"}),e.jsx("ul",{children:t.map((d,m)=>{var j,y;return e.jsxs("li",{children:[e.jsxs(w,{children:[d.en," / ",d.pt," ",e.jsx(v,{children:((y=(j=s.tags)==null?void 0:j[m])==null?void 0:y.length)??0})]}),e.jsx(je,{scene:s,valueIndex:m,addEntryToUpdate:a.addEntryToUpdate})]},d.en)})})]})}],u=D({maxExpandedRows:1,expandedRowRender:t=>e.jsx(fe,{scene:t,objects:n})});return e.jsxs("div",{className:"my-4",children:[e.jsx(w.Title,{level:2,className:"my-0",children:"Scenes"}),e.jsx(x,{className:"mb-4",children:e.jsx(h,{onClick:()=>{i(o.map(t=>t.value).join(", "))},children:"Copy AllTags"})}),e.jsx(S,{columns:p,dataSource:c,rowKey:"id",expandable:u,pagination:r})]})}function je({scene:a,valueIndex:o,addEntryToUpdate:n}){var t,s,d;const[i,c]=W(!1),[r,l]=f.useState([]),p=((t=a==null?void 0:a.tags)==null?void 0:t[o])??[],u=()=>{const m=g.cloneDeep(a);m.tags=m.tags??{},m.tags[o]=[...r.filter(Boolean)],console.log(m.tags),n(m.id,m),l([]),c()};return i?e.jsx(e.Fragment,{children:e.jsxs(R,{gap:6,align:"center",children:[e.jsx(I,{showSearch:!0,mode:"tags",placeholder:"Add new tag",options:[],style:{minWidth:"200px",maxWidth:"600px"},autoClearSearchValue:!0,allowClear:!0,defaultValue:p,onChange:l,tokenSeparators:[","],onClear:()=>l([]),defaultActiveFirstOption:!1,size:"small"}),e.jsx(h,{onClick:u,disabled:r.length===0,children:"Add"}),e.jsx(h,{onClick:c,icon:e.jsx(G,{}),shape:"circle",size:"small",type:"text"})]})}):e.jsxs(e.Fragment,{children:[(d=(s=a==null?void 0:a.tags)==null?void 0:s[o])==null?void 0:d.map(m=>e.jsx(v,{color:"green",children:m},m)),e.jsx(h,{shape:"circle",size:"small",onClick:c,icon:e.jsx(L,{})})]})}function fe({scene:a,objects:o}){const{message:n}=q.useApp(),[i,c]=f.useState(null),r=()=>{const l=g.sample(o);if(!l){n.error("No objects to sample from");return}const p=ye(a,l);c({entry:l,likelihood:p})};return e.jsxs("div",{className:"full-width",children:[e.jsx(h,{onClick:r,children:"Sample"}),e.jsxs("div",{className:"scene-options-sampler mt-4",children:[i&&e.jsx(T,{item:i.entry,cardWidth:70}),a.values.map((l,p)=>{const u=(i==null?void 0:i.likelihood[p])??0;let t=u>50?"cyan":u>25?"orange":"red";const s=Math.max(...Object.values((i==null?void 0:i.likelihood)??{}));return t=u===s?"green":t,e.jsxs(x,{direction:"vertical",children:[e.jsxs(w.Text,{children:[l.en," / ",l.pt]}),e.jsxs(v,{color:u===0?void 0:t,children:[u,"%"]})]},l.en)})]})]})}const ye=(a,o)=>{const n={},i={};return console.log("========="),(o.tags??[]).forEach(c=>{i[c]=0,Object.keys(a.tags??{}).forEach(r=>{var p;(((p=a.tags)==null?void 0:p[r])??[]).includes(c)&&(i[c]=i[c]+1)})}),console.log(JSON.parse(JSON.stringify(i))),Object.keys(i).forEach(c=>{const r=Math.max(0,1-i[c]*.1);i[c]=r}),console.log(JSON.parse(JSON.stringify(i))),(o.tags??[]).forEach(c=>{Object.keys(a.tags??{}).forEach(r=>{var p;(((p=a.tags)==null?void 0:p[r])??[]).includes(c)&&(n[r]=(n[r]??0)+i[c])})}),console.log(JSON.parse(JSON.stringify(n))),Object.keys(n).forEach(c=>{var r;n[c]=Math.floor(Math.min(100,(n[c]??0)/(((r=o.tags)==null?void 0:r.length)??1)*100))}),console.log(JSON.parse(JSON.stringify(n))),n};function Ce({allTags:a,onUpdateCard:o,card:n,buttonProps:i}){const[c,r]=W(!1),l=(p,u,t)=>{const s=g.cloneDeep(t);s.name[u]=p,o(s)};return console.log("EditCrimeCardModal",n),e.jsxs("div",{children:[e.jsx(h,{...i,onClick:r,size:"small",icon:e.jsx(L,{}),style:{minWidth:100},children:"Edit"}),e.jsx(ae,{title:`Editing ${n.id} (${n.name.en})`,open:c,onOk:()=>r(!1),onCancel:r,width:1e3,children:c&&e.jsxs(x,{children:[e.jsxs(x,{direction:"vertical",style:{minWidth:150},children:[e.jsx(T,{item:n,cardWidth:100}),e.jsx(C,{value:n.name,language:"en",onPressEnter:p=>{var u;return l(((u=p.target)==null?void 0:u.value)||n.name.en,"en",n)}}),e.jsx(C,{value:n.name,language:"pt",onPressEnter:p=>{var u;return l(((u=p.target)==null?void 0:u.value)||n.name.pt,"pt",n)}})]}),e.jsx(B,{allTags:a,onUpdateCard:o,card:n})]})})]})}function ve({rows:a,weapons:o,evidence:n,onUpdateCard:i,allTags:c}){const r=f.useMemo(()=>{const t={};return a.forEach(s=>{var d;(d=s.tags)==null||d.forEach(m=>{t[m]||(t[m]={id:m,tag:m,count:0,cardsIds:[]}),t[m].count++,t[m].cardsIds.push(s.id)})}),g.orderBy(Object.values(t),["tag"],["asc"])},[a]),l=O({total:r.length,showQuickJumper:!0}),p=D({maxExpandedRows:1,expandRowByClick:!0,expandedRowRender:t=>e.jsx(x,{size:"small",wrap:!0,children:t.cardsIds.map(s=>{const d=o[s]??n[s];return e.jsxs(x,{direction:"vertical",align:"center",children:[e.jsx(T,{item:d,cardWidth:75}),e.jsx(Ce,{allTags:c,onUpdateCard:i,card:d})]},s)})})}),u=[{title:"Id",dataIndex:"id",key:"id",render:t=>e.jsx("span",{children:t}),sorter:(t,s)=>t.id.localeCompare(s.id)},{title:"Tag",dataIndex:"tag",key:"tag",render:t=>e.jsx("span",{children:t}),sorter:(t,s)=>t.tag.localeCompare(s.tag)},{title:"Count",dataIndex:"count",key:"count",render:t=>e.jsx("span",{children:t}),sorter:(t,s)=>t.count-s.count}];return e.jsx("div",{className:"my-4",children:e.jsx(S,{columns:u,dataSource:r,rowKey:"id",expandable:p,pagination:l})})}function Se({weaponsQuery:a,evidenceQuery:o,scenesQuery:n}){const{is:i,queryParams:c}=$(),r=f.useMemo(()=>[...Object.values(a.data),...Object.values(o.data)],[a.data,o.data]),l=f.useMemo(()=>{const u={};return r.forEach(t=>{var s;(s=t.tags)==null||s.forEach(d=>{u[d]=(u[d]??0)+1})}),g.orderBy(Object.entries(u).map(([t,s])=>({value:t,label:t,count:s})),["value"],["asc"])},[r]),p=u=>{if(u.type==="weapon")a.addEntryToUpdate(u.id,u);else if(u.type==="evidence")o.addEntryToUpdate(u.id,u);else throw new Error("Invalid card type")};return e.jsxs(e.Fragment,{children:[(i("display","cards")||!c.has("display"))&&e.jsx(xe,{rows:r,allTags:l,onUpdateCard:p}),i("display","tags")&&e.jsx(ve,{rows:r,weapons:a.data,evidence:o.data,onUpdateCard:p,allTags:l}),i("display","scenes")&&e.jsx(he,{sceneQuery:n,allTags:l,objects:r})]})}function Te({weaponsQuery:a,evidenceQuery:o,scenesQuery:n}){const{queryParams:i,addParam:c,addParams:r,is:l}=$();return e.jsxs(oe,{children:[e.jsxs(R,{vertical:!0,gap:12,children:[e.jsx("span",{children:"Weapons"}),e.jsx(E,{isDirty:a.isDirty,onSave:a.save,isSaving:a.isSaving,dirt:JSON.stringify(a.entriesToUpdate)}),e.jsx(b,{data:()=>N(a.data),fileName:"crime-weapons.json",disabled:a.isDirty,block:!0}),e.jsx("span",{children:"Evidence"}),e.jsx(E,{isDirty:o.isDirty,onSave:o.save,isSaving:o.isSaving,dirt:JSON.stringify(o.entriesToUpdate)}),e.jsx(b,{data:()=>N(o.data),fileName:"crime-evidence.json",disabled:o.isDirty,block:!0}),e.jsx("span",{children:"Scenes"}),e.jsx(E,{isDirty:n.isDirty,onSave:n.save,isSaving:n.isSaving,dirt:JSON.stringify(n.entriesToUpdate)}),e.jsx(b,{data:()=>N(n.data),fileName:"crime-scenes.json",disabled:n.isDirty,block:!0})]}),e.jsx(X,{}),e.jsx(se,{label:"Display",value:i.get("display")??"listing",onChange:p=>r({display:p,page:1},{page:1}),options:[{title:"Cards",icon:e.jsx(ie,{}),value:"cards"},{title:"Tags",icon:e.jsx(pe,{}),value:"tags"},{title:"Scenes",icon:e.jsx(re,{}),value:"scenes"}]}),l("display","item")&&e.jsx(ne,{label:"No Groups Only",value:l("emptyOnly"),onChange:p=>c("emptyOnly",p,!1)})]})}function N(a){console.log("Preparing file for download...");const o=g.cloneDeep(a);return Z(o)}function jt(){const a=k({tdrResourceName:"crime-weapons",firebaseDataCollectionName:"crimeWeapons",serialize:!0}),o=k({tdrResourceName:"crime-evidence",firebaseDataCollectionName:"crimeEvidence",serialize:!0}),n=k({tdrResourceName:"crime-scenes",firebaseDataCollectionName:"crimeScenes",serialize:!0}),i=ce("items");return e.jsx(Y,{title:"Crimes Hediondos",subtitle:"Categorizer",children:e.jsxs(z,{hasSider:!0,children:[e.jsx(Q,{children:e.jsx(Te,{weaponsQuery:a,evidenceQuery:o,scenesQuery:n})}),e.jsx(z.Content,{className:"content",children:e.jsx(le,{isLoading:a.isLoading||o.isLoading||n.isLoading||i.isLoading,error:a.error||o.error||n.error||i.error,hasResponseData:!g.isEmpty(a.data)&&!g.isEmpty(o.data)&&!g.isEmpty(n.data)&&!g.isEmpty(i.data),children:e.jsx(Se,{weaponsQuery:a,evidenceQuery:o,scenesQuery:n})})})]})})}export{jt as default};
