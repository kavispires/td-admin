import{r as y,$ as A,j as e,B as M,T as b,D as W,P as Q,L as O}from"./index-CD2lQx4f.js";import{D as z}from"./DataLoadingWrapper-BVfG3l-0.js";import{F as q,c as U}from"./FilterEntries-Bs0G3S2r.js";import{S as J}from"./SiderContent-t1h7BugK.js";import{D as K}from"./DownloadButton-BOgfzdWt.js";import{S as _}from"./SaveButton-BseHkRpP.js";import{u as T}from"./useQueryParams-CF8Hi25q.js";import{u as v}from"./useTDResource-idwmPnrO.js";import{l as g,P as V}from"./useBaseUrl-Bgww8MYZ.js";import{h as N,b as X,i as H,r as C,a as Y}from"./index-CLQIfBBa.js";import{L as P}from"./LanguageFlag-Qhm-pAz2.js";import{F as I,R as Z,C as ee}from"./index-BA8x64Vc.js";import{M as se}from"./index-XFHZ6HLo.js";import{I as D}from"./index-DiFhVfyK.js";import{F as w}from"./index-DKHdniSb.js";import{R as te}from"./ClusterOutlined-BQ25YGoV.js";import{R as re}from"./TableOutlined-CBOtnQUU.js";import{T as oe}from"./TransparentButton-DQfyphkw.js";import{D as G}from"./EditableFields-DyCMwdEY.js";import{I as ie}from"./Item-Bz0_XYJY.js";import{u as E}from"./useCopyToClipboardFunction-HXJCF-BI.js";import{u as ae}from"./useTableExpandableRows-BenSI3ku.js";import{u as ne}from"./useTablePagination-cfXPHmmI.js";import{C as le}from"./CopyIdsButton-CzUmucXc.js";import{I as me}from"./InspirationSample-BLN_-9x3.js";import{I as ce}from"./ItemsTypeahead-bUlFmiR1.js";import{I as de,b as k,d as pe}from"./ItemBuildingBlocks-Bx6L25JB.js";import{C as ue}from"./index-D747eGrK.js";import{S as F}from"./index-B96rb3bS.js";import{S as he}from"./index-DNGCIE4G.js";import{F as R}from"./Table-axzLO2_4.js";import{D as xe}from"./index-D1BQZejG.js";import{u as fe,P as je}from"./useGridPagination-BQQ6ZqM5.js";import{T as ye}from"./Typeahead-WF7Cboma.js";import{u as ge}from"./useResourceFirestoreData-Ckcka-iX.js";import"./index-C_ir9kit.js";import"./index-CTbYdUvi.js";import"./moment-C5S46NFB.js";import"./SaveOutlined-M2mo2AsX.js";import"./constants-DFs3AddX.js";import"./Input-CTphaWZv.js";import"./gapSize-U1swVQyS.js";import"./FireFilled-DfCiSQTM.js";import"./IdcardOutlined-aSK3dTi2.js";import"./index-D7bv13ez.js";import"./SyncOutlined-fYlQirXm.js";import"./PlusOutlined-C1HVgwg7.js";import"./useDebounce-CYjpp--u.js";import"./index-DtyFOrZD.js";import"./index-npxyzaEn.js";import"./index-iy7Kw0c8.js";import"./index-CZZ5P_rD.js";import"./scrollTo-CaqoTRmm.js";import"./Pagination-BJrOBp74.js";import"./extendsObject-keMuGWqj.js";import"./useGetFirestoreDoc-Dl3MhrIg.js";import"./useUpdateFirestoreDoc-DX3j66JU.js";import"./useMutation-DZuVovRz.js";function Ie({addEntryToUpdate:s,data:t}){const[o,c]=y.useState(!1),[n]=I.useForm(),{notification:m}=A.useApp(),d=r=>{const i=X(Object.keys(t));s(i,{id:i,name:{pt:r.nome,en:r.name},itemsIds:[],keywords:r.keywords}),m.success({message:"Group added successfully"}),c(!1),n.resetFields()},u=I.useWatch("name",n),f=I.useWatch("nome",n),p=y.useMemo(()=>{const r={};if(u&&u.length>2){const l=Object.entries(t).reduce((x,[S,a])=>{const h=N.compareTwoStrings(a.name.en,u),j=N.compareTwoStrings(a.name.pt,f);return(h>.2||j>.2)&&(x[S]=Math.max(h,j)),x},{});Object.keys(l).forEach(x=>{r[x]=l[x]})}return Object.keys(r)},[u,f,t]);return e.jsxs(e.Fragment,{children:[e.jsx(M,{block:!0,className:"mb-4",onClick:()=>c(!0),type:"dashed",children:"Add New Group"}),e.jsxs(se,{maskClosable:!1,okButtonProps:{htmlType:"submit"},okText:"Add",onCancel:()=>c(!1),onOk:n.submit,open:o,title:"Add New Set",children:[e.jsxs(I,{form:n,onFinish:d,children:[e.jsx(I.Item,{label:"Nome",name:"nome",rules:[{required:!0}],children:e.jsx(D,{placeholder:"Name in pt",prefix:e.jsx(P,{language:"pt",width:"1em"}),size:"small"})}),e.jsx(I.Item,{label:"Name",name:"name",rules:[{required:!0}],children:e.jsx(D,{placeholder:"Name in en",prefix:e.jsx(P,{language:"en",width:"1em"}),size:"small"})})]}),e.jsx(b.Text,{children:"Similar:"}),e.jsx("ul",{children:p.map(r=>{var i,l;return e.jsxs("li",{children:[r," - ",(i=t[r])==null?void 0:i.name.en," / ",(l=t[r])==null?void 0:l.name.pt]},r)})})]})]})}function be({data:s,save:t,isDirty:o,isSaving:c,entriesToUpdate:n,addEntryToUpdate:m,hasFirestoreData:d}){const{queryParams:u,addParam:f,addParams:p,is:r}=T(),i=v("items");return e.jsxs(J,{children:[e.jsxs(w,{gap:12,vertical:!0,children:[e.jsx(_,{dirt:JSON.stringify(L(n)),isDirty:o,isSaving:c,onSave:t}),e.jsx(K,{block:!0,data:()=>Se(s,i.data),disabled:o||g.isEmpty(i.data),fileName:"items-groups.json",hasNewData:d})]}),e.jsx(W,{}),e.jsx(q,{label:"Display",onChange:l=>p({display:l,page:1},{page:1}),options:[{title:"By Groups",icon:e.jsx(te,{}),value:"group"},{title:"By Items",icon:e.jsx(re,{}),value:"item"}],value:u.get("display")??"group"}),e.jsx(Ie,{addEntryToUpdate:m,data:s}),r("display","item")&&e.jsx(U,{label:"No Groups Only",onChange:l=>f("emptyOnly",l,!1),value:r("emptyOnly")})]})}function L(s){return g.omitBy(g.cloneDeep(s),t=>g.isEmpty(t.itemsIds))}function Se(s,t){return Object.keys(s).forEach(o=>{s[o].itemsIds=H(C(s[o].itemsIds));const c=s[o].itemsIds.length,n=s[o].itemsIds.filter(m=>t[m].nsfw).length;n>c*.3&&(s[o].nsfw=!0,console.log(`ðŸ˜ˆ Group ${s[o].name.pt} has ${n} (${Math.round(n/c*100)}%) NSFW items`))}),Y(L(s))}function we({group:s,onUpdateGroupItems:t}){const o=c=>{t(s.id,[...s.itemsIds,c])};return e.jsxs("div",{children:[e.jsx(ce,{onFinish:o}),e.jsx(me,{excludeList:s.itemsIds,initialQuantity:0,onSelect:o})]})}const Ce=["8bc4f","96efa","c10eb","16ec3","2a97f","4bba8","565ed","5fb57","62a8b"];function B({item:s,itemGroups:t,groupsTypeahead:o,onUpdateItemGroups:c}){const n=E();return e.jsxs(ue,{style:{maxWidth:250,...ve(t)},title:e.jsxs(e.Fragment,{children:[e.jsx(b.Text,{onClick:()=>n(s.id),children:s.id}),e.jsx(pe,{item:s})]}),children:[e.jsx(de,{item:s,width:75}),e.jsxs(F,{className:"my-4",direction:"vertical",size:"small",children:[e.jsx(k,{item:s,language:"en"}),e.jsx(k,{item:s,language:"pt"}),e.jsx(he,{defaultValue:t,filterOption:(m,d)=>!!(d!=null&&d.label.toLowerCase().includes(m.toLowerCase())),mode:"multiple",onChange:m=>c(s.id,m),options:o,placeholder:"Select a group",size:"small",style:{width:"100%"}},String(t))]})]})}const ve=s=>!s||(s==null?void 0:s.length)===0?{borderColor:"orange"}:s!=null&&s.every(t=>Ce.includes(t))?{borderColor:"red"}:{};function $({rows:s,items:t,grousByItem:o,groupsTypeahead:c,onUpdateItemGroups:n,onUpdateGroupItems:m,onUpdateName:d}){const u=E(),f=v("items"),[p,r]=y.useState(null),i=ne({showQuickJumper:!0,total:s.length}),l=[{title:"id",dataIndex:"id",key:"id",render:a=>e.jsx("span",{children:a})},{title:"Name",dataIndex:"name",key:"name",render:(a,h)=>e.jsxs(w,{gap:4,vertical:!0,children:[e.jsx(G,{language:"en",onChange:j=>d(j.target.value,"en",h.id),style:{minWidth:150},value:a}),e.jsx(G,{language:"pt",onChange:j=>d(j.target.value,"pt",h.id),style:{minWidth:150},value:a})]})},{title:"Items",dataIndex:"itemsIds",key:"itemsIds",render:(a,h)=>e.jsx(w,{gap:6,wrap:"wrap",children:a.map(j=>e.jsxs(w,{gap:2,vertical:!0,children:[e.jsx(oe,{onClick:()=>r(j),children:e.jsx(ie,{id:j,width:60})}),e.jsx(w,{justify:"center",children:e.jsx(b.Text,{onClick:()=>u(j),children:j})})]},`${h.id}-${j}`))},`items-${h.id}`)},R.EXPAND_COLUMN,{title:"Count",dataIndex:"itemsIds",key:"count",render:a=>C(a).filter(Boolean).length},{title:"Actions",dataIndex:"itemsIds",key:"actions",render:a=>e.jsx(le,{ids:a})}],x=p?t[p]:null,S=ae({maxExpandedRows:1,expandedRowRender:a=>e.jsx(we,{group:a,onUpdateGroupItems:m}),rowExpandable:()=>f.isSuccess});return e.jsxs(e.Fragment,{children:[e.jsx(R,{className:"my-4",columns:l,dataSource:s,expandable:S,pagination:i,rowKey:"id"}),e.jsx(xe,{onClose:()=>r(null),open:!!x,title:"Edit Item Group",children:x&&e.jsx(B,{groupsTypeahead:c,item:x,itemGroups:o[x.id],onUpdateItemGroups:n})})]})}function Te({items:s,grousByItem:t,groupsTypeahead:o,onUpdateItemGroups:c}){const{is:n}=T(),m=n("emptyOnly"),d=y.useMemo(()=>m?Object.values(s).filter(p=>!t[p.id]):Object.values(s),[s,t,m]),{page:u,pagination:f}=fe({data:d});return e.jsxs(e.Fragment,{children:[e.jsxs(b.Title,{level:2,children:["Groups by Items (",d.length,")"]}),e.jsx(je,{pagination:f,children:e.jsx(Z,{className:"my-4",gutter:[16,16],children:u.map(p=>e.jsx(ee,{lg:6,md:12,sm:24,xl:4,xs:24,children:e.jsx(B,{groupsTypeahead:o,item:p,itemGroups:t[p.id],onUpdateItemGroups:c})},p.id))})})]})}function Fe({data:s,items:t,grousByItem:o,groupsTypeahead:c,onUpdateItemGroups:n,onUpdateGroupItems:m,onUpdateName:d}){const[u,f]=y.useState(null),p=y.useMemo(()=>u?s[u]:null,[u,s]);return e.jsxs(F,{direction:"vertical",children:[e.jsx(b.Title,{level:5,children:"Search Groups"}),e.jsx(ye,{data:s,onFinish:r=>f(r),parser:Oe,placeholder:"Search group by name...",style:{width:"100%",minWidth:450}}),!!p&&e.jsx($,{groupsTypeahead:c,grousByItem:o,items:t,onUpdateGroupItems:m,onUpdateItemGroups:n,onUpdateName:d,rows:[p]})]})}const Oe=s=>Object.values(s??{}).reduce((t,o)=>(t[`${o.name.en}`]=o.id,t[`${o.name.pt}`]=o.id,t),{});function Ne({data:s,addEntryToUpdate:t}){const{is:o,queryParams:c}=T(),n=v("items"),m=y.useMemo(()=>Object.values(s??[]).reduce((r,i)=>(i.itemsIds||console.warn("Group without items",i),i.itemsIds.forEach(l=>{r[l]||(r[l]=[]),r[l].push(i.id)}),r),{}),[s]),d=y.useMemo(()=>g.orderBy(Object.values(s).flatMap(({id:r,name:i})=>[{label:`${i.en} [${r}]`,value:r}]),"label"),[s]),u=(r,i)=>{const l=m[r]??[],x=i.filter(a=>!l.includes(a)),S=l.filter(a=>!i.includes(a));x.forEach(a=>{const h=s[a];t(a,{...h,itemsIds:C([...(h==null?void 0:h.itemsIds)??[],r])})}),S.forEach(a=>{const h=s[a];t(a,{...h,itemsIds:C(h==null?void 0:h.itemsIds.filter(j=>j!==r))})})},f=(r,i)=>{const l=s[r];t(r,{...l,itemsIds:C(i)})},p=(r,i,l)=>{const x=s[l];t(l,{...x,name:{...x.name,[i]:r}})};return e.jsxs(e.Fragment,{children:[(o("display","group")||!c.has("display"))&&e.jsxs(F,{className:"mb-4",direction:"vertical",children:[e.jsx(Fe,{data:s,groupsTypeahead:d,grousByItem:m,items:n.data,onUpdateGroupItems:f,onUpdateItemGroups:u,onUpdateName:p}),e.jsxs(b.Title,{level:2,children:["Groups (",Object.keys(s).length,")"]}),e.jsx($,{groupsTypeahead:d,grousByItem:m,items:n.data,onUpdateGroupItems:f,onUpdateItemGroups:u,onUpdateName:p,rows:Object.values(s)})]}),o("display","item")&&e.jsx(Te,{groupsTypeahead:d,grousByItem:m,items:n.data,onUpdateGroupItems:f,onUpdateItemGroups:u,onUpdateName:p})]})}function Rs(){const s=ge({tdrResourceName:"items-groups",firestoreDataCollectionName:"itemsGroups",serialize:!0}),t=v("items");return e.jsx(Q,{subtitle:"Groups Sets",title:"Items",children:e.jsxs(O,{hasSider:!0,children:[e.jsx(V,{children:e.jsx(be,{...s})}),e.jsx(O.Content,{className:"content",children:e.jsx(z,{error:s.error||t.error,hasResponseData:!g.isEmpty(s.data)&&!g.isEmpty(t.data),isLoading:s.isLoading||t.isLoading,children:e.jsx(Ne,{...s})})})]})})}export{Rs as ItemsGroups,Rs as default};
