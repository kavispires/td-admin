import{r as j,a as z,_ as M,j as s,y as S,ag as V,T as B,B as P,Z as K,Y as J,P as W,L as A}from"./index-DyB2iw-j.js";import{D as Y}from"./DataLoadingWrapper-D1KQYaFp.js";import{P as U}from"./PageSider-BMJXEA3M.js";import{u as C}from"./useQueryParams-gR26FJF6.js";import{I as L}from"./ImageCard-EUvrFvV0.js";import{u as Q}from"./useTableExpandableRows-DUhvm4Ra.js";import{u as $}from"./useTablePagination-cOCQoTox.js";import{l as b}from"./useBaseUrl-Cs5WxjUA.js";import{S as R}from"./index-Cr4ra8mC.js";import{F as D}from"./Table-eqN-vA_f.js";import{F as v}from"./index-dctUwvzp.js";import{P as O}from"./progress-CbExdC1U.js";import{T as F}from"./index-DDOtrrfR.js";import{u as _}from"./useCardWidth-3UhqSkaM.js";import{S as G}from"./index-BfeWLvxY.js";import{R as Z}from"./FireFilled-CGbtzQD0.js";import{F as X}from"./FilterEntries-BY2wQHbS.js";import{S as k}from"./SiderContent-CUQL2V2J.js";import{D as ee}from"./DownloadButton-Dpxh4a8W.js";import{S as se}from"./SaveButton-CXHQbRmO.js";import{a as te,d as ne,e as re}from"./index-DG2D6Gd-.js";import{R as oe}from"./TableOutlined-CuP8dIqM.js";import{u as ae}from"./useGetFirestoreDoc-Bg0-FEOP.js";import{u as T}from"./useTDResource-kIzAJGU0.js";import{u as ie}from"./useUpdateFirestoreDoc-CFG_YL9w.js";import"./gapSize-U1swVQyS.js";import"./index-Jqe2Ntp6.js";import"./index-DU2Lz0OK.js";import"./index-HlkVMiZ-.js";import"./index-DkgBULiM.js";import"./scrollTo-BenQeJwt.js";import"./Pagination-DdfimYoz.js";import"./extendsObject-keMuGWqj.js";import"./Input-DGGpOnt9.js";import"./index-Cw_wg7U4.js";import"./index-Dwyhp9v4.js";import"./moment-C5S46NFB.js";import"./SaveOutlined-eOF_xzqD.js";import"./constants-B9jexr5Q.js";import"./Item-Dacs0AJJ.js";import"./useMutation-rka05zm_.js";var ce={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M594.3 601.5a111.8 111.8 0 0029.1-75.5c0-61.9-49.9-112-111.4-112s-111.4 50.1-111.4 112c0 29.1 11 55.5 29.1 75.5a158.09 158.09 0 00-74.6 126.1 8 8 0 008 8.4H407c4.2 0 7.6-3.3 7.9-7.5 3.8-50.6 46-90.5 97.2-90.5s93.4 40 97.2 90.5c.3 4.2 3.7 7.5 7.9 7.5H661a8 8 0 008-8.4c-2.8-53.3-32-99.7-74.7-126.1zM512 578c-28.5 0-51.7-23.3-51.7-52s23.2-52 51.7-52 51.7 23.3 51.7 52-23.2 52-51.7 52zm416-354H768v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H548v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H328v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H96c-17.7 0-32 14.3-32 32v576c0 17.7 14.3 32 32 32h832c17.7 0 32-14.3 32-32V256c0-17.7-14.3-32-32-32zm-40 568H136V296h120v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h148v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h148v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h120v496z"}}]},name:"contacts",theme:"outlined"},le={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M868 160h-92v-40c0-4.4-3.6-8-8-8H256c-4.4 0-8 3.6-8 8v40h-92a44 44 0 00-44 44v148c0 81.7 60 149.6 138.2 162C265.6 630.2 359 721.8 476 734.5v105.2H280c-17.7 0-32 14.3-32 32V904c0 4.4 3.6 8 8 8h512c4.4 0 8-3.6 8-8v-32.3c0-17.7-14.3-32-32-32H548V734.5C665 721.8 758.4 630.2 773.8 514 852 501.6 912 433.7 912 352V204a44 44 0 00-44-44zM248 439.6c-37.1-11.9-64-46.7-64-87.6V232h64v207.6zM840 352c0 41-26.9 75.8-64 87.6V232h64v120z"}}]},name:"trophy",theme:"filled"},de=function(u,d){return j.createElement(z,M({},u,{ref:d,icon:ce}))},ue=j.forwardRef(de),me=function(u,d){return j.createElement(z,M({},u,{ref:d,icon:le}))},pe=j.forwardRef(me);const H=(n,u)=>{const h=`us-gb-${n.split("-")[1]}`,m=u[n]??[];let a=0,o=0;m.forEach(y=>{y===3&&(a+=3),y===-3&&(o+=3)});const f=m.filter(y=>y!==3&&y!==-3),g=f.length+a+o,p=Math.max(g,5),c=m.filter(y=>y===1).length+a,i=Math.round(c/p*100),t=m.filter(y=>y===0).length+o,l=Math.round(t/p*100),x=Math.round((p-c-t)/p*100),w=f.length+a+o>=5,N=g>3,E=g>4,q=E?i>l?"👍":"👎":null,I=N?i>=55?"👍":l>=55?"👎":null:null;return{suspectCardId:n,imageId:h,enoughData:N,reliable:E,total:p,yesCount:c,yesPercentage:i,noCount:t,noPercentage:l,blankPercentage:x,complete:w,values:m,projection:I,result:q}};function he({suspect:n,answersPerQuestion:u,questions:d}){const h=j.useMemo(()=>b.orderBy(Object.keys(u).map(a=>{const o=d[a],{enoughData:f,reliable:g,yesPercentage:p,noPercentage:r,blankPercentage:c,values:i,total:e}=H(n.id,{[n.id]:u[a]});return{id:a,question:o,enoughData:f,reliable:g,yesPercentage:p,noPercentage:r,blankPercentage:c,values:i,total:e}}),["reliable","enoughData","yesPercentage",a=>a.values.length],["desc","desc","desc","desc"]),[u,d,n.id]),m=[{key:"id",title:"Id",dataIndex:"id"},{key:"question",title:"Question",dataIndex:"question",render:a=>a.question},{key:"answer",title:"Answer",dataIndex:"id",sorter:(a,o)=>a.total-o.total,render:a=>{const o=h.find(f=>f.id===a);return o?s.jsxs(v,{gap:8,wrap:"nowrap",children:[s.jsx(S,{title:`Values: ${o.values.join(", ")}`,children:s.jsx(O,{percent:o.noPercentage+o.yesPercentage,size:o.enoughData?[100,20]:[100,10],status:o.enoughData?"exception":"active",success:{percent:o.yesPercentage},showInfo:!1})}),o.yesPercentage>=o.noPercentage?s.jsxs(F,{color:"green-inverse",children:[o.yesPercentage,"% Yes"]}):s.jsxs(F,{color:"red-inverse",children:[o.noPercentage,"% No"]})]}):""}}];return s.jsx(R,{wrap:!0,size:"large",children:s.jsx(D,{rowKey:"id",columns:m,dataSource:h,bordered:!0})})}function ge({isLoading:n,isSuccess:u,questions:d,data:h,suspects:m}){const a=j.useMemo(()=>Object.keys(h).reduce((r,c)=>{const i=h[c]??{};return Object.keys(i).forEach(e=>{r[e]||(r[e]={}),r[e][c]=i[e]}),r},{}),[h]),o=j.useMemo(()=>b.orderBy(Object.values(m).map(r=>({...r,answers:a[r.id]})),r=>Number(r.id.split("-")[1]),"asc"),[m,a]),f=$({total:o.length,showQuickJumper:!0}),g=[{title:"Id",dataIndex:"id",key:"id",sorter:(r,c)=>Number(r.id.split("-")[1])-Number(c.id.split("-")[1])},{title:"Picture",dataIndex:"id",render:r=>{const c=r.split("-").join("-gb-");return s.jsx(L,{id:c,width:48})}},{title:"Name",dataIndex:"name",key:"name",sorter:(r,c)=>r.name.pt.localeCompare(c.name.pt),render:r=>r.pt},{title:"Questions Answered",dataIndex:"answers",key:"answers",sorter:(r,c)=>Object.keys(r.answers).length-Object.keys(c.answers).length,render:r=>r?Object.values(r).length:""}],p=Q({maxExpandedRows:1,expandedRowRender:r=>s.jsx(he,{suspect:r,answersPerQuestion:a[r.id],questions:d}),rowExpandable:()=>u});return s.jsx(D,{columns:g,dataSource:o,pagination:f,rowKey:"id",expandable:p,loading:n,bordered:!0,className:"full-width"})}function fe({answers:n,suspects:u,addEntryToUpdate:d,testimonyId:h}){const[m,a]=_(12),{queryParams:o}=C({sortSuspectsBy:"answers"}),f=o.get("sortSuspectsBy")??"answers",g=j.useMemo(()=>{const e=Object.keys(u).map(t=>H(t,n));return f==="answers"?b.orderBy(e,["reliable","enoughData",t=>t.values.length,"yesPercentage"],["desc","desc","desc","desc"]):e},[n,u,f]),p=e=>{const t={...n};t[e]=[...t[e]||[],3],d(h,t)},r=e=>{const t={...n};t[e]=[...t[e]||[],-3],d(h,t)},c=e=>{var x;const t={...n},l=(x=t[e])==null?void 0:x.findIndex(w=>w===3);l!==-1&&l!==void 0&&(t[e]=[...t[e].slice(0,l),...t[e].slice(l+1)]),d(h,t)},i=e=>{var x;const t={...n},l=(x=t[e])==null?void 0:x.findIndex(w=>w===-3);l!==-1&&l!==void 0&&(t[e]=[...t[e].slice(0,l),...t[e].slice(l+1)]),d(h,t)};return s.jsx(R,{wrap:!0,ref:a,size:"large",children:g.map(e=>s.jsxs(v,{vertical:!0,gap:4,children:[s.jsx(L,{id:e.imageId,width:m,className:e.enoughData?void 0:"grayscale"}),s.jsxs(V,{trigger:"click",title:`Add strong fit/unfit answer to ${u[e.suspectCardId].name.pt}`,content:s.jsxs(v,{vertical:!0,gap:4,children:[s.jsx(B.Text,{type:"secondary",children:e.values.join(", ")}),s.jsxs(P,{icon:"👍",block:!0,onClick:()=>p(e.suspectCardId),children:[" ","Add strong fit"]}),s.jsxs(P,{icon:"👎",block:!0,onClick:()=>r(e.suspectCardId),children:[" ","Add strong unfit"]}),s.jsxs(R.Compact,{children:[s.jsx(P,{icon:"❌",size:"small",block:!0,onClick:()=>c(e.suspectCardId),children:"fit"}),s.jsx(P,{icon:"❌",size:"small",block:!0,onClick:()=>i(e.suspectCardId),children:"unfit"})]})]}),children:[s.jsxs("div",{children:[s.jsx(S,{title:e.suspectCardId,children:u[e.suspectCardId].name.pt})," ",e.complete&&s.jsx(S,{title:"Complete: It has 5 or more answers",children:s.jsx(pe,{style:{color:"gold"}})})]}),s.jsx(S,{title:`Values: ${e.values.join(", ")} : ${e.result?e.result:e.projection?`${e.projection}*`:""}`,children:e.enoughData?s.jsx(O,{percent:e.noPercentage+e.yesPercentage,size:[m,20],status:"exception",success:{percent:e.yesPercentage},showInfo:!1}):s.jsx(O,{percent:e.noPercentage+e.yesPercentage,size:[m,10],status:"exception",success:{percent:e.yesPercentage},showInfo:!1})})]})]},e.suspectCardId))})}function xe({data:n,questions:u,suspects:d,isLoading:h,isSuccess:m,addEntryToUpdate:a}){const{queryParams:o,addParam:f}=C(),g=j.useMemo(()=>b.orderBy(Object.values(u),i=>Number(i.id.split("-")[1]),"asc"),[u]),p=$({total:g.length,showQuickJumper:!0}),r=[{title:"Id",dataIndex:"id",key:"id",sorter:(i,e)=>Number(i.id.split("-")[1])-Number(e.id.split("-")[1])},{title:"Question",dataIndex:"question",key:"question",sorter:(i,e)=>i.question.localeCompare(e.question)},{title:"NSFW",dataIndex:"nsfw",key:"nsfw",render:i=>i?s.jsx(Z,{style:{color:"hotPink"}}):"",sorter:(i,e)=>Number(i.nsfw)-Number(e.nsfw)},{title:"Answers",dataIndex:"id",key:"answers",render:i=>{const e=n[i];return e?Object.values(e).length:""}}],c=Q({maxExpandedRows:1,expandedRowRender:i=>s.jsx(fe,{testimonyId:i.id,answers:n[i.id]??{},suspects:d,addEntryToUpdate:a}),rowExpandable:()=>m});return s.jsxs(v,{gap:12,className:"full-width py-4",vertical:!0,children:[s.jsxs(v,{justify:"space-between",align:"center",children:[s.jsx(B.Title,{level:4,className:"my-0",children:"Suspects by Testimony"}),s.jsx(G,{checked:o.get("sortSuspectsBy")==="answers",onChange:i=>f("sortSuspectsBy",i?"answers":"id"),checkedChildren:"Sort by Answers",unCheckedChildren:"Sort by Id"})]}),s.jsx(D,{columns:r,dataSource:g,pagination:p,rowKey:"id",expandable:c,loading:h,bordered:!0,className:"full-width"})]})}function je(n){const{queryParams:u,is:d}=C();return s.jsxs(s.Fragment,{children:[(d("display","questions")||!u.get("display"))&&s.jsx(xe,{...n}),d("display","suspects")&&s.jsx(ge,{...n})]})}function ye({data:n,hasNewData:u,isDirty:d,save:h,isSaving:m,entriesToUpdate:a}){const{queryParams:o,addParams:f}=C(),g=j.useMemo(()=>{const p={};return Object.values(n).forEach(r=>{Object.keys(r).forEach(c=>{r[c]&&(p[c]||(p[c]=0),r[c].length>=5&&(p[c]+=1))})}),{queriedTestimoniesCount:Object.keys(n).length,suspectsCount:Object.keys(p).length,reliableSuspectsCount:Object.values(p).filter(r=>r>=5).length}},[n]);return s.jsxs(s.Fragment,{children:[s.jsx(k,{children:s.jsxs(v,{vertical:!0,gap:12,children:[s.jsx(se,{isDirty:d,onSave:h,isSaving:m,dirt:JSON.stringify(a)}),s.jsx(ee,{data:()=>be(n),fileName:"testimony-answers.json",disabled:d,hasNewData:u,block:!0})]})}),s.jsx(k,{children:s.jsx(X,{label:"Display",value:o.get("display")??"questions",onChange:p=>f({display:p,page:1},{page:1}),options:[{title:"Questions",icon:s.jsx(oe,{}),value:"questions"},{title:"Suspects",icon:s.jsx(ue,{}),value:"suspects"}]})}),s.jsx(k,{children:s.jsxs("div",{style:{fontSize:"0.85em"},children:[s.jsx("strong",{children:"Legend"}),s.jsxs("ul",{children:[s.jsx("li",{children:"Reliability: At least 5 votes"}),s.jsx("li",{children:"Large Bars: There's enough data (at least 3)"}),s.jsx("li",{children:"Small blue bar: in progress negative"})]})]})}),s.jsx(k,{children:s.jsxs("div",{style:{fontSize:"0.85em"},children:[s.jsx("strong",{children:"Counts"}),s.jsxs("ul",{children:[s.jsxs("li",{children:["Testimonies: ",g.queriedTestimoniesCount]}),s.jsxs("li",{children:["Suspects: ",g.suspectsCount]}),s.jsx("li",{children:s.jsxs(S,{title:"A reliable suspect is one that has at least 5 complete testimonies.",children:["Reliable suspects: ",g.reliableSuspectsCount]})})]})]})})]})}function be(n){return console.log("Preparing file for download..."),te(ne(n))}function we(){const{notification:n}=K.useApp(),u=J(),d=T("suspects"),h=T("testimony-questions-pt"),m=T("testimony-answers"),a=ae("data","testimonies",{select:e=>re(e,t=>{const l={};return Object.keys(t).forEach(x=>{const w=x.replace(/us-\w{2}-(\d+)/,"us-$1");l[w]=t[x]||[]}),l})}),[o,f]=j.useState({}),g=ie("data","testimonies",{onSuccess:()=>{n.success({message:"data/testimonies updated"}),u.refetchQueries({queryKey:["firestore","data","testimonies"]}),f({})},onError:e=>{n.error({message:"data/testimonies update failed",description:e.message})}}),p=j.useMemo(()=>{if(!m.data||!a.data)return{};const e=b.cloneDeep(m.data);return Object.keys(a.data).forEach(t=>{const l=a.data[t];if(e[t]===void 0){e[t]=l;return}Object.keys(l).forEach(x=>{e[t][x]===void 0?e[t][x]=l[x]:e[t][x].push(...l[x])})}),Object.keys(o).forEach(t=>{const l=o[t];e[t]&&(e[t]=l)}),e},[m.data,a.data,o]),r=!b.isEmpty(o),c=(e,t)=>{f(l=>({...l,[e]:t}))},i=()=>{const e=Object.keys(o).reduce((t,l)=>(t[l]=JSON.stringify(o[l]),t),{});g.mutate(e)};return{isLoading:m.isLoading||a.isLoading||h.isLoading||d.isLoading,isSuccess:m.isSuccess&&a.isSuccess&&h.isSuccess&&d.isSuccess,error:m.error||a.error,data:p,questions:h.data,suspects:d.data,hasNewData:!b.isEmpty(a.data),isSaving:g.isPending,save:i,addEntryToUpdate:c,isDirty:r,entriesToUpdate:o}}function ls(){const n=we();return s.jsx(W,{title:"Testimonies",subtitle:"Suspect Testimony Rates",children:s.jsxs(A,{hasSider:!0,children:[s.jsx(U,{children:s.jsx(ye,{...n})}),s.jsx(A.Content,{className:"content",children:s.jsx(Y,{isLoading:n.isLoading,error:n.error,hasResponseData:!b.isEmpty(n.data),children:s.jsx(je,{...n})})})]})})}export{ls as TestimoniesPage,ls as default};
