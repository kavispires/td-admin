import{j as e,D as b,r as x,T as h,B as I,a1 as F,P as O,L as w}from"./index-B5-2HM5B.js";import{D as E}from"./DataLoadingWrapper-BaxBS94E.js";import{u as C}from"./useQueryParams-C8unIuj1.js";import{l as u,P as k}from"./useBaseUrl-C81I6maY.js";import{I as R}from"./Item-Cl0bkTHl.js";import{u as v}from"./useCopyToClipboardFunction-BVVm1Puf.js";import{u as S}from"./useTDResource-xEI3cILf.js";import{u as P}from"./useTableExpandableRows-CpV8STgO.js";import{u as $}from"./useTablePagination-B_hNtmwq.js";import{h as B,r as T,a as H,j as Q}from"./index-DEfIxL-b.js";import{I as Y}from"./ItemsTypeahead-DHtV4KTi.js";import{F as p}from"./index-D8zlra0v.js";import{R as G}from"./PlusOutlined-B59bC0BI.js";import{u as _}from"./useDailyHistoryQuery-NLEUCGsN.js";import{u as J,L as K}from"./constants-BfM-7w-H.js";import{F as f}from"./Table-JtIs1uPt.js";import{S as y}from"./index-CzxBrtg5.js";import{P as W}from"./index-D_SqxPc7.js";import{R as X}from"./DeleteFilled-Bn5eW0bY.js";import{T as z}from"./Typeahead-DlASiFxL.js";import{c as q}from"./FilterEntries-Dq7WElh2.js";import{S as U}from"./SiderContent-hN9zjJ9h.js";import{D as Z}from"./DownloadButton-BslZH4vt.js";import{S as V}from"./SaveButton-Cuebvwj3.js";import{u as ee}from"./useResourceFirestoreData-BtutAPHc.js";import"./constants-DsjZWQx9.js";import"./useDebounce-C8IC8cvu.js";import"./index-DroMa-XX.js";import"./index-TVf6wIbH.js";import"./index-IW2Ifu1c.js";import"./Input-BG1b9zQD.js";import"./gapSize-U1swVQyS.js";import"./PlusOutlined-ByZyTB3m.js";import"./useGetFirestoreDoc-DRobRFSV.js";import"./moment-C5S46NFB.js";import"./index-DShwIIJ8.js";import"./index-CKlL__AM.js";import"./index-Cydz4FrO.js";import"./scrollTo-89HbUyoz.js";import"./Pagination-ljPjtj9s.js";import"./extendsObject-keMuGWqj.js";import"./index-7oODgzUU.js";import"./index-DA6KwYEn.js";import"./SaveOutlined-LRTvDctr.js";import"./useUpdateFirestoreDoc-DlR13OHt.js";import"./useMutation-B7RcyywH.js";function D({movie:t,addEntryToUpdate:r}){const s=a=>{r(t.id,{...t,itemsIds:[...t.itemsIds,a]})};return e.jsxs(p,{gap:12,children:[e.jsx("div",{style:{minWidth:250},children:e.jsx(Y,{onFinish:s})}),e.jsx(b,{type:"vertical",variant:"dotted"}),e.jsx(te,{movie:t,onUpdate:s})]})}function te({movie:t,onUpdate:r}){const s=S("items",!0),a=x.useMemo(()=>{if(!s.data)return[];const i=t.title.toLowerCase(),l=Object.entries(s.data),c=[];return l.forEach(([m,n])=>{if(t.itemsIds.includes(m))return;const o=[n.name.pt.toLowerCase()];n.aliasesPt&&Array.isArray(n.aliasesPt)&&o.push(...n.aliasesPt.map(A=>A.toLowerCase()));const j=B.findBestMatch(i,o).bestMatch.rating;j>.3&&c.push({id:m,similarity:j})}),c.sort((m,n)=>n.similarity-m.similarity).slice(0,20).map(m=>m.id)},[s.data,t]);return e.jsxs(p,{gap:12,vertical:!0,children:[e.jsx(h.Text,{strong:!0,children:"Suggestions"}),e.jsx(p,{gap:16,wrap:"wrap",children:a.map((i,l)=>{var m;const c=(m=s.data)==null?void 0:m[i];return e.jsxs(p,{gap:2,vertical:!0,children:[e.jsx(R,{id:i,width:60,title:`${c.name.en} | ${c.name.pt}`}),e.jsxs(p,{justify:"center",gap:6,children:[e.jsx(h.Text,{children:i}),e.jsx(I,{size:"small",shape:"circle",onClick:()=>r(i),children:e.jsx(G,{})})]})]},`sample-${i}-${l}`)})})]})}function se(){const t=K.DAILY.pt,r=_(t,{enabled:!0}),[s]=J("filmaco",r.data);return x.useMemo(()=>u.mapValues(u.keyBy((s==null?void 0:s.used)??[]),()=>!0),[s])}function N({rows:t,addEntryToUpdate:r}){const s=v(),a=S("items"),i=se(),l=$({total:t.length,showQuickJumper:!0}),c=[{title:"Title",dataIndex:"title",render:(n,o)=>e.jsx(g,{property:"title",value:n,movie:o,addEntryToUpdate:r}),sorter:(n,o)=>n.title.localeCompare(o.title)},{title:"Year",dataIndex:"year",render:(n,o)=>e.jsx(g,{property:"year",value:n,movie:o,addEntryToUpdate:r}),sorter:(n,o)=>n.year-o.year},f.EXPAND_COLUMN,{title:"Items",dataIndex:"itemsIds",key:"itemsIds",render:(n,o)=>e.jsx(L,{movie:o,itemsIds:n,copyToClipboard:s,addEntryToUpdate:r}),sorter:(n,o)=>n.itemsIds.length-o.itemsIds.length},{title:"Count",dataIndex:"itemsIds",render:n=>T(n).filter(Boolean).length},{title:"Used",dataIndex:"id",render:n=>i[n]?"Yes":"No",sorter:(n,o)=>i[n.id]&&!i[o.id]?-1:!i[n.id]&&i[o.id]?1:o.itemsIds.length-n.itemsIds.length}],m=P({maxExpandedRows:1,expandedRowRender:n=>e.jsx(D,{movie:n,addEntryToUpdate:r}),rowExpandable:()=>a.isSuccess});return e.jsx(f,{columns:c,rowKey:"id",dataSource:t,expandable:m,pagination:l})}function re({movie:t,addEntryToUpdate:r,itemId:s}){const a=()=>{r(t.id,{...t,itemsIds:t.itemsIds.filter(i=>i!==s)})};return e.jsx(W,{title:"Are you sure you want to remove this item?",onConfirm:a,okText:"Yes",cancelText:"No",children:e.jsx(I,{icon:e.jsx(X,{}),size:"small",type:"text"})})}function L({movie:t,itemsIds:r,copyToClipboard:s,addEntryToUpdate:a}){return e.jsx(p,{gap:6,wrap:"wrap",children:r.map((i,l)=>e.jsxs(p,{gap:2,vertical:!0,children:[e.jsx(R,{id:i,width:60}),e.jsxs(p,{justify:"center",children:[e.jsx(h.Text,{onClick:()=>s(i),children:i}),e.jsx(re,{movie:t,addEntryToUpdate:a,itemId:i})]})]},`${t.title}-${i}-${l}`))},`items-${t.title}`)}function g({value:t,movie:r,addEntryToUpdate:s,property:a}){const i=l=>typeof t=="number"?l!==String(t)?s(r.id,{...r,[a]:Number(l)}):null:l!==t?s(r.id,{...r,[a]:l.trim()}):null;return e.jsx(y,{children:e.jsx(h.Text,{editable:{onChange:i},children:String(t)})})}function ie(t){return u.orderBy(t,[r=>r.title]).map(r=>({...r,itemsIds:u.orderBy(r.itemsIds,s=>Number(s))}))}function oe({data:t,addEntryToUpdate:r}){const{is:s}=C(),a=s("emptyOnly"),i=x.useMemo(()=>{const c=t?ie(Object.values(t)):[];return a?c.filter(m=>m.itemsIds.length===0):c},[a]),l=i.filter(c=>c.itemsIds.length>0).length;return e.jsxs(y,{direction:"vertical",children:[e.jsxs(h.Title,{level:5,children:["Total Movies: ",i.length," | Complete Movies: ",l]}),e.jsx(N,{rows:i,addEntryToUpdate:r})]})}function ne({data:t,addEntryToUpdate:r}){const[s,a]=x.useState(null),i=x.useMemo(()=>s?t[s]:null,[s,t]);return e.jsxs(y,{direction:"vertical",children:[e.jsx(h.Title,{level:5,children:"Search Movie"}),e.jsx(z,{data:t,onFinish:l=>a(l),placeholder:"Search movie by title...",parser:ae,style:{width:"100%",minWidth:450}}),!!i&&e.jsx(N,{rows:[i],addEntryToUpdate:r})]})}const ae=t=>Object.values(t??{}).reduce((r,s)=>(r[`${s.title} (${s.year})`]=s.id,r),{});function le({data:t,save:r,isDirty:s,isSaving:a,entriesToUpdate:i,hasFirestoreData:l,addEntryToUpdate:c}){const{is:m,addParam:n}=C();return e.jsxs(U,{children:[e.jsxs(p,{vertical:!0,gap:12,children:[e.jsx(V,{isDirty:s,onSave:r,isSaving:a,dirt:JSON.stringify(i)}),e.jsx(Z,{data:()=>ce(t),fileName:"daily-movie-sets.json",disabled:s,hasNewData:l,block:!0})]}),e.jsx(b,{}),e.jsx(q,{label:"Pending Only",value:m("emptyOnly"),onChange:o=>n("emptyOnly",o,!1)}),e.jsx(me,{data:t,addEntryToUpdate:c})]})}function ce(t){return H(t)}function me({data:t,addEntryToUpdate:r}){const{message:s}=F.useApp(),a=v(),i=()=>{const l=Q(Object.keys(t),"dms","pt","-",1),c="[New Movie Set]";r(l,{id:l,title:c,itemsIds:[],year:new Date().getFullYear()}),s.success(`New Movie Set created, search for ${c} to find it easily.`),a(c)};return e.jsx(I,{onClick:i,children:"Add New Movie Set"})}const M=30;function de({data:t,addEntryToUpdate:r}){const[s,a]=x.useState(null),i=S("items"),l=v(),c=()=>{var j;let o=u.sample(Object.keys(t??{})),d=0;for(;d<M&&(((j=t[String(o)])==null?void 0:j.itemsIds)??[]).length>0;)o=u.sample(Object.keys(t??{})),d++;if(d>=M)return console.warn("Could not find a sample with no itemsIds");a(o??null)},m=[{title:"Title",dataIndex:"title",render:(o,d)=>e.jsx(g,{property:"title",value:o,movie:d,addEntryToUpdate:r})},{title:"Year",dataIndex:"year",render:(o,d)=>e.jsx(g,{property:"year",value:o,movie:d,addEntryToUpdate:r})},f.EXPAND_COLUMN,{title:"Items",dataIndex:"itemsIds",key:"itemsIds",render:(o,d)=>e.jsx(L,{movie:d,itemsIds:o,copyToClipboard:l,addEntryToUpdate:r})},{title:"Count",dataIndex:"itemsIds",render:o=>T(o).filter(Boolean).length}],n=P({maxExpandedRows:1,expandedRowRender:o=>e.jsx(D,{movie:o,addEntryToUpdate:r}),rowExpandable:()=>i.isSuccess});return e.jsxs(y,{direction:"vertical",className:"my-4",children:[e.jsx(I,{onClick:c,children:"Get Random Movie"}),s&&e.jsx(f,{columns:m,rowKey:"id",dataSource:[t[s]],expandable:n,pagination:!1},String(s))]})}function it(){const t=ee({tdrResourceName:"daily-movie-sets",firestoreDataCollectionName:"movieSets"});return e.jsx(O,{title:"Items",subtitle:"Movie Sets",children:e.jsxs(w,{hasSider:!0,children:[e.jsx(k,{children:e.jsx(le,{...t})}),e.jsx(w.Content,{className:"content",children:e.jsx(E,{isLoading:t.isLoading,error:t.error,hasResponseData:!u.isEmpty(t.data),children:e.jsxs(y,{direction:"vertical",children:[e.jsx(ne,{...t}),e.jsx(de,{...t}),e.jsx(oe,{...t})]})})})]})})}export{it as ItemsMovieSets,it as default};
