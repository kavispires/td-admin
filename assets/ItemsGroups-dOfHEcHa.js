import{r as y,a1 as M,j as e,B as $,T as b,D as W,P as Q,L as O}from"./index-dxqRZG9X.js";import{D as z}from"./DataLoadingWrapper-CHkaPzzl.js";import{F as q,c as U}from"./FilterEntries-DDHedpCi.js";import{S as J}from"./SiderContent-g6fyCteD.js";import{D as K}from"./DownloadButton-D7cMNwbq.js";import{S as _}from"./SaveButton-wN5bIWmj.js";import{u as T}from"./useQueryParams--Xnh1v1a.js";import{u as v}from"./useTDResource-Bxk_GrJX.js";import{l as g,P as V}from"./useBaseUrl-BXHtA4Pi.js";import{h as N,b as X,i as H,r as C,a as Y}from"./index-CIdX3id2.js";import{L as P}from"./LanguageFlag-Dc2UEnQM.js";import{F as I,R as Z,C as ee}from"./index-C4I3rKEO.js";import{M as se}from"./index-Cqfe7jHO.js";import{I as D}from"./index-DG9-Dq-U.js";import{F as w}from"./index-BggtpG-R.js";import{R as te}from"./ClusterOutlined-WWkLegib.js";import{R as re}from"./TableOutlined-B1zJntsQ.js";import{T as oe}from"./TransparentButton-Clvy830t.js";import{D as G}from"./EditableFields-BnAlkwL5.js";import{I as ae}from"./Item-D-HWwya5.js";import{u as E}from"./useCopyToClipboardFunction-DXdQUBdr.js";import{u as ie}from"./useTableExpandableRows-C14YbQTT.js";import{u as ne}from"./useTablePagination-6PZJK4qc.js";import{C as le}from"./CopyIdsButton-C03mgUC9.js";import{I as me}from"./InspirationSample-v_-HkNSj.js";import{I as ce}from"./ItemsTypeahead-D1mDkd5i.js";import{I as de,b as k,d as pe}from"./ItemBuildingBlocks-BIY8BIpa.js";import{C as ue}from"./index-DkjYrQny.js";import{S as F}from"./index--q15TYvE.js";import{S as he}from"./index-DOhECwtc.js";import{F as R}from"./Table-Dh4wzHOO.js";import{D as xe}from"./index-BgjsGA0b.js";import{u as fe,P as je}from"./useGridPagination-tdfnByHQ.js";import{T as ye}from"./Typeahead-C3RUTsLu.js";import{u as ge}from"./useResourceFirestoreData-pL1PX9Zq.js";import"./index-CzsF-3pk.js";import"./index-BM-X4DgR.js";import"./moment-C5S46NFB.js";import"./SaveOutlined-DH5U4cHr.js";import"./constants-B8Jx-I5N.js";import"./Input-BdiSS1dO.js";import"./gapSize-U1swVQyS.js";import"./FireFilled-BU0ZXDCk.js";import"./IdcardOutlined-CDC85dSd.js";import"./index-Be7dL0At.js";import"./SyncOutlined-BxfGj375.js";import"./PlusOutlined-D-F8h1jm.js";import"./useDebounce-BVP3YnwL.js";import"./index-BrqB1EGw.js";import"./index-BodX8mPE.js";import"./index-q2VES2ua.js";import"./index-tMGK7Y07.js";import"./scrollTo-DBz7YC_A.js";import"./Pagination-CMgMjwwg.js";import"./useGetFirestoreDoc-Bd7iCQ4m.js";import"./useUpdateFirestoreDoc-Cq7_Knra.js";import"./useMutation-CF3vwMOA.js";function Ie({addEntryToUpdate:s,data:t}){const[o,c]=y.useState(!1),[n]=I.useForm(),{notification:m}=M.useApp(),d=r=>{const a=X(Object.keys(t));s(a,{id:a,name:{pt:r.nome,en:r.name},itemsIds:[],keywords:r.keywords}),m.success({message:"Group added successfully"}),c(!1),n.resetFields()},u=I.useWatch("name",n),f=I.useWatch("nome",n),p=y.useMemo(()=>{const r={};if(u&&u.length>2){const l=Object.entries(t).reduce((x,[S,i])=>{const h=N.compareTwoStrings(i.name.en,u),j=N.compareTwoStrings(i.name.pt,f);return(h>.2||j>.2)&&(x[S]=Math.max(h,j)),x},{});Object.keys(l).forEach(x=>{r[x]=l[x]})}return Object.keys(r)},[u,f,t]);return e.jsxs(e.Fragment,{children:[e.jsx($,{block:!0,className:"mb-4",onClick:()=>c(!0),type:"dashed",children:"Add New Group"}),e.jsxs(se,{maskClosable:!1,okButtonProps:{htmlType:"submit"},okText:"Add",onCancel:()=>c(!1),onOk:n.submit,open:o,title:"Add New Set",children:[e.jsxs(I,{form:n,onFinish:d,children:[e.jsx(I.Item,{label:"Nome",name:"nome",rules:[{required:!0}],children:e.jsx(D,{placeholder:"Name in pt",prefix:e.jsx(P,{language:"pt",width:"1em"}),size:"small"})}),e.jsx(I.Item,{label:"Name",name:"name",rules:[{required:!0}],children:e.jsx(D,{placeholder:"Name in en",prefix:e.jsx(P,{language:"en",width:"1em"}),size:"small"})})]}),e.jsx(b.Text,{children:"Similar:"}),e.jsx("ul",{children:p.map(r=>{var a,l;return e.jsxs("li",{children:[r," - ",(a=t[r])==null?void 0:a.name.en," / ",(l=t[r])==null?void 0:l.name.pt]},r)})})]})]})}function be({data:s,save:t,isDirty:o,isSaving:c,entriesToUpdate:n,addEntryToUpdate:m,hasFirestoreData:d}){const{queryParams:u,addParam:f,addParams:p,is:r}=T(),a=v("items");return e.jsxs(J,{children:[e.jsxs(w,{gap:12,vertical:!0,children:[e.jsx(_,{dirt:JSON.stringify(L(n)),isDirty:o,isSaving:c,onSave:t}),e.jsx(K,{block:!0,data:()=>Se(s,a.data),disabled:o||g.isEmpty(a.data),fileName:"items-groups.json",hasNewData:d})]}),e.jsx(W,{}),e.jsx(q,{label:"Display",onChange:l=>p({display:l,page:1},{page:1}),options:[{title:"By Groups",icon:e.jsx(te,{}),value:"group"},{title:"By Items",icon:e.jsx(re,{}),value:"item"}],value:u.get("display")??"group"}),e.jsx(Ie,{addEntryToUpdate:m,data:s}),r("display","item")&&e.jsx(U,{label:"No Groups Only",onChange:l=>f("emptyOnly",l,!1),value:r("emptyOnly")})]})}function L(s){return g.omitBy(g.cloneDeep(s),t=>g.isEmpty(t.itemsIds))}function Se(s,t){return Object.keys(s).forEach(o=>{s[o].itemsIds=H(C(s[o].itemsIds));const c=s[o].itemsIds.length,n=s[o].itemsIds.filter(m=>t[m].nsfw).length;n>c*.3&&(s[o].nsfw=!0,console.log(`ðŸ˜ˆ Group ${s[o].name.pt} has ${n} (${Math.round(n/c*100)}%) NSFW items`))}),Y(L(s))}function we({group:s,onUpdateGroupItems:t}){const o=c=>{t(s.id,[...s.itemsIds,c])};return e.jsxs("div",{children:[e.jsx(ce,{onFinish:o}),e.jsx(me,{excludeList:s.itemsIds,initialQuantity:0,onSelect:o})]})}const Ce=["8bc4f","96efa","c10eb","16ec3","2a97f","4bba8","565ed","5fb57","62a8b"];function B({item:s,itemGroups:t,groupsTypeahead:o,onUpdateItemGroups:c}){const n=E();return e.jsxs(ue,{style:{maxWidth:250,...ve(t)},title:e.jsxs(e.Fragment,{children:[e.jsx(b.Text,{onClick:()=>n(s.id),children:s.id}),e.jsx(pe,{item:s})]}),children:[e.jsx(de,{item:s,width:75}),e.jsxs(F,{className:"my-4",direction:"vertical",size:"small",children:[e.jsx(k,{item:s,language:"en"}),e.jsx(k,{item:s,language:"pt"}),e.jsx(he,{defaultValue:t,filterOption:(m,d)=>!!(d!=null&&d.label.toLowerCase().includes(m.toLowerCase())),mode:"multiple",onChange:m=>c(s.id,m),options:o,placeholder:"Select a group",size:"small",style:{width:"100%"}},String(t))]})]})}const ve=s=>!s||(s==null?void 0:s.length)===0?{borderColor:"orange"}:s!=null&&s.every(t=>Ce.includes(t))?{borderColor:"red"}:{};function A({rows:s,items:t,grousByItem:o,groupsTypeahead:c,onUpdateItemGroups:n,onUpdateGroupItems:m,onUpdateName:d}){const u=E(),f=v("items"),[p,r]=y.useState(null),a=ne({showQuickJumper:!0,total:s.length}),l=[{title:"id",dataIndex:"id",key:"id",render:i=>e.jsx("span",{children:i})},{title:"Name",dataIndex:"name",key:"name",render:(i,h)=>e.jsxs(w,{gap:4,vertical:!0,children:[e.jsx(G,{language:"en",onChange:j=>d(j.target.value,"en",h.id),style:{minWidth:150},value:i}),e.jsx(G,{language:"pt",onChange:j=>d(j.target.value,"pt",h.id),style:{minWidth:150},value:i})]})},{title:"Items",dataIndex:"itemsIds",key:"itemsIds",render:(i,h)=>e.jsx(w,{gap:6,wrap:"wrap",children:i.map(j=>e.jsxs(w,{gap:2,vertical:!0,children:[e.jsx(oe,{onClick:()=>r(j),children:e.jsx(ae,{id:j,width:60})}),e.jsx(w,{justify:"center",children:e.jsx(b.Text,{onClick:()=>u(j),children:j})})]},`${h.id}-${j}`))},`items-${h.id}`)},R.EXPAND_COLUMN,{title:"Count",dataIndex:"itemsIds",key:"count",render:i=>C(i).filter(Boolean).length},{title:"Actions",dataIndex:"itemsIds",key:"actions",render:i=>e.jsx(le,{ids:i})}],x=p?t[p]:null,S=ie({maxExpandedRows:1,expandedRowRender:i=>e.jsx(we,{group:i,onUpdateGroupItems:m}),rowExpandable:()=>f.isSuccess});return e.jsxs(e.Fragment,{children:[e.jsx(R,{className:"my-4",columns:l,dataSource:s,expandable:S,pagination:a,rowKey:"id"}),e.jsx(xe,{onClose:()=>r(null),open:!!x,title:"Edit Item Group",children:x&&e.jsx(B,{groupsTypeahead:c,item:x,itemGroups:o[x.id],onUpdateItemGroups:n})})]})}function Te({items:s,grousByItem:t,groupsTypeahead:o,onUpdateItemGroups:c}){const{is:n}=T(),m=n("emptyOnly"),d=y.useMemo(()=>m?Object.values(s).filter(p=>!t[p.id]):Object.values(s),[s,t,m]),{page:u,pagination:f}=fe({data:d});return e.jsxs(e.Fragment,{children:[e.jsxs(b.Title,{level:2,children:["Groups by Items (",d.length,")"]}),e.jsx(je,{pagination:f,children:e.jsx(Z,{className:"my-4",gutter:[16,16],children:u.map(p=>e.jsx(ee,{lg:6,md:12,sm:24,xl:4,xs:24,children:e.jsx(B,{groupsTypeahead:o,item:p,itemGroups:t[p.id],onUpdateItemGroups:c})},p.id))})})]})}function Fe({data:s,items:t,grousByItem:o,groupsTypeahead:c,onUpdateItemGroups:n,onUpdateGroupItems:m,onUpdateName:d}){const[u,f]=y.useState(null),p=y.useMemo(()=>u?s[u]:null,[u,s]);return e.jsxs(F,{direction:"vertical",children:[e.jsx(b.Title,{level:5,children:"Search Groups"}),e.jsx(ye,{data:s,onFinish:r=>f(r),parser:Oe,placeholder:"Search group by name...",style:{width:"100%",minWidth:450}}),!!p&&e.jsx(A,{groupsTypeahead:c,grousByItem:o,items:t,onUpdateGroupItems:m,onUpdateItemGroups:n,onUpdateName:d,rows:[p]})]})}const Oe=s=>Object.values(s??{}).reduce((t,o)=>(t[`${o.name.en}`]=o.id,t[`${o.name.pt}`]=o.id,t),{});function Ne({data:s,addEntryToUpdate:t}){const{is:o,queryParams:c}=T(),n=v("items"),m=y.useMemo(()=>Object.values(s??[]).reduce((r,a)=>(a.itemsIds||console.warn("Group without items",a),a.itemsIds.forEach(l=>{r[l]||(r[l]=[]),r[l].push(a.id)}),r),{}),[s]),d=y.useMemo(()=>g.orderBy(Object.values(s).flatMap(({id:r,name:a})=>[{label:`${a.en} [${r}]`,value:r}]),"label"),[s]),u=(r,a)=>{const l=m[r]??[],x=a.filter(i=>!l.includes(i)),S=l.filter(i=>!a.includes(i));x.forEach(i=>{const h=s[i];t(i,{...h,itemsIds:C([...(h==null?void 0:h.itemsIds)??[],r])})}),S.forEach(i=>{const h=s[i];t(i,{...h,itemsIds:C(h==null?void 0:h.itemsIds.filter(j=>j!==r))})})},f=(r,a)=>{const l=s[r];t(r,{...l,itemsIds:C(a)})},p=(r,a,l)=>{const x=s[l];t(l,{...x,name:{...x.name,[a]:r}})};return e.jsxs(e.Fragment,{children:[(o("display","group")||!c.has("display"))&&e.jsxs(F,{className:"mb-4",direction:"vertical",children:[e.jsx(Fe,{data:s,groupsTypeahead:d,grousByItem:m,items:n.data,onUpdateGroupItems:f,onUpdateItemGroups:u,onUpdateName:p}),e.jsxs(b.Title,{level:2,children:["Groups (",Object.keys(s).length,")"]}),e.jsx(A,{groupsTypeahead:d,grousByItem:m,items:n.data,onUpdateGroupItems:f,onUpdateItemGroups:u,onUpdateName:p,rows:Object.values(s)})]}),o("display","item")&&e.jsx(Te,{groupsTypeahead:d,grousByItem:m,items:n.data,onUpdateGroupItems:f,onUpdateItemGroups:u,onUpdateName:p})]})}function ks(){const s=ge({tdrResourceName:"items-groups",firestoreDataCollectionName:"itemsGroups",serialize:!0}),t=v("items");return e.jsx(Q,{subtitle:"Groups Sets",title:"Items",children:e.jsxs(O,{hasSider:!0,children:[e.jsx(V,{children:e.jsx(be,{...s})}),e.jsx(O.Content,{className:"content",children:e.jsx(z,{error:s.error||t.error,hasResponseData:!g.isEmpty(s.data)&&!g.isEmpty(t.data),isLoading:s.isLoading||t.isLoading,children:e.jsx(Ne,{...s})})})]})})}export{ks as ItemsGroups,ks as default};
