import{j as e,T as v,r as b,D as R,P as E,L as w}from"./index-oik76Yce.js";import{D as B}from"./DataLoadingWrapper-B2D8XxnP.js";import{u as L,P as k}from"./useGridPagination-CaJCe2Id.js";import{I as Q}from"./Item-Ba0f751c.js";import{u as D}from"./useCopyToClipboardFunction-BFhTS2ay.js";import{u as S}from"./useQueryParams-Df1JeVTl.js";import{u as C}from"./useTDResource-DkOmcFeu.js";import{l as y}from"./lodash-Vop7Mp14.js";import{r as I,h as $,a as W}from"./index-C4Fw4qmq.js";import{T as M}from"./TransparentButton-CsyHwFDG.js";import{D as T}from"./EditableFields-BQttWDlt.js";import{u as A}from"./useTablePagination-twzJ0TmB.js";import{C as z}from"./CopyIdsButton-BsTj5HE-.js";import{I as J}from"./ItemsTypeahead-Duc-5HRT.js";import{I as q,b as F,d as K}from"./ItemBuildingBlocks-C_r0LJGB.js";import{C as U}from"./index-C_m9foa2.js";import{S as V}from"./index-Do93bfhz.js";import{S as X}from"./index-C8FScIXC.js";import{F as G}from"./Table-xgW500Xi.js";import{F as g}from"./index-BPF7_s59.js";import{D as _}from"./index-CkUdqrmR.js";import{R as H,C as Y}from"./index-Bi3uYhXZ.js";import{F as Z,c as ee}from"./FilterEntries-2k4jljom.js";import{S as se}from"./SiderContent-2txor-6k.js";import{D as te}from"./DownloadButton-Dg0aFjjM.js";import{S as re}from"./SaveButton-By4PzGJ5.js";import{R as oe}from"./ClusterOutlined-MJoi-73G.js";import{R as ie}from"./TableOutlined-COhT1_jE.js";import{P as ae}from"./useBaseUrl-8KF9RGGJ.js";import{u as ne}from"./useResourceFirebaseData-BdoRZxAM.js";import"./Pagination-CV-sUief.js";import"./constants-TZCB7cTe.js";import"./LanguageFlag-BIzkDP9a.js";import"./index-DX4nSdYK.js";import"./Input-B7NcGiI2.js";import"./index-BPMAy79T.js";import"./FireFilled-CDhG2y_s.js";import"./IdcardOutlined-G1fFCtkH.js";import"./useDebounce-Cdryh9m_.js";import"./index-CBA8eTtm.js";import"./PlusOutlined-CQT3z5rK.js";import"./gapSize-U1swVQyS.js";import"./index-BT_-hxwD.js";import"./index-D4bHF8ZM.js";import"./index-Cm8buRN3.js";import"./scrollTo-DdZFo67F.js";import"./extendsObject-keMuGWqj.js";import"./moment-C5S46NFB.js";import"./SaveOutlined-DX5pS_DM.js";import"./useGetFirebaseDoc-U-6oUXkl.js";import"./useUpdateFirebaseDoc-DZGN3Wig.js";import"./useMutation-CthqUVjk.js";function N({item:s,itemGroups:t,groupsTypeahead:o,onUpdateItemGroups:n}){const m=D();return e.jsxs(U,{title:e.jsxs(e.Fragment,{children:[e.jsx(v.Text,{onClick:()=>m(s.id),children:s.id}),e.jsx(K,{item:s})]}),style:{maxWidth:250},children:[e.jsx(q,{item:s,width:75}),e.jsxs(V,{size:"small",direction:"vertical",className:"my-4",children:[e.jsx(F,{item:s,language:"en"}),e.jsx(F,{item:s,language:"pt"}),e.jsx(X,{mode:"tags",style:{width:"100%"},placeholder:"Select a group",defaultValue:t,options:o,showSearch:!0,size:"small",onChange:l=>n(s.id,l)},String(t))]})]})}function me({data:s,addEntryToUpdate:t}){const{is:o,queryParams:n}=S(),m=C("items"),l=b.useMemo(()=>Object.values(s??[]).reduce((r,c)=>(c.itemsIds||console.warn("Group without items",c),c.itemsIds.forEach(u=>{r[u]||(r[u]=[]),r[u].push(c.id)}),r),{}),[s]),x=b.useMemo(()=>y.orderBy(Object.keys(s).map(r=>({label:r,value:r})),"label"),[s]),j=(r,c)=>{const u=l[r]??[],f=c.filter(a=>!u.includes(a)),d=u.filter(a=>!c.includes(a));f.forEach(a=>{const i=s[a];t(a,{...i,itemsIds:I([...(i==null?void 0:i.itemsIds)??[],r])})}),d.forEach(a=>{const i=s[a];t(a,{...i,itemsIds:I(i==null?void 0:i.itemsIds.filter(P=>P!==r))})})},h=(r,c)=>{const u=s[r];t(r,{...u,itemsIds:I(c)})},p=(r,c,u)=>{const f=s[u];t(u,{...f,name:{...f.name,[c]:r}})};return e.jsxs(e.Fragment,{children:[(o("display","group")||!n.has("display"))&&e.jsx(le,{data:s,items:m.data,grousByItem:l,groupsTypeahead:x,onUpdateItemGroups:j,onUpdateGroupItems:h,onUpdateName:p}),o("display","item")&&e.jsx(de,{data:s,items:m.data,grousByItem:l,groupsTypeahead:x,onUpdateItemGroups:j,onUpdateGroupItems:h,onUpdateName:p})]})}function le({data:s,items:t,grousByItem:o,groupsTypeahead:n,onUpdateItemGroups:m,onUpdateGroupItems:l,onUpdateName:x}){const j=D(),h=C("items"),[p,r]=b.useState(null),c=A({showQuickJumper:!0,total:Object.keys(s).length}),u=[{title:"id",dataIndex:"id",key:"id",render:d=>e.jsx("span",{children:d})},{title:"Name",dataIndex:"name",key:"name",render:(d,a)=>e.jsxs(g,{vertical:!0,gap:4,children:[e.jsx(T,{value:d,language:"en",style:{minWidth:150},onChange:i=>x(i.target.value,"en",a.id)}),e.jsx(T,{value:d,language:"pt",style:{minWidth:150},onChange:i=>x(i.target.value,"pt",a.id)})]})},{title:"Items",dataIndex:"itemsIds",key:"itemsIds",render:(d,a)=>e.jsx(g,{gap:6,wrap:"wrap",children:d.map(i=>e.jsxs(g,{gap:2,vertical:!0,children:[e.jsx(M,{onClick:()=>r(i),children:e.jsx(Q,{id:i,width:60})}),e.jsx(g,{justify:"center",children:e.jsx(v.Text,{onClick:()=>j(i),children:i})})]},`${a.id}-${i}`))},`items-${a.id}`)},G.EXPAND_COLUMN,{title:"Count",dataIndex:"itemsIds",key:"count",render:d=>I(d).filter(Boolean).length},{title:"Actions",dataIndex:"itemsIds",key:"actions",render:d=>e.jsx(z,{ids:d})}],f=p?t[p]:null;return e.jsxs(e.Fragment,{children:[e.jsx(G,{columns:u,dataSource:Object.values(s),className:"my-4",rowKey:"id",pagination:c,expandable:{expandedRowRender:d=>e.jsx(pe,{group:d,onUpdateGroupItems:l}),rowExpandable:()=>h.isSuccess}}),e.jsx(_,{title:"Edit Item Group",onClose:()=>r(null),open:!!f,children:f&&e.jsx(N,{item:f,itemGroups:o[f.id],groupsTypeahead:n,onUpdateItemGroups:m})})]})}function pe({group:s,onUpdateGroupItems:t}){const o=n=>{t(s.id,[...s.itemsIds,n])};return e.jsx("div",{children:e.jsx(J,{onFinish:o})})}function de({items:s,grousByItem:t,groupsTypeahead:o,onUpdateItemGroups:n}){const{is:m}=S(),l=m("emptyOnly"),x=b.useMemo(()=>l?Object.values(s).filter(p=>!t[p.id]):Object.values(s),[s,t,l]),{page:j,pagination:h}=L({data:x});return e.jsxs(e.Fragment,{children:[e.jsxs(v.Title,{level:2,children:["Groups by Items (",x.length,")"]}),e.jsx(k,{pagination:h,children:e.jsx(H,{gutter:[16,16],className:"my-4",children:j.map(p=>e.jsx(Y,{xs:24,sm:24,md:12,lg:6,xl:4,children:e.jsx(N,{item:p,itemGroups:t[p.id],groupsTypeahead:o,onUpdateItemGroups:n})},p.id))})})]})}function ce({data:s,save:t,isDirty:o,isSaving:n,entriesToUpdate:m}){const{queryParams:l,addParam:x,addParams:j,is:h}=S(),p=C("items");return e.jsxs(se,{children:[e.jsxs(g,{vertical:!0,gap:12,children:[e.jsx(re,{isDirty:o,onSave:t,isSaving:n,dirt:JSON.stringify(O(m))}),e.jsx(te,{data:()=>ue(s,p.data),fileName:"items-groups.json",disabled:o||y.isEmpty(p.data),block:!0})]}),e.jsx(R,{}),e.jsx(Z,{label:"Display",value:l.get("display")??"group",onChange:r=>j({display:r,page:1},{page:1}),options:[{title:"By Groups",icon:e.jsx(oe,{}),value:"group"},{title:"By Items",icon:e.jsx(ie,{}),value:"item"}]}),h("display","item")&&e.jsx(ee,{label:"No Groups Only",value:h("emptyOnly"),onChange:r=>x("emptyOnly",r,!1)})]})}function O(s){return y.omitBy(y.cloneDeep(s),t=>y.isEmpty(t.itemsIds))}function ue(s,t){return Object.keys(s).forEach(o=>{s[o].itemsIds=$(I(s[o].itemsIds));const n=s[o].itemsIds.length,m=s[o].itemsIds.filter(l=>t[l].nsfw).length;m>n*.3&&(s[o].nsfw=!0,console.log(`ðŸ˜ˆ Group ${s[o].name.pt} has ${m} (${Math.round(m/n*100)}%) NSFW items`))}),W(O(s))}function cs(){const s=ne({tdrResourceName:"items-groups",firebaseDataCollectionName:"itemsGroups",serialize:!0}),t=C("items");return e.jsx(E,{title:"Items",subtitle:"Groups Sets",children:e.jsxs(w,{hasSider:!0,children:[e.jsx(ae,{children:e.jsx(ce,{...s})}),e.jsx(w.Content,{className:"content",children:e.jsx(B,{isLoading:s.isLoading||t.isLoading,error:s.error||t.error,hasResponseData:!y.isEmpty(s.data)&&!y.isEmpty(t.data),children:e.jsx(me,{...s})})})]})})}export{cs as ItemsGroups,cs as default};
