import{r as x,a as D,_ as N,j as e,T as C,B as T,ao as _,aj as fe,G as E,D as se,an as ge,P as je,L as Y}from"./index-B5-2HM5B.js";import{D as xe}from"./DataLoadingWrapper-BaxBS94E.js";import{l as O,c as re,P as ye}from"./useBaseUrl-C81I6maY.js";import{u as M}from"./useQueryParams-C8unIuj1.js";import{u as be,R as we,a as ie,c as ve,n as Se,b as ke}from"./useTestimoniesResource-Jabgtqbt.js";import{g as Oe}from"./constants-BfM-7w-H.js";import{S as F}from"./SuspectImageCard-BZHQCPXL.js";import{u as Ce}from"./useTDResource-xEI3cILf.js";import{F as v}from"./index-D8zlra0v.js";import{T as ce,S as Te,F as Ie}from"./FilterEntries-Dq7WElh2.js";import{B as L,D as Re}from"./DownloadButton-BslZH4vt.js";import{S as A}from"./index-DA6KwYEn.js";import{u as oe}from"./useTableExpandableRows-CpV8STgO.js";import{u as ae}from"./useTablePagination-B_hNtmwq.js";import{P as G}from"./progress-yIRsuzuq.js";import{S as z}from"./index-CzxBrtg5.js";import{F as q}from"./Table-JtIs1uPt.js";import{I as Me}from"./index-IW2Ifu1c.js";import{u as Pe}from"./useCardWidth-ts6XmLZP.js";import{C as le}from"./index-DShwIIJ8.js";import{P as J}from"./index-D_SqxPc7.js";import{R as De}from"./FireFilled-_uKRWIHt.js";import{S as $}from"./SiderContent-hN9zjJ9h.js";import{F as K}from"./FirestoreConsoleLink-6lLrw1pf.js";import{S as Ne}from"./SaveButton-Cuebvwj3.js";import{S as Ee}from"./SuspectsStyleVariantSelector-BeAy6Fpm.js";import{g as Ae}from"./useGetFirestoreDoc-DRobRFSV.js";import{e as ze,a as Fe,d as Be}from"./index-DEfIxL-b.js";import{u as ue}from"./useWindowSize-C4HywTqg.js";import{M as de}from"./index-DSmOtqun.js";import{R as He}from"./TableOutlined-BTwTSTEF.js";import"./useResourceFirestoreData-BtutAPHc.js";import"./useUpdateFirestoreDoc-DlR13OHt.js";import"./useMutation-B7RcyywH.js";import"./moment-C5S46NFB.js";import"./ImageCard-Byv5aLWa.js";import"./gapSize-U1swVQyS.js";import"./index-7oODgzUU.js";import"./index-TVf6wIbH.js";import"./index-CKlL__AM.js";import"./index-Cydz4FrO.js";import"./scrollTo-89HbUyoz.js";import"./Pagination-ljPjtj9s.js";import"./extendsObject-keMuGWqj.js";import"./Input-BG1b9zQD.js";import"./SaveOutlined-LRTvDctr.js";import"./constants-DsjZWQx9.js";import"./Item-Cl0bkTHl.js";var $e={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M864 144H560c-8.8 0-16 7.2-16 16v304c0 8.8 7.2 16 16 16h304c8.8 0 16-7.2 16-16V160c0-8.8-7.2-16-16-16zm0 400H560c-8.8 0-16 7.2-16 16v304c0 8.8 7.2 16 16 16h304c8.8 0 16-7.2 16-16V560c0-8.8-7.2-16-16-16zM464 144H160c-8.8 0-16 7.2-16 16v304c0 8.8 7.2 16 16 16h304c8.8 0 16-7.2 16-16V160c0-8.8-7.2-16-16-16zm0 400H160c-8.8 0-16 7.2-16 16v304c0 8.8 7.2 16 16 16h304c8.8 0 16-7.2 16-16V560c0-8.8-7.2-16-16-16z"}}]},name:"appstore",theme:"filled"},Ve={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M512 624c93.9 0 170-75.2 170-168V232c0-92.8-76.1-168-170-168s-170 75.2-170 168v224c0 92.8 76.1 168 170 168zm330-170c0-4.4-3.6-8-8-8h-60c-4.4 0-8 3.6-8 8 0 140.3-113.7 254-254 254S258 594.3 258 454c0-4.4-3.6-8-8-8h-60c-4.4 0-8 3.6-8 8 0 168.7 126.6 307.9 290 327.6V884H326.7c-13.7 0-24.7 14.3-24.7 32v36c0 4.4 2.8 8 6.2 8h407.6c3.4 0 6.2-3.6 6.2-8v-36c0-17.7-11-32-24.7-32H548V782.1c165.3-18 294-158 294-328.1z"}}]},name:"audio",theme:"filled"},Le={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M594.3 601.5a111.8 111.8 0 0029.1-75.5c0-61.9-49.9-112-111.4-112s-111.4 50.1-111.4 112c0 29.1 11 55.5 29.1 75.5a158.09 158.09 0 00-74.6 126.1 8 8 0 008 8.4H407c4.2 0 7.6-3.3 7.9-7.5 3.8-50.6 46-90.5 97.2-90.5s93.4 40 97.2 90.5c.3 4.2 3.7 7.5 7.9 7.5H661a8 8 0 008-8.4c-2.8-53.3-32-99.7-74.7-126.1zM512 578c-28.5 0-51.7-23.3-51.7-52s23.2-52 51.7-52 51.7 23.3 51.7 52-23.2 52-51.7 52zm416-354H768v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H548v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H328v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H96c-17.7 0-32 14.3-32 32v576c0 17.7 14.3 32 32 32h832c17.7 0 32-14.3 32-32V256c0-17.7-14.3-32-32-32zm-40 568H136V296h120v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h148v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h148v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h120v496z"}}]},name:"contacts",theme:"outlined"},Ue={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M300 328a60 60 0 10120 0 60 60 0 10-120 0zM852 64H172c-17.7 0-32 14.3-32 32v660c0 17.7 14.3 32 32 32h680c17.7 0 32-14.3 32-32V96c0-17.7-14.3-32-32-32zm-32 660H204V128h616v596zM604 328a60 60 0 10120 0 60 60 0 10-120 0zm250.2 556H169.8c-16.5 0-29.8 14.3-29.8 32v36c0 4.4 3.3 8 7.4 8h729.1c4.1 0 7.4-3.6 7.4-8v-36c.1-17.7-13.2-32-29.7-32zM664 508H360c-4.4 0-8 3.6-8 8v60c0 4.4 3.6 8 8 8h304c4.4 0 8-3.6 8-8v-60c0-4.4-3.6-8-8-8z"}}]},name:"robot",theme:"outlined"},qe={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M870 126H663.8c-17.4 0-32.9 11.9-37 29.3C614.3 208.1 567 246 512 246s-102.3-37.9-114.8-90.7a37.93 37.93 0 00-37-29.3H154a44 44 0 00-44 44v252a44 44 0 0044 44h75v388a44 44 0 0044 44h478a44 44 0 0044-44V466h75a44 44 0 0044-44V170a44 44 0 00-44-44z"}}]},name:"skin",theme:"filled"},Qe={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M868 160h-92v-40c0-4.4-3.6-8-8-8H256c-4.4 0-8 3.6-8 8v40h-92a44 44 0 00-44 44v148c0 81.7 60 149.6 138.2 162C265.6 630.2 359 721.8 476 734.5v105.2H280c-17.7 0-32 14.3-32 32V904c0 4.4 3.6 8 8 8h512c4.4 0 8-3.6 8-8v-32.3c0-17.7-14.3-32-32-32H548V734.5C665 721.8 758.4 630.2 773.8 514 852 501.6 912 433.7 912 352V204a44 44 0 00-44-44zM248 439.6c-37.1-11.9-64-46.7-64-87.6V232h64v207.6zM840 352c0 41-26.9 75.8-64 87.6V232h64v120z"}}]},name:"trophy",theme:"filled"};function We(){var t=x.useRef(!0);return t.current?(t.current=!1,!0):t.current}function _e(t,i){return typeof t=="function"?t.length?t(i):t():t}function he(t,i,o){if(i===void 0&&(i=10),i<1)throw new Error("Capacity has to be greater than 1, got '"+i+"'");var l=We(),m=x.useState(t),f=m[0],h=m[1],a=x.useRef([]),s=x.useRef(0);l&&(a.current.length?(a.current[a.current.length-1]!==t&&a.current.push(t),a.current.length>i&&(a.current=a.current.slice(a.current.length-i))):a.current.push(t),s.current=a.current.length&&a.current.length-1);var b=x.useCallback(function(r){h(function(c){return r=_e(r,c),r!==c&&(s.current<a.current.length-1&&(a.current=a.current.slice(0,s.current+1)),s.current=a.current.push(r)-1,a.current.length>i&&(a.current=a.current.slice(a.current.length-i))),r})},[f,i]),u=x.useMemo(function(){return{history:a.current,position:s.current,capacity:i,back:function(r){r===void 0&&(r=1),s.current&&h(function(){return s.current-=Math.min(r,s.current),a.current[s.current]})},forward:function(r){r===void 0&&(r=1),s.current!==a.current.length-1&&h(function(){return s.current=Math.min(s.current+r,a.current.length-1),a.current[s.current]})},go:function(r){r!==s.current&&h(function(){return s.current=r<0?Math.max(a.current.length+r,0):Math.min(a.current.length-1,r),a.current[s.current]})}}},[f]);return[f,b,u]}var Ye=function(i,o){return x.createElement(D,N({},i,{ref:o,icon:$e}))},Ge=x.forwardRef(Ye),Je=function(i,o){return x.createElement(D,N({},i,{ref:o,icon:Ve}))},Ke=x.forwardRef(Je),Xe=function(i,o){return x.createElement(D,N({},i,{ref:o,icon:Le}))},Ze=x.forwardRef(Xe),et=function(i,o){return x.createElement(D,N({},i,{ref:o,icon:Ue}))},tt=x.forwardRef(et),nt=function(i,o){return x.createElement(D,N({},i,{ref:o,icon:qe}))},st=x.forwardRef(nt),rt=function(i,o){return x.createElement(D,N({},i,{ref:o,icon:Qe}))},X=x.forwardRef(rt);function it(){const[t,i]=x.useState({batchSize:1,history:{}}),o=x.useRef(1),{entries:l}=be(!0,"pt",t.batchSize,t.history),m=Ce("suspects",!O.isEmpty(l));return console.log(ot(l,m.data??{})),e.jsxs(v,{vertical:!0,gap:12,className:"p-4",children:[e.jsxs(v,{justify:"space-between",align:"center",children:[e.jsx(C.Title,{level:4,className:"my-0",children:"Espionagem Simulator"}),e.jsxs(v,{gap:6,children:[e.jsx(ce,{min:1,max:100,defaultValue:1,onChange:f=>{o.current=f??1}}),e.jsx(T,{type:"primary",onClick:()=>i({batchSize:o.current,history:{}}),children:"Re-run Simulation"})]})]}),e.jsx(ct,{entries:l})]})}function ct({entries:t}){const[i,o]=x.useState(!1),l=Oe(),m=t[l],f=x.useMemo(()=>m?m.statements.reduce((h,a)=>{const{excludes:s}=a;return s.forEach(b=>{h[b]?h[b]++:h[b]=1}),h},{}):{},[m]);return e.jsxs("div",{className:"full-width grid",style:{gridTemplateColumns:"2fr 3fr"},children:[e.jsx(we,{src:t??{},theme:"twilight",collapsed:3}),e.jsx("div",{children:m&&e.jsxs(v,{gap:18,className:"p-4",children:[e.jsx("div",{children:e.jsx("div",{style:{width:`${105*4}px`,display:"grid",gap:"6px",gridTemplateColumns:"repeat(4, 1fr)"},children:m.suspects.map(h=>e.jsxs(L.Ribbon,{text:i?f[h.id]:null,color:"cyan",children:[e.jsx(F,{id:h.id,width:96,className:re(i&&h.id===m.culpritId&&"red-border")},h.id),e.jsxs(v,{gap:6,align:"center",children:[e.jsx(A,{checkedChildren:"🚫",size:"small"})," ",h.id]})]},h.id))})}),e.jsxs("div",{children:[e.jsx("div",{children:e.jsx(A,{checkedChildren:"Show Culprit",unCheckedChildren:"Hide Culprit",checked:i,onChange:o})}),m.statements.map(h=>e.jsx(C.Paragraph,{children:e.jsx(L,{count:h.excludes.length,color:"cyan",children:e.jsx(_,{message:h.text,banner:!0,type:"info",icon:Z(h.type)},h.key)})},h.key)),m.additionalStatements.map(h=>e.jsx(C.Paragraph,{children:e.jsx(L,{count:h.excludes.length,color:"cyan",children:e.jsx(_,{message:h.text,banner:!0,type:"warning",icon:Z(h.type)},h.key)})},h.key))]})]})})]})}const Z=t=>{switch(t){case"testimony":return e.jsx(Ke,{});case"feature":return e.jsx(st,{});case"grid":return e.jsx(Ge,{});default:return"❓"}},ot=(t,i)=>{const o=Object.values(t).reduce((l,m)=>(m.suspects.forEach(f=>{l[f.id]=(l[f.id]||0)+1,f.id===m.culpritId&&(l[`${f.id}_culprit`]=(l[`${f.id}_culprit`]||0)+1)}),l),{});return Object.values(i).forEach(l=>{o[l.id]||(o[l.id]=0),o[`${l.id}_culprit`]||(o[`${l.id}_culprit`]=0)}),o};function me({suspect:t,values:i,resolution:o,projection:l,yesPercentage:m,noPercentage:f,complete:h,enoughData:a,testimonyId:s,addEntryToUpdate:b,answers:u,barWidth:r,showName:c}){const n=j=>{const d={...u};d[j]=[...d[j]||[],3],b(s,d)},g=j=>{const d={...u};d[j]=[...d[j]||[],-3],b(s,d)},k=j=>{var w;const d={...u},p=(w=d[j])==null?void 0:w.findIndex(S=>S===3);p!==-1&&p!==void 0&&(d[j]=[...d[j].slice(0,p),...d[j].slice(p+1)]),b(s,d)},y=j=>{var w;const d={...u},p=(w=d[j])==null?void 0:w.findIndex(S=>S===-3);p!==-1&&p!==void 0&&(d[j]=[...d[j].slice(0,p),...d[j].slice(p+1)]),b(s,d)};return e.jsxs(fe,{trigger:"click",title:`Add strong fit/unfit answer to ${t.name.pt}`,content:e.jsxs(v,{vertical:!0,gap:4,children:[e.jsx(C.Text,{type:"secondary",children:i.join(", ")}),e.jsxs(T,{icon:"👍",block:!0,onClick:()=>n(t.id),children:[" ","Add strong fit"]}),e.jsxs(T,{icon:"👎",block:!0,onClick:()=>g(t.id),children:[" ","Add strong unfit"]}),e.jsxs(z.Compact,{children:[e.jsx(T,{icon:"❌",size:"small",block:!0,onClick:()=>k(t.id),children:"fit"}),e.jsx(T,{icon:"❌",size:"small",block:!0,onClick:()=>y(t.id),children:"unfit"})]})]}),children:[c&&e.jsxs("div",{children:[e.jsx(E,{title:t.id,children:t.name.pt})," ",h&&e.jsx(E,{title:"Complete: It has 5 or more answers",children:e.jsx(X,{style:{color:"gold"}})})]}),e.jsxs(v,{align:"flex-start",gap:12,children:[e.jsx(E,{title:`Values: ${i.join(", ")} : ${o||(l?`${l}*`:"")}`,children:a?e.jsx(G,{percent:f+m,size:[r,20],status:"exception",success:{percent:m},showInfo:!1}):e.jsx(G,{percent:f+m,size:[r,10],status:"exception",success:{percent:m},showInfo:!1})}),!c&&h&&e.jsx(E,{title:"Complete: It has 5 or more answers",children:e.jsx(X,{style:{color:"gold"}})})]})]})}function at({suspect:t,answersPerQuestion:i={},questions:o,addEntryToUpdate:l,allAnswers:m}){const{queryParams:f}=M({sortSuspectsBy:"answers"}),h=f.get("sortSuspectsBy")??"answers",a=x.useMemo(()=>{const u=Object.values(o).map(r=>{const c=i[r.id]??{},{enoughData:n,reliable:g,yesPercentage:k,noPercentage:y,blankPercentage:j,values:d,total:p,resolution:w,projection:S,complete:R}=ie(t.id,{[t.id]:c});return{id:r.id,question:r,enoughData:n,reliable:g,yesPercentage:k,noPercentage:y,blankPercentage:j,values:d,total:p,resolution:w,projection:S,complete:R}});return h==="answers"?O.orderBy(u,["reliable","enoughData","yesPercentage",r=>r.values.length],["desc","desc","desc","desc"]):O.orderBy(u,r=>Number(r.id.split("-")[1]),["asc"])},[i,o,t.id,h]),s=x.useMemo(()=>lt(t,a),[t,a]),b=[{key:"id",title:"Id",dataIndex:"id"},{key:"question",title:"Question",dataIndex:"question",render:u=>u.question},{key:"answer",title:"Answer",dataIndex:"id",sorter:(u,r)=>u.total-r.total,render:u=>{const r=a.find(c=>c.id===u);return r?e.jsx(v,{gap:8,wrap:"nowrap",children:e.jsx(me,{values:r.values,resolution:r.resolution,projection:r.projection,yesPercentage:r.yesPercentage,noPercentage:r.noPercentage,complete:r.complete,enoughData:r.enoughData,suspect:t,testimonyId:r.question.id,answers:m[r.question.id]||{},addEntryToUpdate:l,barWidth:120})}):""}}];return e.jsxs(z,{wrap:!0,size:"large",children:[e.jsx(q,{rowKey:"id",columns:b,dataSource:a,bordered:!0}),e.jsxs(v,{gap:8,vertical:!0,children:[e.jsx(C.Title,{level:5,children:"Suspect Description"}),e.jsx(Me.TextArea,{value:s,readOnly:!0,className:"full-width",rows:7})]})]})}const lt=(t,i)=>{const o=i.filter(l=>l.resolution||l.projection).map(l=>{const{question:m,resolution:f,projection:h}=l,a=f||h;return`${t.gender==="male"?"ele":"ela"} ${a==="👍"?"":"não "}${m.answer.toLocaleLowerCase()}`});return`${t.name.pt}: ${o.join(", ")}`};function ut({isLoading:t,isSuccess:i,questions:o,data:l,suspects:m,addEntryToUpdate:f}){const{queryParams:h,addParam:a}=M(),s=x.useMemo(()=>Object.keys(l).reduce((n,g)=>{const k=l[g]??{};return Object.keys(k).forEach(y=>{n[y]||(n[y]={}),n[y][g]=k[y]}),n},{}),[l]),b=x.useMemo(()=>O.orderBy(Object.values(m).map(n=>({...n,answers:s[n.id]})),n=>Number(n.id.split("-")[1]),"asc"),[m,s]),u=ae({total:b.length,showQuickJumper:!0}),r=[{title:"Id",dataIndex:"id",key:"id",sorter:(n,g)=>Number(n.id.split("-")[1])-Number(g.id.split("-")[1])},{title:"Picture",dataIndex:"id",render:n=>e.jsx(F,{id:n,width:48})},{title:"Name",dataIndex:"name",key:"name",sorter:(n,g)=>n.name.pt.localeCompare(g.name.pt),render:(n,g)=>e.jsxs(v,{vertical:!0,children:[e.jsx(C.Text,{children:n.pt}),e.jsx(C.Text,{type:"secondary",children:n.en}),e.jsx(C.Text,{type:"secondary",italic:!0,children:e.jsx("small",{children:g.note})})]})},{title:"Questions Answered",dataIndex:"answers",key:"answers",sorter:(n,g)=>Object.keys(n.answers??{}).length-Object.keys(g.answers??{}).length,render:n=>n?Object.values(n).length:""}],c=oe({maxExpandedRows:1,expandedRowRender:n=>e.jsx(at,{suspect:n,answersPerQuestion:s[n.id],questions:o,addEntryToUpdate:f,allAnswers:l}),rowExpandable:()=>i});return e.jsxs(v,{gap:12,className:"full-width py-4",vertical:!0,children:[e.jsxs(v,{justify:"space-between",align:"center",children:[e.jsx(C.Title,{level:4,className:"my-0",children:"Testimonies by Suspect"}),e.jsx(A,{checked:h.get("sortSuspectsBy")==="answers",onChange:n=>a("sortSuspectsBy",n?"answers":"id"),checkedChildren:"Sort by Answers",unCheckedChildren:"Sort by Id"})]}),e.jsx(q,{columns:r,dataSource:b,pagination:u,rowKey:"id",expandable:c,loading:t,bordered:!0,className:"full-width"})]})}function dt({answers:t,suspects:i,addEntryToUpdate:o,testimonyId:l}){const[m,f]=Pe(12),{queryParams:h,is:a}=M({sortSuspectsBy:"answers"}),s=a("enableBatch"),b=h.get("sortSuspectsBy")??"answers",u=x.useMemo(()=>{const n=Object.keys(i).map(g=>ie(g,t));return b==="answers"?O.orderBy(n,["reliable","enoughData",g=>g.values.length,"yesPercentage","noPercentage",g=>Number(g.suspectCardId.split("-")[1])],["desc","desc","desc","desc","desc","asc"]):O.orderBy(n,g=>Number(g.suspectCardId.split("-")[1]),["asc"])},[t,i,b]),[r,c]=x.useState([]);return e.jsxs(z,{direction:"vertical",children:[e.jsx(ht,{selection:r,setSelection:c,suspects:i,addEntryToUpdate:o,list:u,testimonyId:l,answers:t}),e.jsx(z,{wrap:!0,ref:f,size:"large",children:u.map(n=>e.jsxs(v,{vertical:!0,gap:6,className:re({"selection-outline":s&&r.includes(n.suspectCardId)}),children:[e.jsx(F,{id:n.imageId,width:m,className:n.values.length>1?void 0:"grayscale"}),e.jsxs(v,{gap:4,children:[s&&e.jsx(le,{disabled:n.complete,checked:r.includes(n.suspectCardId),onChange:g=>{const k=g.target.checked;c(y=>k?[...y,n.suspectCardId]:y.filter(j=>j!==n.suspectCardId))}}),e.jsx(me,{values:n.values,resolution:n.resolution,projection:n.projection,yesPercentage:n.yesPercentage,noPercentage:n.noPercentage,complete:n.complete,enoughData:n.enoughData,suspect:i[n.suspectCardId],testimonyId:l,answers:t,addEntryToUpdate:o,barWidth:m,showName:!0})]})]},n.suspectCardId))})]})}function ht({testimonyId:t,selection:i,setSelection:o,suspects:l,addEntryToUpdate:m,list:f,answers:h}){const[a,s]=x.useState([]),{addParam:b,removeParam:u,is:r}=M({sortSuspectsBy:"answers"}),c=r("enableBatch"),n=y=>{s(j=>j.includes(y)?j.filter(d=>d!==y):[...j,y])},g=x.useMemo(()=>O.keyBy(f,"suspectCardId"),[f]);x.useEffect(()=>{if(a.length===0&&i.length>0){o([]);return}if(!a.length)return;const j=(i.length>0?i:Object.values(g).filter(d=>!d.complete&&!d.values.includes(3)&&!d.values.includes(-3)).map(d=>d.suspectCardId)).filter(d=>{const p=l[d],w=[p.gender,p.ethnicity,p.build,p.height];return p.age==="18-21"&&w.push("young"),(p.age==="21-30"||p.age==="30-40")&&w.push("adult"),p.age==="40-50"&&w.push("parent"),(p.age==="50-60"||p.age==="60-70"||p.age==="70-80"||p.age==="80-90")&&w.push("senior"),a.every(S=>w.includes(S))});o(j)},[a]);const k=y=>{const j=O.cloneDeep(h);i.forEach(d=>{j[d]=[...j[d]||[],y]}),m(t,j),s([])};return e.jsxs(v,{align:"center",gap:6,justify:"space-between",className:"mb-4",children:[e.jsxs(v,{gap:3,children:[e.jsx(C.Text,{className:"nowrap",style:{minWidth:"5ch"},children:"Batch"}),e.jsx(A,{value:c,checkedChildren:"On",unCheckedChildren:"Off",onChange:y=>{y?b("enableBatch",!0):u("enableBatch")}})]}),c&&e.jsxs(e.Fragment,{children:[e.jsxs(C.Text,{className:"nowrap mr-2",children:["Selected ",i.length]}),e.jsxs(v,{gap:6,wrap:!0,align:"center",justify:"center",children:[e.jsx(I,{filter:"male",activeFilters:a,updateActiveFilter:n}),e.jsx(I,{filter:"female",activeFilters:a,updateActiveFilter:n}),e.jsx(I,{filter:"young",activeFilters:a,updateActiveFilter:n}),e.jsx(I,{filter:"adult",activeFilters:a,updateActiveFilter:n}),e.jsx(I,{filter:"parent",activeFilters:a,updateActiveFilter:n}),e.jsx(I,{filter:"senior",activeFilters:a,updateActiveFilter:n}),e.jsx(I,{filter:"thin",activeFilters:a,updateActiveFilter:n}),e.jsx(I,{filter:"muscular",activeFilters:a,updateActiveFilter:n}),e.jsx(I,{filter:"large",activeFilters:a,updateActiveFilter:n}),e.jsx(I,{filter:"asian",activeFilters:a,updateActiveFilter:n}),e.jsx(I,{filter:"black",activeFilters:a,updateActiveFilter:n}),e.jsx(I,{filter:"caucasian",activeFilters:a,updateActiveFilter:n}),e.jsx(I,{filter:"latino",activeFilters:a,updateActiveFilter:n})]}),e.jsxs(v,{align:"center",gap:6,children:[e.jsx(T,{onClick:()=>s([]),danger:!0,size:"small",children:"Clear"}),e.jsx(J,{title:"Apply +3 to selected suspects?",onConfirm:()=>k(3),children:e.jsx(T,{disabled:i.length===0,size:"small",type:"primary",className:"ml-10",children:"Apply +3"})}),e.jsx(se,{type:"vertical"}),e.jsx(J,{title:"Apply -3 to selected suspects?",onConfirm:()=>k(-3),children:e.jsx(T,{disabled:i.length===0,size:"small",type:"primary",children:"Apply -3"})})]})]})]})}function I({filter:t,activeFilters:i,updateActiveFilter:o}){return e.jsxs(e.Fragment,{children:[e.jsxs("span",{children:[e.jsx(le,{checked:i.includes(t),onClick:()=>o(t)})," ",O.capitalize(t)]}),e.jsx(se,{type:"vertical"})]})}function mt({data:t,questions:i,suspects:o,isLoading:l,isSuccess:m,addEntryToUpdate:f}){const{queryParams:h,addParam:a}=M(),s=x.useMemo(()=>O.orderBy(Object.values(i).map(c=>({...c,answersCount:Object.values(t[c.id]??{}).length})),c=>Number(c.id.split("-")[1]),"asc"),[i]),b=ae({total:s.length,showQuickJumper:!0}),u=[{title:"Id",dataIndex:"id",key:"id",sorter:(c,n)=>Number(c.id.split("-")[1])-Number(n.id.split("-")[1])},{title:"Question",dataIndex:"question",key:"question",sorter:(c,n)=>c.question.localeCompare(n.question)},{title:"NSFW",dataIndex:"nsfw",key:"nsfw",render:c=>c?e.jsx(De,{style:{color:"hotPink"}}):"",sorter:(c,n)=>Number(c.nsfw)-Number(n.nsfw)},{title:"Answers",dataIndex:"answersCount",key:"answersCount",sorter:(c,n)=>c.answersCount-n.answersCount}],r=oe({maxExpandedRows:1,expandedRowRender:c=>e.jsx(dt,{testimonyId:c.id,answers:t[c.id]??{},suspects:o,addEntryToUpdate:f}),rowExpandable:()=>m});return e.jsxs(v,{gap:12,className:"full-width py-4",vertical:!0,children:[e.jsxs(v,{justify:"space-between",align:"center",children:[e.jsx(C.Title,{level:4,className:"my-0",children:"Suspects by Testimony"}),e.jsx(A,{checked:h.get("sortSuspectsBy")==="answers",onChange:c=>a("sortSuspectsBy",c?"answers":"id"),checkedChildren:"Sort by Answers",unCheckedChildren:"Sort by Id"})]}),e.jsx(q,{columns:u,dataSource:s,pagination:b,rowKey:"id",expandable:r,loading:l,bordered:!0,className:"full-width"})]})}function pt(t){const{queryParams:i,is:o}=M();return e.jsxs(e.Fragment,{children:[(o("display","questions")||!i.get("display"))&&e.jsx(mt,{...t}),o("display","suspects")&&e.jsx(ut,{...t}),o("display","simulator")&&e.jsx(it,{})]})}const ft="Left",gt="Right",jt="Up",xt="Down",P={delta:10,preventScrollOnSwipe:!1,rotationAngle:0,trackMouse:!1,trackTouch:!0,swipeDuration:1/0,touchEventOptions:{passive:!0}},U={first:!0,initial:[0,0],start:0,swiping:!1,xy:[0,0]},ee="mousemove",te="mouseup",yt="touchend",bt="touchmove",wt="touchstart";function vt(t,i,o,l){return t>i?o>0?gt:ft:l>0?xt:jt}function ne(t,i){if(i===0)return t;const o=Math.PI/180*i,l=t[0]*Math.cos(o)+t[1]*Math.sin(o),m=t[1]*Math.cos(o)-t[0]*Math.sin(o);return[l,m]}function St(t,i){const o=u=>{const r="touches"in u;r&&u.touches.length>1||t((c,n)=>{n.trackMouse&&!r&&(document.addEventListener(ee,l),document.addEventListener(te,h));const{clientX:g,clientY:k}=r?u.touches[0]:u,y=ne([g,k],n.rotationAngle);return n.onTouchStartOrOnMouseDown&&n.onTouchStartOrOnMouseDown({event:u}),Object.assign(Object.assign(Object.assign({},c),U),{initial:y.slice(),xy:y,start:u.timeStamp||0})})},l=u=>{t((r,c)=>{const n="touches"in u;if(n&&u.touches.length>1)return r;if(u.timeStamp-r.start>c.swipeDuration)return r.swiping?Object.assign(Object.assign({},r),{swiping:!1}):r;const{clientX:g,clientY:k}=n?u.touches[0]:u,[y,j]=ne([g,k],c.rotationAngle),d=y-r.xy[0],p=j-r.xy[1],w=Math.abs(d),S=Math.abs(p),R=(u.timeStamp||0)-r.start,B=Math.sqrt(w*w+S*S)/(R||1),pe=[d/(R||1),p/(R||1)],V=vt(w,S,d,p),Q=typeof c.delta=="number"?c.delta:c.delta[V.toLowerCase()]||P.delta;if(w<Q&&S<Q&&!r.swiping)return r;const H={absX:w,absY:S,deltaX:d,deltaY:p,dir:V,event:u,first:r.first,initial:r.initial,velocity:B,vxvy:pe};H.first&&c.onSwipeStart&&c.onSwipeStart(H),c.onSwiping&&c.onSwiping(H);let W=!1;return(c.onSwiping||c.onSwiped||c[`onSwiped${V}`])&&(W=!0),W&&c.preventScrollOnSwipe&&c.trackTouch&&u.cancelable&&u.preventDefault(),Object.assign(Object.assign({},r),{first:!1,eventData:H,swiping:!0})})},m=u=>{t((r,c)=>{let n;if(r.swiping&&r.eventData){if(u.timeStamp-r.start<c.swipeDuration){n=Object.assign(Object.assign({},r.eventData),{event:u}),c.onSwiped&&c.onSwiped(n);const g=c[`onSwiped${n.dir}`];g&&g(n)}}else c.onTap&&c.onTap({event:u});return c.onTouchEndOrOnMouseUp&&c.onTouchEndOrOnMouseUp({event:u}),Object.assign(Object.assign(Object.assign({},r),U),{eventData:n})})},f=()=>{document.removeEventListener(ee,l),document.removeEventListener(te,h)},h=u=>{f(),m(u)},a=(u,r)=>{let c=()=>{};if(u&&u.addEventListener){const n=Object.assign(Object.assign({},P.touchEventOptions),r.touchEventOptions),g=[[wt,o,n],[bt,l,Object.assign(Object.assign({},n),r.preventScrollOnSwipe?{passive:!1}:{})],[yt,m,n]];g.forEach(([k,y,j])=>u.addEventListener(k,y,j)),c=()=>g.forEach(([k,y])=>u.removeEventListener(k,y))}return c},b={ref:u=>{u!==null&&t((r,c)=>{if(r.el===u)return r;const n={};return r.el&&r.el!==u&&r.cleanUpTouch&&(r.cleanUpTouch(),n.cleanUpTouch=void 0),c.trackTouch&&u&&(n.cleanUpTouch=a(u,c)),Object.assign(Object.assign(Object.assign({},r),{el:u}),n)})}};return i.trackMouse&&(b.onMouseDown=o),[b,a]}function kt(t,i,o,l){return!i.trackTouch||!t.el?(t.cleanUpTouch&&t.cleanUpTouch(),Object.assign(Object.assign({},t),{cleanUpTouch:void 0})):t.cleanUpTouch?i.preventScrollOnSwipe!==o.preventScrollOnSwipe||i.touchEventOptions.passive!==o.touchEventOptions.passive?(t.cleanUpTouch(),Object.assign(Object.assign({},t),{cleanUpTouch:l(t.el,i)})):t:Object.assign(Object.assign({},t),{cleanUpTouch:l(t.el,i)})}function Ot(t){const{trackMouse:i}=t,o=x.useRef(Object.assign({},U)),l=x.useRef(Object.assign({},P)),m=x.useRef(Object.assign({},l.current));m.current=Object.assign({},l.current),l.current=Object.assign(Object.assign({},P),t);let f;for(f in P)l.current[f]===void 0&&(l.current[f]=P[f]);const[h,a]=x.useMemo(()=>St(s=>o.current=s(o.current,l.current),{trackMouse:i}),[i]);return o.current=kt(o.current,l.current,m.current,a),h}function Ct(t){const{addParam:i}=M();return e.jsxs(v,{vertical:!0,gap:8,children:[e.jsx(T,{onClick:()=>i("testify","single"),block:!0,children:"Testify Drawer"}),e.jsx(T,{onClick:()=>i("testify","group"),block:!0,children:"Testify Group"}),e.jsx(Tt,{...t}),e.jsx(It,{...t})]})}function Tt({suspects:t,questions:i,answers:o,addEntryToUpdate:l}){var j;const{width:m,height:f}=ue(),{is:h,removeParam:a}=M(),[s,b,u]=he(),r=Ot({onSwipedLeft:()=>alert("Swiped Left"),onSwipedRight:()=>alert("Swiped Right"),onSwipedUp:()=>alert("Swiped Up"),preventScrollOnSwipe:!0,trackTouch:!0,trackMouse:!0}),c=()=>{b({suspectId:O.sample(Object.keys(t))||null,testimonyId:O.sample(Object.keys(i))||null})},n=()=>{c()},g=()=>{if(s!=null&&s.suspectId&&(s!=null&&s.testimonyId)){const d=O.cloneDeep(o[(s==null?void 0:s.testimonyId)??""]??{});d[s.suspectId]=[...d[s.suspectId]||[],1],l(s.testimonyId??"",d),c()}},k=()=>{if(s!=null&&s.suspectId&&(s!=null&&s.testimonyId)){const d=O.cloneDeep(o[(s==null?void 0:s.testimonyId)??""]??{});d[s.suspectId]=[...d[s.suspectId]||[],0],l(s.testimonyId??"",d),c()}},y=!!(s!=null&&s.suspectId)&&!!(s!=null&&s.testimonyId);return e.jsx(de,{title:e.jsx(C,{children:"Does this person do this??"}),open:h("testify","single"),onCancel:()=>a("testify"),maskClosable:!1,width:m-64,footer:null,children:e.jsxs("div",{...r,children:[y&&e.jsxs(v,{vertical:!0,gap:8,className:"mb-8",justify:"center",align:"center",children:[e.jsx(F,{id:s.suspectId??"",width:Math.max(f/4,128)}),e.jsx(C.Title,{level:5,className:"text-center",children:(j=i[s.testimonyId??""])==null?void 0:j.question})]}),e.jsxs(z.Compact,{block:!0,size:"large",className:"mb-8",children:[e.jsx(T,{block:!0,icon:"👎",disabled:!y,style:{height:64},onClick:k,children:"No"}),e.jsx(T,{block:!0,onClick:n,style:{height:64},children:"Skip"}),e.jsx(T,{block:!0,icon:"👍",iconPosition:"end",disabled:!y,style:{height:64},onClick:g,children:"Yes"})]})]})})}function It({suspects:t,questions:i,answers:o,addEntryToUpdate:l}){var j;const{width:m,height:f}=ue(),{is:h,removeParam:a}=M(),[s,b,u]=he(),[r,c]=x.useState(6),n=()=>{var p;const d=(p=O.sampleSize(Object.keys(t),r))==null?void 0:p.reduce((w,S)=>(w[S]=null,w),{});b({suspectsIds:d,testimonyId:O.sample(Object.keys(i))||null})};ge(()=>n());const g=()=>{const d=Object.entries((s==null?void 0:s.suspectsIds)??{}).reduce((p,[w,S])=>(S!==null&&(p[w]=[S]),p),{});if(s!=null&&s.testimonyId&&Object.keys(d).length>0){const p=O.cloneDeep(o[s.testimonyId]??{});Object.entries(d).forEach(([w,S])=>{p[w]=[...p[w]||[],...S]}),l(s.testimonyId,p)}else console.log("No testimonyId or no judged suspects found, likely skipped");n()},k=!!(s!=null&&s.suspectsIds)&&!!(s!=null&&s.testimonyId),y=d=>{b(p=>{if(!p)return p;const w=Object.entries(p.suspectsIds).reduce((S,[R,B])=>(S[R]=B===null?d:B,S),{});return{...p,suspectsIds:w}})};return e.jsx(de,{title:e.jsx(C,{children:"Do these people do this??"}),open:h("testify","group"),onCancel:()=>a("testify"),maskClosable:!1,width:m-64,footer:null,children:e.jsxs("div",{children:[k&&e.jsxs(v,{vertical:!0,gap:8,className:"mb-8",justify:"center",align:"center",children:[e.jsxs(C.Text,{children:["Number of Suspects:",e.jsx(ce,{value:r,onChange:d=>c(d??6)})]}),e.jsx(C.Title,{level:4,className:"text-center",children:(j=i[s.testimonyId??""])==null?void 0:j.question}),e.jsx(v,{wrap:"wrap",justify:"center",gap:8,children:Object.keys(s.suspectsIds).map(d=>{var p,w;return e.jsxs(v,{justify:"center",align:"center",vertical:!0,children:[e.jsx(C.Text,{className:"text-center",children:((w=(p=t[d])==null?void 0:p.name)==null?void 0:w.pt)||"Unknown"}),e.jsx(F,{id:d,width:Math.min(Math.max(f/3,128),128)},d),e.jsx(Te,{shape:"round",size:"large",value:s.suspectsIds[d],onChange:S=>b(R=>R&&{...R,suspectsIds:{...R.suspectsIds,[d]:S}}),options:[{value:0,icon:"👎"},{value:null,icon:"♾"},{value:1,icon:"👍"}]})]},d)})})]}),e.jsxs(v,{justify:"space-between",align:"center",className:"mt-8",children:[e.jsx("span",{}),e.jsxs(v,{gap:8,children:[e.jsx(T,{onClick:()=>y(0),children:"Set all ♾ to 👎"}),e.jsx(T,{onClick:()=>y(1),children:"Set all ♾ to 👍"})]}),e.jsx(T,{onClick:g,size:"large",children:"Next Set"})]})]})})}function Rt({suspects:t,questions:i,data:o,hasNewData:l,isDirty:m,save:f,isSaving:h,entriesToUpdate:a,addEntryToUpdate:s}){const{queryParams:b,addParams:u}=M(),r=x.useMemo(()=>{const c={};return Object.values(o).forEach(n=>{Object.keys(n).forEach(g=>{n[g]&&(c[g]||(c[g]=0),ve(n[g])>=5&&(c[g]+=1))})}),{queriedTestimoniesCount:Object.keys(o).length,suspectsCount:Object.keys(c).length,reliableSuspectsCount:Object.values(c).filter(n=>n>=5).length}},[o]);return e.jsxs(e.Fragment,{children:[e.jsx($,{children:e.jsxs(v,{vertical:!0,gap:12,children:[e.jsx(Ne,{isDirty:m,onSave:f,isSaving:h,dirt:JSON.stringify(a)}),e.jsx(Re,{data:async()=>await Mt(o),fileName:"testimony-answers.json",disabled:m,hasNewData:l,block:!0}),e.jsx(K,{path:"data/testimonies",className:"text-center",label:"Firestore Data"}),e.jsx(K,{path:"tdr/testimonies",className:"text-center",label:"Firestore TDR"})]})}),e.jsxs($,{children:[e.jsx(Ie,{label:"Display",value:b.get("display")??"questions",onChange:c=>u({display:c,page:1},{page:1}),options:[{title:"Questions",icon:e.jsx(He,{}),value:"questions"},{title:"Suspects",icon:e.jsx(Ze,{}),value:"suspects"},{title:"Simulator",icon:e.jsx(tt,{}),value:"simulator"}]}),e.jsx(Ee,{})]}),e.jsx($,{children:e.jsxs("div",{style:{fontSize:"0.85em"},children:[e.jsx("strong",{children:"Legend"}),e.jsxs("ul",{children:[e.jsx("li",{children:"Reliability: At least 5 votes"}),e.jsx("li",{children:"Large Bars: There's enough data (at least 3)"}),e.jsx("li",{children:"Small blue bar: in progress negative"})]})]})}),e.jsxs($,{children:[e.jsxs("div",{style:{fontSize:"0.85em"},children:[e.jsx("strong",{children:"Counts"}),e.jsxs("ul",{children:[e.jsxs("li",{children:["Testimonies: ",r.queriedTestimoniesCount]}),e.jsxs("li",{children:["Suspects: ",r.suspectsCount]}),e.jsx("li",{children:e.jsxs(E,{title:"A reliable suspect is one that has at least 5 complete testimonies.",children:["Reliable suspects: ",r.reliableSuspectsCount]})})]})]}),e.jsx(Ct,{suspects:t,questions:i,answers:o,addEntryToUpdate:s})]})]})}async function Mt(t){console.log("Preparing file for download...x");const i=await Ae("data","testimonies")(),o=ze(i);console.log("Parsed data from Firestore:",o);const l=O.cloneDeep(t);return Object.keys(l).forEach(m=>{const f=l[m],h=o[m]||{};Object.keys(f).forEach(a=>{const s=h[a]||[],b=Se([...f[a],...s]);f[a]=b})}),Fe(Be(l))}function Cn(){const t=ke();return e.jsx(je,{title:"Testimonies",subtitle:"Suspect Testimony Rates",children:e.jsxs(Y,{hasSider:!0,children:[e.jsx(ye,{children:e.jsx(Rt,{...t})}),e.jsx(Y.Content,{className:"content",children:e.jsx(xe,{isLoading:t.isLoading,error:t.error,hasResponseData:!O.isEmpty(t.data),children:e.jsx(pt,{...t})})})]})})}export{Cn as TestimoniesPage,Cn as default};
