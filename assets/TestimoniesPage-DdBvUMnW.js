import{r as p,a as D,_ as O,j as t,y as j,P as Q,L as R}from"./index-BLpG_3dc.js";import{D as H}from"./DataLoadingWrapper-DLiuAs32.js";import{P as I}from"./PageSider-De9kC7SI.js";import{u as M}from"./useQueryParams-ocZrol2E.js";import{I as E}from"./ImageCard-uIDEsSSw.js";import{u as F}from"./useTableExpandableRows-BVT4WWnD.js";import{u as N}from"./useTablePagination-CfDJMguw.js";import{l as x}from"./useBaseUrl-Z8UUKQRH.js";import{S as z}from"./index-C3-g4HeD.js";import{F as k}from"./Table-D8t0FxTd.js";import{F as L}from"./index-C6ycO1rA.js";import{P}from"./progress-DcZXYhBe.js";import{T}from"./index-DxBGFAMq.js";import{u as A}from"./useCardWidth-BRGBqN00.js";import{R as V}from"./FireFilled-5to0p_jP.js";import{F as $}from"./FilterEntries-CMQi29db.js";import{S as b}from"./SiderContent-C8pkahXp.js";import{D as B}from"./DownloadButton-ov5kmDez.js";import{a as q,d as K,e as W}from"./index-BSGMqsez.js";import{R as J}from"./TableOutlined-DIwHYRT1.js";import{u as _}from"./useGetFirestoreDoc-DKduTKnD.js";import{u as v}from"./useTDResource-CEfvLK3O.js";import"./gapSize-U1swVQyS.js";import"./index-Bop_RWDL.js";import"./index-DaoSKbYZ.js";import"./index-B8LDdwuq.js";import"./index-Btk51C0l.js";import"./scrollTo--jvQhqkG.js";import"./Pagination-DAWB2JZ9.js";import"./extendsObject-keMuGWqj.js";import"./Input-CfP8Bjl1.js";import"./index-DCbKhhF5.js";import"./index-Co6Wlshl.js";import"./index-DojfTyfT.js";import"./constants-C7m4kwy2.js";import"./Item-C2s7nmsd.js";var G={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M594.3 601.5a111.8 111.8 0 0029.1-75.5c0-61.9-49.9-112-111.4-112s-111.4 50.1-111.4 112c0 29.1 11 55.5 29.1 75.5a158.09 158.09 0 00-74.6 126.1 8 8 0 008 8.4H407c4.2 0 7.6-3.3 7.9-7.5 3.8-50.6 46-90.5 97.2-90.5s93.4 40 97.2 90.5c.3 4.2 3.7 7.5 7.9 7.5H661a8 8 0 008-8.4c-2.8-53.3-32-99.7-74.7-126.1zM512 578c-28.5 0-51.7-23.3-51.7-52s23.2-52 51.7-52 51.7 23.3 51.7 52-23.2 52-51.7 52zm416-354H768v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H548v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H328v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H96c-17.7 0-32 14.3-32 32v576c0 17.7 14.3 32 32 32h832c17.7 0 32-14.3 32-32V256c0-17.7-14.3-32-32-32zm-40 568H136V296h120v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h148v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h148v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h120v496z"}}]},name:"contacts",theme:"outlined"},Y={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M868 160h-92v-40c0-4.4-3.6-8-8-8H256c-4.4 0-8 3.6-8 8v40h-92a44 44 0 00-44 44v148c0 81.7 60 149.6 138.2 162C265.6 630.2 359 721.8 476 734.5v105.2H280c-17.7 0-32 14.3-32 32V904c0 4.4 3.6 8 8 8h512c4.4 0 8-3.6 8-8v-32.3c0-17.7-14.3-32-32-32H548V734.5C665 721.8 758.4 630.2 773.8 514 852 501.6 912 433.7 912 352V204a44 44 0 00-44-44zM248 439.6c-37.1-11.9-64-46.7-64-87.6V232h64v207.6zM840 352c0 41-26.9 75.8-64 87.6V232h64v120z"}}]},name:"trophy",theme:"filled"},U=function(l,o){return p.createElement(D,O({},l,{ref:o,icon:G}))},X=p.forwardRef(U),Z=function(l,o){return p.createElement(D,O({},l,{ref:o,icon:Y}))},ee=p.forwardRef(Z);function te({answersPerQuestion:r,questions:l}){const o=p.useMemo(()=>x.orderBy(Object.keys(r).map(c=>{const e=l[c],n=r[c],d=n.length>2,a=n.length,i=Math.max(n.length,5),s=n.filter(f=>f===1).length,m=Math.round(s/i*100),g=n.filter(f=>f===0).length,h=Math.round(g/i*100),y=Math.round((i-s-g)/i*100);return{id:c,question:e,enoughData:d,reliability:a,yesPercentage:m,noPercentage:h,blankPercentage:y,values:n}}),["reliability","enoughData","yesPercentage"],["desc","desc","desc"]),[r,l]),u=[{key:"id",title:"Id",dataIndex:"id"},{key:"question",title:"Question",dataIndex:"question",render:c=>c.question},{key:"answer",title:"Answer",dataIndex:"id",sorter:(c,e)=>c.reliability-e.reliability,render:c=>{const e=o.find(n=>n.id===c);return e?t.jsxs(L,{gap:8,wrap:"nowrap",children:[t.jsx(j,{title:`Values: ${e.values.join(", ")}`,children:t.jsx(P,{percent:e.noPercentage+e.yesPercentage,size:e.enoughData?[100,20]:[100,10],status:e.enoughData?"exception":"active",success:{percent:e.yesPercentage},showInfo:!1})}),e.yesPercentage>=e.noPercentage?t.jsxs(T,{color:"green-inverse",children:[e.yesPercentage,"% Yes"]}):t.jsxs(T,{color:"red-inverse",children:[e.noPercentage,"% No"]})]}):""}}];return t.jsx(z,{wrap:!0,size:"large",children:t.jsx(k,{rowKey:"id",columns:u,dataSource:o,bordered:!0})})}function se({isLoading:r,isSuccess:l,questions:o,data:u,suspects:c}){const e=p.useMemo(()=>Object.keys(u).reduce((s,m)=>{const g=u[m]??{};return Object.keys(g).forEach(h=>{s[h]||(s[h]={}),s[h][m]=g[h]}),s},{}),[u]),n=p.useMemo(()=>x.orderBy(Object.values(c).map(s=>({...s,answers:e[s.id]})),s=>Number(s.id.split("-")[1]),"asc"),[c,e]),d=N({total:n.length,showQuickJumper:!0}),a=[{title:"Id",dataIndex:"id",key:"id",sorter:(s,m)=>Number(s.id.split("-")[1])-Number(m.id.split("-")[1])},{title:"Picture",dataIndex:"id",render:s=>{const m=s.split("-").join("-gb-");return t.jsx(E,{id:m,width:48})}},{title:"Name",dataIndex:"name",key:"name",sorter:(s,m)=>s.name.pt.localeCompare(m.name.pt),render:s=>s.pt},{title:"Questions Answered",dataIndex:"answers",key:"answers",sorter:(s,m)=>Object.keys(s.answers).length-Object.keys(m.answers).length,render:s=>s?Object.values(s).length:""}],i=F({maxExpandedRows:1,expandedRowRender:s=>t.jsx(te,{suspect:s,answersPerQuestion:e[s.id],questions:o}),rowExpandable:()=>l});return t.jsx(k,{columns:a,dataSource:n,pagination:d,rowKey:"id",expandable:i,loading:r,bordered:!0,className:"full-width"})}function re({answers:r,suspects:l}){const[o,u]=A(12),c=p.useMemo(()=>x.orderBy(Object.keys(r??{}).map(e=>{const d=`us-gb-${e.split("-")[1]}`,a=r[e],i=a.length>2,s=a.length>4,m=Math.max(a.length,5),g=a.filter(w=>w===1).length,h=Math.round(g/m*100),y=a.filter(w=>w===0).length,f=Math.round(y/m*100),S=Math.round((m-g-y)/m*100),C=a.length>=5;return C&&console.log({suspectCardId:e,values:a,yesPercentage:h,noPercentage:f,blankPercentage:S,total:m}),{imageId:d,suspectCardId:e,enoughData:i,reliability:s,yesPercentage:h,noPercentage:f,blankPercentage:S,complete:C,values:a}}),["complete","reliability","enoughData","percentage"],["desc","desc","desc","desc"]),[r]);return t.jsx(z,{wrap:!0,ref:u,size:"large",children:c.map(e=>t.jsxs(L,{vertical:!0,gap:4,children:[t.jsx(E,{id:e.imageId,width:o,className:e.enoughData?void 0:"grayscale"}),t.jsxs("div",{children:[t.jsx(j,{title:e.suspectCardId,children:l[e.suspectCardId].name.pt})," ",e.complete&&t.jsx(j,{title:"Complete: It has 5 or more answers",children:t.jsx(ee,{style:{color:"gold"}})})]}),t.jsx(j,{title:`Values: ${e.values.join(", ")}`,children:e.enoughData?t.jsx(P,{percent:e.noPercentage+e.yesPercentage,size:[o,20],status:"exception",success:{percent:e.yesPercentage},showInfo:!1}):t.jsx(P,{percent:e.noPercentage+e.yesPercentage,size:[o,10],status:"exception",success:{percent:e.yesPercentage},showInfo:!1})})]},e.suspectCardId))})}function ne({data:r,questions:l,suspects:o,isLoading:u,isSuccess:c}){const e=p.useMemo(()=>x.orderBy(Object.values(l),i=>Number(i.id.split("-")[1]),"asc"),[l]),n=N({total:e.length,showQuickJumper:!0}),d=[{title:"Id",dataIndex:"id",key:"id",sorter:(i,s)=>Number(i.id.split("-")[1])-Number(s.id.split("-")[1])},{title:"Question",dataIndex:"question",key:"question",sorter:(i,s)=>i.question.localeCompare(s.question)},{title:"NSFW",dataIndex:"nsfw",key:"nsfw",render:i=>i?t.jsx(V,{style:{color:"hotPink"}}):"",sorter:(i,s)=>Number(i.nsfw)-Number(s.nsfw)},{title:"Answers",dataIndex:"id",key:"answers",render:i=>{const s=r[i];return s?Object.values(s).length:""}}],a=F({maxExpandedRows:1,expandedRowRender:i=>t.jsx(re,{answers:r[i.id]??{},suspects:o}),rowExpandable:()=>c});return t.jsx(k,{columns:d,dataSource:e,pagination:n,rowKey:"id",expandable:a,loading:u,bordered:!0,className:"full-width"})}function oe(r){const{queryParams:l,is:o}=M();return t.jsxs(t.Fragment,{children:[(o("display","questions")||!l.get("display"))&&t.jsx(ne,{...r}),o("display","suspects")&&t.jsx(se,{...r})]})}function ae({data:r,hasNewData:l}){const{queryParams:o,addParams:u}=M(),c=p.useMemo(()=>{const e={};return Object.values(r).forEach(n=>{Object.keys(n).forEach(d=>{n[d]&&(e[d]||(e[d]=0),n[d].length>=5&&(e[d]+=1))})}),{queriedTestimoniesCount:Object.keys(r).length,suspectsCount:Object.keys(e).length,reliableSuspectsCount:Object.values(e).filter(n=>n>=5).length}},[r]);return t.jsxs(t.Fragment,{children:[t.jsx(b,{children:t.jsx(B,{data:()=>ie(r),fileName:"testimony-answers.json",hasNewData:l,block:!0})}),t.jsx(b,{children:t.jsx($,{label:"Display",value:o.get("display")??"questions",onChange:e=>u({display:e,page:1},{page:1}),options:[{title:"Questions",icon:t.jsx(J,{}),value:"questions"},{title:"Suspects",icon:t.jsx(X,{}),value:"suspects"}]})}),t.jsx(b,{children:t.jsxs("div",{style:{fontSize:"0.85em"},children:[t.jsx("strong",{children:"Legend"}),t.jsxs("ul",{children:[t.jsx("li",{children:"Reliability: At least 5 votes"}),t.jsx("li",{children:"Large Bars: There's enough data (at least 3)"}),t.jsx("li",{children:"Small blue bar: in progress negative"})]})]})}),t.jsx(b,{children:t.jsxs("div",{style:{fontSize:"0.85em"},children:[t.jsx("strong",{children:"Counts"}),t.jsxs("ul",{children:[t.jsxs("li",{children:["Testimonies: ",c.queriedTestimoniesCount]}),t.jsxs("li",{children:["Suspects: ",c.suspectsCount]}),t.jsx("li",{children:t.jsxs(j,{title:"A reliable suspect is one that has at least 5 complete testimonies.",children:["Reliable suspects: ",c.reliableSuspectsCount]})})]})]})})]})}function ie(r){return console.log("Preparing file for download..."),q(K(r))}function ce(){const r=v("suspects"),l=v("testimony-questions-pt"),o=v("testimony-answers"),u=_("data","testimonies",{select:e=>W(e,n=>{const d={};return Object.keys(n).forEach(a=>{const i=a.replace(/us-\w{2}-(\d+)/,"us-$1");d[i]=n[a]||[]}),d})}),c=p.useMemo(()=>{if(!o.data||!u.data)return{};const e=x.cloneDeep(o.data);return Object.keys(u.data).forEach(n=>{const d=u.data[n];if(e[n]===void 0){e[n]=d;return}Object.keys(d).forEach(a=>{e[n][a]===void 0?e[n][a]=d[a]:(console.log("merging",n,a),e[n][a].push(...d[a]))})}),e},[o.data,u.data]);return{isLoading:o.isLoading||u.isLoading||l.isLoading||r.isLoading,isSuccess:o.isSuccess&&u.isSuccess&&l.isSuccess&&r.isSuccess,error:o.error||u.error,data:c,questions:l.data,suspects:r.data,hasNewData:!x.isEmpty(u.data)}}function Ke(){const r=ce();return t.jsx(Q,{title:"Testimonies",subtitle:"Suspect Testimony Rates",children:t.jsxs(R,{hasSider:!0,children:[t.jsx(I,{children:t.jsx(ae,{...r})}),t.jsx(R.Content,{className:"content",children:t.jsx(H,{isLoading:r.isLoading,error:r.error,hasResponseData:!x.isEmpty(r.data),children:t.jsx(oe,{...r})})})]})})}export{Ke as TestimoniesPage,Ke as default};
