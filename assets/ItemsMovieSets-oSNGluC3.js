import{j as e,D as M,r as x,T as h,B as I,a1 as F,P as O,L as w}from"./index-ClMoIjJ-.js";import{D as E}from"./DataLoadingWrapper-DxmEXEAV.js";import{u as C}from"./useQueryParams-COdYnU7u.js";import{l as p,P as k}from"./useBaseUrl-CoCZ9vEc.js";import{I as R}from"./Item-BBR-011g.js";import{u as v}from"./useCopyToClipboardFunction-WO6MKGNB.js";import{u as P}from"./useTableExpandableRows-DdI54Pc4.js";import{u as $}from"./useTablePagination-ea60_ED7.js";import{u as S}from"./useTDResource-D1CzKPY8.js";import{h as B,r as T,a as H,j as Q}from"./index-QJoPbHAX.js";import{I as Y}from"./ItemsTypeahead-C97aYWOR.js";import{F as u}from"./index-CDcG5E1c.js";import{R as G}from"./PlusOutlined-C9cIIWsL.js";import{u as _}from"./useDailyHistoryQuery-DjEjGOu6.js";import{u as J,L as K}from"./useParsedHistory-BJRcwnQI.js";import{F as f}from"./Table-D5EmksB5.js";import{S as y}from"./index-5cCGSyX6.js";import{P as W}from"./index-BPs2fIn7.js";import{R as X}from"./DeleteFilled-SKndJVS3.js";import{T as z}from"./Typeahead-ttrZo8M_.js";import{c as q}from"./FilterEntries-y-2OIjzs.js";import{S as U}from"./SiderContent-DndQDeo1.js";import{D as Z}from"./DownloadButton-8U-ASpJ3.js";import{S as V}from"./SaveButton-CGjy-nAs.js";import{u as ee}from"./useResourceFirestoreData-CiQlyCMh.js";import"./constants-DjtkwDW-.js";import"./useDebounce-BDe8LsIT.js";import"./index-CrxOa4YX.js";import"./index-CTtRcsac.js";import"./index-BdklHplT.js";import"./Input-C7-Q7VGf.js";import"./gapSize-U1swVQyS.js";import"./useGetFirestoreDoc-Bp9vfRDt.js";import"./moment-C5S46NFB.js";import"./index-Dv2wS-2O.js";import"./index-B6UFcfpp.js";import"./index-Cxhh31mU.js";import"./scrollTo-Ct5sfL1p.js";import"./Pagination-DMbGnwAF.js";import"./index-BRtmcCW4.js";import"./index-BY0mvmgr.js";import"./SaveOutlined-NlIzGvIH.js";import"./useUpdateFirestoreDoc-DbRqG7yh.js";import"./useMutation-BEomY5Dv.js";function D({movie:t,addEntryToUpdate:r}){const s=a=>{r(t.id,{...t,itemsIds:[...t.itemsIds,a]})};return e.jsxs(u,{gap:12,children:[e.jsx("div",{style:{minWidth:250},children:e.jsx(Y,{onFinish:s})}),e.jsx(M,{type:"vertical",variant:"dotted"}),e.jsx(te,{movie:t,onUpdate:s})]})}function te({movie:t,onUpdate:r}){const s=S("items",!0),a=x.useMemo(()=>{if(!s.data)return[];const i=t.title.toLowerCase(),l=Object.entries(s.data),c=[];return l.forEach(([m,n])=>{if(t.itemsIds.includes(m))return;const o=[n.name.pt.toLowerCase()];n.aliasesPt&&Array.isArray(n.aliasesPt)&&o.push(...n.aliasesPt.map(A=>A.toLowerCase()));const j=B.findBestMatch(i,o).bestMatch.rating;j>.3&&c.push({id:m,similarity:j})}),c.sort((m,n)=>n.similarity-m.similarity).slice(0,20).map(m=>m.id)},[s.data,t]);return e.jsxs(u,{gap:12,vertical:!0,children:[e.jsx(h.Text,{strong:!0,children:"Suggestions"}),e.jsx(u,{gap:16,wrap:"wrap",children:a.map((i,l)=>{var m;const c=(m=s.data)==null?void 0:m[i];return e.jsxs(u,{gap:2,vertical:!0,children:[e.jsx(R,{id:i,title:`${c.name.en} | ${c.name.pt}`,width:60}),e.jsxs(u,{gap:6,justify:"center",children:[e.jsx(h.Text,{children:i}),e.jsx(I,{onClick:()=>r(i),shape:"circle",size:"small",children:e.jsx(G,{})})]})]},`sample-${i}-${l}`)})})]})}function se(){const t=K.DAILY.pt,r=_(t,{enabled:!0}),[s]=J("filmaco",r.data);return x.useMemo(()=>p.mapValues(p.keyBy((s==null?void 0:s.used)??[]),()=>!0),[s])}function N({rows:t,addEntryToUpdate:r}){const s=v(),a=S("items"),i=se(),l=$({total:t.length,showQuickJumper:!0}),c=[{title:"Title",dataIndex:"title",render:(n,o)=>e.jsx(g,{addEntryToUpdate:r,movie:o,property:"title",value:n}),sorter:(n,o)=>n.title.localeCompare(o.title)},{title:"Year",dataIndex:"year",render:(n,o)=>e.jsx(g,{addEntryToUpdate:r,movie:o,property:"year",value:n}),sorter:(n,o)=>n.year-o.year},f.EXPAND_COLUMN,{title:"Items",dataIndex:"itemsIds",key:"itemsIds",render:(n,o)=>e.jsx(L,{addEntryToUpdate:r,copyToClipboard:s,itemsIds:n,movie:o}),sorter:(n,o)=>n.itemsIds.length-o.itemsIds.length},{title:"Count",dataIndex:"itemsIds",render:n=>T(n).filter(Boolean).length},{title:"Used",dataIndex:"id",render:n=>i[n]?"Yes":"No",sorter:(n,o)=>i[n.id]&&!i[o.id]?-1:!i[n.id]&&i[o.id]?1:o.itemsIds.length-n.itemsIds.length}],m=P({maxExpandedRows:1,expandedRowRender:n=>e.jsx(D,{addEntryToUpdate:r,movie:n}),rowExpandable:()=>a.isSuccess});return e.jsx(f,{columns:c,dataSource:t,expandable:m,pagination:l,rowKey:"id"})}function re({movie:t,addEntryToUpdate:r,itemId:s}){const a=()=>{r(t.id,{...t,itemsIds:t.itemsIds.filter(i=>i!==s)})};return e.jsx(W,{cancelText:"No",okText:"Yes",onConfirm:a,title:"Are you sure you want to remove this item?",children:e.jsx(I,{icon:e.jsx(X,{}),size:"small",type:"text"})})}function L({movie:t,itemsIds:r,copyToClipboard:s,addEntryToUpdate:a}){return e.jsx(u,{gap:6,wrap:"wrap",children:r.map((i,l)=>e.jsxs(u,{gap:2,vertical:!0,children:[e.jsx(R,{id:i,width:60}),e.jsxs(u,{justify:"center",children:[e.jsx(h.Text,{onClick:()=>s(i),children:i}),e.jsx(re,{addEntryToUpdate:a,itemId:i,movie:t})]})]},`${t.title}-${i}-${l}`))},`items-${t.title}`)}function g({value:t,movie:r,addEntryToUpdate:s,property:a}){const i=l=>typeof t=="number"?l!==String(t)?s(r.id,{...r,[a]:Number(l)}):null:l!==t?s(r.id,{...r,[a]:l.trim()}):null;return e.jsx(y,{children:e.jsx(h.Text,{editable:{onChange:i},children:String(t)})})}function ie(t){return p.orderBy(t,[r=>r.title]).map(r=>({...r,itemsIds:p.orderBy(r.itemsIds,s=>Number(s))}))}function oe({data:t,addEntryToUpdate:r}){const{is:s}=C(),a=s("emptyOnly"),i=x.useMemo(()=>{const c=t?ie(Object.values(t)):[];return a?c.filter(m=>m.itemsIds.length===0):c},[a]),l=i.filter(c=>c.itemsIds.length>0).length;return e.jsxs(y,{direction:"vertical",children:[e.jsxs(h.Title,{level:5,children:["Total Movies: ",i.length," | Complete Movies: ",l]}),e.jsx(N,{addEntryToUpdate:r,rows:i})]})}function ne({data:t,addEntryToUpdate:r}){const[s,a]=x.useState(null),i=x.useMemo(()=>s?t[s]:null,[s,t]);return e.jsxs(y,{direction:"vertical",children:[e.jsx(h.Title,{level:5,children:"Search Movie"}),e.jsx(z,{data:t,onFinish:l=>a(l),parser:ae,placeholder:"Search movie by title...",style:{width:"100%",minWidth:450}}),!!i&&e.jsx(N,{addEntryToUpdate:r,rows:[i]})]})}const ae=t=>Object.values(t??{}).reduce((r,s)=>(r[`${s.title} (${s.year})`]=s.id,r),{});function le({data:t,save:r,isDirty:s,isSaving:a,entriesToUpdate:i,hasFirestoreData:l,addEntryToUpdate:c}){const{is:m,addParam:n}=C();return e.jsxs(U,{children:[e.jsxs(u,{gap:12,vertical:!0,children:[e.jsx(V,{dirt:JSON.stringify(i),isDirty:s,isSaving:a,onSave:r}),e.jsx(Z,{block:!0,data:()=>ce(t),disabled:s,fileName:"daily-movie-sets.json",hasNewData:l})]}),e.jsx(M,{}),e.jsx(q,{label:"Pending Only",onChange:o=>n("emptyOnly",o,!1),value:m("emptyOnly")}),e.jsx(me,{addEntryToUpdate:c,data:t})]})}function ce(t){return H(t)}function me({data:t,addEntryToUpdate:r}){const{message:s}=F.useApp(),a=v(),i=()=>{const l=Q(Object.keys(t),"dms","pt","-",1),c="[New Movie Set]";r(l,{id:l,title:c,itemsIds:[],year:new Date().getFullYear()}),s.success(`New Movie Set created, search for ${c} to find it easily.`),a(c)};return e.jsx(I,{block:!0,onClick:i,variant:"dashed",children:"Add New Movie Set"})}const b=30;function de({data:t,addEntryToUpdate:r}){const[s,a]=x.useState(null),i=S("items"),l=v(),c=()=>{var j;let o=p.sample(Object.keys(t??{})),d=0;for(;d<b&&(((j=t[String(o)])==null?void 0:j.itemsIds)??[]).length>0;)o=p.sample(Object.keys(t??{})),d++;if(d>=b)return console.warn("Could not find a sample with no itemsIds");a(o??null)},m=[{title:"Title",dataIndex:"title",render:(o,d)=>e.jsx(g,{addEntryToUpdate:r,movie:d,property:"title",value:o})},{title:"Year",dataIndex:"year",render:(o,d)=>e.jsx(g,{addEntryToUpdate:r,movie:d,property:"year",value:o})},f.EXPAND_COLUMN,{title:"Items",dataIndex:"itemsIds",key:"itemsIds",render:(o,d)=>e.jsx(L,{addEntryToUpdate:r,copyToClipboard:l,itemsIds:o,movie:d})},{title:"Count",dataIndex:"itemsIds",render:o=>T(o).filter(Boolean).length}],n=P({maxExpandedRows:1,expandedRowRender:o=>e.jsx(D,{addEntryToUpdate:r,movie:o}),rowExpandable:()=>i.isSuccess});return e.jsxs(y,{className:"my-4",direction:"vertical",children:[e.jsx(I,{onClick:c,children:"Get Random Movie"}),s&&e.jsx(f,{columns:m,dataSource:[t[s]],expandable:n,pagination:!1,rowKey:"id"},String(s))]})}function st(){const t=ee({tdrResourceName:"daily-movie-sets",firestoreDataCollectionName:"movieSets"});return e.jsx(O,{subtitle:"Movie Sets",title:"Items",children:e.jsxs(w,{hasSider:!0,children:[e.jsx(k,{children:e.jsx(le,{...t})}),e.jsx(w.Content,{className:"content",children:e.jsx(E,{error:t.error,hasResponseData:!p.isEmpty(t.data),isLoading:t.isLoading,children:e.jsxs(y,{direction:"vertical",children:[e.jsx(ne,{...t}),e.jsx(de,{...t}),e.jsx(oe,{...t})]})})})]})})}export{st as ItemsMovieSets,st as default};
