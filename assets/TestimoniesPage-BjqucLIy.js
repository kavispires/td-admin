import{aA as xe,r as w,d as z,_ as L,j as e,F as v,T as k,B as S,A as G,h as ge,a4 as B,D as Y,b as Q,aB as ie,R as ye,a2 as oe,aC as be,P as we,L as J}from"./index-CJP1NcLY.js";import{D as ve}from"./DataLoadingWrapper-DG7QZDr8.js";import{l as O,c as ce,P as Se}from"./useBaseUrl-7hhyaw6U.js";import{u as R}from"./useQueryParams-BFtarVaT.js";import{R as Ce}from"./main-CfsbTSu1.js";import{u as ke,c as Oe,b as Te}from"./useTestimoniesResource-BOs83fhd.js";import{g as Ie}from"./useParsedHistory-ClXvkHJQ.js";import{S as $}from"./SuspectImageCard-CxIZvabj.js";import{u as Re}from"./useTDResource-BAk1Iz0J.js";import{T as ae,S as De,F as Me}from"./FilterEntries-0lyMFttp.js";import{B as q,D as le}from"./DownloadButton-CcWgRP_u.js";import{S as M}from"./index-BNGPopnc.js";import{u as ue}from"./useTableExpandableRows-C1JgaZLo.js";import{u as de}from"./useTablePagination-C5o5ED--.js";import{P as X}from"./progress-CoAiccDD.js";import{S as N}from"./index-XI8Y8BcL.js";import{c as he,n as Ne}from"./utils-Dv7EoUju.js";import{F as _}from"./Table-BUUixokD.js";import{u as Pe}from"./useCardWidth-4tQsr_L4.js";import{C as me}from"./index-ByZ5NuP2.js";import{P as Z}from"./index-CqVlIwge.js";import{S as H}from"./SiderContent-Bm9ZHBWB.js";import{F as Ee,a as Ae}from"./FirestoreConsoleLink-C5jD8xRh.js";import{S as Fe}from"./SaveButton-DJ3uvymx.js";import{S as Be}from"./SuspectsStyleVariantSelector-CAUE3XCH.js";import{g as ze}from"./useGetFirestoreDoc-C_u6buBo.js";import{j as Le,a as $e,i as Ve}from"./index-BGplYY1j.js";import{u as pe}from"./useWindowSize-AGigr-Xv.js";import{R as He}from"./TableOutlined-B3FjYn-O.js";import{R as qe}from"./RobotOutlined-CBEUKBu6.js";import"./useResourceFirestoreData-s8VEI4RV.js";import"./useUpdateFirestoreDoc-Dr4NdarP.js";import"./useMutation-D3ZmfJLK.js";import"./moment-C5S46NFB.js";import"./ImageCard-DpwjCEPh.js";import"./index-BtkknYjo.js";import"./index--R1wWL3p.js";import"./index-BawPSGCN.js";import"./scrollTo-CuTGOS2w.js";import"./Pagination-cpBm3MlS.js";import"./SaveOutlined-9t_KF9k8.js";import"./constants-Cc6Kx7Tc.js";import"./Item-BmBIjVkR.js";function Ue(t,s){return typeof t=="function"?t.length?t(s):t():t}function fe(t,s,o){if(s===void 0&&(s=10),s<1)throw new Error("Capacity has to be greater than 1, got '"+s+"'");var l=xe(),p=w.useState(t),j=p[0],m=p[1],n=w.useRef([]),a=w.useRef(0);l&&(n.current.length?(n.current[n.current.length-1]!==t&&n.current.push(t),n.current.length>s&&(n.current=n.current.slice(n.current.length-s))):n.current.push(t),a.current=n.current.length&&n.current.length-1);var x=w.useCallback(function(i){m(function(f){return i=Ue(i,f),i!==f&&(a.current<n.current.length-1&&(n.current=n.current.slice(0,a.current+1)),a.current=n.current.push(i)-1,n.current.length>s&&(n.current=n.current.slice(n.current.length-s))),i})},[j,s]),h=w.useMemo(function(){return{history:n.current,position:a.current,capacity:s,back:function(i){i===void 0&&(i=1),a.current&&m(function(){return a.current-=Math.min(i,a.current),n.current[a.current]})},forward:function(i){i===void 0&&(i=1),a.current!==n.current.length-1&&m(function(){return a.current=Math.min(a.current+i,n.current.length-1),n.current[a.current]})},go:function(i){i!==a.current&&m(function(){return a.current=i<0?Math.max(n.current.length+i,0):Math.min(n.current.length-1,i),n.current[a.current]})}}},[j]);return[j,x,h]}var Qe={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M864 144H560c-8.8 0-16 7.2-16 16v304c0 8.8 7.2 16 16 16h304c8.8 0 16-7.2 16-16V160c0-8.8-7.2-16-16-16zm0 400H560c-8.8 0-16 7.2-16 16v304c0 8.8 7.2 16 16 16h304c8.8 0 16-7.2 16-16V560c0-8.8-7.2-16-16-16zM464 144H160c-8.8 0-16 7.2-16 16v304c0 8.8 7.2 16 16 16h304c8.8 0 16-7.2 16-16V160c0-8.8-7.2-16-16-16zm0 400H160c-8.8 0-16 7.2-16 16v304c0 8.8 7.2 16 16 16h304c8.8 0 16-7.2 16-16V560c0-8.8-7.2-16-16-16z"}}]},name:"appstore",theme:"filled"},We=function(s,o){return w.createElement(z,L({},s,{ref:o,icon:Qe}))},Ye=w.forwardRef(We),_e={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M512 624c93.9 0 170-75.2 170-168V232c0-92.8-76.1-168-170-168s-170 75.2-170 168v224c0 92.8 76.1 168 170 168zm330-170c0-4.4-3.6-8-8-8h-60c-4.4 0-8 3.6-8 8 0 140.3-113.7 254-254 254S258 594.3 258 454c0-4.4-3.6-8-8-8h-60c-4.4 0-8 3.6-8 8 0 168.7 126.6 307.9 290 327.6V884H326.7c-13.7 0-24.7 14.3-24.7 32v36c0 4.4 2.8 8 6.2 8h407.6c3.4 0 6.2-3.6 6.2-8v-36c0-17.7-11-32-24.7-32H548V782.1c165.3-18 294-158 294-328.1z"}}]},name:"audio",theme:"filled"},Ke=function(s,o){return w.createElement(z,L({},s,{ref:o,icon:_e}))},Ge=w.forwardRef(Ke),Je={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M594.3 601.5a111.8 111.8 0 0029.1-75.5c0-61.9-49.9-112-111.4-112s-111.4 50.1-111.4 112c0 29.1 11 55.5 29.1 75.5a158.09 158.09 0 00-74.6 126.1 8 8 0 008 8.4H407c4.2 0 7.6-3.3 7.9-7.5 3.8-50.6 46-90.5 97.2-90.5s93.4 40 97.2 90.5c.3 4.2 3.7 7.5 7.9 7.5H661a8 8 0 008-8.4c-2.8-53.3-32-99.7-74.7-126.1zM512 578c-28.5 0-51.7-23.3-51.7-52s23.2-52 51.7-52 51.7 23.3 51.7 52-23.2 52-51.7 52zm416-354H768v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H548v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H328v-56c0-4.4-3.6-8-8-8h-56c-4.4 0-8 3.6-8 8v56H96c-17.7 0-32 14.3-32 32v576c0 17.7 14.3 32 32 32h832c17.7 0 32-14.3 32-32V256c0-17.7-14.3-32-32-32zm-40 568H136V296h120v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h148v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h148v56c0 4.4 3.6 8 8 8h56c4.4 0 8-3.6 8-8v-56h120v496z"}}]},name:"contacts",theme:"outlined"},Xe=function(s,o){return w.createElement(z,L({},s,{ref:o,icon:Je}))},Ze=w.forwardRef(Xe),et={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M870 126H663.8c-17.4 0-32.9 11.9-37 29.3C614.3 208.1 567 246 512 246s-102.3-37.9-114.8-90.7a37.93 37.93 0 00-37-29.3H154a44 44 0 00-44 44v252a44 44 0 0044 44h75v388a44 44 0 0044 44h478a44 44 0 0044-44V466h75a44 44 0 0044-44V170a44 44 0 00-44-44z"}}]},name:"skin",theme:"filled"},tt=function(s,o){return w.createElement(z,L({},s,{ref:o,icon:et}))},st=w.forwardRef(tt),nt={icon:{tag:"svg",attrs:{viewBox:"64 64 896 896",focusable:"false"},children:[{tag:"path",attrs:{d:"M868 160h-92v-40c0-4.4-3.6-8-8-8H256c-4.4 0-8 3.6-8 8v40h-92a44 44 0 00-44 44v148c0 81.7 60 149.6 138.2 162C265.6 630.2 359 721.8 476 734.5v105.2H280c-17.7 0-32 14.3-32 32V904c0 4.4 3.6 8 8 8h512c4.4 0 8-3.6 8-8v-32.3c0-17.7-14.3-32-32-32H548V734.5C665 721.8 758.4 630.2 773.8 514 852 501.6 912 433.7 912 352V204a44 44 0 00-44-44zM248 439.6c-37.1-11.9-64-46.7-64-87.6V232h64v207.6zM840 352c0 41-26.9 75.8-64 87.6V232h64v120z"}}]},name:"trophy",theme:"filled"},rt=function(s,o){return w.createElement(z,L({},s,{ref:o,icon:nt}))},ee=w.forwardRef(rt);function it(){const[t,s]=w.useState({batchSize:1,history:{}}),o=w.useRef(1),{entries:l}=ke(!0,"pt",t.batchSize,t.history),p=Re("suspects",!O.isEmpty(l));return console.log(ct(l,p.data??{})),e.jsxs(v,{className:"p-4",gap:12,vertical:!0,children:[e.jsxs(v,{align:"center",justify:"space-between",children:[e.jsx(k.Title,{className:"my-0",level:4,children:"Espionagem Simulator"}),e.jsxs(v,{gap:6,children:[e.jsx(ae,{defaultValue:1,max:100,min:1,onChange:j=>{o.current=j??1}}),e.jsx(S,{onClick:()=>s({batchSize:o.current,history:{}}),type:"primary",children:"Re-run Simulation"})]})]}),e.jsx(ot,{entries:l})]})}function ot({entries:t}){const[s,o]=w.useState(!1),l=Ie(),p=t[l],j=w.useMemo(()=>p?p.statements.reduce((m,n)=>{const{excludes:a}=n;return a.forEach(x=>{m[x]?m[x]++:m[x]=1}),m},{}):{},[p]);return e.jsxs("div",{className:"full-width grid",style:{gridTemplateColumns:"2fr 3fr"},children:[e.jsx(Ce,{collapsed:3,src:t??{},theme:"twilight"}),e.jsx("div",{children:p&&e.jsxs(v,{className:"p-4",gap:18,children:[e.jsx("div",{children:e.jsx("div",{style:{width:`${105*4}px`,display:"grid",gap:"6px",gridTemplateColumns:"repeat(4, 1fr)"},children:p.suspects.map(m=>e.jsxs(q.Ribbon,{color:"cyan",text:s?j[m.id]:null,children:[e.jsx($,{cardId:m.id,cardWidth:96,className:ce(s&&m.id===p.culpritId&&"red-border")},m.id),e.jsxs(v,{align:"center",gap:6,children:[e.jsx(M,{checkedChildren:"ðŸš«",size:"small"})," ",m.id]})]},m.id))})}),e.jsxs("div",{children:[e.jsx("div",{children:e.jsx(M,{checked:s,checkedChildren:"Show Culprit",onChange:o,unCheckedChildren:"Hide Culprit"})}),p.statements.map(m=>e.jsx(k.Paragraph,{children:e.jsx(q,{color:"cyan",count:m.excludes.length,children:e.jsx(G,{banner:!0,icon:te(m.type),message:m.text,type:"info"},m.key)})},m.key)),p.additionalStatements.map(m=>e.jsx(k.Paragraph,{children:e.jsx(q,{color:"cyan",count:m.excludes.length,children:e.jsx(G,{banner:!0,icon:te(m.type),message:m.text,type:"warning"},m.key)})},m.key))]})]})})]})}const te=t=>{switch(t){case"testimony":return e.jsx(Ge,{});case"feature":return e.jsx(st,{});case"grid":return e.jsx(Ye,{});default:return"â“"}},ct=(t,s)=>{const o=Object.values(t).reduce((l,p)=>(p.suspects.forEach(j=>{l[j.id]=(l[j.id]||0)+1,j.id===p.culpritId&&(l[`${j.id}_culprit`]=(l[`${j.id}_culprit`]||0)+1)}),l),{});return Object.values(s).forEach(l=>{o[l.id]||(o[l.id]=0),o[`${l.id}_culprit`]||(o[`${l.id}_culprit`]=0)}),o};function je({suspect:t,values:s,resolution:o,projection:l,yesPercentage:p,noPercentage:j,complete:m,enoughData:n,testimonyId:a,addEntryToUpdate:x,answers:h,barWidth:i,showName:f}){const u=(r,c)=>{const y={...h};y[r]=[...y[r]||[],c],x(a,y)},d=(r,c)=>{const y={...h},g=y[r]?.indexOf(c);g!==-1&&g!==void 0&&(y[r]=[...y[r].slice(0,g),...y[r].slice(g+1)]),x(a,y)};return e.jsxs(ge,{content:e.jsxs(v,{align:"center",vertical:!0,children:[e.jsx(k.Text,{type:"secondary",children:s.join(", ")}),e.jsxs(N.Compact,{children:[e.jsx(S,{block:!0,icon:"ðŸ‘",onClick:()=>u(t.id,4),children:"Fit"}),e.jsx(S,{icon:"âŒ",onClick:()=>d(t.id,4)}),e.jsx(S,{block:!0,icon:"ðŸ‘Ž",onClick:()=>u(t.id,-4),children:"Unfit"}),e.jsx(S,{icon:"âŒ",onClick:()=>d(t.id,-4)})]}),e.jsx(Y,{className:"my-1"}),e.jsxs(N.Compact,{children:[e.jsx(S,{block:!0,icon:"â¬†ï¸",onClick:()=>u(t.id,32),children:"Sure"}),e.jsx(S,{icon:"âœ–ï¸",onClick:()=>d(t.id,32)}),e.jsx(S,{block:!0,icon:"â¬‡ï¸",onClick:()=>u(t.id,-32),children:"Sure"}),e.jsx(S,{icon:"âœ–ï¸",onClick:()=>d(t.id,-32)})]})]}),title:`Add strong fit/unfit answer to ${t.name.pt}`,trigger:"click",children:[f&&e.jsxs("div",{children:[e.jsx(B,{title:t.id,children:t.name.pt})," ",m&&e.jsx(B,{title:"Complete: It has 5 or more answers",children:e.jsx(ee,{style:{color:"gold"}})}),!!o&&o]}),e.jsxs(v,{align:"flex-start",gap:12,children:[e.jsx(B,{title:`Values: ${s.join(", ")} : ${o||(l?`${l}*`:"")}`,children:n?e.jsx(X,{percent:j+p,showInfo:!1,size:[i,20],status:"exception",success:{percent:p}}):e.jsx(X,{percent:j+p,showInfo:!1,size:[i,10],status:"exception",success:{percent:p}})}),!f&&m&&e.jsx(B,{title:"Complete: It has 5 or more answers",children:e.jsx(ee,{style:{color:"gold"}})})]})]})}function at({suspect:t,answersPerQuestion:s={},questions:o,addEntryToUpdate:l,allAnswers:p}){const{queryParams:j}=R({sortSuspectsBy:"answers"}),m=j.get("sortSuspectsBy")??"answers",[n,a]=w.useState(""),[x,h]=w.useState(!1),i=w.useMemo(()=>{const r=Object.values(o).map(c=>{const y=s[c.id]??{},{enoughData:g,reliable:b,yesPercentage:C,noPercentage:T,blankPercentage:D,values:P,total:U,resolution:F,projection:V,complete:E}=he(t.id,c.id,{[t.id]:y});return{id:c.id,question:c,enoughData:g,reliable:b,yesPercentage:C,noPercentage:T,blankPercentage:D,values:P,total:U,resolution:F,projection:V,complete:E}});return m==="answers"?O.orderBy(r,["reliable","enoughData","yesPercentage",c=>c.values.length],["desc","desc","desc","desc"]):O.orderBy(r,c=>Number(c.id.split("-")[1]),["asc"])},[s,o,t.id,m]),f=w.useMemo(()=>lt(t,i),[t,i]),u=[{key:"id",title:"Id",dataIndex:"id",width:"7%"},{key:"question",title:"Question",dataIndex:"question",render:r=>r.question},{key:"answer",title:"Answer",dataIndex:"id",width:"170px",sorter:(r,c)=>r.total-c.total,render:r=>{const c=i.find(y=>y.id===r);return c?e.jsx(v,{gap:8,wrap:"nowrap",children:e.jsx(je,{addEntryToUpdate:l,answers:p[c.question.id]||{},barWidth:120,complete:c.complete,enoughData:c.enoughData,noPercentage:c.noPercentage,projection:c.projection,resolution:c.resolution,suspect:t,testimonyId:c.question.id,values:c.values,yesPercentage:c.yesPercentage})}):""}},{key:"actions",title:"Actions",dataIndex:"id",width:"auto",render:r=>{const c=i.find(y=>y.id===r);return c?e.jsx(ut,{addEntryToUpdate:l,answers:p[c.question.id]||{},suspect:t,testimonyId:c.question.id}):""}}],d=w.useMemo(()=>{let r=i;return n.trim()&&(r=r.filter(c=>c.question.question.toLowerCase().includes(n.toLowerCase())||c.id.toLowerCase().includes(n.toLowerCase()))),x&&(r=r.filter(c=>c.values.reduce((g,b)=>g+Math.abs(b===0?-1:b),0)<=2)),r},[i,n,x]);return e.jsxs(N,{size:"large",wrap:!0,children:[e.jsxs(v,{className:"full-width",gap:16,vertical:!0,children:[e.jsxs(v,{gap:6,children:[e.jsx(Q,{allowClear:!0,onChange:r=>a(r.target.value),placeholder:"Search questions...",prefix:e.jsx(ie,{}),style:{marginBottom:16,width:320},value:n}),e.jsxs(v,{align:"center",gap:8,children:[e.jsx(M,{checked:x,onChange:h}),e.jsx(k.Text,{children:"Show only missing questions"})]})]}),e.jsx(_,{bordered:!0,className:"full-width",columns:u,dataSource:d,rowKey:"id",tableLayout:"fixed"})]}),e.jsxs(v,{gap:8,vertical:!0,children:[e.jsx(k.Title,{level:5,children:"Suspect Description"}),e.jsx(Q.TextArea,{className:"full-width",readOnly:!0,rows:7,value:f})]})]})}const lt=(t,s)=>{const o=s.filter(l=>l.resolution||l.projection).map(l=>{const{question:p,resolution:j,projection:m}=l,n=j||m;return`${t.gender==="male"?"ele":"ela"} ${n==="ðŸ‘"?"":"nÃ£o "}${p.answer.toLocaleLowerCase()}`});return`${t.name.pt}: ${o.join(", ")}`};function ut({suspect:t,testimonyId:s,addEntryToUpdate:o,answers:l}){const p=(n,a)=>{const x={...l};x[n]=[...x[n]||[],a],o(s,x)},j=(n,a)=>{const x={...l},h=x[n]?.indexOf(a);h!==-1&&h!==void 0&&(x[n]=[...x[n].slice(0,h),...x[n].slice(h+1)]),o(s,x)},m=w.useMemo(()=>Object.values(l[t.id]||{}).reduce((n,a)=>n+Math.abs(a===0?-1:a),0),[l,t.id]);return console.log(l[t.id]),e.jsxs(v,{align:"center",gap:6,wrap:"nowrap",children:[e.jsx(q,{color:m>20?"gold":"grey",count:m,showZero:!0,style:{minWidth:32}}),e.jsxs(N.Compact,{children:[e.jsx(S,{block:!0,icon:"ðŸ‘",onClick:()=>p(t.id,4),children:"FIT"}),e.jsx(S,{icon:"âŒ",onClick:()=>j(t.id,4)}),e.jsx(S,{block:!0,icon:"ðŸ‘Ž",onClick:()=>p(t.id,-4),children:"UNFIT"}),e.jsx(S,{icon:"âŒ",onClick:()=>j(t.id,-4)}),e.jsx(S,{block:!0,icon:"â¬†ï¸",onClick:()=>p(t.id,32),children:"Sure"}),e.jsx(S,{icon:"âœ–ï¸",onClick:()=>j(t.id,32)}),e.jsx(S,{block:!0,icon:"â¬‡ï¸",onClick:()=>p(t.id,-32),children:"Sure"}),e.jsx(S,{icon:"âœ–ï¸",onClick:()=>j(t.id,-32)})]})]})}function dt({isLoading:t,isSuccess:s,questions:o,data:l,suspects:p,addEntryToUpdate:j}){const{queryParams:m,addParam:n}=R(),a=Object.values(o).map(({id:d,question:r})=>({id:d,question:r})),x=w.useMemo(()=>Object.keys(l).reduce((d,r)=>{const c=l[r]??{};return Object.keys(c).forEach(y=>{d[y]||(d[y]={}),d[y][r]=c[y]}),d},{}),[l]),h=w.useMemo(()=>O.orderBy(Object.values(p).map(d=>({...d,answers:x[d.id]})),d=>Number(d.id.split("-")[1]),"asc"),[p,x]),i=de({total:h.length,showQuickJumper:!0}),f=[{title:"Id",dataIndex:"id",key:"id",sorter:(d,r)=>Number(d.id.split("-")[1])-Number(r.id.split("-")[1])},{title:"Picture",dataIndex:"id",render:d=>e.jsx($,{cardId:d,cardWidth:48})},{title:"Name",dataIndex:"name",key:"name",sorter:(d,r)=>d.name.pt.localeCompare(r.name.pt),render:(d,r)=>e.jsxs(v,{vertical:!0,children:[e.jsx(k.Text,{children:d.pt}),e.jsx(k.Text,{type:"secondary",children:d.en}),e.jsx(k.Text,{italic:!0,type:"secondary",children:e.jsx("small",{children:r.persona.en})})]})},{title:"Questions Answered",dataIndex:"answers",key:"answers",sorter:(d,r)=>Object.keys(d.answers??{}).length-Object.keys(r.answers??{}).length,render:d=>d?Object.values(d).length:""}],u=ue({maxExpandedRows:1,expandedRowRender:d=>e.jsx(at,{addEntryToUpdate:j,allAnswers:l,answersPerQuestion:d.answers,questions:o,suspect:d}),rowExpandable:()=>s});return e.jsxs(v,{className:"full-width py-4",gap:12,vertical:!0,children:[e.jsxs(v,{align:"center",justify:"space-between",children:[e.jsx(k.Title,{className:"my-0",level:4,children:"Testimonies by Suspect"}),e.jsx(le,{data:a,fileName:"newQuestions.json"}),e.jsx(M,{checked:m.get("sortSuspectsBy")==="answers",checkedChildren:"Sort by Answers",onChange:d=>n("sortSuspectsBy",d?"answers":"id"),unCheckedChildren:"Sort by Id"})]}),e.jsx(_,{bordered:!0,className:"full-width",columns:f,dataSource:h,expandable:u,loading:t,pagination:i,rowKey:"id"})]})}function ht({answers:t,suspects:s,addEntryToUpdate:o,testimonyId:l}){const[p,j]=Pe(12),{queryParams:m,is:n}=R({sortSuspectsBy:"answers"}),a=n("enableBatch"),x=m.get("sortSuspectsBy")??"answers",h=w.useMemo(()=>{const u=Object.keys(s).map(d=>he(d,l,t));return x==="answers"?O.orderBy(u,["reliable","enoughData",d=>d.values.length,"yesPercentage","noPercentage",d=>Number(d.suspectCardId.split("-")[1])],["desc","desc","desc","desc","desc","asc"]):O.orderBy(u,d=>Number(d.suspectCardId.split("-")[1]),["asc"])},[t,s,l,x]),[i,f]=w.useState([]);return e.jsxs(N,{direction:"vertical",children:[e.jsx(mt,{addEntryToUpdate:o,answers:t,list:h,selection:i,setSelection:f,suspects:s,testimonyId:l}),e.jsx(N,{ref:j,size:"large",wrap:!0,children:h.map(u=>e.jsxs(v,{className:ce({"selection-outline":a&&i.includes(u.suspectCardId)}),gap:6,vertical:!0,children:[e.jsx($,{cardId:u.imageId,cardWidth:p,className:u.values.length>1||u.enoughData?void 0:"grayscale"}),e.jsxs(v,{gap:4,children:[a&&e.jsx(me,{checked:i.includes(u.suspectCardId),disabled:u.complete,onChange:d=>{const r=d.target.checked;f(c=>r?[...c,u.suspectCardId]:c.filter(y=>y!==u.suspectCardId))}}),e.jsx(je,{addEntryToUpdate:o,answers:t,barWidth:p,complete:u.complete,enoughData:u.enoughData,noPercentage:u.noPercentage,projection:u.projection,resolution:u.resolution,showName:!0,suspect:s[u.suspectCardId],testimonyId:l,values:u.values,yesPercentage:u.yesPercentage})]})]},u.suspectCardId))})]})}function mt({testimonyId:t,selection:s,setSelection:o,suspects:l,addEntryToUpdate:p,list:j,answers:m}){const[n,a]=w.useState([]),{addParam:x,removeParam:h,is:i}=R({sortSuspectsBy:"answers"}),f=i("enableBatch"),u=c=>{a(y=>y.includes(c)?y.filter(g=>g!==c):[...y,c])},d=w.useMemo(()=>O.keyBy(j,"suspectCardId"),[j]);w.useEffect(()=>{if(n.length===0&&s.length>0){o([]);return}if(!n.length)return;const c=s.length>0?s:Object.values(d).filter(g=>!g.complete&&!g.values.includes(4)&&!g.values.includes(-4)).map(g=>g.suspectCardId);if(n.includes("empty")){const g=Object.values(d).filter(b=>b.values.length===0).map(b=>b.suspectCardId);o(g);return}const y=c.filter(g=>{const b=l[g],C=[b.gender,b.ethnicity,b.build,b.height];return b.age==="18-21"&&C.push("young"),(b.age==="21-30"||b.age==="30-40")&&C.push("adult"),b.age==="40-50"&&C.push("parent"),(b.age==="50-60"||b.age==="60-70"||b.age==="70-80"||b.age==="80-90")&&C.push("senior"),n.every(T=>C.includes(T))});o(y)},[n]);const r=c=>{const y=O.cloneDeep(m);s.forEach(g=>{y[g]=[...y[g]||[],c]}),p(t,y),a([])};return e.jsxs(v,{align:"center",className:"mb-4",gap:6,justify:"space-between",children:[e.jsxs(v,{gap:3,children:[e.jsx(k.Text,{className:"nowrap",style:{minWidth:"5ch"},children:"Batch"}),e.jsx(M,{checkedChildren:"On",onChange:c=>{c?x("enableBatch",!0):h("enableBatch")},unCheckedChildren:"Off",value:f})]}),f&&e.jsxs(e.Fragment,{children:[e.jsxs(k.Text,{className:"nowrap mr-2",children:["Selected ",s.length]}),e.jsxs(v,{align:"center",gap:6,justify:"center",wrap:!0,children:[e.jsx(I,{activeFilters:n,filter:"empty",updateActiveFilter:u}),e.jsx(I,{activeFilters:n,filter:"male",updateActiveFilter:u}),e.jsx(I,{activeFilters:n,filter:"female",updateActiveFilter:u}),e.jsx(I,{activeFilters:n,filter:"young",updateActiveFilter:u}),e.jsx(I,{activeFilters:n,filter:"adult",updateActiveFilter:u}),e.jsx(I,{activeFilters:n,filter:"parent",updateActiveFilter:u}),e.jsx(I,{activeFilters:n,filter:"senior",updateActiveFilter:u}),e.jsx(I,{activeFilters:n,filter:"thin",updateActiveFilter:u}),e.jsx(I,{activeFilters:n,filter:"muscular",updateActiveFilter:u}),e.jsx(I,{activeFilters:n,filter:"large",updateActiveFilter:u}),e.jsx(I,{activeFilters:n,filter:"asian",updateActiveFilter:u}),e.jsx(I,{activeFilters:n,filter:"black",updateActiveFilter:u}),e.jsx(I,{activeFilters:n,filter:"caucasian",updateActiveFilter:u}),e.jsx(I,{activeFilters:n,filter:"latino",updateActiveFilter:u})]}),e.jsxs(v,{align:"center",gap:6,children:[e.jsx(S,{danger:!0,onClick:()=>a([]),size:"small",children:"Clear"}),e.jsx(Z,{onConfirm:()=>r(4),title:"Apply +4 to selected suspects?",children:e.jsx(S,{className:"ml-10",disabled:s.length===0,size:"small",type:"primary",children:"Apply +4"})}),e.jsx(Y,{type:"vertical"}),e.jsx(Z,{onConfirm:()=>r(-4),title:"Apply -4 to selected suspects?",children:e.jsx(S,{disabled:s.length===0,size:"small",type:"primary",children:"Apply -4"})})]})]})]})}function I({filter:t,activeFilters:s,updateActiveFilter:o}){return e.jsxs(e.Fragment,{children:[e.jsxs("span",{children:[e.jsx(me,{checked:s.includes(t),onClick:()=>o(t)})," ",O.capitalize(t)]}),e.jsx(Y,{type:"vertical"})]})}function pt({data:t,questions:s,suspects:o,isLoading:l,isSuccess:p,addEntryToUpdate:j}){const{queryParams:m,addParam:n}=R(),[a,x]=w.useState(""),h=w.useMemo(()=>O.orderBy(Object.values(s).map(r=>({...r,answersCount:Object.values(t[r.id]??{}).length})),r=>Number(r.id.split("-")[1]),"asc"),[s]),i=w.useMemo(()=>a.trim()?h.filter(r=>r.question.toLowerCase().includes(a.toLowerCase())||r.id.toLowerCase().includes(a.toLowerCase())):h,[h,a]),f=de({total:i.length,showQuickJumper:!0}),u=[{title:"Id",dataIndex:"id",key:"id",sorter:(r,c)=>Number(r.id.split("-")[1])-Number(c.id.split("-")[1])},{title:"Question",dataIndex:"question",key:"question",sorter:(r,c)=>r.question.localeCompare(c.question)},{title:"NSFW",dataIndex:"nsfw",key:"nsfw",render:r=>r?e.jsx(ye,{style:{color:"hotPink"}}):"",sorter:(r,c)=>Number(r.nsfw)-Number(c.nsfw)},{title:"Answers",dataIndex:"answersCount",key:"answersCount",sorter:(r,c)=>r.answersCount-c.answersCount}],d=ue({maxExpandedRows:1,expandedRowRender:r=>e.jsx(ht,{addEntryToUpdate:j,answers:t[r.id]??{},suspects:o,testimonyId:r.id},r.id),rowExpandable:()=>p});return e.jsxs(v,{className:"full-width py-4",gap:12,vertical:!0,children:[e.jsxs(v,{align:"center",justify:"space-between",children:[e.jsx(k.Title,{className:"my-0",level:4,children:"Suspects by Testimony"}),e.jsx(M,{checked:m.get("sortSuspectsBy")==="answers",checkedChildren:"Sort by Answers",onChange:r=>n("sortSuspectsBy",r?"answers":"id"),unCheckedChildren:"Sort by Id"})]}),e.jsx(Q,{allowClear:!0,onChange:r=>x(r.target.value),placeholder:"Search questions by text or ID...",prefix:e.jsx(ie,{}),style:{width:320},value:a}),e.jsx(_,{bordered:!0,className:"full-width",columns:u,dataSource:i,expandable:d,loading:l,pagination:f,rowKey:"id"})]})}function ft(t){const{queryParams:s,is:o}=R();return e.jsxs(e.Fragment,{children:[(o("display","questions")||!s.get("display"))&&e.jsx(pt,{...t}),o("display","suspects")&&e.jsx(dt,{...t}),o("display","simulator")&&e.jsx(it,{})]})}const jt="Left",xt="Right",gt="Up",yt="Down",A={delta:10,preventScrollOnSwipe:!1,rotationAngle:0,trackMouse:!1,trackTouch:!0,swipeDuration:1/0,touchEventOptions:{passive:!0}},W={first:!0,initial:[0,0],start:0,swiping:!1,xy:[0,0]},se="mousemove",ne="mouseup",bt="touchend",wt="touchmove",vt="touchstart";function St(t,s,o,l){return t>s?o>0?xt:jt:l>0?yt:gt}function re(t,s){if(s===0)return t;const o=Math.PI/180*s,l=t[0]*Math.cos(o)+t[1]*Math.sin(o),p=t[1]*Math.cos(o)-t[0]*Math.sin(o);return[l,p]}function Ct(t,s){const o=h=>{const i="touches"in h;i&&h.touches.length>1||t((f,u)=>{u.trackMouse&&!i&&(document.addEventListener(se,l),document.addEventListener(ne,m));const{clientX:d,clientY:r}=i?h.touches[0]:h,c=re([d,r],u.rotationAngle);return u.onTouchStartOrOnMouseDown&&u.onTouchStartOrOnMouseDown({event:h}),Object.assign(Object.assign(Object.assign({},f),W),{initial:c.slice(),xy:c,start:h.timeStamp||0})})},l=h=>{t((i,f)=>{const u="touches"in h;if(u&&h.touches.length>1)return i;if(h.timeStamp-i.start>f.swipeDuration)return i.swiping?Object.assign(Object.assign({},i),{swiping:!1}):i;const{clientX:d,clientY:r}=u?h.touches[0]:h,[c,y]=re([d,r],f.rotationAngle),g=c-i.xy[0],b=y-i.xy[1],C=Math.abs(g),T=Math.abs(b),D=(h.timeStamp||0)-i.start,P=Math.sqrt(C*C+T*T)/(D||1),U=[g/(D||1),b/(D||1)],F=St(C,T,g,b),V=typeof f.delta=="number"?f.delta:f.delta[F.toLowerCase()]||A.delta;if(C<V&&T<V&&!i.swiping)return i;const E={absX:C,absY:T,deltaX:g,deltaY:b,dir:F,event:h,first:i.first,initial:i.initial,velocity:P,vxvy:U};E.first&&f.onSwipeStart&&f.onSwipeStart(E),f.onSwiping&&f.onSwiping(E);let K=!1;return(f.onSwiping||f.onSwiped||f[`onSwiped${F}`])&&(K=!0),K&&f.preventScrollOnSwipe&&f.trackTouch&&h.cancelable&&h.preventDefault(),Object.assign(Object.assign({},i),{first:!1,eventData:E,swiping:!0})})},p=h=>{t((i,f)=>{let u;if(i.swiping&&i.eventData){if(h.timeStamp-i.start<f.swipeDuration){u=Object.assign(Object.assign({},i.eventData),{event:h}),f.onSwiped&&f.onSwiped(u);const d=f[`onSwiped${u.dir}`];d&&d(u)}}else f.onTap&&f.onTap({event:h});return f.onTouchEndOrOnMouseUp&&f.onTouchEndOrOnMouseUp({event:h}),Object.assign(Object.assign(Object.assign({},i),W),{eventData:u})})},j=()=>{document.removeEventListener(se,l),document.removeEventListener(ne,m)},m=h=>{j(),p(h)},n=(h,i)=>{let f=()=>{};if(h&&h.addEventListener){const u=Object.assign(Object.assign({},A.touchEventOptions),i.touchEventOptions),d=[[vt,o,u],[wt,l,Object.assign(Object.assign({},u),i.preventScrollOnSwipe?{passive:!1}:{})],[bt,p,u]];d.forEach(([r,c,y])=>h.addEventListener(r,c,y)),f=()=>d.forEach(([r,c])=>h.removeEventListener(r,c))}return f},x={ref:h=>{h!==null&&t((i,f)=>{if(i.el===h)return i;const u={};return i.el&&i.el!==h&&i.cleanUpTouch&&(i.cleanUpTouch(),u.cleanUpTouch=void 0),f.trackTouch&&h&&(u.cleanUpTouch=n(h,f)),Object.assign(Object.assign(Object.assign({},i),{el:h}),u)})}};return s.trackMouse&&(x.onMouseDown=o),[x,n]}function kt(t,s,o,l){return!s.trackTouch||!t.el?(t.cleanUpTouch&&t.cleanUpTouch(),Object.assign(Object.assign({},t),{cleanUpTouch:void 0})):t.cleanUpTouch?s.preventScrollOnSwipe!==o.preventScrollOnSwipe||s.touchEventOptions.passive!==o.touchEventOptions.passive?(t.cleanUpTouch(),Object.assign(Object.assign({},t),{cleanUpTouch:l(t.el,s)})):t:Object.assign(Object.assign({},t),{cleanUpTouch:l(t.el,s)})}function Ot(t){const{trackMouse:s}=t,o=w.useRef(Object.assign({},W)),l=w.useRef(Object.assign({},A)),p=w.useRef(Object.assign({},l.current));p.current=Object.assign({},l.current),l.current=Object.assign(Object.assign({},A),t);let j;for(j in A)l.current[j]===void 0&&(l.current[j]=A[j]);const[m,n]=w.useMemo(()=>Ct(a=>o.current=a(o.current,l.current),{trackMouse:s}),[s]);return o.current=kt(o.current,l.current,p.current,n),m}function Tt(t){const{addParam:s}=R();return e.jsxs(v,{gap:8,vertical:!0,children:[e.jsx(S,{block:!0,onClick:()=>s("testify","single"),children:"Testify Drawer"}),e.jsx(S,{block:!0,onClick:()=>s("testify","group"),children:"Testify Group"}),e.jsx(It,{...t}),e.jsx(Rt,{...t})]})}function It({suspects:t,questions:s,answers:o,addEntryToUpdate:l}){const{width:p,height:j}=pe(),{is:m,removeParam:n}=R(),[a,x]=fe(),h=Ot({onSwipedLeft:()=>alert("Swiped Left"),onSwipedRight:()=>alert("Swiped Right"),onSwipedUp:()=>alert("Swiped Up"),preventScrollOnSwipe:!0,trackTouch:!0,trackMouse:!0}),i=()=>{x({suspectId:O.sample(Object.keys(t))||null,testimonyId:O.sample(Object.keys(s))||null})},f=()=>{i()},u=()=>{if(a?.suspectId&&a?.testimonyId){const c=O.cloneDeep(o[a?.testimonyId??""]??{});c[a.suspectId]=[...c[a.suspectId]||[],1],l(a.testimonyId??"",c),i()}},d=()=>{if(a?.suspectId&&a?.testimonyId){const c=O.cloneDeep(o[a?.testimonyId??""]??{});c[a.suspectId]=[...c[a.suspectId]||[],0],l(a.testimonyId??"",c),i()}},r=!!a?.suspectId&&!!a?.testimonyId;return e.jsx(oe,{footer:null,maskClosable:!1,onCancel:()=>n("testify"),open:m("testify","single"),title:e.jsx(k,{children:"Does this person do this??"}),width:p-64,children:e.jsxs("div",{...h,children:[r&&e.jsxs(v,{align:"center",className:"mb-8",gap:8,justify:"center",vertical:!0,children:[e.jsx($,{cardId:a.suspectId??"",cardWidth:Math.max(j/4,128)}),e.jsx(k.Title,{className:"text-center",level:5,children:s[a.testimonyId??""]?.question})]}),e.jsxs(N.Compact,{block:!0,className:"mb-8",size:"large",children:[e.jsx(S,{block:!0,disabled:!r,icon:"ðŸ‘Ž",onClick:d,style:{height:64},children:"No"}),e.jsx(S,{block:!0,onClick:f,style:{height:64},children:"Skip"}),e.jsx(S,{block:!0,disabled:!r,icon:"ðŸ‘",iconPosition:"end",onClick:u,style:{height:64},children:"Yes"})]})]})})}function Rt({suspects:t,questions:s,answers:o,addEntryToUpdate:l}){const{width:p,height:j}=pe(),{is:m,removeParam:n}=R(),[a,x]=fe(),[h,i]=w.useState(6),[f,u]=w.useState(!0),d=()=>{const g=O.sampleSize(Object.keys(t),h)?.reduce((b,C)=>(b[C]=null,b),{});x({suspectsIds:g,testimonyId:(f?O.sample(Object.keys(s)):a?.testimonyId)??null})};be(()=>d());const r=()=>{const g=Object.entries(a?.suspectsIds??{}).reduce((b,[C,T])=>(T!==null&&(b[C]=[T]),b),{});if(a?.testimonyId&&Object.keys(g).length>0){const b=O.cloneDeep(o[a.testimonyId]??{});Object.entries(g).forEach(([C,T])=>{b[C]=[...b[C]||[],...T]}),l(a.testimonyId,b)}else console.log("No testimonyId or no judged suspects found, likely skipped");d()},c=!!a?.suspectsIds&&!!a?.testimonyId,y=g=>{x(b=>{if(!b)return b;const C=Object.entries(b.suspectsIds).reduce((T,[D,P])=>(T[D]=P===null?g:P,T),{});return{...b,suspectsIds:C}})};return e.jsx(oe,{footer:null,maskClosable:!1,onCancel:()=>n("testify"),open:m("testify","group"),title:e.jsx(k,{children:"Do these people do this??"}),width:p-64,children:e.jsxs("div",{children:[c&&e.jsxs(v,{align:"center",className:"mb-8",gap:8,justify:"center",vertical:!0,children:[e.jsxs(v,{align:"center",gap:6,justify:"center",children:[e.jsx(k.Text,{children:"Number of Suspects:"}),e.jsx(ae,{onChange:g=>i(g??6),size:"small",value:h}),e.jsx(k.Text,{children:"Random Questions:"}),e.jsx(M,{checked:f,onChange:u,size:"small"})]}),e.jsxs(k.Title,{className:"text-center",level:4,children:[a.testimonyId," - ",s[a.testimonyId??""]?.question]}),e.jsx(v,{gap:8,justify:"center",wrap:"wrap",children:Object.keys(a.suspectsIds).map(g=>e.jsxs(v,{align:"center",justify:"center",vertical:!0,children:[e.jsx(k.Text,{className:"text-center",children:t[g]?.name?.pt||"Unknown"}),e.jsx($,{cardId:g,cardWidth:Math.min(Math.max(j/3,128),128)},g),e.jsx(De,{onChange:b=>x(C=>C&&{...C,suspectsIds:{...C.suspectsIds,[g]:b}}),options:[{value:0,icon:"ðŸ‘Ž"},{value:null,icon:"â™¾"},{value:1,icon:"ðŸ‘"}],shape:"round",size:"large",value:a.suspectsIds[g]})]},g))})]}),e.jsxs(v,{align:"center",className:"mt-8",justify:"space-between",children:[e.jsx("span",{}),e.jsxs(v,{gap:8,children:[e.jsx(S,{onClick:()=>y(0),children:"Set all â™¾ to ðŸ‘Ž"}),e.jsx(S,{onClick:()=>y(1),children:"Set all â™¾ to ðŸ‘"})]}),e.jsx(S,{onClick:r,size:"large",children:"Next Set"})]})]})})}function Dt({suspects:t,questions:s,data:o,hasNewData:l,isDirty:p,save:j,isSaving:m,entriesToUpdate:n,addEntryToUpdate:a}){const{queryParams:x,addParams:h}=R(),i=w.useMemo(()=>{let u=0;const d={};return Object.values(o).forEach(r=>{Object.keys(r).forEach(c=>{if(r[c]){d[c]||(d[c]=0);const y=Oe(r[c]);y>=5&&(d[c]+=1),y>=3&&(u+=1)}})}),{absoluteTotal:u,queriedTestimoniesCount:Object.keys(o).length,suspectsCount:Object.keys(d).length,reliableSuspectsCount:Object.values(d).filter(r=>r>=30).length}},[o]),f=i.queriedTestimoniesCount*i.suspectsCount;return e.jsxs(e.Fragment,{children:[e.jsx(H,{children:e.jsxs(v,{gap:12,vertical:!0,children:[e.jsx(Fe,{dirt:JSON.stringify(n),isDirty:p,isSaving:m,onSave:j}),e.jsx(le,{block:!0,data:async()=>await Mt(o),disabled:p,fileName:"testimony-answers.json",hasNewData:l}),e.jsx(Ee,{label:"FS Data",path:"data/testimonies"}),e.jsx(Ae,{docId:"testimonies",label:"FS TDR",path:"tdr",queryKey:["tdr","testimonies"]})]})}),e.jsxs(H,{children:[e.jsx(Me,{label:"Display",onChange:u=>h({display:u,page:1},{page:1}),options:[{title:"Questions",icon:e.jsx(He,{}),value:"questions"},{title:"Suspects",icon:e.jsx(Ze,{}),value:"suspects"},{title:"Simulator",icon:e.jsx(qe,{}),value:"simulator"}],value:x.get("display")??"questions"}),e.jsx(Be,{})]}),e.jsx(H,{children:e.jsxs("div",{style:{fontSize:"0.85em"},children:[e.jsx("strong",{children:"Legend"}),e.jsxs("ul",{children:[e.jsx("li",{children:"Reliability: At least 5 votes"}),e.jsx("li",{children:"Large Bars: There's enough data (at least 3)"}),e.jsx("li",{children:"Small blue bar: in progress negative"})]})]})}),e.jsxs(H,{children:[e.jsxs("div",{style:{fontSize:"0.85em"},children:[e.jsx("strong",{children:"Counts"}),e.jsxs("ul",{children:[e.jsxs("li",{children:["Testimonies: ",i.queriedTestimoniesCount]}),e.jsxs("li",{children:["Suspects: ",i.suspectsCount]}),e.jsx("li",{children:e.jsxs(B,{title:"A reliable suspect is one that has at least 5 complete testimonies.",children:["Reliable suspects: ",i.reliableSuspectsCount]})}),e.jsxs("li",{children:["Complete: ",i.absoluteTotal]}),e.jsxs("li",{children:["Total: ",f]}),e.jsxs("li",{children:["Percentage: ",(i.absoluteTotal/f*100).toFixed(1),"%"]})]})]}),e.jsx(Tt,{addEntryToUpdate:a,answers:o,questions:s,suspects:t})]})]})}async function Mt(t){console.log("Preparing file for download...x");const s=await ze("data","testimonies")(),o=Le(s);console.log("Parsed data from Firestore:",o);const l=O.cloneDeep(t);return Object.keys(l).forEach(p=>{const j=l[p],m=o[p]||{};Object.keys(j).forEach(n=>{const a=m[n]||[],x=Ne([...j[n],...a]);j[n]=x})}),$e(Ve(l))}function ws(){const t=Te();return e.jsx(we,{subtitle:"Suspect Testimony Rates",title:"Testimonies",children:e.jsxs(J,{hasSider:!0,children:[e.jsx(Se,{children:e.jsx(Dt,{...t})}),e.jsx(J.Content,{className:"content",children:e.jsx(ve,{error:t.error,hasResponseData:!O.isEmpty(t.data),isLoading:t.isLoading,children:e.jsx(ft,{...t})})})]})})}export{ws as TestimoniesPage,ws as default};
