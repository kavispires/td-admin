import{r as y,X as M,j as e,B as $,T as C,D as W,P as Q,L as N}from"./index-CTqAsA_o.js";import{D as z}from"./DataLoadingWrapper-Dk0jKqZ1.js";import{F as q,c as U}from"./FilterEntries-DKUgjbtn.js";import{S as J}from"./SiderContent-B0McUjmA.js";import{D as K}from"./DownloadButton-CL9t0Pp_.js";import{S as X}from"./SaveButton-UbZtJZGF.js";import{u as T}from"./useQueryParams-DqPkNU1y.js";import{u as v}from"./useTDResource-DyzOjZyK.js";import{l as g,P as _}from"./useBaseUrl-CfIxsWS4.js";import{h as O,b as V,i as H,r as w,a as Y}from"./index-CYoT0uSg.js";import{L as P}from"./LanguageFlag-AD47zjFI.js";import{F as I,R as Z,C as ee}from"./index-jT5de-T3.js";import{M as se}from"./index-I4YDiCTp.js";import{I as D}from"./index-BSqbKlSi.js";import{F as S}from"./index-CqyweTda.js";import{R as te}from"./ClusterOutlined-BHo9d3R2.js";import{R as re}from"./TableOutlined-Q7o2FGQ_.js";import{T as oe}from"./TransparentButton-CAp6NPKW.js";import{D as R}from"./EditableFields-CVbodQxm.js";import{I as ie}from"./Item-CcptkV8V.js";import{u as G}from"./useCopyToClipboardFunction-DPTOY0LV.js";import{u as ae}from"./useTableExpandableRows-DD_wfO95.js";import{u as ne}from"./useTablePagination-Cqi3XmqR.js";import{C as le}from"./CopyIdsButton-BhC2uNUE.js";import{I as me,b as k,d as ce}from"./ItemBuildingBlocks-DuC14PJA.js";import{C as de}from"./index-DmmskQaB.js";import{S as F}from"./index-J20xQDFc.js";import{S as pe}from"./index-CGHZ3ZJ-.js";import{I as ue}from"./InspirationSample-raINtJNH.js";import{I as he}from"./ItemsTypeahead-C3yAwN3-.js";import{F as E}from"./Table-BMQsW9r8.js";import{D as xe}from"./index-C9t15dx8.js";import{u as fe,P as je}from"./useGridPagination-Dclbfs1T.js";import{T as ye}from"./Typeahead-d1wcwIWD.js";import{u as ge}from"./useResourceFirestoreData-DCuPlNlD.js";import"./index-ZuSYxOkb.js";import"./index-BI9BNfae.js";import"./moment-C5S46NFB.js";import"./SaveOutlined-C-KNcU5w.js";import"./constants-COkG863P.js";import"./Input-BkRdKyg_.js";import"./gapSize-U1swVQyS.js";import"./FireFilled-B56-0noN.js";import"./IdcardOutlined-C5s12t6S.js";import"./index-C7F_crQu.js";import"./PlusOutlined-ByZyTB3m.js";import"./index-B4tBgGMB.js";import"./SyncOutlined-C2rtO8n9.js";import"./PlusOutlined-BlDRSlUE.js";import"./useDebounce-rFkX6Q5o.js";import"./index-BAMR3jpG.js";import"./index-CBE_GNRC.js";import"./index-DEdHXK8i.js";import"./scrollTo-De5D9bdo.js";import"./Pagination-Cs6cIB1f.js";import"./extendsObject-keMuGWqj.js";import"./useGetFirestoreDoc-CwTsKYwp.js";import"./useUpdateFirestoreDoc-Cb71gbZb.js";import"./useMutation-BlHvKcpM.js";function Ie({addEntryToUpdate:s,data:t}){const[o,c]=y.useState(!1),[n]=I.useForm(),{notification:m}=M.useApp(),d=r=>{const i=V(Object.keys(t));s(i,{id:i,name:{pt:r.nome,en:r.name},itemsIds:[],keywords:r.keywords}),m.success({message:"Group added successfully"}),c(!1),n.resetFields()},u=I.useWatch("name",n),f=I.useWatch("nome",n),p=y.useMemo(()=>{const r={};if(u&&u.length>2){const l=Object.entries(t).reduce((x,[b,a])=>{const h=O.compareTwoStrings(a.name.en,u),j=O.compareTwoStrings(a.name.pt,f);return(h>.2||j>.2)&&(x[b]=Math.max(h,j)),x},{});Object.keys(l).forEach(x=>{r[x]=l[x]})}return Object.keys(r)},[u,f,t]);return e.jsxs(e.Fragment,{children:[e.jsx($,{type:"dashed",block:!0,onClick:()=>c(!0),className:"mb-4",children:"Add New Group"}),e.jsxs(se,{title:"Add New Set",open:o,onOk:n.submit,onCancel:()=>c(!1),maskClosable:!1,okText:"Add",okButtonProps:{htmlType:"submit"},children:[e.jsxs(I,{form:n,onFinish:d,children:[e.jsx(I.Item,{name:"nome",label:"Nome",rules:[{required:!0}],children:e.jsx(D,{prefix:e.jsx(P,{language:"pt",width:"1em"}),placeholder:"Name in pt",size:"small"})}),e.jsx(I.Item,{name:"name",label:"Name",rules:[{required:!0}],children:e.jsx(D,{prefix:e.jsx(P,{language:"en",width:"1em"}),placeholder:"Name in en",size:"small"})})]}),e.jsx(C.Text,{children:"Similar:"}),e.jsx("ul",{children:p.map(r=>{var i,l;return e.jsxs("li",{children:[r," - ",(i=t[r])==null?void 0:i.name.en," / ",(l=t[r])==null?void 0:l.name.pt]},r)})})]})]})}function be({data:s,save:t,isDirty:o,isSaving:c,entriesToUpdate:n,addEntryToUpdate:m,hasFirestoreData:d}){const{queryParams:u,addParam:f,addParams:p,is:r}=T(),i=v("items");return e.jsxs(J,{children:[e.jsxs(S,{vertical:!0,gap:12,children:[e.jsx(X,{isDirty:o,onSave:t,isSaving:c,dirt:JSON.stringify(L(n))}),e.jsx(K,{data:()=>Se(s,i.data),fileName:"items-groups.json",disabled:o||g.isEmpty(i.data),hasNewData:d,block:!0})]}),e.jsx(W,{}),e.jsx(Ie,{data:s,addEntryToUpdate:m}),e.jsx(q,{label:"Display",value:u.get("display")??"group",onChange:l=>p({display:l,page:1},{page:1}),options:[{title:"By Groups",icon:e.jsx(te,{}),value:"group"},{title:"By Items",icon:e.jsx(re,{}),value:"item"}]}),r("display","item")&&e.jsx(U,{label:"No Groups Only",value:r("emptyOnly"),onChange:l=>f("emptyOnly",l,!1)})]})}function L(s){return g.omitBy(g.cloneDeep(s),t=>g.isEmpty(t.itemsIds))}function Se(s,t){return Object.keys(s).forEach(o=>{s[o].itemsIds=H(w(s[o].itemsIds));const c=s[o].itemsIds.length,n=s[o].itemsIds.filter(m=>t[m].nsfw).length;n>c*.3&&(s[o].nsfw=!0,console.log(`ðŸ˜ˆ Group ${s[o].name.pt} has ${n} (${Math.round(n/c*100)}%) NSFW items`))}),Y(L(s))}const we=["8bc4f","96efa","c10eb","16ec3","2a97f","4bba8","565ed","5fb57","62a8b"];function B({item:s,itemGroups:t,groupsTypeahead:o,onUpdateItemGroups:c}){const n=G();return e.jsxs(de,{title:e.jsxs(e.Fragment,{children:[e.jsx(C.Text,{onClick:()=>n(s.id),children:s.id}),e.jsx(ce,{item:s})]}),style:{maxWidth:250,...Ce(t)},children:[e.jsx(me,{item:s,width:75}),e.jsxs(F,{size:"small",direction:"vertical",className:"my-4",children:[e.jsx(k,{item:s,language:"en"}),e.jsx(k,{item:s,language:"pt"}),e.jsx(pe,{mode:"multiple",style:{width:"100%"},placeholder:"Select a group",defaultValue:t,options:o,filterOption:(m,d)=>!!(d!=null&&d.label.toLowerCase().includes(m.toLowerCase())),size:"small",onChange:m=>c(s.id,m)},String(t))]})]})}const Ce=s=>!s||(s==null?void 0:s.length)===0?{borderColor:"orange"}:s!=null&&s.every(t=>we.includes(t))?{borderColor:"red"}:{};function ve({group:s,onUpdateGroupItems:t}){const o=c=>{t(s.id,[...s.itemsIds,c])};return e.jsxs("div",{children:[e.jsx(he,{onFinish:o}),e.jsx(ue,{onSelect:o,excludeList:s.itemsIds,initialQuantity:0})]})}function A({rows:s,items:t,grousByItem:o,groupsTypeahead:c,onUpdateItemGroups:n,onUpdateGroupItems:m,onUpdateName:d}){const u=G(),f=v("items"),[p,r]=y.useState(null),i=ne({showQuickJumper:!0,total:s.length}),l=[{title:"id",dataIndex:"id",key:"id",render:a=>e.jsx("span",{children:a})},{title:"Name",dataIndex:"name",key:"name",render:(a,h)=>e.jsxs(S,{vertical:!0,gap:4,children:[e.jsx(R,{value:a,language:"en",style:{minWidth:150},onChange:j=>d(j.target.value,"en",h.id)}),e.jsx(R,{value:a,language:"pt",style:{minWidth:150},onChange:j=>d(j.target.value,"pt",h.id)})]})},{title:"Items",dataIndex:"itemsIds",key:"itemsIds",render:(a,h)=>e.jsx(S,{gap:6,wrap:"wrap",children:a.map(j=>e.jsxs(S,{gap:2,vertical:!0,children:[e.jsx(oe,{onClick:()=>r(j),children:e.jsx(ie,{id:j,width:60})}),e.jsx(S,{justify:"center",children:e.jsx(C.Text,{onClick:()=>u(j),children:j})})]},`${h.id}-${j}`))},`items-${h.id}`)},E.EXPAND_COLUMN,{title:"Count",dataIndex:"itemsIds",key:"count",render:a=>w(a).filter(Boolean).length},{title:"Actions",dataIndex:"itemsIds",key:"actions",render:a=>e.jsx(le,{ids:a})}],x=p?t[p]:null,b=ae({maxExpandedRows:1,expandedRowRender:a=>e.jsx(ve,{group:a,onUpdateGroupItems:m}),rowExpandable:()=>f.isSuccess});return e.jsxs(e.Fragment,{children:[e.jsx(E,{columns:l,dataSource:s,className:"my-4",rowKey:"id",pagination:i,expandable:b}),e.jsx(xe,{title:"Edit Item Group",onClose:()=>r(null),open:!!x,children:x&&e.jsx(B,{item:x,itemGroups:o[x.id],groupsTypeahead:c,onUpdateItemGroups:n})})]})}function Te({items:s,grousByItem:t,groupsTypeahead:o,onUpdateItemGroups:c}){const{is:n}=T(),m=n("emptyOnly"),d=y.useMemo(()=>m?Object.values(s).filter(p=>!t[p.id]):Object.values(s),[s,t,m]),{page:u,pagination:f}=fe({data:d});return e.jsxs(e.Fragment,{children:[e.jsxs(C.Title,{level:2,children:["Groups by Items (",d.length,")"]}),e.jsx(je,{pagination:f,children:e.jsx(Z,{gutter:[16,16],className:"my-4",children:u.map(p=>e.jsx(ee,{xs:24,sm:24,md:12,lg:6,xl:4,children:e.jsx(B,{item:p,itemGroups:t[p.id],groupsTypeahead:o,onUpdateItemGroups:c})},p.id))})})]})}function Fe({data:s,items:t,grousByItem:o,groupsTypeahead:c,onUpdateItemGroups:n,onUpdateGroupItems:m,onUpdateName:d}){const[u,f]=y.useState(null),p=y.useMemo(()=>u?s[u]:null,[u,s]);return e.jsxs(F,{direction:"vertical",children:[e.jsx(C.Title,{level:5,children:"Search Disc Set"}),e.jsx(ye,{data:s,onFinish:r=>f(r),placeholder:"Search disc set by title...",parser:Ne,style:{width:"100%",minWidth:450}}),!!p&&e.jsx(A,{rows:[p],items:t,grousByItem:o,groupsTypeahead:c,onUpdateItemGroups:n,onUpdateGroupItems:m,onUpdateName:d})]})}const Ne=s=>Object.values(s??{}).reduce((t,o)=>(t[`${o.name.en}`]=o.id,t[`${o.name.pt}`]=o.id,t),{});function Oe({data:s,addEntryToUpdate:t}){const{is:o,queryParams:c}=T(),n=v("items"),m=y.useMemo(()=>Object.values(s??[]).reduce((r,i)=>(i.itemsIds||console.warn("Group without items",i),i.itemsIds.forEach(l=>{r[l]||(r[l]=[]),r[l].push(i.id)}),r),{}),[s]),d=y.useMemo(()=>g.orderBy(Object.values(s).flatMap(({id:r,name:i})=>[{label:`${i.en} [${r}]`,value:r}]),"label"),[s]),u=(r,i)=>{const l=m[r]??[],x=i.filter(a=>!l.includes(a)),b=l.filter(a=>!i.includes(a));x.forEach(a=>{const h=s[a];t(a,{...h,itemsIds:w([...(h==null?void 0:h.itemsIds)??[],r])})}),b.forEach(a=>{const h=s[a];t(a,{...h,itemsIds:w(h==null?void 0:h.itemsIds.filter(j=>j!==r))})})},f=(r,i)=>{const l=s[r];t(r,{...l,itemsIds:w(i)})},p=(r,i,l)=>{const x=s[l];t(l,{...x,name:{...x.name,[i]:r}})};return e.jsxs(e.Fragment,{children:[(o("display","group")||!c.has("display"))&&e.jsxs(F,{direction:"vertical",className:"mb-4",children:[e.jsx(Fe,{data:s,items:n.data,grousByItem:m,groupsTypeahead:d,onUpdateItemGroups:u,onUpdateGroupItems:f,onUpdateName:p}),e.jsx(A,{rows:Object.values(s),items:n.data,grousByItem:m,groupsTypeahead:d,onUpdateItemGroups:u,onUpdateGroupItems:f,onUpdateName:p})]}),o("display","item")&&e.jsx(Te,{items:n.data,grousByItem:m,groupsTypeahead:d,onUpdateItemGroups:u,onUpdateGroupItems:f,onUpdateName:p})]})}function Gs(){const s=ge({tdrResourceName:"items-groups",firestoreDataCollectionName:"itemsGroups",serialize:!0}),t=v("items");return e.jsx(Q,{title:"Items",subtitle:"Groups Sets",children:e.jsxs(N,{hasSider:!0,children:[e.jsx(_,{children:e.jsx(be,{...s})}),e.jsx(N.Content,{className:"content",children:e.jsx(z,{isLoading:s.isLoading||t.isLoading,error:s.error||t.error,hasResponseData:!g.isEmpty(s.data)&&!g.isEmpty(t.data),children:e.jsx(Oe,{...s})})})]})})}export{Gs as ItemsGroups,Gs as default};
